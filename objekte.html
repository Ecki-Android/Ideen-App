<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Objektverwaltung Pro + Finanzen</title>
    <!-- PDF Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <!-- MS Auth -->
    <script src="https://alcdn.msauth.net/browser/2.24.0/js/msal-browser.min.js"></script>
    
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; padding: 15px; background-color: #f4f7f6; margin: 0; }
        
        /* Header & Actions */
        .app-header { background: white; padding: 15px; border-bottom: 1px solid #ddd; margin: -15px -15px 20px -15px; display: flex; flex-wrap: wrap; align-items: center; justify-content: space-between; gap: 10px; }
        .app-title { font-size: 1.2em; font-weight: bold; color: #2e7d32; margin: 0; }
        .cloud-actions { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        
        button { padding: 8px 12px; font-size: 0.9em; border-radius: 4px; border: 1px solid #bbb; background: #eee; cursor: pointer; }
        button:hover { background: #ddd; }
        button:disabled { opacity: 0.6; cursor: not-allowed; }

        .primary-btn { background: #2e7d32; color: white; border-color: #1b5e20; }
        .warn-btn { background: #d9534f; color: white; border-color: #d43f3a; }
        .onedrive-btn { background: #0078d4; color: white; border-color: #005a9e; }
        .local-btn { background: #fff3cd; color: #856404; border-color: #ffeeba; }
        .report-btn { background: #607d8b; color: white; border-color: #455a64; }
        .test-btn { background: #ff9800; color: white; border-color: #f57c00; }
        .finance-btn { background: #673ab7; color: white; border-color: #512da8; } 
        .account-btn { background: #e1bee7; color: #4a148c; border-color: #ce93d8; font-weight:bold; }
        
        /* Status Anzeige */
        .onedrive-status { 
            display: none; align-items: center; padding: 6px 12px; font-size: 0.9em; font-weight: 500; 
            border-radius: 4px; transition: all 0.3s ease; margin-left: 10px; 
        }
        .onedrive-status.saving { background-color: #e0f2fe; color: #0c4a6e; border: 1px solid #bae6fd; display: inline-flex; }
        .onedrive-status.success { background-color: #dcfce7; color: #14532d; border: 1px solid #bbf7d0; display: inline-flex; }
        .onedrive-status.error { background-color: #fee2e2; color: #991b1b; border: 1px solid #fecaca; display: inline-flex; }
        .onedrive-status.info { background-color: #fffbeb; color: #92400e; border: 1px solid #fde68a; display: inline-flex; }
        
        #sessionExpiredWarning { 
            margin: 0 0 15px 0; font-weight: bold; padding: 10px; border-radius: 4px; 
            display: none; background-color: #fffbe6; border: 1px solid #ffc107; color: #ff8f00; 
            text-align: center; width: 100%; box-sizing: border-box;
        }

        /* Navigation */
        .tab-bar { margin-bottom: 15px; display: flex; gap: 5px; flex-wrap: wrap; align-items: center; }
        .tab-btn { background: #f9f9f9; padding: 10px 15px; border-bottom: 3px solid transparent; cursor: pointer; border-radius: 4px 4px 0 0; }
        .tab-btn.active { border-bottom: 3px solid #2e7d32; font-weight: bold; background: white; }
        .report-actions { margin-left: auto; display: flex; gap: 5px; }

        /* Filter Banner */
        #filterBanner { display: none; background-color: #e3f2fd; border: 1px solid #90caf9; color: #0d47a1; padding: 10px; margin-bottom: 15px; border-radius: 4px; align-items: center; justify-content: space-between; }
        #filterBanner button { margin: 0; padding: 5px 10px; background: #fff; border: 1px solid #90caf9; color: #0d47a1; }

        .panel { display: none; background: white; padding: 15px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .panel.active { display: block; }
        .liste-item { border: 1px solid #ddd; padding: 10px; margin-bottom: 10px; background: #fff; border-radius: 4px; display: flex; gap: 10px; align-items: flex-start; }
        .liste-content { flex: 1; }
        .item-checkbox { margin-top: 5px; transform: scale(1.2); cursor: pointer; }

        .objekt-stats { font-size: 0.85em; background: #fafafa; padding: 8px; border-radius: 4px; margin-top: 8px; border: 1px solid #eee; }
        .validation-row { display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding: 2px 0; }
        
        .stat-ok { color: #2e7d32; font-weight: bold; }
        .stat-err { color: #d32f2f; font-weight: bold; }
        
        .detail-box { margin-top: 8px; border-top: 1px solid #eee; padding-top: 5px; font-size: 0.85em; color: #444; }
        .detail-row { display: flex; justify-content: space-between; padding: 1px 0; }
        .detail-header { font-weight: bold; margin-bottom: 2px; color: #333; margin-top: 5px; }

        /* SCROLLABLE MATRIX */
        .matrix-wrapper { max-height: 300px; overflow-y: auto; border: 1px solid #ccc; margin-bottom: 10px; background: #fff; }
        .soll-matrix { width: 100%; border-collapse: collapse; font-size: 0.85em; }
        .soll-matrix th { text-align: center; background: #eee; padding: 5px; border: 1px solid #ccc; font-weight: 600; position: sticky; top: 0; z-index: 2; }
        .soll-matrix td { border: 1px solid #ccc; padding: 4px; text-align: center; }
        .soll-matrix input { width: 100%; text-align: center; border: 1px solid transparent; background: #f9fbe7; font-weight: bold; }
        .soll-matrix input:focus { background: #fff; border: 1px solid #2e7d32; outline: none; }
        .readonly-val { color: #555; }
        .diff-val { font-weight: bold; }
        
        .matrix-sum-row { background: #e0f2f1; font-weight: bold; }

        /* Modal */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; justify-content: center; align-items: center; }
        .modal-overlay.active { display: flex; }
        .modal-content { background: white; padding: 25px; border-radius: 8px; width: 95%; max-width: 900px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); max-height: 90vh; overflow-y: auto; }
        .modal-content input, .modal-content select, .modal-content textarea { width: 100%; padding: 8px; margin-top: 5px; margin-bottom: 15px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
        .modal-actions { text-align: right; margin-top: 20px; }
        
        /* DRAGGABLE MODAL */
        .modal-draggable { position: fixed; top: 100px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 500px; background: white; border-radius: 8px; box-shadow: 0 5px 25px rgba(0,0,0,0.4); z-index: 2000; display: none; border: 1px solid #bbb; }
        .modal-draggable.active { display: block; }
        .modal-header-drag { background: #444; color: white; padding: 10px; border-radius: 8px 8px 0 0; cursor: move; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 15px; max-height: 70vh; overflow-y: auto; }

        .sub-list-container { border: 1px solid #eee; padding: 10px; background: #fafafa; border-radius: 4px; margin-bottom: 15px; max-height: 350px; overflow-y: auto; }
        
        .belegung-wrapper { border-bottom: 1px solid #ddd; padding-bottom: 10px; margin-bottom: 10px; background: #fff; padding: 10px; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .belegung-row { display: flex; gap: 8px; align-items: center; }
        .belegung-row select { flex: 3; min-width: 200px; margin: 0; font-weight: bold; } 
        .belegung-row input[type="date"] { flex: 0 0 130px; margin: 0; font-size: 0.9em; } 
        
        .historie-row { display: flex; gap: 5px; align-items: center; margin-bottom: 5px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .historie-row input[type="date"] { width: 130px; margin:0; }
        .historie-row input[type="text"] { flex: 1; margin:0; }

        .badge { padding: 2px 6px; border-radius: 4px; font-size: 0.8em; font-weight: bold; margin-left: 5px; border: 1px solid #ccc; background: #f0f0f0; color: #333; }
        .mieter-status { margin-top: 8px; padding-top: 8px; border-top: 1px solid #eee; font-size: 0.95em; }
        .status-leerstand { color: #c62828; font-weight: bold; background: #ffebee; padding: 2px 6px; border-radius: 3px; display:inline-block; }
        .status-vermietet { color: #2e7d32; font-weight: bold; }
        .status-zukunft { color: #0277bd; font-style: italic; }
        .contract-id { font-family: monospace; background: #eee; padding: 1px 4px; border-radius: 3px; margin-left: 5px; color: #555; }

        .live-status-box { padding: 10px; border-radius: 4px; margin-bottom: 15px; font-size: 0.9em; border: 1px solid transparent; }
        
        /* Container for the Type Statistics */
        .type-overview-container { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 15px; padding: 10px; background: #f9f9f9; border-radius: 4px; border: 1px solid #eee; }
        .type-badge { padding: 4px 8px; border-radius: 4px; font-size: 0.85em; border: 1px solid #ccc; background: #fff; color: #555; cursor: pointer; }
        .type-badge:hover { background-color: #eee; }
        .type-badge.open { border-color: #2196f3; background: #e3f2fd; color: #0d47a1; font-weight: bold; }
        .type-badge.full { border-color: #4caf50; background: #e8f5e9; color: #1b5e20; }
        .type-badge.over { border-color: #f44336; background: #ffebee; color: #b71c1c; }
        .type-badge.selected { box-shadow: 0 0 0 2px #333; }

        /* Styles f√ºr Finanz-Modul & Konditionen */
        .kondition-row { display: grid; grid-template-columns: 2fr 0.8fr 0.8fr 1fr 0.9fr 0.9fr 0.6fr 30px 30px 30px; gap: 5px; margin-bottom: 5px; align-items: center; border-bottom:1px dashed #eee; padding-bottom:5px;}
        .kondition-row input, .kondition-row select { margin: 0; font-size: 0.9em; }
        
        .konto-tabelle { width: 100%; border-collapse: collapse; font-size: 0.9em; }
        .konto-tabelle th, .konto-tabelle td { border: 1px solid #ddd; padding: 6px; text-align: left; }
        .konto-tabelle th { background: #f5f5f5; }
        .konto-tabelle tr:hover { background-color: #e3f2fd; cursor: pointer; }
        .text-right { text-align: right; }
        .betrag-soll { color: #c62828; }
        .betrag-haben { color: #2e7d32; }

        h4 { margin: 0; padding: 0; }
        .sub-info { color: #666; font-size: 0.9em; margin-top: 4px; }
        
        .filter-btn { background: #fff; color: #333; border: 1px solid #aaa; padding: 4px 8px; font-size: 0.85em; }
        .filter-btn.active { background: #e0f2f1; border-color: #00695c; color: #00695c; font-weight: bold; }
        
        .section-header { margin-top: 15px; margin-bottom: 5px; padding-bottom: 5px; border-bottom: 1px solid #eee; font-weight: bold; color: #333; display: flex; justify-content: space-between; align-items: center; }

        /* Steuerschl√ºssel Tabelle */
        .tax-table { width: 100%; border-collapse: collapse; font-size: 0.9em; }
        .tax-table th, .tax-table td { border: 1px solid #ccc; padding: 4px; text-align: left; }
        .tax-table th { background: #eee; position: sticky; top: 0; }

        /* Badge f√ºr Steuerstatus */
        .tax-badge { display:inline-block; padding: 2px 6px; border-radius: 4px; font-size: 0.8em; font-weight: bold; margin-left: 5px; }
        .tax-opt { background: #e8f5e9; color: #1b5e20; border:1px solid #c8e6c9; }
        .tax-none { background: #f5f5f5; color: #616161; border:1px solid #e0e0e0; }
        .tax-mixed { background: #fff3e0; color: #e65100; border:1px solid #ffe0b2; }

        /* Login Protection */
        #loginMessage { text-align: center; padding: 50px 20px; background: white; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-top: 20px; display: none; }
        #loginMessage h2 { border-bottom: none; color: #555; }
        #protectedContent { display: block; }

        /* UPDATE: Styles f√ºr Kosten-Erfassung (inkl. Lohnart & Lohnanteil) */
        /* Konto | Text | Brutto | Lohn | LohnArt(NEU) | VSt-Key | Netto | VSt | Verteil | X */
        .kosten-row { display: grid; grid-template-columns: 0.8fr 1.8fr 1fr 0.8fr 1fr 0.6fr 1fr 0.8fr 1fr 30px; gap: 5px; margin-bottom: 5px; align-items: center; border-bottom: 1px dashed #ddd; padding-bottom: 5px; }
        .kosten-row input, .kosten-row select { font-size: 0.85em; padding: 4px; margin: 0; border:1px solid #ccc; border-radius:3px; }
        .kosten-header { display: grid; grid-template-columns: 0.8fr 1.8fr 1fr 0.8fr 1fr 0.6fr 1fr 0.8fr 1fr 30px; gap: 5px; font-weight: bold; background: #eee; padding: 8px 5px; border-radius: 4px 4px 0 0; font-size: 0.85em; }
        .kosten-footer { display: flex; justify-content: flex-end; gap: 15px; padding: 10px; background: #e0f2f1; font-weight: bold; border-top: 2px solid #00695c; margin-top: 10px; }
        
        /* UPDATE: Styles f√ºr Split-Modal (inkl. Lohnart) */
        /* Betrag | Text | Konto | Lohn | LohnArt | Tax | Verteil | X */
        .split-row { display: grid; grid-template-columns: 1fr 2fr 1fr 0.8fr 1fr 0.8fr 1fr 30px; gap: 5px; margin-bottom: 5px; align-items: center; }
        .split-row input, .split-row select { width: 100%; font-size:0.9em; padding: 5px; margin: 0; border:1px solid #ccc; }
        .split-header { display: grid; grid-template-columns: 1fr 2fr 1fr 0.8fr 1fr 0.8fr 1fr 30px; gap: 5px; margin-bottom: 10px; font-weight:bold; font-size:0.85em; background:#eee; padding:5px; }

        /* Styles f√ºr Verbrauchsdaten-Modal */
        .v-tab-bar { display: flex; border-bottom: 1px solid #ccc; margin-bottom: 15px; background: #f1f1f1; border-radius: 4px 4px 0 0; }
        .v-tab { flex: 1; text-align: center; padding: 10px; cursor: pointer; border-bottom: 3px solid transparent; color: #555; font-weight: 500; }
        .v-tab:hover { background: #e9e9e9; }
        .v-tab.active { background: #fff; border-bottom: 3px solid #2e7d32; color: #2e7d32; font-weight: bold; border-radius: 4px 4px 0 0; }
        
        .v-panel { display: none; animation: fadeIn 0.3s; }
        .v-panel.active { display: block; }

        .verbrauchs-header { display: grid; gap: 5px; font-weight: bold; background: #e0f2f1; padding: 8px; border-radius: 4px; font-size: 0.85em; margin-bottom: 10px; border: 1px solid #b2dfdb; }
        .verbrauchs-row { display: grid; gap: 5px; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 5px; margin-bottom: 5px; }
        .verbrauchs-row input, .verbrauchs-row select { width: 100%; box-sizing: border-box; font-size: 0.9em; padding: 4px; border: 1px solid #ccc; border-radius: 3px; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* Result Table in Modal */
        .result-table { width: 100%; border-collapse: collapse; font-size: 0.9em; }
        .result-table th, .result-table td { border: 1px solid #ddd; padding: 6px; text-align: left; }
        .result-table th { background: #f5f5f5; font-weight: bold; }
        .res-num { text-align: right; font-family: monospace; }
        .res-good { color: #2e7d32; font-weight: bold; }
        .res-bad { color: #c62828; font-weight: bold; }
    </style>
</head>
<body>
    <div id="sessionExpiredWarning">Ihre Sitzung ist abgelaufen. Bitte melden Sie sich erneut an, um Datenverlust zu vermeiden.</div>

    <div class="app-header">
        <div class="app-title">Objektverwaltung Pro <span id="loggedInUser" style="font-size:0.6em; font-weight:normal; color:#555;"></span></div>
        <div class="cloud-actions">
            <button onclick="openTaxModal()" class="finance-btn" title="Steuerschl√ºssel verwalten">üõ†Ô∏è Steuerschl√ºssel</button>
            <button onclick="openSollstellungModal()" class="finance-btn" title="Monatliche Mieten berechnen">üí∞ Sollstellung</button>
            <span style="border-left: 1px solid #ccc; height: 20px; margin: 0 5px;"></span>
            
            <button onclick="createAbrechnungDummy()" class="test-btn" title="Erstellt komplexe Abrechnungs-Daten">üß™ Abrechnungs-Dummy</button>
            
            <button id="msLoginBtn" onclick="handleMicrosoftLogin()" class="onedrive-btn">üîë Login</button>
            <button id="msLogoutBtn" onclick="handleLogout()" class="warn-btn" style="display:none;">üîí Logout</button>
            <span style="border-left: 1px solid #ccc; height: 20px; margin: 0 5px;"></span>
            <button id="cloudSaveBtn" onclick="saveToOneDrive(true)" disabled>üíæ Speichern</button>
            <button onclick="speichereDateiLokal()" class="local-btn">üìÇ Sichern</button>
            <button onclick="ladeDateiLokal()" class="local-btn">üìÇ Laden</button>
            <span id="onedriveStatus" class="onedrive-status"></span>
        </div>
    </div>

    <div style="max-width: 1200px; margin: 0 auto;">
        <div id="loginMessage">
            <h2>üîí Zugriff gesch√ºtzt</h2>
            <p>Bitte melden Sie sich an oder laden Sie eine lokale Datei.</p>
        </div>

        <div id="protectedContent">
            <div id="filterBanner">
                <span id="filterText">Filter aktiv</span>
                <button onclick="toggleFilter(null)">Filter aufheben</button>
            </div>

            <div class="tab-bar">
                <button class="tab-btn active" onclick="switchTab('objekte')">üè† Objekte</button>
                <button class="tab-btn" onclick="switchTab('haeuser')">üèòÔ∏è H√§user</button>
                <button class="tab-btn" onclick="switchTab('einheiten')">üö™ Einheiten</button>
                <button class="tab-btn" onclick="switchTab('kosten')">üìâ BK-Abrechnung</button> 
                <div class="report-actions">
                    <button onclick="generateObjectReportPDF()" class="report-btn">üìÑ Objekt-Status PDF</button>
                    <button onclick="generateHouseReportPDF()" class="report-btn">üèòÔ∏è Haus-Status PDF</button>
                    <button onclick="generateUnitReportPDF()" class="report-btn">üìã Vermietungsliste PDF</button>
                </div>
                <a href="kontakte.html" style="margin-left:10px; text-decoration:none;"><button>üë• Kontakte</button></a>
            </div>

            <div id="panelObjekte" class="panel active">
                <button class="primary-btn" onclick="openObjektMask()">+ Neues Objekt anlegen</button>
                <div style="margin-top:10px;"><input type="checkbox" onchange="toggleAll('objekteListe', this.checked)"> Alle ausw√§hlen</div>
                <div id="objekteListe" style="margin-top: 15px;"></div>
            </div>

            <div id="panelHaeuser" class="panel">
                <button class="primary-btn" onclick="openHausMask()">+ Neues Haus anlegen</button>
                <div style="margin-top:10px;"><input type="checkbox" onchange="toggleAll('haeuserListe', this.checked)"> Alle ausw√§hlen</div>
                <div id="haeuserListe" style="margin-top: 15px;"></div>
            </div>

            <div id="panelEinheiten" class="panel">
                <button class="primary-btn" onclick="openEinheitMask()">+ Neue Einheit anlegen</button>
                <div style="margin-top:10px;"><input type="checkbox" onchange="toggleAll('einheitenListe', this.checked)"> Alle ausw√§hlen</div>
                <div id="einheitenListe" style="margin-top: 15px;"></div>
            </div>

            <div id="panelKosten" class="panel">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:10px;">
                    <div style="display:flex; gap:10px; align-items:center;">
                        <label><b>1. Objekt w√§hlen:</b></label>
                        <select id="kostenObjektSelect" onchange="renderAbrechnungsListe()" style="padding:5px; font-weight:bold;"></select>
                    </div>
                    <button class="primary-btn" onclick="openNeueAbrechnung()">+ Neuer Veranlagungszeitraum</button>
                </div>

                <div id="abrechnungWrapper" style="display:none;">
                    <div style="display:flex; gap:10px; margin-bottom:10px;">
                        <div style="flex:1; border:1px solid #ccc; border-radius:4px; padding:10px; max-height:500px; overflow-y:auto; background:#f9f9f9;">
                            <b>2. Zeitraum w√§hlen:</b>
                            <div id="abrechnungenListe" style="margin-top:5px;"></div>
                        </div>
                        <div style="flex:4; border:1px solid #ccc; border-radius:4px; padding:10px; background:white;">
                            <div id="kostenEditor" style="display:none;">
                                <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:2px solid #2e7d32; padding-bottom:5px; margin-bottom:10px;">
                                    <h3 style="margin:0; color:#2e7d32;">Erfassung: <span id="editorTitle"></span></h3>
                                    <div style="display:flex; gap:5px;">
                                        <button onclick="simulateAbrechnung()" class="test-btn">üßÆ Abrechnung simulieren</button>
                                        <span id="abrStatusBadge" style="padding:5px 10px; border-radius:4px; font-weight:bold; margin-right:10px;"></span>
                                        <button id="btnLockAbr" onclick="toggleAbrechnungStatus(true)" class="finance-btn">üîí Abschlie√üen</button>
                                        <button id="btnUnlockAbr" onclick="toggleAbrechnungStatus(false)" class="warn-btn" style="display:none;">üîì √ñffnen (Korrektur)</button>
                                        <button id="btnDelAbr" onclick="deleteAbrechnungComplete()" class="warn-btn">üóëÔ∏è Zeitraum L√∂schen</button>
                                    </div>
                                </div>
                                <input type="hidden" id="currentAbrechnungId">
                                <div class="kosten-header" style="grid-template-columns: 0.8fr 1.8fr 1fr 0.8fr 1fr 0.6fr 1fr 0.8fr 1fr 30px;">
                                    <div>Konto</div><div>Beschreibung</div><div>Brutto ‚Ç¨</div><div>Lohn ‚Ç¨</div><div>Lohn-Art</div><div>VSt-Key</div><div>Netto ‚Ç¨</div><div>Vorsteuer ‚Ç¨</div><div>Verteiler</div><div></div>
                                </div>
                                <div id="kostenListe" style="max-height:400px; overflow-y:auto; border:1px solid #ddd; border-top:none;"></div>
                                <div id="kostenActions" style="margin-top:10px; display:flex; gap:10px;">
                                    <button class="primary-btn" onclick="addKostenRow()">+ Kostenposition</button>
                                    <button class="finance-btn" onclick="openSplitModal()">‚úÇÔ∏è Split-Buchung</button>
                                </div>
                                <div class="kosten-footer">
                                    <div>Summe Netto: <span id="sumKostenNetto">0,00 ‚Ç¨</span></div>
                                    <div>Summe Vorsteuer: <span id="sumKostenSteuer">0,00 ‚Ç¨</span></div>
                                    <div>Summe Brutto: <span id="sumKostenBrutto" style="color:#2e7d32;">0,00 ‚Ç¨</span></div>
                                </div>
                                <div style="text-align:right; margin-top:20px;">
                                    <button id="btnSaveKosten" class="primary-btn" onclick="saveKostenErfassung()">üíæ Speichern</button>
                                </div>
                            </div>
                            <div id="kostenPlaceholder" style="text-align:center; padding:50px; color:#777;">
                                ‚¨ÖÔ∏è Bitte links einen Zeitraum w√§hlen oder neu anlegen.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODALS -->
    <div id="resultModal" class="modal-overlay" onclick="if(event.target===this)this.classList.remove('active')">
        <div class="modal-content" style="max-width:900px;">
            <h3>üìä Abrechnungs-Ergebnis (Vorschau)</h3>
            <div id="resultContent" style="max-height:60vh; overflow-y:auto;"></div>
            <div class="modal-actions">
                <button onclick="document.getElementById('resultModal').classList.remove('active')">Schlie√üen</button>
                <button class="primary-btn" onclick="alert('PDF Funktion folgt im n√§chsten Schritt!')">Als PDF drucken</button>
            </div>
        </div>
    </div>

    <div id="verbrauchsdatenModal" class="modal-overlay" onclick="if(event.target===this)this.classList.remove('active')">
        <div class="modal-content" style="max-width:1100px; height:85vh; display:flex; flex-direction:column;">
            <h3>üìä Z√§hler & Verbrauchsdaten</h3>
            <input type="hidden" id="verbrauchEinheitId">
            <h4 id="verbrauchTitle" style="color:#2e7d32; margin-bottom:10px;"></h4>
            <div class="v-tab-bar">
                <div class="v-tab active" onclick="switchVerbrauchTab('personen')">üë• Personen</div>
                <div class="v-tab" onclick="switchVerbrauchTab('zaehler')">üíß‚ö° Z√§hlerst√§nde (Statistik)</div>
                <div class="v-tab" onclick="switchVerbrauchTab('direkt')">üîß Direktkosten / Fremdabrechnung</div>
            </div>
            <div id="vPanel-personen" class="v-panel active" style="flex:1; overflow-y:auto;">
                <p class="sub-info">Erfassung der bewohnten Personenanzahl.</p>
                <div class="verbrauchs-header" style="grid-template-columns: 1fr 1fr 1fr 30px;"><div>Von</div><div>Bis</div><div>Anzahl Pers.</div><div></div></div>
                <div id="vList-personen"></div>
                <button onclick="addPersonenRow()" class="primary-btn" style="margin-top:10px;">+ Zeitraum</button>
            </div>
            <div id="vPanel-zaehler" class="v-panel" style="flex:1; overflow-y:auto;">
                <p class="sub-info">Statistische Erfassung von Z√§hlerst√§nden.</p>
                <div class="verbrauchs-header" style="grid-template-columns: 1fr 1fr 1fr 1fr 0.8fr 0.8fr 0.8fr 30px;"><div>Z√§hler-Nr.</div><div>Art</div><div>Von</div><div>Bis</div><div>Start</div><div>Ende</div><div>Verbrauch</div><div></div></div>
                <div id="vList-zaehler"></div>
                <button onclick="addZaehlerRow()" class="primary-btn" style="margin-top:10px;">+ Z√§hlerstand erfassen</button>
            </div>
            <div id="vPanel-direkt" class="v-panel" style="flex:1; overflow-y:auto;">
                <p class="sub-info">Erfassung der Kosten lt. Einzelabrechnung (z.B. Techem).</p>
                <div class="verbrauchs-header" style="grid-template-columns: 1.2fr 1.5fr 0.8fr 0.8fr 0.8fr 0.6fr 0.8fr 0.7fr 0.8fr 0.8fr 30px; font-size:0.8em;"><div>Art</div><div>Beschreibung</div><div>Von</div><div>Bis</div><div>Brutto ‚Ç¨</div><div>VSt-Key</div><div>Netto ‚Ç¨</div><div>Lohn ‚Ç¨</div><div>Lohn-Art</div><div>Vorsteuer ‚Ç¨</div><div></div></div>
                <div id="vList-direkt"></div>
                <button onclick="addDirektRow()" class="primary-btn" style="margin-top:10px;">+ Kostenposition</button>
            </div>
            <div class="modal-actions" style="margin-top:auto; padding-top:15px; border-top:1px solid #eee;">
                <button onclick="document.getElementById('verbrauchsdatenModal').classList.remove('active')">Schlie√üen</button>
                <button class="primary-btn" onclick="saveVerbrauchsdaten()">Speichern</button>
            </div>
        </div>
    </div>

    <div id="splitModal" class="modal-overlay" onclick="if(event.target===this)this.classList.remove('active')">
        <div class="modal-content" style="max-width:1000px;">
            <h3>‚úÇÔ∏è Split-Buchung erfassen</h3>
            <div style="background:#e3f2fd; padding:15px; border-radius:4px; margin-bottom:15px;">
                <label style="font-weight:bold; font-size:1.1em;">Gesamtsumme Rechnung (Brutto):</label>
                <input type="number" step="0.01" id="splitTotalInput" style="font-size:1.2em; width:150px; font-weight:bold;" placeholder="0,00" oninput="calcSplitRest()"> <span style="font-size:1.2em;">‚Ç¨</span>
            </div>
            <div class="split-header" style="grid-template-columns: 0.8fr 1.5fr 0.8fr 0.8fr 0.8fr 0.6fr 0.8fr 30px;"><div>Betrag ‚Ç¨</div><div>Beschreibung</div><div>Konto</div><div>Lohn ‚Ç¨</div><div>Lohn-Art</div><div>VSt-Key</div><div>Verteilung</div><div></div></div>
            <div id="splitRowsContainer" style="max-height:300px; overflow-y:auto; border:1px solid #ccc; padding:5px; margin-bottom:10px;"></div>
            <button onclick="addSplitRow()" class="finance-btn" style="font-size:0.8em;">+ Zeile hinzuf√ºgen</button>
            <div style="margin-top:15px; padding-top:10px; border-top:2px solid #ccc; display:flex; justify-content:space-between; align-items:center;">
                <div style="font-size:1.1em;"><span>Erfasst: </span><span id="splitSummeErfasst">0,00 ‚Ç¨</span></div>
                <div style="font-size:1.1em; font-weight:bold;"><span>Rest: </span><span id="splitSummeRest" style="color:red;">0,00 ‚Ç¨</span></div>
            </div>
            <div class="modal-actions">
                <button onclick="document.getElementById('splitModal').classList.remove('active')">Abbrechen</button>
                <button class="primary-btn" id="btnApplySplit" onclick="applySplitBuchung()" disabled>√úbernehmen</button>
            </div>
        </div>
    </div>

    <div id="abrechnungModal" class="modal-overlay" onclick="if(event.target===this)this.classList.remove('active')">
        <div class="modal-content" style="max-width:400px;">
            <h3>Neuer Veranlagungszeitraum</h3>
            <label>Bezeichnung (z.B. Jahr 2024):</label><input type="text" id="newAbrName">
            <label>Von:</label><input type="date" id="newAbrVon">
            <label>Bis:</label><input type="date" id="newAbrBis">
            <div class="modal-actions"><button onclick="document.getElementById('abrechnungModal').classList.remove('active')">Abbrechen</button><button class="primary-btn" onclick="createAbrechnung()">Anlegen</button></div>
        </div>
    </div>

    <div id="taxModal" class="modal-draggable">
        <div class="modal-header-drag" onmousedown="startDrag(event, 'taxModal')"><span>Steuerschl√ºssel (DATEV)</span><button onclick="document.getElementById('taxModal').classList.remove('active')" style="background:transparent; border:none; color:white; font-weight:bold; cursor:pointer;">X</button></div>
        <div class="modal-body">
            <div style="max-height:300px; overflow-y:auto; margin-bottom:15px; border:1px solid #ccc;"><table class="tax-table"><thead><tr><th>Nr.</th><th>Bezeichnung</th><th>% Satz</th><th></th></tr></thead><tbody id="taxTableBody"></tbody></table></div>
            <div style="background:#eee; padding:10px; border-radius:4px;"><b>Neu:</b><div style="display:flex; gap:5px; margin-top:5px;"><input type="text" id="newTaxId" placeholder="Nr" style="width:60px;"><input type="text" id="newTaxLabel" placeholder="Bezeichnung" style="flex:1;"><input type="number" id="newTaxRate" placeholder="%" style="width:60px;"><button onclick="addTaxKey()" class="primary-btn">+</button></div></div>
        </div>
    </div>

    <div id="verteilModal" class="modal-draggable">
        <div class="modal-header-drag" onmousedown="startDrag(event, 'verteilModal')"><span>Verteilerschl√ºssel</span><button onclick="document.getElementById('verteilModal').classList.remove('active')" style="background:transparent; border:none; color:white; font-weight:bold; cursor:pointer;">X</button></div>
        <div class="modal-body">
            <div style="max-height:300px; overflow-y:auto; margin-bottom:15px; border:1px solid #ccc;"><table class="tax-table"><thead><tr><th>ID</th><th>Bezeichnung</th><th></th></tr></thead><tbody id="verteilTableBody"></tbody></table></div>
            <div style="background:#eee; padding:10px; border-radius:4px;"><b>Neu:</b><div style="display:flex; gap:5px; margin-top:5px;"><input type="text" id="newVerteilId" placeholder="ID"><input type="text" id="newVerteilLabel" placeholder="Bezeichnung" style="flex:1;"><button onclick="addVerteilKey()" class="primary-btn">+</button></div></div>
        </div>
    </div>

    <div id="objektModal" class="modal-overlay" onclick="if(event.target===this)this.classList.remove('active')">
        <div class="modal-content">
            <h3>Objekt bearbeiten</h3>
            <input type="hidden" id="objektIdInput">
            <div style="display:flex; gap:10px;"><div style="flex:1"><label>Objekt-Nr.*:</label><input type="text" id="objektNummerInput" readonly style="background:#eee;"></div><div style="flex:2"><label>Bez./Adresse*:</label><input type="text" id="objektNameInput"></div></div>
            <div style="display:flex; gap:10px;"><div style="flex:1"><label>Soll H√§user:</label><input type="number" id="objektSollHaeuser"></div><div style="flex:1"><label>Gesamtfl√§che:</label><input type="number" step="0.01" id="objektFlaecheInput"></div><div style="flex:1"><label>Gesamt MEA:</label><input type="number" step="0.001" id="objektMeaInput"></div></div>
            <div style="margin-top:10px;"><label>Steuer-Status:</label><select id="objektSteuerStatus"><option value="opt">Mit USt/Vorsteuer (Optiert)</option><option value="none">Ohne USt</option><option value="mixed">Gemischt</option></select></div>
            <div class="modal-actions"><button onclick="document.getElementById('objektModal').classList.remove('active')">Abbrechen</button><button class="primary-btn" onclick="saveObjekt()">Speichern</button><button class="warn-btn" onclick="deleteObjekt()" style="float:left;">L√∂schen</button></div>
        </div>
    </div>

    <div id="hausModal" class="modal-overlay" onclick="if(event.target===this)this.classList.remove('active')">
        <div class="modal-content">
            <h3>Haus bearbeiten</h3>
            <input type="hidden" id="hausIdInput">
            <div style="display:flex; gap:10px;"><div style="flex:1;"><label>Objekt*:</label><select id="hausObjektSelect"></select></div><div style="flex:1;"><label>ID:</label><input type="text" id="hausNummerDisplay" readonly style="background:#eee;"></div><div style="flex:2;"><label>Bez.*:</label><input type="text" id="hausBezeichnungInput"></div></div>
            <h4 style="margin-top:15px; margin-bottom:5px;">Validierungs-Matrix</h4>
            <div class="matrix-wrapper"><table class="soll-matrix"><thead><tr><th>Typ</th><th>Soll Anz.</th><th>Ist</th><th>Diff</th><th>Soll Fl√§che</th><th>Ist</th><th>Diff</th></tr></thead><tbody id="hausSollMatrixBody"></tbody></table></div>
            <div style="display:flex; gap:10px; margin-top:10px;"><div style="flex:1;"><label>Gesamt MEA (Soll):</label><input type="number" step="0.001" id="hausAnteileInput"></div></div>
            <div class="modal-actions"><button onclick="document.getElementById('hausModal').classList.remove('active')">Abbrechen</button><button class="primary-btn" onclick="saveHaus()">Speichern</button><button class="warn-btn" onclick="deleteHaus()" style="float:left;">L√∂schen</button></div>
        </div>
    </div>

    <div id="einheitModal" class="modal-overlay" onclick="if(event.target===this)this.classList.remove('active')">
        <div class="modal-content">
            <h3>Einheit bearbeiten</h3>
            <input type="hidden" id="einheitIdInput">
            <div style="display:flex; gap:10px;"><div style="flex:1;"><label>Objekt*:</label><select id="einheitObjektSelect" onchange="filterHaeuserDropdown(true)"></select></div><div style="flex:1;"><label>Haus*:</label><select id="einheitHausSelect" onchange="updateHausAvailability(this.value)"></select></div><div style="flex:1;"><label>ID:</label><input type="text" id="einheitNummerDisplay" readonly style="background:#eee;"></div></div>
            
            <label style="margin-top:10px; display:block; font-size:0.9em; font-weight:bold;">Verf√ºgbarkeit im Haus:</label>
            <div id="hausTypeOverview" class="type-overview-container">
                <span style="color:#666; font-style:italic;">Bitte erst ein Haus ausw√§hlen...</span>
            </div>

            <div style="display:flex; gap:10px;"><div style="flex:2;"><label>Lage/Bez.*:</label><input type="text" id="einheitNameInput"></div><div style="flex:1;"><label>Typ:</label><select id="einheitTypSelect"></select></div></div>
            <div style="display:flex; gap:10px;"><div style="flex:1;"><label>Fl√§che (m¬≤):</label><input type="number" step="0.01" id="einheitFlaecheInput"></div><div style="flex:1;"><label>Zimmer:</label><input type="number" step="0.5" id="einheitZimmerInput"></div><div style="flex:1;"><label>MEA:</label><input type="number" step="0.001" id="einheitMeaInput"></div></div>
            <div class="section-header"><span>Miet-Konditionen</span><button type="button" onclick="addKonditionRow()" style="font-size:0.8em;">+ Position</button></div>
            <div style="background:#f9f9f9; padding:5px; border:1px solid #eee; margin-bottom:10px; max-height:250px; overflow-y:auto;"><div id="konditionenListe"></div></div>
            <div class="section-header">Belegung</div><div id="belegungListe" class="sub-list-container"></div><button type="button" onclick="addBelegungRow()" style="margin-top:5px;">+ Mieterwechsel</button>
            <div class="section-header">Historie</div><div id="historieListe" class="sub-list-container"></div><button type="button" onclick="addHistorieRow()" style="margin-top:5px;">+ Eintrag</button>
            <div class="modal-actions"><button onclick="document.getElementById('einheitModal').classList.remove('active')">Abbrechen</button><button class="primary-btn" onclick="saveEinheit()">Speichern</button><button class="warn-btn" onclick="deleteEinheit()" style="float:left;">L√∂schen</button></div>
        </div>
    </div>

    <div id="sollstellungModal" class="modal-overlay" onclick="if(event.target===this)this.classList.remove('active')">
        <div class="modal-content" style="max-width:500px;">
            <h3>üí∞ Sollstellung generieren</h3>
            <label>Abrechnungs-Monat:</label><input type="month" id="sollMonatInput">
            <label style="margin-top:10px; display:block;">Buchungsdatum:</label><input type="date" id="sollBuchungsdatum">
            <div id="sollLog" style="background:#333; color:#0f0; padding:10px; height:150px; overflow-y:auto; margin-top:10px; font-size:0.8em; display:none;"></div>
            <div class="modal-actions"><button onclick="document.getElementById('sollstellungModal').classList.remove('active')">Schlie√üen</button><button class="finance-btn" onclick="runSollstellung()">Starten</button></div>
        </div>
    </div>

    <div id="kontoModal" class="modal-overlay" onclick="if(event.target===this)this.classList.remove('active')">
        <div class="modal-content" style="max-width:1000px;">
            <h3>üí∂ Mieterkonto</h3>
            <input type="hidden" id="kontoEinheitId"><h4 id="kontoTitle" style="color:#0078d4;"></h4>
            <div style="display:flex; justify-content:space-between; margin:10px 0;"><div><select id="kontoJahrSelect" onchange="renderKontoTable()"><option value="all">Alle Jahre</option></select></div><div><button class="warn-btn" onclick="resetKonto()">üßπ Bereinigen</button><button class="primary-btn" onclick="openManuelleBuchung()">+ Buchung</button><button onclick="exportKontoPDF()">üñ®Ô∏è PDF</button></div></div>
            <div class="sub-list-container" style="max-height:500px;"><table class="konto-tabelle"><thead><tr><th>Korr.</th><th>Datum</th><th>Text</th><th>Konto</th><th>St-S</th><th class="text-right">Soll</th><th class="text-right">Haben</th><th class="text-right">Saldo</th><th></th></tr></thead><tbody id="kontoBody"></tbody><tfoot><tr style="font-weight:bold; background:#eee;"><td colspan="5">Endstand:</td><td id="sumSoll" class="text-right"></td><td id="sumHaben" class="text-right"></td><td id="sumSaldo" class="text-right"></td><td></td></tr></tfoot></table></div>
            <div id="manuelleBuchungForm" style="display:none; background:#e3f2fd; padding:10px; border:1px solid #90caf9; margin-top:10px;"><b>Neue Buchung:</b><div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:5px;"><input type="date" id="mbDatum"><select id="mbTyp"><option value="haben">Haben (Zahlung)</option><option value="soll">Soll (Forderung)</option></select><input type="number" step="0.01" id="mbBetrag" placeholder="Betrag"></div><div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px;"><input type="text" id="mbText" placeholder="Text"><input type="text" id="mbBeleg" placeholder="Beleg"></div><div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:5px;"><input type="text" id="mbKonto" placeholder="Gegenkonto"><select id="mbSteuer"></select><button class="primary-btn" onclick="saveManuelleBuchung()">Buchen</button></div></div>
            <div class="modal-actions"><button onclick="document.getElementById('kontoModal').classList.remove('active')">Schlie√üen</button></div>
        </div>
    </div>

    <div id="buchungDetailModal" class="modal-overlay" onclick="if(event.target===this)this.classList.remove('active')">
        <div class="modal-content" style="max-width:600px;">
            <h3>Buchungs-Detail</h3>
            <input type="hidden" id="detailBuchungId"><input type="hidden" id="detailKorrCount">
            <div style="background:#f9f9f9; padding:10px; border-radius:4px; margin-bottom:15px; font-size:0.9em;"><div class="detail-row"><span>ID:</span><span id="detailId"></span></div><div class="detail-row"><span>Korrektur:</span><span id="detailKorrNr" style="font-weight:bold; color:#d32f2f;"></span></div>
            <div style="margin-top:10px; border-top:1px solid #ddd; padding-top:10px;"><label>Datum:</label><input type="date" id="detailDatumInp"><label>Betrag:</label><input type="number" step="0.01" id="detailBetragInp"><label>Text:</label><input type="text" id="detailTextInp"><label>Sachkonto:</label><input type="text" id="detailKontoInp"><label>Steuer:</label><select id="detailSteuerInp"></select></div></div>
            <label>Notiz:</label><textarea id="detailDoku" rows="4"></textarea>
            <div class="modal-actions"><button class="primary-btn" onclick="saveBuchungChanges()">Speichern</button><button onclick="document.getElementById('buchungDetailModal').classList.remove('active')">Schlie√üen</button></div>
        </div>
    </div>

    <script>
        // --- CONSTANTS ---
        const STANDARD_TYPES = [{id:'wohnung',label:'Wohnung'},{id:'gewerbe',label:'Gewerbe'},{id:'halle',label:'Gewerbe-Halle'},{id:'geschaeft',label:'Gesch√§ft'},{id:'garage',label:'Garage'},{id:'parkplatz',label:'Parkplatz'},{id:'keller',label:'Keller'},{id:'garten',label:'Garten'},{id:'sonstige',label:'Sonstige'}];
        const KONDITION_TYPES = ["Kaltmiete","BK-Vorausz.","HK-Vorausz.","Stellplatz","Garage","K√ºchenzuschlag","Mietminderung","Sonstiges"];
        const INTERVALL_OPTS = ['Monatlich','Viertelj√§hrlich','Halbj√§hrlich','J√§hrlich'];
        const LOHN_ARTEN = [{id:'none',label:'-'},{id:'hdl',label:'Haushaltsnahe DL'},{id:'hwl',label:'Handwerkerleistung'}];
        let verteilKeys = [{id:'m2',label:'Fl√§che (m¬≤)'},{id:'mea',label:'MEA'},{id:'einheiten',label:'Einheiten'},{id:'personen',label:'Personen'},{id:'direkt',label:'Direkt (lt. Rg.)'},{id:'m3',label:'Umbauter Raum'},{id:'person_days',label:'Personentage'},{id:'consumption',label:'Verbrauch'},{id:'nutzeinheit',label:'Nutzeinheiten'}];
        let taxKeys = [{id:'2',label:'2 - USt 7%',rate:7},{id:'3',label:'3 - USt 19%',rate:19},{id:'20',label:'20 - USt 0%',rate:0},{id:'8',label:'8 - VSt 7%',rate:7},{id:'9',label:'9 - VSt 19%',rate:19},{id:'30',label:'30 - VSt 0%',rate:0}];
        const TAX_STATUS_MAP = {'opt':{label:'USt/VSt',class:'tax-opt'},'none':{label:'USt-Frei',class:'tax-none'},'mixed':{label:'Gemischt',class:'tax-mixed'}};
        
        // --- AUTH ---
        const msalConfig = { auth: { clientId: "c3cd3be4-3540-46dd-a24c-82eb6ed5542d", authority: "https://login.microsoftonline.com/common", redirectUri: window.location.origin + window.location.pathname } };
        let msalInstance = null, accessToken = null, userEmail = null;
        let dbObjekte = new Map(), dbHaeuser = new Map(), dbEinheiten = new Map(), dbKontakte = new Map(); 
        let dbFinanzen = [], dbAbrechnungen = [], dbKosten = []; 
        let activeFilterId = null, autoSaveTimer = null;

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', async () => {
            loadLocal(); initTaxSelect(); renderTaxTable(); renderVerteilTable();
            try { renderLists(); } catch (err) { console.error("Render Init Error:", err); }
            try { msalInstance = new msal.PublicClientApplication(msalConfig); await msalInstance.initialize(); await versucheSitzungWiederherzustellen(); } catch(e) {}
        });

        // --- HELPER ---
        function safeFloat(val) { if(typeof val==='number') return val; if(!val) return 0; return parseFloat(val.toString().replace(/\./g,'').replace(',','.')) || 0; }
        function formatDate(s) { if(!s) return ""; const p=s.split('-'); return `${p[2]}.${p[1]}.${p[0]}`; }
        function formatNum(n) { return n.toLocaleString('de-DE',{minimumFractionDigits:2,maximumFractionDigits:2}); }
        function pad(n,w) { n=n+''; return n.length>=w?n:new Array(w-n.length+1).join('0')+n; }
        function formatCurrency(n) { return n.toLocaleString('de-DE',{style:'currency',currency:'EUR'}); }
        function validateVal(soll, ist, unit='', tol=0.01) {
            soll=safeFloat(soll); ist=safeFloat(ist); const diff=Math.round((ist-soll)*1000)/1000;
            if(Math.abs(diff)<=tol) return `<div class="validation-row"><span class="stat-ok">‚úÖ ${formatNum(ist)} ${unit} (Soll: ${formatNum(soll)})</span></div>`;
            return `<div class="validation-row"><span class="stat-err">‚ö†Ô∏è ${formatNum(ist)} ${unit} (Soll: ${formatNum(soll)}) <small>Diff: ${diff>0?'+':''}${formatNum(diff)}</small></span></div>`;
        }
        function getNextObjektID() { let max=0; dbObjekte.forEach((o,id)=>{const n=parseInt(id); if(!isNaN(n)&&n>max)max=n;}); return pad(max+1,4); }
        function getNextHausID(oid) { let max=0; dbHaeuser.forEach((h,id)=>{if(id.startsWith(oid+"/")){const n=parseInt(id.split('/').pop()); if(!isNaN(n)&&n>max)max=n;}}); return oid+"/"+pad(max+1,2); }
        function getNextEinheitID(hid) { let max=0; dbEinheiten.forEach((e,id)=>{if(id.startsWith(hid+"/")){const n=parseInt(id.split('/').pop()); if(!isNaN(n)&&n>max)max=n;}}); return hid+"/"+pad(max+1,4); }
        function getNextFinanzId() { return 'tx_'+Date.now()+'_'+Math.random().toString(36).substr(2,5); }
        function switchTab(id) { document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active')); document.querySelector(`.tab-btn[onclick*='${id}']`).classList.add('active'); document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active')); document.getElementById('panel'+id.charAt(0).toUpperCase()+id.slice(1)).classList.add('active'); }
        function toggleFilter(id) { activeFilterId = id; const b=document.getElementById('filterBanner'); if(id){b.style.display='flex'; document.getElementById('filterText').innerHTML=`<b>Fokus:</b> ${dbObjekte.get(id).name}`;}else{b.style.display='none';} renderLists(); }

        // --- RENDER LISTS ---
        function renderLists() {
            const oSel = document.getElementById('hausObjektSelect'); const eObjSel = document.getElementById('einheitObjektSelect'); const kObjSel = document.getElementById('kostenObjektSelect');
            if(oSel) { 
                oSel.innerHTML=""; eObjSel.innerHTML="<option value=''>-- Objekt --</option>"; kObjSel.innerHTML="<option value=''>-- Objekt --</option>"; 
                dbObjekte.forEach((o,id)=>{ oSel.add(new Option(o.name,id)); eObjSel.add(new Option(o.name,id)); kObjSel.add(new Option(o.name,id)); }); 
            }
            
            // OBJEKTE
            const objDiv = document.getElementById('objekteListe'); objDiv.innerHTML = "";
            dbObjekte.forEach((o, id) => {
                if(activeFilterId && activeFilterId !== id) return;
                
                // Aggregation
                const hEntries = Array.from(dbHaeuser.entries()).filter(([hid, h]) => h.objektId === id);
                let istFl=0, istMea=0;
                let typeSummary = {}; 

                hEntries.forEach(([hid, h]) => {
                    // Fl√§che: Matrix bevorzugen, sonst Einheiten
                    let hArea = 0;
                    if(h.sollMatrix) {
                        Object.entries(h.sollMatrix).forEach(([tid, d]) => {
                            hArea += safeFloat(d.area);
                            if(!typeSummary[tid]) typeSummary[tid] = {soll:0, ist:0};
                            typeSummary[tid].soll += (parseInt(d.count)||0);
                        });
                    }
                    // Wenn Matrix leer (0), nimm echte Einheiten
                    if(hArea === 0) {
                        const uArr = Array.from(dbEinheiten.values()).filter(e => e.hausId === hid);
                        hArea = uArr.reduce((s,e) => s + safeFloat(e.flaeche), 0);
                    }
                    istFl += hArea;
                    istMea += safeFloat(h.anteile);

                    // IST-Zustand z√§hlen
                    const uArr = Array.from(dbEinheiten.values()).filter(e => e.hausId === hid);
                    uArr.forEach(u => {
                        if(!typeSummary[u.typ]) typeSummary[u.typ] = {soll:0, ist:0};
                        typeSummary[u.typ].ist++;
                    });
                });

                // Badges bauen
                let typeBadges = '<div style="margin-top:5px; display:flex; gap:5px; flex-wrap:wrap;">';
                Object.entries(typeSummary).forEach(([tid, d]) => {
                    if(d.soll > 0 || d.ist > 0) {
                        const lbl = getTypeLabel(tid);
                        const cls = d.ist === d.soll ? 'full' : (d.ist > d.soll ? 'over' : 'open');
                        typeBadges += `<span class="type-badge ${cls}" style="font-size:0.75em;">${lbl}: ${d.ist}/${d.soll}</span>`;
                    }
                });
                typeBadges += '</div>';

                const stats = `
                    <div class="objekt-stats">
                        ${validateVal(o.sollHaeuser, hEntries.length, 'H√§user')}
                        ${validateVal(o.flaeche, istFl, 'm¬≤')}
                        ${validateVal(o.mea, istMea, 'MEA')}
                    </div>`;
                
                const tSt = TAX_STATUS_MAP[o.steuerStatus || 'opt'];
                objDiv.innerHTML += `
                <div class="liste-item">
                    <input type="checkbox" class="item-checkbox" value="${id}">
                    <div class="liste-content">
                        <h4>${o.name} <small>(${o.nummer})</small> <span class="tax-badge ${tSt.class}">${tSt.label}</span></h4>
                        ${stats}
                        ${typeBadges}
                        <div style="margin-top:5px;">
                            <button onclick="openObjektMask('${id}')">Bearbeiten</button>
                            <button class="filter-btn" onclick="toggleFilter('${id}')">Fokus</button>
                        </div>
                    </div>
                </div>`;
            });

            // H√ÑUSER
            const hDiv = document.getElementById('haeuserListe'); hDiv.innerHTML = "";
            dbHaeuser.forEach((h, id) => {
                if(activeFilterId && h.objektId !== activeFilterId) return;
                const o = dbObjekte.get(h.objektId);
                const uArr = Array.from(dbEinheiten.values()).filter(e => e.hausId === id);
                
                let matrixInfo = "";
                let typeBadges = '<div style="margin-top:5px; display:flex; gap:5px; flex-wrap:wrap;">';
                let sumSollArea=0, sumIstArea=0;
                
                if(h.sollMatrix) {
                    Object.entries(h.sollMatrix).forEach(([typId, data]) => {
                        const unitsOfType = uArr.filter(e => e.typ === typId).length;
                        const areaOfUnits = uArr.filter(e => e.typ === typId).reduce((s,e)=>s+safeFloat(e.flaeche),0);
                        const sollCnt = parseInt(data.count)||0;
                        
                        sumSollArea += safeFloat(data.area);
                        sumIstArea += areaOfUnits;
                        
                        const cls = unitsOfType === sollCnt ? 'full' : (unitsOfType > sollCnt ? 'over' : 'open');
                        typeBadges += `<span class="type-badge ${cls}" style="font-size:0.75em;">${getTypeLabel(typId)}: ${unitsOfType}/${sollCnt}</span>`;
                    });
                    matrixInfo = `<div class="objekt-stats">${validateVal(sumSollArea, sumIstArea, 'm¬≤ (Soll vs Ist)')}</div>`;
                }
                typeBadges += '</div>';
                
                hDiv.innerHTML += `
                <div class="liste-item">
                    <input type="checkbox" class="item-checkbox" value="${id}">
                    <div class="liste-content">
                        <h4>${h.bezeichnung} <small>(${o ? o.name : '?'})</small></h4>
                        ${matrixInfo}
                        ${typeBadges}
                        <div class="detail-box">Einheiten: ${uArr.length} | Ist-Fl√§che: ${formatNum(sumIstArea)} m¬≤</div>
                        <button onclick="openHausMask('${id}')" style="margin-top:5px;">Bearbeiten</button>
                    </div>
                </div>`;
            });

            // EINHEITEN
            const eDiv = document.getElementById('einheitenListe'); eDiv.innerHTML = "";
            dbEinheiten.forEach((e, id) => {
                const h = dbHaeuser.get(e.hausId);
                if(activeFilterId && (!h || h.objektId !== activeFilterId)) return;
                
                let status = '<span class="status-leerstand">LEERSTAND</span>';
                if(e.belegung && e.belegung.length) {
                    const today = new Date().toISOString().split('T')[0];
                    const current = e.belegung.find(b => (b.einzug <= today) && (!b.auszug || b.auszug >= today));
                    if(current) {
                        const m = dbKontakte.get(current.mieterId);
                        const contactInfo = m ? `${m.fn} <small style="color:#666;">${m.email||''} ${m.phone||''}</small>` : '?';
                        status = `<span class="status-vermietet">Vermietet: ${contactInfo}</span>`;
                    }
                }

                eDiv.innerHTML += `
                <div class="liste-item">
                    <input type="checkbox" class="item-checkbox" value="${id}">
                    <div class="liste-content">
                        <div style="display:flex; justify-content:space-between;">
                            <h4>${e.name} <small>(${h ? h.bezeichnung : ''})</small></h4>
                            <div>
                                <button class="finance-btn" onclick="openVerbrauchsdatenModal('${id}')">üìä Z√§hler & Daten</button>
                                <button class="account-btn" onclick="openKontoModal('${id}')">üí∂ Konto</button>
                                <button onclick="openEinheitMask('${id}')">Bearbeiten</button>
                            </div>
                        </div>
                        <div class="detail-box">
                            ${getTypeLabel(e.typ)} | ${formatNum(e.flaeche)} m¬≤ | ${e.zimmer} Zi | ${status}
                        </div>
                    </div>
                </div>`;
            });
            
            const tSel = document.getElementById('einheitTypSelect');
            if(tSel && tSel.options.length === 0) STANDARD_TYPES.forEach(t => tSel.add(new Option(t.label, t.id)));
        }

        // --- NEW: HOUSE AVAILABILITY HELPER ---
        function updateHausAvailability(hausId) {
            const container = document.getElementById('hausTypeOverview');
            if(!hausId) {
                container.innerHTML = '<span style="color:#666; font-style:italic;">Bitte erst ein Haus ausw√§hlen...</span>';
                return;
            }
            const h = dbHaeuser.get(hausId);
            if(!h || !h.sollMatrix) {
                container.innerHTML = '<span style="color:#666;">Keine Matrix f√ºr dieses Haus definiert.</span>';
                return;
            }
            
            const uArr = Array.from(dbEinheiten.values()).filter(e => e.hausId === hausId);
            container.innerHTML = "";
            
            Object.entries(h.sollMatrix).forEach(([typId, data]) => {
                const existing = uArr.filter(e => e.typ === typId).length;
                const total = parseInt(data.count) || 0;
                let cls = 'open'; if(existing === total) cls = 'full'; if(existing > total) cls = 'over';
                
                const badge = document.createElement('span');
                badge.className = `type-badge ${cls}`;
                badge.innerText = `${getTypeLabel(typId)}: ${existing} / ${total}`;
                badge.onclick = () => {
                    document.getElementById('einheitTypSelect').value = typId;
                    document.querySelectorAll('.type-badge').forEach(b => b.classList.remove('selected'));
                    badge.classList.add('selected');
                    const areaInp = document.getElementById('einheitFlaecheInput');
                    if(safeFloat(areaInp.value) === 0 && data.area && total > 0) areaInp.value = (safeFloat(data.area) / total).toFixed(2);
                };
                container.appendChild(badge);
            });
        }

        // --- UPDATED DELETE LOGIC ---
        function deleteObjekt() {
            const id = document.getElementById('objektIdInput').value;
            if(!id) return;
            const hArr = Array.from(dbHaeuser.entries()).filter(([hid, h]) => h.objektId === id);
            let uCount = 0; hArr.forEach(([hid]) => { uCount += Array.from(dbEinheiten.values()).filter(e => e.hausId === hid).length; });
            if(!confirm(`WARNUNG: Objekt l√∂schen?\n\nEs werden mitgel√∂scht:\n- ${hArr.length} H√§user\n- ${uCount} Einheiten\n\nFortfahren?`)) return;
            hArr.forEach(([hid]) => {
                const uArr = Array.from(dbEinheiten.entries()).filter(([eid, e]) => e.hausId === hid);
                uArr.forEach(([eid]) => dbEinheiten.delete(eid));
                dbHaeuser.delete(hid);
            });
            dbObjekte.delete(id);
            saveLocal(); renderLists(); document.getElementById('objektModal').classList.remove('active');
        }

        function deleteHaus() {
            const id = document.getElementById('hausIdInput').value;
            if(!id) return;
            const uArr = Array.from(dbEinheiten.entries()).filter(([eid, e]) => e.hausId === id);
            if(!confirm(`WARNUNG: Haus l√∂schen?\n\nEs werden ${uArr.length} Einheiten mitgel√∂scht.`)) return;
            uArr.forEach(([eid]) => dbEinheiten.delete(eid));
            dbHaeuser.delete(id);
            saveLocal(); renderLists(); document.getElementById('hausModal').classList.remove('active');
        }

        function deleteEinheit() {
            const id = document.getElementById('einheitIdInput').value;
            if(!id) return; if(!confirm("Einheit wirklich l√∂schen?")) return;
            dbEinheiten.delete(id); saveLocal(); renderLists(); document.getElementById('einheitModal').classList.remove('active');
        }

        // --- MASKEN ---
        function openObjektMask(id){ const o=id?dbObjekte.get(id):{}; document.getElementById('objektIdInput').value=id||""; document.getElementById('objektNummerInput').value=id||getNextObjektID(); document.getElementById('objektNameInput').value=o.name||""; document.getElementById('objektSteuerStatus').value=o.steuerStatus||'opt'; document.getElementById('objektSollHaeuser').value=o.sollHaeuser||""; document.getElementById('objektFlaecheInput').value=o.flaeche||""; document.getElementById('objektMeaInput').value=o.mea||""; document.getElementById('objektModal').classList.add('active'); }
        function saveObjekt(){ const id=document.getElementById('objektNummerInput').value; dbObjekte.set(id, { nummer:id, name:document.getElementById('objektNameInput').value, steuerStatus:document.getElementById('objektSteuerStatus').value, sollHaeuser:safeFloat(document.getElementById('objektSollHaeuser').value), flaeche:safeFloat(document.getElementById('objektFlaecheInput').value), mea:safeFloat(document.getElementById('objektMeaInput').value) }); document.getElementById('objektModal').classList.remove('active'); saveLocal(); renderLists(); }
        
        function openHausMask(id){ 
            document.getElementById('hausIdInput').value=id||""; const h=id?dbHaeuser.get(id):{}; 
            document.getElementById('hausBezeichnungInput').value=h.bezeichnung||""; 
            const sel = document.getElementById('hausObjektSelect');
            sel.value=h.objektId||(activeFilterId || ""); sel.disabled = !!activeFilterId && !id;
            document.getElementById('hausNummerDisplay').value=id||""; 
            document.getElementById('hausAnteileInput').value=h.anteile||""; 
            renderHausMatrix(h); document.getElementById('hausModal').classList.add('active'); 
        }
        function saveHaus(){ let id=document.getElementById('hausNummerDisplay').value; if(!id) id=getNextHausID(document.getElementById('hausObjektSelect').value); const mx={}; document.querySelectorAll('#hausSollMatrixBody tr').forEach(tr=>{ mx[tr.dataset.typeId]={count:tr.querySelector('.soll-count').value,area:tr.querySelector('.soll-area').value}; }); dbHaeuser.set(id, {objektId:document.getElementById('hausObjektSelect').value, bezeichnung:document.getElementById('hausBezeichnungInput').value, sollMatrix:mx, anteile:safeFloat(document.getElementById('hausAnteileInput').value)}); document.getElementById('hausModal').classList.remove('active'); saveLocal(); renderLists(); }
        function renderHausMatrix(h){ const b=document.getElementById('hausSollMatrixBody'); b.innerHTML=""; STANDARD_TYPES.forEach(t=>{ b.innerHTML+=`<tr data-type-id="${t.id}"><td>${t.label}</td><td><input type="number" class="soll-count" value="${h&&h.sollMatrix&&h.sollMatrix[t.id]?h.sollMatrix[t.id].count:''}"></td><td class="readonly-val">-</td><td class="diff-val"></td><td><input type="number" step="0.01" class="soll-area" value="${h&&h.sollMatrix&&h.sollMatrix[t.id]?h.sollMatrix[t.id].area:''}"></td><td class="readonly-val">-</td><td class="diff-val"></td></tr>`; }); }
        
        function updateKonditionDatalist() { const l=document.getElementById('konditionTypes')||document.createElement('datalist'); l.id="konditionTypes"; l.innerHTML=""; KONDITION_TYPES.forEach(t=>l.appendChild(new Option(t))); if(!l.parentNode) document.body.appendChild(l); }
        function filterHaeuserDropdown(keep){ const oid=document.getElementById('einheitObjektSelect').value; const h=document.getElementById('einheitHausSelect'); const old=h.value; h.innerHTML=""; Array.from(dbHaeuser.entries()).filter(([hid,x])=>x.objektId===oid).forEach(([hid,x])=>h.add(new Option(x.bezeichnung,hid))); if(keep&&old)h.value=old; updateHausAvailability(h.value); }
        
        function openEinheitMask(id){ 
            updateKonditionDatalist(); const e=id?dbEinheiten.get(id):{}; 
            document.getElementById('einheitIdInput').value=id||""; 
            document.getElementById('einheitNameInput').value=e.name||""; 
            document.getElementById('einheitNummerDisplay').value=id||""; 
            document.getElementById('einheitTypSelect').value=e.typ||"wohnung"; 
            document.getElementById('einheitFlaecheInput').value=e.flaeche||""; 
            document.getElementById('einheitZimmerInput').value=e.zimmer||""; 
            document.getElementById('einheitMeaInput').value=e.mea||""; 
            
            const oSel = document.getElementById('einheitObjektSelect');
            oSel.value = e.objektId || (activeFilterId || ""); oSel.disabled = !!activeFilterId && !id;
            filterHaeuserDropdown(true); 
            if(e.hausId) { document.getElementById('einheitHausSelect').value=e.hausId; updateHausAvailability(e.hausId); } 
            else { updateHausAvailability(document.getElementById('einheitHausSelect').value); }

            const kl=document.getElementById('konditionenListe'); kl.innerHTML=""; if(e.konditionen)e.konditionen.forEach(k=>addKonditionRow(k)); else addKonditionRow();
            const bl=document.getElementById('belegungListe'); bl.innerHTML=""; if(e.belegung)e.belegung.forEach(b=>addBelegungRow(b));
            const hl=document.getElementById('historieListe'); hl.innerHTML=""; if(e.historie)e.historie.forEach(h=>addHistorieRow(h));
            document.getElementById('einheitModal').classList.add('active'); 
        }
        function saveEinheit(){ const id=document.getElementById('einheitNummerDisplay').value||getNextEinheitID(document.getElementById('einheitHausSelect').value); const k=[]; document.querySelectorAll('.kondition-row').forEach(r=>{const l=r.querySelector('.kond-label').value,b=safeFloat(r.querySelector('.kond-betrag').value); if(l&&b)k.push({label:l,betrag:b,konto:r.querySelector('.kond-konto').value,intervall:r.querySelector('.kond-intervall').value,gueltigAb:r.querySelector('.kond-date').value,gueltigBis:r.querySelector('.kond-date-bis').value,steuerKey:r.querySelector('.kond-tax').value});}); 
        const bel=[]; document.querySelectorAll('.belegung-wrapper').forEach(w=>{bel.push({mieterId:w.querySelector('.belegung-mieter').value,einzug:w.querySelector('.belegung-einzug').value,auszug:w.querySelector('.belegung-auszug').value});});
        const his=[]; document.querySelectorAll('.historie-row').forEach(r=>{his.push({date:r.querySelector('.hist-date').value,text:r.querySelector('.hist-desc').value});});
        dbEinheiten.set(id, {hausId:document.getElementById('einheitHausSelect').value,objektId:document.getElementById('einheitObjektSelect').value,name:document.getElementById('einheitNameInput').value,typ:document.getElementById('einheitTypSelect').value,flaeche:safeFloat(document.getElementById('einheitFlaecheInput').value),zimmer:safeFloat(document.getElementById('einheitZimmerInput').value),mea:safeFloat(document.getElementById('einheitMeaInput').value),konditionen:k,belegung:bel,historie:his}); document.getElementById('einheitModal').classList.remove('active'); saveLocal(); renderLists(); }

        function addKonditionRow(d={}) { const c=document.getElementById('konditionenListe'); const r=document.createElement('div'); r.className='kondition-row'; r.innerHTML=`<input class="kond-label" list="konditionTypes" value="${d.label||''}"><input type="number" class="kond-betrag" value="${d.betrag||''}"><input class="kond-konto" value="${d.konto||''}"><select class="kond-intervall">${INTERVALL_OPTS.map(o=>`<option value="${o}" ${d.intervall===o?'selected':''}>${o}</option>`).join('')}</select><input type="date" class="kond-date" value="${d.gueltigAb||''}"><input type="date" class="kond-date-bis" value="${d.gueltigBis||''}"><select class="kond-tax"><option value="">-</option>${taxKeys.map(t=>`<option value="${t.id}" ${d.steuerKey===t.id?'selected':''}>${t.label}</option>`).join('')}</select><button class="finance-btn" onclick="openTaxModal()">‚öôÔ∏è</button><button class="primary-btn" onclick="addKonditionRow({label:this.parentElement.querySelector('.kond-label').value})">+</button><button class="warn-btn" onclick="this.parentElement.remove()">X</button>`; c.appendChild(r); }
        function addBelegungRow(d={}){ const c=document.getElementById('belegungListe'); const w=document.createElement('div'); w.className='belegung-wrapper'; w.innerHTML=`<div class="belegung-row"><select class="belegung-mieter"><option value="">-- Mieter --</option></select><input type="date" class="belegung-einzug" value="${d.einzug||''}"><input type="date" class="belegung-auszug" value="${d.auszug||''}"><button class="warn-btn" onclick="this.parentElement.parentElement.remove()">X</button></div>`; const s=w.querySelector('select'); Array.from(dbKontakte.entries()).sort((a,b)=>(a[1].fn||"").localeCompare(b[1].fn||"")).forEach(([id,k])=>s.add(new Option(k.fn+(k.org?` (${k.org})`:""),id))); if(d.mieterId) s.value=d.mieterId; c.appendChild(w); }
        function addHistorieRow(d={}){ const c=document.getElementById('historieListe'); const r=document.createElement('div'); r.className='historie-row'; r.innerHTML=`<input type="date" class="hist-date" value="${d.date||''}"><input type="text" class="hist-desc" value="${d.text||''}"><button class="warn-btn" onclick="this.parentElement.remove()">X</button>`; c.appendChild(r); }
        function getTypeLabel(id) { const t=STANDARD_TYPES.find(x=>x.id===id); return t?t.label:id; }

        // --- KOSTEN EDITOR ---
        function renderAbrechnungsListe() { const oid=document.getElementById('kostenObjektSelect').value; const c=document.getElementById('abrechnungenListe'); document.getElementById('abrechnungWrapper').style.display=oid?"flex":"none"; c.innerHTML=""; dbAbrechnungen.filter(a=>a.objektId===oid).forEach(a=>{const div=document.createElement('div'); div.style="padding:8px; border-bottom:1px solid #ddd; cursor:pointer; background:white; margin-bottom:2px;"; if(a.status==='closed')div.style.backgroundColor="#f0f0f0"; div.innerHTML=`<b>${a.status==='closed'?'üîí':'üìù'} ${a.name}</b><br><small>${formatDate(a.von)}-${formatDate(a.bis)}</small>`; div.onclick=()=>loadKostenEditor(a.id); c.appendChild(div);}); }
        function openNeueAbrechnung() { document.getElementById('abrechnungModal').classList.add('active'); }
        function createAbrechnung() { const id='abr_'+Date.now(); dbAbrechnungen.push({id, objektId:document.getElementById('kostenObjektSelect').value, name:document.getElementById('newAbrName').value, von:document.getElementById('newAbrVon').value, bis:document.getElementById('newAbrBis').value, status:'open'}); saveLocal(); renderAbrechnungsListe(); document.getElementById('abrechnungModal').classList.remove('active'); loadKostenEditor(id); }
        function loadKostenEditor(abrId) { const abr=dbAbrechnungen.find(a=>a.id===abrId); document.getElementById('currentAbrechnungId').value=abrId; document.getElementById('editorTitle').innerText=abr.name; document.getElementById('kostenPlaceholder').style.display="none"; document.getElementById('kostenEditor').style.display="block"; const isClosed=abr.status==='closed'; document.getElementById('btnLockAbr').style.display=isClosed?'none':'inline-block'; document.getElementById('btnUnlockAbr').style.display=isClosed?'inline-block':'none'; document.getElementById('btnSaveKosten').disabled=isClosed; document.getElementById('kostenActions').style.display=isClosed?'none':'flex'; const l=document.getElementById('kostenListe'); l.innerHTML=""; const k=dbKosten.filter(x=>x.abrechnungId===abrId); if(k.length===0&&!isClosed)addKostenRow(); else k.forEach(x=>addKostenRow(x,isClosed)); updateKostenSums(); }
        function addKostenRow(d={},lock=false) { const c=document.getElementById('kostenListe'); const r=document.createElement('div'); r.className='kosten-row'; r.dataset.id=d.id||getNextFinanzId(); r.innerHTML=`<input class="k-konto" value="${d.konto||''}" ${lock?'disabled':''}><input class="k-text" value="${d.text||''}" ${lock?'disabled':''}><input type="number" step="0.01" class="k-brutto" value="${d.brutto||''}" oninput="calculateRow(this.parentElement)" ${lock?'disabled':''}><input type="number" step="0.01" class="k-lohn" value="${d.lohn||''}" ${lock?'disabled':''}><select class="k-lohn-art" ${lock?'disabled':''}>${LOHN_ARTEN.map(l=>`<option value="${l.id}" ${d.lohnArt===l.id?'selected':''}>${l.label}</option>`).join('')}</select><div style="display:flex;"><select class="k-tax" onchange="calculateRow(this.parentElement)" ${lock?'disabled':''}><option value="">-</option>${taxKeys.map(t=>`<option value="${t.id}" ${d.steuerKey===t.id?'selected':''}>${t.label}</option>`).join('')}</select></div><input class="k-netto" readonly value="${d.netto?formatNum(d.netto):''}"><input class="k-tax-amt" readonly value="${d.steuerBetrag?formatNum(d.steuerBetrag):''}"><div style="display:flex;"><select class="k-verteil" ${lock?'disabled':''}>${verteilKeys.map(v=>`<option value="${v.id}" ${d.verteilKey===v.id?'selected':''}>${v.label}</option>`).join('')}</select></div>${!lock?'<button class="warn-btn" onclick="this.parentElement.remove();updateKostenSums()">X</button>':''}`; c.appendChild(r); }
        function calculateRow(r) { const b=safeFloat(r.querySelector('.k-brutto').value); const tid=r.querySelector('.k-tax').value; let n=b,t=0; if(tid){const k=taxKeys.find(x=>x.id===tid); if(k&&k.rate>0){n=b/(1+k.rate/100); t=b-n;}} r.querySelector('.k-netto').value=formatNum(n); r.querySelector('.k-tax-amt').value=formatNum(t); r.dataset.net=n; r.dataset.tax=t; updateKostenSums(); }
        function updateKostenSums() { let sn=0,st=0,sb=0; document.querySelectorAll('.kosten-row').forEach(r=>{const b=safeFloat(r.querySelector('.k-brutto').value); sb+=b; if(r.dataset.net){sn+=parseFloat(r.dataset.net); st+=parseFloat(r.dataset.tax);}else{calculateRow(r); sn+=parseFloat(r.dataset.net); st+=parseFloat(r.dataset.tax);}}); document.getElementById('sumKostenNetto').innerText=formatCurrency(sn); document.getElementById('sumKostenSteuer').innerText=formatCurrency(st); document.getElementById('sumKostenBrutto').innerText=formatCurrency(sb); }
        function saveKostenErfassung() { const aid=document.getElementById('currentAbrechnungId').value; dbKosten=dbKosten.filter(k=>k.abrechnungId!==aid); document.querySelectorAll('.kosten-row').forEach(r=>{const b=safeFloat(r.querySelector('.k-brutto').value),txt=r.querySelector('.k-text').value; if(b||txt){const tid=r.querySelector('.k-tax').value; let rate=0; if(tid){const k=taxKeys.find(x=>x.id===tid); if(k)rate=k.rate;} const n=b/(1+rate/100); dbKosten.push({id:r.dataset.id,abrechnungId:aid,konto:r.querySelector('.k-konto').value,text:txt,brutto:b,lohn:safeFloat(r.querySelector('.k-lohn').value),lohnArt:r.querySelector('.k-lohn-art').value,steuerKey:tid,netto:n,steuerBetrag:b-n,verteilKey:r.querySelector('.k-verteil').value});}}); saveLocal(); triggerAutoSave(); alert("Gespeichert!"); }
        
        function openSplitModal() { document.getElementById('splitTotalInput').value=""; document.getElementById('splitRowsContainer').innerHTML=""; addSplitRow(); document.getElementById('splitModal').classList.add('active'); }
        function calcSplitRest() { const t=safeFloat(document.getElementById('splitTotalInput').value); let s=0; document.querySelectorAll('.split-amount').forEach(i=>s+=safeFloat(i.value)); document.getElementById('splitSummeRest').innerText=formatCurrency(t-s); document.getElementById('splitSummeErfasst').innerText=formatCurrency(s); document.getElementById('btnApplySplit').disabled=Math.abs(t-s)>0.01; }
        function addSplitRow() { const d=document.createElement('div'); d.className='split-row'; d.innerHTML=`<input type="number" step="0.01" class="split-amount" oninput="calcSplitRest()"><input class="split-text"><input class="split-konto"><input type="number" step="0.01" class="split-lohn"><select class="split-lohn-art">${LOHN_ARTEN.map(l=>`<option value="${l.id}">${l.label}</option>`).join('')}</select><select class="split-tax"><option value="">-</option>${taxKeys.map(t=>`<option value="${t.id}">${t.label}</option>`).join('')}</select><select class="split-verteil">${verteilKeys.map(v=>`<option value="${v.id}">${v.label}</option>`).join('')}</select><button class="warn-btn" onclick="this.parentElement.remove();calcSplitRest()">X</button>`; document.getElementById('splitRowsContainer').appendChild(d); }
        function applySplitBuchung() { document.querySelectorAll('.split-row').forEach(r=>{const a=safeFloat(r.querySelector('.split-amount').value); if(a>0) addKostenRow({brutto:a,text:r.querySelector('.split-text').value,konto:r.querySelector('.split-konto').value,lohn:safeFloat(r.querySelector('.split-lohn').value),lohnArt:r.querySelector('.split-lohn-art').value,steuerKey:r.querySelector('.split-tax').value,verteilKey:r.querySelector('.split-verteil').value});}); document.getElementById('splitModal').classList.remove('active'); updateKostenSums(); }

        // --- VERBRAUCH ---
        function openVerbrauchsdatenModal(id) { const e=dbEinheiten.get(id); document.getElementById('verbrauchEinheitId').value=id; document.getElementById('verbrauchTitle').innerText=e.name; if(!e.verbrauchsdaten)e.verbrauchsdaten={personen:[],zaehler:[],direkt:[]}; renderVerbrauchLists(e.verbrauchsdaten); switchVerbrauchTab('personen'); document.getElementById('verbrauchsdatenModal').classList.add('active'); }
        function switchVerbrauchTab(t) { document.querySelectorAll('.v-tab').forEach(x=>x.classList.remove('active')); document.querySelectorAll('.v-panel').forEach(x=>x.classList.remove('active')); document.querySelector(`.v-tab[onclick*='${t}']`).classList.add('active'); document.getElementById('vPanel-'+t).classList.add('active'); }
        function renderVerbrauchLists(d) { document.getElementById('vList-personen').innerHTML="";if(d.personen)d.personen.forEach(x=>addPersonenRow(x)); document.getElementById('vList-zaehler').innerHTML="";if(d.zaehler)d.zaehler.forEach(x=>addZaehlerRow(x)); document.getElementById('vList-direkt').innerHTML="";if(d.direkt)d.direkt.forEach(x=>addDirektRow(x)); }
        function addPersonenRow(d={}){ const r=document.createElement('div'); r.className='verbrauchs-row'; r.style.gridTemplateColumns="1fr 1fr 1fr 30px"; r.innerHTML=`<input type="date" class="v-von" value="${d.von||''}"><input type="date" class="v-bis" value="${d.bis||''}"><input type="number" class="v-anz" value="${d.anzahl||''}"><button class="warn-btn" onclick="this.parentElement.remove()">X</button>`; document.getElementById('vList-personen').appendChild(r); }
        function addZaehlerRow(d={}){ const r=document.createElement('div'); r.className='verbrauchs-row'; r.style.gridTemplateColumns="1fr 1fr 1fr 1fr 0.8fr 0.8fr 0.8fr 30px"; r.innerHTML=`<input class="v-nr" value="${d.nr||''}"><select class="v-art"><option>Wasser Kalt</option><option>Wasser Warm</option><option>Strom</option><option>Heizung</option></select><input type="date" class="v-von" value="${d.von||''}"><input type="date" class="v-bis" value="${d.bis||''}"><input type="number" class="v-start" value="${d.standStart||''}"><input type="number" class="v-end" value="${d.standEnde||''}"><input class="v-verbr" readonly style="background:#eee;"><button class="warn-btn" onclick="this.parentElement.remove()">X</button>`; if(d.art)r.querySelector('.v-art').value=d.art; const calc=()=>{const s=safeFloat(r.querySelector('.v-start').value),e=safeFloat(r.querySelector('.v-end').value);r.querySelector('.v-verbr').value=(e>=s)?formatNum(e-s):"Err";}; r.querySelectorAll('input').forEach(i=>i.oninput=calc); calc(); document.getElementById('vList-zaehler').appendChild(r); }
        function addDirektRow(d={}){ const c=document.getElementById('vList-direkt'); const r=document.createElement('div'); r.className='verbrauchs-row'; r.style.gridTemplateColumns="1.2fr 1.5fr 0.8fr 0.8fr 0.8fr 0.6fr 0.8fr 0.7fr 0.8fr 0.8fr 30px"; r.innerHTML=`<select class="v-typ" style="font-weight:bold;"><option>Sonstige Direktkosten</option><option>Heizkosten (Fremd)</option><option>Wasser (Fremd)</option></select><input class="v-text" value="${d.text||''}"><input type="date" class="v-von" value="${d.von||''}"><input type="date" class="v-bis" value="${d.bis||''}"><input type="number" step="0.01" class="v-betrag" value="${d.betrag||''}" oninput="calcDirektRow(this.parentElement)"><select class="v-tax" onchange="calcDirektRow(this.parentElement)"><option value="">-</option>${taxKeys.map(t=>`<option value="${t.id}" ${d.steuerKey===t.id?'selected':''}>${t.label}</option>`).join('')}</select><input class="v-netto" readonly style="background:#f0f0f0;" value="${d.netto?formatNum(d.netto):''}"><input type="number" step="0.01" class="v-lohn" value="${d.lohn||''}"><select class="v-lohn-art">${LOHN_ARTEN.map(l=>`<option value="${l.id}" ${d.lohnArt===l.id?'selected':''}>${l.label}</option>`).join('')}</select><input class="v-vorsteuer" readonly style="background:#f0f0f0;" value="${d.vorsteuer?formatNum(d.vorsteuer):''}"><button class="warn-btn" onclick="this.parentElement.remove()">X</button>`; if(d.typ)r.querySelector('.v-typ').value=d.typ; c.appendChild(r); }
        function calcDirektRow(r){ const b=safeFloat(r.querySelector('.v-betrag').value),tid=r.querySelector('.v-tax').value; let n=b,t=0; if(tid){const k=taxKeys.find(x=>x.id===tid); if(k&&k.rate>0){n=b/(1+k.rate/100); t=b-n;}} r.querySelector('.v-netto').value=formatNum(n); r.querySelector('.v-vorsteuer').value=formatNum(t); }
        function saveVerbrauchsdaten(){ const eid=document.getElementById('verbrauchEinheitId').value, e=dbEinheiten.get(eid), p=[], z=[], d=[]; 
        document.querySelectorAll('#vList-personen .verbrauchs-row').forEach(r=>p.push({von:r.querySelector('.v-von').value,bis:r.querySelector('.v-bis').value,anzahl:safeFloat(r.querySelector('.v-anz').value)}));
        document.querySelectorAll('#vList-zaehler .verbrauchs-row').forEach(r=>z.push({nr:r.querySelector('.v-nr').value,art:r.querySelector('.v-art').value,von:r.querySelector('.v-von').value,bis:r.querySelector('.v-bis').value,standStart:safeFloat(r.querySelector('.v-start').value),standEnde:safeFloat(r.querySelector('.v-end').value)}));
        document.querySelectorAll('#vList-direkt .verbrauchs-row').forEach(r=>{const b=safeFloat(r.querySelector('.v-betrag').value),tid=r.querySelector('.v-tax').value; let n=b,t=0; if(tid){const k=taxKeys.find(x=>x.id===tid); if(k&&k.rate>0){n=b/(1+k.rate/100); t=b-n;}} d.push({typ:r.querySelector('.v-typ').value,text:r.querySelector('.v-text').value,von:r.querySelector('.v-von').value,bis:r.querySelector('.v-bis').value,betrag:b,steuerKey:tid,netto:n,vorsteuer:t,lohn:safeFloat(r.querySelector('.v-lohn').value),lohnArt:r.querySelector('.v-lohn-art').value});});
        e.verbrauchsdaten={personen:p,zaehler:z,direkt:d}; dbEinheiten.set(eid,e); saveLocal(); triggerAutoSave(); document.getElementById('verbrauchsdatenModal').classList.remove('active'); alert("Gespeichert!"); }

        // --- DATA MGMT ---
        function toggleAbrechnungStatus(l){ const aid=document.getElementById('currentAbrechnungId').value,a=dbAbrechnungen.find(x=>x.id===aid); if(!a)return; if(l){if(!confirm("Abschlie√üen?"))return;a.status='closed';}else{if(!confirm("√ñffnen?"))return;a.status='open';} saveLocal(); triggerAutoSave(); renderAbrechnungsListe(); loadKostenEditor(aid); }
        function deleteAbrechnungComplete(){ const aid=document.getElementById('currentAbrechnungId').value; if(!aid||!confirm("Alles l√∂schen?"))return; dbKosten=dbKosten.filter(k=>k.abrechnungId!==aid); dbAbrechnungen=dbAbrechnungen.filter(a=>a.id!==aid); saveLocal(); triggerAutoSave(); document.getElementById('abrechnungWrapper').style.display="none"; document.getElementById('kostenEditor').style.display="none"; renderAbrechnungsListe(); alert("Gel√∂scht."); }
        async function loadFromOneDrive(){ if(!(await getValidToken(true)))return; zeigeStatus("Lade...","saving"); try{const rC=await fetch("https://graph.microsoft.com/v1.0/me/drive/root:/ideenapp/stammdaten.json:/content",{headers:{"Authorization":`Bearer ${accessToken}`}});if(rC.ok){const d=await rC.json();if(d.kontakte)dbKontakte=new Map(d.kontakte);} 
        const rF=await fetch("https://graph.microsoft.com/v1.0/me/drive/root:/ideenapp/finanzen.json:/content",{headers:{"Authorization":`Bearer ${accessToken}`}});if(rF.ok){const d=await rF.json();if(d.finanzen)dbFinanzen=d.finanzen;if(d.taxKeys)taxKeys=d.taxKeys;if(d.verteilKeys)verteilKeys=d.verteilKeys;if(d.abrechnungen)dbAbrechnungen=d.abrechnungen;if(d.kosten)dbKosten=d.kosten;}
        const rI=await fetch("https://graph.microsoft.com/v1.0/me/drive/root:/ideenapp/immobilien.json:/content",{headers:{"Authorization":`Bearer ${accessToken}`}});if(rI.ok){const d=await rI.json();if(d.objekte)dbObjekte=new Map(d.objekte);if(d.haeuser)dbHaeuser=new Map(d.haeuser);if(d.einheiten)dbEinheiten=new Map(d.einheiten);saveLocal();renderLists();zeigeStatus("Geladen","success");} }catch(e){zeigeStatus(e.message,"error");} }
        async function saveToOneDrive(m=true){ if(!(await getValidToken(m)))return; zeigeStatus("Speichere...","saving"); 
        const dI={objekte:Array.from(dbObjekte.entries()),haeuser:Array.from(dbHaeuser.entries()),einheiten:Array.from(dbEinheiten.entries())}, dF={finanzen:dbFinanzen,taxKeys:taxKeys,verteilKeys:verteilKeys,abrechnungen:dbAbrechnungen,kosten:dbKosten};
        await Promise.all([fetch("https://graph.microsoft.com/v1.0/me/drive/root:/ideenapp/immobilien.json:/content",{method:"PUT",headers:{"Authorization":`Bearer ${accessToken}`,"Content-Type":"application/json"},body:JSON.stringify(dI)}),
        fetch("https://graph.microsoft.com/v1.0/me/drive/root:/ideenapp/finanzen.json:/content",{method:"PUT",headers:{"Authorization":`Bearer ${accessToken}`,"Content-Type":"application/json"},body:JSON.stringify(dF)})]); zeigeStatus("Gespeichert","success"); }
        function loadLocal(){ try{const o=localStorage.getItem("immo_objekte");if(o)dbObjekte=new Map(JSON.parse(o));const h=localStorage.getItem("immo_haeuser");if(h)dbHaeuser=new Map(JSON.parse(h));const e=localStorage.getItem("immo_einheiten");if(e)dbEinheiten=new Map(JSON.parse(e));
        const f=localStorage.getItem("immo_finanzen");if(f){const p=JSON.parse(f);dbFinanzen=p.finanzen||p;if(p.taxKeys)taxKeys=p.taxKeys;if(p.verteilKeys)verteilKeys=p.verteilKeys;if(p.abrechnungen)dbAbrechnungen=p.abrechnungen;if(p.kosten)dbKosten=p.kosten;}
        const k=localStorage.getItem("kontakte_personen");if(k)dbKontakte=new Map(JSON.parse(k));}catch(e){} }
        function saveLocal(){ localStorage.setItem("immo_objekte",JSON.stringify(Array.from(dbObjekte.entries())));localStorage.setItem("immo_haeuser",JSON.stringify(Array.from(dbHaeuser.entries())));localStorage.setItem("immo_einheiten",JSON.stringify(Array.from(dbEinheiten.entries())));localStorage.setItem("immo_finanzen",JSON.stringify({finanzen:dbFinanzen,taxKeys:taxKeys,verteilKeys:verteilKeys,abrechnungen:dbAbrechnungen,kosten:dbKosten})); }
        function triggerAutoSave(){ if(!accessToken)return; zeigeStatus("...","info"); clearTimeout(autoSaveTimer); autoSaveTimer=setTimeout(()=>saveToOneDrive(false),2000); }
        async function getValidToken(i=false){ if(!msalInstance)return null; const a=msalInstance.getActiveAccount(); if(!a)return null; try{const r=await msalInstance.acquireTokenSilent({scopes:["Files.ReadWrite"],account:a});accessToken=r.accessToken;return r.accessToken;}catch(e){if(i){try{const r=await msalInstance.acquireTokenPopup({scopes:["Files.ReadWrite"],account:a});accessToken=r.accessToken;return r.accessToken;}catch(e){return null;}}return null;} }
        async function versucheSitzungWiederherzustellen(){ if(sessionStorage.getItem('loginType')==='microsoft'){ const a=await msalInstance.getAccountByHomeId(sessionStorage.getItem('msalAccountIdentifier')); if(a){ msalInstance.setActiveAccount(a); if(await getValidToken(false)){ userEmail=a.username; document.getElementById('loggedInUser').innerText=`(${userEmail})`; document.getElementById('msLoginBtn').style.display='none'; document.getElementById('msLogoutBtn').style.display='inline-block'; document.getElementById('cloudSaveBtn').disabled=false; loadFromOneDrive(); }}}}
        async function handleMicrosoftLogin(){ try{const r=await msalInstance.loginPopup({scopes:["Files.ReadWrite","User.Read"]}); msalInstance.setActiveAccount(r.account); sessionStorage.setItem('loginType','microsoft'); sessionStorage.setItem('msalAccountIdentifier',r.account.homeAccountId); versucheSitzungWiederherzustellen(); }catch(e){} }
        function handleLogout(){ msalInstance.logoutPopup(); sessionStorage.clear(); location.reload(); }
        function zeigeStatus(m,c){ const s=document.getElementById('onedriveStatus'); s.innerText=m; s.className='onedrive-status '+c; s.style.display='inline-flex'; setTimeout(()=>s.style.display='none',3000); }

        // --- FILE IO ---
        async function speichereDateiLokal(){ const d={objekte:Array.from(dbObjekte.entries()),haeuser:Array.from(dbHaeuser.entries()),einheiten:Array.from(dbEinheiten.entries()),finanzen:dbFinanzen,taxKeys:taxKeys,verteilKeys:verteilKeys,abrechnungen:dbAbrechnungen,kosten:dbKosten}; const b=new Blob([JSON.stringify(d,null,2)],{type:"application/json"}); if(window.showSaveFilePicker){try{const h=await window.showSaveFilePicker({suggestedName:"objekte_backup.json"});const w=await h.createWritable();await w.write(b);await w.close();zeigeStatus("Gesichert","success");}catch(e){}}else{const a=document.createElement("a");a.href=URL.createObjectURL(b);a.download="objekte_backup.json";a.click();} }
        async function ladeDateiLokal(){ try{let t;if(window.showOpenFilePicker){const [h]=await window.showOpenFilePicker();const f=await h.getFile();t=await f.text();}else{const i=document.createElement("input");i.type="file";i.click();await new Promise(r=>i.onchange=e=>{const fr=new FileReader();fr.onload=ev=>r(t=ev.target.result);fr.readAsText(e.target.files[0]);});}if(t){const d=JSON.parse(t);if(d.objekte)dbObjekte=new Map(d.objekte);if(d.haeuser)dbHaeuser=new Map(d.haeuser);if(d.einheiten)dbEinheiten=new Map(d.einheiten);if(d.finanzen)dbFinanzen=d.finanzen;if(d.taxKeys)taxKeys=d.taxKeys;if(d.verteilKeys)verteilKeys=d.verteilKeys;if(d.abrechnungen)dbAbrechnungen=d.abrechnungen;if(d.kosten)dbKosten=d.kosten;saveLocal();renderLists();alert("Geladen!");}}catch(e){alert("Fehler");} }
        function createDummyData(){ 
            if(!confirm("Musterdaten (Wohnpark + Z√§hler + Lohnkosten) erzeugen? \nPr√ºfung erfolgt in Konsole und Alert.")) return;
            console.group("Erstelle Testdaten...");
            const oid = getNextObjektID();
            const oData = { nummer: oid, name: "Wohnpark Test", plz: "12345", ort: "Musterstadt", flaeche: 150, mea: 1000, sollHaeuser: 1, steuerStatus: "opt" };
            dbObjekte.set(oid, oData);
            
            const hid = getNextHausID(oid);
            const matrix = {}; matrix['wohnung'] = { count: 2, area: 100, label: "Wohnung" }; matrix['gewerbe'] = { count: 1, area: 50, label: "Gewerbe" };
            const hData = { objektId: oid, bezeichnung: "Haus A", anteile: 1000, sollMatrix: matrix, steuerStatus: "opt" };
            dbHaeuser.set(hid, hData);
            
            let eid = getNextEinheitID(hid);
            const now = new Date(); const year = now.getFullYear();
            const u1Data = { 
                hausId: hid, name: "EG Links", typ: "wohnung", flaeche: 50, zimmer: 2, mea: 333.33,
                konditionen: [
                    { id: 'k1', label: 'Kaltmiete', betrag: 500, konto: '8000', intervall: 'Monatlich', gueltigAb: `${year}-01-01`, steuerKey: '2' }, 
                    { id: 'k2', label: 'BK-Vorausz.', betrag: 100, konto: '8010', intervall: 'Monatlich', gueltigAb: `${year}-01-01`, steuerKey: '20' } 
                ], 
                belegung: [{ mieterId: "dummy_mieter", einzug: `${year}-01-01`, auszug: "" }],
                verbrauchsdaten: {
                    personen: [{ von: `${year}-01-01`, bis: "", anzahl: 2 }],
                    zaehler: [{ nr: "WZ-101", art: "Wasser Kalt", von: `${year}-01-01`, bis: `${year}-12-31`, standStart: 100.0, standEnde: 145.0 }],
                    direkt: [{ typ: "Sonstige Direktkosten", text: "Wartung Therme", von: `${year}-01-01`, bis: `${year}-12-31`, betrag: 119, lohn: 50, lohnArt: 'hwl', steuerKey: '9', netto: 100, vorsteuer: 19 }]
                }
            };
            dbEinheiten.set(eid, u1Data);

            eid = getNextEinheitID(hid);
            const u2Data = { hausId: hid, name: "EG Rechts", typ: "wohnung", flaeche: 50, zimmer: 2, mea: 333.33, belegung: [] };
            dbEinheiten.set(eid, u2Data);

            eid = getNextEinheitID(hid);
            const u3Data = { 
                hausId: hid, name: "B√ºro OG", typ: "gewerbe", flaeche: 50, zimmer: 3, mea: 333.34, 
                konditionen: [{ id: 'k1', label: 'Kaltmiete', betrag: 800, konto: '8000', intervall: 'Monatlich', gueltigAb: `${year}-01-01`, steuerKey: '3' }],
                belegung: [] 
            };
            dbEinheiten.set(eid, u3Data);

            const abrId = 'abr_' + Date.now();
            const aData = { id: abrId, objektId: oid, name: `Betriebskosten ${year}`, von: `${year}-01-01`, bis: `${year}-12-31`, status: 'open' };
            dbAbrechnungen.push(aData);
            const kData = { id: getNextFinanzId(), abrechnungId: abrId, konto: "4010", text: "Hausmeister Gartenpflege", brutto: 595, lohn: 150, lohnArt: 'hdl', steuerKey: "9", netto: 500, steuerBetrag: 95, verteilKey: "einheiten" };
            dbKosten.push(kData);
            console.groupEnd();

            saveLocal(); renderLists(); 
            alert(`Testdaten Protokoll:\nObjekt: ${oData.name} (${oid})\nHaus: ${hData.bezeichnung} (${hid})\nEinheiten: 3 St√ºck angelegt.\nAbrechnung: ${aData.name} mit 1 Kostenposition.`);
        }

        // --- NEW: ABRECHNUNG DUMMY ---
        function createAbrechnungDummy() {
            if(!confirm("Komplexes Abrechnungs-Szenario erzeugen?\n(Sonnenhof, 3 Einheiten, div. Schl√ºssel)")) return;
            
            // 1. Objekt
            const oid = getNextObjektID();
            dbObjekte.set(oid, { nummer: oid, name: "Sonnenhof Muster", plz: "99999", ort: "Musterstadt", flaeche: 300, mea: 1000, sollHaeuser: 1, steuerStatus: "none" });
            
            // 2. Haus
            const hid = getNextHausID(oid);
            const matrix = {'wohnung':{count:3, area:200}};
            dbHaeuser.set(hid, { objektId: oid, bezeichnung: "Haupthaus", anteile: 1000, sollMatrix: matrix });

            // 3. Einheiten (E1: Voll, E2: Wechsel, E3: Leer)
            const y = 2024;
            // E1: 100m¬≤, ganzes Jahr
            let eid = getNextEinheitID(hid);
            dbEinheiten.set(eid, { hausId: hid, objektId: oid, name: "Wohnung 1 (Voll)", typ: "wohnung", flaeche: 100, zimmer: 4, mea: 333, 
                konditionen: [{label:'BK-Vorausz.', betrag: 200, intervall:'Monatlich', gueltigAb: `${y}-01-01`, steuerKey: '20'}],
                belegung: [{mieterId: 'dummy_m1', einzug: `${y}-01-01`, auszug: `${y}-12-31`}]
            });
            // E2: 100m¬≤, nur 2. Halbjahr
            eid = getNextEinheitID(hid);
            dbEinheiten.set(eid, { hausId: hid, objektId: oid, name: "Wohnung 2 (Wechsel)", typ: "wohnung", flaeche: 100, zimmer: 4, mea: 333,
                konditionen: [{label:'BK-Vorausz.', betrag: 200, intervall:'Monatlich', gueltigAb: `${y}-07-01`, steuerKey: '20'}],
                belegung: [{mieterId: 'dummy_m2', einzug: `${y}-07-01`, auszug: `${y}-12-31`}]
            });
            // E3: 100m¬≤, Leerstand
            eid = getNextEinheitID(hid);
            dbEinheiten.set(eid, { hausId: hid, objektId: oid, name: "Wohnung 3 (Leer)", typ: "wohnung", flaeche: 100, zimmer: 4, mea: 334, belegung: [] });

            // 4. Abrechnung & Kosten
            const aid = 'abr_' + Date.now();
            dbAbrechnungen.push({ id: aid, objektId: oid, name: `Abrechnung ${y}`, von: `${y}-01-01`, bis: `${y}-12-31`, status: 'open' });
            
            // Kosten:
            // - Grundsteuer (nach Fl√§che m2)
            dbKosten.push({ id: getNextFinanzId(), abrechnungId: aid, text: "Grundsteuer", brutto: 3000, netto: 3000, verteilKey: "m2" });
            // - M√ºll (nach Einheiten)
            dbKosten.push({ id: getNextFinanzId(), abrechnungId: aid, text: "M√ºllabfuhr", brutto: 900, netto: 900, verteilKey: "einheiten" });
            // - Garten (nach Fl√§che, ¬ß35a)
            dbKosten.push({ id: getNextFinanzId(), abrechnungId: aid, text: "Gartenpflege", brutto: 600, netto: 600, lohn: 300, lohnArt: 'hdl', verteilKey: "m2" });

            // 5. Vorauszahlungen (Finanzen) simulieren
            // E1 hat 12x 200 = 2400 gezahlt
            dbFinanzen.push({ id: getNextFinanzId(), einheitId: Array.from(dbEinheiten.keys())[0], typ: 'haben', kategorie: 'BK-Vorausz.', betrag: 2400, buchungsdatum: `${y}-12-31`, text: "Summe VZ Jahr" });
            // E2 hat 6x 200 = 1200 gezahlt
            dbFinanzen.push({ id: getNextFinanzId(), einheitId: Array.from(dbEinheiten.keys())[1], typ: 'haben', kategorie: 'BK-Vorausz.', betrag: 1200, buchungsdatum: `${y}-12-31`, text: "Summe VZ Jahr" });

            saveLocal(); renderLists(); alert("Szenario 'Sonnenhof' erstellt!\nGehe jetzt auf 'BK-Abrechnung' und w√§hle das Objekt.");
        }

        // --- SIMULATION ENGINE ---
        function simulateAbrechnung() {
            const aid = document.getElementById('currentAbrechnungId').value;
            if(!aid) return;
            const abr = dbAbrechnungen.find(a => a.id === aid);
            const costs = dbKosten.filter(k => k.abrechnungId === aid);
            const units = Array.from(dbEinheiten.values()).filter(u => u.objektId === abr.objektId);
            const start = new Date(abr.von);
            const end = new Date(abr.bis);
            const totalDays = (end - start) / (1000 * 60 * 60 * 24) + 1;

            let resultHTML = `<table class="result-table"><thead><tr><th>Einheit</th><th>Verteiler-Anteile</th><th>Kosten-Anteil</th><th>Vorausz.</th><th>Saldo</th></tr></thead><tbody>`;

            units.forEach(u => {
                let unitCostShare = 0;
                let unitDetails = [];

                costs.forEach(cost => {
                    // 1. Verteiler Summen ermitteln (Gesamt im Objekt)
                    let totalKeyVal = 0;
                    let unitKeyVal = 0;
                    
                    if(cost.verteilKey === 'm2') {
                        units.forEach(un => totalKeyVal += safeFloat(un.flaeche));
                        unitKeyVal = safeFloat(u.flaeche);
                    } else if(cost.verteilKey === 'einheiten') {
                        totalKeyVal = units.length;
                        unitKeyVal = 1;
                    } else if(cost.verteilKey === 'mea') {
                        units.forEach(un => totalKeyVal += safeFloat(un.mea));
                        unitKeyVal = safeFloat(u.mea);
                    }

                    if(totalKeyVal > 0) {
                        // 2. Kostenanteil der Einheit (Vollkosten)
                        const rawShare = (safeFloat(cost.netto) / totalKeyVal) * unitKeyVal;
                        
                        // 3. Zeitfaktor (Leerstand vs. Mieter)
                        // Vereinfacht: Wir pr√ºfen nur, ob √ºberhaupt vermietet im Zeitraum
                        // F√ºr echte Abrechnung muss hier Taggenaue Split-Logik rein
                        // Hier nehmen wir an: Einheit tr√§gt Kosten immer (Eigent√ºmer-Sicht)
                        unitCostShare += rawShare;
                    }
                });

                // 4. Vorauszahlungen suchen
                // Wir suchen in dbFinanzen nach Eintr√§gen f√ºr diese Einheit im Zeitraum
                // Vereinfachung: Wir nehmen ALLE 'haben' Buchungen der Kategorie BK
                const uid = getUnitIdByObj(u); // Helper needed
                let prepay = 0;
                dbFinanzen.filter(f => f.einheitId === uid && f.typ === 'haben' && (f.kategorie.includes('BK') || f.kategorie.includes('Nebenk'))).forEach(f => prepay += safeFloat(f.betrag));

                const saldo = unitCostShare - prepay;
                const color = saldo > 0 ? 'res-bad' : 'res-good'; // Positiv = Nachzahlung (Bad for tenant)

                resultHTML += `<tr>
                    <td>${u.name}</td>
                    <td><small>${u.flaeche}m¬≤</small></td>
                    <td class="res-num">${formatNum(unitCostShare)} ‚Ç¨</td>
                    <td class="res-num">${formatNum(prepay)} ‚Ç¨</td>
                    <td class="res-num ${color}">${formatNum(saldo)} ‚Ç¨</td>
                </tr>`;
            });

            resultHTML += `</tbody></table>`;
            document.getElementById('resultContent').innerHTML = resultHTML;
            document.getElementById('resultModal').classList.add('active');
        }

        // Helper to find ID by object value (reverse lookup in Map is slow, but ok here)
        function getUnitIdByObj(uObj) {
            for (let [key, val] of dbEinheiten.entries()) {
                if (val === uObj) return key;
            }
            return null;
        }

        // --- INIT UI ---
        function openTaxModal(){ document.getElementById('taxModal').classList.add('active'); }
        function renderTaxTable(){ const b=document.getElementById('taxTableBody'); b.innerHTML=""; taxKeys.forEach(t=>b.innerHTML+=`<tr><td>${t.id}</td><td>${t.label}</td><td>${t.rate}%</td><td><button class="warn-btn" onclick="deleteTaxKey('${t.id}')">x</button></td></tr>`); }
        function addTaxKey(){ const i=document.getElementById('newTaxId').value,l=document.getElementById('newTaxLabel').value,r=parseFloat(document.getElementById('newTaxRate').value); if(i&&l&&!isNaN(r)){taxKeys.push({id:i,label:l,rate:r}); saveLocal(); initTaxSelect(); renderTaxTable();} }
        function deleteTaxKey(id){ if(confirm("L√∂schen?")){taxKeys=taxKeys.filter(t=>t.id!==id); saveLocal(); initTaxSelect(); renderTaxTable();} }
        function initTaxSelect(){ const s=['mbSteuer','detailSteuerInp']; s.forEach(i=>{const e=document.getElementById(i); if(e){const old=e.value; e.innerHTML='<option value="">--</option>'; taxKeys.forEach(t=>e.add(new Option(t.label,t.id))); e.value=old;}}); document.querySelectorAll('.k-tax, .v-tax, .kond-tax, .split-tax').forEach(e=>{const old=e.value; e.innerHTML='<option value="">-</option>'; taxKeys.forEach(t=>e.add(new Option(t.label,t.id))); e.value=old;}); }
        function openVerteilModal(){ document.getElementById('verteilModal').classList.add('active'); renderVerteilTable(); }
        function renderVerteilTable(){ const b=document.getElementById('verteilTableBody'); b.innerHTML=""; verteilKeys.forEach(v=>b.innerHTML+=`<tr><td>${v.id}</td><td>${v.label}</td><td><button class="warn-btn" onclick="deleteVerteilKey('${v.id}')">x</button></td></tr>`); }
        function addVerteilKey(){ const i=document.getElementById('newVerteilId').value,l=document.getElementById('newVerteilLabel').value; if(i&&l){verteilKeys.push({id:i,label:l}); saveLocal(); renderVerteilTable();} }
        function deleteVerteilKey(id){ if(confirm("L√∂schen?")){verteilKeys=verteilKeys.filter(v=>v.id!==id); saveLocal(); renderVerteilTable();} }
        function startDrag(e,i){ e.preventDefault(); const m=document.getElementById(i); let x=e.clientX,y=e.clientY,l=m.offsetLeft,t=m.offsetTop; function d(ev){m.style.left=(l+ev.clientX-x)+'px';m.style.top=(t+ev.clientY-y)+'px';} function s(){document.removeEventListener('mousemove',d);document.removeEventListener('mouseup',s);} document.addEventListener('mousemove',d); document.addEventListener('mouseup',s); }

        // --- ACCOUNTING ---
        function openKontoModal(id){ const e=dbEinheiten.get(id); document.getElementById('kontoEinheitId').value=id; document.getElementById('kontoTitle').innerText=`Konto: ${e.name}`; document.getElementById('manuelleBuchungForm').style.display='none'; const t=dbFinanzen.filter(x=>x.einheitId===id), s=document.getElementById('kontoJahrSelect'), y=new Set(); t.forEach(x=>{if(x.buchungsdatum)y.add(x.buchungsdatum.substr(0,4));}); s.innerHTML='<option value="all">Alle Jahre</option>'; Array.from(y).sort().reverse().forEach(v=>s.add(new Option(v,v))); renderKontoTable(); document.getElementById('kontoModal').classList.add('active'); }
        function renderKontoTable(){ const eid=document.getElementById('kontoEinheitId').value, y=document.getElementById('kontoJahrSelect').value, b=document.getElementById('kontoBody'); b.innerHTML=""; let t=dbFinanzen.filter(x=>x.einheitId===eid); if(y!=='all')t=t.filter(x=>x.buchungsdatum.startsWith(y)); t.sort((m,n)=>m.buchungsdatum.localeCompare(n.buchungsdatum)); let ss=0,sh=0,bal=0; t.forEach(x=>{const s=x.typ==='soll'?safeFloat(x.betrag):0, h=x.typ==='haben'?safeFloat(x.betrag):0; ss+=s; sh+=h; bal+=(s-h); b.innerHTML+=`<tr onclick="openBuchungDetail('${x.id}')"><td>${x.history&&x.history.length?'(Korr)':''}</td><td>${formatDate(x.buchungsdatum)}</td><td>${x.text}</td><td>${x.konto||''}</td><td>${x.steuerschluessel||'-'}</td><td class="text-right betrag-soll">${s?formatNum(s):''}</td><td class="text-right betrag-haben">${h?formatNum(h):''}</td><td class="text-right"><b>${formatNum(bal)}</b></td><td>${x.locked?'üîí':'<button class="warn-btn" onclick="event.stopPropagation();deleteBuchung(\''+x.id+'\')">x</button>'}</td></tr>`;}); document.getElementById('sumSoll').innerText=formatCurrency(ss); document.getElementById('sumHaben').innerText=formatCurrency(sh); document.getElementById('sumSaldo').innerText=formatCurrency(bal); }
        function deleteBuchung(id){ if(confirm("L√∂schen?")){dbFinanzen=dbFinanzen.filter(x=>x.id!==id); saveLocal(); triggerAutoSave(); renderKontoTable();} }
        function saveManuelleBuchung(){ const eid=document.getElementById('kontoEinheitId').value, d=document.getElementById('mbDatum').value, b=safeFloat(document.getElementById('mbBetrag').value); if(!d||!b)return; const tid=document.getElementById('mbSteuer').value; let sb=0; if(tid){const k=taxKeys.find(x=>x.id===tid); if(k)sb=b-(b/(1+k.rate/100));} dbFinanzen.push({id:getNextFinanzId(),einheitId:eid,buchungsdatum:d,typ:document.getElementById('mbTyp').value,betrag:b,text:document.getElementById('mbText').value,konto:document.getElementById('mbKonto').value,steuerschluessel:tid,steuerbetrag:sb,kategorie:"Manuell",locked:false}); saveLocal(); triggerAutoSave(); renderKontoTable(); document.getElementById('manuelleBuchungForm').style.display='none'; }
        function resetKonto(){ if(confirm("Alles leeren?")){const eid=document.getElementById('kontoEinheitId').value; dbFinanzen=dbFinanzen.filter(x=>x.einheitId!==eid); saveLocal(); triggerAutoSave(); renderKontoTable();} }
        function openManuelleBuchung(){ document.getElementById('manuelleBuchungForm').style.display='block'; }
        function openSollstellungModal(){ document.getElementById('sollstellungModal').classList.add('active'); document.getElementById('sollMonatInput').value=new Date().toISOString().slice(0,7); document.getElementById('sollBuchungsdatum').value=new Date().toISOString().slice(0,10); }
        function runSollstellung(){ const m=document.getElementById('sollMonatInput').value, bd=document.getElementById('sollBuchungsdatum').value; if(!m||!bd)return; const [yr,mo]=m.split('-').map(Number), dM=new Date(yr,mo,0).getDate(), ms=new Date(yr,mo-1,1), me=new Date(yr,mo-1,dM); let cnt=0; dbEinheiten.forEach((e,eid)=>{if(e.belegung)e.belegung.forEach(b=>{const ei=new Date(b.einzug), au=b.auszug?new Date(b.auszug):new Date('2099-12-31'); if(ei<=me&&au>=ms){ const s=ei>ms?ei:ms, en=au<me?au:me, days=Math.ceil(Math.abs(en-s)/(864e5))+1; if(days>0){ const f=days/dM, op=`${eid}-${mo}${yr}`; if(e.konditionen)e.konditionen.forEach(k=>{ const ga=new Date(k.gueltigAb), gb=k.gueltigBis?new Date(k.gueltigBis):new Date('2099-12-31'); if(ga<=me&&gb>=ms){ const si=ga.getMonth()+1, iv=k.intervall||'Monatlich'; let due=false; if(iv==='Monatlich')due=true; else if(iv==='Viertelj√§hrlich'&&(mo-si)%3===0)due=true; else if(iv==='Halbj√§hrlich'&&(mo-si)%6===0)due=true; else if(iv==='J√§hrlich'&&mo===si)due=true; if(due){ const bet=safeFloat(k.betrag)*f; let stb=0; if(k.steuerKey){const tk=taxKeys.find(t=>t.id===k.steuerKey);if(tk)stb=bet-(bet/(1+tk.rate/100));} if(!dbFinanzen.some(x=>x.text.includes(op)&&x.kategorie===k.label)){ dbFinanzen.push({id:getNextFinanzId(),einheitId:eid,mieterId:b.mieterId,monatRef:m,buchungsdatum:bd,typ:'soll',kategorie:k.label,text:`${op} (${k.label})`,betrag:bet,konto:k.konto,steuerschluessel:k.steuerKey,steuerbetrag:stb,locked:true}); cnt++; } } } }); } } }); }); saveLocal(); triggerAutoSave(); alert(cnt+" Buchungen erstellt."); document.getElementById('sollstellungModal').classList.remove('active'); }
        function openBuchungDetail(id){ const t=dbFinanzen.find(x=>x.id===id); if(!t)return; document.getElementById('detailBuchungId').value=id; document.getElementById('detailId').innerText=id; document.getElementById('detailDatumInp').value=t.buchungsdatum; document.getElementById('detailBetragInp').value=safeFloat(t.betrag); document.getElementById('detailTextInp').value=t.text; document.getElementById('detailKontoInp').value=t.konto||""; document.getElementById('detailSteuerInp').value=t.steuerschluessel||""; document.getElementById('detailDoku').value=t.doku||""; document.getElementById('buchungDetailModal').classList.add('active'); }
        function saveBuchungChanges(){ const id=document.getElementById('detailBuchungId').value, t=dbFinanzen.find(x=>x.id===id); if(!t)return; const nd=document.getElementById('detailDatumInp').value, nb=safeFloat(document.getElementById('detailBetragInp').value), nt=document.getElementById('detailTextInp').value, nk=document.getElementById('detailKontoInp').value, nst=document.getElementById('detailSteuerInp').value; if(nd!==t.buchungsdatum||nb!==safeFloat(t.betrag)||nt!==t.text||nk!==(t.konto||"")||nst!==(t.steuerschluessel||"")){ if(!t.history)t.history=[]; t.history.push({datum:new Date().toISOString(),old:JSON.parse(JSON.stringify(t))}); t.buchungsdatum=nd; t.betrag=nb; t.text=nt; t.konto=nk; t.steuerschluessel=nst; if(nst){const k=taxKeys.find(x=>x.id===nst); if(k)t.steuerbetrag=nb-(nb/(1+k.rate/100));} t.doku=(document.getElementById('detailDoku').value)+`\n[Edit ${new Date().toLocaleDateString()}]`; saveLocal(); triggerAutoSave(); renderKontoTable(); document.getElementById('buchungDetailModal').classList.remove('active'); alert("Gespeichert"); } }

        // PDF Functions
        function exportKontoPDF() { const eid=document.getElementById('kontoEinheitId').value, e=dbEinheiten.get(eid), doc=new jspdf.jsPDF(); doc.text(`Mieterkonto: ${e.name}`,14,15); const r=[]; let bal=0; dbFinanzen.filter(x=>x.einheitId===eid).sort((a,b)=>a.buchungsdatum.localeCompare(b.buchungsdatum)).forEach(x=>{ const s=x.typ==='soll'?safeFloat(x.betrag):0, h=x.typ==='haben'?safeFloat(x.betrag):0; bal+=(s-h); r.push([formatDate(x.buchungsdatum),x.text,s?formatNum(s):'',h?formatNum(h):'',formatNum(bal)]); }); doc.autoTable({head:[['Datum','Text','Soll','Haben','Saldo']],body:r,startY:20}); doc.save(`Konto_${e.name}.pdf`); }
        function generateObjectReportPDF() { const doc=new jspdf.jsPDF('l'), r=[]; dbObjekte.forEach((o,id)=>{const h=Array.from(dbHaeuser.values()).filter(x=>x.objektId===id); let fl=0; h.forEach(x=>{if(x.sollMatrix)Object.values(x.sollMatrix).forEach(v=>fl+=safeFloat(v.area));}); r.push([o.name,`${h.length}/${o.sollHaeuser}`,`${formatNum(safeFloat(o.flaeche))} m¬≤`,`${formatNum(fl)} m¬≤`]);}); doc.autoTable({head:[['Objekt','H√§user','Soll-Fl','Ist-Fl']],body:r}); doc.save('objekte.pdf'); }
        function generateHouseReportPDF() { const doc=new jspdf.jsPDF('l'), r=[]; dbHaeuser.forEach((h,id)=>{const u=Array.from(dbEinheiten.values()).filter(x=>x.hausId===id); let sf=0; if(h.sollMatrix)Object.values(h.sollMatrix).forEach(v=>sf+=safeFloat(v.area)); const ifl=u.reduce((s,e)=>s+safeFloat(e.flaeche),0); r.push([h.bezeichnung,u.length,`${formatNum(sf)} m¬≤`,`${formatNum(ifl)} m¬≤`]);}); doc.autoTable({head:[['Haus','Einheiten','Soll-Fl','Ist-Fl']],body:r}); doc.save('haeuser.pdf'); }
        function generateUnitReportPDF() { const doc=new jspdf.jsPDF('l'), r=[]; dbEinheiten.forEach((e,id)=>{const h=dbHaeuser.get(e.hausId); let st="LEERSTAND"; if(e.belegung&&e.belegung.length){const cur=e.belegung.find(b=>(b.einzug<=new Date().toISOString().split('T')[0])&&(!b.auszug||b.auszug>=new Date().toISOString().split('T')[0])); if(cur){const m=dbKontakte.get(cur.mieterId); st=m?m.fn:"Vermietet";}} r.push([h?h.bezeichnung:'?',e.name,e.typ,`${formatNum(e.flaeche)} m¬≤`,st]);}); doc.autoTable({head:[['Haus','Einheit','Typ','Fl√§che','Status']],body:r}); doc.save('einheiten.pdf'); }
    </script>
</body>
</html>