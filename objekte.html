<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Objektverwaltung Pro + Finanzen</title>
    <!-- PDF Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <!-- MS Auth -->
    <script src="https://alcdn.msauth.net/browser/2.24.0/js/msal-browser.min.js"></script>
    
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; padding: 15px; background-color: #f4f7f6; margin: 0; }
        
        /* Header & Actions */
        .app-header { background: white; padding: 15px; border-bottom: 1px solid #ddd; margin: -15px -15px 20px -15px; display: flex; flex-wrap: wrap; align-items: center; justify-content: space-between; gap: 10px; }
        .app-title { font-size: 1.2em; font-weight: bold; color: #2e7d32; margin: 0; }
        .cloud-actions { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        
        button { padding: 8px 12px; font-size: 0.9em; border-radius: 4px; border: 1px solid #bbb; background: #eee; cursor: pointer; }
        button:hover { background: #ddd; }
        button:disabled { opacity: 0.6; cursor: not-allowed; }

        .primary-btn { background: #2e7d32; color: white; border-color: #1b5e20; }
        .warn-btn { background: #d9534f; color: white; border-color: #d43f3a; }
        .onedrive-btn { background: #0078d4; color: white; border-color: #005a9e; }
        .local-btn { background: #fff3cd; color: #856404; border-color: #ffeeba; }
        .report-btn { background: #607d8b; color: white; border-color: #455a64; }
        .test-btn { background: #ff9800; color: white; border-color: #f57c00; }
        .finance-btn { background: #673ab7; color: white; border-color: #512da8; } 
        .account-btn { background: #e1bee7; color: #4a148c; border-color: #ce93d8; font-weight:bold; }
        
        /* Status Anzeige */
        .onedrive-status { 
            display: none; align-items: center; padding: 6px 12px; font-size: 0.9em; font-weight: 500; 
            border-radius: 4px; transition: all 0.3s ease; margin-left: 10px; 
        }
        .onedrive-status.saving { background-color: #e0f2fe; color: #0c4a6e; border: 1px solid #bae6fd; display: inline-flex; }
        .onedrive-status.success { background-color: #dcfce7; color: #14532d; border: 1px solid #bbf7d0; display: inline-flex; }
        .onedrive-status.error { background-color: #fee2e2; color: #991b1b; border: 1px solid #fecaca; display: inline-flex; }
        .onedrive-status.info { background-color: #fffbeb; color: #92400e; border: 1px solid #fde68a; display: inline-flex; }
        
        #sessionExpiredWarning { 
            margin: 0 0 15px 0; font-weight: bold; padding: 10px; border-radius: 4px; 
            display: none; background-color: #fffbe6; border: 1px solid #ffc107; color: #ff8f00; 
            text-align: center; width: 100%; box-sizing: border-box;
        }

        /* Navigation */
        .tab-bar { margin-bottom: 15px; display: flex; gap: 5px; flex-wrap: wrap; align-items: center; }
        .tab-btn { background: #f9f9f9; padding: 10px 15px; border-bottom: 3px solid transparent; cursor: pointer; border-radius: 4px 4px 0 0; }
        .tab-btn.active { border-bottom: 3px solid #2e7d32; font-weight: bold; background: white; }
        .report-actions { margin-left: auto; display: flex; gap: 5px; }

        /* Filter Banner */
        #filterBanner { display: none; background-color: #e3f2fd; border: 1px solid #90caf9; color: #0d47a1; padding: 10px; margin-bottom: 15px; border-radius: 4px; align-items: center; justify-content: space-between; }
        #filterBanner button { margin: 0; padding: 5px 10px; background: #fff; border: 1px solid #90caf9; color: #0d47a1; }

        .panel { display: none; background: white; padding: 15px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .panel.active { display: block; }
        .liste-item { border: 1px solid #ddd; padding: 10px; margin-bottom: 10px; background: #fff; border-radius: 4px; display: flex; gap: 10px; align-items: flex-start; }
        .liste-content { flex: 1; }
        .item-checkbox { margin-top: 5px; transform: scale(1.2); cursor: pointer; }

        .objekt-stats { font-size: 0.85em; background: #fafafa; padding: 8px; border-radius: 4px; margin-top: 8px; border: 1px solid #eee; }
        .validation-row { display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding: 2px 0; }
        
        .stat-ok { color: #2e7d32; font-weight: bold; }
        .stat-err { color: #d32f2f; font-weight: bold; }
        
        .detail-box { margin-top: 8px; border-top: 1px solid #eee; padding-top: 5px; font-size: 0.85em; color: #444; }
        .detail-row { display: flex; justify-content: space-between; padding: 1px 0; }
        .detail-header { font-weight: bold; margin-bottom: 2px; color: #333; margin-top: 5px; }

        /* SCROLLABLE MATRIX */
        .matrix-wrapper { max-height: 300px; overflow-y: auto; border: 1px solid #ccc; margin-bottom: 10px; background: #fff; }
        .soll-matrix { width: 100%; border-collapse: collapse; font-size: 0.85em; }
        .soll-matrix th { text-align: center; background: #eee; padding: 5px; border: 1px solid #ccc; font-weight: 600; position: sticky; top: 0; z-index: 2; }
        .soll-matrix td { border: 1px solid #ccc; padding: 4px; text-align: center; }
        .soll-matrix input { width: 100%; text-align: center; border: 1px solid transparent; background: #f9fbe7; font-weight: bold; }
        .soll-matrix input:focus { background: #fff; border: 1px solid #2e7d32; outline: none; }
        .readonly-val { color: #555; }
        .diff-val { font-weight: bold; }
        
        .matrix-sum-row { background: #e0f2f1; font-weight: bold; }

        /* Modal */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; justify-content: center; align-items: center; }
        .modal-overlay.active { display: flex; }
        .modal-content { background: white; padding: 25px; border-radius: 8px; width: 95%; max-width: 900px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); max-height: 90vh; overflow-y: auto; }
        .modal-content input, .modal-content select, .modal-content textarea { width: 100%; padding: 8px; margin-top: 5px; margin-bottom: 15px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
        .modal-actions { text-align: right; margin-top: 20px; }
        
        /* DRAGGABLE MODAL */
        .modal-draggable { position: fixed; top: 100px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 500px; background: white; border-radius: 8px; box-shadow: 0 5px 25px rgba(0,0,0,0.4); z-index: 2000; display: none; border: 1px solid #bbb; }
        .modal-draggable.active { display: block; }
        .modal-header-drag { background: #444; color: white; padding: 10px; border-radius: 8px 8px 0 0; cursor: move; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 15px; max-height: 70vh; overflow-y: auto; }

        .sub-list-container { border: 1px solid #eee; padding: 10px; background: #fafafa; border-radius: 4px; margin-bottom: 15px; max-height: 350px; overflow-y: auto; }
        
        .belegung-wrapper { border-bottom: 1px solid #ddd; padding-bottom: 10px; margin-bottom: 10px; background: #fff; padding: 10px; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .belegung-row { display: flex; gap: 8px; align-items: center; }
        .belegung-row select { flex: 3; min-width: 200px; margin: 0; font-weight: bold; } 
        .belegung-row input[type="date"] { flex: 0 0 130px; margin: 0; font-size: 0.9em; } 
        
        .historie-row { display: flex; gap: 5px; align-items: center; margin-bottom: 5px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .historie-row input[type="date"] { width: 130px; margin:0; }
        .historie-row input[type="text"] { flex: 1; margin:0; }

        .badge { padding: 2px 6px; border-radius: 4px; font-size: 0.8em; font-weight: bold; margin-left: 5px; border: 1px solid #ccc; background: #f0f0f0; color: #333; }
        .mieter-status { margin-top: 8px; padding-top: 8px; border-top: 1px solid #eee; font-size: 0.95em; }
        .status-leerstand { color: #c62828; font-weight: bold; background: #ffebee; padding: 2px 6px; border-radius: 3px; display:inline-block; }
        .status-vermietet { color: #2e7d32; font-weight: bold; }
        .status-zukunft { color: #0277bd; font-style: italic; }
        .contract-id { font-family: monospace; background: #eee; padding: 1px 4px; border-radius: 3px; margin-left: 5px; color: #555; }

        .live-status-box { padding: 10px; border-radius: 4px; margin-bottom: 15px; font-size: 0.9em; border: 1px solid transparent; }
        .type-overview-container { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 15px; padding: 10px; background: #f9f9f9; border-radius: 4px; border: 1px solid #eee; }
        .type-badge { padding: 4px 8px; border-radius: 4px; font-size: 0.85em; border: 1px solid #ccc; background: #fff; color: #555; cursor: pointer; }
        .type-badge:hover { background-color: #eee; }
        .type-badge.open { border-color: #2196f3; background: #e3f2fd; color: #0d47a1; font-weight: bold; }
        .type-badge.full { border-color: #4caf50; background: #e8f5e9; color: #1b5e20; }
        .type-badge.over { border-color: #f44336; background: #ffebee; color: #b71c1c; }
        .type-badge.selected { box-shadow: 0 0 0 2px #333; }

        /* Styles f√ºr Finanz-Modul */
        .kondition-row { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr 1fr 0.5fr 30px 30px; gap: 5px; margin-bottom: 5px; align-items: center; border-bottom:1px dashed #eee; padding-bottom:5px;}
        .kondition-row input, .kondition-row select { margin: 0; font-size: 0.9em; }
        
        .konto-tabelle { width: 100%; border-collapse: collapse; font-size: 0.9em; }
        .konto-tabelle th, .konto-tabelle td { border: 1px solid #ddd; padding: 6px; text-align: left; }
        .konto-tabelle th { background: #f5f5f5; }
        .konto-tabelle tr:hover { background-color: #e3f2fd; cursor: pointer; }
        .text-right { text-align: right; }
        .betrag-soll { color: #c62828; }
        .betrag-haben { color: #2e7d32; }

        h4 { margin: 0; padding: 0; }
        .sub-info { color: #666; font-size: 0.9em; margin-top: 4px; }
        
        .filter-btn { background: #fff; color: #333; border: 1px solid #aaa; padding: 4px 8px; font-size: 0.85em; }
        .filter-btn.active { background: #e0f2f1; border-color: #00695c; color: #00695c; font-weight: bold; }
        
        .section-header { margin-top: 15px; margin-bottom: 5px; padding-bottom: 5px; border-bottom: 1px solid #eee; font-weight: bold; color: #333; display: flex; justify-content: space-between; align-items: center; }

        /* Steuerschl√ºssel Tabelle */
        .tax-table { width: 100%; border-collapse: collapse; font-size: 0.9em; }
        .tax-table th, .tax-table td { border: 1px solid #ccc; padding: 4px; text-align: left; }
        .tax-table th { background: #eee; position: sticky; top: 0; }

        /* Badge f√ºr Steuerstatus */
        .tax-badge { display:inline-block; padding: 2px 6px; border-radius: 4px; font-size: 0.8em; font-weight: bold; margin-left: 5px; }
        .tax-opt { background: #e8f5e9; color: #1b5e20; border:1px solid #c8e6c9; } /* Gr√ºn */
        .tax-none { background: #f5f5f5; color: #616161; border:1px solid #e0e0e0; } /* Grau */
        .tax-mixed { background: #fff3e0; color: #e65100; border:1px solid #ffe0b2; } /* Orange */

        /* Login Protection */
        #loginMessage { text-align: center; padding: 50px 20px; background: white; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-top: 20px; display: none; }
        #loginMessage h2 { border-bottom: none; color: #555; }
        #protectedContent { display: block; }

        /* NEU: Styles f√ºr Kosten-Erfassung */
        .kosten-row { display: grid; grid-template-columns: 1fr 2fr 1fr 1fr 1fr 1fr 1fr 1fr 30px; gap: 5px; margin-bottom: 5px; align-items: center; border-bottom: 1px dashed #ddd; padding-bottom: 5px; }
        .kosten-row input, .kosten-row select { font-size: 0.85em; padding: 4px; margin: 0; border:1px solid #ccc; border-radius:3px; }
        .kosten-header { display: grid; grid-template-columns: 1fr 2fr 1fr 1fr 1fr 1fr 1fr 1fr 30px; gap: 5px; font-weight: bold; background: #eee; padding: 8px 5px; border-radius: 4px 4px 0 0; font-size: 0.85em; }
        .kosten-footer { display: flex; justify-content: flex-end; gap: 15px; padding: 10px; background: #e0f2f1; font-weight: bold; border-top: 2px solid #00695c; margin-top: 10px; }
        
        /* NEU: Styles f√ºr Split-Modal */
        .split-row { display: grid; grid-template-columns: 1fr 2fr 1fr 1fr 1fr 1fr 30px; gap: 5px; margin-bottom: 5px; align-items: center; }
        .split-row input, .split-row select { width: 100%; font-size:0.9em; padding: 5px; margin: 0; border:1px solid #ccc; }
        .split-header { display: grid; grid-template-columns: 1fr 2fr 1fr 1fr 1fr 1fr 30px; gap: 5px; margin-bottom: 10px; font-weight:bold; font-size:0.85em; background:#eee; padding:5px; }

        /* NEU: Styles f√ºr Verbrauchsdaten */
        .verbrauch-group { margin-bottom: 20px; border: 1px solid #ddd; padding: 10px; border-radius: 4px; background: #fff; }
        .verbrauch-header { font-weight: bold; color: #2e7d32; border-bottom: 1px solid #eee; padding-bottom: 5px; margin-bottom: 10px; display:flex; justify-content: space-between; align-items: center;}
        .verbrauch-row { display: flex; gap: 5px; margin-bottom: 5px; align-items: center; border-bottom: 1px dashed #eee; padding-bottom: 2px; }
        .verbrauch-row input, .verbrauch-row select { flex: 1; padding: 4px; font-size: 0.9em; }
    </style>
</head>
<body>
    <div id="sessionExpiredWarning">Ihre Sitzung ist abgelaufen. Bitte melden Sie sich erneut an, um Datenverlust zu vermeiden.</div>

    <div class="app-header">
        <div class="app-title">Objektverwaltung Pro <span id="loggedInUser" style="font-size:0.6em; font-weight:normal; color:#555;"></span></div>
        <div class="cloud-actions">
            <!-- FINANCE BUTTON -->
            <button onclick="openTaxModal()" class="finance-btn" title="Steuerschl√ºssel verwalten">üõ†Ô∏è Steuerschl√ºssel</button>
            <button onclick="openSollstellungModal()" class="finance-btn" title="Monatliche Mieten berechnen">üí∞ Sollstellung</button>
            <span style="border-left: 1px solid #ccc; height: 20px; margin: 0 5px;"></span>
            
            <button onclick="createDummyData()" class="test-btn" title="Erstellt Musterobjekt mit Finanz-Historie">üß™ Testdaten</button>
            
            <button id="msLoginBtn" onclick="handleMicrosoftLogin()" class="onedrive-btn">üîë Login</button>
            <button id="msLogoutBtn" onclick="handleLogout()" class="warn-btn" style="display:none;">üîí Logout</button>
            
            <span style="border-left: 1px solid #ccc; height: 20px; margin: 0 5px;"></span>
            
            <button id="cloudSaveBtn" onclick="saveToOneDrive(true)" disabled>üíæ Speichern</button>
            <button onclick="speichereDateiLokal()" class="local-btn">üìÇ Sichern</button>
            <button onclick="ladeDateiLokal()" class="local-btn">üìÇ Laden</button>

            <span id="onedriveStatus" class="onedrive-status"></span>
        </div>
    </div>

    <div style="max-width: 1200px; margin: 0 auto;">
        
        <!-- Login Hinweis -->
        <div id="loginMessage">
            <h2>üîí Zugriff gesch√ºtzt</h2>
            <p>Bitte melden Sie sich an oder laden Sie eine lokale Datei.</p>
        </div>

        <div id="protectedContent">
            <!-- FILTER BANNER -->
            <div id="filterBanner">
                <span id="filterText">Filter aktiv</span>
                <button onclick="toggleFilter(null)">Filter aufheben</button>
            </div>

            <div class="tab-bar">
                <button class="tab-btn active" onclick="switchTab('objekte')">üè† Objekte</button>
                <button class="tab-btn" onclick="switchTab('haeuser')">üèòÔ∏è H√§user</button>
                <button class="tab-btn" onclick="switchTab('einheiten')">üö™ Einheiten</button>
                <button class="tab-btn" onclick="switchTab('kosten')">üìâ BK-Abrechnung</button> <!-- NEU -->
                
                <div class="report-actions">
                    <button onclick="generateObjectReportPDF()" class="report-btn">üìÑ Objekt-Status PDF</button>
                    <button onclick="generateHouseReportPDF()" class="report-btn">üèòÔ∏è Haus-Status PDF</button>
                    <button onclick="generateUnitReportPDF()" class="report-btn">üìã Vermietungsliste PDF</button>
                </div>
                
                <a href="kontakte.html" style="margin-left:10px; text-decoration:none;"><button>üë• Kontakte</button></a>
            </div>

            <!-- PANEL OBJEKTE -->
            <div id="panelObjekte" class="panel active">
                <button class="primary-btn" onclick="openObjektMask()">+ Neues Objekt anlegen</button>
                <div style="margin-top:10px;"><input type="checkbox" onchange="toggleAll('objekteListe', this.checked)"> Alle ausw√§hlen</div>
                <div id="objekteListe" style="margin-top: 15px;"></div>
            </div>

            <!-- PANEL H√ÑUSER -->
            <div id="panelHaeuser" class="panel">
                <button class="primary-btn" onclick="openHausMask()">+ Neues Haus anlegen</button>
                <div style="margin-top:10px;"><input type="checkbox" onchange="toggleAll('haeuserListe', this.checked)"> Alle ausw√§hlen</div>
                <div id="haeuserListe" style="margin-top: 15px;"></div>
            </div>

            <!-- PANEL EINHEITEN -->
            <div id="panelEinheiten" class="panel">
                <button class="primary-btn" onclick="openEinheitMask()">+ Neue Einheit anlegen</button>
                <div style="margin-top:10px;"><input type="checkbox" onchange="toggleAll('einheitenListe', this.checked)"> Alle ausw√§hlen</div>
                <div id="einheitenListe" style="margin-top: 15px;"></div>
            </div>

            <!-- NEU: PANEL KOSTEN (Betriebskosten) -->
            <div id="panelKosten" class="panel">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:10px;">
                    <div style="display:flex; gap:10px; align-items:center;">
                        <label><b>1. Objekt w√§hlen:</b></label>
                        <select id="kostenObjektSelect" onchange="renderAbrechnungsListe()" style="padding:5px; font-weight:bold;"></select>
                    </div>
                    <button class="primary-btn" onclick="openNeueAbrechnung()">+ Neuer Veranlagungszeitraum</button>
                </div>

                <div id="abrechnungWrapper" style="display:none;">
                    <div style="display:flex; gap:10px; margin-bottom:10px;">
                        <div style="flex:1; border:1px solid #ccc; border-radius:4px; padding:10px; max-height:400px; overflow-y:auto; background:#f9f9f9;">
                            <b>2. Zeitraum w√§hlen:</b>
                            <div id="abrechnungenListe" style="margin-top:5px;"></div>
                        </div>
                        <div style="flex:4; border:1px solid #ccc; border-radius:4px; padding:10px; background:white;">
                            <div id="kostenEditor" style="display:none;">
                                <h3 style="margin-top:0; border-bottom:2px solid #2e7d32; padding-bottom:5px; color:#2e7d32;">
                                    Erfassung: <span id="editorTitle"></span>
                                </h3>
                                <input type="hidden" id="currentAbrechnungId">
                                
                                <div class="kosten-header">
                                    <div>Konto</div>
                                    <div>Beschreibung / Text</div>
                                    <div>Brutto ‚Ç¨</div>
                                    <div>VSt.-Schl√ºssel</div>
                                    <div>Netto ‚Ç¨</div>
                                    <div>Vorsteuer ‚Ç¨</div>
                                    <div>Verteilschl√ºssel</div>
                                    <div style="font-size:0.9em; color:#555;">Lohn ‚Ç¨</div>
                                    <div></div>
                                </div>
                                <div id="kostenListe" style="max-height:400px; overflow-y:auto; border:1px solid #ddd; border-top:none;"></div>
                                
                                <div style="margin-top:10px; display:flex; gap:10px;">
                                    <button class="primary-btn" onclick="addKostenRow()">+ Kostenposition</button>
                                    <button class="finance-btn" onclick="openSplitModal()">‚úÇÔ∏è Split-Buchung</button>
                                </div>

                                <div class="kosten-footer">
                                    <div>Summe Netto: <span id="sumKostenNetto">0,00 ‚Ç¨</span></div>
                                    <div>Summe Vorsteuer: <span id="sumKostenSteuer">0,00 ‚Ç¨</span></div>
                                    <div>Summe Brutto: <span id="sumKostenBrutto" style="color:#2e7d32;">0,00 ‚Ç¨</span></div>
                                </div>
                                
                                <div style="text-align:right; margin-top:20px;">
                                    <button class="primary-btn" onclick="saveKostenErfassung()">üíæ Speichern</button>
                                </div>
                            </div>
                            <div id="kostenPlaceholder" style="text-align:center; padding:50px; color:#777;">
                                ‚¨ÖÔ∏è Bitte links einen Zeitraum w√§hlen oder neu anlegen.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ================= MODALS ================= -->

    <!-- Modal: Split Buchung -->
    <div id="splitModal" class="modal-overlay" onclick="if(event.target===this)this.classList.remove('active')">
        <div class="modal-content" style="max-width:900px;">
            <h3>‚úÇÔ∏è Split-Buchung erfassen</h3>
            <div style="background:#e3f2fd; padding:15px; border-radius:4px; margin-bottom:15px;">
                <label style="font-weight:bold; font-size:1.1em;">Gesamtsumme Rechnung (Brutto):</label>
                <input type="number" step="0.01" id="splitTotalInput" style="font-size:1.2em; width:150px; font-weight:bold;" placeholder="0,00" oninput="calcSplitRest()">
                <span style="font-size:1.2em; margin-left:5px;">‚Ç¨</span>
            </div>

            <div class="split-header">
                <div>Betrag ‚Ç¨</div>
                <div>Beschreibung (z.B. Frischwasser)</div>
                <div>Konto</div>
                <div>VSt-Schl√ºssel</div>
                <div>Verteilung</div>
                <div style="font-size:0.9em; color:#555;">Lohn ‚Ç¨</div>
                <div></div>
            </div>
            <div id="splitRowsContainer" style="max-height:300px; overflow-y:auto; border:1px solid #ccc; padding:5px; margin-bottom:10px;">
                <!-- Rows go here -->
            </div>
            
            <button onclick="addSplitRow()" class="finance-btn" style="font-size:0.8em;">+ Zeile hinzuf√ºgen</button>

            <div style="margin-top:15px; padding-top:10px; border-top:2px solid #ccc; display:flex; justify-content:space-between; align-items:center;">
                <div style="font-size:1.1em;">
                    <span>Erfasst: </span><span id="splitSummeErfasst">0,00 ‚Ç¨</span>
                </div>
                <div style="font-size:1.1em; font-weight:bold;">
                    <span>Rest: </span><span id="splitSummeRest" style="color:red;">0,00 ‚Ç¨</span>
                </div>
            </div>

            <div class="modal-actions">
                <button onclick="document.getElementById('splitModal').classList.remove('active')">Abbrechen</button>
                <button class="primary-btn" id="btnApplySplit" onclick="applySplitBuchung()" disabled>√úbernehmen</button>
            </div>
        </div>
    </div>

    <!-- Modal: Neue Abrechnung -->
    <div id="abrechnungModal" class="modal-overlay" onclick="if(event.target===this)this.classList.remove('active')">
        <div class="modal-content" style="max-width:400px;">
            <h3>Neuer Veranlagungszeitraum</h3>
            <label>Bezeichnung (z.B. Jahr 2024):</label>
            <input type="text" id="newAbrName">
            <label>Von:</label>
            <input type="date" id="newAbrVon">
            <label>Bis:</label>
            <input type="date" id="newAbrBis">
            <div class="modal-actions">
                <button onclick="document.getElementById('abrechnungModal').classList.remove('active')">Abbrechen</button>
                <button class="primary-btn" onclick="createAbrechnung()">Anlegen</button>
            </div>
        </div>
    </div>

    <!-- Modal: Steuerschl√ºssel Verwaltung (DRAGGABLE) -->
    <div id="taxModal" class="modal-draggable">
        <div class="modal-header-drag" onmousedown="startDrag(event, 'taxModal')">
            <span>Steuerschl√ºssel Verwaltung (DATEV)</span>
            <button onclick="document.getElementById('taxModal').classList.remove('active')" style="background:transparent; border:none; color:white; font-weight:bold; cursor:pointer;">X</button>
        </div>
        <div class="modal-body">
            <div style="max-height:300px; overflow-y:auto; margin-bottom:15px; border:1px solid #ccc;">
                <table class="tax-table">
                    <thead>
                        <tr>
                            <th style="width:50px;">Nr.</th>
                            <th>Bezeichnung</th>
                            <th style="width:80px;">% Satz</th>
                            <th style="width:40px;"></th>
                        </tr>
                    </thead>
                    <tbody id="taxTableBody"></tbody>
                </table>
            </div>
            <div style="background:#eee; padding:10px; border-radius:4px;">
                <b>Neuen Schl√ºssel anlegen:</b>
                <div style="display:flex; gap:5px; margin-top:5px;">
                    <input type="text" id="newTaxId" placeholder="Nr" style="width:60px; margin:0;">
                    <input type="text" id="newTaxLabel" placeholder="Bezeichnung" style="flex:1; margin:0;">
                    <input type="number" id="newTaxRate" placeholder="%" style="width:60px; margin:0;">
                    <button onclick="addTaxKey()" class="primary-btn" style="margin:0;">+</button>
                </div>
            </div>
        </div>
    </div>

    <!-- NEU: Modal Verteilerschl√ºssel Verwaltung (DRAGGABLE) -->
    <div id="verteilModal" class="modal-draggable">
        <div class="modal-header-drag" onmousedown="startDrag(event, 'verteilModal')">
            <span>Verteilerschl√ºssel Verwaltung</span>
            <button onclick="document.getElementById('verteilModal').classList.remove('active')" style="background:transparent; border:none; color:white; font-weight:bold; cursor:pointer;">X</button>
        </div>
        <div class="modal-body">
            <div style="max-height:300px; overflow-y:auto; margin-bottom:15px; border:1px solid #ccc;">
                <table class="tax-table">
                    <thead>
                        <tr>
                            <th style="width:80px;">ID</th>
                            <th>Bezeichnung</th>
                            <th style="width:40px;"></th>
                        </tr>
                    </thead>
                    <tbody id="verteilTableBody"></tbody>
                </table>
            </div>
            <div style="background:#eee; padding:10px; border-radius:4px;">
                <b>Neuen Schl√ºssel anlegen:</b>
                <div style="display:flex; gap:5px; margin-top:5px;">
                    <input type="text" id="newVerteilId" placeholder="ID (z.B. m3)" style="width:80px; margin:0;">
                    <input type="text" id="newVerteilLabel" placeholder="Bezeichnung" style="flex:1; margin:0;">
                    <button onclick="addVerteilKey()" class="primary-btn" style="margin:0;">+</button>
                </div>
            </div>
        </div>
    </div>

    <!-- NEU: Modal Verbrauchsdaten & Z√§hler (DRAGGABLE) -->
    <div id="verbrauchsdatenModal" class="modal-draggable" style="max-width:800px; width:95%;">
        <div class="modal-header-drag" onmousedown="startDrag(event, 'verbrauchsdatenModal')">
            <span>üìä Z√§hler & Verbrauchsdaten</span>
            <button onclick="document.getElementById('verbrauchsdatenModal').classList.remove('active')" style="background:transparent; border:none; color:white; font-weight:bold; cursor:pointer;">X</button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="verbrauchsdatenEinheitId">
            <h4 id="verbrauchsdatenTitle" style="color:#0078d4; margin-top:0;"></h4>

            <!-- PERSONEN -->
            <div class="verbrauch-group">
                <div class="verbrauch-header">
                    <span>üë• Personen-Historie</span>
                    <button class="primary-btn" style="font-size:0.7em; padding:2px 5px;" onclick="addPersonenRow()">+</button>
                </div>
                <div id="personenListe" style="max-height:150px; overflow-y:auto;"></div>
            </div>

            <!-- Z√ÑHLER (Wasser, Strom) -->
            <div class="verbrauch-group">
                <div class="verbrauch-header">
                    <span>üíß‚ö° Z√§hlerst√§nde (Wasser, Strom etc.)</span>
                    <button class="primary-btn" style="font-size:0.7em; padding:2px 5px;" onclick="addZaehlerRow()">+</button>
                </div>
                <div style="display:grid; grid-template-columns: 1.5fr 1fr 1.2fr 1.2fr 1fr 1fr 30px; gap:5px; font-size:0.8em; font-weight:bold; margin-bottom:5px;">
                    <div>Typ</div>
                    <div>Z√§hler-Nr.</div>
                    <div>Von</div>
                    <div>Bis</div>
                    <div>Start</div>
                    <div>Ende</div>
                    <div></div>
                </div>
                <div id="zaehlerListe" style="max-height:200px; overflow-y:auto;"></div>
            </div>

            <!-- DIREKTKOSTEN -->
            <div class="verbrauch-group">
                <div class="verbrauch-header">
                    <span>üî• Direkte Kosten (Fremdfirma: Heizung/Warmwasser)</span>
                    <button class="primary-btn" style="font-size:0.7em; padding:2px 5px;" onclick="addDirektRow()">+</button>
                </div>
                <div style="display:grid; grid-template-columns: 1.5fr 1.2fr 1.2fr 1fr 1fr 30px; gap:5px; font-size:0.8em; font-weight:bold; margin-bottom:5px;">
                    <div>Art</div>
                    <div>Von</div>
                    <div>Bis</div>
                    <div>Betrag ‚Ç¨</div>
                    <div>Lohn ‚Ç¨</div>
                    <div></div>
                </div>
                <div id="direktListe" style="max-height:150px; overflow-y:auto;"></div>
            </div>

            <div style="text-align:right;">
                <button class="primary-btn" onclick="saveVerbrauchsdaten()">Speichern</button>
            </div>
        </div>
    </div>

    <!-- Modal 1: Objekt -->
    <div id="objektModal" class="modal-overlay" onclick="if(event.target===this)this.classList.remove('active')">
        <div class="modal-content">
            <h3>Objekt bearbeiten</h3>
            <input type="hidden" id="objektIdInput">
            <div id="objektLiveStatus" class="live-status-box" style="display:none;"></div>

            <div style="display:flex; gap:10px;">
                <div style="flex:1"><label>Objekt-Nr. (z.B. 0001)*:</label><input type="text" id="objektNummerInput" placeholder="0001" readonly style="background:#eee; font-family:monospace;"></div>
                <div style="flex:2"><label>Bezeichnung / Adresse*:</label><input type="text" id="objektNameInput"></div>
            </div>
            <div style="display:flex; gap:10px;">
                <div style="flex:1"><label>PLZ:</label><input type="text" id="objektPlzInput"></div>
                <div style="flex:2;"><label>Ort:</label><input type="text" id="objektOrtInput"></div>
            </div>
            <h4 style="margin-top:10px;border-bottom:1px solid #eee;">Gesamt-Vorgaben (Soll)</h4>
            <div style="display:flex; gap:10px;">
                <div style="flex:1;"><label>Anzahl H√§user:</label><input type="number" id="objektSollHaeuser" placeholder="1" oninput="updateObjektLiveStatus()"></div>
                <div style="flex:1;"><label>Gesamtfl√§che (m¬≤):</label><input type="number" step="0.01" id="objektFlaecheInput" oninput="updateObjektLiveStatus()"></div>
                <div style="flex:1;"><label>Gesamt MEA:</label><input type="number" step="0.001" id="objektMeaInput" value="1000" oninput="updateObjektLiveStatus()"></div>
            </div>
            <!-- NEU: Steuerstatus -->
            <div style="margin-top:10px;">
                <label>Steuer-Status:</label>
                <select id="objektSteuerStatus">
                    <option value="opt">Mit USt/Vorsteuer (Optiert)</option>
                    <option value="none">Ohne USt (Wohnen/Steuerfrei)</option>
                    <option value="mixed">Gemischt (Einstellung je Haus)</option>
                </select>
            </div>

            <div class="modal-actions">
                <button onclick="document.getElementById('objektModal').classList.remove('active')">Abbrechen</button>
                <button class="primary-btn" onclick="saveObjekt()">Speichern</button>
                <button class="warn-btn" onclick="deleteObjekt()" style="float:left;">L√∂schen</button>
            </div>
        </div>
    </div>

    <!-- Modal 2: Haus -->
    <div id="hausModal" class="modal-overlay" onclick="if(event.target===this)this.classList.remove('active')">
        <div class="modal-content">
            <h3>Haus bearbeiten</h3>
            <input type="hidden" id="hausIdInput">
            
            <div style="display:flex; gap:10px;">
                <div style="flex:1;"><label>Geh√∂rt zu Objekt*:</label><select id="hausObjektSelect" onchange="updateHausIdPreview()"></select></div>
                <div style="flex:1;"><label>Haus-ID (auto):</label><input type="text" id="hausNummerDisplay" readonly style="background:#eee; font-family:monospace;"></div>
                <div style="flex:2;"><label>Bezeichnung*:</label><input type="text" id="hausBezeichnungInput"></div>
            </div>

            <!-- NEU: Steuerstatus nur bei gemischten Objekten -->
            <div id="hausSteuerBox" style="display:none; margin-top:10px; background:#e3f2fd; padding:5px; border-radius:4px;">
                <label>Steuer-Status (Haus):</label>
                <select id="hausSteuerStatus">
                    <option value="opt">Mit USt/Vorsteuer</option>
                    <option value="none">Ohne USt</option>
                    <option value="mixed">Gemischt (Einstellung je Einheit)</option>
                </select>
            </div>

            <h4 style="margin-top:15px; margin-bottom:5px;">Validierungs-Matrix</h4>
            <div class="matrix-wrapper">
                <table class="soll-matrix">
                    <thead>
                        <tr>
                            <th style="width:25%;">Typ / Bez.</th>
                            <th style="width:10%;">Soll Anz.</th>
                            <th style="width:10%; background:#f5f5f5;">Ist</th>
                            <th style="width:10%; background:#f5f5f5;">Diff</th>
                            <th style="width:15%;">Soll Fl√§che</th>
                            <th style="width:15%; background:#f5f5f5;">Ist</th>
                            <th style="width:15%; background:#f5f5f5;">Diff</th>
                            <th style="width:5%;"></th>
                        </tr>
                    </thead>
                    <tbody id="hausSollMatrixBody"></tbody>
                    <tfoot>
                        <tr class="matrix-sum-row">
                            <td>Summe:</td>
                            <td id="matrixSumCount">0</td>
                            <td id="matrixIstCount" class="readonly-val">-</td>
                            <td></td>
                            <td id="matrixSumArea">0.00</td>
                            <td id="matrixIstArea" class="readonly-val">-</td>
                            <td></td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            <button type="button" onclick="addCustomTypeRow()" style="font-size:0.8em; margin-bottom: 10px;">+ Weiteren Typ hinzuf√ºgen</button>
            
            <div style="display:flex; gap:10px; margin-top:10px;">
                <div style="flex:1;"><label>Gesamt MEA (Soll):</label><input type="number" step="0.001" id="hausAnteileInput" oninput="calcMatrixSum()"></div>
                <div style="flex:1; padding-top:25px;"><span id="hausMeaStatus" style="font-weight:bold;"></span></div>
            </div>
            <div class="modal-actions">
                <button onclick="document.getElementById('hausModal').classList.remove('active')">Abbrechen</button>
                <button class="primary-btn" onclick="saveHaus()">Speichern</button>
                <button class="warn-btn" onclick="deleteHaus()" style="float:left;">L√∂schen</button>
            </div>
        </div>
    </div>

    <!-- Modal 3: Einheit -->
    <div id="einheitModal" class="modal-overlay" onclick="if(event.target===this)this.classList.remove('active')">
        <div class="modal-content">
            <h3>Einheit bearbeiten</h3>
            <input type="hidden" id="einheitIdInput">
            
            <div style="display:flex; gap:10px;">
                <div style="flex:1;">
                    <label>Objekt w√§hlen*:</label>
                    <select id="einheitObjektSelect" onchange="filterHaeuserDropdown(true)"></select>
                </div>
                <div style="flex:1;">
                    <label>Haus w√§hlen*:</label>
                    <select id="einheitHausSelect" onchange="onHausSelectionChange()"></select>
                </div>
                <div style="flex:1;">
                    <label>Einheit-ID (auto):</label>
                    <input type="text" id="einheitNummerDisplay" readonly style="background:#eee; font-family:monospace;">
                </div>
            </div>

            <!-- STATUS √úBERSICHT -->
            <label style="margin-top:10px; display:block; font-size:0.9em; font-weight:bold;">Verf√ºgbarkeit im Haus:</label>
            <div id="hausTypeOverview" class="type-overview-container">
                <span style="color:#666; font-style:italic;">Bitte erst ein Haus ausw√§hlen...</span>
            </div>

            <div id="einheitLiveStatus" class="live-status-box" style="display:none;"></div>

            <div style="display:flex; gap:10px;">
                <div style="flex:2;"><label>Lage / Bezeichnung*:</label><input type="text" id="einheitNameInput"></div>
                <div style="flex:1;"><label>Typ:</label><select id="einheitTypSelect" onchange="updateUnitLiveStatus()"></select></div>
            </div>
            <div style="display:flex; gap:10px;">
                <div style="flex:1;"><label>Wohn-/Nutzfl√§che (m¬≤):</label><input type="number" step="0.01" id="einheitFlaecheInput" oninput="updateUnitLiveStatus()"></div>
                <div style="flex:1;"><label>Heizfl√§che (m¬≤):</label><input type="number" step="0.01" id="einheitHeizflaecheInput"></div>
            </div>
            <div style="display:flex; gap:10px;">
                <div style="flex:1;"><label>Zimmer:</label><input type="number" step="0.5" id="einheitZimmerInput"></div>
                <div style="flex:1;"><label>MEA Anteil:</label><input type="number" step="0.001" id="einheitMeaInput"></div>
            </div>

            <!-- Z√ÑHLER & VERBRAUCH (NEU) -->
            <div class="section-header">Z√§hlerst√§nde / Verbrauchsparameter (m¬≥)</div>
            <div style="display:flex; gap:10px;">
                <div style="flex:1;"><label>Warmwasser m¬≥ (Info):</label><input type="number" step="0.001" id="einheitWwInput" placeholder="z.B. Z√§hlerstand"></div>
                <div style="flex:1;"><label>Kaltwasser m¬≥ (Info):</label><input type="number" step="0.001" id="einheitKwInput" placeholder="z.B. Z√§hlerstand"></div>
            </div>
            
            <!-- MIET-KONDITIONEN (NEU: Scrollbar & Bis-Datum) -->
            <div class="section-header">
                <span>Miet-Konditionen & Vorauszahlungen</span>
                <button type="button" onclick="addKonditionRow()" style="font-size:0.8em; padding:2px 8px;">+ Position</button>
            </div>
            <div style="background:#f9f9f9; padding:5px; border-radius:4px; border:1px solid #eee; margin-bottom:10px; max-height:250px; overflow-y:auto;">
                <div id="konditionHeader" style="display:grid; grid-template-columns: 2fr 1fr 1fr 1fr 1fr 0.5fr 30px 30px; gap:5px; font-size:0.8em; font-weight:bold; margin-bottom:5px; padding-right:10px;">
                    <div>Bezeichnung</div>
                    <div>Betrag (‚Ç¨)</div>
                    <div>Konto (Erl√∂s)</div>
                    <div>G√ºltig Ab</div>
                    <div>G√ºltig Bis</div>
                    <div>St-S</div> <!-- Steuerschl√ºssel -->
                    <div></div>
                    <div></div>
                </div>
                <div id="konditionenListe"></div>
            </div>
            
            <div class="section-header">Belegung / Mieterhistorie</div>
            <div id="belegungListe" class="sub-list-container"></div>
            <button type="button" onclick="addBelegungRow()" style="margin-top:5px; font-size:0.85em;">+ Mieterwechsel hinzuf√ºgen</button>

            <div class="section-header">Bauliche Historie & √Ñnderungen</div>
            <div id="historieListe" class="sub-list-container"></div>
            <button type="button" onclick="addHistorieRow()" style="margin-top:5px; font-size:0.85em;">+ √Ñnderung dokumentieren</button>

            <div class="modal-actions">
                <button onclick="document.getElementById('einheitModal').classList.remove('active')">Abbrechen</button>
                <button class="primary-btn" onclick="saveEinheit()">Speichern</button>
                <button class="warn-btn" onclick="deleteEinheit()" style="float:left;">L√∂schen</button>
            </div>
        </div>
    </div>

    <!-- Modal 4: Sollstellung Generator (NEU) -->
    <div id="sollstellungModal" class="modal-overlay" onclick="if(event.target===this)this.classList.remove('active')">
        <div class="modal-content" style="max-width:500px;">
            <h3>üí∞ Sollstellung generieren</h3>
            <p style="font-size:0.9em; color:#555;">Hiermit werden die monatlichen Forderungen f√ºr alle aktiven Mietverh√§ltnisse berechnet. Es werden nur Positionen gebucht, die im gew√§hlten Monat g√ºltig sind.</p>
            
            <label>Abrechnungs-Monat:</label>
            <input type="month" id="sollMonatInput">
            
            <div id="sollLog" style="background:#333; color:#0f0; font-family:monospace; padding:10px; height:150px; overflow-y:auto; margin-top:10px; font-size:0.8em; display:none;"></div>

            <div class="modal-actions">
                <button onclick="document.getElementById('sollstellungModal').classList.remove('active')">Schlie√üen</button>
                <button class="finance-btn" onclick="runSollstellung()">Lauf starten</button>
            </div>
        </div>
    </div>

    <!-- Modal 5: Mieterkonto (NEU: Erweiterte Felder) -->
    <div id="kontoModal" class="modal-overlay" onclick="if(event.target===this)this.classList.remove('active')">
        <div class="modal-content" style="max-width:1000px;">
            <h3>üí∂ Mieterkonto</h3>
            <input type="hidden" id="kontoEinheitId">
            <h4 id="kontoTitle" style="color:#0078d4;"></h4>
            
            <div style="display:flex; justify-content:space-between; margin:10px 0;">
                <div>
                    <select id="kontoJahrSelect" onchange="renderKontoTable()" style="width:auto; display:inline-block; margin:0;">
                        <option value="all">Alle Jahre</option>
                    </select>
                </div>
                <div>
                    <button class="warn-btn" onclick="resetKonto()" title="L√∂scht ALLE Buchungen dieser Einheit (f√ºr Testdaten/Neustart)">üßπ Konto bereinigen</button>
                    <button class="primary-btn" onclick="openManuelleBuchung()">+ Manuelle Buchung</button>
                    <button onclick="exportKontoPDF()">üñ®Ô∏è Auszug PDF</button>
                </div>
            </div>

            <div class="sub-list-container" style="max-height:500px;">
                <table class="konto-tabelle">
                    <thead>
                        <tr>
                            <th>Korr.</th>
                            <th>Datum</th>
                            <th>Vorgang / Text</th>
                            <th>Sachk.</th> <!-- NEUE SPALTE -->
                            <th>St.-S.</th>
                            <th class="text-right">Soll (Forderung)</th>
                            <th class="text-right">Haben (Zahlung)</th>
                            <th class="text-right">Saldo</th>
                            <th style="width:50px;"></th>
                        </tr>
                    </thead>
                    <tbody id="kontoBody"></tbody>
                    <tfoot>
                        <tr style="font-weight:bold; background:#eee;">
                            <td colspan="5">Endstand:</td>
                            <td id="sumSoll" class="text-right">0,00 ‚Ç¨</td>
                            <td id="sumHaben" class="text-right">0,00 ‚Ç¨</td>
                            <td id="sumSaldo" class="text-right">0,00 ‚Ç¨</td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>

            <!-- Manuelle Buchung Form (Erweitert f√ºr DATEV/Export) -->
            <div id="manuelleBuchungForm" style="display:none; background:#e3f2fd; padding:10px; border:1px solid #90caf9; margin-top:10px;">
                <b>Neue Buchung erfassen:</b>
                <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:5px; margin-top:5px;">
                    <div><label style="font-size:0.8em">Datum:</label><input type="date" id="mbDatum"></div>
                    <div><label style="font-size:0.8em">Typ:</label><select id="mbTyp"><option value="haben">Haben (Zahlung/Gutschrift)</option><option value="soll">Soll (Forderung/Nachb.)</option></select></div>
                    <div><label style="font-size:0.8em">Betrag ‚Ç¨:</label><input type="number" step="0.01" id="mbBetrag" placeholder="0,00"></div>
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px; margin-top:5px;">
                    <div><label style="font-size:0.8em">Buchungstext:</label><input type="text" id="mbText" placeholder="z.B. Mieteingang"></div>
                    <div><label style="font-size:0.8em">Belegfeld 1 (Optional):</label><input type="text" id="mbBeleg" placeholder="Belegnummer"></div>
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:5px; margin-top:5px;">
                    <div><label style="font-size:0.8em">Gegenkonto (Erl√∂s/Bank):</label><input type="text" id="mbKonto" placeholder="z.B. 1200 oder 8000"></div>
                    <!-- NEU: Steuerschl√ºssel -->
                    <div>
                        <label style="font-size:0.8em">Steuerschl√ºssel:</label>
                        <select id="mbSteuer" title="Steuerschl√ºssel nach DATEV"></select>
                    </div>
                    <div style="display:flex; align-items:flex-end; gap:5px;">
                        <button class="primary-btn" style="flex:1;" onclick="saveManuelleBuchung()">Buchen</button>
                        <button style="flex:1;" onclick="document.getElementById('manuelleBuchungForm').style.display='none'">Abbrechen</button>
                    </div>
                </div>
            </div>

            <div class="modal-actions">
                <button onclick="document.getElementById('kontoModal').classList.remove('active')">Schlie√üen</button>
            </div>
        </div>
    </div>

    <!-- NEU: Modal 6: Buchungs-Detail / Dokumentation & Bearbeiten -->
    <div id="buchungDetailModal" class="modal-overlay" onclick="if(event.target===this)this.classList.remove('active')">
        <div class="modal-content" style="max-width:600px;">
            <h3>Buchungs-Detail & Bearbeitung</h3>
            <input type="hidden" id="detailBuchungId">
            <input type="hidden" id="detailKorrCount">
            
            <div style="background:#f9f9f9; padding:10px; border-radius:4px; margin-bottom:15px; font-size:0.9em;">
                <div class="detail-row"><span>ID:</span><span id="detailId"></span></div>
                <div class="detail-row"><span>Korrektur-Nr:</span><span id="detailKorrNr" style="font-weight:bold; color:#d32f2f;"></span></div>
                
                <div style="margin-top:10px; border-top:1px solid #ddd; padding-top:10px;">
                    <label style="font-size:0.8em">Datum:</label><input type="date" id="detailDatumInp">
                    <label style="font-size:0.8em">Betrag ‚Ç¨:</label><input type="number" step="0.01" id="detailBetragInp">
                    <label style="font-size:0.8em">Buchungstext:</label><input type="text" id="detailTextInp">
                    <!-- NEU: Sachkonto Editierbar -->
                    <label style="font-size:0.8em">Sachkonto (Erl√∂s):</label><input type="text" id="detailKontoInp">
                    <label style="font-size:0.8em">Steuerschl√ºssel:</label><select id="detailSteuerInp"></select>
                </div>
            </div>
            
            <label>Dokumentation / Notiz (Bleibt erhalten):</label>
            <textarea id="detailDoku" rows="4" placeholder="Hier wird jede √Ñnderung dokumentiert..."></textarea>
            
            <div class="modal-actions">
                <button class="primary-btn" onclick="saveBuchungChanges()">√Ñnderungen Speichern</button>
                <button onclick="document.getElementById('buchungDetailModal').classList.remove('active')">Schlie√üen</button>
            </div>
        </div>
    </div>

    <script>
        // --- DEFINITIONEN ---
        const STANDARD_TYPES = [
            { id: 'wohnung', label: 'Wohnung' }, { id: 'gewerbe', label: 'Gewerbe' }, { id: 'halle', label: 'Gewerbe-Halle' },
            { id: 'geschaeft', label: 'Gesch√§ft' }, { id: 'garage', label: 'Garage' }, { id: 'parkplatz', label: 'Parkplatz' },
            { id: 'keller', label: 'Keller' }, { id: 'garten', label: 'Garten' }, { id: 'sonstige', label: 'Sonstige' }
        ];

        // Standard Miet-Konditionen Typen
        const KONDITION_TYPES = [
            "Kaltmiete", "BK-Vorausz.", "HK-Vorausz.", "Stellplatz", "Garage", "K√ºchenzuschlag", "Mietminderung", "Sonstiges"
        ];

        // ERWEITERTE VERTEILERSCHL√úSSEL
        let verteilKeys = [
            { id: 'm2', label: 'Fl√§che (m¬≤)' },
            { id: 'mea', label: 'MEA (Anteile)' },
            { id: 'einheiten', label: 'Einheiten (St√ºck)' },
            { id: 'personen', label: 'Personen' },
            { id: 'direkt', label: 'Direkt (lt. Rg.)' },
            // Recherche Ergebnisse:
            { id: 'm3', label: 'Umbauter Raum (m¬≥)' },
            { id: 'person_days', label: 'Personentage' },
            { id: 'consumption', label: 'Verbrauch (Z√§hler)' },
            { id: 'nutzeinheit', label: 'Nutzeinheiten' }
        ];

        // Initiale Tax Keys, jetzt erweiterbar (INKLUSIVE VORSTEUER)
        let taxKeys = [
            { id: '2', label: '2 - Umsatzsteuer erm√§√üigt (7%)', rate: 7 },
            { id: '3', label: '3 - Umsatzsteuer allgemein (19%)', rate: 19 },
            { id: '20', label: '20 - Umsatzsteuer 0% (0,00)', rate: 0 },
            // VORSTEUER SCHL√úSSEL
            { id: '8', label: '8 - Vorsteuer 7%', rate: 7 },
            { id: '9', label: '9 - Vorsteuer 19%', rate: 19 },
            { id: '30', label: '30 - Vorsteuer 0%', rate: 0 }
        ];

        // Z√§hler Typen
        const ZAEHLER_TYPES = [
            { id: 'wasser_kalt', label: 'Kaltwasser (m¬≥)' },
            { id: 'wasser_warm', label: 'Warmwasser (m¬≥)' },
            { id: 'strom', label: 'Strom (kWh)' },
            { id: 'gas', label: 'Gas (m¬≥/kWh)' },
            { id: 'heizung', label: 'W√§rmemengenz√§hler (kWh)' }
        ];

        const DIREKT_TYPES = [
            { id: 'heizung_extern', label: 'Heizkosten (Extern)' },
            { id: 'wasser_extern', label: 'Wasserkosten (Extern)' },
            { id: 'sonstiges', label: 'Sonstige Direktkosten' }
        ];

        // Helper Map f√ºr Steuerstatus Anzeige
        const TAX_STATUS_MAP = {
            'opt': { label: 'USt/VSt', class: 'tax-opt' },
            'none': { label: 'USt-Frei', class: 'tax-none' },
            'mixed': { label: 'Gemischt', class: 'tax-mixed' }
        };

        // Auth Config
        const msalConfig = { 
            auth: { 
                clientId: "c3cd3be4-3540-46dd-a24c-82eb6ed5542d", 
                authority: "https://login.microsoftonline.com/common", 
                redirectUri: window.location.origin + window.location.pathname
            } 
        };
        let msalInstance = null;
        let accessToken = null;
        let tokenRefreshIntervalId = null; 
        let userEmail = null;
        
        let dbObjekte = new Map(), dbHaeuser = new Map(), dbEinheiten = new Map(), dbKontakte = new Map(); 
        let dbFinanzen = []; 
        // NEU: Betriebskosten Datenbanken
        let dbAbrechnungen = []; // { id, objektId, name, von, bis, status }
        let dbKosten = []; // { id, abrechnungId, konto, text, brutto, steuerKey, netto, steuerBetrag, verteilKey }
        
        let activeFilterId = null; 
        let autoSaveTimer = null;

        // FUNKTION VOR DOMContentLoaded DEFINIEREN UM FEHLER ZU VERMEIDEN
        function updateKonditionDatalist() { 
            const allTypes = new Set(KONDITION_TYPES); 
            dbEinheiten.forEach(e => { 
                if(e.konditionen) { 
                    e.konditionen.forEach(k => { 
                        if(k.label) allTypes.add(k.label); 
                    }); 
                } 
            }); 
            let dl = document.getElementById('konditionTypes'); 
            if(!dl) { 
                dl = document.createElement('datalist'); 
                dl.id = "konditionTypes"; 
                document.body.appendChild(dl); 
            } 
            dl.innerHTML = ""; 
            Array.from(allTypes).sort().forEach(t => { 
                const op = document.createElement('option'); 
                op.value = t; 
                dl.appendChild(op); 
            }); 
        }

        // FEHLENDE FUNKTION: filterHaeuserDropdown
        function filterHaeuserDropdown(keepSelection=false){ 
            const oid=document.getElementById('einheitObjektSelect').value; 
            const h=document.getElementById('einheitHausSelect'); 
            const oldVal = h.value; 
            h.innerHTML=""; 
            if(!oid)return; 
            Array.from(dbHaeuser.entries())
                .filter(([hid,x])=>x.objektId===oid)
                .forEach(([hid,x])=>h.add(new Option(x.bezeichnung,hid))); 
            if(keepSelection && oldVal) { 
                if(Array.from(h.options).some(o=>o.value===oldVal)) h.value = oldVal; 
            } 
        }

        document.addEventListener('DOMContentLoaded', async () => {
            loadLocal(); 
            initTaxSelect(); // Dropdowns f√ºllen
            renderTaxTable(); // Verwaltungs-Tabelle
            renderVerteilTable(); // Verteilschl√ºssel Tabelle
            try { renderLists(); } catch (err) { console.error("Fehler beim Initial-Rendering:", err); }
            
            try {
                msalInstance = new msal.PublicClientApplication(msalConfig);
                await msalInstance.initialize();
                await versucheSitzungWiederherzustellen();
            } catch(e) { console.error("MSAL Fehler:", e); }
        });

        // --- STEUER VERWALTUNG ---
        function openTaxModal() { 
            const m = document.getElementById('taxModal');
            m.classList.add('active'); 
            renderTaxTable(); 
            // Reset position if off screen
            m.style.top = "100px";
            m.style.left = "50%";
        }
        function renderTaxTable() {
            const tbody = document.getElementById('taxTableBody'); tbody.innerHTML = "";
            taxKeys.forEach(t => {
                tbody.innerHTML += `<tr><td>${t.id}</td><td>${t.label}</td><td>${t.rate}%</td><td><button class="warn-btn" style="padding:2px 5px;" onclick="deleteTaxKey('${t.id}')">x</button></td></tr>`;
            });
        }
        function addTaxKey() {
            const id = document.getElementById('newTaxId').value;
            const label = document.getElementById('newTaxLabel').value;
            const rate = parseFloat(document.getElementById('newTaxRate').value);
            if(!id || !label || isNaN(rate)) return alert("Bitte alle Felder f√ºllen");
            if(taxKeys.find(t=>t.id===id)) return alert("ID existiert bereits");
            taxKeys.push({id, label, rate});
            saveLocal(); 
            refreshAllTaxSelects(); 
            renderTaxTable();
            document.getElementById('newTaxId').value=""; document.getElementById('newTaxLabel').value=""; document.getElementById('newTaxRate').value="";
        }
        function deleteTaxKey(id) {
            if(!confirm("L√∂schen?")) return;
            taxKeys = taxKeys.filter(t => t.id !== id);
            saveLocal(); 
            refreshAllTaxSelects(); 
            renderTaxTable();
        }
        function initTaxSelect() {
            const selects = ['mbSteuer', 'detailSteuerInp'];
            selects.forEach(sid => {
                const sel = document.getElementById(sid);
                if(sel) {
                    const oldVal = sel.value;
                    sel.innerHTML = '<option value="">--</option>';
                    taxKeys.forEach(t => sel.add(new Option(t.label, t.id)));
                    sel.value = oldVal;
                }
            });
        }
        function refreshAllTaxSelects() {
            initTaxSelect(); // Statische
            // Dynamische in Konditionen-Liste
            document.querySelectorAll('.kond-tax').forEach(sel => {
                const oldVal = sel.value;
                sel.innerHTML = '<option value="">-</option>';
                taxKeys.forEach(t => sel.add(new Option(t.label, t.id)));
                sel.value = oldVal;
            });
            // Dynamische in Kosten-Liste
            document.querySelectorAll('.kosten-tax').forEach(sel => {
                const oldVal = sel.value;
                sel.innerHTML = '<option value="">-</option>';
                taxKeys.forEach(t => sel.add(new Option(t.label, t.id)));
                sel.value = oldVal;
            });
            // Dynamische in Split-Liste
            document.querySelectorAll('.split-tax').forEach(sel => {
                const oldVal = sel.value;
                sel.innerHTML = '<option value="">-</option>';
                taxKeys.forEach(t => sel.add(new Option(t.label, t.id)));
                sel.value = oldVal;
            });
        }

        // --- VERTEILSCHL√úSSEL VERWALTUNG ---
        function openVerteilModal() {
            const m = document.getElementById('verteilModal');
            m.classList.add('active');
            renderVerteilTable();
            m.style.top = "100px";
            m.style.left = "50%";
        }
        function renderVerteilTable() {
            const tbody = document.getElementById('verteilTableBody'); tbody.innerHTML = "";
            verteilKeys.forEach(v => {
                tbody.innerHTML += `<tr><td>${v.id}</td><td>${v.label}</td><td><button class="warn-btn" style="padding:2px 5px;" onclick="deleteVerteilKey('${v.id}')">x</button></td></tr>`;
            });
        }
        function addVerteilKey() {
            const id = document.getElementById('newVerteilId').value;
            const label = document.getElementById('newVerteilLabel').value;
            if(!id || !label) return alert("Bitte alle Felder f√ºllen");
            if(verteilKeys.find(v=>v.id===id)) return alert("ID existiert bereits");
            verteilKeys.push({id, label});
            saveLocal();
            refreshVerteilSelects();
            renderVerteilTable();
            document.getElementById('newVerteilId').value=""; document.getElementById('newVerteilLabel').value="";
        }
        function deleteVerteilKey(id) {
            if(!confirm("L√∂schen?")) return;
            verteilKeys = verteilKeys.filter(v => v.id !== id);
            saveLocal();
            refreshVerteilSelects();
            renderVerteilTable();
        }
        function refreshVerteilSelects() {
            // Kostenliste
            document.querySelectorAll('.k-verteil').forEach(sel => {
                const oldVal = sel.value;
                sel.innerHTML = '';
                verteilKeys.forEach(v => sel.add(new Option(v.label, v.id)));
                sel.value = oldVal;
            });
            // Split Modal
            document.querySelectorAll('.split-verteil').forEach(sel => {
                const oldVal = sel.value;
                sel.innerHTML = '';
                verteilKeys.forEach(v => sel.add(new Option(v.label, v.id)));
                sel.value = oldVal;
            });
        }

        // --- DRAGGABLE LOGIC ---
        function startDrag(e, modalId) {
            e.preventDefault();
            const modal = document.getElementById(modalId);
            // Bring to front
            document.querySelectorAll('.modal-draggable').forEach(m => m.style.zIndex = 2000);
            modal.style.zIndex = 2001;

            let startX = e.clientX;
            let startY = e.clientY;
            let startLeft = modal.offsetLeft;
            let startTop = modal.offsetTop;

            function doDrag(ev) {
                const dx = ev.clientX - startX;
                const dy = ev.clientY - startY;
                modal.style.left = (startLeft + dx) + 'px';
                modal.style.top = (startTop + dy) + 'px';
                modal.style.transform = 'none'; // Disable translate centering once moved
            }

            function stopDrag() {
                document.removeEventListener('mousemove', doDrag);
                document.removeEventListener('mouseup', stopDrag);
            }

            document.addEventListener('mousemove', doDrag);
            document.addEventListener('mouseup', stopDrag);
        }


        // --- AUTH & WACHHUND LOGIK ---
        async function versucheSitzungWiederherzustellen() {
            const savedLoginType = sessionStorage.getItem('loginType');
            const savedAccountId = sessionStorage.getItem('msalAccountIdentifier');
            if (savedLoginType === 'microsoft' && savedAccountId) {
                const account = await msalInstance.getAccountByHomeId(savedAccountId);
                if (account) {
                    msalInstance.setActiveAccount(account);
                    const token = await getValidToken(false); 
                    if (token) await handleLoginSuccess(account);
                }
            }
        }
        async function handleMicrosoftLogin() {
            try {
                const loginResponse = await msalInstance.loginPopup({ scopes: ["Files.ReadWrite", "User.Read", "offline_access"], prompt: "select_account" });
                await handleLoginSuccess(loginResponse.account);
            } catch (e) { zeigeStatus("Login fehlgeschlagen: " + e.message, "error"); }
        }
        async function handleLoginSuccess(account) {
            userEmail = account.username;
            document.getElementById('loggedInUser').textContent = `(${userEmail})`;
            document.getElementById('msLoginBtn').style.display = 'none';
            document.getElementById('msLogoutBtn').style.display = 'inline-block';
            document.getElementById('cloudSaveBtn').disabled = false;
            document.getElementById('sessionExpiredWarning').style.display = 'none';
            sessionStorage.setItem('loginType', 'microsoft');
            sessionStorage.setItem('userEmail', userEmail);
            sessionStorage.setItem('msalAccountIdentifier', account.homeAccountId);
            const token = await getValidToken(false);
            if (token) {
                clearInterval(tokenRefreshIntervalId);
                tokenRefreshIntervalId = setInterval(() => getValidToken(false), 10 * 60 * 1000); 
                zeigeStatus("Angemeldet & Wachhund aktiv.", "info");
                await loadFromOneDrive(); 
            }
        }
        async function getValidToken(interactive = false) {
            if (!msalInstance) return null;
            const account = msalInstance.getActiveAccount();
            if (!account) return null;
            try {
                const response = await msalInstance.acquireTokenSilent({ scopes: ["Files.ReadWrite"], account: account });
                accessToken = response.accessToken;
                document.getElementById('sessionExpiredWarning').style.display = 'none';
                return accessToken;
            } catch (error) {
                if (interactive) {
                    try {
                        const response = await msalInstance.acquireTokenPopup({ scopes: ["Files.ReadWrite"], account: account });
                        accessToken = response.accessToken;
                        document.getElementById('sessionExpiredWarning').style.display = 'none';
                        return accessToken;
                    } catch (err2) { handleExpiredSession(); return null; }
                } else { handleExpiredSession(); return null; }
            }
        }
        function handleExpiredSession() { document.getElementById('sessionExpiredWarning').style.display = 'block'; accessToken = null; }
        async function handleLogout() { await msalInstance.logoutPopup(); sessionStorage.clear(); location.reload(); }
        
        function zeigeStatus(msg, type) { 
            const s = document.getElementById('onedriveStatus'); s.textContent = msg; s.className = 'onedrive-status ' + type; s.style.display = 'inline-flex'; 
            setTimeout(() => { if(s.textContent === msg) s.style.display = 'none'; }, 4000); 
        }

        // --- HELPER ---
        function safeFloat(val) { if(typeof val==='number') return val; if(!val) return 0; let str=val.toString().replace(',','.'); return parseFloat(str)||0; }
        function formatDate(isoStr) { if(!isoStr) return ""; const p=isoStr.split('-'); return `${p[2]}.${p[1]}.${p[0]}`; }
        function formatNum(n) { return n.toLocaleString('de-DE', {minimumFractionDigits:2, maximumFractionDigits:2}); }
        function pad(n, width, z) { z = z || '0'; n = n + ''; return n.length >= width ? n : new Array(width - n.length + 1).join(z) + n; }
        function formatCurrency(n) { return n.toLocaleString('de-DE', {style:'currency', currency:'EUR'}); }
        function getTypeLabel(typId) { const std = STANDARD_TYPES.find(t => t.id === typId); return std ? std.label : (typId || 'Unbekannt'); }
        function getNextFinanzId() { return 'tx_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5); }

        function validateVal(soll, ist, unit = '', tolerance = 0.01) {
            soll = safeFloat(soll); ist = safeFloat(ist);
            const diff = Math.round((ist - soll) * 1000) / 1000;
            if(Math.abs(diff) <= tolerance) return `<div class="validation-row"><span class="stat-ok">‚úÖ ${formatNum(ist)} ${unit} (Soll: ${formatNum(soll)})</span></div>`;
            const diffStr = diff > 0 ? `+${formatNum(diff)}` : formatNum(diff);
            return `<div class="validation-row"><span class="stat-err">‚ö†Ô∏è ${formatNum(ist)} ${unit} (Soll: ${formatNum(soll)}) <small style="margin-left:5px;">Diff: ${diffStr}</small></span></div>`;
        }

        // --- FILTER ---
        function toggleFilter(id) {
            activeFilterId = id;
            const banner = document.getElementById('filterBanner');
            const txt = document.getElementById('filterText');
            if(activeFilterId) {
                const o = dbObjekte.get(activeFilterId);
                banner.style.display = "flex";
                txt.innerHTML = `<b>Fokus aktiv:</b> ${o ? o.name : 'Objekt'}`;
            } else { banner.style.display = "none"; }
            renderLists();
        }

        // --- ID GENERATORS ---
        function getNextObjektID() { let max = 0; dbObjekte.forEach((o, id) => { const num = parseInt(id, 10); if (!isNaN(num) && num > max) max = num; }); return pad(max + 1, 4); }
        function getNextHausID(objektId) { let max = 0; dbHaeuser.forEach((h, id) => { if (id.startsWith(objektId + "/")) { const parts = id.split('/'); const num = parseInt(parts[parts.length - 1], 10); if (!isNaN(num) && num > max) max = num; } }); return objektId + "/" + pad(max + 1, 2); }
        function getNextEinheitID(hausId) { let max = 0; dbEinheiten.forEach((e, id) => { if (id.startsWith(hausId + "/")) { const parts = id.split('/'); const num = parseInt(parts[parts.length - 1], 10); if (!isNaN(num) && num > max) max = num; } }); return hausId + "/" + pad(max + 1, 4); }

        function createDummyData() {
            if(!confirm("Musterdaten (Wohnpark + Finanzhistorie + BK) erzeugen?\nDies √ºberschreibt ggf. keine Daten, f√ºgt aber neue hinzu.")) return;
            const oid = getNextObjektID();
            // Objekt mit OPT Status
            dbObjekte.set(oid, { nummer: oid, name: "Wohnpark Test", plz: "12345", ort: "Musterstadt", flaeche: 150, mea: 1000, sollHaeuser: 1, steuerStatus: "opt" });
            
            const hid = getNextHausID(oid);
            const matrix = {}; matrix['wohnung'] = { count: 2, area: 100, label: "Wohnung" }; matrix['gewerbe'] = { count: 1, area: 50, label: "Gewerbe" };
            // Haus √ºbernimmt Objekt Status oder ist explizit gesetzt
            dbHaeuser.set(hid, { objektId: oid, bezeichnung: "Haus A", anteile: 1000, sollMatrix: matrix, steuerStatus: "opt" });
            
            // Einheit 1: Wohnung Links (MIT VERBRAUCHSDATEN)
            let eid = getNextEinheitID(hid);
            const contractId = `${eid}/01`; 
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth() + 1;

            const dummyVerbrauch = {
                personen: [
                    { von: '2023-01-01', bis: '2023-06-30', anzahl: 2 },
                    { von: '2023-07-01', bis: '2099-12-31', anzahl: 3 } // Baby bekommen
                ],
                zaehler: [
                    { typ: 'wasser_kalt', nummer: 'K-1001', von: '2023-01-01', bis: '2023-12-31', start: 100, ende: 145 },
                    { typ: 'wasser_warm', nummer: 'W-2002', von: '2023-01-01', bis: '2023-12-31', start: 50, ende: 75 }
                ],
                direkt: [
                    { typ: 'heizung_extern', von: '2023-01-01', bis: '2023-12-31', betrag: 1200, lohn: 150 }
                ]
            };

            dbEinheiten.set(eid, { 
                hausId: hid, name: "EG Links", typ: "wohnung", flaeche: 50, zimmer: 2, mea: 333.33, ww_m3: 123.4, kw_m3: 456.7, 
                konditionen: [
                    { id: 'k1', label: 'Kaltmiete', betrag: 500, konto: '8000', gueltigAb: '2023-01-01', gueltigBis: '', steuerKey: '2' }, // 7%
                    { id: 'k2', label: 'BK-Vorausz.', betrag: 100, konto: '8010', gueltigAb: '2023-01-01', gueltigBis: '', steuerKey: '20' } // 0%
                ], 
                belegung: [{ mieterId: "dummy_mieter", einzug: "2023-01-01", auszug: "" }],
                verbrauchsdaten: dummyVerbrauch
            });

            // Finanzhistorie f√ºr Einheit 1
            for(let i=1; i<=3; i++) {
                let m = month - i;
                let y = year;
                if(m <= 0) { m += 12; y--; }
                const mStr = `${y}-${pad(m,2)}`;
                const dBuch = `${mStr}-01`;
                
                dbFinanzen.push({
                    id: getNextFinanzId(), einheitId: eid, mieterId: "dummy_mieter", monatRef: mStr, buchungsdatum: dBuch,
                    typ: 'soll', kategorie: 'Kaltmiete', text: `${contractId}-${pad(m,2)}${y} (Kaltmiete)`,
                    betrag: 500, konto: '8000', steuerschluessel: '2', steuerbetrag: 32.71, locked: true
                });
                dbFinanzen.push({
                    id: getNextFinanzId(), einheitId: eid, mieterId: "dummy_mieter", monatRef: mStr, buchungsdatum: dBuch,
                    typ: 'soll', kategorie: 'BK-Vorausz.', text: `${contractId}-${pad(m,2)}${y} (BK-Vorausz.)`,
                    betrag: 100, konto: '8010', steuerschluessel: '20', steuerbetrag: 0, locked: true
                });
                dbFinanzen.push({
                    id: getNextFinanzId(), einheitId: eid, mieterId: "dummy_mieter", monatRef: mStr, buchungsdatum: `${mStr}-05`,
                    typ: 'haben', kategorie: 'Mieteingang', text: `Miete ${m}/${y}`,
                    betrag: 600, konto: '1200', steuerschluessel: '', steuerbetrag: 0, locked: false
                });
            }

            // Einheit 2: Wohnung Rechts
            eid = getNextEinheitID(hid);
            dbEinheiten.set(eid, { hausId: hid, name: "EG Rechts", typ: "wohnung", flaeche: 50, zimmer: 2, mea: 333.33, belegung: [] });

            // Einheit 3: Gewerbe (FEHLTE VORHER)
            eid = getNextEinheitID(hid);
            dbEinheiten.set(eid, { 
                hausId: hid, name: "B√ºro OG", typ: "gewerbe", flaeche: 50, zimmer: 3, mea: 333.34, 
                konditionen: [
                    { id: 'k1', label: 'Kaltmiete', betrag: 800, konto: '8000', gueltigAb: '2023-01-01', gueltigBis: '', steuerKey: '3' } // 19%
                ],
                belegung: [] 
            });

            // DUMMY BK ABRECHNUNG
            const abrId = 'abr_' + Date.now();
            dbAbrechnungen.push({ id: abrId, objektId: oid, name: "Betriebskosten 2023", von: "2023-01-01", bis: "2023-12-31" });
            // Kostenpositionen (MIT LOHNANTEIL)
            dbKosten.push({ id: getNextFinanzId(), abrechnungId: abrId, konto: "4000", text: "Wasser / Abwasser", brutto: 1070, steuerKey: "8", netto: 1000, steuerBetrag: 70, verteilKey: "m2", lohn: 0 });
            dbKosten.push({ id: getNextFinanzId(), abrechnungId: abrId, konto: "4100", text: "Heizung", brutto: 2380, steuerKey: "9", netto: 2000, steuerBetrag: 380, verteilKey: "direkt", lohn: 200 }); // 200‚Ç¨ Lohn
            dbKosten.push({ id: getNextFinanzId(), abrechnungId: abrId, konto: "4200", text: "Grundsteuer", brutto: 500, steuerKey: "30", netto: 500, steuerBetrag: 0, verteilKey: "mea", lohn: 0 });
            
            saveLocal(); renderLists(); alert("Vollst√§ndige Testdaten (2 Whg, 1 Gew) & BK 2023 angelegt!");
        }

        // --- LOAD / SAVE ---
        function triggerAutoSave() { if(!accessToken) return; zeigeStatus("‚è≥ Speichern...", "info"); clearTimeout(autoSaveTimer); autoSaveTimer = setTimeout(() => saveToOneDrive(false), 2000); }
        async function loadFromOneDrive() {
            if (!(await getValidToken(true))) return;
            zeigeStatus("Lade Daten...", "saving");
            try { const resC = await fetch("https://graph.microsoft.com/v1.0/me/drive/root:/ideenapp/stammdaten.json:/content", { headers: { "Authorization": `Bearer ${accessToken}` } }); if (resC.ok) { const d = await resC.json(); if(d.kontakte) dbKontakte = new Map(d.kontakte); } } catch(e) {}
            try { const resF = await fetch("https://graph.microsoft.com/v1.0/me/drive/root:/ideenapp/finanzen.json:/content", { headers: { "Authorization": `Bearer ${accessToken}` } }); if (resF.ok) { const d = await resF.json(); 
                if(d.finanzen) dbFinanzen = d.finanzen; 
                if(d.taxKeys) taxKeys = d.taxKeys; 
                if(d.verteilKeys) verteilKeys = d.verteilKeys; // NEU
                if(d.abrechnungen) dbAbrechnungen = d.abrechnungen;
                if(d.kosten) dbKosten = d.kosten;
                initTaxSelect(); renderTaxTable(); renderVerteilTable();
            } } catch(e) {}
            try { const resI = await fetch("https://graph.microsoft.com/v1.0/me/drive/root:/ideenapp/immobilien.json:/content", { headers: { "Authorization": `Bearer ${accessToken}` } }); if (resI.ok) { const d = await resI.json(); if(d.objekte) dbObjekte = new Map(d.objekte); if(d.haeuser) dbHaeuser = new Map(d.haeuser); if(d.einheiten) dbEinheiten = new Map(d.einheiten); saveLocal(); renderLists(); zeigeStatus("Daten geladen", "success"); } } catch(e) { zeigeStatus("Fehler: " + e.message, "error"); }
        }
        async function saveToOneDrive(isManual = true) {
            if (!(await getValidToken(isManual))) { if(isManual) alert("Session abgelaufen."); return; }
            zeigeStatus("‚òÅÔ∏è Speichere...", "saving");
            const dataImmo = { objekte: Array.from(dbObjekte.entries()), haeuser: Array.from(dbHaeuser.entries()), einheiten: Array.from(dbEinheiten.entries()), meta: { updated: new Date().toISOString() } };
            const p1 = fetch("https://graph.microsoft.com/v1.0/me/drive/root:/ideenapp/immobilien.json:/content", { method: "PUT", headers: { "Authorization": `Bearer ${accessToken}`, "Content-Type": "application/json" }, body: JSON.stringify(dataImmo, null, 2) });
            // NEU: inkl Abrechnungen, Kosten, Verteilschl√ºssel
            const dataFin = { finanzen: dbFinanzen, taxKeys: taxKeys, verteilKeys: verteilKeys, abrechnungen: dbAbrechnungen, kosten: dbKosten, meta: { updated: new Date().toISOString() } };
            const p2 = fetch("https://graph.microsoft.com/v1.0/me/drive/root:/ideenapp/finanzen.json:/content", { method: "PUT", headers: { "Authorization": `Bearer ${accessToken}`, "Content-Type": "application/json" }, body: JSON.stringify(dataFin, null, 2) });
            try { await Promise.all([p1, p2]); zeigeStatus("‚úì Gespeichert", "success"); } catch(e) { zeigeStatus("Fehler: " + e.message, "error"); }
        }
        function loadLocal() { 
            try { 
                const o=localStorage.getItem("immo_objekte"); if(o) dbObjekte=new Map(JSON.parse(o)); 
                const h=localStorage.getItem("immo_haeuser"); if(h) dbHaeuser=new Map(JSON.parse(h)); 
                const e=localStorage.getItem("immo_einheiten"); if(e) dbEinheiten=new Map(JSON.parse(e)); 
                const f=localStorage.getItem("immo_finanzen"); if(f) { 
                    const parsed=JSON.parse(f); 
                    dbFinanzen=parsed.finanzen || parsed; 
                    if(parsed.taxKeys) taxKeys = parsed.taxKeys; 
                    if(parsed.verteilKeys) verteilKeys = parsed.verteilKeys; // NEU
                    if(parsed.abrechnungen) dbAbrechnungen = parsed.abrechnungen;
                    if(parsed.kosten) dbKosten = parsed.kosten;
                }
                const k=localStorage.getItem("kontakte_personen"); if(k) dbKontakte=new Map(JSON.parse(k));
            } catch(err){} 
        }
        function saveLocal() { 
            localStorage.setItem("immo_objekte", JSON.stringify(Array.from(dbObjekte.entries()))); 
            localStorage.setItem("immo_haeuser", JSON.stringify(Array.from(dbHaeuser.entries()))); 
            localStorage.setItem("immo_einheiten", JSON.stringify(Array.from(dbEinheiten.entries()))); 
            // NEU: inkl. abrechnungen und kosten
            localStorage.setItem("immo_finanzen", JSON.stringify({finanzen: dbFinanzen, taxKeys: taxKeys, verteilKeys: verteilKeys, abrechnungen: dbAbrechnungen, kosten: dbKosten}));
        }
        // ... (speichere/ladeDateiLokal analog) ...
        async function speichereDateiLokal() {
            // NEU: inkl Abrechnungen und Kosten
            const data = { objekte: Array.from(dbObjekte.entries()), haeuser: Array.from(dbHaeuser.entries()), einheiten: Array.from(dbEinheiten.entries()), finanzen: dbFinanzen, taxKeys: taxKeys, verteilKeys: verteilKeys, abrechnungen: dbAbrechnungen, kosten: dbKosten };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
            if (window.showSaveFilePicker) { try { const handle = await window.showSaveFilePicker({ suggestedName: "objekte_backup.json", types: [{ accept: { "application/json": [".json"] } }] }); const writable = await handle.createWritable(); await writable.write(blob); await writable.close(); zeigeStatus("Lokal gesichert", "success"); } catch(e) {} } else { const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = "objekte_backup.json"; a.click(); }
        }
        async function ladeDateiLokal() {
            try { let text; if (window.showOpenFilePicker) { const [handle] = await window.showOpenFilePicker({ types: [{ accept: { "application/json": [".json"] } }] }); const file = await handle.getFile(); text = await file.text(); } else { const inp = document.createElement("input"); inp.type="file"; inp.click(); await new Promise(r => inp.onchange = e => { if(e.target.files[0]) { const reader = new FileReader(); reader.onload=ev=>r(text=ev.target.result); reader.readAsText(e.target.files[0]); } }); } if(text) { const d = JSON.parse(text); if(d.objekte) dbObjekte = new Map(d.objekte); if(d.haeuser) dbHaeuser = new Map(d.haeuser); if(d.einheiten) dbEinheiten = new Map(d.einheiten); if(d.finanzen) dbFinanzen = d.finanzen; if(d.taxKeys) taxKeys = d.taxKeys; 
                // NEU
                if(d.verteilKeys) verteilKeys = d.verteilKeys;
                if(d.abrechnungen) dbAbrechnungen = d.abrechnungen;
                if(d.kosten) dbKosten = d.kosten;
                initTaxSelect(); renderTaxTable(); renderVerteilTable(); saveLocal(); renderLists(); triggerAutoSave(); alert("Backup geladen!"); } } catch(e) { alert("Fehler: "+e.message); }
        }

        // --- MATRIX LOGIK (Unver√§ndert, aber n√∂tig) ---
        function renderHausMatrix(haus) { const tbody = document.getElementById('hausSollMatrixBody'); tbody.innerHTML = ""; STANDARD_TYPES.forEach(t => addMatrixRowToUI(t.id, t.label, haus ? haus.sollMatrix : null, false)); if(haus && haus.sollMatrix) Object.keys(haus.sollMatrix).forEach(key => { if(!STANDARD_TYPES.some(st => st.id === key)) addMatrixRowToUI(key, haus.sollMatrix[key].label || "Unbenannt", haus.sollMatrix, true); }); }
        function addMatrixRowToUI(id, label, matrixData, isCustom) { const tbody = document.getElementById('hausSollMatrixBody'); const tr = document.createElement('tr'); tr.dataset.typeId = id; const cnt = matrixData && matrixData[id] ? matrixData[id].count : ""; const area = matrixData && matrixData[id] ? matrixData[id].area : ""; let labelHtml = label; if(isCustom) { labelHtml = `<input type="text" class="custom-label-inp" value="${label.replace(/"/g, '&quot;')}" style="text-align:left; background:#fff; border:1px solid #ccc; padding:2px;">`; } tr.innerHTML = `<td>${labelHtml}</td><td><input type="number" step="1" class="soll-count matrix-inp" value="${cnt}" oninput="calcMatrixSum()"></td><td class="readonly-val ist-count">0</td><td class="diff-val diff-count">0</td><td><input type="number" step="0.01" class="soll-area matrix-inp" value="${area}" oninput="calcMatrixSum()"></td><td class="readonly-val ist-area">0</td><td class="diff-val diff-area">0.00</td><td>${isCustom ? '<button type="button" class="warn-btn" style="padding:2px 6px;" onclick="this.closest(\'tr\').remove(); calcMatrixSum();">X</button>' : ''}</td>`; tbody.appendChild(tr); }
        function addCustomTypeRow() { addMatrixRowToUI('custom_' + Date.now(), "Neuer Typ", null, true); }
        function calcMatrixSum() { /* (Logik bleibt gleich, gek√ºrzt) */ let sumCnt=0, sumArea=0, istTotalCnt=0, istTotalArea=0; const hid = document.getElementById('hausIdInput').value; const einheiten = hid ? Array.from(dbEinheiten.values()).filter(e => e.hausId === hid) : []; const sollMea = safeFloat(document.getElementById('hausAnteileInput').value); const istMea = einheiten.reduce((s,e) => s + safeFloat(e.mea), 0); const meaStat = document.getElementById('hausMeaStatus'); meaStat.innerText = `Ist: ${formatNum(istMea)} | Diff: ${formatNum(istMea - sollMea)}`; meaStat.style.color = (Math.abs(istMea - sollMea) <= 0.01) ? '#2e7d32' : '#c62828'; document.querySelectorAll('#hausSollMatrixBody tr').forEach(tr => { const typeId = tr.dataset.typeId; const sollC = safeFloat(tr.querySelector('.soll-count').value); const sollA = safeFloat(tr.querySelector('.soll-area').value); sumCnt += sollC; sumArea += sollA; const unitsOfType = einheiten.filter(e => e.typ === typeId); const istC = unitsOfType.length; const istA = unitsOfType.reduce((s,e)=>s+safeFloat(e.flaeche), 0); istTotalCnt += istC; istTotalArea += istA; tr.querySelector('.ist-count').innerText = istC; tr.querySelector('.ist-area').innerText = formatNum(istA); tr.querySelector('.diff-count').innerText = (istC - sollC); tr.querySelector('.diff-count').style.color = (istC - sollC === 0) ? '#2e7d32' : '#c62828'; tr.querySelector('.diff-area').innerText = formatNum(istA - sollA); tr.querySelector('.diff-area').style.color = (Math.abs(istA - sollA) < 0.1) ? '#2e7d32' : '#c62828'; }); document.getElementById('matrixSumCount').innerText = sumCnt; document.getElementById('matrixSumArea').innerText = formatNum(sumArea); document.getElementById('matrixIstCount').innerText = istTotalCnt; document.getElementById('matrixIstArea').innerText = formatNum(istTotalArea); }
        
        // --- MASKEN & LOGIK ---
        function onHausSelectionChange(isFirstLoad = false) { updateHausIdPreview(); updateHausTypeOverview(isFirstLoad); updateUnitLiveStatus(); }
        function updateHausIdPreview() { const oid = document.getElementById('hausObjektSelect').value; if(oid && !document.getElementById('hausIdInput').value) document.getElementById('hausNummerDisplay').value = getNextHausID(oid); }
        function updateHausTypeOverview(isFirstLoad) { /* ... (bleibt) ... */ }
        function updateUnitLiveStatus() { document.getElementById('einheitLiveStatus').style.display = "none"; }
        function updateObjektLiveStatus() { }
        function switchTab(id) { document.querySelectorAll('.panel').forEach(p => p.classList.remove('active')); document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); const p = document.getElementById('panel' + id.charAt(0).toUpperCase() + id.slice(1)); if(p) p.classList.add('active'); const btns = document.querySelectorAll('.tab-btn'); if(id==='objekte'&&btns[0])btns[0].classList.add('active'); if(id==='haeuser'&&btns[1])btns[1].classList.add('active'); if(id==='einheiten'&&btns[2])btns[2].classList.add('active'); if(id==='kosten'&&btns[3])btns[3].classList.add('active'); }
        
        function renderLists() {
            // Dropdowns f√ºllen
            const oSel = document.getElementById('hausObjektSelect'); 
            const eObjSel = document.getElementById('einheitObjektSelect'); 
            const kObjSel = document.getElementById('kostenObjektSelect'); // NEU
            if (oSel && eObjSel) { 
                oSel.innerHTML = ""; 
                eObjSel.innerHTML = "<option value=''>-- Objekt w√§hlen --</option>"; 
                kObjSel.innerHTML = "<option value=''>-- Objekt w√§hlen --</option>";
                dbObjekte.forEach((o, id) => { 
                    oSel.add(new Option(`${o.name}`, id)); 
                    eObjSel.add(new Option(`${o.name}`, id)); 
                    kObjSel.add(new Option(`${o.name}`, id));
                }); 
            }
            
            let showObj = dbObjekte; 
            let showHaus = dbHaeuser; 
            let showEin = dbEinheiten; 
            
            if(activeFilterId) { 
                showObj = new Map(); 
                if(dbObjekte.has(activeFilterId)) showObj.set(activeFilterId, dbObjekte.get(activeFilterId)); 
                showHaus = new Map(Array.from(dbHaeuser.entries()).filter(([id, h]) => h.objektId === activeFilterId)); 
                const hausIds = Array.from(showHaus.keys()); 
                showEin = new Map(Array.from(dbEinheiten.entries()).filter(([id, e]) => hausIds.includes(e.hausId))); 
            }

            // Objekte rendern
            const oDiv = document.getElementById('objekteListe'); 
            oDiv.innerHTML = ""; 
            showObj.forEach((o, id) => { 
                const haeuserArr = Array.from(dbHaeuser.entries()).filter(([hid, h]) => h.objektId === id);
                let sumHausFlaecheSoll = 0; 
                let sumHausMea = haeuserArr.reduce((s,[hid,h]) => s + safeFloat(h.anteile), 0);
                let realTotalArea = 0; 
                let objTypeStats = {}; 
                let hausListHtml = '<div class="detail-header">H√§user-√úbersicht:</div>';
                
                haeuserArr.forEach(([hid, h]) => { 
                    if(h.sollMatrix) Object.values(h.sollMatrix).forEach(v => sumHausFlaecheSoll += safeFloat(v.area)); 
                    else sumHausFlaecheSoll += (safeFloat(h.wohnflaeche)+safeFloat(h.gewerbeflaeche)); 
                    const hEinheiten = Array.from(dbEinheiten.values()).filter(e => e.hausId === hid); 
                    const hArea = hEinheiten.reduce((s,e) => s + safeFloat(e.flaeche), 0); 
                    realTotalArea += hArea; 
                    hausListHtml += `<div class="detail-row"><span>${h.bezeichnung}</span><span>${formatNum(hArea)} m¬≤</span></div>`; 
                    hEinheiten.forEach(e => { const t = e.typ || 'sonstige'; if(!objTypeStats[t]) objTypeStats[t] = { count: 0, area: 0 }; objTypeStats[t].count++; objTypeStats[t].area += safeFloat(e.flaeche); }); 
                });
                
                let typeListHtml = '<div class="detail-header">Typen-Verteilung (Gesamt):</div>'; 
                Object.keys(objTypeStats).forEach(tid => { const s = objTypeStats[tid]; typeListHtml += `<div class="detail-row"><span>${getTypeLabel(tid)} (${s.count})</span><span>${formatNum(s.area)} m¬≤</span></div>`; });
                
                let valHtml = validateVal(o.sollHaeuser || 0, haeuserArr.length, "H√§user", 0); 
                valHtml += validateVal(o.flaeche || 0, sumHausFlaecheSoll, "m¬≤ (Plan)"); 
                valHtml += `<div class="validation-row" style="margin-top:5px; border-top:1px solid #ccc; font-weight:bold;"><span>Ist-Fl√§che (Einheiten):</span><span>${formatNum(realTotalArea)} m¬≤</span></div>`; 
                valHtml += validateVal(o.mea || 1000, sumHausMea, "MEA");
                
                // Steuer Badge Objekt
                const tSt = TAX_STATUS_MAP[o.steuerStatus || 'opt'];
                const tBadge = `<span class="tax-badge ${tSt.class}">${tSt.label}</span>`;

                const filterBtn = (activeFilterId === id) ? `<button class="filter-btn active" onclick="toggleFilter(null)">Filter l√∂sen</button>` : `<button class="filter-btn" onclick="toggleFilter('${id}')">üéØ Fokus</button>`;
                
                oDiv.innerHTML += `
                <div class="liste-item">
                    <input type="checkbox" class="item-checkbox" value="${id}">
                    <div class="liste-content">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <h4>${o.name} <small>[${o.nummer}]</small> ${tBadge}</h4>
                            <div>${filterBtn} <button onclick="openObjektMask('${id}')">Bearbeiten</button></div>
                        </div>
                        <div class="sub-info">${o.plz} ${o.ort}</div>
                        <div class="objekt-stats">${valHtml}</div>
                        <div class="detail-box">${hausListHtml}${typeListHtml}</div>
                    </div>
                </div>`; 
            });

            // H√§user rendern
            const hDiv = document.getElementById('haeuserListe'); 
            hDiv.innerHTML = ""; 
            showHaus.forEach((h, id) => { 
                const o = dbObjekte.get(h.objektId); 
                const einheiten = Array.from(dbEinheiten.values()).filter(e => e.hausId === id); 
                let hausTypeStats = {}; 
                let hausRealArea = 0; 
                einheiten.forEach(e => { const t = e.typ || 'sonstige'; if(!hausTypeStats[t]) hausTypeStats[t] = { count: 0, area: 0 }; hausTypeStats[t].count++; const fl = safeFloat(e.flaeche); hausTypeStats[t].area += fl; hausRealArea += fl; });
                
                let typeListHtml = '<div class="detail-header">Typen im Haus:</div>'; 
                if(Object.keys(hausTypeStats).length === 0) typeListHtml += '<div style="font-style:italic; color:#777;">Keine Einheiten.</div>'; 
                Object.keys(hausTypeStats).forEach(tid => { const s = hausTypeStats[tid]; typeListHtml += `<div class="detail-row"><span>${getTypeLabel(tid)} (${s.count})</span><span>${formatNum(s.area)} m¬≤</span></div>`; });
                
                let valHtml = ""; let hasError = false; 
                if(h.sollMatrix) { Object.keys(h.sollMatrix).forEach(tid => { const tLabel = h.sollMatrix[tid].label; const sollCnt = safeFloat(h.sollMatrix[tid].count); const sollArea = safeFloat(h.sollMatrix[tid].area); if(sollCnt>0 || sollArea>0) { const act = einheiten.filter(e => e.typ === tid); const istCnt = act.length; const istArea = act.reduce((s,e)=>s+safeFloat(e.flaeche),0); if(istCnt!=sollCnt) { hasError=true; valHtml += `<div class="validation-row"><span class="stat-err">‚ö†Ô∏è ${tLabel} Anz: ${istCnt}/${sollCnt}</span></div>`; } if(Math.abs(istArea-sollArea)>0.1) { hasError=true; valHtml += `<div class="validation-row"><span class="stat-err">‚ö†Ô∏è ${tLabel} Fl.: ${formatNum(istArea)}/${formatNum(sollArea)} m¬≤</span></div>`; } } }); } 
                const sumMea = einheiten.reduce((s,e)=>s+safeFloat(e.mea),0); 
                valHtml += validateVal(h.anteile||0, sumMea, "MEA"); 
                if(!hasError && valHtml.indexOf('‚ö†Ô∏è')===-1) valHtml = '<div class="stat-ok">‚úÖ Alle Vorgaben erf√ºllt.</div>' + valHtml;
                
                // Steuer Badge Haus
                let hStKey = 'opt';
                if(o && o.steuerStatus === 'mixed') hStKey = h.steuerStatus || 'opt';
                else if(o) hStKey = (o.steuerStatus === 'none') ? 'none' : 'opt';
                
                const tSt = TAX_STATUS_MAP[hStKey] || TAX_STATUS_MAP['opt'];
                const tBadge = `<span class="tax-badge ${tSt.class}">${tSt.label}</span>`;

                hDiv.innerHTML += `
                <div class="liste-item">
                    <input type="checkbox" class="item-checkbox" value="${id}">
                    <div class="liste-content">
                        <div style="display:flex; justify-content:space-between;">
                            <h4>${h.bezeichnung} <span style="font-size:0.7em; font-weight:normal; color:#555;">(Objekt ${o ? o.nummer : "?"})</span> ${tBadge}</h4>
                            <button onclick="openHausMask('${id}')">Bearbeiten</button>
                        </div>
                        <div class="objekt-stats">${valHtml}</div>
                        <div class="detail-box">
                            <div class="detail-row" style="border-bottom:1px solid #ddd; margin-bottom:3px;"><span><b>Gesamtfl√§che (Ist):</b></span><span><b>${formatNum(hausRealArea)} m¬≤</b></span></div>
                            ${typeListHtml}
                        </div>
                    </div>
                </div>`; 
            });

            // Einheiten rendern
            const eDiv = document.getElementById('einheitenListe'); 
            eDiv.innerHTML = ""; 
            const listE = Array.from(showEin.entries()).map(([id, e]) => { const h = dbHaeuser.get(e.hausId); const o = h ? dbObjekte.get(h.objektId) : null; return { id, ...e, hName: h?h.bezeichnung:'?', oName: o?o.name:'?' }; }).sort((a,b) => a.oName.localeCompare(b.oName) || a.hName.localeCompare(b.hName));
            
            listE.forEach(e => {
                let stHtml = '<span class="status-leerstand">‚ö†Ô∏è LEERSTAND</span>';
                if(e.belegung && e.belegung.length>0) {
                    const act = e.belegung.find(b => (b.einzug||'0000')<=new Date().toISOString().split('T')[0] && (b.auszug||'9999')>=new Date().toISOString().split('T')[0]);
                    const fut = e.belegung.find(b => (b.einzug||'0000')>new Date().toISOString().split('T')[0]);
                    const sortedBel = [...e.belegung].sort((a,b) => (a.einzug||'').localeCompare(b.einzug||''));
                    
                    if(act) { 
                        const m = dbKontakte.get(act.mieterId); 
                        const seqIndex = sortedBel.indexOf(act) + 1; 
                        const contractId = e.id + "/" + pad(seqIndex, 2);
                        stHtml = `<div style="margin-bottom:3px;"><span class="status-vermietet">‚úÖ ${m?m.fn:'?'}</span> <small style="color:#666; font-family:monospace;">(Vertrag: ${contractId})</small></div>`;
                        if(m) { let contactInfo = ""; if(m.telefon && m.telefon.length > 0) contactInfo += `<div>üìû ${m.telefon.map(t=>t.number).join(', ')}</div>`; if(m.email && m.email.length > 0) contactInfo += `<div>‚úâÔ∏è ${m.email.map(em=>em.address).join(', ')}</div>`; if(contactInfo) stHtml += `<div style="font-size:0.8em; color:#555; margin-top:2px; border-top:1px dotted #ccc; padding-top:2px;">${contactInfo}</div>`; }
                        stHtml += `<span style="font-size:0.85em; color:#555;">Seit: ${formatDate(act.einzug)}</span>`;
                    }
                    else if(fut) { const m=dbKontakte.get(fut.mieterId); stHtml = `<span class="status-zukunft">‚û°Ô∏è Ab ${formatDate(fut.einzug)}: ${m?m.fn:'?'}</span>`; }
                }
                
                // Steuer Badge Einheit
                // Logik: Objekt > Haus > Einheit (wenn mixed)
                let hStKey = 'opt';
                const h = dbHaeuser.get(e.hausId);
                const o = h ? dbObjekte.get(h.objektId) : null;
                
                if(o && o.steuerStatus === 'mixed') {
                    if(h && h.steuerStatus === 'mixed') {
                        // Einheit Mixed Status k√∂nnte hier stehen, wenn wir es speichern w√ºrden
                        // Aktuell implizit via Konditionen
                        hStKey = 'mixed'; 
                    } else {
                        hStKey = h ? (h.steuerStatus || 'opt') : 'opt';
                    }
                }
                else if(o) hStKey = (o.steuerStatus === 'none') ? 'none' : 'opt';
                
                const tSt = TAX_STATUS_MAP[hStKey] || TAX_STATUS_MAP['opt'];
                const tBadge = `<span class="tax-badge ${tSt.class}">${tSt.label}</span>`;

                const kontoBtn = `<button class="account-btn" onclick="openKontoModal('${e.id}')">üí∂ Konto</button>`;
                const verbrauchBtn = `<button class="finance-btn" style="background:#0288d1; border-color:#0277bd;" onclick="openVerbrauchsdatenModal('${e.id}')">üìä Z√§hler</button>`; // NEU
                
                eDiv.innerHTML += `
                <div class="liste-item">
                    <input type="checkbox" class="item-checkbox" value="${e.id}">
                    <div class="liste-content">
                        <div style="display:flex; justify-content:space-between;">
                            <h4>${e.name} <small style="font-family:monospace; color:#000;">[ID: ${e.id}]</small> <small>(${e.hName})</small> ${tBadge}</h4>
                            <div style="display:flex; gap:5px;">${verbrauchBtn} ${kontoBtn} <button onclick="openEinheitMask('${e.id}')">Bearbeiten</button></div>
                        </div>
                        <div class="sub-info"><span style="display:inline-block; padding:2px 6px; background:#e3f2fd; color:#0d47a1; border-radius:4px; font-size:0.9em; margin-right:5px;">${getTypeLabel(e.typ)}</span><b>${formatNum(safeFloat(e.flaeche))} m¬≤</b></div>
                        <div class="mieter-status">${stHtml}</div>
                    </div>
                </div>`;
            });
        }

        // ================= VERBRAUCHSDATEN LOGIK =================
        function openVerbrauchsdatenModal(einheitId) {
            const e = dbEinheiten.get(einheitId);
            if(!e) return;
            document.getElementById('verbrauchsdatenEinheitId').value = einheitId;
            document.getElementById('verbrauchsdatenTitle').innerText = `Daten f√ºr: ${e.name}`;
            
            // Clear lists
            document.getElementById('personenListe').innerHTML = "";
            document.getElementById('zaehlerListe').innerHTML = "";
            document.getElementById('direktListe').innerHTML = "";

            const v = e.verbrauchsdaten || { personen: [], zaehler: [], direkt: [] };

            // Populate
            if(v.personen) v.personen.forEach(p => addPersonenRow(p));
            if(v.zaehler) {
                // Sort by date desc (newest first)
                const sortedZ = [...v.zaehler].sort((a,b) => (b.von || '').localeCompare(a.von || ''));
                sortedZ.forEach(z => addZaehlerRow(z));
            }
            if(v.direkt) v.direkt.forEach(d => addDirektRow(d));

            // Position Modal
            const m = document.getElementById('verbrauchsdatenModal');
            m.classList.add('active');
            m.style.top = "50px";
            m.style.left = "50%";
        }

        function addPersonenRow(data = {}) {
            const container = document.getElementById('personenListe');
            const row = document.createElement('div');
            row.className = 'verbrauch-row personen-row';
            
            row.innerHTML = `
                <input type="date" class="p-von" value="${data.von || ''}" placeholder="Von">
                <input type="date" class="p-bis" value="${data.bis || ''}" placeholder="Bis">
                <input type="number" class="p-anzahl" value="${data.anzahl || ''}" placeholder="Anzahl" step="0.5">
                <button class="warn-btn" style="padding:2px 5px;" onclick="this.parentElement.remove()">X</button>
            `;
            container.appendChild(row);
        }

        function addZaehlerRow(data = {}) {
            const container = document.getElementById('zaehlerListe');
            const row = document.createElement('div');
            row.className = 'verbrauch-row zaehler-row';
            
            // Build Type Options
            let typeOpts = "";
            ZAEHLER_TYPES.forEach(t => {
                typeOpts += `<option value="${t.id}" ${data.typ === t.id ? 'selected' : ''}>${t.label}</option>`;
            });

            // Build Z√§hler-Nr Datalist/Select Logic could be here, for now simple input
            // Um eindeutige Z√§hlernummern zu merken, m√ºssten wir alle Einheiten scannen. 
            // Einfache L√∂sung: Input mit Datalist global
            
            row.innerHTML = `
                <select class="z-typ" style="flex:1.5;">${typeOpts}</select>
                <input type="text" class="z-nr" value="${data.nummer || ''}" placeholder="Nr." list="zaehlerNrs">
                <input type="date" class="z-von" value="${data.von || ''}" style="flex:1.2;">
                <input type="date" class="z-bis" value="${data.bis || ''}" style="flex:1.2;">
                <input type="number" class="z-start" value="${data.start || ''}" placeholder="Start" step="0.001">
                <input type="number" class="z-ende" value="${data.ende || ''}" placeholder="Ende" step="0.001">
                <button class="warn-btn" style="padding:2px 5px;" onclick="this.parentElement.remove()">X</button>
            `;
            container.appendChild(row);
        }

        function addDirektRow(data = {}) {
            const container = document.getElementById('direktListe');
            const row = document.createElement('div');
            row.className = 'verbrauch-row direkt-row';
            
            let typeOpts = "";
            DIREKT_TYPES.forEach(t => {
                typeOpts += `<option value="${t.id}" ${data.typ === t.id ? 'selected' : ''}>${t.label}</option>`;
            });

            row.innerHTML = `
                <select class="d-typ" style="flex:1.5;">${typeOpts}</select>
                <input type="date" class="d-von" value="${data.von || ''}" style="flex:1.2;">
                <input type="date" class="d-bis" value="${data.bis || ''}" style="flex:1.2;">
                <input type="number" class="d-betrag" value="${data.betrag || ''}" placeholder="‚Ç¨" step="0.01">
                <input type="number" class="d-lohn" value="${data.lohn || ''}" placeholder="Lohn ‚Ç¨" step="0.01">
                <button class="warn-btn" style="padding:2px 5px;" onclick="this.parentElement.remove()">X</button>
            `;
            container.appendChild(row);
        }

        function saveVerbrauchsdaten() {
            const eid = document.getElementById('verbrauchsdatenEinheitId').value;
            const e = dbEinheiten.get(eid);
            if(!e) return;

            const personen = [];
            document.querySelectorAll('.personen-row').forEach(r => {
                const von = r.querySelector('.p-von').value;
                const bis = r.querySelector('.p-bis').value;
                const anz = r.querySelector('.p-anzahl').value;
                if(von && anz) personen.push({ von, bis, anzahl: parseFloat(anz) });
            });

            const zaehler = [];
            document.querySelectorAll('.zaehler-row').forEach(r => {
                zaehler.push({
                    typ: r.querySelector('.z-typ').value,
                    nummer: r.querySelector('.z-nr').value,
                    von: r.querySelector('.z-von').value,
                    bis: r.querySelector('.z-bis').value,
                    start: safeFloat(r.querySelector('.z-start').value),
                    ende: safeFloat(r.querySelector('.z-ende').value)
                });
            });

            const direkt = [];
            document.querySelectorAll('.direkt-row').forEach(r => {
                direkt.push({
                    typ: r.querySelector('.d-typ').value,
                    von: r.querySelector('.d-von').value,
                    bis: r.querySelector('.d-bis').value,
                    betrag: safeFloat(r.querySelector('.d-betrag').value),
                    lohn: safeFloat(r.querySelector('.d-lohn').value)
                });
            });

            e.verbrauchsdaten = { personen, zaehler, direkt };
            dbEinheiten.set(eid, e);
            
            saveLocal();
            triggerAutoSave();
            document.getElementById('verbrauchsdatenModal').classList.remove('active');
            // Z√§hlernummern sammeln f√ºr Autocomplete
            updateZaehlerDatalist();
        }

        function updateZaehlerDatalist() {
            let dl = document.getElementById('zaehlerNrs');
            if(!dl) {
                dl = document.createElement('datalist');
                dl.id = "zaehlerNrs";
                document.body.appendChild(dl);
            }
            dl.innerHTML = "";
            const nrs = new Set();
            dbEinheiten.forEach(e => {
                if(e.verbrauchsdaten && e.verbrauchsdaten.zaehler) {
                    e.verbrauchsdaten.zaehler.forEach(z => {
                        if(z.nummer) nrs.add(z.nummer);
                    });
                }
            });
            nrs.forEach(n => {
                const op = document.createElement('option');
                op.value = n;
                dl.appendChild(op);
            });
        }

        // --- UPDATED KOSTEN LOGIK (LOHNANTEIL) ---

        function addKostenRow(data = {}) {
            const container = document.getElementById('kostenListe');
            const row = document.createElement('div');
            row.className = 'kosten-row';
            row.dataset.id = data.id || getNextFinanzId(); 

            // 1. Konto
            const inpKonto = document.createElement('input');
            inpKonto.placeholder = "Konto";
            inpKonto.className = "k-konto";
            inpKonto.value = data.konto || "";

            // 2. Text
            const inpText = document.createElement('input');
            inpText.placeholder = "Beschreibung";
            inpText.className = "k-text";
            inpText.value = data.text || "";

            // 3. Brutto
            const inpBrutto = document.createElement('input');
            inpBrutto.type = "number";
            inpBrutto.step = "0.01";
            inpBrutto.placeholder = "0,00";
            inpBrutto.className = "k-brutto";
            inpBrutto.value = data.brutto || "";
            inpBrutto.oninput = () => calculateRow(row);

            // 4. Steuerschl√ºssel (Vorsteuer)
            const taxWrapper = document.createElement('div');
            taxWrapper.style = "display:flex; align-items:center;";
            const selSteuer = document.createElement('select');
            selSteuer.className = "k-tax kosten-tax";
            selSteuer.style = "flex:1; min-width:0;";
            selSteuer.add(new Option("-", ""));
            taxKeys.forEach(t => selSteuer.add(new Option(t.label, t.id)));
            if(data.steuerKey) selSteuer.value = data.steuerKey;
            selSteuer.onchange = () => calculateRow(row);
            const btnTax = document.createElement('button');
            btnTax.innerText = "‚öôÔ∏è";
            btnTax.className = "finance-btn";
            btnTax.style.padding = "2px 4px";
            btnTax.style.marginLeft = "2px";
            btnTax.onclick = () => openTaxModal();
            taxWrapper.append(selSteuer, btnTax);

            // 5. Netto (Readonly)
            const outNetto = document.createElement('input');
            outNetto.readOnly = true;
            outNetto.className = "k-netto";
            outNetto.style.background = "#f0f0f0";
            outNetto.value = data.netto ? formatNum(data.netto) : "";

            // 6. Steuerbetrag (Readonly)
            const outTaxAmt = document.createElement('input');
            outTaxAmt.readOnly = true;
            outTaxAmt.className = "k-tax-amt";
            outTaxAmt.style.background = "#f0f0f0";
            outTaxAmt.value = data.steuerBetrag ? formatNum(data.steuerBetrag) : "";

            // 7. Verteilschl√ºssel
            const verteilWrapper = document.createElement('div');
            verteilWrapper.style = "display:flex; align-items:center;";
            const selVerteil = document.createElement('select');
            selVerteil.className = "k-verteil";
            selVerteil.style = "flex:1; min-width:0;";
            verteilKeys.forEach(v => selVerteil.add(new Option(v.label, v.id)));
            if(data.verteilKey) selVerteil.value = data.verteilKey;
            const btnVerteil = document.createElement('button');
            btnVerteil.innerText = "‚öôÔ∏è";
            btnVerteil.className = "finance-btn";
            btnVerteil.style.padding = "2px 4px";
            btnVerteil.style.marginLeft = "2px";
            btnVerteil.onclick = () => openVerteilModal();
            verteilWrapper.append(selVerteil, btnVerteil);

            // 8. Lohnanteil (NEU)
            const inpLohn = document.createElement('input');
            inpLohn.type = "number";
            inpLohn.step = "0.01";
            inpLohn.placeholder = "Lohn";
            inpLohn.className = "k-lohn";
            inpLohn.value = data.lohn || "";

            // Delete Btn
            const btnDel = document.createElement('button');
            btnDel.innerText = "X";
            btnDel.className = "warn-btn";
            btnDel.style.padding = "2px 5px";
            btnDel.onclick = () => { row.remove(); updateKostenSums(); };

            row.append(inpKonto, inpText, inpBrutto, taxWrapper, outNetto, outTaxAmt, verteilWrapper, inpLohn, btnDel);
            container.appendChild(row);
        }

        // --- SPLIT BUCHUNG MIT LOHNANTEIL ---
        function addSplitRow(initialAmount = null) {
            const container = document.getElementById('splitRowsContainer');
            const rest = calcSplitRest();
            const startVal = initialAmount !== null ? initialAmount : (rest > 0 ? rest : "");

            const div = document.createElement('div');
            div.className = 'split-row';
            
            // Amount
            const inpAmt = document.createElement('input');
            inpAmt.type = "number"; inpAmt.step = "0.01"; inpAmt.placeholder = "Betrag"; 
            inpAmt.className = "split-amount";
            if(startVal) inpAmt.value = startVal;
            inpAmt.oninput = calcSplitRest;

            // Text
            const inpText = document.createElement('input');
            inpText.type = "text"; inpText.placeholder = "Beschreibung";
            inpText.className = "split-text";

            // Konto
            const inpKonto = document.createElement('input');
            inpKonto.type = "text"; inpKonto.placeholder = "Konto";
            inpKonto.className = "split-konto";

            // Tax
            const selTax = document.createElement('select');
            selTax.className = "split-tax";
            selTax.add(new Option("-", ""));
            taxKeys.forEach(t => selTax.add(new Option(t.label, t.id)));

            // Verteilung
            const selVerteil = document.createElement('select');
            selVerteil.className = "split-verteil";
            verteilKeys.forEach(v => selVerteil.add(new Option(v.label, v.id)));

            // Lohnanteil (NEU)
            const inpLohn = document.createElement('input');
            inpLohn.type = "number"; inpLohn.step = "0.01"; inpLohn.placeholder = "Lohn ‚Ç¨";
            inpLohn.className = "split-lohn";

            // Del Button
            const btnDel = document.createElement('button');
            btnDel.innerText = "X";
            btnDel.className = "warn-btn";
            btnDel.style.padding = "2px 5px";
            btnDel.onclick = () => { div.remove(); calcSplitRest(); };

            div.append(inpAmt, inpText, inpKonto, selTax, selVerteil, inpLohn, btnDel);
            container.appendChild(div);
            
            calcSplitRest();
        }

        function applySplitBuchung() {
            document.querySelectorAll('#splitRowsContainer .split-row').forEach(row => {
                const amt = safeFloat(row.querySelector('.split-amount').value);
                if(amt > 0) {
                    const data = {
                        konto: row.querySelector('.split-konto').value,
                        text: row.querySelector('.split-text').value,
                        brutto: amt,
                        steuerKey: row.querySelector('.split-tax').value,
                        verteilKey: row.querySelector('.split-verteil').value,
                        lohn: safeFloat(row.querySelector('.split-lohn').value) // NEU
                    };
                    addKostenRow(data);
                }
            });
            document.getElementById('splitModal').classList.remove('active');
            updateKostenSums();
        }

        function saveKostenErfassung() {
            const abrId = document.getElementById('currentAbrechnungId').value;
            if(!abrId) return;

            dbKosten = dbKosten.filter(k => k.abrechnungId !== abrId);

            document.querySelectorAll('.kosten-row').forEach(row => {
                const brutto = safeFloat(row.querySelector('.k-brutto').value);
                const text = row.querySelector('.k-text').value;
                
                if(brutto || text) {
                    const tId = row.querySelector('.k-tax').value;
                    let rate = 0;
                    if(tId) { const k = taxKeys.find(t=>t.id===tId); if(k) rate = k.rate; }
                    
                    const netto = brutto / (1 + rate/100);
                    const taxAmt = brutto - netto;

                    dbKosten.push({
                        id: row.dataset.id,
                        abrechnungId: abrId,
                        konto: row.querySelector('.k-konto').value,
                        text: text,
                        brutto: brutto,
                        steuerKey: tId,
                        netto: netto,
                        steuerBetrag: taxAmt,
                        verteilKey: row.querySelector('.k-verteil').value,
                        lohn: safeFloat(row.querySelector('.k-lohn').value) // NEU
                    });
                }
            });

            saveLocal();
            triggerAutoSave();
            alert("Kosten gespeichert!");
        }

        // --- CRUD MASKEN (Mit Schutz f√ºr Verbrauchsdaten) ---
        function openObjektMask(id){ const o=id?dbObjekte.get(id):{}; document.getElementById('objektIdInput').value=id||""; document.getElementById('objektNummerInput').value=id || getNextObjektID(); document.getElementById('objektNameInput').value=o.name||""; document.getElementById('objektPlzInput').value=o.plz||""; document.getElementById('objektOrtInput').value=o.ort||""; document.getElementById('objektFlaecheInput').value=o.flaeche||""; document.getElementById('objektMeaInput').value=o.mea||"1000"; document.getElementById('objektSollHaeuser').value=o.sollHaeuser||"1"; document.getElementById('objektSteuerStatus').value = o.steuerStatus || 'opt'; updateObjektLiveStatus(); document.getElementById('objektModal').classList.add('active'); }
        
        function saveObjekt(){ 
            let id=document.getElementById('objektNummerInput').value; 
            if(!id) id=getNextObjektID(); 
            dbObjekte.set(String(id), { 
                nummer: id, 
                name: document.getElementById('objektNameInput').value, 
                plz: document.getElementById('objektPlzInput').value, 
                ort: document.getElementById('objektOrtInput').value, 
                flaeche: safeFloat(document.getElementById('objektFlaecheInput').value), 
                mea: safeFloat(document.getElementById('objektMeaInput').value), 
                sollHaeuser: safeFloat(document.getElementById('objektSollHaeuser').value), 
                steuerStatus: document.getElementById('objektSteuerStatus').value 
            }); 
            document.getElementById('objektModal').classList.remove('active'); 
            saveLocal(); 
            renderLists(); 
            triggerAutoSave(); 
        }

        function deleteObjekt() { const oid = document.getElementById('objektIdInput').value; if (!oid) return; const associatedHouses = Array.from(dbHaeuser.values()).filter(h => h.objektId === oid); const associatedHouseIds = Array.from(dbHaeuser.entries()).filter(([hid, h]) => h.objektId === oid).map(([hid, h]) => hid); const associatedUnits = Array.from(dbEinheiten.values()).filter(e => associatedHouseIds.includes(e.hausId)); const msg = `ACHTUNG: Objekt ${oid} l√∂schen?\n${associatedHouses.length} H√§user\n${associatedUnits.length} Einheiten`; if (confirm(msg)) { const unitIdsToDelete = []; dbEinheiten.forEach((u, uid) => { if (associatedHouseIds.includes(u.hausId)) { unitIdsToDelete.push(uid); } }); unitIdsToDelete.forEach(uid => dbEinheiten.delete(uid)); associatedHouseIds.forEach(hid => dbHaeuser.delete(hid)); dbObjekte.delete(oid); document.getElementById('objektModal').classList.remove('active'); if(activeFilterId === oid) { activeFilterId = null; toggleFilter(null); } saveLocal(); renderLists(); triggerAutoSave(); } }
        
        function openHausMask(id){ 
            document.getElementById('hausIdInput').value=id||""; const sel=document.getElementById('hausObjektSelect'); sel.innerHTML=""; if(activeFilterId) { const o=dbObjekte.get(activeFilterId); if(o) sel.add(new Option(o.name,activeFilterId)); } else { dbObjekte.forEach((o,oid)=>sel.add(new Option(o.name,oid))); } const h=id?dbHaeuser.get(id):{}; if(h.objektId) sel.value=h.objektId; if(!id && sel.value) document.getElementById('hausNummerDisplay').value = getNextHausID(sel.value); else document.getElementById('hausNummerDisplay').value = id; document.getElementById('hausBezeichnungInput').value=h.bezeichnung||""; document.getElementById('hausAnteileInput').value=h.anteile||""; renderHausMatrix(h); calcMatrixSum(); 
            const obj = dbObjekte.get(sel.value);
            const box = document.getElementById('hausSteuerBox');
            if(obj && obj.steuerStatus === 'mixed') {
                box.style.display = 'block';
                document.getElementById('hausSteuerStatus').value = h.steuerStatus || 'opt';
            } else {
                box.style.display = 'none';
            }
            document.getElementById('hausModal').classList.add('active'); 
        }
        function saveHaus(){ let id=document.getElementById('hausNummerDisplay').value; if(!id) { const oid=document.getElementById('hausObjektSelect').value; id=getNextHausID(oid); } let mx={}; document.querySelectorAll('#hausSollMatrixBody tr').forEach(tr => { const tid = tr.dataset.typeId; const lblInput = tr.querySelector('.custom-label-inp'); const lbl = lblInput ? lblInput.value : tr.cells[0].innerText; const cnt = tr.querySelector('.soll-count').value; const area = tr.querySelector('.soll-area').value; if(cnt || area) { mx[tid] = { count: cnt, area: area, label: lbl }; } }); 
            const stStat = document.getElementById('hausSteuerBox').style.display !== 'none' ? document.getElementById('hausSteuerStatus').value : null;
            dbHaeuser.set(String(id), { objektId: document.getElementById('hausObjektSelect').value, bezeichnung: document.getElementById('hausBezeichnungInput').value, anteile: safeFloat(document.getElementById('hausAnteileInput').value), sollMatrix: mx, steuerStatus: stStat }); document.getElementById('hausModal').classList.remove('active'); saveLocal(); renderLists(); triggerAutoSave(); }
        function deleteHaus() { const hid = document.getElementById('hausIdInput').value; if(!hid) return; const associatedUnits = Array.from(dbEinheiten.values()).filter(e => e.hausId === hid); const msg = `Haus l√∂schen? ${associatedUnits.length} Einheiten!`; if(confirm(msg)) { const unitIdsToDelete = []; dbEinheiten.forEach((u, uid) => { if (u.hausId === hid) unitIdsToDelete.push(uid); }); unitIdsToDelete.forEach(uid => dbEinheiten.delete(uid)); dbHaeuser.delete(hid); document.getElementById('hausModal').classList.remove('active'); saveLocal(); renderLists(); triggerAutoSave(); } }
        
        function openEinheitMask(id){ 
            updateKonditionDatalist(); 
            const e=id?dbEinheiten.get(id):{}; document.getElementById('einheitIdInput').value=id||""; const oSel=document.getElementById('einheitObjektSelect'); const hSel=document.getElementById('einheitHausSelect'); oSel.innerHTML=""; if(activeFilterId) { const o=dbObjekte.get(activeFilterId); if(o) oSel.add(new Option(o.name, activeFilterId)); } else { oSel.innerHTML = "<option value=''>-- Objekt w√§hlen --</option>"; dbObjekte.forEach((o,oid)=>oSel.add(new Option(o.name,oid))); }
            let oid, hid; if(id) { hid = e.hausId; oid = hid ? dbHaeuser.get(hid)?.objektId : ""; } else { if(activeFilterId) { oid = activeFilterId; } else if(oSel.options.length > 0 && !oSel.value) { } hid = ""; } if(oid) oSel.value=oid; filterHaeuserDropdown(); if(hid) hSel.value=hid; else if(hSel.options.length>0) hSel.selectedIndex=0; if(id) document.getElementById('einheitNummerDisplay').value = id; else if(hSel.value) document.getElementById('einheitNummerDisplay').value = getNextEinheitID(hSel.value); document.getElementById('einheitNameInput').value=e.name||""; document.getElementById('einheitTypSelect').innerHTML=""; STANDARD_TYPES.forEach(t=>document.getElementById('einheitTypSelect').add(new Option(t.label,t.id))); document.getElementById('einheitFlaecheInput').value=e.flaeche||""; document.getElementById('einheitHeizflaecheInput').value=e.heizflaeche||""; document.getElementById('einheitZimmerInput').value=e.zimmer||""; document.getElementById('einheitMeaInput').value=e.mea||""; document.getElementById('einheitWwInput').value = e.ww_m3 || ""; document.getElementById('einheitKwInput').value = e.kw_m3 || ""; const c=document.getElementById('belegungListe'); c.innerHTML=""; if(e.belegung&&e.belegung.length) e.belegung.forEach(b=>addBelegungRow(b)); else addBelegungRow(); const hList = document.getElementById('historieListe'); hList.innerHTML=""; if(e.historie && e.historie.length) e.historie.forEach(h=>addHistorieRow(h)); 
            
            let showTax = false;
            if(hSel.value) {
                const h = dbHaeuser.get(hSel.value);
                const o = h ? dbObjekte.get(h.objektId) : null;
                if(o) {
                    if(o.steuerStatus === 'opt') { showTax = true; } else if(o.steuerStatus === 'mixed') { if(h && h.steuerStatus === 'opt') showTax = true; if(h && h.steuerStatus === 'mixed') showTax = true; }
                }
            }
            
            const kList = document.getElementById('konditionenListe'); kList.innerHTML=""; 
            if(e.konditionen && e.konditionen.length) e.konditionen.forEach(k=>addKonditionRow(k, showTax)); 
            else addKonditionRow({}, showTax); 
            
            onHausSelectionChange(!id); if(e.typ) document.getElementById('einheitTypSelect').value = e.typ; document.getElementById('einheitModal').classList.add('active'); 
        }

        function addKonditionRow(d={}, showTax=false) { 
            const c = document.getElementById('konditionenListe'); 
            const row = document.createElement('div'); row.className = 'kondition-row'; 
            const descInput = document.createElement('input'); descInput.setAttribute('list', 'konditionTypes'); descInput.placeholder = "Bez..."; descInput.className="kond-label"; if(d.label) descInput.value = d.label; 
            const betragInput = document.createElement('input'); betragInput.type="number"; betragInput.step="0.01"; betragInput.placeholder="‚Ç¨"; betragInput.className="kond-betrag"; if(d.betrag) betragInput.value = d.betrag; 
            const kontoInput = document.createElement('input'); kontoInput.type="text"; kontoInput.placeholder="Konto"; kontoInput.className="kond-konto"; if(d.konto) kontoInput.value = d.konto; 
            const dateInput = document.createElement('input'); dateInput.type="date"; dateInput.className="kond-date"; if(d.gueltigAb) dateInput.value = d.gueltigAb; else dateInput.value = new Date().toISOString().split('T')[0]; 
            const dateBisInput = document.createElement('input'); dateBisInput.type="date"; dateBisInput.className="kond-date-bis"; if(d.gueltigBis) dateBisInput.value = d.gueltigBis;
            
            let taxSelect; let taxBtn = null;
            if(showTax) {
                const s = document.createElement('select'); s.className="kond-tax"; s.add(new Option("-", ""));
                taxKeys.forEach(t => s.add(new Option(t.label, t.id))); 
                if(d.steuerKey) s.value = d.steuerKey;
                taxSelect = s;
                taxBtn = document.createElement('button'); taxBtn.innerText = "‚öôÔ∏è"; taxBtn.className = "finance-btn"; taxBtn.style.padding = "2px 5px"; taxBtn.title = "Steuerschl√ºssel verwalten"; taxBtn.onclick = () => openTaxModal();
            } else { taxSelect = document.createElement('span'); }

            const copyBtn = document.createElement('button'); copyBtn.innerText="+"; copyBtn.className="primary-btn"; copyBtn.style.padding="2px 5px"; 
            copyBtn.onclick = () => {
                const newData = { label: descInput.value, betrag: betragInput.value, konto: kontoInput.value, steuerKey: showTax && taxSelect.value ? taxSelect.value : "" };
                addKonditionRow(newData, showTax);
                c.insertBefore(c.lastChild, row.nextSibling);
            };
            const delBtn = document.createElement('button'); delBtn.innerText="X"; delBtn.className="warn-btn"; delBtn.style.padding="2px 5px"; delBtn.onclick = () => row.remove(); 
            row.append(descInput, betragInput, kontoInput, dateInput, dateBisInput, taxSelect); if(taxBtn) row.appendChild(taxBtn); row.append(copyBtn, delBtn); c.appendChild(row); 
        }

        function saveEinheit(){ 
            let id=document.getElementById('einheitNummerDisplay').value; if(!id) { const hid=document.getElementById('einheitHausSelect').value; id=getNextEinheitID(hid); } 
            
            // PRESERVE EXISTING DATA (especially Verbrauchsdaten!)
            const existing = dbEinheiten.get(String(id)) || {};
            const verbrauchsdaten = existing.verbrauchsdaten || { personen:[], zaehler:[], direkt:[] };

            const bel=[]; document.querySelectorAll('#belegungListe .belegung-wrapper').forEach(w=>{ const m=w.querySelector('.belegung-mieter').value; if(m) bel.push({mieterId:m, einzug:w.querySelector('.belegung-einzug').value, auszug:w.querySelector('.belegung-auszug').value}); }); 
            const hist=[]; document.querySelectorAll('#historieListe .historie-row').forEach(r=>{ const d = r.querySelector('.hist-date').value; const t = r.querySelector('.hist-desc').value; if(d || t) hist.push({date:d, text:t}); }); 
            const kond=[]; document.querySelectorAll('#konditionenListe .kondition-row').forEach(r=>{ const l = r.querySelector('.kond-label').value; const b = safeFloat(r.querySelector('.kond-betrag').value); const k = r.querySelector('.kond-konto').value; const d = r.querySelector('.kond-date').value; const dbis = r.querySelector('.kond-date-bis').value; const st = r.querySelector('.kond-tax') ? r.querySelector('.kond-tax').value : ""; if(l && b) kond.push({ label:l, betrag:b, konto:k, gueltigAb:d, gueltigBis:dbis, steuerKey: st }); }); 
            
            dbEinheiten.set(String(id), { 
                hausId: document.getElementById('einheitHausSelect').value, 
                name: document.getElementById('einheitNameInput').value, 
                typ: document.getElementById('einheitTypSelect').value, 
                flaeche: safeFloat(document.getElementById('einheitFlaecheInput').value), 
                heizflaeche: safeFloat(document.getElementById('einheitHeizflaecheInput').value), 
                zimmer: document.getElementById('einheitZimmerInput').value, 
                mea: safeFloat(document.getElementById('einheitMeaInput').value), 
                ww_m3: safeFloat(document.getElementById('einheitWwInput').value), 
                kw_m3: safeFloat(document.getElementById('einheitKwInput').value), 
                konditionen: kond, 
                belegung: bel, 
                historie: hist,
                verbrauchsdaten: verbrauchsdaten // Important: Keep existing data
            }); 
            document.getElementById('einheitModal').classList.remove('active'); saveLocal(); renderLists(); triggerAutoSave(); 
        }

        function addBelegungRow(d={}) { 
            const c = document.getElementById('belegungListe'); 
            const wrapper = document.createElement('div'); 
            wrapper.className = 'belegung-wrapper'; 
            const r = document.createElement('div'); 
            r.className = 'belegung-row'; 
            const s = document.createElement('select'); 
            s.className = 'belegung-mieter'; 
            s.innerHTML = "<option value=''>-- Mieter --</option>"; 
            Array.from(dbKontakte.entries()).sort((a,b) => (a[1].fn||"").localeCompare(b[1].fn||"")).forEach(([id,k]) => s.add(new Option(k.fn+(k.org?` (${k.org})`:""), id))); 
            if(d.mieterId) s.value = d.mieterId; 
            const inEin = document.createElement('input'); 
            inEin.type = "date"; 
            inEin.className = "belegung-einzug"; 
            if(d.einzug) inEin.value = d.einzug; 
            const inAus = document.createElement('input'); 
            inAus.type = "date"; 
            inAus.className = "belegung-auszug"; 
            if(d.auszug) inAus.value = d.auszug; 
            const b = document.createElement('button'); 
            b.className = "warn-btn"; 
            b.innerText = "X"; 
            b.onclick = () => { 
                const currentEid = document.getElementById('einheitIdInput').value; 
                const mieterVal = s.value; 
                if(currentEid && mieterVal) { 
                    const hasTx = dbFinanzen.some(tx => tx.einheitId === currentEid && tx.mieterId === mieterVal); 
                    if(hasTx) { alert("Buchungen vorhanden! Bitte Auszugdatum setzen."); return; } 
                } 
                wrapper.remove(); 
            }; 
            r.append(s, inEin, inAus, b); 
            wrapper.appendChild(r); 
            c.appendChild(wrapper); 
        }

        function addHistorieRow(d={}) { 
            const c = document.getElementById('historieListe'); 
            const r = document.createElement('div'); 
            r.className = 'historie-row'; 
            const inDate = document.createElement('input'); 
            inDate.type = "date"; 
            inDate.className = "hist-date"; 
            if(d.date) inDate.value = d.date; 
            const inText = document.createElement('input'); 
            inText.type = "text"; 
            inText.className = "hist-desc"; 
            if(d.text) inText.value = d.text; 
            const b = document.createElement('button'); 
            b.className = "warn-btn"; 
            b.innerText = "X"; 
            b.onclick = () => r.remove(); 
            r.append(inDate, inText, b); 
            c.appendChild(r); 
        }

        // --- RESTORED SOLLSTELLUNG LOGIC ---
        function runSollstellung() { 
            const monatStr = document.getElementById('sollMonatInput').value; if(!monatStr) return alert("Monat?"); 
            const [jahr, monat] = monatStr.split('-').map(Number); const daysInMonth = new Date(jahr, monat, 0).getDate(); const monthStart = new Date(jahr, monat - 1, 1); const monthEnd = new Date(jahr, monat - 1, daysInMonth); 
            logSoll(`Lauf: ${monat}/${jahr}`); let count = 0;
            
            dbEinheiten.forEach((e, eid) => { 
                if(!e.belegung || !e.belegung.length) return; 
                e.belegung.forEach(b => { 
                    const einzug = new Date(b.einzug); const auszug = b.auszug ? new Date(b.auszug) : new Date('2099-12-31'); 
                    if(einzug <= monthEnd && auszug >= monthStart) { 
                        const start = einzug > monthStart ? einzug : monthStart; const end = auszug < monthEnd ? auszug : monthEnd; 
                        const activeDays = Math.ceil(Math.abs(end - start) / (1000 * 60 * 60 * 24)) + 1; 
                        if(activeDays > 0) { 
                            const faktor = activeDays / daysInMonth; 
                            const sortedBel = [...e.belegung].sort((a,b) => (a.einzug||'').localeCompare(b.einzug||'')); 
                            const seqIndex = sortedBel.indexOf(b) + 1; const contractId = e.id + "/" + pad(seqIndex, 2); const opCode = `${contractId}-${pad(monat, 2)}${jahr}`; 
                            
                            if(e.konditionen) e.konditionen.forEach(k => { 
                                const gueltigAb = new Date(k.gueltigAb); let gueltigBis = k.gueltigBis ? new Date(k.gueltigBis) : new Date('2099-12-31'); 
                                if(gueltigAb <= monthEnd && gueltigBis >= monthStart) { 
                                    const betrag = safeFloat(k.betrag) * faktor; 
                                    let stBetrag = 0;
                                    if(k.steuerKey) {
                                        const sObj = taxKeys.find(t=>t.id===k.steuerKey);
                                        if(sObj && sObj.rate > 0) stBetrag = betrag - (betrag / (1 + sObj.rate/100));
                                    }

                                    const tx = { id: getNextFinanzId(), einheitId: eid, mieterId: b.mieterId, monatRef: monatStr, buchungsdatum: new Date().toISOString().split('T')[0], typ: 'soll', kategorie: k.label, text: `${opCode} (${k.label})`, betrag: betrag, konto: k.konto, steuerschluessel: k.steuerKey || "", steuerbetrag: stBetrag, locked: true }; 
                                    dbFinanzen.push(tx); count++; 
                                } 
                            }); 
                        } 
                    } 
                }); 
            }); 
            logSoll(`Fertig: ${count} Buchungen.`); saveLocal(); triggerAutoSave(); 
        }

        function logSoll(msg) {
            const l = document.getElementById('sollLog');
            l.style.display = 'block';
            l.innerHTML += `<div>${msg}</div>`;
            l.scrollTop = l.scrollHeight;
        }

        function openSollstellungModal() {
            document.getElementById('sollLog').innerHTML = "";
            document.getElementById('sollstellungModal').classList.add('active');
        }

        // --- ACCOUNTING & OTHER HELPERS ---
        function renderKontoTable() { 
            const eid = document.getElementById('kontoEinheitId').value; const yearFilter = document.getElementById('kontoJahrSelect').value; const tbody = document.getElementById('kontoBody'); tbody.innerHTML = ""; 
            let txs = dbFinanzen.filter(tx => tx.einheitId === eid); if(yearFilter !== 'all') txs = txs.filter(tx => tx.buchungsdatum.startsWith(yearFilter)); txs.sort((a,b) => a.buchungsdatum.localeCompare(b.buchungsdatum)); 
            let sumS = 0, sumH = 0, saldo = 0; 
            txs.forEach(tx => { 
                const s = tx.typ === 'soll' ? safeFloat(tx.betrag) : 0; const h = tx.typ === 'haben' ? safeFloat(tx.betrag) : 0; sumS += s; sumH += h; saldo += (s - h); 
                const steuerInfo = tx.steuerschluessel ? `<span class="badge" style="background:#e3f2fd;">${tx.steuerschluessel}</span>` : '-'; 
                let delBtn = `<button class="warn-btn" style="padding:2px 5px;" onclick="event.stopPropagation(); deleteBuchung('${tx.id}')">x</button>`; if(tx.locked) delBtn = `üîí`; 
                const korrBadge = (tx.history && tx.history.length > 0) ? `<span style="color:#d32f2f; font-weight:bold; font-size:0.8em; margin-right:5px;">(Korr. ${tx.history.length})</span>` : "";
                
                const tr = document.createElement('tr'); tr.onclick = () => openBuchungDetail(tx.id);
                tr.innerHTML = `<td>${korrBadge}</td><td>${formatDate(tx.buchungsdatum)}</td><td>${tx.text}</td><td>${tx.konto || '-'}</td><td style="text-align:center;">${steuerInfo}</td><td class="text-right betrag-soll">${s > 0 ? formatNum(s) : ''}</td><td class="text-right betrag-haben">${h > 0 ? formatNum(h) : ''}</td><td class="text-right" style="font-weight:bold;">${formatNum(saldo)}</td><td>${delBtn}</td>`; tbody.appendChild(tr); 
            }); 
            document.getElementById('sumSoll').innerText = formatCurrency(sumS); document.getElementById('sumHaben').innerText = formatCurrency(sumH); document.getElementById('sumSaldo').innerText = formatCurrency(saldo); 
        }

        function deleteBuchung(id) { const tx = dbFinanzen.find(t => t.id === id); if(tx && tx.locked) { alert("Sollstellung gesperrt!"); return; } if(!confirm("L√∂schen?")) return; dbFinanzen = dbFinanzen.filter(tx => tx.id !== id); saveLocal(); triggerAutoSave(); renderKontoTable(); }
        function resetKonto() { if(!confirm("Konto leeren?")) return; const eid = document.getElementById('kontoEinheitId').value; dbFinanzen = dbFinanzen.filter(tx => tx.einheitId !== eid); saveLocal(); triggerAutoSave(); renderKontoTable(); }

        function openKontoModal(einheitId) { 
            const e = dbEinheiten.get(einheitId); 
            if(!e) return; 
            document.getElementById('kontoEinheitId').value = einheitId; 
            document.getElementById('kontoTitle').innerText = `Konto: ${e.name}`; 
            document.getElementById('manuelleBuchungForm').style.display = 'none'; 
            
            const txs = dbFinanzen.filter(tx => tx.einheitId === einheitId);
            const years = new Set();
            txs.forEach(tx => { if(tx.buchungsdatum) years.add(tx.buchungsdatum.substring(0,4));
            });
            
            const ySel = document.getElementById('kontoJahrSelect');
            const oldY = ySel.value;
            ySel.innerHTML = "<option value='all'>Alle Jahre</option>";
            Array.from(years).sort().reverse().forEach(y => ySel.add(new Option(y, y)));
            if(oldY && (oldY === 'all' || years.has(oldY))) ySel.value = oldY;
            
            renderKontoTable();
            document.getElementById('kontoModal').classList.add('active');
        }

        // --- MANUELLE BUCHUNG ---
        function openManuelleBuchung() {
            document.getElementById('mbDatum').value = new Date().toISOString().split('T')[0];
            document.getElementById('manuelleBuchungForm').style.display = 'block';
        }

        function saveManuelleBuchung() {
            const eid = document.getElementById('kontoEinheitId').value;
            const dat = document.getElementById('mbDatum').value;
            const typ = document.getElementById('mbTyp').value;
            const bet = safeFloat(document.getElementById('mbBetrag').value);
            const txt = document.getElementById('mbText').value;
            const kto = document.getElementById('mbKonto').value;
            const bel = document.getElementById('mbBeleg').value;
            const steuer = document.getElementById('mbSteuer').value; // NEU: Steuerschl√ºssel
            
            if(!dat || !bet || !txt) { alert("Bitte Datum, Betrag und Text angeben."); return; }
            
            // Steuer berechnen f√ºr Historie
            let stBetrag = 0;
            if(steuer) {
                const sObj = taxKeys.find(t => t.id === steuer);
                if(sObj && sObj.rate > 0) {
                    stBetrag = bet - (bet / (1 + sObj.rate/100));
                }
            }

            const tx = {
                id: getNextFinanzId(),
                einheitId: eid,
                buchungsdatum: dat,
                typ: typ,
                text: txt + (bel ? ` (Beleg: ${bel})` : ""),
                betrag: bet,
                konto: kto,
                steuerschluessel: steuer,
                steuerbetrag: stBetrag,
                locked: false,
                history: []
            };
            
            dbFinanzen.push(tx);
            saveLocal();
            triggerAutoSave();
            
            document.getElementById('mbBetrag').value = "";
            document.getElementById('mbText').value = "";
            document.getElementById('mbBeleg').value = "";
            document.getElementById('manuelleBuchungForm').style.display = 'none';
            renderKontoTable();
        }

        // --- BUCHUNGS DETAIL & EDIT ---
        function openBuchungDetail(id) {
            const tx = dbFinanzen.find(t => t.id === id);
            if(!tx) return;
            
            document.getElementById('detailBuchungId').value = id;
            document.getElementById('detailId').innerText = tx.id;
            document.getElementById('detailKorrNr').innerText = (tx.history ? tx.history.length : 0);
            
            document.getElementById('detailDatumInp').value = tx.buchungsdatum;
            document.getElementById('detailBetragInp').value = tx.betrag;
            document.getElementById('detailTextInp').value = tx.text;
            document.getElementById('detailKontoInp').value = tx.konto || "";
            
            // Steuer Select f√ºllen
            const sSel = document.getElementById('detailSteuerInp');
            sSel.innerHTML = '<option value="">-</option>';
            taxKeys.forEach(t => sSel.add(new Option(t.label, t.id)));
            sSel.value = tx.steuerschluessel || "";

            document.getElementById('detailDoku').value = ""; // Reset Note
            
            // Logic: Wenn Locked, inputs readonly? 
            // Hier erlauben wir Korrekturen, aber loggen sie.
            if(tx.locked) {
                document.getElementById('detailDatumInp').disabled = true; 
                // Datum bei Systembuchungen oft fix, aber Betrag/Konto korrigierbar
            } else {
                document.getElementById('detailDatumInp').disabled = false;
            }

            document.getElementById('buchungDetailModal').classList.add('active');
        }

        function saveBuchungChanges() {
            const id = document.getElementById('detailBuchungId').value;
            const tx = dbFinanzen.find(t => t.id === id);
            if(!tx) return;

            const newDat = document.getElementById('detailDatumInp').value;
            const newBet = safeFloat(document.getElementById('detailBetragInp').value);
            const newTxt = document.getElementById('detailTextInp').value;
            const newKto = document.getElementById('detailKontoInp').value;
            const newSteuer = document.getElementById('detailSteuerInp').value;
            const note = document.getElementById('detailDoku').value;

            if(!note) { alert("Bitte eine Begr√ºndung/Notiz f√ºr die √Ñnderung eingeben."); return; }

            // Backup old state
            if(!tx.history) tx.history = [];
            tx.history.push({
                date: new Date().toISOString(),
                oldData: { ...tx, history: null }, // shallow copy without history recursion
                note: note,
                user: document.getElementById('loggedInUser').innerText
            });

            // Update
            tx.buchungsdatum = newDat;
            tx.betrag = newBet;
            tx.text = newTxt;
            tx.konto = newKto;
            tx.steuerschluessel = newSteuer;
            
            // Recalc Steuerbetrag if needed
            if(newSteuer) {
                const sObj = taxKeys.find(t => t.id === newSteuer);
                if(sObj && sObj.rate > 0) {
                    tx.steuerbetrag = newBet - (newBet / (1 + sObj.rate/100));
                } else {
                    tx.steuerbetrag = 0;
                }
            } else {
                tx.steuerbetrag = 0;
            }

            saveLocal();
            triggerAutoSave();
            document.getElementById('buchungDetailModal').classList.remove('active');
            renderKontoTable();
        }

        // --- SPLIT & KOSTEN LOGIK (Missing Functions) ---

        function openSplitModal() {
            document.getElementById('splitRowsContainer').innerHTML = "";
            document.getElementById('splitTotalInput').value = "";
            document.getElementById('splitSummeErfasst').innerText = "0,00 ‚Ç¨";
            document.getElementById('splitSummeRest').innerText = "0,00 ‚Ç¨";
            document.getElementById('btnApplySplit').disabled = true;
            
            // Initiale Zeile
            addSplitRow();
            
            document.getElementById('splitModal').classList.add('active');
        }

        function calcSplitRest() {
            const total = safeFloat(document.getElementById('splitTotalInput').value);
            let sum = 0;
            document.querySelectorAll('#splitRowsContainer .split-amount').forEach(inp => {
                sum += safeFloat(inp.value);
            });
            
            const rest = total - sum;
            document.getElementById('splitSummeErfasst').innerText = formatCurrency(sum);
            
            const restSpan = document.getElementById('splitSummeRest');
            restSpan.innerText = formatCurrency(rest);
            
            if(Math.abs(rest) < 0.01 && total > 0) {
                restSpan.style.color = "green";
                document.getElementById('btnApplySplit').disabled = false;
            } else {
                restSpan.style.color = "red";
                document.getElementById('btnApplySplit').disabled = true;
            }
            return rest;
        }

        function updateKostenSums() {
            let sumNetto = 0;
            let sumSteuer = 0;
            let sumBrutto = 0;

            // Wir lesen die Werte direkt aus dem DOM der Liste, da diese die aktuellsten Rechenwerte enthalten
            document.querySelectorAll('#kostenListe .kosten-row').forEach(row => {
                // Brutto ist Input
                const brutto = safeFloat(row.querySelector('.k-brutto').value);
                // Steuerbetrag ist Readonly Input
                const steuerAmt = safeFloat(row.querySelector('.k-tax-amt').value);
                // Netto ist Readonly Input
                const netto = safeFloat(row.querySelector('.k-netto').value);

                sumBrutto += brutto;
                sumSteuer += steuerAmt;
                sumNetto += netto;
            });

            document.getElementById('sumKostenNetto').innerText = formatCurrency(sumNetto);
            document.getElementById('sumKostenSteuer').innerText = formatCurrency(sumSteuer);
            document.getElementById('sumKostenBrutto').innerText = formatCurrency(sumBrutto);
        }

        function calculateRow(row) {
            const brutto = safeFloat(row.querySelector('.k-brutto').value);
            const tId = row.querySelector('.k-tax').value;
            let rate = 0;
            if(tId) { 
                const k = taxKeys.find(t=>t.id===tId); 
                if(k) rate = k.rate; 
            }
            
            const netto = brutto / (1 + rate/100);
            const taxAmt = brutto - netto;

            row.querySelector('.k-netto').value = formatNum(netto);
            row.querySelector('.k-tax-amt').value = formatNum(taxAmt);

            updateKostenSums();
        }


        // --- ABRECHNUNGS VERWALTUNG (CRUD) ---
        function renderAbrechnungsListe() {
            const oid = document.getElementById('kostenObjektSelect').value;
            const list = document.getElementById('abrechnungenListe');
            const editor = document.getElementById('kostenEditor');
            const placeholder = document.getElementById('kostenPlaceholder');
            
            list.innerHTML = "";
            editor.style.display = "none";
            placeholder.style.display = "block";
            document.getElementById('currentAbrechnungId').value = "";

            if(!oid) return;

            const abrs = dbAbrechnungen.filter(a => a.objektId === oid);
            // Sort by Date DESC
            abrs.sort((a,b) => b.von.localeCompare(a.von));

            abrs.forEach(a => {
                const div = document.createElement('div');
                div.style.padding = "8px";
                div.style.borderBottom = "1px solid #eee";
                div.style.cursor = "pointer";
                div.style.background = "#fff";
                div.innerHTML = `
                    <div style="font-weight:bold;">${a.name}</div>
                    <div style="font-size:0.8em; color:#666;">${formatDate(a.von)} - ${formatDate(a.bis)}</div>
                    <button class="warn-btn" style="font-size:0.7em; padding:1px 4px; margin-top:2px;" onclick="event.stopPropagation(); deleteAbrechnung('${a.id}')">L√∂schen</button>
                `;
                div.onclick = () => loadAbrechnung(a.id);
                list.appendChild(div);
            });
        }

        function openNeueAbrechnung() {
            const oid = document.getElementById('kostenObjektSelect').value;
            if(!oid) { alert("Bitte erst ein Objekt w√§hlen."); return; }
            document.getElementById('abrechnungModal').classList.add('active');
        }

        function createAbrechnung() {
            const oid = document.getElementById('kostenObjektSelect').value;
            const name = document.getElementById('newAbrName').value;
            const von = document.getElementById('newAbrVon').value;
            const bis = document.getElementById('newAbrBis').value;

            if(!name || !von || !bis) { alert("Bitte alle Felder f√ºllen"); return; }

            const newId = 'abr_' + Date.now();
            dbAbrechnungen.push({
                id: newId,
                objektId: oid,
                name: name,
                von: von,
                bis: bis,
                status: 'open'
            });

            saveLocal();
            document.getElementById('abrechnungModal').classList.remove('active');
            renderAbrechnungsListe();
            loadAbrechnung(newId); // Direkt √∂ffnen
        }

        function deleteAbrechnung(id) {
            if(!confirm("Abrechnungszeitraum und ALLE zugeh√∂rigen Kostenpositionen l√∂schen?")) return;
            dbAbrechnungen = dbAbrechnungen.filter(a => a.id !== id);
            dbKosten = dbKosten.filter(k => k.abrechnungId !== id);
            saveLocal();
            triggerAutoSave();
            renderAbrechnungsListe();
        }

        function loadAbrechnung(id) {
            const abr = dbAbrechnungen.find(a => a.id === id);
            if(!abr) return;

            document.getElementById('currentAbrechnungId').value = id;
            document.getElementById('editorTitle').innerText = abr.name;
            
            document.getElementById('kostenPlaceholder').style.display = "none";
            document.getElementById('kostenEditor').style.display = "block";

            // Highlight active item in list
            // (Simple implementation skipped for brevity)

            // Load Costs
            const kList = document.getElementById('kostenListe');
            kList.innerHTML = "";
            
            const kosten = dbKosten.filter(k => k.abrechnungId === id);
            kosten.forEach(k => addKostenRow(k));
            
            updateKostenSums();
        }


        // --- PDF REPORTS (jsPDF + autoTable) ---

        async function generateObjectReportPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(18);
            doc.text("Objekt-Status Bericht", 14, 20);
            doc.setFontSize(10);
            doc.text(`Erstellt am: ${new Date().toLocaleDateString()}`, 14, 28);
            
            const headers = [["Nr", "Objekt", "Ort", "H√§user", "Einheiten", "Steuer-Status"]];
            const rows = [];
            
            dbObjekte.forEach((o, id) => {
                const hCount = Array.from(dbHaeuser.values()).filter(h => h.objektId === id).length;
                // Count units recursively
                const hIds = Array.from(dbHaeuser.entries()).filter(([hid, h]) => h.objektId === id).map(x => x[0]);
                const uCount = Array.from(dbEinheiten.values()).filter(e => hIds.includes(e.hausId)).length;
                
                rows.push([
                    o.nummer, 
                    o.name, 
                    o.ort, 
                    hCount, 
                    uCount,
                    TAX_STATUS_MAP[o.steuerStatus||'opt'].label
                ]);
            });

            doc.autoTable({
                startY: 35,
                head: headers,
                body: rows,
            });
            
            doc.save("Objekt_Bericht.pdf");
        }

        async function generateHouseReportPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text("H√§user & Fl√§chen √úbersicht", 14, 20);
            
            const headers = [["Objekt", "Haus", "Typen", "Fl√§che (Ist)", "Status"]];
            const rows = [];
            
            dbHaeuser.forEach((h, hid) => {
                const o = dbObjekte.get(h.objektId);
                const einheiten = Array.from(dbEinheiten.values()).filter(e => e.hausId === hid);
                const totalArea = einheiten.reduce((s,e) => s + safeFloat(e.flaeche), 0);
                const types = [...new Set(einheiten.map(e => getTypeLabel(e.typ)))].join(", ");
                
                rows.push([
                    o ? o.name : '?',
                    h.bezeichnung,
                    types,
                    formatNum(totalArea) + " m¬≤",
                    (h.steuerStatus || 'opt').toUpperCase()
                ]);
            });

            doc.autoTable({ startY: 30, head: headers, body: rows });
            doc.save("Haus_Status.pdf");
        }

        async function generateUnitReportPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l'); // Landscape
            doc.text("Vermietungsliste / Einheiten", 14, 20);
            
            const headers = [["Objekt/Haus", "Einheit", "Mieter", "Seit", "Miete (Netto)", "BK", "Status"]];
            const rows = [];
            
            // Sortierung
            const sortedUnits = Array.from(dbEinheiten.values()).sort((a,b) => a.name.localeCompare(b.name));
            
            sortedUnits.forEach(e => {
                const h = dbHaeuser.get(e.hausId);
                const o = h ? dbObjekte.get(h.objektId) : null;
                const location = (o?o.name:'') + " / " + (h?h.bezeichnung:'');
                
                let mieterTxt = "Leerstand";
                let seitTxt = "-";
                let status = "Leer";
                
                // Check Active Belegung
                const now = new Date().toISOString().split('T')[0];
                const act = e.belegung ? e.belegung.find(b => (b.einzug||'0000') <= now && (b.auszug||'9999') >= now) : null;
                
                if(act) {
                    const m = dbKontakte.get(act.mieterId);
                    mieterTxt = m ? m.fn : "Unbekannt";
                    seitTxt = formatDate(act.einzug);
                    status = "Vermietet";
                }
                
                // Miete ermitteln (Kaltmiete)
                let km = 0; let bk = 0;
                if(e.konditionen) {
                    e.konditionen.forEach(k => {
                        // Pr√ºfen ob g√ºltig
                        if(k.gueltigAb <= now && (!k.gueltigBis || k.gueltigBis >= now)) {
                            if(k.label.includes("Kalt")) km += safeFloat(k.betrag);
                            if(k.label.includes("BK") || k.label.includes("Vorausz")) bk += safeFloat(k.betrag);
                        }
                    });
                }
                
                rows.push([
                    location,
                    e.name,
                    mieterTxt,
                    seitTxt,
                    formatNum(km) + " ‚Ç¨",
                    formatNum(bk) + " ‚Ç¨",
                    status
                ]);
            });

            doc.autoTable({ startY: 30, head: headers, body: rows });
            doc.save("Vermietungsliste.pdf");
        }

        async function exportKontoPDF() {
            const eid = document.getElementById('kontoEinheitId').value;
            const e = dbEinheiten.get(eid);
            if(!e) return;
            const h = dbHaeuser.get(e.hausId);
            const o = h ? dbObjekte.get(h.objektId) : null;

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(14);
            doc.text(`Mieterkonto Auszug`, 14, 20);
            doc.setFontSize(10);
            doc.text(`Objekt: ${o?o.name:''} | Einheit: ${e.name}`, 14, 28);
            doc.text(`Datum: ${new Date().toLocaleDateString()}`, 14, 34);
            
            const headers = [["Datum", "Vorgang", "Soll", "Haben", "Saldo"]];
            const rows = [];
            
            let txs = dbFinanzen.filter(tx => tx.einheitId === eid);
            // Optional: Filter beachten
            const yearFilter = document.getElementById('kontoJahrSelect').value;
            if(yearFilter !== 'all') txs = txs.filter(tx => tx.buchungsdatum.startsWith(yearFilter));
            
            txs.sort((a,b) => a.buchungsdatum.localeCompare(b.buchungsdatum));
            
            let saldo = 0;
            txs.forEach(tx => {
                const s = tx.typ === 'soll' ? safeFloat(tx.betrag) : 0;
                const hVal = tx.typ === 'haben' ? safeFloat(tx.betrag) : 0;
                saldo += (s - hVal);
                
                rows.push([
                    formatDate(tx.buchungsdatum),
                    tx.text,
                    s > 0 ? formatNum(s) : "",
                    hVal > 0 ? formatNum(hVal) : "",
                    formatNum(saldo)
                ]);
            });
            
            // Add Sum Row
            rows.push(["", "Endstand", "", "", formatNum(saldo) + " ‚Ç¨"]);

            doc.autoTable({
                startY: 40,
                head: headers,
                body: rows,
                columnStyles: {
                    2: { halign: 'right' },
                    3: { halign: 'right' },
                    4: { halign: 'right', fontStyle: 'bold' }
                }
            });
            
            doc.save(`Konto_${e.name.replace(/\s/g,'_')}.pdf`);
        }

        // --- GLOBAL ERROR HANDLER ---
        window.onerror = function(msg, url, line) {
            console.error("Global Error:", msg, line);
            // alert("Fehler im Script: " + msg); // Optional f√ºr Debugging
        };

    </script>
</body>
</html>