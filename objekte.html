<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Objektverwaltung Pro + Finanzen</title>
    <!-- PDF Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <!-- MS Auth -->
    <script src="https://alcdn.msauth.net/browser/2.24.0/js/msal-browser.min.js"></script>
    
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; padding: 15px; background-color: #f4f7f6; margin: 0; }
        
        /* Header & Actions */
        .app-header { background: white; padding: 15px; border-bottom: 1px solid #ddd; margin: -15px -15px 20px -15px; display: flex; flex-wrap: wrap; align-items: center; justify-content: space-between; gap: 10px; }
        .app-title { font-size: 1.2em; font-weight: bold; color: #2e7d32; margin: 0; }
        .cloud-actions { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        
        button { padding: 8px 12px; font-size: 0.9em; border-radius: 4px; border: 1px solid #bbb; background: #eee; cursor: pointer; }
        button:hover { background: #ddd; }
        button:disabled { opacity: 0.6; cursor: not-allowed; }

        .primary-btn { background: #2e7d32; color: white; border-color: #1b5e20; }
        .warn-btn { background: #d9534f; color: white; border-color: #d43f3a; }
        .onedrive-btn { background: #0078d4; color: white; border-color: #005a9e; }
        .local-btn { background: #fff3cd; color: #856404; border-color: #ffeeba; }
        .report-btn { background: #607d8b; color: white; border-color: #455a64; }
        .test-btn { background: #ff9800; color: white; border-color: #f57c00; }
        .finance-btn { background: #673ab7; color: white; border-color: #512da8; } /* LILA f√ºr Finanzen */
        .account-btn { background: #e1bee7; color: #4a148c; border-color: #ce93d8; font-weight:bold; }
        
        .onedrive-status { display: none; padding: 6px 12px; border-radius: 4px; font-size: 0.9em; font-weight: 500;}
        .onedrive-status.saving { background-color: #e0f2fe; color: #0c4a6e; display: inline-block; border: 1px solid #bae6fd;}
        .onedrive-status.success { background-color: #dcfce7; color: #14532d; display: inline-block; border: 1px solid #bbf7d0;}
        .onedrive-status.error { background-color: #fee2e2; color: #991b1b; display: inline-block; border: 1px solid #fecaca;}
        .onedrive-status.info { background-color: #fffbeb; color: #92400e; display: inline-block; border: 1px solid #fde68a;}
        
        /* Session Warning */
        #sessionExpiredWarning { display: none; width: 100%; background: #fff3cd; color: #856404; text-align: center; padding: 10px; margin-bottom: 10px; border: 1px solid #ffeeba; border-radius: 4px; font-weight: bold; }

        /* Navigation */
        .tab-bar { margin-bottom: 15px; display: flex; gap: 5px; flex-wrap: wrap; align-items: center; }
        .tab-btn { background: #f9f9f9; padding: 10px 15px; border-bottom: 3px solid transparent; cursor: pointer; border-radius: 4px 4px 0 0; }
        .tab-btn.active { border-bottom: 3px solid #2e7d32; font-weight: bold; background: white; }
        .report-actions { margin-left: auto; display: flex; gap: 5px; }

        /* Filter Banner */
        #filterBanner { display: none; background-color: #e3f2fd; border: 1px solid #90caf9; color: #0d47a1; padding: 10px; margin-bottom: 15px; border-radius: 4px; align-items: center; justify-content: space-between; }
        #filterBanner button { margin: 0; padding: 5px 10px; background: #fff; border: 1px solid #90caf9; color: #0d47a1; }

        .panel { display: none; background: white; padding: 15px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .panel.active { display: block; }
        .liste-item { border: 1px solid #ddd; padding: 10px; margin-bottom: 10px; background: #fff; border-radius: 4px; display: flex; gap: 10px; align-items: flex-start; }
        .liste-content { flex: 1; }
        .item-checkbox { margin-top: 5px; transform: scale(1.2); cursor: pointer; }

        .objekt-stats { font-size: 0.85em; background: #fafafa; padding: 8px; border-radius: 4px; margin-top: 8px; border: 1px solid #eee; }
        .validation-row { display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding: 2px 0; }
        
        .stat-ok { color: #2e7d32; font-weight: bold; }
        .stat-err { color: #d32f2f; font-weight: bold; }
        
        /* SCROLLABLE MATRIX */
        .matrix-wrapper { max-height: 300px; overflow-y: auto; border: 1px solid #ccc; margin-bottom: 10px; background: #fff; }
        .soll-matrix { width: 100%; border-collapse: collapse; font-size: 0.85em; }
        .soll-matrix th { text-align: center; background: #eee; padding: 5px; border: 1px solid #ccc; font-weight: 600; position: sticky; top: 0; z-index: 2; }
        .soll-matrix td { border: 1px solid #ccc; padding: 4px; text-align: center; }
        .soll-matrix input { width: 100%; text-align: center; border: 1px solid transparent; background: #f9fbe7; font-weight: bold; }
        .soll-matrix input:focus { background: #fff; border: 1px solid #2e7d32; outline: none; }
        .readonly-val { color: #555; }
        .diff-val { font-weight: bold; }
        
        .matrix-sum-row { background: #e0f2f1; font-weight: bold; }

        /* Modal */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; justify-content: center; align-items: center; }
        .modal-overlay.active { display: flex; }
        .modal-content { background: white; padding: 25px; border-radius: 8px; width: 95%; max-width: 900px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); max-height: 90vh; overflow-y: auto; }
        .modal-content input, .modal-content select, .modal-content textarea { width: 100%; padding: 8px; margin-top: 5px; margin-bottom: 15px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
        .modal-actions { text-align: right; margin-top: 20px; }
        
        /* Listen Container f√ºr Belegung/Historie/Finanzen */
        .sub-list-container { border: 1px solid #eee; padding: 10px; background: #fafafa; border-radius: 4px; margin-bottom: 15px; max-height: 350px; overflow-y: auto; }
        
        .belegung-wrapper { border-bottom: 1px solid #ddd; padding-bottom: 10px; margin-bottom: 10px; background: #fff; padding: 10px; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .belegung-row { display: flex; gap: 8px; align-items: center; }
        .belegung-row select { flex: 3; min-width: 200px; margin: 0; font-weight: bold; } 
        .belegung-row input[type="date"] { flex: 0 0 130px; margin: 0; font-size: 0.9em; } 
        
        .belegung-extra { display: none; margin-top: 8px; background: #fff3e0; padding: 8px; border-radius: 4px; border: 1px solid #ffe0b2; }
        .belegung-adresse-grid { display: grid; grid-template-columns: 3fr 1fr 1fr 3fr; gap: 5px; }
        .belegung-adresse-grid input { margin: 0; font-size: 0.9em; width: 100%; border: 1px solid #ffcc80; background: #fff; }
        
        .contact-info-display { font-size: 0.85em; color: #555; margin-left: 5px; margin-top: 4px; display: flex; gap: 15px; }
        .contact-info-item { display: flex; align-items: center; gap: 4px; }
        
        .historie-row { display: flex; gap: 5px; align-items: center; margin-bottom: 5px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .historie-row input[type="date"] { width: 130px; margin:0; }
        .historie-row input[type="text"] { flex: 1; margin:0; }

        .badge { padding: 2px 6px; border-radius: 4px; font-size: 0.8em; font-weight: bold; margin-left: 5px; border: 1px solid #ccc; background: #f0f0f0; color: #333; }
        .mieter-status { margin-top: 8px; padding-top: 8px; border-top: 1px solid #eee; font-size: 0.95em; }
        .status-leerstand { color: #c62828; font-weight: bold; background: #ffebee; padding: 2px 6px; border-radius: 3px; display:inline-block; }
        .status-vermietet { color: #2e7d32; font-weight: bold; }
        .status-zukunft { color: #0277bd; font-style: italic; }
        .contract-id { font-family: monospace; background: #eee; padding: 1px 4px; border-radius: 3px; margin-left: 5px; color: #555; }

        /* Live Status Boxen */
        .live-status-box { padding: 10px; border-radius: 4px; margin-bottom: 15px; font-size: 0.9em; border: 1px solid transparent; }
        .live-status-info { background: #e3f2fd; border-color: #90caf9; color: #0d47a1; }
        .live-status-ok { background: #e8f5e9; border-color: #a5d6a7; color: #1b5e20; }
        .live-status-err { background: #ffebee; border-color: #ef9a9a; color: #c62828; }

        /* Type Overview Badges */
        .type-overview-container { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 15px; padding: 10px; background: #f9f9f9; border-radius: 4px; border: 1px solid #eee; }
        .type-badge { padding: 4px 8px; border-radius: 4px; font-size: 0.85em; border: 1px solid #ccc; background: #fff; color: #555; cursor: pointer; }
        .type-badge:hover { background-color: #eee; }
        .type-badge.open { border-color: #2196f3; background: #e3f2fd; color: #0d47a1; font-weight: bold; }
        .type-badge.full { border-color: #4caf50; background: #e8f5e9; color: #1b5e20; }
        .type-badge.over { border-color: #f44336; background: #ffebee; color: #b71c1c; }
        .type-badge.selected { box-shadow: 0 0 0 2px #333; }

        .full-house-warning { color: #c62828; font-weight: bold; margin-bottom: 5px; display: block; border-bottom: 1px solid #ef9a9a; padding-bottom: 5px; }

        /* Styles f√ºr Finanz-Modul */
        .kondition-row { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr 30px; gap: 5px; margin-bottom: 5px; align-items: center; }
        .kondition-row input, .kondition-row select { margin: 0; font-size: 0.9em; }
        
        .konto-tabelle { width: 100%; border-collapse: collapse; font-size: 0.9em; }
        .konto-tabelle th, .konto-tabelle td { border: 1px solid #ddd; padding: 6px; text-align: left; }
        .konto-tabelle th { background: #f5f5f5; }
        .text-right { text-align: right; }
        .betrag-soll { color: #c62828; }
        .betrag-haben { color: #2e7d32; }

        h4 { margin: 0; padding: 0; }
        .sub-info { color: #666; font-size: 0.9em; margin-top: 4px; }
        
        .filter-btn { background: #fff; color: #333; border: 1px solid #aaa; padding: 4px 8px; font-size: 0.85em; }
        .filter-btn.active { background: #e0f2f1; border-color: #00695c; color: #00695c; font-weight: bold; }
        
        .section-header { margin-top: 15px; margin-bottom: 5px; padding-bottom: 5px; border-bottom: 1px solid #eee; font-weight: bold; color: #333; display: flex; justify-content: space-between; align-items: center; }
    </style>
</head>
<body>
    <div id="sessionExpiredWarning">‚ö†Ô∏è Ihre Sitzung ist abgelaufen. Bitte erneut anmelden, um zu speichern!</div>

    <div class="app-header">
        <div class="app-title">Objektverwaltung Pro <span id="loggedInUser" style="font-size:0.6em; font-weight:normal; color:#555;"></span></div>
        <div class="cloud-actions">
            <!-- FINANCE BUTTON -->
            <button onclick="openSollstellungModal()" class="finance-btn" title="Monatliche Mieten berechnen">üí∞ Sollstellung</button>
            <span style="border-left: 1px solid #ccc; height: 20px; margin: 0 5px;"></span>
            
            <button onclick="createDummyData()" class="test-btn" title="Erstellt Musterobjekt mit Finanz-Historie">üß™ Testdaten</button>
            
            <button id="msLoginBtn" onclick="handleMicrosoftLogin()" class="onedrive-btn">üîë Login</button>
            <button id="msLogoutBtn" onclick="handleLogout()" class="warn-btn" style="display:none;">üîí Logout</button>
            
            <span style="border-left: 1px solid #ccc; height: 20px; margin: 0 5px;"></span>
            
            <button onclick="saveToOneDrive(true)">üíæ Speichern</button>
            <button onclick="speichereDateiLokal()" class="local-btn">üìÇ Sichern</button>
            <button onclick="ladeDateiLokal()" class="local-btn">üìÇ Laden</button>

            <span id="onedriveStatus" class="onedrive-status"></span>
        </div>
    </div>

    <div style="max-width: 1200px; margin: 0 auto;">
        <!-- FILTER BANNER -->
        <div id="filterBanner">
            <span id="filterText">Filter aktiv</span>
            <button onclick="toggleFilter(null)">Filter aufheben</button>
        </div>

        <div class="tab-bar">
            <button class="tab-btn active" onclick="switchTab('objekte')">üè† Objekte</button>
            <button class="tab-btn" onclick="switchTab('haeuser')">üèòÔ∏è H√§user</button>
            <button class="tab-btn" onclick="switchTab('einheiten')">üö™ Einheiten</button>
            
            <div class="report-actions">
                <button onclick="generateObjectReportPDF()" class="report-btn">üìÑ Objekt-Status PDF</button>
                <button onclick="generateHouseReportPDF()" class="report-btn">üèòÔ∏è Haus-Status PDF</button>
                <button onclick="generateUnitReportPDF()" class="report-btn">üìã Vermietungsliste PDF</button>
            </div>
            
            <a href="kontakte.html" style="margin-left:10px; text-decoration:none;"><button>üë• Kontakte</button></a>
        </div>

        <!-- PANEL OBJEKTE -->
        <div id="panelObjekte" class="panel active">
            <button class="primary-btn" onclick="openObjektMask()">+ Neues Objekt anlegen</button>
            <div style="margin-top:10px;"><input type="checkbox" onchange="toggleAll('objekteListe', this.checked)"> Alle ausw√§hlen</div>
            <div id="objekteListe" style="margin-top: 15px;"></div>
        </div>

        <!-- PANEL H√ÑUSER -->
        <div id="panelHaeuser" class="panel">
            <button class="primary-btn" onclick="openHausMask()">+ Neues Haus anlegen</button>
            <div style="margin-top:10px;"><input type="checkbox" onchange="toggleAll('haeuserListe', this.checked)"> Alle ausw√§hlen</div>
            <div id="haeuserListe" style="margin-top: 15px;"></div>
        </div>

        <!-- PANEL EINHEITEN -->
        <div id="panelEinheiten" class="panel">
            <button class="primary-btn" onclick="openEinheitMask()">+ Neue Einheit anlegen</button>
            <div style="margin-top:10px;"><input type="checkbox" onchange="toggleAll('einheitenListe', this.checked)"> Alle ausw√§hlen</div>
            <div id="einheitenListe" style="margin-top: 15px;"></div>
        </div>
    </div>

    <!-- ================= MODALS ================= -->

    <!-- Modal 1: Objekt -->
    <div id="objektModal" class="modal-overlay" onclick="if(event.target===this)this.classList.remove('active')">
        <div class="modal-content">
            <h3>Objekt bearbeiten</h3>
            <input type="hidden" id="objektIdInput">
            <div id="objektLiveStatus" class="live-status-box" style="display:none;"></div>

            <div style="display:flex; gap:10px;">
                <div style="flex:1"><label>Objekt-Nr. (z.B. 0001)*:</label><input type="text" id="objektNummerInput" placeholder="0001" readonly style="background:#eee; font-family:monospace;"></div>
                <div style="flex:2"><label>Bezeichnung / Adresse*:</label><input type="text" id="objektNameInput"></div>
            </div>
            <div style="display:flex; gap:10px;">
                <div style="flex:1"><label>PLZ:</label><input type="text" id="objektPlzInput"></div>
                <div style="flex:2;"><label>Ort:</label><input type="text" id="objektOrtInput"></div>
            </div>
            <h4 style="margin-top:10px;border-bottom:1px solid #eee;">Gesamt-Vorgaben (Soll)</h4>
            <div style="display:flex; gap:10px;">
                <div style="flex:1;"><label>Anzahl H√§user:</label><input type="number" id="objektSollHaeuser" placeholder="1" oninput="updateObjektLiveStatus()"></div>
                <div style="flex:1;"><label>Gesamtfl√§che (m¬≤):</label><input type="number" step="0.01" id="objektFlaecheInput" oninput="updateObjektLiveStatus()"></div>
                <div style="flex:1;"><label>Gesamt MEA:</label><input type="number" step="0.001" id="objektMeaInput" value="1000" oninput="updateObjektLiveStatus()"></div>
            </div>
            <div class="modal-actions">
                <button onclick="document.getElementById('objektModal').classList.remove('active')">Abbrechen</button>
                <button class="primary-btn" onclick="saveObjekt()">Speichern</button>
                <button class="warn-btn" onclick="deleteObjekt()" style="float:left;">L√∂schen</button>
            </div>
        </div>
    </div>

    <!-- Modal 2: Haus -->
    <div id="hausModal" class="modal-overlay" onclick="if(event.target===this)this.classList.remove('active')">
        <div class="modal-content">
            <h3>Haus bearbeiten</h3>
            <input type="hidden" id="hausIdInput">
            
            <div style="display:flex; gap:10px;">
                <div style="flex:1;"><label>Geh√∂rt zu Objekt*:</label><select id="hausObjektSelect" onchange="updateHausIdPreview()"></select></div>
                <div style="flex:1;"><label>Haus-ID (auto):</label><input type="text" id="hausNummerDisplay" readonly style="background:#eee; font-family:monospace;"></div>
                <div style="flex:2;"><label>Bezeichnung*:</label><input type="text" id="hausBezeichnungInput"></div>
            </div>

            <h4 style="margin-top:15px; margin-bottom:5px;">Validierungs-Matrix</h4>
            <div class="matrix-wrapper">
                <table class="soll-matrix">
                    <thead>
                        <tr>
                            <th style="width:25%;">Typ / Bez.</th>
                            <th style="width:10%;">Soll Anz.</th>
                            <th style="width:10%; background:#f5f5f5;">Ist</th>
                            <th style="width:10%; background:#f5f5f5;">Diff</th>
                            <th style="width:15%;">Soll Fl√§che</th>
                            <th style="width:15%; background:#f5f5f5;">Ist</th>
                            <th style="width:15%; background:#f5f5f5;">Diff</th>
                            <th style="width:5%;"></th>
                        </tr>
                    </thead>
                    <tbody id="hausSollMatrixBody"></tbody>
                    <tfoot>
                        <tr class="matrix-sum-row">
                            <td>Summe:</td>
                            <td id="matrixSumCount">0</td>
                            <td id="matrixIstCount" class="readonly-val">-</td>
                            <td></td>
                            <td id="matrixSumArea">0.00</td>
                            <td id="matrixIstArea" class="readonly-val">-</td>
                            <td></td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            <button type="button" onclick="addCustomTypeRow()" style="font-size:0.8em; margin-bottom: 10px;">+ Weiteren Typ hinzuf√ºgen</button>
            
            <div style="display:flex; gap:10px; margin-top:10px;">
                <div style="flex:1;"><label>Gesamt MEA (Soll):</label><input type="number" step="0.001" id="hausAnteileInput" oninput="calcMatrixSum()"></div>
                <div style="flex:1; padding-top:25px;"><span id="hausMeaStatus" style="font-weight:bold;"></span></div>
            </div>
            <div class="modal-actions">
                <button onclick="document.getElementById('hausModal').classList.remove('active')">Abbrechen</button>
                <button class="primary-btn" onclick="saveHaus()">Speichern</button>
                <button class="warn-btn" onclick="deleteHaus()" style="float:left;">L√∂schen</button>
            </div>
        </div>
    </div>

    <!-- Modal 3: Einheit -->
    <div id="einheitModal" class="modal-overlay" onclick="if(event.target===this)this.classList.remove('active')">
        <div class="modal-content">
            <h3>Einheit bearbeiten</h3>
            <input type="hidden" id="einheitIdInput">
            
            <div style="display:flex; gap:10px;">
                <div style="flex:1;">
                    <label>Objekt w√§hlen*:</label>
                    <select id="einheitObjektSelect" onchange="filterHaeuserDropdown()"></select>
                </div>
                <div style="flex:1;">
                    <label>Haus w√§hlen*:</label>
                    <select id="einheitHausSelect" onchange="onHausSelectionChange()"></select>
                </div>
                <div style="flex:1;">
                    <label>Einheit-ID (auto):</label>
                    <input type="text" id="einheitNummerDisplay" readonly style="background:#eee; font-family:monospace;">
                </div>
            </div>

            <!-- STATUS √úBERSICHT -->
            <label style="margin-top:10px; display:block; font-size:0.9em; font-weight:bold;">Verf√ºgbarkeit im Haus:</label>
            <div id="hausTypeOverview" class="type-overview-container">
                <span style="color:#666; font-style:italic;">Bitte erst ein Haus ausw√§hlen...</span>
            </div>

            <div id="einheitLiveStatus" class="live-status-box" style="display:none;"></div>

            <div style="display:flex; gap:10px;">
                <div style="flex:2;"><label>Lage / Bezeichnung*:</label><input type="text" id="einheitNameInput"></div>
                <div style="flex:1;"><label>Typ:</label><select id="einheitTypSelect" onchange="updateUnitLiveStatus()"></select></div>
            </div>
            <div style="display:flex; gap:10px;">
                <div style="flex:1;"><label>Wohn-/Nutzfl√§che (m¬≤):</label><input type="number" step="0.01" id="einheitFlaecheInput" oninput="updateUnitLiveStatus()"></div>
                <div style="flex:1;"><label>Heizfl√§che (m¬≤):</label><input type="number" step="0.01" id="einheitHeizflaecheInput"></div>
            </div>
            <div style="display:flex; gap:10px;">
                <div style="flex:1;"><label>Zimmer:</label><input type="number" step="0.5" id="einheitZimmerInput"></div>
                <div style="flex:1;"><label>MEA Anteil:</label><input type="number" step="0.001" id="einheitMeaInput"></div>
            </div>

            <!-- Z√ÑHLER & VERBRAUCH (NEU) -->
            <div class="section-header">Z√§hlerst√§nde / Verbrauchsparameter (m¬≥)</div>
            <div style="display:flex; gap:10px;">
                <div style="flex:1;"><label>Warmwasser m¬≥ (Info):</label><input type="number" step="0.001" id="einheitWwInput" placeholder="z.B. Z√§hlerstand"></div>
                <div style="flex:1;"><label>Kaltwasser m¬≥ (Info):</label><input type="number" step="0.001" id="einheitKwInput" placeholder="z.B. Z√§hlerstand"></div>
            </div>
            
            <!-- MIET-KONDITIONEN (NEU) -->
            <div class="section-header">
                <span>Miet-Konditionen & Vorauszahlungen (Monatlich)</span>
                <button type="button" onclick="addKonditionRow()" style="font-size:0.8em; padding:2px 8px;">+ Position</button>
            </div>
            <div style="background:#f9f9f9; padding:5px; border-radius:4px; border:1px solid #eee; margin-bottom:10px;">
                <div style="display:grid; grid-template-columns: 2fr 1fr 1fr 1fr 30px; gap:5px; font-size:0.8em; font-weight:bold; margin-bottom:5px;">
                    <div>Bezeichnung</div>
                    <div>Betrag (‚Ç¨)</div>
                    <div>Konto (S/H)</div>
                    <div>G√ºltig Ab</div>
                    <div></div>
                </div>
                <div id="konditionenListe"></div>
            </div>
            
            <div class="section-header">Belegung / Mieterhistorie</div>
            <div id="belegungListe" class="sub-list-container"></div>
            <button type="button" onclick="addBelegungRow()" style="margin-top:5px; font-size:0.85em;">+ Mieterwechsel hinzuf√ºgen</button>

            <div class="section-header">Bauliche Historie & √Ñnderungen</div>
            <div id="historieListe" class="sub-list-container"></div>
            <button type="button" onclick="addHistorieRow()" style="margin-top:5px; font-size:0.85em;">+ √Ñnderung dokumentieren</button>

            <div class="modal-actions">
                <button onclick="document.getElementById('einheitModal').classList.remove('active')">Abbrechen</button>
                <button class="primary-btn" onclick="saveEinheit()">Speichern</button>
                <button class="warn-btn" onclick="deleteEinheit()" style="float:left;">L√∂schen</button>
            </div>
        </div>
    </div>

    <!-- Modal 4: Sollstellung Generator (NEU) -->
    <div id="sollstellungModal" class="modal-overlay" onclick="if(event.target===this)this.classList.remove('active')">
        <div class="modal-content" style="max-width:500px;">
            <h3>üí∞ Sollstellung generieren</h3>
            <p style="font-size:0.9em; color:#555;">Hiermit werden die monatlichen Forderungen f√ºr alle aktiven Mietverh√§ltnisse berechnet (taggenau).</p>
            
            <label>Abrechnungs-Monat:</label>
            <input type="month" id="sollMonatInput">
            
            <div id="sollLog" style="background:#333; color:#0f0; font-family:monospace; padding:10px; height:150px; overflow-y:auto; margin-top:10px; font-size:0.8em; display:none;"></div>

            <div class="modal-actions">
                <button onclick="document.getElementById('sollstellungModal').classList.remove('active')">Schlie√üen</button>
                <button class="finance-btn" onclick="runSollstellung()">Lauf starten</button>
            </div>
        </div>
    </div>

    <!-- Modal 5: Mieterkonto (NEU) -->
    <div id="kontoModal" class="modal-overlay" onclick="if(event.target===this)this.classList.remove('active')">
        <div class="modal-content" style="max-width:1000px;">
            <h3>üí∂ Mieterkonto</h3>
            <input type="hidden" id="kontoEinheitId">
            <h4 id="kontoTitle" style="color:#0078d4;"></h4>
            
            <div style="display:flex; justify-content:space-between; margin:10px 0;">
                <div>
                    <select id="kontoJahrSelect" onchange="renderKontoTable()" style="width:auto; display:inline-block; margin:0;">
                        <option value="all">Alle Jahre</option>
                    </select>
                </div>
                <div>
                    <button class="warn-btn" onclick="resetKonto()" title="L√∂scht ALLE Buchungen dieser Einheit (f√ºr Testdaten/Neustart)">üßπ Konto bereinigen</button>
                    <button class="primary-btn" onclick="openManuelleBuchung()">+ Manuelle Buchung</button>
                    <button onclick="exportKontoPDF()">üñ®Ô∏è Auszug PDF</button>
                </div>
            </div>

            <div class="sub-list-container" style="max-height:500px;">
                <table class="konto-tabelle">
                    <thead>
                        <tr>
                            <th>Datum</th>
                            <th>Vorgang / Text</th>
                            <th class="text-right">Soll (Forderung)</th>
                            <th class="text-right">Haben (Zahlung)</th>
                            <th class="text-right">Saldo</th>
                            <th style="width:50px;"></th>
                        </tr>
                    </thead>
                    <tbody id="kontoBody"></tbody>
                    <tfoot>
                        <tr style="font-weight:bold; background:#eee;">
                            <td colspan="2">Endstand:</td>
                            <td id="sumSoll" class="text-right">0,00 ‚Ç¨</td>
                            <td id="sumHaben" class="text-right">0,00 ‚Ç¨</td>
                            <td id="sumSaldo" class="text-right">0,00 ‚Ç¨</td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>

            <!-- Manuelle Buchung Form (Inline) -->
            <div id="manuelleBuchungForm" style="display:none; background:#e3f2fd; padding:10px; border:1px solid #90caf9; margin-top:10px;">
                <b>Neue Buchung erfassen:</b>
                <div style="display:flex; gap:5px; margin-top:5px;">
                    <input type="date" id="mbDatum">
                    <input type="text" id="mbText" placeholder="Beschreibung (z.B. Mieteingang, Korrektur)">
                    <select id="mbTyp"><option value="haben">Haben (Zahlung/Gutschrift)</option><option value="soll">Soll (Forderung/Nachb.)</option></select>
                    <input type="number" step="0.01" id="mbBetrag" placeholder="Betrag ‚Ç¨">
                    <button class="primary-btn" onclick="saveManuelleBuchung()">Buchen</button>
                    <button onclick="document.getElementById('manuelleBuchungForm').style.display='none'">Abbr.</button>
                </div>
            </div>

            <div class="modal-actions">
                <button onclick="document.getElementById('kontoModal').classList.remove('active')">Schlie√üen</button>
            </div>
        </div>
    </div>

    <script>
        // --- DEFINITIONEN ---
        const STANDARD_TYPES = [
            { id: 'wohnung', label: 'Wohnung' }, { id: 'gewerbe', label: 'Gewerbe' }, { id: 'halle', label: 'Gewerbe-Halle' },
            { id: 'geschaeft', label: 'Gesch√§ft' }, { id: 'garage', label: 'Garage' }, { id: 'parkplatz', label: 'Parkplatz' },
            { id: 'keller', label: 'Keller' }, { id: 'garten', label: 'Garten' }, { id: 'sonstige', label: 'Sonstige' }
        ];

        // Standard Miet-Konditionen Typen
        const KONDITION_TYPES = [
            "Kaltmiete", "BK-Vorausz.", "HK-Vorausz.", "Stellplatz", "Garage", "K√ºchenzuschlag", "Mietminderung", "Sonstiges"
        ];

        const msalConfig = { auth: { clientId: "c3cd3be4-3540-46dd-a24c-82eb6ed5542d", authority: "https://login.microsoftonline.com/common", redirectUri: window.location.origin + window.location.pathname } };
        let msalInstance, accessToken;
        
        let dbObjekte = new Map(), dbHaeuser = new Map(), dbEinheiten = new Map(), dbKontakte = new Map(); 
        let dbFinanzen = []; // [{ id, einheitId, mieterId, datum, text, soll, haben, monatRef, typ, locked, kategorie }]
        
        let activeFilterId = null; 
        let autoSaveTimer = null;

        document.addEventListener('DOMContentLoaded', async () => {
            loadLocal(); 
            try { renderLists(); } catch (err) { console.error("Fehler beim Initial-Rendering:", err); }
            try {
                msalInstance = new msal.PublicClientApplication(msalConfig);
                await msalInstance.initialize();
                setInterval(checkSession, 1000 * 60 * 5); 
                const acc = msalInstance.getAllAccounts()[0];
                if (acc) { msalInstance.setActiveAccount(acc); if(await getToken()) handleLoginSuccess(acc); }
            } catch(e) { console.error(e); }
        });

        // --- HELPER ---
        function safeFloat(val) { if(typeof val==='number') return val; if(!val) return 0; let str=val.toString().replace(',','.'); return parseFloat(str)||0; }
        function formatDate(isoStr) { if(!isoStr) return ""; const p=isoStr.split('-'); return `${p[2]}.${p[1]}.${p[0]}`; }
        function formatNum(n) { return n.toLocaleString('de-DE', {minimumFractionDigits:2, maximumFractionDigits:2}); }
        function pad(n, width, z) { z = z || '0'; n = n + ''; return n.length >= width ? n : new Array(width - n.length + 1).join(z) + n; }
        function formatCurrency(n) { return n.toLocaleString('de-DE', {style:'currency', currency:'EUR'}); }
        
        // --- DATA LAYER ---
        function getNextFinanzId() { return 'tx_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5); }

        function validateVal(soll, ist, unit = '', tolerance = 0.01) {
            soll = safeFloat(soll); ist = safeFloat(ist);
            const diff = Math.round((ist - soll) * 1000) / 1000;
            const isOk = Math.abs(diff) <= tolerance;
            if(isOk) return `<div class="validation-row"><span class="stat-ok">‚úÖ ${formatNum(ist)} ${unit} (Soll: ${formatNum(soll)})</span></div>`;
            const diffStr = diff > 0 ? `+${formatNum(diff)}` : formatNum(diff);
            return `<div class="validation-row"><span class="stat-err">‚ö†Ô∏è ${formatNum(ist)} ${unit} (Soll: ${formatNum(soll)}) <small style="margin-left:5px;">Diff: ${diffStr}</small></span></div>`;
        }

        // --- FILTER ---
        function toggleFilter(id) {
            activeFilterId = id;
            const banner = document.getElementById('filterBanner');
            const txt = document.getElementById('filterText');
            if(activeFilterId) {
                const o = dbObjekte.get(activeFilterId);
                banner.style.display = "flex";
                txt.innerHTML = `<b>Fokus aktiv:</b> ${o ? o.name : 'Objekt'}`;
            } else {
                banner.style.display = "none";
            }
            renderLists();
        }

        // --- ID GENERATORS (ROBUST GEMACHT) ---
        function getNextObjektID() {
            let max = 0;
            dbObjekte.forEach((o, id) => { const num = parseInt(id, 10); if (!isNaN(num) && num > max) max = num; });
            return pad(max + 1, 4);
        }
        function getNextHausID(objektId) {
            let max = 0;
            dbHaeuser.forEach((h, id) => {
                if (id.startsWith(objektId + "/")) { 
                    const parts = id.split('/'); 
                    // Nimm immer den letzten Teil der ID, um sicherzugehen (Robustheit f√ºr 0001/02)
                    const num = parseInt(parts[parts.length - 1], 10); 
                    if (!isNaN(num) && num > max) max = num; 
                }
            });
            return objektId + "/" + pad(max + 1, 2);
        }
        function getNextEinheitID(hausId) {
            let max = 0;
            dbEinheiten.forEach((e, id) => {
                if (id.startsWith(hausId + "/")) { 
                    const parts = id.split('/'); 
                    // Nimm immer den letzten Teil, falls Haus-ID auch Slashes enth√§lt (Robustheit)
                    const num = parseInt(parts[parts.length - 1], 10); 
                    if (!isNaN(num) && num > max) max = num; 
                }
            });
            return hausId + "/" + pad(max + 1, 4);
        }

        function createDummyData() {
            if(!confirm("Musterdaten (Wohnpark Test) erzeugen?\nDies erstellt auch ein Muster-Mieterkonto.")) return;
            const oid = getNextObjektID();
            dbObjekte.set(oid, { nummer: oid, name: "Wohnpark Test", plz: "12345", ort: "Musterstadt", flaeche: 150, mea: 1000, sollHaeuser: 1 });
            const hid = getNextHausID(oid);
            const matrix = {}; 
            matrix['wohnung'] = { count: 2, area: 100, label: "Wohnung" }; // 2x50 = 100
            matrix['gewerbe'] = { count: 1, area: 50, label: "Gewerbe" };  // 1x50 = 50
            
            dbHaeuser.set(hid, { objektId: oid, bezeichnung: "Haus A", anteile: 1000, sollMatrix: matrix });
            
            // Einheit 1: Wohnung Links (ID generieren)
            let eid = getNextEinheitID(hid);
            dbEinheiten.set(eid, { 
                hausId: hid, name: "EG Links", typ: "wohnung", flaeche: 50, zimmer: 2, mea: 333.33, 
                ww_m3: 123.4, kw_m3: 456.7,
                konditionen: [
                    { id: 'k1', label: 'Kaltmiete', betrag: 500, konto: '8000', gueltigAb: '2023-01-01' },
                    { id: 'k2', label: 'BK-Vorausz.', betrag: 100, konto: '8010', gueltigAb: '2023-01-01' },
                    { id: 'k3', label: 'K√ºchenzuschlag', betrag: 50, konto: '8050', gueltigAb: '2023-01-01' } 
                ],
                belegung: [{ mieterId: "dummy_mieter", einzug: "2023-01-01", auszug: "" }] 
            });

            // FINANZ HISTORIE NUR F√úR EINHEIT 1 ERZEUGEN (Letzte 3 Monate)
            const now = new Date();
            for (let i = 3; i >= 1; i--) {
                const d = new Date(now.getFullYear(), now.getMonth() - i, 1); 
                const monatStr = d.toISOString().slice(0, 7);
                const buchDatum = d.toISOString().slice(0, 10);
                const zahlDatum = new Date(d); zahlDatum.setDate(4);
                
                dbFinanzen.push({ id: getNextFinanzId(), einheitId: eid, mieterId: "dummy_mieter", monatRef: monatStr, buchungsdatum: buchDatum, typ: 'soll', kategorie: 'Miete Gesamt', text: `Sollstellung ${monatStr} (Test)`, betrag: 650, konto: '8000' });
                dbFinanzen.push({ id: getNextFinanzId(), einheitId: eid, mieterId: "dummy_mieter", monatRef: monatStr, buchungsdatum: zahlDatum.toISOString().slice(0, 10), typ: 'haben', kategorie: 'Zahlung', text: `Mieteigang ${monatStr}`, betrag: 650, konto: '1200' });
            }

            // Einheit 2: Wohnung Rechts (ID generieren - da E1 schon im Map ist, wird E2 korrekt berechnet)
            eid = getNextEinheitID(hid);
            dbEinheiten.set(eid, { hausId: hid, name: "EG Rechts", typ: "wohnung", flaeche: 50, zimmer: 2, mea: 333.33, belegung: [] });

            // Einheit 3: Gewerbe (ID generieren)
            eid = getNextEinheitID(hid);
            dbEinheiten.set(eid, { hausId: hid, name: "B√ºro OG", typ: "gewerbe", flaeche: 50, zimmer: 3, mea: 333.34, belegung: [] });

            saveLocal(); renderLists(); alert("Wohnpark Test + Finanzhistorie angelegt!");
        }

        // --- AUTH & CLOUD ---
        async function handleMicrosoftLogin() { try { const res = await msalInstance.loginPopup({ scopes: ["Files.ReadWrite"], prompt: "select_account" }); if(await getToken()) { handleLoginSuccess(res.account); } } catch(e) { alert("Login Error: " + e.message); } }
        async function handleLogout() { await msalInstance.logoutPopup(); location.reload(); }
        function handleLoginSuccess(account) {
            document.getElementById('msLoginBtn').style.display = 'none';
            document.getElementById('msLogoutBtn').style.display = 'inline-block';
            document.getElementById('loggedInUser').innerText = `(${account.username})`;
            document.getElementById('sessionExpiredWarning').style.display = 'none';
            loadFromOneDrive();
        }
        async function getToken() { try { const r = await msalInstance.acquireTokenSilent({ scopes: ["Files.ReadWrite"], account: msalInstance.getActiveAccount() }); accessToken = r.accessToken; document.getElementById('sessionExpiredWarning').style.display = 'none'; return true; } catch(e) { try { const r = await msalInstance.acquireTokenPopup({ scopes: ["Files.ReadWrite"] }); accessToken = r.accessToken; return true; } catch(err) { return false; } } }
        async function checkSession() { if(msalInstance.getActiveAccount()) { const valid = await getToken(); if(!valid) document.getElementById('sessionExpiredWarning').style.display = 'block'; } }

        // --- LOAD / SAVE (INKL FINANZEN) ---
        async function loadFromOneDrive() {
            if (!accessToken && !(await getToken())) return;
            showStatus("Lade Daten...", "saving");
            // Stammdaten/Kontakte
            try { const resC = await fetch("https://graph.microsoft.com/v1.0/me/drive/root:/ideenapp/stammdaten.json:/content", { headers: { "Authorization": `Bearer ${accessToken}` } }); if (resC.ok) { const d = await resC.json(); if(d.kontakte) dbKontakte = new Map(d.kontakte); } } catch(e) {}
            // Finanzen
            try { const resF = await fetch("https://graph.microsoft.com/v1.0/me/drive/root:/ideenapp/finanzen.json:/content", { headers: { "Authorization": `Bearer ${accessToken}` } }); if (resF.ok) { const d = await resF.json(); if(d.finanzen) dbFinanzen = d.finanzen; } } catch(e) {}
            // Immobilien
            try { 
                const resI = await fetch("https://graph.microsoft.com/v1.0/me/drive/root:/ideenapp/immobilien.json:/content", { headers: { "Authorization": `Bearer ${accessToken}` } }); 
                if (resI.ok) { 
                    const d = await resI.json(); 
                    if(d.objekte) dbObjekte = new Map(d.objekte); 
                    if(d.haeuser) dbHaeuser = new Map(d.haeuser); 
                    if(d.einheiten) dbEinheiten = new Map(d.einheiten); 
                    saveLocal(); renderLists(); showStatus("Daten geladen", "success"); 
                } 
            } catch(e) { showStatus("Fehler: " + e.message, "error"); }
        }
        
        function triggerAutoSave() {
            if(!accessToken) return;
            showStatus("‚è≥ Speichern...", "info");
            clearTimeout(autoSaveTimer);
            autoSaveTimer = setTimeout(() => saveToOneDrive(false), 2000);
        }

        async function saveToOneDrive(m) {
            if (!accessToken && !(await getToken())) { if(m) alert("Bitte einloggen."); return; }
            if(m) showStatus("Speichere...", "saving");
            
            // Immobilien
            const dataImmo = { objekte: Array.from(dbObjekte.entries()), haeuser: Array.from(dbHaeuser.entries()), einheiten: Array.from(dbEinheiten.entries()), meta: { updated: new Date().toISOString() } };
            const p1 = fetch("https://graph.microsoft.com/v1.0/me/drive/root:/ideenapp/immobilien.json:/content", { method: "PUT", headers: { "Authorization": `Bearer ${accessToken}`, "Content-Type": "application/json" }, body: JSON.stringify(dataImmo, null, 2) });
            
            // Finanzen separat speichern
            const dataFin = { finanzen: dbFinanzen, meta: { updated: new Date().toISOString() } };
            const p2 = fetch("https://graph.microsoft.com/v1.0/me/drive/root:/ideenapp/finanzen.json:/content", { method: "PUT", headers: { "Authorization": `Bearer ${accessToken}`, "Content-Type": "application/json" }, body: JSON.stringify(dataFin, null, 2) });

            try { 
                await Promise.all([p1, p2]);
                showStatus("Gespeichert", "success"); 
            } catch(e) { showStatus("Fehler: " + e.message, "error"); }
        }
        
        function loadLocal() { 
            try { 
                const o=localStorage.getItem("immo_objekte"); if(o) dbObjekte=new Map(JSON.parse(o)); 
                const h=localStorage.getItem("immo_haeuser"); if(h) dbHaeuser=new Map(JSON.parse(h)); 
                const e=localStorage.getItem("immo_einheiten"); if(e) dbEinheiten=new Map(JSON.parse(e)); 
                const f=localStorage.getItem("immo_finanzen"); if(f) dbFinanzen=JSON.parse(f);
            } catch(err){} 
        }
        function saveLocal() { 
            localStorage.setItem("immo_objekte", JSON.stringify(Array.from(dbObjekte.entries()))); 
            localStorage.setItem("immo_haeuser", JSON.stringify(Array.from(dbHaeuser.entries()))); 
            localStorage.setItem("immo_einheiten", JSON.stringify(Array.from(dbEinheiten.entries()))); 
            localStorage.setItem("immo_finanzen", JSON.stringify(dbFinanzen));
        }
        function showStatus(msg, type) { const s=document.getElementById('onedriveStatus'); s.textContent=msg; s.className='onedrive-status '+type; s.style.display='inline-block'; setTimeout(()=>s.style.display='none', 4000); }

        async function speichereDateiLokal() {
            const data = { objekte: Array.from(dbObjekte.entries()), haeuser: Array.from(dbHaeuser.entries()), einheiten: Array.from(dbEinheiten.entries()), finanzen: dbFinanzen };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
            if (window.showSaveFilePicker) {
                try {
                    const handle = await window.showSaveFilePicker({ suggestedName: "objekte_backup.json", types: [{ accept: { "application/json": [".json"] } }] });
                    const writable = await handle.createWritable(); await writable.write(blob); await writable.close();
                    showStatus("Lokal gesichert", "success");
                } catch(e) {}
            } else { const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = "objekte_backup.json"; a.click(); }
        }

        async function ladeDateiLokal() {
            try {
                let text;
                if (window.showOpenFilePicker) { const [handle] = await window.showOpenFilePicker({ types: [{ accept: { "application/json": [".json"] } }] }); const file = await handle.getFile(); text = await file.text(); } 
                else { const inp = document.createElement("input"); inp.type="file"; inp.click(); await new Promise(r => inp.onchange = e => { if(e.target.files[0]) { const reader = new FileReader(); reader.onload=ev=>r(text=ev.target.result); reader.readAsText(e.target.files[0]); } }); }
                if(text) {
                    const d = JSON.parse(text);
                    if(d.objekte) dbObjekte = new Map(d.objekte);
                    if(d.haeuser) dbHaeuser = new Map(d.haeuser);
                    if(d.einheiten) dbEinheiten = new Map(d.einheiten);
                    if(d.finanzen) dbFinanzen = d.finanzen;
                    saveLocal(); renderLists(); triggerAutoSave(); alert("Backup erfolgreich geladen!");
                }
            } catch(e) { alert("Fehler beim Laden: "+e.message); }
        }

        // --- HAUS MATRIX LOGIC ---
        function renderHausMatrix(haus) {
            const tbody = document.getElementById('hausSollMatrixBody'); tbody.innerHTML = "";
            STANDARD_TYPES.forEach(t => addMatrixRowToUI(t.id, t.label, haus ? haus.sollMatrix : null, false));
            if(haus && haus.sollMatrix) Object.keys(haus.sollMatrix).forEach(key => { if(!STANDARD_TYPES.some(st => st.id === key)) addMatrixRowToUI(key, haus.sollMatrix[key].label || "Unbenannt", haus.sollMatrix, true); });
        }
        function addMatrixRowToUI(id, label, matrixData, isCustom) {
            const tbody = document.getElementById('hausSollMatrixBody'); const tr = document.createElement('tr'); tr.dataset.typeId = id;
            const cnt = matrixData && matrixData[id] ? matrixData[id].count : ""; const area = matrixData && matrixData[id] ? matrixData[id].area : "";
            let labelHtml = label; if(isCustom) { labelHtml = `<input type="text" class="custom-label-inp" value="${label.replace(/"/g, '&quot;')}" style="text-align:left; background:#fff; border:1px solid #ccc; padding:2px;">`; }
            tr.innerHTML = `<td>${labelHtml}</td><td><input type="number" step="1" class="soll-count matrix-inp" value="${cnt}" oninput="calcMatrixSum()"></td><td class="readonly-val ist-count">0</td><td class="diff-val diff-count">0</td><td><input type="number" step="0.01" class="soll-area matrix-inp" value="${area}" oninput="calcMatrixSum()"></td><td class="readonly-val ist-area">0</td><td class="diff-val diff-area">0.00</td><td>${isCustom ? '<button type="button" class="warn-btn" style="padding:2px 6px;" onclick="this.closest(\'tr\').remove(); calcMatrixSum();">X</button>' : ''}</td>`;
            tbody.appendChild(tr);
        }
        function addCustomTypeRow() { addMatrixRowToUI('custom_' + Date.now(), "Neuer Typ", null, true); }
        function calcMatrixSum() {
            let sumCnt=0, sumArea=0, istTotalCnt=0, istTotalArea=0; const hid = document.getElementById('hausIdInput').value; const einheiten = hid ? Array.from(dbEinheiten.values()).filter(e => e.hausId === hid) : [];
            const sollMea = safeFloat(document.getElementById('hausAnteileInput').value); const istMea = einheiten.reduce((s,e) => s + safeFloat(e.mea), 0);
            const meaStat = document.getElementById('hausMeaStatus'); meaStat.innerText = `Ist: ${formatNum(istMea)} | Diff: ${formatNum(istMea - sollMea)}`; meaStat.style.color = (Math.abs(istMea - sollMea) <= 0.01) ? '#2e7d32' : '#c62828';
            document.querySelectorAll('#hausSollMatrixBody tr').forEach(tr => {
                const typeId = tr.dataset.typeId; const sollC = safeFloat(tr.querySelector('.soll-count').value); const sollA = safeFloat(tr.querySelector('.soll-area').value);
                sumCnt += sollC; sumArea += sollA;
                const unitsOfType = einheiten.filter(e => e.typ === typeId); const istC = unitsOfType.length; const istA = unitsOfType.reduce((s,e)=>s+safeFloat(e.flaeche), 0);
                istTotalCnt += istC; istTotalArea += istA;
                tr.querySelector('.ist-count').innerText = istC; tr.querySelector('.ist-area').innerText = formatNum(istA);
                tr.querySelector('.diff-count').innerText = (istC - sollC); tr.querySelector('.diff-count').style.color = (istC - sollC === 0) ? '#2e7d32' : '#c62828';
                tr.querySelector('.diff-area').innerText = formatNum(istA - sollA); tr.querySelector('.diff-area').style.color = (Math.abs(istA - sollA) < 0.1) ? '#2e7d32' : '#c62828';
            });
            document.getElementById('matrixSumCount').innerText = sumCnt; document.getElementById('matrixSumArea').innerText = formatNum(sumArea);
            document.getElementById('matrixIstCount').innerText = istTotalCnt; document.getElementById('matrixIstArea').innerText = formatNum(istTotalArea);
        }

        // --- HOUSE TYPE OVERVIEW (FIXED FOR SELECTION BUG) ---
        function onHausSelectionChange(isFirstLoad = false) { updateHausIdPreview(); updateHausTypeOverview(isFirstLoad); updateUnitLiveStatus(); }
        function updateHausIdPreview() { const oid = document.getElementById('hausObjektSelect').value; if(oid && !document.getElementById('hausIdInput').value) document.getElementById('hausNummerDisplay').value = getNextHausID(oid); }
        
        function updateHausTypeOverview(isFirstLoad) {
            const hid = document.getElementById('einheitHausSelect').value; 
            const container = document.getElementById('hausTypeOverview'); 
            const typeSelect = document.getElementById('einheitTypSelect');
            
            // --- FIX: Save current selection so it doesn't get lost on rebuild ---
            const currentSelection = typeSelect.value;
            
            container.innerHTML = ""; typeSelect.innerHTML = "";
            
            if(!hid) { container.innerHTML = '<span style="color:#666;">Kein Haus gew√§hlt.</span>'; return; }
            const h = dbHaeuser.get(hid); if(!h) return;
            const units = Array.from(dbEinheiten.values()).filter(u => u.hausId === hid);
            let availableTypes = [...STANDARD_TYPES];
            if(h.sollMatrix) Object.keys(h.sollMatrix).forEach(k => { if(!availableTypes.some(t => t.id === k)) availableTypes.push({ id: k, label: h.sollMatrix[k].label || "Custom" }); });
            
            availableTypes.forEach(t => typeSelect.add(new Option(t.label, t.id)));
            
            // --- FIX: Restore selection if it exists in the new list ---
            if(currentSelection && Array.from(typeSelect.options).some(o => o.value === currentSelection)) {
                typeSelect.value = currentSelection;
            }

            let html = ''; let foundAny = false; let firstOpenType = null;
            availableTypes.forEach(t => {
                const sollCnt = safeFloat(h.sollMatrix?.[t.id]?.count); const istCnt = units.filter(u => u.typ === t.id).length;
                if (sollCnt > 0 || istCnt > 0) {
                    foundAny = true; let cssClass = ""; let text = `${t.label}: ${istCnt} / ${sollCnt}`;
                    if (sollCnt > 0) { if (istCnt < sollCnt) { cssClass = "type-badge open"; if(!firstOpenType) firstOpenType = t.id; } else if (istCnt === sollCnt) { cssClass = "type-badge full"; } else { cssClass = "type-badge over"; } } else if (istCnt > 0) { cssClass = "type-badge over"; }
                    html += `<div class="${cssClass}" onclick="document.getElementById('einheitTypSelect').value='${t.id}'; updateUnitLiveStatus();">${text}</div>`;
                }
            });
            container.innerHTML = html || '<span style="color:#666; font-style:italic;">Keine Typen im Haus definiert.</span>';
            
            // Auto-Select only if NEW unit
            if(!document.getElementById('einheitIdInput').value && firstOpenType && isFirstLoad) typeSelect.value = firstOpenType;
            if(!document.getElementById('einheitIdInput').value) document.getElementById('einheitNummerDisplay').value = getNextEinheitID(hid);
        }
        function updateUnitLiveStatus() { /* (Simplified for brevity) */ document.getElementById('einheitLiveStatus').style.display = "none"; }
        function updateObjektLiveStatus() { /* (Simplified) */ }

        // --- RENDER LISTS & FILTER ---
        function switchTab(id) {
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active')); document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            const p = document.getElementById('panel' + id.charAt(0).toUpperCase() + id.slice(1)); if(p) p.classList.add('active');
            const btns = document.querySelectorAll('.tab-btn');
            if(id==='objekte'&&btns[0])btns[0].classList.add('active'); if(id==='haeuser'&&btns[1])btns[1].classList.add('active'); if(id==='einheiten'&&btns[2])btns[2].classList.add('active');
        }

        function renderLists() {
            const oSel = document.getElementById('hausObjektSelect'); const eObjSel = document.getElementById('einheitObjektSelect');
            if (oSel && eObjSel) { oSel.innerHTML = ""; eObjSel.innerHTML = "<option value=''>-- Objekt w√§hlen --</option>"; dbObjekte.forEach((o, id) => { oSel.add(new Option(`${o.name}`, id)); eObjSel.add(new Option(`${o.name}`, id)); }); }
            
            // Filter logic
            let showObj = dbObjekte; let showHaus = dbHaeuser; let showEin = dbEinheiten;
            if(activeFilterId) {
                showObj = new Map(); if(dbObjekte.has(activeFilterId)) showObj.set(activeFilterId, dbObjekte.get(activeFilterId));
                showHaus = new Map(Array.from(dbHaeuser.entries()).filter(([id, h]) => h.objektId === activeFilterId));
                const hausIds = Array.from(showHaus.keys());
                showEin = new Map(Array.from(dbEinheiten.entries()).filter(([id, e]) => hausIds.includes(e.hausId)));
            }

            // RENDER OBJEKTE (MIT VALIDIERUNG)
            const oDiv = document.getElementById('objekteListe'); oDiv.innerHTML = "";
            showObj.forEach((o, id) => { 
                // Abstimmung Objekt
                const haeuser = Array.from(dbHaeuser.values()).filter(h => h.objektId === id);
                let sumHausFlaeche = 0; let sumHausMea = haeuser.reduce((s,h) => s + safeFloat(h.anteile), 0);
                haeuser.forEach(h => { if(h.sollMatrix) Object.values(h.sollMatrix).forEach(v => sumHausFlaeche += safeFloat(v.area)); else sumHausFlaeche += (safeFloat(h.wohnflaeche)+safeFloat(h.gewerbeflaeche)); });
                
                let valHtml = validateVal(o.sollHaeuser || 0, haeuser.length, "H√§user", 0);
                valHtml += validateVal(o.flaeche || 0, sumHausFlaeche, "m¬≤");
                valHtml += validateVal(o.mea || 1000, sumHausMea, "MEA");

                const filterBtn = (activeFilterId === id) ? `<button class="filter-btn active" onclick="toggleFilter(null)">Filter l√∂sen</button>` : `<button class="filter-btn" onclick="toggleFilter('${id}')">üéØ Fokus</button>`;
                oDiv.innerHTML += `<div class="liste-item"><input type="checkbox" class="item-checkbox" value="${id}"><div class="liste-content"><div style="display:flex; justify-content:space-between; align-items:center;"><h4>${o.name} <small>[${o.nummer}]</small></h4><div>${filterBtn} <button onclick="openObjektMask('${id}')">Bearbeiten</button></div></div><div class="sub-info">${o.plz} ${o.ort}</div><div class="objekt-stats">${valHtml}</div></div></div>`; 
            });

            // RENDER H√ÑUSER (MIT VALIDIERUNG)
            const hDiv = document.getElementById('haeuserListe'); hDiv.innerHTML = "";
            showHaus.forEach((h, id) => { 
                // Abstimmung Haus
                const o = dbObjekte.get(h.objektId);
                const einheiten = Array.from(dbEinheiten.values()).filter(e => e.hausId === id);
                let valHtml = ""; let hasError = false;
                if(h.sollMatrix) {
                    Object.keys(h.sollMatrix).forEach(tid => {
                        const tLabel = h.sollMatrix[tid].label;
                        const sollCnt = safeFloat(h.sollMatrix[tid].count);
                        const sollArea = safeFloat(h.sollMatrix[tid].area);
                        if(sollCnt>0 || sollArea>0) {
                            const act = einheiten.filter(e => e.typ === tid);
                            const istCnt = act.length;
                            const istArea = act.reduce((s,e)=>s+safeFloat(e.flaeche),0);
                            if(istCnt!=sollCnt) { hasError=true; valHtml += `<div class="validation-row"><span class="stat-err">‚ö†Ô∏è ${tLabel} Anz: ${istCnt}/${sollCnt}</span></div>`; }
                            if(Math.abs(istArea-sollArea)>0.1) { hasError=true; valHtml += `<div class="validation-row"><span class="stat-err">‚ö†Ô∏è ${tLabel} Fl.: ${formatNum(istArea)}/${formatNum(sollArea)} m¬≤</span></div>`; }
                        }
                    });
                }
                const sumMea = einheiten.reduce((s,e)=>s+safeFloat(e.mea),0);
                valHtml += validateVal(h.anteile||0, sumMea, "MEA");
                if(!hasError && valHtml.indexOf('‚ö†Ô∏è')===-1) valHtml = '<div class="stat-ok">‚úÖ Alle Vorgaben erf√ºllt.</div>' + valHtml;

                hDiv.innerHTML += `<div class="liste-item"><input type="checkbox" class="item-checkbox" value="${id}"><div class="liste-content"><div style="display:flex; justify-content:space-between;"><h4>${h.bezeichnung}</h4><button onclick="openHausMask('${id}')">Bearbeiten</button></div><div class="objekt-stats">${valHtml}</div></div></div>`; 
            });

            // RENDER EINHEITEN (MIT KONTO BUTTON)
            const eDiv = document.getElementById('einheitenListe'); eDiv.innerHTML = "";
            const listE = Array.from(showEin.entries()).map(([id, e]) => { const h = dbHaeuser.get(e.hausId); const o = h ? dbObjekte.get(h.objektId) : null; return { id, ...e, hName: h?h.bezeichnung:'?', oName: o?o.name:'?' }; }).sort((a,b) => a.oName.localeCompare(b.oName) || a.hName.localeCompare(b.hName));
            
            const today = new Date().toISOString().split('T')[0];
            listE.forEach(e => {
                let stHtml = '<span class="status-leerstand">‚ö†Ô∏è LEERSTAND</span>';
                let isVermietet = false;
                if(e.belegung && e.belegung.length>0) {
                    const act = e.belegung.find(b => (b.einzug||'0000')<=today && (b.auszug||'9999')>=today);
                    const fut = e.belegung.find(b => (b.einzug||'0000')>today);
                    if(act) { 
                        const m=dbKontakte.get(act.mieterId); 
                        stHtml = `<span class="status-vermietet">‚úÖ ${m?m.fn:'?'}</span>`; 
                        isVermietet = true;
                    }
                    else if(fut) { const m=dbKontakte.get(fut.mieterId); stHtml = `<span class="status-zukunft">‚û°Ô∏è Ab ${formatDate(fut.einzug)}: ${m?m.fn:'?'}</span>`; }
                }
                
                // KONTO BUTTON nur wenn vermietet oder Historie da
                const kontoBtn = `<button class="account-btn" onclick="openKontoModal('${e.id}')">üí∂ Konto</button>`;
                
                eDiv.innerHTML += `<div class="liste-item"><input type="checkbox" class="item-checkbox" value="${e.id}"><div class="liste-content"><div style="display:flex; justify-content:space-between;"><h4>${e.name} <small>(${e.hName})</small></h4><div>${kontoBtn} <button onclick="openEinheitMask('${e.id}')">Bearbeiten</button></div></div><div class="sub-info">${formatNum(safeFloat(e.flaeche))}m¬≤</div><div class="mieter-status">${stHtml}</div></div></div>`;
            });
        }

        // --- CRUD MASKEN ---
        // (Objekt & Haus CRUD sind Standard und hier gek√ºrzt dargestellt, Einheit ist wichtig)
        function openObjektMask(id){ const o=id?dbObjekte.get(id):{}; document.getElementById('objektIdInput').value=id||""; document.getElementById('objektNummerInput').value=id || getNextObjektID(); document.getElementById('objektNameInput').value=o.name||""; document.getElementById('objektPlzInput').value=o.plz||""; document.getElementById('objektOrtInput').value=o.ort||""; document.getElementById('objektFlaecheInput').value=o.flaeche||""; document.getElementById('objektMeaInput').value=o.mea||"1000"; document.getElementById('objektSollHaeuser').value=o.sollHaeuser||"1"; updateObjektLiveStatus(); document.getElementById('objektModal').classList.add('active'); }
        function saveObjekt(){ let id=document.getElementById('objektNummerInput').value; if(!id) id=getNextObjektID(); dbObjekte.set(String(id), { nummer: id, name: document.getElementById('objektNameInput').value, plz: document.getElementById('objektPlzInput').value, ort: document.getElementById('objektOrtInput').value, flaeche: safeFloat(document.getElementById('objektFlaecheInput').value), mea: safeFloat(document.getElementById('objektMeaInput').value), sollHaeuser: safeFloat(document.getElementById('objektSollHaeuser').value) }); document.getElementById('objektModal').classList.remove('active'); saveLocal(); renderLists(); triggerAutoSave(); }
        function deleteObjekt(){ if(confirm("L√∂schen?")) { dbObjekte.delete(document.getElementById('objektIdInput').value); document.getElementById('objektModal').classList.remove('active'); saveLocal(); renderLists(); triggerAutoSave(); } }
        function openHausMask(id){ /* Standard... */ document.getElementById('hausIdInput').value=id||""; const sel=document.getElementById('hausObjektSelect'); sel.innerHTML=""; dbObjekte.forEach((o,oid)=>sel.add(new Option(o.name,oid))); const h=id?dbHaeuser.get(id):{}; if(h.objektId) sel.value=h.objektId; if(!id && sel.value) document.getElementById('hausNummerDisplay').value = getNextHausID(sel.value); else document.getElementById('hausNummerDisplay').value = id; document.getElementById('hausBezeichnungInput').value=h.bezeichnung||""; document.getElementById('hausAnteileInput').value=h.anteile||""; renderHausMatrix(h); calcMatrixSum(); document.getElementById('hausModal').classList.add('active'); }
        function saveHaus(){ /* Standard... */ let id=document.getElementById('hausNummerDisplay').value; if(!id) { const oid=document.getElementById('hausObjektSelect').value; id=getNextHausID(oid); } let mx={}; document.querySelectorAll('#hausSollMatrixBody tr').forEach(tr => { const tid = tr.dataset.typeId; const lblInput = tr.querySelector('.custom-label-inp'); const lbl = lblInput ? lblInput.value : tr.cells[0].innerText; const cnt = tr.querySelector('.soll-count').value; const area = tr.querySelector('.soll-area').value; if(cnt || area) { mx[tid] = { count: cnt, area: area, label: lbl }; } }); dbHaeuser.set(String(id), { objektId: document.getElementById('hausObjektSelect').value, bezeichnung: document.getElementById('hausBezeichnungInput').value, anteile: safeFloat(document.getElementById('hausAnteileInput').value), sollMatrix: mx }); document.getElementById('hausModal').classList.remove('active'); saveLocal(); renderLists(); triggerAutoSave(); }
        function deleteHaus(){ if(confirm("L√∂schen?")) { dbHaeuser.delete(document.getElementById('hausIdInput').value); document.getElementById('hausModal').classList.remove('active'); saveLocal(); renderLists(); triggerAutoSave(); } }

        function filterHaeuserDropdown(){ const oid=document.getElementById('einheitObjektSelect').value; const h=document.getElementById('einheitHausSelect'); h.innerHTML=""; if(!oid)return; Array.from(dbHaeuser.entries()).filter(([hid,x])=>x.objektId===oid).forEach(([hid,x])=>h.add(new Option(x.bezeichnung,hid))); }
        
        // --- EINHEIT MASKE (FIXED FOR TYPE DISPLAY) ---
        function openEinheitMask(id){
            updateKonditionDatalist();

            const e=id?dbEinheiten.get(id):{}; document.getElementById('einheitIdInput').value=id||"";
            const oSel=document.getElementById('einheitObjektSelect'); const hSel=document.getElementById('einheitHausSelect');
            let hid=e.hausId; let oid=hid?dbHaeuser.get(hid)?.objektId:"";
            if(oid) oSel.value=oid; else if(oSel.options.length>0) oSel.selectedIndex=0; filterHaeuserDropdown();
            if(hid) hSel.value=hid; else if(hSel.options.length>0) hSel.selectedIndex=0;
            if(id) document.getElementById('einheitNummerDisplay').value = id;
            
            document.getElementById('einheitNameInput').value=e.name||""; 
            
            // Populate Types initially
            document.getElementById('einheitTypSelect').innerHTML=""; 
            STANDARD_TYPES.forEach(t=>document.getElementById('einheitTypSelect').add(new Option(t.label,t.id)));
            
            // --- FIX MOVED: Do not set value yet, it will be wiped by onHausSelectionChange ---
            
            document.getElementById('einheitFlaecheInput').value=e.flaeche||""; document.getElementById('einheitHeizflaecheInput').value=e.heizflaeche||"";
            document.getElementById('einheitZimmerInput').value=e.zimmer||""; document.getElementById('einheitMeaInput').value=e.mea||"";
            
            // Wasser Info Felder
            document.getElementById('einheitWwInput').value = e.ww_m3 || "";
            document.getElementById('einheitKwInput').value = e.kw_m3 || "";

            // Belegung
            const c=document.getElementById('belegungListe'); c.innerHTML=""; 
            if(e.belegung&&e.belegung.length) e.belegung.forEach(b=>addBelegungRow(b)); else addBelegungRow();
            
            // Historie
            const hList = document.getElementById('historieListe'); hList.innerHTML="";
            if(e.historie && e.historie.length) e.historie.forEach(h=>addHistorieRow(h));
            
            // Konditionen
            const kList = document.getElementById('konditionenListe'); kList.innerHTML="";
            if(e.konditionen && e.konditionen.length) e.konditionen.forEach(k=>addKonditionRow(k)); else addKonditionRow();

            // Rebuild dropdowns based on House
            onHausSelectionChange(!id);

            // --- FIX: SET VALUE NOW, AFTER DROPDOWN IS REBUILT ---
            if(e.typ) document.getElementById('einheitTypSelect').value = e.typ;

            document.getElementById('einheitModal').classList.add('active');
        }

        // --- NEU: Dynamische Datalist-Funktion ---
        function updateKonditionDatalist() {
            // Sammle alle Standard-Typen
            const allTypes = new Set(KONDITION_TYPES);
            
            // Scanne alle vorhandenen Einheiten nach benutzerdefinierten Konditionen
            dbEinheiten.forEach(e => {
                if(e.konditionen) {
                    e.konditionen.forEach(k => {
                        if(k.label) allTypes.add(k.label);
                    });
                }
            });

            // Pr√ºfe oder erstelle Datalist
            let dl = document.getElementById('konditionTypes');
            if(!dl) {
                dl = document.createElement('datalist');
                dl.id = "konditionTypes";
                document.body.appendChild(dl);
            }
            
            // Neu bef√ºllen
            dl.innerHTML = "";
            Array.from(allTypes).sort().forEach(t => {
                const op = document.createElement('option');
                op.value = t;
                dl.appendChild(op);
            });
        }
        
        function addKonditionRow(d={}) {
            const c = document.getElementById('konditionenListe');
            const row = document.createElement('div'); row.className = 'kondition-row';
            
            // Bezeichnung 
            const descInput = document.createElement('input'); 
            descInput.setAttribute('list', 'konditionTypes'); 
            descInput.placeholder = "W√§hlen oder tippen..."; // Text angepasst
            descInput.className="kond-label";
            if(d.label) descInput.value = d.label;
            
            // Betrag
            const betragInput = document.createElement('input'); 
            betragInput.type="number"; betragInput.step="0.01"; betragInput.placeholder="Betrag ‚Ç¨"; 
            betragInput.className="kond-betrag";
            if(d.betrag) betragInput.value = d.betrag;

            // Konto
            const kontoInput = document.createElement('input'); 
            kontoInput.type="text"; kontoInput.placeholder="Konto (z.B. 8000)"; 
            kontoInput.className="kond-konto";
            if(d.konto) kontoInput.value = d.konto;
            
            // G√ºltig Ab
            const dateInput = document.createElement('input'); 
            dateInput.type="date"; 
            dateInput.className="kond-date";
            if(d.gueltigAb) dateInput.value = d.gueltigAb; else dateInput.value = new Date().toISOString().split('T')[0];

            const delBtn = document.createElement('button'); 
            delBtn.innerText="X"; delBtn.className="warn-btn"; delBtn.style.padding="2px 5px";
            delBtn.onclick = () => row.remove();

            row.append(descInput, betragInput, kontoInput, dateInput, delBtn);
            c.appendChild(row);
        }

        function addBelegungRow(d={}){ 
            const c=document.getElementById('belegungListe'); 
            const wrapper = document.createElement('div'); wrapper.className = 'belegung-wrapper';
            const r=document.createElement('div'); r.className='belegung-row'; 
            const s=document.createElement('select'); s.className='belegung-mieter'; 
            s.innerHTML="<option value=''>-- Mieter --</option>";
            Array.from(dbKontakte.entries()).sort((a,b)=>(a[1].fn||"").localeCompare(b[1].fn||"")).forEach(([id,k])=>s.add(new Option(k.fn+(k.org?` (${k.org})`:""),id)));
            if(d.mieterId) s.value=d.mieterId;
            const inEin=document.createElement('input'); inEin.type="date"; inEin.className="belegung-einzug"; if(d.einzug) inEin.value=d.einzug;
            const inAus=document.createElement('input'); inAus.type="date"; inAus.className="belegung-auszug"; if(d.auszug) inAus.value=d.auszug;
            const b=document.createElement('button'); b.className="warn-btn"; b.innerText="X"; b.onclick=()=>wrapper.remove();
            r.append(s,inEin,inAus,b); 
            wrapper.appendChild(r); c.appendChild(wrapper);
        }

        function addHistorieRow(d={}){
            const c=document.getElementById('historieListe');
            const r=document.createElement('div'); r.className='historie-row';
            const inDate = document.createElement('input'); inDate.type="date"; inDate.className="hist-date"; if(d.date) inDate.value=d.date;
            const inText = document.createElement('input'); inText.type="text"; inText.className="hist-desc"; inText.placeholder="Beschreibung..."; if(d.text) inText.value=d.text;
            const b=document.createElement('button'); b.className="warn-btn"; b.innerText="X"; b.onclick=()=>r.remove();
            r.append(inDate, inText, b); c.appendChild(r);
        }

        function saveEinheit(){
            let id=document.getElementById('einheitNummerDisplay').value; 
            if(!id) { const hid=document.getElementById('einheitHausSelect').value; id=getNextEinheitID(hid); }
            
            // Belegung sammeln
            const bel=[]; document.querySelectorAll('#belegungListe .belegung-wrapper').forEach(w=>{ const m=w.querySelector('.belegung-mieter').value; if(m) bel.push({mieterId:m, einzug:w.querySelector('.belegung-einzug').value, auszug:w.querySelector('.belegung-auszug').value}); });
            
            // Historie sammeln
            const hist=[]; document.querySelectorAll('#historieListe .historie-row').forEach(r=>{ const d = r.querySelector('.hist-date').value; const t = r.querySelector('.hist-desc').value; if(d || t) hist.push({date:d, text:t}); });
            
            // Konditionen sammeln (NEU)
            const kond=[]; 
            document.querySelectorAll('#konditionenListe .kondition-row').forEach(r=>{ 
                const l = r.querySelector('.kond-label').value; 
                const b = safeFloat(r.querySelector('.kond-betrag').value);
                const k = r.querySelector('.kond-konto').value;
                const d = r.querySelector('.kond-date').value;
                if(l && b) kond.push({ label:l, betrag:b, konto:k, gueltigAb:d });
            });

            dbEinheiten.set(String(id), { 
                hausId: document.getElementById('einheitHausSelect').value, 
                name: document.getElementById('einheitNameInput').value, 
                typ: document.getElementById('einheitTypSelect').value, 
                flaeche: safeFloat(document.getElementById('einheitFlaecheInput').value), 
                heizflaeche: safeFloat(document.getElementById('einheitHeizflaecheInput').value), 
                zimmer: document.getElementById('einheitZimmerInput').value, 
                mea: safeFloat(document.getElementById('einheitMeaInput').value), 
                // Neue Felder
                ww_m3: safeFloat(document.getElementById('einheitWwInput').value),
                kw_m3: safeFloat(document.getElementById('einheitKwInput').value),
                konditionen: kond,
                belegung: bel, 
                historie: hist 
            });
            document.getElementById('einheitModal').classList.remove('active'); saveLocal(); renderLists(); triggerAutoSave();
        }
        function deleteEinheit(){ if(confirm("L√∂schen?")) { dbEinheiten.delete(document.getElementById('einheitIdInput').value); document.getElementById('einheitModal').classList.remove('active'); saveLocal(); renderLists(); triggerAutoSave(); } }

        // =========================================================================
        // === SOLLSTELLUNG / FINANZ-MODUL ===
        // =========================================================================

        function openSollstellungModal() {
            document.getElementById('sollMonatInput').value = new Date().toISOString().slice(0, 7);
            document.getElementById('sollLog').style.display = 'none';
            document.getElementById('sollLog').innerHTML = '';
            document.getElementById('sollstellungModal').classList.add('active');
        }

        function logSoll(msg) {
            const l = document.getElementById('sollLog');
            l.style.display = 'block';
            l.innerHTML += `<div>${msg}</div>`;
            l.scrollTop = l.scrollHeight;
        }

        function runSollstellung() {
            const monatStr = document.getElementById('sollMonatInput').value; // "YYYY-MM"
            if(!monatStr) return alert("Bitte Monat w√§hlen");
            
            const [jahr, monat] = monatStr.split('-').map(Number);
            const daysInMonth = new Date(jahr, monat, 0).getDate(); // z.B. 31
            const monthStart = new Date(jahr, monat - 1, 1);
            const monthEnd = new Date(jahr, monat - 1, daysInMonth);

            logSoll(`>> Starte Lauf f√ºr ${monat}/${jahr} (${daysInMonth} Tage)`);
            
            let count = 0;

            dbEinheiten.forEach((e, eid) => {
                // 1. Aktiven Mieter finden
                if(!e.belegung || !e.belegung.length) return;
                
                // Wir pr√ºfen alle Belegungen, falls es Wechsel im Monat gibt
                e.belegung.forEach(b => {
                    const einzug = new Date(b.einzug);
                    const auszug = b.auszug ? new Date(b.auszug) : new Date('2099-12-31');

                    // Check Overlap
                    if(einzug <= monthEnd && auszug >= monthStart) {
                        // Schnittmenge berechnen
                        const start = einzug > monthStart ? einzug : monthStart;
                        const end = auszug < monthEnd ? auszug : monthEnd;
                        
                        // Taggenaue Berechnung (Inklusive Start und Endtag)
                        const diffTime = Math.abs(end - start);
                        const activeDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1; 
                        
                        // Nur wenn > 0 Tage
                        if(activeDays > 0) {
                            const faktor = activeDays / daysInMonth;
                            const mieter = dbKontakte.get(b.mieterId);
                            const mieterName = mieter ? mieter.fn : "Unbekannt";
                            
                            logSoll(`   Einheit ${e.name}: Mieter ${mieterName} (${activeDays}/${daysInMonth} Tage)`);

                            // Konditionen iterieren
                            if(e.konditionen) e.konditionen.forEach(k => {
                                // Pr√ºfen ob Kondition g√ºltig ist
                                const gueltigAb = new Date(k.gueltigAb);
                                if(gueltigAb <= monthEnd) {
                                    const betrag = safeFloat(k.betrag) * faktor;
                                    
                                    // Eintrag erstellen
                                    const tx = {
                                        id: getNextFinanzId(),
                                        einheitId: eid,
                                        mieterId: b.mieterId,
                                        monatRef: monatStr,
                                        buchungsdatum: new Date().toISOString().split('T')[0],
                                        typ: 'soll', // Forderung
                                        kategorie: k.label,
                                        text: `Sollstellung ${monat}/${jahr} (${k.label}) - ${activeDays} Tage`,
                                        betrag: betrag,
                                        konto: k.konto,
                                        locked: true // FESTGESCHRIEBEN: Kann nicht gel√∂scht werden
                                    };
                                    
                                    dbFinanzen.push(tx);
                                    count++;
                                }
                            });
                        }
                    }
                });
            });

            logSoll(`>> Fertig. ${count} Buchungen generiert.`);
            saveLocal();
            triggerAutoSave();
            alert(`Sollstellung abgeschlossen.\n${count} Buchungen erstellt.`);
        }

        // =========================================================================
        // === MIETERKONTO ===
        // =========================================================================
        
        function openKontoModal(einheitId) {
            const e = dbEinheiten.get(einheitId);
            if(!e) return;
            
            document.getElementById('kontoEinheitId').value = einheitId;
            document.getElementById('kontoTitle').innerText = `Konto: ${e.name}`;
            document.getElementById('manuelleBuchungForm').style.display = 'none';

            // Jahre f√ºllen
            const years = new Set(dbFinanzen.filter(tx => tx.einheitId === einheitId).map(tx => tx.buchungsdatum.substr(0,4)));
            const sel = document.getElementById('kontoJahrSelect');
            sel.innerHTML = '<option value="all">Alle Jahre</option>';
            Array.from(years).sort().reverse().forEach(y => sel.add(new Option(y, y)));
            
            renderKontoTable();
            document.getElementById('kontoModal').classList.add('active');
        }

        function renderKontoTable() {
            const eid = document.getElementById('kontoEinheitId').value;
            const yearFilter = document.getElementById('kontoJahrSelect').value;
            const tbody = document.getElementById('kontoBody');
            tbody.innerHTML = "";

            let txs = dbFinanzen.filter(tx => tx.einheitId === eid);
            if(yearFilter !== 'all') txs = txs.filter(tx => tx.buchungsdatum.startsWith(yearFilter));

            // Sortieren nach Datum
            txs.sort((a,b) => a.buchungsdatum.localeCompare(b.buchungsdatum));

            let sumS = 0, sumH = 0, saldo = 0;

            txs.forEach(tx => {
                const tr = document.createElement('tr');
                const s = tx.typ === 'soll' ? safeFloat(tx.betrag) : 0;
                const h = tx.typ === 'haben' ? safeFloat(tx.betrag) : 0;
                
                sumS += s; sumH += h;
                saldo += (s - h); // Soll erh√∂ht Forderung (positiv im Saldo wenn Schuld)

                let delBtn = `<button class="warn-btn" style="padding:2px 5px;" onclick="deleteBuchung('${tx.id}')">x</button>`;
                if(tx.locked) {
                    delBtn = `<span style="font-size:1.2em;" title="Sollstellung: Festgeschrieben">üîí</span>`;
                }

                tr.innerHTML = `
                    <td>${formatDate(tx.buchungsdatum)}</td>
                    <td>${tx.text} <small style="color:#888;">[${tx.kategorie||'-'}]</small></td>
                    <td class="text-right betrag-soll">${s > 0 ? formatNum(s) : ''}</td>
                    <td class="text-right betrag-haben">${h > 0 ? formatNum(h) : ''}</td>
                    <td class="text-right" style="font-weight:bold;">${formatNum(saldo)}</td>
                    <td>${delBtn}</td>
                `;
                tbody.appendChild(tr);
            });

            document.getElementById('sumSoll').innerText = formatCurrency(sumS);
            document.getElementById('sumHaben').innerText = formatCurrency(sumH);
            const elSaldo = document.getElementById('sumSaldo');
            elSaldo.innerText = formatCurrency(saldo);
            elSaldo.style.color = saldo > 0 ? '#c62828' : (saldo < 0 ? '#2e7d32' : 'black');
        }

        function openManuelleBuchung() {
            document.getElementById('manuelleBuchungForm').style.display='block';
            document.getElementById('mbDatum').value = new Date().toISOString().split('T')[0];
        }

        function saveManuelleBuchung() {
            const eid = document.getElementById('kontoEinheitId').value;
            const dat = document.getElementById('mbDatum').value;
            const txt = document.getElementById('mbText').value;
            const typ = document.getElementById('mbTyp').value;
            const betrag = safeFloat(document.getElementById('mbBetrag').value);

            if(!dat || !betrag) return alert("Datum und Betrag erforderlich");

            const tx = {
                id: getNextFinanzId(),
                einheitId: eid,
                mieterId: "manuell",
                monatRef: dat.substr(0,7),
                buchungsdatum: dat,
                typ: typ,
                kategorie: "Manuell",
                text: txt || "Manuelle Buchung",
                betrag: betrag,
                konto: "",
                locked: false // Manuelle Buchungen sind l√∂schbar
            };
            dbFinanzen.push(tx);
            saveLocal(); triggerAutoSave();
            renderKontoTable();
            document.getElementById('manuelleBuchungForm').style.display='none';
        }

        function deleteBuchung(id) {
            const tx = dbFinanzen.find(t => t.id === id);
            if(tx && tx.locked) {
                alert("Diese Buchung entstammt einer festgeschriebenen Sollstellung und darf nicht gel√∂scht werden!\nBitte nutzen Sie eine Gegenbuchung zur Korrektur.");
                return;
            }
            if(!confirm("Buchung l√∂schen?")) return;
            dbFinanzen = dbFinanzen.filter(tx => tx.id !== id);
            saveLocal(); triggerAutoSave();
            renderKontoTable();
        }

        function resetKonto() {
            const eid = document.getElementById('kontoEinheitId').value;
            if(!confirm("ACHTUNG: M√∂chten Sie wirklich ALLE Buchungen dieser Einheit l√∂schen?\nDas ist sinnvoll, um Testdaten zu entfernen, bevor Sie echt starten.\nDieser Schritt kann nicht r√ºckg√§ngig gemacht werden!")) return;
            
            // L√∂sche alle Buchungen dieser Einheit
            dbFinanzen = dbFinanzen.filter(tx => tx.einheitId !== eid);
            saveLocal(); triggerAutoSave();
            renderKontoTable();
            alert("Konto wurde erfolgreich geleert/bereinigt.");
        }

        function exportKontoPDF() {
            const eid = document.getElementById('kontoEinheitId').value;
            const e = dbEinheiten.get(eid);
            const doc = new jspdf.jsPDF();
            
            doc.setFontSize(14);
            doc.text(`Mieterkonto: ${e.name}`, 14, 15);
            doc.setFontSize(10);
            doc.text(`Stand: ${new Date().toLocaleDateString('de-DE')}`, 14, 22);

            // Daten sammeln (identisch zu renderTable logic)
            let txs = dbFinanzen.filter(tx => tx.einheitId === eid);
            txs.sort((a,b) => a.buchungsdatum.localeCompare(b.buchungsdatum));
            
            let saldo = 0;
            const rows = txs.map(tx => {
                const s = tx.typ === 'soll' ? safeFloat(tx.betrag) : 0;
                const h = tx.typ === 'haben' ? safeFloat(tx.betrag) : 0;
                saldo += (s - h);
                return [
                    formatDate(tx.buchungsdatum),
                    tx.text,
                    tx.kategorie,
                    s > 0 ? formatNum(s) : '',
                    h > 0 ? formatNum(h) : '',
                    formatNum(saldo)
                ];
            });

            doc.autoTable({
                head: [['Datum', 'Text', 'Kat', 'Soll', 'Haben', 'Saldo']],
                body: rows,
                startY: 30,
                theme: 'striped',
                columnStyles: {
                    3: { halign: 'right' },
                    4: { halign: 'right' },
                    5: { halign: 'right', fontStyle: 'bold' }
                }
            });
            doc.save(`Konto_${e.name}.pdf`);
        }

        // --- STANDARD REPORTS (vorhanden) ---
        function getSelectedIds(containerId) { const checkboxes = document.querySelectorAll(`#${containerId} .item-checkbox:checked`); if(checkboxes.length === 0) return []; return Array.from(checkboxes).map(cb => cb.value); }
        function toggleAll(containerId, checked) { document.querySelectorAll(`#${containerId} .item-checkbox`).forEach(cb => cb.checked = checked); }
        function generateObjectReportPDF() { const ids=getSelectedIds('objekteListe'); const arr=ids.length?Array.from(dbObjekte.entries()).filter(([id])=>ids.includes(id)):Array.from(dbObjekte.entries()); const doc=new jspdf.jsPDF('l'); doc.text("Objekt-Statusbericht",14,15); const rows=arr.map(([id,o])=>{ const hArr=Array.from(dbHaeuser.values()).filter(h=>h.objektId===id); let sf=0; hArr.forEach(h=>{if(h.sollMatrix)Object.values(h.sollMatrix).forEach(v=>sf+=safeFloat(v.area));else sf+=(safeFloat(h.wohnflaeche)+safeFloat(h.gewerbeflaeche));}); return [o.nummer,o.name,`${hArr.length}/${o.sollHaeuser||0}`,`${formatNum(safeFloat(o.flaeche))} m¬≤`,`${formatNum(sf)} m¬≤`,Math.abs(sf-safeFloat(o.flaeche))>0.1?formatNum(sf-safeFloat(o.flaeche)):'OK']; }); doc.autoTable({head:[['Nr','Objekt','H√§user','Soll-Fl','Ist-Plan','Diff']],body:rows,startY:20}); doc.save('objekt_bericht.pdf'); }
        function generateHouseReportPDF() { const ids=getSelectedIds('haeuserListe'); const arr=ids.length?Array.from(dbHaeuser.entries()).filter(([id])=>ids.includes(id)):Array.from(dbHaeuser.entries()); const doc=new jspdf.jsPDF('l'); doc.text("Haus-Statusbericht",14,15); const rows=arr.map(([id,h])=>{ const uArr=Array.from(dbEinheiten.values()).filter(e=>e.hausId===id); let sF=0; if(h.sollMatrix)Object.values(h.sollMatrix).forEach(v=>sF+=safeFloat(v.area)); const iF=uArr.reduce((s,e)=>s+safeFloat(e.flaeche),0); return [h.bezeichnung,uArr.length,`${formatNum(sF)} m¬≤`,`${formatNum(iF)} m¬≤`,Math.abs(iF-sF)>0.1?formatNum(iF-sF):'OK']; }); doc.autoTable({head:[['Haus','Einheiten','Soll-Fl','Ist-Fl','Diff']],body:rows,startY:20}); doc.save('haus_bericht.pdf'); }
        function generateUnitReportPDF() { const ids=getSelectedIds('einheitenListe'); const arr=ids.length?Array.from(dbEinheiten.entries()).filter(([id])=>ids.includes(id)):Array.from(dbEinheiten.entries()); const doc=new jspdf.jsPDF('l'); doc.text("Vermietungsliste",14,15); const rows=arr.map(([id,e])=>{ const h=dbHaeuser.get(e.hausId); let st="LEERSTAND"; let mi=""; if(e.belegung&&e.belegung.length){ const act=e.belegung.find(b=>(b.einzug||'0000')<=new Date().toISOString().split('T')[0]&&(b.auszug||'9999')>=new Date().toISOString().split('T')[0]); if(act){ const m=dbKontakte.get(act.mieterId); st="Vermietet"; mi=m?m.fn:"?"; } } return [h?h.bezeichnung:'?',e.name,e.typ,`${formatNum(safeFloat(e.flaeche))} m¬≤`,st,mi]; }); doc.autoTable({head:[['Haus','Einheit','Typ','Fl√§che','Status','Mieter']],body:rows,startY:20,didParseCell:function(d){if(d.column.index===4&&d.cell.raw==='LEERSTAND')d.cell.styles.textColor=[200,0,0];}}); doc.save('vermietung.pdf'); }
    </script>
</body>
</html>