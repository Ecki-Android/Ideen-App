<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Objektverwaltung (Pro)</title>
    <script src="https://alcdn.msauth.net/browser/2.24.0/js/msal-browser.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; padding: 15px; background-color: #f4f7f6; margin: 0; }
        .app-header { background: white; padding: 15px; border-bottom: 1px solid #ddd; margin: -15px -15px 20px -15px; display: flex; flex-wrap: wrap; align-items: center; justify-content: space-between; gap: 10px; }
        .app-title { font-size: 1.2em; font-weight: bold; color: #2e7d32; margin: 0; }
        .cloud-actions { display: flex; gap: 10px; align-items: center; }
        button { padding: 8px 12px; font-size: 0.9em; border-radius: 4px; border: 1px solid #bbb; background: #eee; cursor: pointer; }
        button:hover { background: #ddd; }
        .primary-btn { background: #2e7d32; color: white; border-color: #1b5e20; }
        .warn-btn { background: #d9534f; color: white; border-color: #d43f3a; }
        .onedrive-btn { background: #0078d4; color: white; border-color: #005a9e; }
        
        .onedrive-status { display: none; padding: 6px 12px; border-radius: 4px; font-size: 0.9em; font-weight: 500;}
        .onedrive-status.saving { background-color: #e0f2fe; color: #0c4a6e; display: inline-block; border: 1px solid #bae6fd;}
        .onedrive-status.success { background-color: #dcfce7; color: #14532d; display: inline-block; border: 1px solid #bbf7d0;}
        .onedrive-status.error { background-color: #fee2e2; color: #991b1b; display: inline-block; border: 1px solid #fecaca;}
        
        .tab-bar { margin-bottom: 15px; display: flex; gap: 5px; flex-wrap: wrap;}
        .tab-btn { background: #f9f9f9; padding: 10px 15px; border-bottom: 3px solid transparent; cursor: pointer; border-radius: 4px 4px 0 0; }
        .tab-btn.active { border-bottom: 3px solid #2e7d32; font-weight: bold; background: white; }
        
        .panel { display: none; background: white; padding: 15px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .panel.active { display: block; }
        .liste-item { border: 1px solid #ddd; padding: 10px; margin-bottom: 10px; background: #fff; border-radius: 4px; }
        
        /* Stats & Validierung Styles */
        .objekt-stats { font-size: 0.85em; background: #fafafa; padding: 8px; border-radius: 4px; margin-top: 8px; border: 1px solid #eee; }
        .validation-row { display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding: 2px 0; }
        .validation-row:last-child { border-bottom: none; }
        
        .stat-ok { color: #2e7d32; font-weight: bold; }
        .stat-err { color: #d32f2f; font-weight: bold; }
        .warn-icon { margin-right: 5px; font-size: 1.1em; }

        /* Matrix Tabelle im Modal */
        .soll-matrix { width: 100%; border-collapse: collapse; font-size: 0.9em; margin-bottom: 15px; }
        .soll-matrix th { text-align: left; background: #eee; padding: 5px; border: 1px solid #ccc; }
        .soll-matrix td { border: 1px solid #ccc; padding: 5px; }
        .soll-matrix input { width: 100%; margin: 0; border: none; background: transparent; font-family: inherit; }
        .soll-matrix input:focus { background: #e8f0fe; outline: none; }

        /* Modal */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; justify-content: center; align-items: center; }
        .modal-overlay.active { display: flex; }
        .modal-content { background: white; padding: 25px; border-radius: 8px; width: 95%; max-width: 800px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); max-height: 90vh; overflow-y: auto; }
        .modal-content input, .modal-content select, .modal-content textarea { width: 100%; padding: 8px; margin-top: 5px; margin-bottom: 15px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
        .modal-actions { text-align: right; margin-top: 20px; }
        
        /* Belegungs-Liste */
        .belegung-container { border: 1px solid #eee; padding: 10px; background: #fafafa; border-radius: 4px; margin-bottom: 15px; max-height: 200px; overflow-y: auto; }
        .belegung-row { display: flex; gap: 5px; align-items: center; margin-bottom: 5px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        
        /* Badges */
        .badge { padding: 2px 6px; border-radius: 4px; font-size: 0.8em; font-weight: bold; margin-left: 5px; border: 1px solid #ccc; background: #f0f0f0; color: #333; }
        
        .mieter-status { margin-top: 8px; padding-top: 8px; border-top: 1px solid #eee; font-size: 0.95em; }
        .status-leerstand { color: #c62828; font-weight: bold; background: #ffebee; padding: 2px 6px; border-radius: 3px; display:inline-block; }
        .status-vermietet { color: #2e7d32; font-weight: bold; }
        .status-zukunft { color: #0277bd; font-style: italic; }

        h4 { margin: 0; padding: 0; }
        .sub-info { color: #666; font-size: 0.9em; margin-top: 4px; }
    </style>
</head>
<body>
    <div class="app-header">
        <div class="app-title">Objektverwaltung Pro</div>
        <div class="cloud-actions">
            <button id="msLoginBtn" onclick="handleMicrosoftLogin()" class="onedrive-btn">üîë Login</button>
            <button onclick="saveToOneDrive(true)">üíæ Speichern</button>
            <span id="onedriveStatus" class="onedrive-status"></span>
        </div>
    </div>

    <div style="max-width: 1200px; margin: 0 auto;">
        <div class="tab-bar">
            <button class="tab-btn active" onclick="switchTab('objekte')">üè† Objekte (Liegenschaft)</button>
            <button class="tab-btn" onclick="switchTab('haeuser')">üèòÔ∏è H√§user (Geb√§ude)</button>
            <button class="tab-btn" onclick="switchTab('einheiten')">üö™ Einheiten (Wohnungen)</button>
            <a href="kontakte.html" style="margin-left:auto; text-decoration:none;"><button>üë• Zu den Kontakten</button></a>
        </div>

        <!-- PANEL OBJEKTE -->
        <div id="panelObjekte" class="panel active">
            <button class="primary-btn" onclick="openObjektMask()">+ Neues Objekt anlegen</button>
            <div id="objekteListe" style="margin-top: 15px;"></div>
        </div>

        <!-- PANEL H√ÑUSER -->
        <div id="panelHaeuser" class="panel">
            <button class="primary-btn" onclick="openHausMask()">+ Neues Haus anlegen</button>
            <div id="haeuserListe" style="margin-top: 15px;"></div>
        </div>

        <!-- PANEL EINHEITEN -->
        <div id="panelEinheiten" class="panel">
            <button class="primary-btn" onclick="openEinheitMask()">+ Neue Einheit anlegen</button>
            <div id="einheitenListe" style="margin-top: 15px;"></div>
        </div>
    </div>

    <!-- ================= MODALS ================= -->

    <!-- Modal 1: Objekt -->
    <div id="objektModal" class="modal-overlay" onclick="if(event.target===this)this.classList.remove('active')">
        <div class="modal-content">
            <h3>Objekt bearbeiten</h3>
            <input type="hidden" id="objektIdInput">
            <div style="display:flex; gap:10px;">
                <div style="flex:1"><label>Objekt-Nr.*:</label><input type="text" id="objektNummerInput" placeholder="OBJ-001"></div>
                <div style="flex:2"><label>Bezeichnung / Adresse*:</label><input type="text" id="objektNameInput"></div>
            </div>
            <div style="display:flex; gap:10px;">
                <div style="flex:1;"><label>PLZ:</label><input type="text" id="objektPlzInput"></div>
                <div style="flex:2;"><label>Ort:</label><input type="text" id="objektOrtInput"></div>
            </div>
            
            <h4 style="margin-top:10px;border-bottom:1px solid #eee;">Gesamt-Vorgaben (Soll)</h4>
            <div style="display:flex; gap:10px;">
                <div style="flex:1;"><label>Anzahl H√§user:</label><input type="number" id="objektSollHaeuser" placeholder="1"></div>
                <div style="flex:1;"><label>Gesamtfl√§che (m¬≤):</label><input type="number" step="0.01" id="objektFlaecheInput"></div>
                <div style="flex:1;"><label>Gesamt MEA:</label><input type="number" step="0.001" id="objektMeaInput" value="1000"></div>
            </div>
            
            <div class="modal-actions">
                <button onclick="document.getElementById('objektModal').classList.remove('active')">Abbrechen</button>
                <button class="primary-btn" onclick="saveObjekt()">Speichern</button>
                <button class="warn-btn" onclick="deleteObjekt()" style="float:left;">L√∂schen</button>
            </div>
        </div>
    </div>

    <!-- Modal 2: Haus (MIT MATRIX) -->
    <div id="hausModal" class="modal-overlay" onclick="if(event.target===this)this.classList.remove('active')">
        <div class="modal-content">
            <h3>Haus bearbeiten</h3>
            <input type="hidden" id="hausIdInput">
            
            <div style="display:flex; gap:10px;">
                <div style="flex:1"><label>Geh√∂rt zu Objekt*:</label><select id="hausObjektSelect"></select></div>
                <div style="flex:2"><label>Hausbezeichnung*:</label><input type="text" id="hausBezeichnungInput"></div>
            </div>

            <h4 style="margin-top:15px; margin-bottom:5px;">Soll-Vorgaben & Validierung</h4>
            <p style="font-size:0.8em; color:#666; margin-top:0;">Bitte geben Sie hier die geplanten Einheiten und Fl√§chen ein. Diese werden gegen die tats√§chlich angelegten Einheiten gepr√ºft.</p>
            
            <table class="soll-matrix">
                <thead>
                    <tr>
                        <th style="width:40%;">Typ</th>
                        <th style="width:30%;">Soll-Anzahl (Stk)</th>
                        <th style="width:30%;">Soll-Fl√§che (m¬≤)</th>
                    </tr>
                </thead>
                <tbody id="hausSollMatrixBody">
                    <!-- Wird per JS gef√ºllt -->
                </tbody>
            </table>
            
            <div style="display:flex; gap:10px; margin-top:10px;">
                <div style="flex:1;"><label>Gesamt MEA (Soll):</label><input type="number" step="0.001" id="hausAnteileInput"></div>
            </div>

            <div class="modal-actions">
                <button onclick="document.getElementById('hausModal').classList.remove('active')">Abbrechen</button>
                <button class="primary-btn" onclick="saveHaus()">Speichern</button>
                <button class="warn-btn" onclick="deleteHaus()" style="float:left;">L√∂schen</button>
            </div>
        </div>
    </div>

    <!-- Modal 3: Einheit -->
    <div id="einheitModal" class="modal-overlay" onclick="if(event.target===this)this.classList.remove('active')">
        <div class="modal-content">
            <h3>Einheit bearbeiten</h3>
            <input type="hidden" id="einheitIdInput">
            
            <div style="display:flex; gap:10px;">
                <div style="flex:1;">
                    <label>Objekt w√§hlen*:</label>
                    <select id="einheitObjektSelect" onchange="filterHaeuserDropdown()"></select>
                </div>
                <div style="flex:1;">
                    <label>Haus w√§hlen*:</label>
                    <select id="einheitHausSelect"></select>
                </div>
            </div>
            
            <div style="display:flex; gap:10px;">
                <div style="flex:2;">
                    <label>Lage / Bezeichnung (z.B. EG Links)*:</label>
                    <input type="text" id="einheitNameInput">
                </div>
                <div style="flex:1;">
                    <label>Typ:</label>
                    <select id="einheitTypSelect">
                        <!-- Wird per JS gef√ºllt -->
                    </select>
                </div>
            </div>
            
            <div style="display:flex; gap:10px;">
                <div style="flex:1;"><label>Wohn-/Nutzfl√§che (m¬≤):</label><input type="number" step="0.01" id="einheitFlaecheInput"></div>
                <div style="flex:1;"><label>Heizfl√§che (m¬≤):</label><input type="number" step="0.01" id="einheitHeizflaecheInput"></div>
            </div>

            <div style="display:flex; gap:10px;">
                <div style="flex:1;"><label>Zimmer:</label><input type="number" step="0.5" id="einheitZimmerInput"></div>
                <div style="flex:1;"><label>MEA Anteil:</label><input type="number" step="0.001" id="einheitMeaInput"></div>
            </div>
            
            <h4 style="margin-top:15px; border-bottom:1px solid #eee;">Belegung / Mieterhistorie</h4>
            <div id="belegungListe" class="belegung-container"></div>
            <button type="button" onclick="addBelegungRow()" style="margin-top:0;">+ Mieterwechsel hinzuf√ºgen</button>

            <div class="modal-actions">
                <button onclick="document.getElementById('einheitModal').classList.remove('active')">Abbrechen</button>
                <button class="primary-btn" onclick="saveEinheit()">Speichern</button>
                <button class="warn-btn" onclick="deleteEinheit()" style="float:left;">L√∂schen</button>
            </div>
        </div>
    </div>

    <script>
        // --- DEFINITIONEN ---
        const UNIT_TYPES = [
            { id: 'wohnung', label: 'Wohnung' },
            { id: 'gewerbe', label: 'Gewerbe' },
            { id: 'halle', label: 'Gewerbe-Halle' },
            { id: 'geschaeft', label: 'Gesch√§ft' },
            { id: 'garage', label: 'Garage' },
            { id: 'parkplatz', label: 'Parkplatz' },
            { id: 'keller', label: 'Keller' },
            { id: 'garten', label: 'Garten' },
            { id: 'sonstige', label: 'Sonstige' }
        ];

        const msalConfig = { auth: { clientId: "c3cd3be4-3540-46dd-a24c-82eb6ed5542d", authority: "https://login.microsoftonline.com/common", redirectUri: window.location.origin + window.location.pathname } };
        let msalInstance, accessToken;
        
        let dbObjekte = new Map();
        let dbHaeuser = new Map();
        let dbEinheiten = new Map();
        let dbKontakte = new Map(); 

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', async () => {
            initUnitTypes();
            initHausMatrix();
            loadLocal(); 
            // Wrap in try-catch to prevent unhandled rejection during init
            try {
                renderLists();
            } catch (err) {
                console.error("Fehler beim Initial-Rendering:", err);
            }
            try {
                msalInstance = new msal.PublicClientApplication(msalConfig);
                await msalInstance.initialize();
                const acc = msalInstance.getAllAccounts()[0];
                if (acc) { 
                    msalInstance.setActiveAccount(acc); 
                    if(await getToken()) {
                        document.getElementById('msLoginBtn').style.display = 'none';
                        await loadFromOneDrive(); 
                    }
                }
            } catch(e) { console.error(e); }
        });

        function initUnitTypes() {
            const sel = document.getElementById('einheitTypSelect');
            if (sel) {
                sel.innerHTML = "";
                UNIT_TYPES.forEach(t => {
                    sel.add(new Option(t.label, t.id));
                });
            }
        }

        function initHausMatrix() {
            const tbody = document.getElementById('hausSollMatrixBody');
            if (tbody) {
                tbody.innerHTML = "";
                UNIT_TYPES.forEach(t => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${t.label}</td>
                        <td><input type="number" step="1" id="soll_count_${t.id}" placeholder="0"></td>
                        <td><input type="number" step="0.01" id="soll_area_${t.id}" placeholder="0.00"></td>
                    `;
                    tbody.appendChild(tr);
                });
            }
        }

        // --- AUTH & CLOUD ---
        async function handleMicrosoftLogin() {
            try {
                await msalInstance.loginPopup({ scopes: ["Files.ReadWrite"], prompt: "select_account" });
                if(await getToken()) {
                    document.getElementById('msLoginBtn').style.display = 'none';
                    await loadFromOneDrive();
                }
            } catch(e) { alert("Login fehlgeschlagen: " + e.message); }
        }
        async function getToken() {
            try { 
                const r = await msalInstance.acquireTokenSilent({ scopes: ["Files.ReadWrite"], account: msalInstance.getActiveAccount() }); 
                accessToken = r.accessToken; return true; 
            } catch(e) { 
                try { const r = await msalInstance.acquireTokenPopup({ scopes: ["Files.ReadWrite"] }); accessToken = r.accessToken; return true; } catch(err) { return false; }
            }
        }

        async function loadFromOneDrive() {
            if (!accessToken && !(await getToken())) return;
            showStatus("Lade Daten...", "saving");
            
            // Kontakte holen
            try {
                const resC = await fetch("https://graph.microsoft.com/v1.0/me/drive/root:/ideenapp/stammdaten.json:/content", { headers: { "Authorization": `Bearer ${accessToken}` } });
                if (resC.ok) { const dataC = await resC.json(); if(dataC.kontakte) dbKontakte = new Map(dataC.kontakte); }
            } catch(e) {}

            // Immobilien holen
            try {
                const resI = await fetch("https://graph.microsoft.com/v1.0/me/drive/root:/ideenapp/immobilien.json:/content", { headers: { "Authorization": `Bearer ${accessToken}` } });
                if (resI.ok) {
                    const dataI = await resI.json();
                    if(dataI.objekte) dbObjekte = new Map(dataI.objekte);
                    if(dataI.haeuser) dbHaeuser = new Map(dataI.haeuser);
                    if(dataI.einheiten) dbEinheiten = new Map(dataI.einheiten);
                    saveLocal(); renderLists(); showStatus("Daten geladen", "success");
                }
            } catch(e) { showStatus("Fehler/Neu: " + e.message, "error"); }
        }

        async function saveToOneDrive(manual) {
            if (!accessToken && !(await getToken())) { if(manual) alert("Bitte einloggen."); return; }
            showStatus("Speichere...", "saving");
            const data = { 
                objekte: Array.from(dbObjekte.entries()), 
                haeuser: Array.from(dbHaeuser.entries()),
                einheiten: Array.from(dbEinheiten.entries()),
                meta: { updated: new Date().toISOString() }
            };
            try {
                const res = await fetch("https://graph.microsoft.com/v1.0/me/drive/root:/ideenapp/immobilien.json:/content", { 
                    method: "PUT", headers: { "Authorization": `Bearer ${accessToken}`, "Content-Type": "application/json" }, body: JSON.stringify(data, null, 2)
                });
                if (res.ok) showStatus("Gespeichert", "success");
                else showStatus("Speicherfehler", "error");
            } catch(e) { showStatus("Fehler: " + e.message, "error"); }
        }

        function loadLocal() {
            try { 
                const o = localStorage.getItem("immo_objekte"); if(o) dbObjekte = new Map(JSON.parse(o));
                const h = localStorage.getItem("immo_haeuser"); if(h) dbHaeuser = new Map(JSON.parse(h));
                const e = localStorage.getItem("immo_einheiten"); if(e) dbEinheiten = new Map(JSON.parse(e));
            } catch(err) {}
        }
        function saveLocal() {
            localStorage.setItem("immo_objekte", JSON.stringify(Array.from(dbObjekte.entries())));
            localStorage.setItem("immo_haeuser", JSON.stringify(Array.from(dbHaeuser.entries())));
            localStorage.setItem("immo_einheiten", JSON.stringify(Array.from(dbEinheiten.entries())));
        }
        function showStatus(msg, type) { const s = document.getElementById('onedriveStatus'); s.textContent = msg; s.className = 'onedrive-status ' + type; s.style.display = 'inline-block'; setTimeout(() => { if(s.textContent===msg) s.style.display='none'; }, 4000); }

        // --- VALIDIERUNGS LOGIK ---
        
        function validateVal(soll, ist, unit = '', tolerance = 0.1) {
            soll = parseFloat(soll) || 0;
            ist = parseFloat(ist) || 0;
            const diff = ist - soll;
            const isOk = Math.abs(diff) <= tolerance;
            
            if(isOk) {
                return `<div class="validation-row"><span class="stat-ok">‚úÖ ${ist.toLocaleString()} ${unit} (Soll: ${soll.toLocaleString()})</span></div>`;
            } else {
                const diffStr = diff > 0 ? `+${diff.toLocaleString()}` : diff.toLocaleString();
                return `<div class="validation-row"><span class="stat-err">‚ö†Ô∏è ${ist.toLocaleString()} ${unit} (Soll: ${soll.toLocaleString()}) <br><small style="margin-left:22px;">Differenz: ${diffStr} ${unit}</small></span></div>`;
            }
        }

        // --- RENDER FUNCTIONS ---

        function switchTab(id) {
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            const panel = document.getElementById('panel' + id.charAt(0).toUpperCase() + id.slice(1));
            if (panel) panel.classList.add('active');
            const btns = document.querySelectorAll('.tab-btn');
            if(id==='objekte' && btns[0]) btns[0].classList.add('active');
            if(id==='haeuser' && btns[1]) btns[1].classList.add('active');
            if(id==='einheiten' && btns[2]) btns[2].classList.add('active');
        }

        function renderLists() {
            const oSel = document.getElementById('hausObjektSelect'); 
            const eObjSel = document.getElementById('einheitObjektSelect');
            
            // Safety check for dropdowns
            if (oSel && eObjSel) {
                oSel.innerHTML = ""; 
                eObjSel.innerHTML = "<option value=''>-- Objekt w√§hlen --</option>";
                dbObjekte.forEach((o, id) => {
                    oSel.add(new Option(`${o.name} [${o.nummer}]`, id));
                    eObjSel.add(new Option(`${o.name} [${o.nummer}]`, id));
                });
            }

            const mSel = document.getElementById('einheitMieterSelect'); 
            if (mSel) {
                mSel.innerHTML = "<option value=''>-- Leerstand / Keiner --</option>";
                const sortedKontakte = Array.from(dbKontakte.entries()).sort((a,b) => (a[1].fn||"").localeCompare(b[1].fn||""));
                sortedKontakte.forEach(([id, k]) => mSel.add(new Option(k.fn + (k.org ? ` (${k.org})` : ""), id)));
            }

            // 1. OBJEKTE
            const oDiv = document.getElementById('objekteListe'); 
            if (oDiv) {
                oDiv.innerHTML = "";
                dbObjekte.forEach((o, id) => {
                    const haeuser = Array.from(dbHaeuser.values()).filter(h => h.objektId === id);
                    
                    const allEinheiten = Array.from(dbEinheiten.values()).filter(e => haeuser.some(h => h.objektId === id && dbHaeuser.get(e.hausId)?.objektId === id));
                    let istHaeuser = haeuser.length;
                    let istFlaeche = allEinheiten.reduce((s,e) => s + (parseFloat(e.flaeche)||0), 0);
                    let istMea = allEinheiten.reduce((s,e) => s + (parseFloat(e.mea)||0), 0);

                    let valHtml = "";
                    valHtml += validateVal(o.sollHaeuser || 0, istHaeuser, "H√§user", 0);
                    valHtml += validateVal(o.flaeche || 0, istFlaeche, "m¬≤");
                    valHtml += validateVal(o.mea || 1000, istMea, "MEA");

                    oDiv.innerHTML += `
                    <div class="liste-item">
                        <div style="display:flex; justify-content:space-between;">
                            <h4>${o.name} <small style="color:#888;">[${o.nummer}]</small></h4>
                            <button onclick="openObjektMask('${id}')">Bearbeiten</button>
                        </div>
                        <div class="sub-info">${o.plz} ${o.ort}</div>
                        <div class="objekt-stats">${valHtml}</div>
                    </div>`;
                });
            }

            // 2. H√ÑUSER (Detailed Check)
            const hDiv = document.getElementById('haeuserListe'); 
            if (hDiv) {
                hDiv.innerHTML = "";
                dbHaeuser.forEach((h, id) => {
                    const obj = dbObjekte.get(h.objektId);
                    const objName = obj ? obj.name : "??";
                    const einheiten = Array.from(dbEinheiten.values()).filter(e => e.hausId === id);

                    let valHtml = "";
                    let hasError = false;

                    // Loop through all defined Types
                    UNIT_TYPES.forEach(type => {
                        const sollCnt = h.sollMatrix?.[type.id]?.count || 0;
                        const sollArea = h.sollMatrix?.[type.id]?.area || 0;

                        if (sollCnt > 0 || sollArea > 0) {
                            const actualUnits = einheiten.filter(e => e.typ === type.id);
                            const istCnt = actualUnits.length;
                            const istArea = actualUnits.reduce((s,e) => s + (parseFloat(e.flaeche)||0), 0);

                            if (istCnt != sollCnt) {
                                hasError = true;
                                valHtml += `<div class="validation-row"><span class="stat-err">‚ö†Ô∏è ${type.label} Anzahl: ${istCnt}/${sollCnt} (Diff: ${istCnt-sollCnt})</span></div>`;
                            }
                            
                            if (Math.abs(istArea - sollArea) > 0.1) {
                                hasError = true;
                                const diff = istArea - sollArea;
                                valHtml += `<div class="validation-row"><span class="stat-err">‚ö†Ô∏è ${type.label} Fl√§che: ${istArea.toFixed(2)}/${parseFloat(sollArea).toFixed(2)} m¬≤ (Diff: ${diff.toFixed(2)})</span></div>`;
                            }
                        }
                    });
                    
                    const sumMea = einheiten.reduce((s,e) => s + (parseFloat(e.mea)||0), 0);
                    valHtml += validateVal(h.anteile || 0, sumMea, "MEA");

                    if (!hasError && valHtml.indexOf('‚ö†Ô∏è') === -1) {
                        valHtml = '<div class="stat-ok">‚úÖ Alle Typen, Anzahl & Fl√§chen korrekt.</div>' + valHtml;
                    }

                    hDiv.innerHTML += `
                    <div class="liste-item">
                        <div style="display:flex; justify-content:space-between;">
                            <h4>${h.bezeichnung} <small>in ${objName}</small></h4>
                            <button onclick="openHausMask('${id}')">Bearbeiten</button>
                        </div>
                        <div class="objekt-stats">${valHtml}</div>
                    </div>`;
                });
            }

            // 3. EINHEITEN
            const eDiv = document.getElementById('einheitenListe'); 
            if (eDiv) {
                eDiv.innerHTML = "";
                const listE = Array.from(dbEinheiten.entries()).map(([id, e]) => {
                    const h = dbHaeuser.get(e.hausId);
                    const o = h ? dbObjekte.get(h.objektId) : null;
                    return { id, ...e, hausName: h ? h.bezeichnung : "??", objName: o ? o.name : "??" };
                }).sort((a,b) => a.objName.localeCompare(b.objName) || a.hausName.localeCompare(b.hausName));

                const today = new Date().toISOString().split('T')[0];

                listE.forEach(e => {
                    const typeObj = UNIT_TYPES.find(t => t.id === e.typ);
                    const typeLabel = typeObj ? typeObj.label : e.typ;
                    
                    let statusHtml = '<span class="status-leerstand">‚ö†Ô∏è LEERSTAND</span>';
                    if (e.belegung && e.belegung.length > 0) {
                        const active = e.belegung.find(b => {
                            const start = b.einzug || '0000-00-00';
                            const end = b.auszug || '9999-12-31';
                            return start <= today && end >= today;
                        });
                        const future = e.belegung.find(b => (b.einzug || '0000-00-00') > today);

                        if (active) {
                            const m = dbKontakte.get(active.mieterId);
                            statusHtml = `<span class="status-vermietet">‚úÖ ${m?m.fn:'?'}</span> <span style="color:#666;font-size:0.8em;">(seit ${formatDate(active.einzug)})</span>`;
                        } else if (future) {
                            const m = dbKontakte.get(future.mieterId);
                            statusHtml = `<span class="status-leerstand">‚ö†Ô∏è LEERSTAND</span> <span class="status-zukunft">‚û°Ô∏è Ab ${formatDate(future.einzug)}: ${m?m.fn:'?'}</span>`;
                        }
                    }

                    eDiv.innerHTML += `
                    <div class="liste-item">
                        <div style="display:flex; justify-content:space-between;">
                            <h4>${e.name} <span class="badge">${typeLabel}</span> <small>(${e.hausName})</small></h4>
                            <button onclick="openEinheitMask('${e.id}')">Bearbeiten</button>
                        </div>
                        <div class="sub-info">Fl√§che: ${e.flaeche}m¬≤ | Zimmer: ${e.zimmer} | MEA: ${e.mea}</div>
                        <div class="mieter-status">${statusHtml}</div>
                    </div>`;
                });
            }
        }

        // --- CRUD OBJEKTE ---
        function openObjektMask(id){
            const o = id ? dbObjekte.get(id) : {};
            document.getElementById('objektIdInput').value = id||"";
            document.getElementById('objektNummerInput').value = o.nummer||"";
            document.getElementById('objektNameInput').value = o.name||"";
            document.getElementById('objektPlzInput').value = o.plz||"";
            document.getElementById('objektOrtInput').value = o.ort||"";
            document.getElementById('objektFlaecheInput').value = o.flaeche||"";
            document.getElementById('objektMeaInput').value = o.mea||"1000";
            document.getElementById('objektSollHaeuser').value = o.sollHaeuser||"1";
            document.getElementById('objektModal').classList.add('active');
        }
        function saveObjekt(){
            let id = document.getElementById('objektIdInput').value || 'o_'+Date.now();
            dbObjekte.set(String(id), {
                nummer: document.getElementById('objektNummerInput').value,
                name: document.getElementById('objektNameInput').value,
                plz: document.getElementById('objektPlzInput').value,
                ort: document.getElementById('objektOrtInput').value,
                flaeche: document.getElementById('objektFlaecheInput').value,
                mea: document.getElementById('objektMeaInput').value,
                sollHaeuser: document.getElementById('objektSollHaeuser').value
            });
            document.getElementById('objektModal').classList.remove('active');
            saveLocal(); renderLists(); saveToOneDrive(false);
        }
        function deleteObjekt(){
            const id = document.getElementById('objektIdInput').value;
            const hasH = Array.from(dbHaeuser.values()).some(h => h.objektId === id);
            if(hasH) return alert("Objekt hat noch H√§user. Bitte erst diese l√∂schen.");
            if(confirm("L√∂schen?")) { dbObjekte.delete(id); document.getElementById('objektModal').classList.remove('active'); saveLocal(); renderLists(); saveToOneDrive(false); }
        }

        // --- CRUD H√ÑUSER ---
        function openHausMask(id){
            if(dbObjekte.size===0) return alert("Erst Objekt anlegen.");
            const h = id ? dbHaeuser.get(id) : {};
            document.getElementById('hausIdInput').value = id||"";
            
            const sel = document.getElementById('hausObjektSelect'); sel.innerHTML="";
            dbObjekte.forEach((o, oid) => sel.add(new Option(o.name, oid)));
            if(h.objektId) sel.value = h.objektId;

            document.getElementById('hausBezeichnungInput').value = h.bezeichnung||"";
            document.getElementById('hausAnteileInput').value = h.anteile||"";

            // Matrix f√ºllen
            UNIT_TYPES.forEach(t => {
                const cnt = h.sollMatrix?.[t.id]?.count || "";
                const area = h.sollMatrix?.[t.id]?.area || "";
                const elCnt = document.getElementById(`soll_count_${t.id}`);
                const elArea = document.getElementById(`soll_area_${t.id}`);
                if (elCnt) elCnt.value = cnt;
                if (elArea) elArea.value = area;
            });
            
            document.getElementById('hausModal').classList.add('active');
        }
        function saveHaus(){
            let id = document.getElementById('hausIdInput').value || 'h_'+Date.now();
            
            // Matrix auslesen
            let matrix = {};
            UNIT_TYPES.forEach(t => {
                const elCnt = document.getElementById(`soll_count_${t.id}`);
                const elArea = document.getElementById(`soll_area_${t.id}`);
                if (elCnt && elArea) {
                    matrix[t.id] = {
                        count: elCnt.value,
                        area: elArea.value
                    };
                }
            });

            dbHaeuser.set(String(id), {
                objektId: document.getElementById('hausObjektSelect').value,
                bezeichnung: document.getElementById('hausBezeichnungInput').value,
                anteile: document.getElementById('hausAnteileInput').value,
                sollMatrix: matrix
            });
            document.getElementById('hausModal').classList.remove('active');
            saveLocal(); renderLists(); saveToOneDrive(false);
        }
        function deleteHaus(){
            const id = document.getElementById('hausIdInput').value;
            const hasE = Array.from(dbEinheiten.values()).some(e => e.hausId === id);
            if(hasE) return alert("Haus hat noch Einheiten.");
            if(confirm("L√∂schen?")) { dbHaeuser.delete(id); document.getElementById('hausModal').classList.remove('active'); saveLocal(); renderLists(); saveToOneDrive(false); }
        }

        // --- CRUD EINHEITEN ---
        function filterHaeuserDropdown() {
            const oid = document.getElementById('einheitObjektSelect').value;
            const hSel = document.getElementById('einheitHausSelect');
            if (hSel) {
                hSel.innerHTML = "";
                if(!oid) { hSel.innerHTML="<option>Erst Objekt w√§hlen</option>"; return; }
                const haeuser = Array.from(dbHaeuser.entries()).filter(([hid, h]) => h.objektId === oid);
                haeuser.forEach(([hid, h]) => hSel.add(new Option(h.bezeichnung, hid)));
            }
        }

        function addBelegungRow(data = {}) {
            const container = document.getElementById('belegungListe');
            if (!container) return;
            const div = document.createElement('div');
            div.className = 'belegung-row';
            const sel = document.createElement('select');
            sel.className = 'belegung-mieter';
            sel.style.flex="2";
            sel.innerHTML = "<option value=''>-- Mieter w√§hlen --</option>";
            const sortedKontakte = Array.from(dbKontakte.entries()).sort((a,b) => (a[1].fn||"").localeCompare(b[1].fn||""));
            sortedKontakte.forEach(([id, k]) => sel.add(new Option(k.fn + (k.org ? ` (${k.org})` : ""), id)));
            if(data.mieterId) sel.value = data.mieterId;

            const inEin = document.createElement('input'); inEin.type="date"; inEin.className="belegung-einzug"; if(data.einzug) inEin.value=data.einzug;
            const inAus = document.createElement('input'); inAus.type="date"; inAus.className="belegung-auszug"; if(data.auszug) inAus.value=data.auszug;
            const btn = document.createElement('button'); btn.className="warn-btn"; btn.innerText="X"; btn.onclick = () => div.remove();
            div.append(sel, inEin, inAus, btn);
            container.appendChild(div);
        }

        function openEinheitMask(id){
            if(dbHaeuser.size===0) return alert("Bitte erst ein Haus anlegen.");
            const e = id ? dbEinheiten.get(id) : {};
            document.getElementById('einheitIdInput').value = id||"";
            
            const eObjSelect = document.getElementById('einheitObjektSelect');
            let hid = e.hausId; 
            let oid = hid ? dbHaeuser.get(hid)?.objektId : "";
            if(oid && eObjSelect) eObjSelect.value = oid; else if(eObjSelect) eObjSelect.selectedIndex = 0;
            filterHaeuserDropdown();
            const hSel = document.getElementById('einheitHausSelect');
            if(hid && hSel) hSel.value = hid;

            document.getElementById('einheitNameInput').value = e.name||"";
            document.getElementById('einheitTypSelect').value = e.typ||"wohnung";
            document.getElementById('einheitFlaecheInput').value = e.flaeche||"";
            document.getElementById('einheitHeizflaecheInput').value = e.heizflaeche||"";
            document.getElementById('einheitZimmerInput').value = e.zimmer||"";
            document.getElementById('einheitMeaInput').value = e.mea||"";
            
            const belContainer = document.getElementById('belegungListe');
            if (belContainer) {
                belContainer.innerHTML = "";
                if(e.belegung && Array.isArray(e.belegung)) e.belegung.forEach(b => addBelegungRow(b));
                else addBelegungRow();
            }

            document.getElementById('einheitModal').classList.add('active');
        }

        function saveEinheit(){
            const hid = document.getElementById('einheitHausSelect').value;
            const name = document.getElementById('einheitNameInput').value;
            if(!hid || !name) return alert("Haus und Name sind Pflicht.");
            
            let id = document.getElementById('einheitIdInput').value || 'e_'+Date.now();
            const belegung = [];
            document.querySelectorAll('#belegungListe .belegung-row').forEach(row => {
                const mId = row.querySelector('.belegung-mieter').value;
                if(mId) belegung.push({ mieterId: mId, einzug: row.querySelector('.belegung-einzug').value, auszug: row.querySelector('.belegung-auszug').value });
            });

            dbEinheiten.set(String(id), {
                hausId: hid,
                name: name,
                typ: document.getElementById('einheitTypSelect').value,
                flaeche: document.getElementById('einheitFlaecheInput').value,
                heizflaeche: document.getElementById('einheitHeizflaecheInput').value,
                zimmer: document.getElementById('einheitZimmerInput').value,
                mea: document.getElementById('einheitMeaInput').value,
                belegung: belegung
            });
            document.getElementById('einheitModal').classList.remove('active');
            saveLocal(); renderLists(); saveToOneDrive(false);
        }

        function deleteEinheit(){
            const id = document.getElementById('einheitIdInput').value;
            if(confirm("L√∂schen?")) { dbEinheiten.delete(id); document.getElementById('einheitModal').classList.remove('active'); saveLocal(); renderLists(); saveToOneDrive(false); }
        }

        function formatDate(isoStr) {
            if(!isoStr) return "";
            const parts = isoStr.split('-');
            return `${parts[2]}.${parts[1]}.${parts[0]}`;
        }
    </script>
</body>
</html>