<!-- 
    ===========================================================================
    PROJEKT: Hausverwaltung Pro (Enterprise Edition)
    VERSION: v16.9.35 (Release: Backup & DMS)
    DATUM:   2026-01-06
    STATUS:  STABLE
    
    BASIS: v16.9.34 (Repaired)
    
    CHANGELOG v16.9.35:
    - FEATURE: Lokales Backup-System (JSON Download/Upload) im Header.
      -> Ermöglicht Datensicherung auf Festplatte/USB.
    - FEATURE: DMS-Brücke (Smart-Link) zur Ideen-App.
      -> Button im Mietvertrag öffnet 'index.html?search=Name'.
    - MAINTENANCE: Versionierung aktualisiert.
    ===========================================================================
-->
<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hausverwaltung Pro v16.9.35 (Backup)</title>
    
    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://alcdn.msauth.net/browser/2.24.0/js/msal-browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root { --primary: #0f172a; --accent: #166534; --bg: #f8fafc; }
        body { font-family: 'Inter', system-ui, -apple-system, sans-serif; background-color: var(--bg); color: #334155; margin: 0; padding-bottom: 60px; }
        
        /* LAYOUT & UTILS */
        .glass-header { background: rgba(15, 23, 42, 0.98); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(255,255,255,0.1); }
        .nav-link { padding: 0.5rem 0.75rem; color: #94a3b8; font-weight: 500; font-size: 0.875rem; transition: all 0.2s; border-bottom: 2px solid transparent; cursor: pointer; }
        .nav-link:hover { color: white; }
        .nav-link.active { border-bottom-color: #4ade80; color: white; }

        .card { background: white; border-radius: 0.75rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; }
        .panel { display: none; }
        .panel.active { display: block; animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }

        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(15, 23, 42, 0.85); backdrop-filter: blur(4px); z-index: 1000; justify-content: center; align-items: center; padding: 1rem; }
        .modal-overlay.active { display: flex; }
        .modal-content { background: white; border-radius: 1rem; width: 100%; max-height: 95vh; overflow-y: auto; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); }

        /* TABS Styles */
        .unit-tab-btn { padding: 0.75rem 1rem; font-size: 0.75rem; font-weight: 700; border-bottom: 2px solid transparent; color: #64748b; }
        .unit-tab-btn.active { border-bottom-color: #4f46e5; color: #4338ca; background-color: #eef2ff; }
        .unit-tab-content.hidden { display: none; }

        /* NATIVE CSS REPLACEMENTS FOR @apply */
        .btn-primary { 
            background-color: #4338ca; color: white; padding: 0.5rem 1rem; border-radius: 0.5rem; 
            font-weight: 700; display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; 
            border: 1px solid #312e81; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); transition: background-color 0.2s;
        }
        .btn-primary:hover { background-color: #3730a3; }
        
        .btn-secondary { 
            background-color: #f1f5f9; color: #334155; padding: 0.5rem 1rem; border-radius: 0.5rem; 
            font-weight: 600; font-size: 0.875rem; border: 1px solid #cbd5e1; transition: background-color 0.2s;
        }
        .btn-secondary:hover { background-color: #e2e8f0; }

        .input-std { 
            width: 100%; border: 1px solid #cbd5e1; border-radius: 0.5rem; padding: 0.5rem; 
            font-size: 0.875rem; background-color: white; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); outline: none;
        }
        .input-std:focus { border-color: #6366f1; ring: 2px solid #e0e7ff; }

        .label-std { 
            font-size: 10px; font-weight: 900; text-transform: uppercase; color: #64748b; 
            margin-bottom: 0.25rem; display: block; letter-spacing: 0.05em;
        }

        /* TABLES */
        table { width: 100%; font-size: 0.875rem; border-collapse: collapse; }
        th { background-color: #f1f5f9; color: #334155; font-size: 10px; text-transform: uppercase; font-weight: 900; padding: 0.75rem; text-align: left; border-bottom: 1px solid #e2e8f0; position: sticky; top: 0; z-index: 10; }
        td { padding: 0.75rem; border-bottom: 1px solid #f1f5f9; color: #334155; }
        
        .badge { font-size: 9px; font-weight: 700; padding: 0.125rem 0.375rem; border-radius: 0.25rem; border: 1px solid currentColor; text-transform: uppercase; white-space: nowrap; }
        .audit-row:hover { background-color: #eef2ff; cursor: pointer; }
        .audit-error { border-left: 4px solid #f43f5e; background-color: #fff1f2; }
        
        .toast-container { position: fixed; top: 80px; right: 20px; z-index: 2000; display: flex; flex-direction: column; gap: 10px; }
        
        /* CHECK LIST STYLES */
        .check-log-title { font-size: 10px; font-weight: 700; text-transform: uppercase; color: #94a3b8; margin-top: 0.5rem; margin-bottom: 0.25rem; border-bottom: 1px solid #f1f5f9; }
        .check-pass { font-size: 0.75rem; color: #059669; display: flex; align-items: center; gap: 0.5rem; padding: 0.125rem 0; }
        .check-fail { font-size: 0.75rem; color: #e11d48; font-weight: 700; display: flex; justify-content: space-between; align-items: center; gap: 0.5rem; padding: 0.25rem 0.5rem; background-color: #fff1f2; border-radius: 0.25rem; border: 1px solid #ffe4e6; margin: 0.25rem 0; cursor: pointer; }
        .check-warn { font-size: 0.75rem; color: #d97706; font-weight: 700; display: flex; justify-content: space-between; align-items: center; gap: 0.5rem; padding: 0.25rem 0.5rem; background-color: #fffbeb; border-radius: 0.25rem; border: 1px solid #fef3c7; margin: 0.25rem 0; cursor: pointer; }

        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        .gen-log-entry { font-family: monospace; font-size: 10px; margin-bottom: 2px; }
        .gen-log-success { color: #4ade80; }

        /* CHAIN & VACANCY STYLES (NEW) */
        .chain-gap { background-color: #fff1f2 !important; border-left: 4px solid #f43f5e; }
        .chain-gap td { color: #be123c; font-weight: bold; }

        /* STATUS DOTS (Ampel) */
        .status-dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .status-green { background-color: #22c55e; box-shadow: 0 0 5px #22c55e; }
        .status-yellow { background-color: #eab308; box-shadow: 0 0 5px #eab308; animation: pulse 2s infinite; }
        .status-blue { background-color: #3b82f6; box-shadow: 0 0 5px #3b82f6; animation: spin 1s infinite; }
        .status-red { background-color: #ef4444; box-shadow: 0 0 5px #ef4444; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>

    <div id="toastContainer" class="toast-container"></div>

    <!-- Header -->
    <header class="glass-header sticky top-0 z-[100] text-white py-3 px-4 shadow-lg">
        <div class="max-w-[1800px] mx-auto flex flex-wrap items-center justify-between gap-4">
            <div class="flex items-center gap-4 cursor-pointer hover:opacity-80 transition-opacity" onclick="window.openMandantMask()" title="Mandanten-Stammdaten bearbeiten">
                <div class="bg-indigo-600 p-2.5 rounded-xl shadow-lg border border-indigo-400/30"><i class="fas fa-building-user text-xl text-white"></i></div>
                <div>
                    <h1 class="font-black text-xl leading-tight tracking-tight text-white">Hausverwaltung <span class="text-indigo-400">Pro</span></h1>
                    <div class="flex items-center gap-2 text-[10px] text-slate-400 uppercase font-bold">
                        <span id="userDisplay">Offline-Modus</span>
                        <span class="w-1 h-1 bg-slate-600 rounded-full"></span>
                      <span>v16.9.35 (Backup)</span>
                    </div>
                </div>
            </div>

            <div class="flex items-center gap-3">
                 <!-- STATUS AMPEL -->
                 <div id="statusIndicator" class="flex items-center bg-slate-800/80 px-3 py-1.5 rounded-full border border-white/10" title="Status: Offline">
                    <span id="statusDot" class="status-dot status-red"></span>
                    <span id="statusText" class="text-[10px] font-bold">Offline</span>
                </div>

                <div class="h-8 w-px bg-white/10 mx-1"></div>

                <div class="flex bg-slate-800/50 rounded-lg p-1 gap-1 border border-white/10">
                    <button onclick="window.openSollMask()" class="p-2 hover:bg-slate-700 rounded transition-all text-indigo-300" title="Sollstellung"><i class="fas fa-calculator"></i></button>
                   <button onclick="window.openGeneratorMask()" class="p-2 hover:bg-slate-700 rounded transition-all text-orange-300" title="Enterprise Wizard 2.0"><i class="fas fa-magic"></i></button>
</div>

<!-- NEU: BACKUP LOKAL -->
<div class="h-8 w-px bg-white/10 mx-1"></div>
<div class="flex bg-emerald-900/30 rounded-lg p-1 gap-1 border border-emerald-500/30">
    <button onclick="window.downloadBackup()" class="p-2 hover:bg-emerald-800 rounded transition-all text-emerald-300" title="Lokales Backup speichern (Diskette)"><i class="fas fa-save"></i></button>
    <button onclick="document.getElementById('backupInputLocal').click()" class="p-2 hover:bg-emerald-800 rounded transition-all text-emerald-300" title="Lokales Backup laden"><i class="fas fa-folder-open"></i></button>
    <input type="file" id="backupInputLocal" style="display:none" onchange="window.restoreBackup(this)" accept=".json">
</div>
<!-- ENDE NEU -->

<div class="h-8 w-px bg-white/10 mx-1"></div>
                <input type="text" id="onedrivePath" value="/ideenapp/objekte.json" class="bg-slate-900/50 border border-white/10 text-[10px] text-slate-300 px-2 py-1 rounded w-32 focus:w-48 transition-all outline-none hidden md:block">
                
                <!-- LOGIN BUTTONS -->
                <button id="btnLogin" onclick="window.handleLogin()" class="btn-primary py-1.5 text-xs"><i class="fab fa-microsoft"></i> Login</button>
                <button id="btnLogout" onclick="window.handleLogout()" class="hidden bg-rose-900/50 p-2 rounded text-rose-200 hover:text-white"><i class="fas fa-sign-out-alt"></i></button>
                
                <!-- MANUAL ACTION BUTTONS -->
                <button id="btnSave" onclick="window.saveToCloud(true)" class="p-2.5 bg-blue-600 rounded-xl hover:bg-blue-700 shadow-xl disabled:opacity-30 disabled:cursor-not-allowed text-white" disabled title="Manuell Speichern"><i class="fas fa-cloud-upload-alt"></i></button>
                <button id="btnLoad" onclick="window.loadFromCloud()" class="p-2.5 bg-slate-600 rounded-xl hover:bg-slate-700 shadow-xl disabled:opacity-30 disabled:cursor-not-allowed text-white" disabled title="Daten aus Cloud laden"><i class="fas fa-cloud-download-alt"></i></button>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="bg-slate-900 text-white border-b border-white/5 px-4 sticky top-[70px] z-[90] shadow-md overflow-x-auto">
        <div class="max-w-[1800px] mx-auto flex gap-4">
            <div onclick="window.switchTab('dashboard')" class="nav-link active" id="tab-dashboard"><i class="fas fa-chart-pie mr-2"></i>Dashboard</div>
            <div onclick="window.switchTab('objekte')" class="nav-link" id="tab-objekte"><i class="fas fa-city mr-2"></i>Immobilien</div>
            <div onclick="window.switchTab('contracts')" class="nav-link" id="tab-contracts"><i class="fas fa-file-contract mr-2"></i>Verträge & Leerstand</div>
            <div onclick="window.switchTab('kontakte')" class="nav-link" id="tab-kontakte"><i class="fas fa-address-book mr-2"></i>Kontakte</div>
            <div onclick="window.switchTab('tickets')" class="nav-link" id="tab-tickets"><i class="fas fa-ticket-alt mr-2"></i>Tickets</div>
            <div onclick="window.switchTab('journal')" class="nav-link" id="tab-journal"><i class="fas fa-book mr-2"></i>Buchhaltung</div>
            <div onclick="window.switchTab('audit')" class="nav-link" id="tab-audit"><i class="fas fa-shield-alt mr-2"></i>Audit</div>
            <div onclick="window.switchTab('stamm')" class="nav-link" id="tab-stamm"><i class="fas fa-cogs mr-2"></i>System</div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-[1800px] mx-auto p-4 md:p-6 space-y-6">

        <!-- PANEL: DASHBOARD -->
        <section id="panelDashboard" class="panel active space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div class="card p-6 border-b-4 border-indigo-500"><p class="label-std">Einheiten Gesamt</p><h2 id="dashUnitCount" class="text-3xl font-black text-slate-800">0</h2></div>
                <div class="card p-6 border-b-4 border-emerald-500"><p class="label-std">Vermietungsquote</p><h2 id="dashOccupancy" class="text-3xl font-black text-slate-800">0%</h2><div class="w-full bg-slate-100 h-1.5 rounded-full mt-3 overflow-hidden"><div id="occBar" class="bg-emerald-500 h-full transition-all duration-1000" style="width:0%"></div></div></div>
                <div class="card p-6 border-b-4 border-amber-500 bg-amber-50/10">
                    <p class="label-std flex justify-between"><span>Konditions-Radar (90 Tage)</span><i class="fas fa-radar text-amber-500"></i></p>
                    <h2 id="dashAdjustments" class="text-3xl font-black text-amber-600">0</h2>
                    <p class="text-[10px] text-slate-400 mt-1">Staffelmieten / Anpassungen</p>
                </div>
                <div class="card p-6 border-b-4 border-rose-500"><p class="label-std">Forderungen Offen</p><h2 id="dashOpenDebts" class="text-3xl font-black text-rose-600">0,00 €</h2></div>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                <div class="card p-0 flex flex-col h-[500px]">
                    <div class="p-4 border-b bg-slate-50 flex justify-between items-center rounded-t-lg">
                        <h3 class="font-black text-xs uppercase text-slate-600"><i class="fas fa-clipboard-check mr-2"></i>Deep Check</h3>
                        <button onclick="window.runPlausibilityCheck()" class="text-[10px] bg-indigo-600 !text-white px-3 py-1.5 rounded font-bold hover:bg-indigo-700 shadow"><i class="fas fa-sync-alt mr-1"></i>Prüfen</button>
                    </div>
                    <div id="warnList" class="flex-1 overflow-y-auto custom-scrollbar p-4 bg-slate-50/50 space-y-1"></div>
                </div>
                <div class="card p-0 flex flex-col h-[500px]">
                    <div class="bg-white p-4 border-b flex justify-between items-center rounded-t-lg">
                        <h3 class="font-black text-xs uppercase text-slate-500 flex items-center gap-2"><i class="fas fa-exchange-alt text-blue-500"></i>Mieterwechsel</h3>
                        <div class="bg-blue-50 text-blue-600 px-2 rounded text-[10px] font-bold">+/- 30 Tage</div>
                    </div>
                    <div id="dashTenantSwitchList" class="flex-1 overflow-y-auto custom-scrollbar p-4 space-y-2"></div>
                </div>
                <div class="card p-0 flex flex-col h-[500px]">
                    <div class="bg-white p-4 border-b flex justify-between items-center rounded-t-lg">
                        <h3 class="font-black text-xs uppercase text-slate-500 flex items-center gap-2"><i class="fas fa-binoculars text-amber-500"></i>Konditions-Radar</h3>
                    </div>
                    <div id="radarList" class="flex-1 overflow-y-auto custom-scrollbar p-4 space-y-2"></div>
                </div>
                <div class="card p-6 h-[500px]"><h3 class="font-black text-xs uppercase text-slate-500 border-b pb-3 mb-4 flex justify-between"><span>Finanz-Chart</span><i class="fas fa-chart-line text-blue-500"></i></h3><div class="h-64"><canvas id="mainChart"></canvas></div></div>
            </div>
        </section>

        <!-- PANEL: VERTRÄGE -->
        <section id="panelContracts" class="panel card p-0 overflow-hidden">
            <div class="p-5 border-b bg-slate-50 flex justify-between items-center">
                <div><h2 class="text-lg font-bold">Vertrags- & Leerstandsliste</h2><p class="text-xs text-slate-400">Lückenlose Historie & Ketten-ID</p></div>
                <div class="flex gap-2 items-center">
                    <button onclick="window.filterOnlyVacancies()" class="flex items-center gap-2 text-xs font-bold bg-white px-3 py-1.5 rounded border border-rose-200 hover:bg-rose-50 shadow-sm text-rose-700" title="Zeigt nur Leerstände an">
                        <i class="fas fa-exclamation-triangle"></i> Leerstandsliste
                    </button>
                    <label class="flex items-center gap-2 text-xs font-bold bg-white px-3 py-1.5 rounded border border-slate-200 cursor-pointer hover:bg-slate-50 shadow-sm text-slate-700">
                        <input type="checkbox" id="showVacancies" onchange="window.renderContracts()" class="accent-indigo-600">
                        <i class="fas fa-link"></i> Kette Prüfen (Alle)
                    </label>
                    <!-- SORT TOGGLE -->
                    <button onclick="window.toggleContractSort()" class="btn-secondary text-xs px-2 py-1" title="Sortierung ändern (Alt-Neu / Neu-Alt)">
                        <i class="fas fa-sort"></i> 
                    </button>

                    <input type="text" placeholder="Suche..." class="input-std w-48 text-xs" onkeyup="window.renderContracts(this.value)">
                    <button onclick="window.openTenantSwitchWizard()" class="btn-primary text-xs bg-indigo-700 !text-white border-indigo-500 shadow-indigo-200" title="Mieterwechsel"><i class="fas fa-exchange-alt"></i></button>
                    <button onclick="window.generateTenantListPDF()" class="btn-secondary text-xs bg-white border"><i class="fas fa-print"></i></button>
                    <button onclick="window.exportContractList()" class="btn-secondary text-xs bg-white border"><i class="fas fa-file-export"></i></button>
                </div>
            </div>
            <div class="overflow-x-auto max-h-[75vh] custom-scrollbar">
                <table class="w-full text-xs bg-white">
                    <thead class="bg-slate-100 sticky top-0 shadow-sm z-20">
                        <tr><th class="pl-6 w-16">Status</th><th>ID-Kette (Obj/Hs/Einh/Lfd)</th><th>Typ</th><th>Mieter / Debitor / Leerstand</th><th>Laufzeit</th><th class="text-right">Aktuelle Soll-Miete</th><th class="text-right pr-6">Aktion</th></tr>
                    </thead>
                    <tbody id="contractsBody" class="text-slate-700"></tbody>
                </table>
            </div>
        </section>
        
        <!-- PANEL: TICKETS -->
        <section id="panelTickets" class="panel p-0 space-y-6">
             <div class="flex justify-between items-center bg-white p-4 rounded-xl border shadow-sm">
                <h2 class="text-xl font-black text-slate-800">Ticketsystem</h2>
                <button onclick="window.openTicketMask()" class="btn-primary">+ Neues Ticket</button>
            </div>
            <div class="grid grid-cols-3 gap-6 h-[70vh]">
                <div class="bg-slate-100 p-4 rounded-xl border"><h3 class="font-bold mb-4 text-slate-500 uppercase text-xs">Offen</h3><div id="ticketsOpen" class="space-y-2"></div></div>
                <div class="bg-blue-50 p-4 rounded-xl border border-blue-100"><h3 class="font-bold mb-4 text-blue-500 uppercase text-xs">In Arbeit</h3><div id="ticketsProg" class="space-y-2"></div></div>
                <div class="bg-emerald-50 p-4 rounded-xl border border-emerald-100"><h3 class="font-bold mb-4 text-emerald-500 uppercase text-xs">Erledigt</h3><div id="ticketsDone" class="space-y-2"></div></div>
            </div>
        </section>

        <!-- PANEL: KONTAKTE -->
        <section id="panelKontakte" class="panel space-y-6">
            <div class="flex justify-between items-center bg-white p-4 rounded-xl border shadow-sm">
                <div><h2 class="text-xl font-black text-slate-800">Adressbuch</h2><p class="text-xs text-slate-400">Mieter, Dienstleister, Eigentümer (Klicken zum Bearbeiten)</p></div>
                <div class="flex gap-2">
                    <!-- NEW SYNC BUTTON -->
                    <button onclick="window.syncGlobalContacts()" class="btn-primary bg-indigo-50 !text-indigo-600 border-indigo-200 hover:bg-indigo-100">
                        <i class="fas fa-cloud-download-alt mr-2"></i>Globale Kontakte importieren
                    </button>
                    <button onclick="window.openContactMask()" class="btn-primary">+ Neuer Kontakt</button>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="contactList"></div>
        </section>

        <!-- PANEL: IMMOBILIEN (OBJEKTE) -->
        <section id="panelObjekte" class="panel space-y-6">
            <div class="flex justify-between items-center bg-white p-4 rounded-xl border shadow-sm">
                <div><h2 class="text-xl font-black text-slate-800">Bestands-Management</h2><p class="text-xs text-slate-400" id="filterInfo">Alle Immobilien sichtbar</p></div>
                <div class="flex gap-3">
                    <button onclick="window.toggleArchive()" id="btnArchiveToggle" class="btn-secondary text-xs">Archiv anzeigen</button>
                    <button onclick="window.toggleFilter(null)" class="btn-secondary text-xs">Filter Reset</button>
                    <button onclick="window.openObjektMask()" class="btn-primary shadow-indigo-200">+ Objekt anlegen</button>
                </div>
            </div>
            <div id="objekteListe" class="space-y-8"></div>
        </section>

        <!-- PANEL: FINANZEN (JOURNAL) -->
        <section id="panelJournal" class="panel card p-0 overflow-hidden">
            <div class="p-5 border-b bg-slate-50 flex justify-between items-center">
                <h2 class="text-lg font-bold">Buchungsjournal (Einnahmen & Ausgaben)</h2>
                <div class="flex gap-2"><select id="journalFilter" onchange="window.renderJournal()" class="input-std w-64 text-xs"></select><button onclick="window.exportDatev()" class="btn-secondary text-xs bg-white border"><i class="fas fa-file-export mr-2"></i>DATEV Export</button></div>
            </div>
            <div class="overflow-x-auto max-h-[70vh] custom-scrollbar">
                <table class="w-full text-xs">
                    <thead class="bg-slate-100 sticky top-0 shadow-sm"><tr><th>Datum</th><th>Beleg</th><th>Obj / Haus / Einh</th><th>Mieter / Debitor</th><th>Text</th><th class="text-right">Soll</th><th class="text-right">Haben</th></tr></thead>
                    <tbody id="journalBody"></tbody>
                </table>
            </div>
        </section>

        <!-- PANEL: AUDIT -->
        <section id="panelAudit" class="panel card p-0 overflow-hidden">
            <div class="p-5 border-b bg-slate-50 flex justify-between items-center">
                <h2 class="text-lg font-bold">System-Audit & Tracing</h2>
                <div class="flex gap-2">
                    <input type="text" placeholder="Audit durchsuchen..." class="input-std w-64 text-xs" onkeyup="window.renderAudit(this.value)">
                    <button onclick="window.generateAuditPDF()" class="btn-primary text-xs bg-slate-700 !text-white"><i class="fas fa-file-contract mr-2"></i>Protokoll PDF</button>
                </div>
            </div>
            <div class="overflow-x-auto max-h-[70vh] custom-scrollbar"><table class="w-full"><thead><tr><th>Zeitpunkt</th><th>Modul</th><th>Aktion</th><th>User</th><th>Details (Klickbar)</th></tr></thead><tbody id="auditBody"></tbody></table></div>
        </section>

        <!-- PANEL: STAMMDATEN -->
        <section id="panelStamm" class="panel space-y-6">
            <h2 class="text-xl font-bold">System-Konfiguration</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <!-- SPALTE 1 -->
                <div class="card p-5 col-span-1">
                    <div class="flex justify-between items-center border-b pb-2 mb-3">
                        <h4 class="label-std">Sachkonten-Plan</h4>
                        <label class="cursor-pointer text-xs bg-indigo-50 text-indigo-700 px-2 py-1 rounded hover:bg-indigo-100 font-bold"><i class="fas fa-file-csv mr-1"></i>Import<input type="file" class="hidden" onchange="window.importGlAccounts(this)"></label>
                    </div>
                    <div id="glList" class="space-y-1 mb-3 h-[400px] overflow-y-auto custom-scrollbar"></div>
                    <div class="mt-4 pt-4 border-t">
                        <h4 class="label-std mb-2">Kostenarten (Pro)</h4>
                        <div id="costTypeList" class="space-y-1 mb-2 h-32 overflow-y-auto custom-scrollbar"></div>
                        <div class="bg-slate-50 p-2 rounded border grid gap-2">
                            <input type="text" id="newCostName" placeholder="Bez. (z.B. Müllabfuhr)" class="input-std text-xs">
                            <div class="flex gap-2"><select id="newCostUnit" class="input-std text-xs"><option value="monat">€/Monat</option><option value="jahr">€/Jahr</option><option value="qm">€/m²</option></select><select id="newCostAcc" class="input-std text-xs"></select></div>
                            <div class="flex gap-4 text-[10px] items-center"><label><input type="checkbox" id="newCostUml" checked> Umlagefähig (BK)</label><label><input type="checkbox" id="newCostTax"> Steuerrel. (Anl. V)</label></div>
                            <button onclick="window.addCostType()" class="btn-primary text-xs w-full justify-center">Anlegen</button>
                        </div>
                    </div>
                </div>
                <!-- SPALTE 2 -->
                <div class="card p-5 col-span-2 flex flex-col">
                    <h4 class="label-std border-b pb-2 mb-3">Konditions-Arten & Automatik</h4>
                    <div class="flex-1 overflow-auto custom-scrollbar"><table class="w-full text-xs"><thead><tr class="text-left bg-slate-50"><th class="p-2">Bezeichnung</th><th class="p-2">Std. Konto</th><th class="p-2">Steuer</th><th class="p-2">Intervall</th><th class="p-2 text-right">Aktion</th></tr></thead><tbody id="condTypeList"></tbody></table></div>
                    <div class="bg-slate-50 p-3 rounded mt-3 grid grid-cols-5 gap-2 items-end border"><div class="col-span-2"><label class="label-std">Name</label><input type="text" id="newCondLabel" class="input-std text-xs" placeholder="z.B. Stellplatz"></div><div><label class="label-std">Std. Konto</label><select id="newCondGl" class="input-std text-xs"></select></div><div><label class="label-std">Std. Intervall</label><select id="newCondInt" class="input-std text-xs"><option value="monat">Monat</option><option value="quartal">Quartal</option><option value="halbjahr">Halbjahr</option><option value="jahr">Jahr</option></select></div><button onclick="window.addSmartCondType()" class="btn-primary justify-center text-xs h-[38px]">Anlegen</button></div>
                </div>
                <!-- SPALTE 3 -->
                <div class="col-span-1 space-y-6">
                    <div class="card p-5"><h4 class="label-std border-b pb-2 mb-3">Verteilungsschlüssel (BK)</h4><div id="vKeyList" class="space-y-1 h-32 overflow-y-auto custom-scrollbar"></div><div class="flex gap-1 mt-3"><input type="text" id="newVKey" placeholder="Schlüssel" class="input-std text-xs"><button onclick="window.addVKey()" class="bg-indigo-600 !text-white rounded px-2 text-xs">+</button></div></div>
                    <div class="card p-5">
                        <h4 class="label-std border-b pb-2 mb-3">Einheiten-Typen</h4>
                        <div id="unitTypeList" class="space-y-1 h-32 overflow-y-auto custom-scrollbar"></div>
                        <div class="flex gap-1 mt-3"><input type="text" id="newUnitType" placeholder="Typ" class="input-std text-xs"><button onclick="window.addUnitType()" class="bg-indigo-600 !text-white rounded px-2 text-xs">+</button></div>
                    </div>
                    <div class="card p-5"><h4 class="label-std border-b pb-2 mb-3">Umsatzsteuer-Schlüssel</h4><div id="taxKeyList" class="space-y-1 mb-3 h-32 overflow-y-auto custom-scrollbar"></div><div class="flex gap-1"><input type="text" id="newTaxId" placeholder="ID" class="input-std w-10 text-xs"><input type="number" id="newTaxRate" placeholder="%" class="input-std w-12 text-xs"><button onclick="window.addTaxKey()" class="bg-indigo-600 !text-white rounded px-2 text-xs">+</button></div></div>
                    <div class="card p-5"><h4 class="label-std border-b pb-2 mb-3">Zähler-Typen (Neu)</h4><div id="meterTypeList" class="space-y-1 mb-3 h-32 overflow-y-auto custom-scrollbar"></div><div class="flex gap-1 mt-3"><input type="text" id="newMeterType" placeholder="Typ (z.B. Kaltwasser)" class="input-std text-xs"><button onclick="window.addMeterType()" class="bg-indigo-600 !text-white rounded px-2 text-xs">+</button></div></div>
                </div>
            </div>
        </section>
    </main>

    <!-- MODALS -->
    <!-- CONTACT MODAL -->
    <div id="kontaktModal" class="modal-overlay" onclick="if(event.target===this)window.closeModals()">
        <div class="modal-content max-w-lg p-8">
            <h3 class="text-xl font-bold mb-6">Kontakt Details</h3>
            <div class="grid gap-4">
                <input type="hidden" id="kId">
                <input type="text" id="kName" class="input-std" placeholder="Vorname Nachname / Firma">
                <input type="text" id="kStr" class="input-std" placeholder="Straße">
                <div class="flex gap-2">
                    <input type="text" id="kPlz" class="input-std w-20" placeholder="PLZ">
                    <input type="text" id="kOrt" class="input-std flex-1" placeholder="Ort">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <input type="email" id="kEmail" class="input-std" placeholder="E-Mail">
                    <input type="text" id="kTel" class="input-std" placeholder="Telefon">
                </div>
                <div class="bg-slate-50 p-3 rounded border mt-2">
                    <label class="label-std">Bankverbindung (Lastschrift)</label>
                    <input type="text" id="kIban" class="input-std mb-2 font-mono" placeholder="IBAN">
                    <div class="flex gap-2">
                        <input type="text" id="kBic" class="input-std w-24" placeholder="BIC">
                        <input type="text" id="kBank" class="input-std flex-1" placeholder="Bank Name">
                    </div>
                    <input type="text" id="kMandat" class="input-std mt-2" placeholder="Mandatsreferenz-Nr.">
                </div>
            </div>
            <div class="flex justify-end mt-6 gap-2"><button onclick="window.closeModals()" class="btn-secondary">Abbruch</button><button onclick="window.saveKontakt()" class="btn-primary">Speichern</button></div>
        </div>
    </div>

    <!-- ADJUSTMENT WIZARD -->
    <div id="adjWizardModal" class="modal-overlay" onclick="if(event.target===this)window.closeModals()">
        <div class="modal-content max-w-lg p-8">
            <h3 class="text-xl font-bold mb-6 text-orange-600">Mietanpassungs-Assistent</h3>
            <div class="bg-orange-50 p-3 rounded mb-4 text-xs text-orange-800">Erhöht die aktuelle Kaltmiete prozentual. Alte Konditionen werden automatisch beendet (Historie).</div>
            <div class="grid gap-4">
                <div><label class="label-std">Wirksam Ab (Start der Erhöhung)</label><input type="date" id="adjDate" class="input-std"></div>
                <div><label class="label-std">Erhöhung (%)</label><input type="number" id="adjPercent" class="input-std" value="5" step="0.1"></div>
            </div>
            <div class="flex justify-end mt-6 gap-2"><button onclick="window.closeModals()" class="btn-secondary">Abbruch</button><button onclick="window.executeAdjustment()" class="btn-primary bg-orange-600 !text-white">Durchführen</button></div>
        </div>
    </div>

    <!-- TENANT SWITCH WIZARD (SECURE WITH DEBTOR OVERRIDE) -->
    <div id="tenantSwitchModal" class="modal-overlay" onclick="if(event.target===this)window.closeModals()">
        <div class="modal-content max-w-lg p-8">
            <h3 class="text-xl font-bold mb-6 text-indigo-900"><i class="fas fa-exchange-alt mr-2"></i>Mieterwechsel-Assistent</h3>
            <div class="bg-indigo-50 p-3 rounded mb-4 text-xs text-indigo-800">Beendet den aktuellen Vertrag und erstellt einen neuen. <br><b>Achtung:</b> Prüfen Sie Zählerstände separat!</div>
            <div class="grid gap-4">
                <div><label class="label-std">Einheit & Aktueller Mieter</label><select id="tsUnitSelect" class="input-std" onchange="window.updateTenantSwitchInfo()"></select></div>
                <div class="grid grid-cols-2 gap-4"><div><label class="label-std">Auszug (Ende Alt)</label><input type="date" id="tsEndDate" class="input-std"></div><div><label class="label-std">Einzug (Start Neu)</label><input type="date" id="tsStartDate" class="input-std"></div></div>
                <div><label class="label-std">Neuer Mieter</label><select id="tsNewTenant" class="input-std" onchange="window.checkNewTenantSelection(this)"></select></div>
                <!-- DEBITOR OVERRIDE -->
                <div id="tsDebtorContainer">
                    <label class="label-std">Neue Debitor-Nr. (Manuell Überschreibbar)</label>
                    <div class="flex gap-2">
                        <input type="text" id="tsDebtorId" class="input-std font-mono font-bold text-indigo-700" onkeyup="window.checkDebtorUniqueness(this.value, 'tsDebtorStatus')">
                        <div id="tsDebtorStatus" class="flex items-center text-xs w-8"></div>
                    </div>
                </div>
                <div class="flex items-center gap-2 border p-2 rounded bg-slate-50"><input type="checkbox" id="tsCopyConds" checked class="accent-indigo-600"><label for="tsCopyConds" class="text-xs font-bold text-slate-600">Standard-Konditionen (Soll) übernehmen</label></div>
            </div>
            <div class="flex justify-end mt-6 gap-2"><button onclick="window.closeModals()" class="btn-secondary">Abbruch</button><button onclick="window.executeTenantSwitch()" class="btn-primary">Wechsel durchführen</button></div>
        </div>
    </div>

    <!-- OBJEKT MODAL -->
    <div id="objektModal" class="modal-overlay" onclick="if(event.target===this)window.closeModals()">
        <div class="modal-content max-w-3xl p-8">
            <div class="flex justify-between items-center mb-6 border-b pb-3">
                <h3 class="text-xl font-black">Objekt-Stammdaten</h3>
                <div class="flex gap-2"><button onclick="window.openDossierMask()" class="btn-primary text-xs bg-indigo-700 !text-white hover:bg-indigo-800 border-indigo-500"><i class="fas fa-folder-open mr-2"></i>Gesamt-Dossier</button></div>
            </div>
            <div class="grid grid-cols-2 gap-5 h-[60vh] overflow-y-auto custom-scrollbar pr-2">
                <input type="hidden" id="objId">
                <div class="col-span-2"><label class="label-std">Bezeichnung</label><input type="text" id="objName" class="input-std" placeholder="z.B. Wohnpark am See"></div>
                <div><label class="label-std">Interne Nummer</label><input type="text" id="objNr" class="input-std"></div>
                <div><label class="label-std flex items-center gap-2">USt-Option</label><select id="objTax" class="input-std font-bold text-indigo-700"><option value="opt">Optiert / Gewerbe (19%)</option><option value="fewo">Ferienwohnung (7%)</option><option value="no">Steuerfrei / Wohnen (0%)</option><option value="klein">Kleinunternehmer (0%)</option></select></div>
                <div class="col-span-2 border-t pt-2 mt-2"><label class="label-std font-bold">Anschrift</label></div>
                <div class="col-span-2"><input type="text" id="objStr" class="input-std" placeholder="Straße & Hausnummer"></div>
                <div><input type="text" id="objPlz" class="input-std" placeholder="PLZ"></div>
                <div><input type="text" id="objOrt" class="input-std" placeholder="Ort"></div>
                <div class="col-span-2 border-t pt-2 mt-2"><label class="label-std font-bold">Erweiterte Daten & Statistik</label></div>
                <div><label class="label-std">Baujahr</label><input type="number" id="objBaujahr" class="input-std"></div>
                <div><label class="label-std">Gesamtfläche (m²)</label><input type="number" id="objFlaeche" class="input-std" step="0.01"></div>
                <div><label class="label-std">Letzte Sanierung</label><input type="number" id="objSanierung" class="input-std" placeholder="Jahr"></div>
                <div><label class="label-std">Energetischer Zustand</label><select id="objEnergie" class="input-std"><option value="">- Wählen -</option><option value="A">A (Neubau)</option><option value="B">B</option><option value="C">C</option><option value="D">D (Altbau saniert)</option><option value="E">E</option><option value="F">F</option><option value="G">G</option><option value="H">H (Sanierungsbedürftig)</option></select></div>
                <div class="col-span-2 border-t pt-2 mt-2"><label class="label-std font-bold">Finanzdaten</label></div>
                <div><label class="label-std">Steuernummer</label><input type="text" id="objSteuer" class="input-std"></div>
                <div><label class="label-std">USt-ID</label><input type="text" id="objUStId" class="input-std"></div>
                <div><label class="label-std">IBAN</label><input type="text" id="objIban" class="input-std"></div>
                <div><label class="label-std">Gläubiger-ID</label><input type="text" id="objGid" class="input-std"></div>
                <div class="col-span-2"><label class="label-std">Gemarkung / Flur</label><input type="text" id="objFlur" class="input-std"></div>
            </div>
            <div class="flex justify-between mt-6 pt-4 border-t"><button onclick="window.archiveObject()" class="text-amber-600 text-xs font-bold bg-amber-50 px-3 py-1 rounded hover:bg-amber-100"><i class="fas fa-archive mr-1"></i>Archivieren</button><div class="flex gap-2"><button onclick="window.closeModals()" class="btn-secondary">Abbruch</button><button onclick="window.saveObjekt()" class="btn-primary">Speichern</button></div></div>
        </div>
    </div>

    <!-- DOSSIER CONFIG MODAL -->
    <div id="dossierModal" class="modal-overlay" onclick="if(event.target===this)window.closeModals()">
        <div class="modal-content max-w-md p-8">
            <h3 class="text-xl font-bold mb-6 text-indigo-900">Dossier Konfigurator</h3>
            <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100 mb-4">
                <p class="text-xs text-indigo-800 mb-2 font-bold">Inhalt auswählen:</p>
                <div class="space-y-2">
                    <label class="flex items-center gap-3 bg-white p-2 rounded border cursor-pointer hover:bg-slate-50"><input type="checkbox" id="dosObj" checked disabled class="text-indigo-600 focus:ring-indigo-500"><span class="text-sm font-medium text-slate-700">Objekt-Stammdaten</span></label>
                    <label class="flex items-center gap-3 bg-white p-2 rounded border cursor-pointer hover:bg-slate-50"><input type="checkbox" id="dosHaeuser" checked class="text-indigo-600 focus:ring-indigo-500"><span class="text-sm font-medium text-slate-700">Häuser-Liste</span></label>
                    <label class="flex items-center gap-3 bg-white p-2 rounded border cursor-pointer hover:bg-slate-50"><input type="checkbox" id="dosUnits" checked class="text-indigo-600 focus:ring-indigo-500"><span class="text-sm font-medium text-slate-700">Einheiten & Mieter-Liste (inkl. Leerstand)</span></label>
                    <label class="flex items-center gap-3 bg-white p-2 rounded border cursor-pointer hover:bg-slate-50"><input type="checkbox" id="dosSystem" class="text-indigo-600 focus:ring-indigo-500"><span class="text-sm font-medium text-slate-700">System-Anhang (Konten/Kosten)</span></label>
                </div>
            </div>
            <div class="flex justify-end mt-6 gap-2"><button onclick="window.closeModals()" class="btn-secondary">Abbruch</button><button onclick="window.runDossierExport()" class="btn-primary bg-indigo-700 !text-white hover:bg-indigo-800">PDF Generieren</button></div>
        </div>
    </div>

    <!-- HAUS MODAL -->
    <div id="hausModal" class="modal-overlay" onclick="if(event.target===this)window.closeModals()"><div class="modal-content max-w-4xl p-8"><div class="flex justify-between mb-6 border-b pb-3"><h3 class="text-xl font-bold">Haus Details</h3><button onclick="window.generateHausPDF()" class="btn-secondary text-xs"><i class="fas fa-file-pdf mr-2"></i>Stammblatt PDF</button></div><input type="hidden" id="hausId"><div class="grid grid-cols-3 gap-4 mb-6"><input type="text" id="hausName" class="input-std" placeholder="Bezeichnung"><input type="number" id="hausMeaSoll" class="input-std" placeholder="MEA Soll"><select id="hausTax" class="input-std"><option value="auto">Auto</option><option value="opt">Optiert</option><option value="no">Steuerfrei</option></select></div><div class="bg-slate-50 rounded-xl border overflow-hidden"><table><thead><tr><th>Typ</th><th class="text-center">Soll (Anz)</th><th class="text-center">Ist</th><th>Diff</th><th class="text-right">Soll (m²)</th><th class="text-right">Ist</th><th>Diff</th></tr></thead><tbody id="hausMatrixBody"></tbody></table></div><div class="flex justify-end mt-6 gap-3"><button onclick="window.closeModals()" class="btn-secondary">Abbruch</button><button id="btnSaveHaus" class="btn-primary">Speichern</button></div></div></div>

    <!-- EINHEIT MODAL -->
    <div id="einheitModal" class="modal-overlay" onclick="if(event.target===this)window.closeModals()">
        <div class="modal-content max-w-6xl p-0 overflow-hidden flex flex-col h-[90vh]">
            <div class="bg-white p-6 border-b flex justify-between items-center">
                <!-- UPDATED HEADER WITH CHAIN ID -->
                <div><h3 class="text-xl font-black"><span id="modalUnitTitle" class="text-indigo-600"></span></h3><span id="modalTaxBadge" class="badge"></span></div>
                <div class="flex gap-2"><button onclick="window.generateUnitPDF()" class="btn-secondary text-xs"><i class="fas fa-file-pdf mr-2"></i>Stammblatt PDF</button><button onclick="window.closeModals()" class="text-slate-400 hover:text-slate-600"><i class="fas fa-times text-xl"></i></button></div>
            </div>
            <div class="bg-slate-50 px-6 border-b flex gap-1 overflow-x-auto">
                <button onclick="window.switchUnitTab('stamm')" class="unit-tab-btn active px-4 py-3 text-xs font-bold border-b-2 border-indigo-600 text-indigo-700">Stammdaten</button>
                <button onclick="window.switchUnitTab('vertrage')" class="unit-tab-btn px-4 py-3 text-xs font-bold border-b-2 border-transparent text-slate-500 hover:text-indigo-600">Verträge</button>
                <button onclick="window.switchUnitTab('kosten')" class="unit-tab-btn px-4 py-3 text-xs font-bold border-b-2 border-transparent text-slate-500 hover:text-indigo-600">Direkte Kosten</button>
                <button onclick="window.switchUnitTab('zaehler')" class="unit-tab-btn px-4 py-3 text-xs font-bold border-b-2 border-transparent text-slate-500 hover:text-indigo-600"><i class="fas fa-tachometer-alt mr-2"></i>Zähler</button>
                <button onclick="window.switchUnitTab('personen')" class="unit-tab-btn px-4 py-3 text-xs font-bold border-b-2 border-transparent text-slate-500 hover:text-indigo-600">Personen (BK)</button>
            </div>
            <div class="flex-1 overflow-y-auto p-8 bg-white">
                <div id="uTab_stamm" class="unit-tab-content">
                    <div class="grid grid-cols-3 gap-6">
                        <div><label class="label-std">Bezeichnung</label><input type="text" id="unitName" class="input-std"></div>
                        <div><label class="label-std">Typ</label><select id="unitTypeSelect" class="input-std"></select></div>
                        <div><label class="label-std">Fläche ($m^2$)</label><input type="number" id="unitArea" class="input-std" step="0.01" onchange="window.trackAreaChange(this.value)"></div>
                        <div><label class="label-std">Lage</label><input type="text" id="unitLage" class="input-std" placeholder="EG Links"></div>
                        <div><label class="label-std">USt-Option</label><select id="unitTax" class="input-std"><option value="auto">Auto (wie Objekt)</option><option value="opt">Optiert (19%)</option><option value="fewo">FeWo (7%)</option><option value="no">Steuerfrei (0%)</option></select></div>
                    </div>
                    <!-- SOLL-KONDITIONEN TABLE REWORKED -->
                    <div class="mt-6 border-t pt-4">
                        <div class="flex justify-between items-center mb-2">
                            <div class="flex gap-2 items-center"><h4 class="label-std !text-indigo-600">Soll-Konditionen (Standard für neue Verträge)</h4><button onclick="window.checkUnitLogic()" class="text-[10px] bg-amber-100 text-amber-700 px-2 py-1 rounded font-bold border border-amber-200 hover:bg-amber-200"><i class="fas fa-stethoscope mr-1"></i>Lücken prüfen</button></div>
                            <div class="text-xs font-bold text-indigo-900 bg-indigo-50 px-2 py-1 rounded">Summe Aktuell: <span id="unitCondSum">0,00 €</span></div>
                            <button onclick="window.addUnitStdCondRow()" class="text-[10px] bg-indigo-50 text-indigo-600 px-2 rounded font-bold">+ Standard-Satz</button>
                        </div>
                        <div class="overflow-y-auto max-h-48 border rounded custom-scrollbar">
                            <table class="w-full text-xs text-left">
                                <!-- UPDATED HEADERS -->
                                <thead class="bg-slate-50 sticky top-0"><tr><th>Art</th><th>Betrag</th><th>Einheit</th><th>Summe (Live)</th><th>Gültig Von</th><th>Gültig Bis</th><th>Aktionen</th></tr></thead>
                                <tbody id="unitStdCondsBody"></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="mt-8"><h4 class="label-std !text-indigo-600 border-b pb-2 mb-4">Flächen-Historie</h4><div class="bg-slate-50 rounded border p-4 h-40 overflow-y-auto text-xs" id="unitAreaLog"></div></div>
                </div>
                <div id="uTab_vertrage" class="unit-tab-content hidden"><div class="flex justify-between mb-4"><h4 class="font-bold">Vertragshistorie & Kette</h4><button onclick="window.openContractModalNew()" class="btn-primary text-xs">+ Neuer Vertrag</button></div><div id="unitContractList" class="space-y-2"></div></div>
                <div id="uTab_kosten" class="unit-tab-content hidden"><div class="flex justify-between mb-4"><h4 class="font-bold">Direkte Kosten & Umlagen</h4><button onclick="window.addUnitCostRow()" class="text-xs text-blue-600 font-bold">+ Kostenart hinzufügen</button></div><table class="w-full text-xs text-left"><thead><tr><th>Kostenart (Stamm)</th><th>Menge</th><th>Betrag/Einheit</th><th>Gültig Von</th><th>Gültig Bis</th><th></th></tr></thead><tbody id="unitDirectCostsBody"></tbody></table></div>
                <div id="uTab_zaehler" class="unit-tab-content hidden">
                    <div class="flex justify-between mb-4 items-center"><h4 class="font-bold">Zähler & Messgeräte</h4><button onclick="window.addMeterRow()" class="btn-primary text-xs bg-emerald-600 hover:bg-emerald-700 !text-white">+ Zähler erfassen</button></div>
                    <div class="bg-indigo-50/50 rounded-xl border p-4 mb-4 text-xs text-slate-500"><i class="fas fa-info-circle mr-2"></i>Hier erfassen Sie Wasser-, Strom-, Gas- und Wärmezähler für die verbrauchsabhängige Abrechnung.</div>
                    <table class="w-full text-xs text-left"><thead class="bg-slate-50"><tr><th>Typ</th><th>Zählernummer</th><th>Letzter Stand</th><th>Ablesedatum</th><th>Eichung Bis</th><th></th></tr></thead><tbody id="unitMetersBody"></tbody></table>
                </div>
                <div id="uTab_personen" class="unit-tab-content hidden"><div class="flex justify-between mb-4"><h4 class="font-bold">Personenbelegung (BK)</h4><button onclick="window.addPersonRow()" class="text-xs text-blue-600">+ Zeitraum</button></div><table class="w-full text-xs text-left"><thead><tr><th>Von</th><th>Bis</th><th>Anzahl</th><th>Notiz</th><th></th></tr></thead><tbody id="unitPersonList"></tbody></table></div>
            </div>
            <div class="p-4 border-t flex justify-end gap-3 bg-slate-50"><button onclick="window.closeModals()" class="btn-secondary">Abbruch</button><button id="btnSaveUnit" class="btn-primary">Speichern</button></div>
        </div>
    </div>

    <!-- CONTRACT MODAL (UPDATED TABLE) -->
    <div id="contractModal" class="modal-overlay" onclick="if(event.target===this)window.closeModals()">
        <div class="modal-content max-w-6xl p-8 bg-slate-50">
            <div class="flex justify-between items-center mb-6 border-b pb-3">
                <div class="flex gap-4 items-center"><h3 class="text-xl font-bold text-indigo-900">Mietvertrag</h3><button onclick="window.validateContractOverlap()" class="text-[10px] bg-amber-100 text-amber-700 px-3 py-1 rounded font-bold border border-amber-200 hover:bg-amber-200 shadow-sm"><i class="fas fa-bolt mr-1"></i>Vertrag Prüfen</button></div>
                <button onclick="window.openAdjustmentWizard()" class="btn-primary bg-orange-500 hover:bg-orange-600 text-xs py-1"><i class="fas fa-chart-line"></i> Mietanpassung</button>
            </div>
            
            <div class="flex gap-4">
                <!-- LEFT SIDE: BASIC DATA -->
                <div class="flex-1 bg-white p-5 rounded-xl border shadow-sm mb-6 grid grid-cols-4 gap-4">
                    <div class="col-span-2"><label class="label-std">Mieter</label><select id="cTenantSelect" class="input-std" onchange="window.checkNewTenantSelection(this)"></select></div>
                    <div><label class="label-std">Debitor-Nr. (Manuell)</label><div class="flex gap-2"><input type="text" id="cDebtor" class="input-std font-bold text-indigo-700" onkeyup="window.checkDebtorUniqueness(this.value, 'cDebtorStatus')"><div id="cDebtorStatus" class="flex items-center text-xs w-8"></div></div></div>
                    <div><label class="label-std">Kaution (€)</label><input type="number" id="cDeposit" class="input-std"></div>
                    <div><label class="label-std">Beginn</label><input type="date" id="cStart" class="input-std"></div>
                    <div><label class="label-std">Ende</label><input type="date" id="cEnd" class="input-std"></div>
                    <div><label class="label-std">Zahlweise</label><select id="cPayType" class="input-std"><option value="sepa">Lastschrift</option><option value="ue">Überweiser</option></select></div>
                </div>

                <!-- RIGHT SIDE: DOCS -->
                <div class="w-1/3 bg-slate-50 p-4 rounded-xl border shadow-sm mb-6 flex flex-col">
                    <h4 class="label-std border-b pb-2 mb-2">Dokumente & Protokolle</h4>
                    <div class="flex-1 space-y-2 overflow-y-auto h-24">
                         <!-- Doc List (Placeholder) -->
                         <div class="text-[10px] text-slate-400 italic">Keine Dokumente verknüpft.</div>
                    </div><!-- NEU: DMS BUTTON -->
<button onclick="window.openDMSBridge()" class="w-full mt-2 mb-2 py-2 bg-fuchsia-100 hover:bg-fuchsia-200 text-fuchsia-800 text-xs font-bold rounded border border-fuchsia-300 flex items-center justify-center gap-2">
    <i class="fas fa-search-location"></i> 📂 DMS-Akte (Ideen-App) öffnen
</button><!-- NEU: LIVE LISTE VORGÄNGE -->
<div class="mt-3 border-t pt-2">
    <div class="flex justify-between items-center mb-1">
        <span class="label-std">Aktive Vorgänge (Ideen-App)</span>
        <button onclick="window.refreshExternalTickets()" class="text-[10px] text-blue-500 hover:underline"><i class="fas fa-sync"></i> Refresh</button>
    </div>
    <div id="externalTicketsList" class="bg-white border rounded h-32 overflow-y-auto custom-scrollbar p-2 space-y-1">
        <div class="text-[10px] text-slate-400 italic text-center mt-4">Wird geladen...</div>
    </div>
</div>
<!-- ENDE NEU -->
<!-- ENDE NEU -->
                    <div class="mt-2 grid grid-cols-2 gap-2">
                        <button onclick="window.generateProtocolPDF()" class="text-[10px] bg-white border border-slate-300 rounded p-1 hover:bg-slate-100 flex flex-col items-center gap-1">
                            <i class="fas fa-file-pdf text-red-500 text-lg"></i><span>Übergabeprotokoll (Blanko)</span>
                        </button>
                         <button onclick="window.openDocFolder()" class="text-[10px] bg-white border border-slate-300 rounded p-1 hover:bg-slate-100 flex flex-col items-center gap-1">
                            <i class="fas fa-folder-open text-yellow-500 text-lg"></i><span>Upload-Ordner öffnen</span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-6 h-[400px]">
                <div class="bg-white p-4 rounded-xl border shadow-sm flex flex-col">
                    <div class="flex justify-between mb-3 border-b pb-2">
                        <span class="label-std">Konditionen (Historie / Staffel)</span>
                        <div class="flex gap-2 items-center">
                            <div class="text-xs font-bold text-indigo-900 bg-indigo-50 px-2 py-1 rounded">Aktuell: <span id="contractSum">0,00 €</span></div>
                            <button onclick="window.importUnitConditions()" class="text-[10px] bg-emerald-50 text-emerald-600 px-2 py-1 rounded font-bold hover:bg-emerald-100 border border-emerald-200" title="Konditionen aus Einheit übernehmen"><i class="fas fa-file-import mr-1"></i>Soll-Werte laden</button>
                            <button onclick="window.addCondRow()" class="text-[10px] bg-indigo-50 text-indigo-600 px-2 py-1 rounded font-bold hover:bg-indigo-100">+ Zeile</button>
                        </div>
                    </div>
                    <div class="flex-1 overflow-y-auto custom-scrollbar h-64 border rounded">
                        <table class="w-full text-xs">
                            <!-- UPDATED HEADERS CONTRACT -->
                            <thead class="sticky top-0 bg-white z-10 shadow-sm"><tr class="text-left text-slate-400"><th>Art</th><th>Betrag</th><th>Einh.</th><th>Summe (Live)</th><th>Start</th><th>Ende</th><th>Aktionen</th></tr></thead>
                            <tbody id="condListBody"></tbody>
                        </table>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-xl border shadow-sm flex flex-col">
                    <div class="flex justify-between mb-3 border-b pb-2"><span class="label-std">Direkte Kosten (Vertrag)</span><button onclick="window.addContractCostRow()" class="text-[10px] bg-blue-50 text-blue-600 px-2 rounded font-bold">+ Kosten</button></div>
                    <div class="flex-1 overflow-y-auto custom-scrollbar"><table class="w-full text-xs"><thead><tr class="text-left text-slate-400"><th>Kostenart</th><th>€/Monat</th><th></th></tr></thead><tbody id="contractCostBody"></tbody></table></div>
                </div>
            </div>
            <div class="flex justify-end mt-6 pt-4 border-t gap-3"><button onclick="window.closeModals()" class="btn-secondary">Abbruch</button><button onclick="window.saveContract()" class="btn-primary">Vertrag speichern</button></div>
        </div>
    </div>

    <!-- KONTO MODAL -->
    <div id="kontoModal" class="modal-overlay" onclick="if(event.target===this)window.closeModals()">
        <div class="modal-content max-w-6xl p-8">
            <div class="flex justify-between items-center mb-6 border-b pb-3"><div><h3 class="text-2xl font-bold" id="kontoTitle">Konto</h3></div></div>
            <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100 mb-6">
                <h4 class="label-std !text-indigo-600 mb-2">Neue Manuelle Buchung</h4>
                <div class="grid grid-cols-6 gap-2 items-end">
                    <div><label class="label-std">Datum</label><input type="date" id="mbDatum" class="input-std text-xs"></div>
                    <div><label class="label-std">Typ</label><select id="mbTyp" class="input-std text-xs"><option value="haben">Zahlung (H)</option><option value="soll">Forderung (S)</option></select></div>
                    <div><label class="label-std">Betrag (€)</label><input type="number" id="mbBetrag" class="input-std text-xs" step="0.01"></div>
                    <div class="col-span-2"><label class="label-std">Text</label><input type="text" id="mbText" class="input-std text-xs"></div>
                    <button onclick="window.saveManualBooking()" class="btn-primary h-[38px] justify-center text-xs">Buchen</button>
                </div>
            </div>
            <div class="overflow-x-auto border rounded-xl max-h-[400px] custom-scrollbar">
                <table class="w-full"><thead class="sticky top-0 bg-white"><tr><th>Datum</th><th>Beleg</th><th>Text</th><th class="text-right">Soll</th><th class="text-right">Haben</th><th class="text-right">Saldo</th><th></th></tr></thead><tbody id="kontoBody"></tbody></table>
            </div>
        </div>
    </div>

    <!-- TICKET MODAL -->
    <div id="ticketModal" class="modal-overlay" onclick="if(event.target===this)window.closeModals()">
        <div class="modal-content max-w-lg p-6">
            <h3 class="text-xl font-bold mb-4">Ticket erfassen</h3>
            <div class="space-y-4">
                <input type="text" id="tickTitle" class="input-std" placeholder="Betreff / Mangel">
                <div class="grid grid-cols-2 gap-2"><div><label class="label-std">Objekt</label><select id="tickObj" class="input-std" onchange="window.updateTicketHouses()"></select></div><div><label class="label-std">Haus</label><select id="tickHaus" class="input-std" onchange="window.updateTicketUnits()"></select></div></div>
                <div><label class="label-std">Einheit & Mieter</label><select id="tickUnit" class="input-std"></select></div>
                <div class="flex gap-2"><select id="tickStatus" class="input-std"><option value="open">Offen</option><option value="prog">In Arbeit</option><option value="done">Erledigt</option></select><select id="tickPrio" class="input-std"><option value="low">Niedrig</option><option value="mid">Mittel</option><option value="high">Hoch</option></select></div>
                <textarea id="tickDesc" class="input-std h-32" placeholder="Beschreibung..."></textarea>
                <div class="flex justify-end gap-2 pt-4"><button onclick="window.closeModals()" class="btn-secondary">Abbruch</button><button onclick="window.saveTicket()" class="btn-primary">Speichern</button></div>
            </div>
        </div>
    </div>

    <!-- OTHER MODALS -->
    <div id="mandantModal" class="modal-overlay" onclick="if(event.target===this)window.closeModals()"><div class="modal-content max-w-lg p-8"><h3 class="text-xl font-bold mb-6">Mandant (Hausverwaltung)</h3><div class="space-y-4"><input type="text" id="manName" class="input-std" placeholder="Firma"><input type="text" id="manStr" class="input-std" placeholder="Str"><input type="text" id="manOrt" class="input-std" placeholder="Ort"><div class="border-t pt-2 mt-2"><label class="label-std">Gläubiger-ID (Zentral)</label><input type="text" id="manGid" class="input-std font-mono" placeholder="DE98ZZZ..."></div></div><div class="flex justify-end mt-6"><button onclick="window.saveMandant()" class="btn-primary">Speichern</button></div></div></div>
    <div id="sollstellungModal" class="modal-overlay" onclick="if(event.target===this)window.closeModals()"><div class="modal-content max-w-7xl p-8"><div class="flex justify-between items-center mb-6"><div><h3 class="text-2xl font-black">Sollstellung</h3></div><div class="text-right"><p class="label-std">Gesamtsumme</p><p id="sollSumTotal" class="text-2xl font-black text-indigo-600">0,00 €</p></div></div><div class="grid grid-cols-4 gap-4 mb-6 bg-slate-50 p-4 rounded-xl border"><div><label class="label-std">Monat</label><input type="month" id="sollMonth" class="input-std" onchange="window.updateSollPreview()"></div><div><label class="label-std">Belegdatum</label><input type="date" id="sollDate" class="input-std"></div></div><div class="border rounded-xl h-[500px] overflow-auto custom-scrollbar bg-white"><table class="w-full text-[11px]"><thead class="sticky top-0 bg-slate-100 shadow-sm"><tr><th class="w-8"><input type="checkbox" checked onchange="window.toggleAllSoll(this.checked)"></th><th>Objekt / Haus</th><th>Einheit / Mieter</th><th>Debitor</th><th>Konto</th><th class="text-right">Betrag</th><th>Aktion</th></tr></thead><tbody id="sollPreviewBody"></tbody></table></div><div class="flex justify-end gap-3 mt-6 pt-4 border-t"><button onclick="window.closeModals()" class="btn-secondary">Abbruch</button><button onclick="window.executeSollstellung()" class="btn-primary">Verbuchung starten</button></div></div></div>
    <div id="auditDetailModal" class="modal-overlay" onclick="if(event.target===this)window.closeModals()"><div class="modal-content max-w-2xl p-6"><h3 class="text-xl font-bold mb-4">Audit Trace Details</h3><div id="auditDetailContent" class="bg-slate-900 text-green-400 p-4 rounded-lg font-mono text-xs overflow-auto max-h-80 mb-6 select-all"></div><div class="flex justify-end gap-3"><button onclick="window.copyAuditToClip()" class="btn-secondary">Kopieren</button><button onclick="window.closeModals()" class="btn-primary">Schließen</button></div></div></div>
    <div id="generatorModal" class="modal-overlay" onclick="if(event.target===this)window.closeModals()"><div class="modal-content max-w-4xl p-8"><h3 class="text-xl font-bold mb-6 text-orange-600 flex items-center gap-2"><i class="fas fa-robot"></i> Enterprise Generator 2.0</h3><div class="grid grid-cols-2 gap-8"><div class="space-y-5"><div><label class="label-std">Template Auswahl</label><select id="genTemplate" class="input-std" onchange="window.applyGenTemplate()"><option value="mfh_std">MFH Standard (Wohnpark)</option><option value="gewerbe">Gewerbepark / Business Center</option><option value="mixed">Mischobjekt (Wohnen & Gewerbe)</option></select></div><div><label class="label-std">Objekt Name</label><input type="text" id="genObjName" class="input-std" value="Wohnpark Mitte (Muster)"></div><div><label class="label-std">Start-Adresse (Haus 1)</label><input type="text" id="genAddress" class="input-std" value="Hauptstr. 1"></div><div class="grid grid-cols-2 gap-4"><div><label class="label-std">Anzahl Häuser</label><input type="number" id="genHausCount" class="input-std" value="2"></div><div><label class="label-std">Einheiten pro Haus</label><input type="number" id="genUnitCount" class="input-std" value="6"></div></div><div><div class="flex justify-between"><label class="label-std">Leerstands-Simulation</label><span id="genVacancyDisp" class="text-xs font-bold text-slate-500">10%</span></div><input type="range" id="genVacancy" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer" min="0" max="100" value="10" oninput="document.getElementById('genVacancyDisp').innerText=this.value+'%'"></div></div><div class="flex flex-col h-full"><h4 class="label-std mb-2">Live-Protokoll & Feedback</h4><div id="genLog" class="bg-slate-900 text-green-400 p-4 rounded-lg font-mono text-[10px] flex-1 overflow-y-auto h-80 border border-slate-700 shadow-inner"><div class="opacity-50">// Bereit zum Generieren...</div><div class="opacity-50">// Warte auf Eingabe.</div></div></div></div><div class="flex justify-end mt-8 gap-3 pt-4 border-t"><button onclick="window.closeModals()" class="btn-secondary">Abbruch</button><button onclick="window.runEnterpriseGenerator()" class="btn-primary bg-orange-600 hover:bg-orange-700 shadow-orange-200"><i class="fas fa-play mr-2"></i>Generierung Starten</button></div></div></div>

    <!-- Scripts -->
    <script>
        const SYSTEM_DEFAULTS = { 
            sachkonten: [{id:'8500', name:'Miete 19%'}, {id:'8100', name:'Miete 0%'}, {id:'1200', name:'Bank'}, {id:'1000', name:'Kasse'}, {id:'1400', name:'Forderungen'}], 
            taxKeys: [{id:'3', name:'19% USt', rate:19}, {id:'2', name:'7% USt', rate:7}, {id:'1', name:'0% USt', rate:0}], 
            condTypes: [{label: 'Kaltmiete', gl: '8500', tax: 'opt', intervall: 'monat'}, {label: 'NK-Vorausz.', gl: '1700', tax: 'opt', intervall: 'monat'}], 
            costTypes: [
                {id: 'ct_1', name: 'Grundsteuer', unit: 'jahr', acc: '8500', uml: true, taxDeductible: true}, 
                {id: 'ct_2', name: 'Versicherung', unit: 'jahr', acc: '8500', uml: true, taxDeductible: true}, 
                {id: 'ct_3', name: 'Wasser', unit: 'monat', acc: '1700', uml: true, taxDeductible: true}
            ], 
            unitTypes: ['Wohnung', 'Gewerbe', 'Garage', 'Lager'], 
            vKeys: ['Personen', 'Fläche (m²)', 'Einheiten'],
            meterTypes: ['Wasser (m³)', 'Strom (kWh)', 'Wärme (kWh)', 'Gas (m³)', 'HKV (Einh.)']
        };
        const MSAL_CFG = { auth: { clientId: "c3cd3be4-3540-46dd-a24c-82eb6ed5542d", authority: "https://login.microsoftonline.com/common", redirectUri: window.location.origin + window.location.pathname } };
        let db = { objekte: new Map(), haeuser: new Map(), einheiten: new Map(), finanzen: [], sachkonten: [], condTypes: [], costTypes: [], unitTypes: [], taxKeys: [], vKeys: [], meterTypes: [], kontakte: new Map(), audit: [], tickets: [], mandant: {} };
        let activeFocus = null, currentUnitId = null, currentContractIdx = null, currentKontoUnit = null, mainChart = null, showArchived = false;
        let sollPreviewData = []; let msalInstance;
        let searchTimeout = null; 
        
        let isDirty = false;
        let autoSaveTimer = null;
        let contractSortDesc = false; // New Sort State

        const setStatus = (status, text) => {
            const dot = document.getElementById('statusDot');
            const txt = document.getElementById('statusText');
            if(!dot || !txt) return;
            dot.className = 'status-dot status-'+status;
            txt.innerText = text;
        };

        const markDirty = () => {
            if(!isDirty) {
                isDirty = true;
                setStatus('yellow', 'Ungespeichert');
                clearTimeout(autoSaveTimer);
                autoSaveTimer = setTimeout(() => {
                     if(document.getElementById('userDisplay').innerText.includes('@')) {
                         window.saveToCloud(false);
                     }
                }, 30000);
            }
        };

        window.onbeforeunload = (e) => {
            if(isDirty) { e.preventDefault(); e.returnValue = ''; }
        };

        const uuid = () => 'tr_' + Math.random().toString(36).substr(2, 9);
        const roundMoney = (n) => Math.round((parseFloat(n)||0) * 100) / 100;
        const nowStr = () => new Date().toISOString().slice(0,10);
        const nowDateTimeStr = () => new Date().toLocaleString('de-DE');
        const formatEuro = (n) => (n||0).toLocaleString('de-DE', {style:'currency', currency:'EUR'});

        window.onerror = function (msg, url, lineNo, columnNo, error) { const details = `${msg} URL: ${url} Line: ${lineNo} Col: ${columnNo} Error: ${error}`; logAudit('SYSTEM', 'CRITICAL_ERROR', details, 'ERROR'); return false; };
        window.onunhandledrejection = function (event) { logAudit('SYSTEM', 'PROMISE_ERROR', event.reason, 'ERROR'); };

        window.calculateHistoryChain = (u) => {
            const chain = [];
            if(!u.contracts) u.contracts = [];
            
            const sorted = [...u.contracts].sort((a,b) => a.start.localeCompare(b.start));
            
            let nr = 1;
            let lastEnd = null;

            if(sorted.length === 0) {
                chain.push({ type:'vacancy', start: '2000-01-01', end: null, nr: nr, uId: u.id });
                return chain;
            }

            sorted.forEach(c => {
                if(lastEnd) {
                    const nextStart = new Date(c.start);
                    const prevEnd = new Date(lastEnd);
                    const diffTime = nextStart - prevEnd;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 

                    if(diffDays > 1) {
                        const vacStart = new Date(prevEnd); vacStart.setDate(vacStart.getDate() + 1);
                        const vacEnd = new Date(nextStart); vacEnd.setDate(vacEnd.getDate() - 1);
                        chain.push({ type: 'vacancy', start: vacStart.toISOString().slice(0,10), end: vacEnd.toISOString().slice(0,10), nr: nr++, uId: u.id });
                    }
                }
                chain.push({ type: 'contract', data: c, nr: nr++, uId: u.id });
                lastEnd = c.end;
            });

            if(lastEnd && lastEnd < nowStr()) {
                const vacStart = new Date(new Date(lastEnd).setDate(new Date(lastEnd).getDate()+1));
                chain.push({ type: 'vacancy', start: vacStart.toISOString().slice(0,10), end: null, nr: nr++, uId: u.id });
            }
            return chain;
        };

        window.getChainLabel = (u, runningNr) => {
            const o = db.objekte.get(u.objId);
            const h = db.haeuser.get(u.hausId);
            const nrPad = (n) => String(n).padStart(2, '0');
            const unitNr = u.name.match(/\d+/)?.[0] || '0000';
            return `${o?.nr||'0000'} / ${h?.name.match(/\d+/)?.[0]||'00'} / ${unitNr} / ${nrPad(runningNr)}`;
        };

        window.getChainedID = function(uId) { const u = db.einheiten.get(uId); if(!u) return '-'; const h = db.haeuser.get(u.hausId); const o = db.objekte.get(u.objId); return `${o?.nr||'0000'} / ${h?.name.match(/\d+/)?.[0]||'00'} / ${u.name.replace(/[^0-9]/g, '') || '0'}`; };

        window.validateContractOverlap = () => {
            const start = document.getElementById('cStart').value;
            const end = document.getElementById('cEnd').value || '2099-12-31';
            if(!start) return alert("Startdatum fehlt");
            const u = db.einheiten.get(currentUnitId);
            let collision = false;
            let collisionName = "";
            (u.contracts||[]).forEach((c, idx) => {
                if(currentContractIdx !== null && idx === currentContractIdx) return; 
                const cStart = c.start;
                const cEnd = c.end || '2099-12-31';
                if(start <= cEnd && end >= cStart) {
                    collision = true;
                    collisionName = window.resolveContactName(c.tenantId) + " (" + cStart + " - " + (c.end||'offen') + ")";
                }
            });
            if(collision) alert(`⚠️ Warnung: Zeitliche Kollision mit Vertrag von ${collisionName}`);
            else alert("✅ Zeitraum scheint frei zu sein.");
        };

        window.checkDebtorUniqueness = (val, statusId) => {
            const el = document.getElementById(statusId);
            if(!val) { el.innerHTML = ''; return; }
            let found = null;
            db.einheiten.forEach(u => {
                (u.contracts||[]).forEach(c => {
                    if(currentContractIdx !== null && u.contracts[currentContractIdx]?.debtor === val && u.id === currentUnitId) return;
                    if(c.debtor == val) found = u.name;
                });
            });
            if(found) {
                el.innerHTML = '<i class="fas fa-exclamation-circle text-rose-500"></i>';
                el.title = `Nummer bereits vergeben in Einheit: ${found}`;
            } else {
                el.innerHTML = '<i class="fas fa-check text-emerald-500"></i>';
                el.title = "Nummer frei";
            }
        };

        window.checkNewTenantSelection = (selectEl) => { if(selectEl.value === 'new') { window.openContactMask(); selectEl.value = ""; } };

        window.switchTab = function(id) { document.querySelectorAll('.panel, .nav-link').forEach(el=>el.classList.remove('active')); const panel = document.getElementById('panel'+id.charAt(0).toUpperCase()+id.slice(1)); const tab = document.getElementById('tab-'+id); if(panel) panel.classList.add('active'); if(tab) tab.classList.add('active'); if(id === 'contracts') window.renderContracts(); else if(id === 'kontakte') window.renderKontakte(); else if(id === 'tickets') window.renderTickets(); else window.renderAll(); };
        window.switchUnitTab = function(tabName) { document.querySelectorAll('.unit-tab-btn').forEach(b => { b.classList.remove('active', 'border-indigo-600', 'text-indigo-700'); b.classList.add('border-transparent', 'text-slate-500'); }); document.querySelectorAll('.unit-tab-content').forEach(c => c.classList.add('hidden')); const btn = document.querySelector(`button[onclick="window.switchUnitTab('${tabName}')"]`); if(btn) { btn.classList.add('active', 'border-indigo-600', 'text-indigo-700'); btn.classList.remove('border-transparent', 'text-slate-500'); } const content = document.getElementById('uTab_'+tabName); if(content) content.classList.remove('hidden'); };
        
        function logAudit(modul, aktion, details, type="INFO") { const entry = { id: uuid(), date: nowDateTimeStr(), user: document.getElementById('userDisplay').innerText, modul, aktion, details: typeof details === 'object' ? JSON.stringify(details) : details, type }; db.audit.unshift(entry); if(db.audit.length > 1000) db.audit.pop(); saveLocal(); if(document.getElementById('panelAudit').classList.contains('active')) window.renderAudit(); }
        window.renderAll = function() { renderDashboard(); renderObjekte(); renderJournal(); renderAudit(); renderTickets(); renderStammdaten(); updateDropdowns(); };

        window.updateDropdowns = () => {
            const jFilter = document.getElementById('journalFilter');
            if(jFilter) {
                const current = jFilter.value;
                jFilter.innerHTML = '<option value="all">Alle Objekte</option>';
                db.objekte.forEach(o => { jFilter.add(new Option(o.name, o.id)); });
                if(current) jFilter.value = current;
            }
        };

        window.copyAuditToClip = () => { const text = document.getElementById('auditDetailContent').innerText; const textArea = document.createElement("textarea"); textArea.value = text; textArea.style.position = "fixed"; document.body.appendChild(textArea); textArea.focus(); textArea.select(); try { const successful = document.execCommand('copy'); if(successful) alert("Kopiert!"); else throw new Error("Copy failed"); } catch (err) { console.error('Copy fallback failed', err); logAudit('SYSTEM', 'ERROR', 'Clipboard Copy failed: ' + err.message, 'ERROR'); alert("Kopieren fehlgeschlagen. Bitte manuell markieren."); } document.body.removeChild(textArea); };

        window.generateAuditPDF = () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const m = db.mandant || {};
            doc.setFontSize(18); doc.text("Audit Protokoll / System-Log", 14, 20);
            doc.setFontSize(10); doc.setTextColor(100); 
            doc.text(`Erstellt am: ${nowDateTimeStr()}`, 14, 26);
            doc.text(`Mandant: ${m.name || 'Unbekannt'}`, 14, 32);
            const rows = db.audit.map(a => [a.date, a.modul, a.aktion, a.user, a.details.substring(0, 50)]);
            doc.autoTable({ startY: 40, head: [['Datum/Zeit', 'Modul', 'Aktion', 'User', 'Details']], body: rows, theme: 'grid', styles: { fontSize: 8 }, headStyles: { fillColor: [15, 23, 42] } });
            doc.save(`Audit_Protokoll_${nowStr()}.pdf`);
        };

        // --- NEW DOCUMENT FEATURES ---
        window.generateProtocolPDF = () => {
             const { jsPDF } = window.jspdf;
             const doc = new jsPDF();
             const u = db.einheiten.get(currentUnitId);
             
             doc.setFontSize(20); doc.text("Übergabeprotokoll", 14, 20);
             doc.setFontSize(12); doc.text(`Einheit: ${u.name}`, 14, 30);
             
             // List Meters
             const rows = (u.meters||[]).map(m => [m.type, m.nr, m.val, '', '']);
             doc.autoTable({ 
                 startY: 40, 
                 head: [['Zähler-Typ', 'Nummer', 'Stand Alt', 'Stand Neu', 'Unterschrift']], 
                 body: rows,
                 theme: 'grid'
             });
             
             // Signatures
             const finalY = doc.lastAutoTable.finalY + 20;
             doc.text("__________________________      __________________________", 14, finalY);
             doc.text("Vermieter                       Mieter", 14, finalY + 5);
             
             doc.save(`Protokoll_${u.name}.pdf`);
        };

        window.openDocFolder = () => {
             const u = db.einheiten.get(currentUnitId);
             const h = db.haeuser.get(u.hausId);
             const o = db.objekte.get(u.objId);
             
             const path = `Dokumente/${o.name}/${u.name}/`;
             const filename = `${nowStr()}_Protokoll.pdf`;
             
             const msg = `Ihr Cloud-Pfad:\n${path}\n\nVorschlag Dateiname:\n${filename}`;
             
             // Copy to clipboard
             navigator.clipboard.writeText(path).then(() => {
                 alert(msg + "\n\n(Pfad wurde in die Zwischenablage kopiert!)");
                 // Simulate opening (In real app: MS Graph Link)
                 // window.open('https://onedrive.live.com/...');
             });
        };
        
        window.toggleContractSort = () => {
            contractSortDesc = !contractSortDesc;
            window.renderContracts();
        };

        // --- DOSSIER FUNCTIONS ---
        window.openDossierMask = () => { document.getElementById('dossierModal').classList.add('active'); };

        window.runDossierExport = () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            let y = 20;
            doc.setFontSize(18); doc.text("Gesamtdossier - Objektbestand", 14, y); y += 10;
            doc.setFontSize(10); doc.setTextColor(100); 
            doc.text(`Erstellt am: ${nowDateTimeStr()}`, 14, y); y += 6;
            
            const includeObj = document.getElementById('dosObj').checked;
            const includeHaus = document.getElementById('dosHaeuser').checked;
            const includeUnits = document.getElementById('dosUnits').checked;

            db.objekte.forEach(o => {
                if(includeObj) {
                    if(y > 270) { doc.addPage(); y=20; }
                    doc.setFontSize(14); doc.setTextColor(0); doc.text(o.name, 14, y); y+=6;
                    doc.setFontSize(10); doc.setTextColor(100); doc.text(`${o.addr} (Nr: ${o.nr})`, 14, y); y+=8;
                }
                if(includeHaus || includeUnits) {
                    const hArr = Array.from(db.haeuser.values()).filter(h => h.objektId === o.id);
                    hArr.forEach(h => {
                        if(includeHaus) {
                            if(y > 270) { doc.addPage(); y=20; }
                            doc.setFontSize(12); doc.setTextColor(0); doc.text(`  > ${h.name}`, 14, y); y+=6;
                        }
                        if(includeUnits) {
                            const uArr = Array.from(db.einheiten.values()).filter(u => u.hausId === h.id);
                            uArr.forEach(u => {
                                const chain = window.calculateHistoryChain(u);
                                const current = chain.find(i => (!i.end || i.end >= nowStr()) && i.start <= nowStr()) || chain[chain.length-1];
                                let statusText = "Leerstand";
                                if(current && current.type === 'contract') {
                                    statusText = window.resolveContactName(current.data.tenantId);
                                }
                                const chainLbl = window.getChainLabel(u, current ? current.nr : 1);
                                if(y > 275) { doc.addPage(); y=20; }
                                doc.setFontSize(9); doc.setTextColor(50);
                                doc.text(`      - [${chainLbl}] ${u.name}: ${u.area}m² | ${statusText}`, 14, y); y+=5;
                            });
                            y+=2; 
                        }
                    });
                    y+=4;
                }
                y+=4;
            });
            doc.save(`Gesamtdossier_${nowStr()}.pdf`);
            window.closeModals();
        };

        window.renderKontakte = () => {
            const div = document.getElementById('contactList');
            let html = '';
            db.kontakte.forEach(k => {
                html += `<div class="bg-white p-4 rounded-xl border shadow-sm flex justify-between items-center cursor-pointer hover:bg-slate-50" onclick="window.editKontakt('${k.id}')"><div><div class="font-bold text-sm">${k.fn || 'Name fehlt'}</div><div class="text-xs text-slate-500">${k.str||'-'}, ${k.plz||''} ${k.ort||''}</div><div class="text-[10px] text-indigo-600 mt-1"><i class="fas fa-envelope mr-1"></i>${k.email||'-'} | ${k.iban ? 'SEPA vorhanden' : 'Kein SEPA'}</div></div><button onclick="event.stopPropagation(); window.deleteKontakt('${k.id}')" class="text-rose-400 hover:text-rose-600"><i class="fas fa-trash"></i></button></div>`;
            });
            div.innerHTML = html;
        };
        window.openContactMask = () => { 
            document.getElementById('kId').value = 'k_'+uuid(); 
            document.getElementById('kName').value=''; document.getElementById('kStr').value=''; document.getElementById('kPlz').value=''; document.getElementById('kOrt').value=''; document.getElementById('kEmail').value=''; document.getElementById('kTel').value=''; 
            document.getElementById('kIban').value=''; document.getElementById('kBic').value=''; document.getElementById('kBank').value=''; document.getElementById('kMandat').value='';
            document.getElementById('kontaktModal').classList.add('active'); 
        };
        window.editKontakt = (id) => {
            const k = db.kontakte.get(id); if(!k) return;
            document.getElementById('kId').value = k.id;
            document.getElementById('kName').value=k.fn; document.getElementById('kStr').value=k.str||''; document.getElementById('kPlz').value=k.plz||''; document.getElementById('kOrt').value=k.ort||''; document.getElementById('kEmail').value=k.email||''; document.getElementById('kTel').value=k.tel||'';
            document.getElementById('kIban').value=k.iban||''; document.getElementById('kBic').value=k.bic||''; document.getElementById('kBank').value=k.bank||''; document.getElementById('kMandat').value=k.mandat||'';
            document.getElementById('kontaktModal').classList.add('active');
        };

        window.saveKontakt = () => { 
            const id = document.getElementById('kId').value; 
            const k = { 
                id, fn: document.getElementById('kName').value, str: document.getElementById('kStr').value, plz: document.getElementById('kPlz').value, ort: document.getElementById('kOrt').value, email: document.getElementById('kEmail').value, tel: document.getElementById('kTel').value,
                iban: document.getElementById('kIban').value, bic: document.getElementById('kBic').value, bank: document.getElementById('kBank').value, mandat: document.getElementById('kMandat').value
            }; 
            db.kontakte.set(id, k); 
            const ts = document.getElementById('tsNewTenant'); if(ts) ts.add(new Option(k.fn, k.id));
            const cs = document.getElementById('cTenantSelect'); if(cs) { cs.add(new Option(k.fn, k.id)); cs.value = id; }
            saveLocal(); window.closeModals(); window.renderKontakte(); 
        };
        window.deleteKontakt = (id) => { if(confirm("Löschen?")) { db.kontakte.delete(id); saveLocal(); window.renderKontakte(); }};

        window.syncGlobalContacts = async () => {
            const t = await getValidToken();
            if(!t) { alert("Bitte erst einloggen!"); return; }
            
            setStatus('blue', 'Lade Kontakte...');
            try {
                const url = `https://graph.microsoft.com/v1.0/me/drive/root:/ideenapp/kontakte.json:/content`;
                const r = await fetch(url, { headers: {Authorization:`Bearer ${t}`} });
                if(!r.ok) throw new Error("Datei nicht gefunden oder Fehler beim Laden.");
                
                const globalData = await r.json();
                let imported = 0;
                
                if(Array.isArray(globalData)) {
                    globalData.forEach(gk => {
                        db.kontakte.set(gk.id, gk);
                        imported++;
                    });
                }
                
                saveLocal();
                window.renderKontakte();
                setStatus('green', `Import OK: ${imported}`);
                alert(`${imported} Kontakte erfolgreich importiert/aktualisiert.`);
                
            } catch(e) {
                console.error(e);
                setStatus('red', 'Import Fehler');
                alert("Fehler beim Import: " + e.message);
            }
        };

        window.calcRowSum = (elm) => {
            const tr = elm.closest('tr');
            if(!tr) return;
            const val = parseFloat(tr.querySelector('.c-val, .usc-val').value) || 0;
            const isM2 = tr.querySelector('.c-m2, .usc-m2').checked;
            let area = 0;
            if(document.getElementById('unitArea')) area = parseFloat(document.getElementById('unitArea').value) || 0;
            let sum = val;
            if(isM2) sum = val * area;
            const sumCell = tr.querySelector('.c-sum');
            if(sumCell) sumCell.innerText = formatEuro(sum);
        };

        window.addUnitStdCondRow = (d={}) => {
            const tb = document.getElementById('unitStdCondsBody');
            const tr = document.createElement('tr');
            const typeOpts = db.condTypes.map(t => `<option value="${t.label}" ${d.label===t.label?'selected':''}>${t.label}</option>`).join('');
            const startVal = d.start || nowStr();
            tr.innerHTML = `<td><select class="usc-lbl input-std text-xs w-32">${typeOpts}</select></td><td><div class="flex"><input type="number" class="usc-val input-std text-xs w-20" value="${d.val||0}" oninput="window.calcRowSum(this)"></div></td><td><label class="text-[9px]"><input type="checkbox" class="usc-m2" ${d.isM2?'checked':''} onchange="window.calcRowSum(this)">m²</label><td class="font-bold text-indigo-600 text-xs text-right pr-4 c-sum">0,00 €</td><td><input type="date" class="usc-start input-std text-xs w-24" value="${startVal}"></td><td><input type="date" class="usc-end input-std text-xs w-24" value="${d.end||''}"></td><td class="flex gap-1"><button onclick="window.duplicateUnitCondRow(this)" title="Kopie/Historie" class="bg-indigo-50 text-indigo-600 px-1 rounded hover:bg-indigo-100 font-bold">+</button><button onclick="this.closest('tr').remove()" class="text-rose-500 px-1 hover:bg-rose-50 rounded">×</button></td>`;
            tb.appendChild(tr);
            window.calcRowSum(tr.querySelector('.usc-val'));
        };

        window.duplicateUnitCondRow = (btn) => {
            const row = btn.closest('tr');
            const lbl = row.querySelector('.usc-lbl').value;
            const val = row.querySelector('.usc-val').value;
            const isM2 = row.querySelector('.usc-m2').checked;
            window.addUnitStdCondRow({ label: lbl, val: val, isM2: isM2, start: nowStr() });
        };

        window.harmonizeConditions = (conds) => {
            if(!conds || conds.length === 0) return [];
            conds.sort((a, b) => {
                if (a.label !== b.label) return a.label.localeCompare(b.label);
                return a.start.localeCompare(b.start);
            });
            const unique = [];
            for (let i = 0; i < conds.length; i++) {
                if (i < conds.length - 1 && conds[i].label === conds[i+1].label && conds[i].start === conds[i+1].start) {
                    continue; 
                }
                unique.push(conds[i]);
            }
            conds = unique;
            for (let i = 0; i < conds.length - 1; i++) {
                const current = conds[i];
                const next = conds[i+1];
                if (current.label === next.label) {
                    if (next.start > current.start) {
                        const nextDate = new Date(next.start);
                        nextDate.setDate(nextDate.getDate() - 1);
                        const newEnd = nextDate.toISOString().slice(0,10);
                        if (!current.end || current.end >= next.start) {
                            current.end = newEnd;
                        }
                    }
                }
            }
            return conds;
        };

        window.openAdjustmentWizard = () => document.getElementById('adjWizardModal').classList.add('active');
        
        window.executeAdjustment = () => {
            const u = db.einheiten.get(currentUnitId);
            if(!u.contracts || !u.contracts.length) return alert("Keine Verträge vorhanden.");
            const contractIdx = u.contracts.findIndex(x => (!x.end || x.end >= new Date().toISOString().slice(0,10)));
            if(contractIdx === -1) return alert("Kein aktiver Vertrag.");
            
            const contract = u.contracts[contractIdx];
            const pct = parseFloat(document.getElementById('adjPercent').value) / 100;
            const validDate = document.getElementById('adjDate').value;
            if(!validDate) return alert("Datum wählen");

            const newCondsToAdd = [];
            contract.conds.forEach(c => {
                if(!c.end || c.end >= validDate) {
                    if(['Kaltmiete', 'Stellplatz', 'Garage', 'Miete'].some(k => c.label.includes(k))) {
                        const newVal = (parseFloat(c.val) * (1 + pct)).toFixed(2);
                        newCondsToAdd.push({
                            label: c.label, val: newVal, isM2: c.isM2, intervall: c.intervall, gl: c.gl, start: validDate, end: ''
                        });
                    }
                }
            });

            if(newCondsToAdd.length === 0) return alert("Keine anpassbaren Konditionen gefunden.");
            contract.conds.push(...newCondsToAdd);
            contract.conds = window.harmonizeConditions(contract.conds); 
            u.contracts[contractIdx] = contract;
            db.einheiten.set(u.id, u);
            logAudit('VERTRAG', 'MIETANPASSUNG', `Erhöhung um ${(pct*100).toFixed(1)}% für ${u.name}`);
            saveLocal(); window.closeModals(); window.openContractModalEdit(contractIdx); 
            alert("Anpassung erfolgreich! Alte Konditionen wurden beendet.");
        };
        
        window.importUnitConditions = () => {
             const u = db.einheiten.get(currentUnitId);
             if(!u || !u.stdConds || u.stdConds.length === 0) {
                 return alert("Fehler: In dieser Einheit sind keine Soll-Konditionen (Stammdaten) hinterlegt.");
             }
             if(!confirm(`Möchten Sie ${u.stdConds.length} Konditionen aus der Einheit übernehmen?`)) return;
             document.getElementById('condListBody').innerHTML = "";
             const contractStart = document.getElementById('cStart').value || nowStr();
             let imported = 0;
             u.stdConds.forEach(c => {
                 window.addCondRow({
                     label: c.label, val: c.val, isM2: c.isM2, start: contractStart, end: ''
                 });
                 imported++;
             });
             if(imported === 0) alert("Keine Konditionen importiert.");
        };
        
        window.checkUnitLogic = () => {
            const area = parseFloat(document.getElementById('unitArea').value);
            if(!area || area <= 0) return alert("⚠️ Fehler: Fläche darf nicht 0 sein.");
            
            const emptyCost = Array.from(document.querySelectorAll('#unitDirectCostsBody tr')).some(r => !r.querySelector('.uc-amt').value || parseFloat(r.querySelector('.uc-amt').value)<=0 || !r.querySelector('.uc-start').value);
            if(emptyCost) return alert("⚠️ Fehler: Unvollständige Einträge bei 'Direkte Kosten'.");
            
            const emptyPers = Array.from(document.querySelectorAll('#unitPersonList tr')).some(r => !r.querySelector('.p-von').value || !r.querySelector('.p-anz').value || parseFloat(r.querySelector('.p-anz').value)<=0);
            if(emptyPers) return alert("⚠️ Fehler: Unvollständige Einträge bei 'Personen'.");

            const rows = Array.from(document.querySelectorAll('#unitStdCondsBody tr'));
            const conds = rows.map(r => ({
                start: r.querySelector('.usc-start').value,
                end: r.querySelector('.usc-end').value
            })).sort((a,b) => a.start.localeCompare(b.start));

            if(conds.length === 0) return alert("⚠️ Keine Soll-Konditionen vorhanden!");

            let gapFound = false;
            for(let i=0; i<conds.length-1; i++) {
                const currEnd = new Date(conds[i].end);
                const nextStart = new Date(conds[i+1].start);
                
                if(!conds[i].end) {
                    gapFound = true; // Open end in middle
                    break;
                }
                const diff = (nextStart - currEnd) / (1000 * 60 * 60 * 24);
                if(diff > 1) {
                    gapFound = true;
                    break;
                }
            }

            if(gapFound) {
                if(confirm("⚠️ LÜCKE ENTDECKT! Die Soll-Konditionen sind nicht lückenlos.\n\nMöchten Sie die Lücken automatisch schließen (Anschluss-Daten setzen)?")) {
                    window.fixUnitGaps();
                }
            } else {
                alert("✅ Prüfung erfolgreich: Fläche OK & Konditionen lückenlos.");
            }
        };

        window.fixUnitGaps = () => {
            let rows = Array.from(document.querySelectorAll('#unitStdCondsBody tr')).map(r => ({
                label: r.querySelector('.usc-lbl').value,
                val: r.querySelector('.usc-val').value,
                isM2: r.querySelector('.usc-m2').checked,
                start: r.querySelector('.usc-start').value,
                end: r.querySelector('.usc-end').value
            }));
            rows.sort((a,b) => a.start.localeCompare(b.start));
            for(let i=0; i<rows.length-1; i++) {
                const nextStart = new Date(rows[i+1].start);
                nextStart.setDate(nextStart.getDate() - 1);
                rows[i].end = nextStart.toISOString().slice(0,10);
            }
            document.getElementById('unitStdCondsBody').innerHTML = "";
            rows.forEach(window.addUnitStdCondRow);
            alert("✅ Lücken geschlossen. Bitte 'Speichern' nicht vergessen.");
        };
        
        window.filterOnlyVacancies = () => {
            document.getElementById('showVacancies').checked = true;
            window.renderContracts('__VACANCY_ONLY__');
        };

        window.renderContracts = function(filter = "") { 
            if(filter !== "" && filter !== "__VACANCY_ONLY__") {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => { _doRenderContracts(filter); }, 300);
            } else {
                _doRenderContracts(filter);
            }
        };

        function _doRenderContracts(filter) {
            const showVacancies = document.getElementById('showVacancies').checked;
            const vacancyOnlyMode = filter === '__VACANCY_ONLY__';
            if(vacancyOnlyMode) document.getElementById('showVacancies').checked = true;

            const b = document.getElementById('contractsBody'); if(!b) return; 
            
            let html = "";
            let vacCount = 0;
            let activeCount = 0;

            db.einheiten.forEach(u => { 
                const chain = window.calculateHistoryChain(u);
                
                // FEATURE: Sortierung umkehren
                if(contractSortDesc) chain.reverse();

                chain.forEach(item => {
                    const chainLabel = window.getChainLabel(u, item.nr);
                    const isVac = item.type === 'vacancy';

                    if(isVac) vacCount++;
                    if(!isVac && (!item.data.end || item.data.end >= nowStr())) activeCount++;

                    if(vacancyOnlyMode && !isVac) return;
                    if(!vacancyOnlyMode && filter && filter !== '' && filter !== '__VACANCY_ONLY__') {
                        const searchStr = (isVac ? 'Leerstand' : db.kontakte.get(item.data.tenantId)?.fn || '') + chainLabel;
                        if(!searchStr.toLowerCase().includes(filter.toLowerCase())) return;
                    }
                    if(!vacancyOnlyMode && !showVacancies && isVac) return;

                    if(isVac) {
                        html += `
                            <tr class="border-b chain-gap">
                                <td class="pl-6 py-2"><span class="bg-rose-100 text-rose-800 px-2 rounded font-bold text-[10px]">LEERSTAND</span></td>
                                <td class="font-mono text-xs font-bold text-rose-900">${chainLabel}</td>
                                <td>-</td>
                                <td class="italic text-rose-700">Leerstand (Nr. ${String(item.nr).padStart(2,'0')})</td>
                                <td class="font-mono text-rose-700">${item.start} - ${item.end||'offen'}</td>
                                <td class="text-right text-slate-400">0,00 €</td>
                                <td class="text-right pr-6"><button onclick="window.openEinheitMask('${u.hausId}','${u.id}'); window.switchUnitTab('vertrage')" class="text-xs bg-white border px-2 rounded">Verwalten</button></td>
                            </tr>`;
                    } else {
                        const c = item.data;
                        const tenant = window.resolveContactName(c.tenantId); 
                        const isActive = c.start <= nowStr() && (!c.end || c.end >= nowStr()); 
                        
                        let currentRent = 0; 
                        if(isActive) { 
                            (c.conds||[]).forEach(cond => { 
                                const today = nowStr();
                                if(cond.start <= today && (!cond.end || cond.end >= today)) { 
                                    let val = parseFloat(cond.val) || 0; 
                                    if(cond.isM2) val *= (parseFloat(u.area)||0); 
                                    currentRent += val; 
                                } 
                            }); 
                        } 
                        const status = isActive ? `<span class="bg-emerald-100 text-emerald-700 px-2 rounded font-bold">AKTIV</span>` : `<span class="bg-slate-100 text-slate-400 px-2 rounded">BEENDET</span>`; 
                        
                        html += `<tr class="hover:bg-slate-50 border-b"><td class="pl-6 py-2">${status}</td><td class="font-mono text-[10px] text-indigo-900">${chainLabel}</td><td>${u.type}</td><td><b>${tenant}</b><br><span class="text-[10px]">D-${c.debtor}</span></td><td>${c.start}<br><span class="text-[10px]">${c.end||'∞'}</span></td><td class="text-right font-mono font-bold">${isActive ? formatEuro(currentRent) : '-'}</td><td class="text-right pr-6"><button onclick="window.openEinheitMask('${u.hausId}','${u.id}'); setTimeout(()=>window.switchUnitTab('vertrage'),100)" class="text-blue-600 font-bold">Edit</button></td></tr>`;
                    }
                });
            }); 
            
            b.innerHTML = html;
            const elVac = document.getElementById('dashVacancyRate');
            const elAct = document.getElementById('dashActiveContracts');
            if(elVac) elVac.innerText = vacCount;
            if(elAct) elAct.innerText = activeCount;
        }

        // --- TENANT SWITCH WIZARD ---
        window.openTenantSwitchWizard = () => {
            const sel = document.getElementById('tsUnitSelect'); sel.innerHTML = '<option value="">- Einheit wählen -</option>';
            db.einheiten.forEach(u => {
                const activeC = (u.contracts||[]).find(c => !c.end || c.end >= nowStr());
                if(activeC) {
                    const tName = resolveContactName(activeC.tenantId);
                    sel.add(new Option(`${u.name} (Aktuell: ${tName})`, u.id));
                }
            });
            const selT = document.getElementById('tsNewTenant'); 
            selT.innerHTML = '<option value="">- Wählen -</option><option value="new">+ Neuer Kontakt</option><option value="vacancy" class="text-rose-600 font-bold">-- Leerstand (Kein Nachmieter) --</option>';
            db.kontakte.forEach(k => selT.add(new Option(k.fn, k.id)));
            
            document.getElementById('tsEndDate').value = nowStr();
            const tomorrow = new Date(); tomorrow.setDate(tomorrow.getDate()+1);
            document.getElementById('tsStartDate').value = tomorrow.toISOString().slice(0,10);
            
            document.getElementById('tenantSwitchModal').classList.add('active');
            window.toggleDebtorField();
        };
        
        window.updateTenantSwitchInfo = () => {
            window.toggleDebtorField();
        };

        window.toggleDebtorField = () => {
            const uId = document.getElementById('tsUnitSelect').value;
            const tId = document.getElementById('tsNewTenant').value;
            const dBox = document.getElementById('tsDebtorContainer');
            
            if(!uId || tId === 'vacancy') {
                dBox.style.display = 'none';
                return;
            }
            dBox.style.display = 'block';
            
            const u = db.einheiten.get(uId);
            let nextD = 10000;
            db.einheiten.forEach(unit => (unit.contracts||[]).forEach(c => { if(parseInt(c.debtor)>nextD) nextD=parseInt(c.debtor); }));
            document.getElementById('tsDebtorId').value = (nextD+1).toString();
            window.checkDebtorUniqueness((nextD+1).toString(), 'tsDebtorStatus');
        };
        
        window.executeTenantSwitch = () => {
            const uId = document.getElementById('tsUnitSelect').value;
            if(!uId) return alert("Bitte Einheit wählen");
            
            const u = db.einheiten.get(uId);
            const oldEnd = document.getElementById('tsEndDate').value;
            const newStart = document.getElementById('tsStartDate').value;
            const manualDebtor = document.getElementById('tsDebtorId').value;
            
            if(newStart <= oldEnd) return alert("Fehler: Einzug muss nach Auszug sein.");
            
            const activeIdx = u.contracts.findIndex(c => !c.end || c.end >= nowStr());
            if(activeIdx === -1) return alert("Kein aktiver Vertrag gefunden.");
            
            u.contracts[activeIdx].end = oldEnd;
            
            let tId = document.getElementById('tsNewTenant').value;
            if(tId === 'vacancy') {
                logAudit('VERTRAG', 'LEERSTAND', `Einheit ${u.name}: Auszug per ${oldEnd}`);
                db.einheiten.set(u.id, u);
                saveLocal();
                window.closeModals();
                window.renderContracts();
                window.renderDashboard(); 
                alert("Vertrag beendet. Einheit nun im Leerstand.");
                return;
            }

            if(!tId) return alert("Bitte neuen Mieter wählen.");
            if(tId === 'new') { tId = 'k_'+uuid(); db.kontakte.set(tId, {id:tId, fn:'Neuer Mieter '+uuid().substr(0,4)}); }
            
            let newConds = [];
            if(document.getElementById('tsCopyConds').checked && u.stdConds) {
                u.stdConds.forEach(sc => {
                    newConds.push({ label: sc.label, val: sc.val, isM2: sc.isM2, start: newStart, end: '', gl: '8500', intervall: 'monat' });
                });
            } else {
                newConds.push({ label: 'Kaltmiete', val: 0, isM2: false, start: newStart, end: '', gl: '8500', intervall: 'monat' });
            }

            const newContract = {
                id: uuid(),
                tenantId: tId,
                debtor: manualDebtor,
                start: newStart,
                end: '',
                deposit: 0,
                payType: 'sepa',
                conds: newConds,
                directCosts: []
            };
            
            u.contracts.push(newContract);
            db.einheiten.set(u.id, u);
            
            logAudit('VERTRAG', 'MIETERWECHSEL', `Einheit ${u.name}: Wechsel zu ${resolveContactName(tId)} (Debitor: ${manualDebtor})`);
            saveLocal();
            window.closeModals();
            window.renderContracts();
            window.renderDashboard();
            alert("Mieterwechsel erfolgreich durchgeführt!");
        };

        // RENDERERS & LOGIC
        window.renderDashboard = function() { 
            const today = nowStr();
            document.getElementById('dashUnitCount').innerText = db.einheiten.size; 
            let occ = 0; db.einheiten.forEach(u => { if((u.contracts||[]).some(c => c.start <= today && (!c.end || c.end >= today))) occ++; }); 
            const p = db.einheiten.size ? Math.round(occ/db.einheiten.size*100) : 0; 
            document.getElementById('dashOccupancy').innerText = p + "%"; 
            document.getElementById('occBar').style.width = p + "%"; 
            
            const radarList = document.getElementById('radarList');
            const switchList = document.getElementById('dashTenantSwitchList');
            
            if(radarList && switchList) {
                let radarHtml = "";
                let switchHtml = "";
                
                const future90 = new Date(); future90.setDate(new Date().getDate() + 90);
                const future30 = new Date(); future30.setDate(new Date().getDate() + 30);
                const past30 = new Date(); past30.setDate(new Date().getDate() - 30);
                
                const future90Str = future90.toISOString().slice(0,10);
                const future30Str = future30.toISOString().slice(0,10);
                const past30Str = past30.toISOString().slice(0,10);
                
                let changeCount = 0;
                let switchCount = 0;

                db.einheiten.forEach(u => {
                    const activeC = (u.contracts||[]).find(c => !c.end || c.end >= today);
                    if (!activeC) {
                        switchHtml += `<div class="p-2 border-b border-rose-100 bg-rose-50 flex justify-between items-center rounded cursor-pointer hover:bg-rose-100" onclick="window.openEinheitMask('${u.hausId}','${u.id}'); setTimeout(()=>window.switchUnitTab('vertrage'),200)"><div class="text-[10px] text-rose-700 font-bold"><i class="fas fa-exclamation-triangle mr-1"></i>LEERSTAND</div><div class="text-xs font-bold text-slate-700">${u.name}</div></div>`;
                        switchCount++;
                    }

                    (u.contracts||[]).forEach(c => {
                        if(c.end && c.end >= past30Str && c.end <= future30Str) {
                            switchHtml += `<div class="p-2 border-b border-slate-100 flex justify-between items-center cursor-pointer hover:bg-slate-50" onclick="window.openEinheitMask('${u.hausId}','${u.id}')"><div class="text-[10px]"><span class="text-rose-500 font-bold">AUSZUG</span> ${c.end}</div><div class="text-xs truncate w-24">${u.name}</div></div>`;
                            switchCount++;
                        }
                        if(c.start >= today && c.start <= future30Str) {
                            switchHtml += `<div class="p-2 border-b border-slate-100 flex justify-between items-center cursor-pointer hover:bg-slate-50" onclick="window.openEinheitMask('${u.hausId}','${u.id}')"><div class="text-[10px]"><span class="text-emerald-500 font-bold">EINZUG</span> ${c.start}</div><div class="text-xs truncate w-24">${u.name}</div></div>`;
                            switchCount++;
                        }
                        if((!c.end || c.end >= today)) {
                             (c.conds||[]).forEach(cond => {
                                 if(cond.start >= today && cond.start <= future90Str) {
                                     changeCount++;
                                     radarHtml += `<div class="p-2 border-b border-slate-100 cursor-pointer hover:bg-slate-50" onclick="window.openEinheitMask('${u.hausId}','${u.id}'); setTimeout(()=>window.switchUnitTab('vertrage'),200)"><div class="flex justify-between"><span class="text-[10px] font-bold text-amber-600">AB ${cond.start}</span><span class="text-[10px]">${u.name}</span></div><div class="text-xs text-slate-600">${cond.label}: ${formatEuro(parseFloat(cond.val))}</div></div>`;
                                 }
                             });
                        }
                    });
                });
                
                if(switchCount === 0) switchHtml = '<div class="text-[10px] text-slate-400 italic text-center p-2">Keine Wechsel (+/- 30 Tage)</div>';
                if(changeCount === 0) radarHtml = '<div class="text-[10px] text-slate-400 italic text-center p-2">Keine Anpassungen (90 Tage)</div>';
                
                switchList.innerHTML = switchHtml;
                radarList.innerHTML = radarHtml;
                
                document.getElementById('dashAdjustments').innerText = changeCount;
            }

            // --- DEEP CHECK LOGIC UPDATED ---
            window.runPlausibilityCheck = () => {
                const wl = document.getElementById('warnList');
                if(!wl) return;
                wl.innerHTML = "";
                let issues = 0;
                let out = "";
                const logSection = (title) => { out += `<div class="check-log-title">${title}</div>`; };
                const logFail = (msg, fn, crit=false) => {
                    issues++;
                    out += `<div class="${crit?'check-fail':'check-warn'}"><span>${crit?'🛑':'⚠️'} ${msg}</span><button onclick="${fn}" class="text-[9px] bg-white border px-1 rounded uppercase hover:bg-slate-100">Fix</button></div>`;
                };

                logSection("Prüfung: Lückenlosigkeit (Ketten)");
                db.einheiten.forEach(u => {
                    const chain = window.calculateHistoryChain(u);
                    const currentVac = chain.find(i => i.type === 'vacancy' && (!i.end || i.end >= nowStr()));
                    if(currentVac) {
                        const lbl = window.getChainLabel(u, currentVac.nr);
                        logFail(`Lücke / Leerstand (${lbl})`, `window.openEinheitMask('${u.hausId}','${u.id}'); window.switchUnitTab('vertrage')`, true);
                    }
                });
                
                logSection("Prüfung: Integrität & Vollständigkeit");
                db.einheiten.forEach(u => {
                    if(u.costs && u.costs.some(c => !c.amt || c.amt <= 0 || !c.start)) {
                         logFail(`${u.name}: Kosten unvollständig`, `window.openEinheitMask('${u.hausId}','${u.id}'); window.switchUnitTab('kosten')`, true);
                    }
                    if(u.persons && u.persons.some(p => !p.von || !p.anz || p.anz <= 0)) {
                         logFail(`${u.name}: Personen-Daten unvollständig`, `window.openEinheitMask('${u.hausId}','${u.id}'); window.switchUnitTab('personen')`, true);
                    }
                    if(u.type === 'Wohnung' && (!u.persons || u.persons.length === 0)) {
                         logFail(`${u.name}: Keine Personen (BK)`, `window.openEinheitMask('${u.hausId}','${u.id}'); window.switchUnitTab('personen')`, false);
                    }
                    if(u.costs && u.costs.some(c => c.end && c.start > c.end)) {
                        logFail(`${u.name}: Kosten-Datum unlogisch`, `window.openEinheitMask('${u.hausId}','${u.id}'); window.switchUnitTab('kosten')`, true);
                    }
                });

                logSection("Prüfung: Objekt & Einheiten Details");
                db.objekte.forEach(o => {
                    if (o.archived) return;
                    const hArr = Array.from(db.haeuser.values()).filter(h => h.objektId === o.id);
                    if(hArr.length === 0) {
                        logFail(`${o.name}: Keine Häuser`, `window.openHausModal('${o.id}')`, true);
                    } else {
                        hArr.forEach(h => {
                            const uArr = Array.from(db.einheiten.values()).filter(u => u.hausId === h.id);
                            uArr.forEach(u => {
                                const activeContracts = (u.contracts||[]).filter(c => !c.end || c.end > nowStr());
                                if(activeContracts.length > 1) {
                                    let overlap = false;
                                    for(let i=0; i<activeContracts.length; i++) {
                                        for(let j=i+1; j<activeContracts.length; j++) {
                                            if(activeContracts[i].start <= (activeContracts[j].end||'9999-99-99') && (activeContracts[i].end||'9999-99-99') >= activeContracts[j].start) {
                                                overlap = true;
                                            }
                                        }
                                    }
                                    if(overlap) logFail(`${u.name}: Überlappende Verträge!`, `window.openEinheitMask('${h.id}','${u.id}'); setTimeout(()=>window.switchUnitTab('vertrage'),200)`, true);
                                }
                                if((!u.meters || u.meters.length === 0) && u.type === 'Wohnung') {
                                    logFail(`${u.name}: Keine Zähler`, `window.openEinheitMask('${h.id}','${u.id}'); setTimeout(()=>window.switchUnitTab('zaehler'),200)`, false);
                                }
                            });
                        });
                    }
                });
                
                if(issues === 0) out += "<div class='text-xs text-center text-emerald-600 font-bold p-4 mt-4 bg-emerald-50 rounded border border-emerald-200'><i class='fas fa-check-double text-2xl mb-1'></i><br>Systemstatus: EXZELLENT</div>";
                wl.innerHTML = out;
            };
            
            const ctx = document.getElementById('mainChart'); if(ctx) { if(mainChart) mainChart.destroy(); mainChart = new Chart(ctx, { type: 'bar', data: { labels: ['Soll', 'Ist'], datasets: [{ label: 'Monat', data: [12000, 11500], backgroundColor: ['#6366f1', '#10b981'] }] }, options: { maintainAspectRatio: false, plugins: { legend: { display: false } } } }); } 
        };
        
        window.openTicketMask = () => { 
            const selObj = document.getElementById('tickObj'); selObj.innerHTML = '<option value="">- Objekt wählen -</option>';
            db.objekte.forEach(o => selObj.add(new Option(o.name, o.id)));
            document.getElementById('ticketModal').classList.add('active'); 
        };
        window.updateTicketHouses = () => {
            const oid = document.getElementById('tickObj').value;
            const selH = document.getElementById('tickHaus'); selH.innerHTML = '<option value="">- Haus wählen -</option>';
            db.haeuser.forEach(h => { if(h.objektId === oid) selH.add(new Option(h.name, h.id)); });
        };
        window.updateTicketUnits = () => {
            const hid = document.getElementById('tickHaus').value;
            const selU = document.getElementById('tickUnit'); selU.innerHTML = '<option value="">- Einheit wählen -</option>';
            db.einheiten.forEach(u => { 
                if(u.hausId === hid) {
                    const activeC = (u.contracts||[]).find(c => !c.end || c.end >= nowStr());
                    const tenant = activeC ? resolveContactName(activeC.tenantId) : "Leerstand";
                    selU.add(new Option(`${u.name} (${tenant})`, u.id)); 
                }
            });
        };

        window.renderTickets = function() { 
            const cols = { open: document.getElementById('ticketsOpen'), prog: document.getElementById('ticketsProg'), done: document.getElementById('ticketsDone') }; 
            if(!cols.open) return; 
            let bufOpen = "", bufProg = "", bufDone = "";
            
            db.tickets.forEach((t, idx) => { 
                const u = db.einheiten.get(t.einheitId); 
                const html = `<div class="bg-white p-3 rounded border shadow-sm text-xs cursor-pointer hover:bg-slate-50" onclick="window.openTicketModal(${idx})"><div class="flex justify-between font-bold mb-1"><span>${t.titel}</span><span class="text-[9px] text-slate-400">${t.date||''}</span></div><div class="text-[10px] text-slate-500 truncate">${u?.name || 'Keine Einheit'}</div></div>`; 
                if(t.status === 'open') bufOpen += html;
                else if(t.status === 'prog') bufProg += html;
                else if(t.status === 'done') bufDone += html;
            });
            cols.open.innerHTML = bufOpen;
            cols.prog.innerHTML = bufProg;
            cols.done.innerHTML = bufDone;
        };
        window.renderAudit = function(filter='') { 
            const b = document.getElementById('auditBody'); if(!b) return; 
            let html = "";
            db.audit.filter(a => JSON.stringify(a).toLowerCase().includes(filter.toLowerCase())).slice(0, 100).forEach(a => { 
                html += `<tr class="audit-row ${a.type==='ERROR'?'audit-error':''}" onclick="window.showAuditDetail('${a.id}')"><td>${a.date}</td><td><span class="badge badge-no">${a.modul}</span></td><td><b>${a.aktion}</b></td><td>${a.user}</td><td class="truncate max-w-xs text-xs text-slate-400 font-mono">${a.details}</td></tr>`; 
            }); 
            b.innerHTML = html;
        };
        
        window.renderStammdaten = function() { 
            const glList = document.getElementById('glList'); if(glList) glList.innerHTML = db.sachkonten.map(s => `<div class="flex justify-between border-b p-1 text-xs"><b>${s.id}</b> <span class="truncate ml-2">${s.name}</span></div>`).join(''); 
            const condList = document.getElementById('condTypeList'); if(condList) condList.innerHTML = db.condTypes.map(c => `<tr class="border-b bg-white hover:bg-slate-50"><td class="p-2 font-bold">${c.label}</td><td class="p-2 font-mono text-indigo-600">${c.gl}</td><td class="p-2"><span class="badge bg-slate-100">${c.tax||'-'}</span></td><td class="p-2 text-xs uppercase">${c.intervall}</td><td class="p-2 text-right"><button class="text-rose-500 hover:bg-rose-50 p-1 rounded" onclick="window.deleteCondType('${c.label}')"><i class="fas fa-trash"></i></button></td></tr>`).join(''); 
            
            // Render select options efficiently
            const glOpts = db.sachkonten.map(s => `<option value="${s.id}">${s.id} ${s.name}</option>`).join('');
            const glSel = document.getElementById('newCondGl'); if(glSel) glSel.innerHTML = glOpts;
            const accSel = document.getElementById('newCostAcc'); if(accSel) accSel.innerHTML = glOpts;
            
            const vKeyList = document.getElementById('vKeyList'); if(vKeyList) vKeyList.innerHTML = db.vKeys.map(v => `<div class="border-b p-1 text-xs">${v}</div>`).join(''); 
            const unitTypeList = document.getElementById('unitTypeList'); if(unitTypeList) unitTypeList.innerHTML = db.unitTypes.map(t => `<div class="border-b p-1 text-xs">${t}</div>`).join(''); 
            const taxKeyList = document.getElementById('taxKeyList'); if(taxKeyList) taxKeyList.innerHTML = db.taxKeys.map(t => `<div class="flex justify-between border-b p-1 text-xs"><b>${t.id}</b> ${t.name} (${t.rate}%)</div>`).join(''); 
            const meterTypeList = document.getElementById('meterTypeList'); if(meterTypeList) meterTypeList.innerHTML = db.meterTypes.map(m => `<div class="border-b p-1 text-xs">${m}</div>`).join(''); 
            const costTypeList = document.getElementById('costTypeList'); if(costTypeList) costTypeList.innerHTML = db.costTypes.map(c => `<div class="flex justify-between border-b p-1 text-xs"><span>${c.name} (${c.unit})</span><div class="flex gap-1 text-[9px] text-slate-400"><span class="${c.uml?'text-emerald-600 font-bold':''}">${c.uml?'BK':''}</span><span class="${c.taxDeductible?'text-blue-600 font-bold':''}">${c.taxDeductible?'St':''}</span></div><button onclick="window.deleteCostType('${c.id}')" class="text-rose-500">×</button></div>`).join(''); 
        };

        window.renderObjekte = function() { 
            const l = document.getElementById('objekteListe'); if(!l) return; 
            let html = ""; 
            db.objekte.forEach((o, oid) => { 
                if(activeFocus && activeFocus !== oid) return; 
                if(!showArchived && o.archived) return; 
                if(showArchived && !o.archived) return; 
                
                const hArr = Array.from(db.haeuser.values()).filter(h => h.objektId === o.id); 
                html += `<div class="card overflow-hidden shadow-md ${o.archived ? 'opacity-75 border-2 border-amber-300' : ''}"><div class="bg-slate-900 text-white p-4 flex justify-between items-center"><div><h3 class="font-bold text-lg">${o.name} ${o.archived?'(ARCHIV)':''}</h3><span class="text-[10px] opacity-60 tracking-widest">${o.nr || oid}</span></div><div class="flex gap-2"><button onclick="window.openObjektMask('${oid}')" class="p-2 bg-white/10 rounded hover:bg-white/20"><i class="fas fa-cog"></i></button><button onclick="window.toggleFilter('${oid}')" class="px-3 py-1 bg-emerald-600 rounded text-xs font-bold !text-white">FOKUS</button></div></div><div class="p-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 bg-slate-50/50">`; 
                
                hArr.forEach(h => { 
                    const uArr = Array.from(db.einheiten.values()).filter(e => e.hausId === h.id); 
                    html += `<div class="bg-white border rounded-xl p-4 shadow-sm"><div class="flex justify-between items-center mb-3 border-b pb-2"><span class="font-black text-xs uppercase cursor-pointer hover:text-indigo-600" onclick="window.openHausModal('${oid}','${h.id}')">${h.name}</span><button onclick="window.openEinheitMask('${h.id}')" class="text-[10px] font-black text-indigo-600 bg-indigo-50 px-2 py-1 rounded">+ TOP</button></div><div class="space-y-2">`; 
                    uArr.forEach(u => { 
                        const chain = window.getChainedID(u.id); 
                        html += `<div class="p-2 border rounded hover:border-indigo-400 cursor-pointer transition-all bg-white" onclick="window.openEinheitMask('${h.id}','${u.id}')"><div class="text-[10px] text-indigo-600 font-mono mb-1">${chain}</div><div class="flex justify-between text-xs font-bold mb-1"><span>${u.name}</span><span>${u.area} m²</span></div><button onclick="event.stopPropagation(); window.openKontoModal('${u.id}')" class="text-[9px] font-bold text-blue-600 hover:underline">Konto</button></div>`; 
                    }); 
                    html += `</div></div>`; 
                }); 
                html += `<button onclick="window.openHausModal('${oid}')" class="border-2 border-dashed border-slate-300 rounded-xl p-8 text-slate-300 hover:text-slate-500 hover:bg-slate-100 flex flex-col items-center justify-center transition-all"><i class="fas fa-plus text-2xl mb-2"></i><span class="text-xs font-bold uppercase">Haus anlegen</span></button></div></div>`; 
            });
            l.innerHTML = html; 
        };
        
        window.renderJournal = function() { 
            const b = document.getElementById('journalBody'); if(!b) return; 
            let html = "";
            const fil = document.getElementById('journalFilter')?.value; 
            db.finanzen.sort((a,b)=>b.buchungsdatum.localeCompare(a.buchungsdatum)).forEach(f => { 
                if(fil && fil !== 'all' && f.objId !== fil) return; 
                const u = db.einheiten.get(f.einheitId); 
                const o = db.objekte.get(f.objId); 
                const h = u ? db.haeuser.get(u.hausId) : null; 
                let debtor = "-"; 
                if(u) { const c = (u.contracts||[]).find(c => c.start <= f.buchungsdatum && (!c.end || c.end >= f.buchungsdatum)); if(c) debtor = c.debtor; } 
                html += `<tr><td>${f.buchungsdatum}</td><td><span class="text-xs bg-slate-100 p-1 rounded border">${f.beleg||f.id.substr(-6)}</span></td><td class="text-[10px] text-slate-500">${o?.nr||'?'} / ${h?.name||'?'} / ${u?.name||'?'}</td><td class="font-mono text-xs">${debtor}</td><td>${f.text}</td><td class="text-right text-rose-600">${f.typ==='soll'?formatEuro(f.betrag):''}</td><td class="text-right text-emerald-600">${f.typ==='haben'?formatEuro(f.betrag):''}</td></tr>`; 
            }); 
            b.innerHTML = html;
        };

        window.addCostType = () => { const name = document.getElementById('newCostName').value; if(!name) return; db.costTypes.push({ id: 'ct_'+uuid(), name: name, unit: document.getElementById('newCostUnit').value, acc: document.getElementById('newCostAcc').value, uml: document.getElementById('newCostUml').checked, taxDeductible: document.getElementById('newCostTax').checked, ext: false }); logAudit('STAMMDATEN', 'KOSTENART', `Angelegt: ${name}`); saveLocal(); window.renderStammdaten(); };
        window.deleteCostType = (id) => { db.costTypes = db.costTypes.filter(c => c.id !== id); logAudit('STAMMDATEN', 'DELETE', `Kostenart gelöscht`); saveLocal(); renderStammdaten(); };
        window.addSmartCondType = () => { const l = document.getElementById('newCondLabel').value; if(l) { db.condTypes.push({ label: l, gl: document.getElementById('newCondGl').value, tax: 'auto', intervall: document.getElementById('newCondInt').value }); logAudit('STAMMDATEN', 'KONDITION', `Angelegt: ${l}`); saveLocal(); renderStammdaten(); } };
        window.deleteCondType = (l) => { db.condTypes = db.condTypes.filter(c => c.label !== l); saveLocal(); renderStammdaten(); };
        window.addVKey = () => { const v = document.getElementById('newVKey').value; if(v){ db.vKeys.push(v); saveLocal(); renderStammdaten(); } };
        window.addUnitType = () => { const v = document.getElementById('newUnitType').value; if(v){ db.unitTypes.push(v); saveLocal(); renderStammdaten(); } };
        window.addMeterType = () => { const v = document.getElementById('newMeterType').value; if(v){ db.meterTypes.push(v); saveLocal(); renderStammdaten(); } };
        window.addTaxKey = () => { const i = document.getElementById('newTaxId').value; const r = document.getElementById('newTaxRate').value; if(i){ db.taxKeys.push({id:i, name:r+'% USt', rate:r}); saveLocal(); renderStammdaten(); } };

        window.openGeneratorMask = () => { const conf = JSON.parse(localStorage.getItem('gen_last_config') || '{}'); if(conf.objName) document.getElementById('genObjName').value = conf.objName; if(conf.address) document.getElementById('genAddress').value = conf.address; document.getElementById('generatorModal').classList.add('active'); };
        window.applyGenTemplate = () => { const t = document.getElementById('genTemplate').value; if(t === 'mfh_std') { document.getElementById('genObjName').value = "Wohnpark Mitte (Muster)"; document.getElementById('genHausCount').value = 2; document.getElementById('genUnitCount').value = 6; } else if (t === 'gewerbe') { document.getElementById('genObjName').value = "Business Center North"; document.getElementById('genHausCount').value = 1; document.getElementById('genUnitCount').value = 15; } };
        window.runEnterpriseGenerator = async () => { const logBox = document.getElementById('genLog'); const log = (msg, type='info') => { logBox.innerHTML += `<div class="gen-log-entry gen-log-${type}">${msg}</div>`; logBox.scrollTop = logBox.scrollHeight; }; log("🚀 Starte Generator 2.0...", 'success'); const cfg = { name: document.getElementById('genObjName').value, addr: document.getElementById('genAddress').value, hC: parseInt(document.getElementById('genHausCount').value), uC: parseInt(document.getElementById('genUnitCount').value), vac: parseInt(document.getElementById('genVacancy').value) }; localStorage.setItem('gen_last_config', JSON.stringify({objName: cfg.name, address: cfg.addr})); const oid = 'o_' + uuid(); db.objekte.set(oid, {id: oid, name: cfg.name, nr: oid, addr: cfg.addr}); log(`Objekt angelegt: ${cfg.name}`); await new Promise(r => setTimeout(r, 500)); let stats = { units: 0, contracts: 0 }; const addrParts = cfg.addr.match(/^(.+?)\s*(\d+)$/); const street = addrParts ? addrParts[1] : cfg.addr; let startNr = addrParts ? parseInt(addrParts[2]) : 1; for(let i=0; i < cfg.hC; i++) { const hid = 'h_' + uuid(); const hName = `Haus ${startNr + (i*2)}`; db.haeuser.set(hid, {id: hid, objektId: oid, name: hName, measoll: 1000}); log(`> ${hName} erstellt...`); await new Promise(r => setTimeout(r, 100)); for(let j=0; j < cfg.uC; j++) { const uid = 'u_' + uuid(); const uName = `Top ${j+1}`; const isVacant = (Math.random() * 100) < cfg.vac; const area = 50 + Math.floor(Math.random()*60); const unit = { id: uid, hausId: hid, objId: oid, name: uName, type: 'Wohnung', area: area, contracts: [], costs: [], persons: [], stdConds: [{label:'Kaltmiete', val: 12.50, isM2: true}], meters: [] }; if(!isVacant) { const tId = 'k_' + uuid(); db.kontakte.set(tId, {id: tId, fn: `Muster Mieter ${uuid().substr(0,4)}`}); unit.contracts.push({ id: uuid(), tenantId: tId, debtor: `${10000+stats.contracts}`, start: '2025-01-01', conds: [{label:'Kaltmiete', val: 12.50, isM2: true, start:'2025-01-01', end:''}] }); stats.contracts++; } db.einheiten.set(uid, unit); stats.units++; } } log(`✅ FERTIG! ${stats.units} Einheiten, ${stats.contracts} Verträge generiert.`, 'success'); logAudit('GENERATOR', 'RUN', `Objekt ${cfg.name} mit ${stats.units} Einheiten generiert.`); saveLocal(); setTimeout(() => { window.closeModals(); window.renderAll(); }, 1500); };

        // --- SAVING & LOADING ---
        window.saveContract = () => { 
            const u = db.einheiten.get(currentUnitId); if(!u.contracts) u.contracts = []; 
            let tId = document.getElementById('cTenantSelect').value; if(tId === 'new') { window.openContactMask(); return; }
            
            const conds = [];
            document.querySelectorAll('#condListBody tr').forEach(r => {
                const l = r.querySelector('.c-lbl')?.value;
                const v = r.querySelector('.c-val')?.value;
                const m = r.querySelector('.c-m2')?.checked;
                const s = r.querySelector('.c-start')?.value;
                const e = r.querySelector('.c-end')?.value;
                
                const i = r.querySelector('.c-int')?.value || 'monat';
                const g = r.querySelector('.c-gl')?.value || '8500';

                // Only add if essential data is present
                if(l && v && s) {
                    conds.push({ label: l, val: v, isM2: m, intervall: i, gl: g, start: s, end: e });
                }
            });

            // 1. Pre-Contract Check (Error)
            const cStart = document.getElementById('cStart').value;
            if(cStart && conds.some(c => c.start < cStart)) {
                return alert("🛑 Fehler: Eine Kondition beginnt vor dem Vertragsstart (" + cStart + ")!");
            }

            // 2. Logic: Value Reduction & Date Sequence (Warnings)
            // We use the 'conds' array (as entered by user) for sequence check
            let dateWarning = false;
            for(let i=0; i<conds.length-1; i++) {
                if(conds[i+1].start < conds[i].start) dateWarning = true;
            }
            if(dateWarning) {
                if(!confirm("⚠️ Chronologie-Warnung:\nDie eingegebenen Datumswerte sind nicht chronologisch.\n(Das System sortiert diese automatisch.)\n\nFortfahren?")) return;
            }

            // LOGIC: Harmonize before saving
            const harmonizedConds = window.harmonizeConditions(conds);

            // Reduction Check (on sorted data)
            let reductionWarning = false;
            for(let i=0; i<harmonizedConds.length-1; i++) {
                if(harmonizedConds[i].label === harmonizedConds[i+1].label) {
                    if(parseFloat(harmonizedConds[i+1].val) < parseFloat(harmonizedConds[i].val)) {
                        reductionWarning = true;
                    }
                }
            }
            if(reductionWarning) {
                if(!confirm("📉 Mietminderungs-Warnung:\nEin oder mehrere Beträge sinken im Zeitverlauf.\n\nIst das beabsichtigt?")) return;
            }

            const contractCosts = [];
            document.querySelectorAll('#contractCostBody tr').forEach(r => {
                const l = r.querySelector('.cc-lbl')?.value;
                const v = r.querySelector('.cc-val')?.value;
                if(l && v) contractCosts.push({ label: l, val: v });
            });

            const cData = { 
                id: currentContractIdx !== null ? u.contracts[currentContractIdx].id : uuid(), 
                tenantId: tId, 
                debtor: document.getElementById('cDebtor').value, 
                start: document.getElementById('cStart').value, 
                end: document.getElementById('cEnd').value, 
                deposit: document.getElementById('cDeposit').value, 
                payType: document.getElementById('cPayType').value, 
                conds: harmonizedConds, 
                directCosts: contractCosts 
            }; 
            
            if(currentContractIdx !== null) {
                logAudit('VERTRAG', 'UPDATE', `Vertrag Mieter ${tId} aktualisiert (${harmonizedConds.length} Konditionen)`);
                u.contracts[currentContractIdx] = cData; 
            } else {
                logAudit('VERTRAG', 'CREATE', `Neuer Vertrag Mieter ${tId}`);
                u.contracts.push(cData); 
            }
            
            db.einheiten.set(u.id, u); 
            saveLocal(); window.closeModals(); window.openEinheitMask(u.hausId, u.id); setTimeout(() => window.switchUnitTab('vertrage'), 50); 
        };

        window.saveUnit = () => { 
            const id = currentUnitId || 'u_'+uuid(); 
            
            // --- STRICT VALIDATION FOR COSTS & PERSONS ---
            const costsRows = Array.from(document.querySelectorAll('#unitDirectCostsBody tr'));
            const costs = [];
            for(let r of costsRows) {
                const amt = parseFloat(r.querySelector('.uc-amt').value);
                const start = r.querySelector('.uc-start').value;
                // Check integrity
                if(!amt || amt <= 0) return alert("🛑 Speichern blockiert! \nFehler bei 'Direkte Kosten': Betrag fehlt oder ist 0.");
                if(!start) return alert("🛑 Speichern blockiert! \nFehler bei 'Direkte Kosten': Startdatum fehlt.");
                
                costs.push({ typeId: r.querySelector('.uc-type').value, qty: r.querySelector('.uc-qty').value, amt: amt, start: start, end: r.querySelector('.uc-end').value });
            }

            const personRows = Array.from(document.querySelectorAll('#unitPersonList tr'));
            const persons = [];
            for(let r of personRows) {
                const von = r.querySelector('.p-von').value;
                const anz = parseFloat(r.querySelector('.p-anz').value);
                // Check integrity
                if(!von) return alert("🛑 Speichern blockiert! \nFehler bei 'Personen': Startdatum (Von) fehlt.");
                if(!anz || anz <= 0) return alert("🛑 Speichern blockiert! \nFehler bei 'Personen': Anzahl Personen fehlt oder ist 0.");
                
                persons.push({ von: von, bis: r.querySelector('.p-bis').value, anz: anz, notiz: r.querySelector('.p-not').value });
            }

            const meters = Array.from(document.querySelectorAll('#unitMetersBody tr')).map(r => ({
                type: r.querySelector('.m-type').value, nr: r.querySelector('.m-nr').value, val: r.querySelector('.m-val').value, date: r.querySelector('.m-date').value, valid: r.querySelector('.m-valid').value
            }));

            let stdConds = Array.from(document.querySelectorAll('#unitStdCondsBody tr')).map(r => ({
                label: r.querySelector('.usc-lbl').value, 
                val: r.querySelector('.usc-val').value, 
                isM2: r.querySelector('.usc-m2').checked, 
                start: r.querySelector('.usc-start').value, 
                end: r.querySelector('.usc-end').value
            }));
            stdConds = window.harmonizeConditions(stdConds); // APPLY HARMONIZATION

            const e = db.einheiten.get(id) || {}; 
            db.einheiten.set(id, { ...e, id, name: document.getElementById('unitName').value, type: document.getElementById('unitTypeSelect').value, area: document.getElementById('unitArea').value, lage: document.getElementById('unitLage').value, tax: document.getElementById('unitTax').value, costs: costs, persons: persons, stdConds: stdConds, meters: meters }); 
            logAudit('EINHEIT', 'SAVE', `Einheit ${document.getElementById('unitName').value} gespeichert`); saveLocal(); window.closeModals(); window.renderAll(); 
        };

        window.openEinheitMask = (hId, uId=null) => { 
            currentUnitId = uId; 
            const e = uId ? db.einheiten.get(uId) : { hausId: hId, objId: db.haeuser.get(hId).objektId, name:'', area:0, tax:'auto', contracts:[], costs:[], persons:[], stdConds:[], meters:[] }; 
            if(!e.costs) e.costs = []; if(!e.persons) e.persons = []; if(!e.stdConds) e.stdConds = []; if(!e.meters) e.meters = [];
            
            // UPDATED TITLE WITH CHAIN
            const chainId = uId ? window.getChainedID(uId) : 'Neu';
            document.getElementById('modalUnitTitle').innerHTML = `<span class="text-sm font-mono text-slate-400 block">${chainId}</span> ${e.name}`; 
            
            document.getElementById('unitName').value = e.name; document.getElementById('unitArea').value = e.area; document.getElementById('unitTypeSelect').innerHTML = db.unitTypes.map(t=>`<option value="${t}" ${e.type===t?'selected':''}>${t}</option>`).join(''); document.getElementById('unitLage').value = e.lage||''; document.getElementById('unitTax').value = e.tax||'auto'; 
            
            document.getElementById('unitDirectCostsBody').innerHTML = ""; (e.costs||[]).forEach(window.addUnitCostRow); 
            document.getElementById('unitPersonList').innerHTML = ""; (e.persons||[]).forEach(window.addPersonRow); 
            document.getElementById('unitStdCondsBody').innerHTML = ""; (e.stdConds||[]).forEach(window.addUnitStdCondRow);
            document.getElementById('unitMetersBody').innerHTML = ""; (e.meters||[]).forEach(window.addMeterRow);

            const today = nowStr();
            const currentUnitSum = (e.stdConds||[]).reduce((sum, c) => {
                if((!c.start || c.start <= today) && (!c.end || c.end >= today)) {
                    let val = parseFloat(c.val)||0;
                    if(c.isM2) val *= (parseFloat(e.area)||0);
                    return sum + val;
                }
                return sum;
            }, 0);
            document.getElementById('unitCondSum').innerText = formatEuro(currentUnitSum);

            // UPDATED: Use Chain Logic for Contract List in Modal
            const cList = document.getElementById('unitContractList');
            cList.innerHTML = "";
            const chain = window.calculateHistoryChain(e);
            chain.forEach(item => {
                const chainLbl = window.getChainLabel(e, item.nr);
                if(item.type === 'vacancy') {
                    cList.innerHTML += `<div class="bg-rose-50 border-l-4 border-rose-400 rounded p-2 flex justify-between text-xs items-center mb-1">
                        <div class="flex flex-col">
                            <span class="text-rose-700 font-bold">LEERSTAND (Nr. ${item.nr})</span>
                            <span class="text-[9px] text-slate-500">${chainLbl}</span>
                        </div>
                        <span class="font-mono text-rose-600">${item.start} - ${item.end||'offen'}</span>
                    </div>`;
                } else {
                    const c = item.data;
                    // Find index in original array
                    const idx = e.contracts.findIndex(x => x.id === c.id);
                    const isActive = !c.end || c.end >= nowStr();
                    const statusClass = isActive ? 'text-emerald-600 font-bold' : 'text-slate-400';
                    
                    cList.innerHTML += `<div class="bg-white border rounded p-2 flex justify-between text-xs items-center mb-1">
                        <div class="flex flex-col">
                            <span class="${statusClass}">${window.resolveContactName(c.tenantId)} (Nr. ${item.nr})</span>
                            <span class="text-[9px] text-slate-400">${chainLbl}</span>
                        </div>
                        <div class="flex flex-col text-right mr-2">
                             <span class="font-mono">${c.start}</span>
                             <span class="font-mono text-[9px]">${c.end||'aktiv'}</span>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="window.deleteContract(${idx})" class="text-rose-400 hover:text-rose-600" title="Löschen"><i class="fas fa-trash"></i></button>
                            <button onclick="window.openContractModalEdit(${idx})" class="text-blue-600 font-bold hover:underline">Edit</button>
                        </div>
                    </div>`;
                }
            });
            
            document.getElementById('btnSaveUnit').onclick = window.saveUnit; 
            document.getElementById('einheitModal').classList.add('active'); window.switchUnitTab('stamm'); 
        };
        
       window.deleteContract = (idx) => {
            const u = db.einheiten.get(currentUnitId);
            const c = u.contracts[idx];
            
            // Check for bookings (Sollstellung Schutz)
            const hasBookings = db.finanzen.some(f => f.einheitId === u.id && f.text.includes(db.kontakte.get(c.tenantId)?.fn || 'Unbekannt'));
            
            if(hasBookings) {
                if(!confirm("⚠️ ACHTUNG: Es existieren bereits Buchungen für diesen Vertrag! Löschen führt zu Inkonsistenzen im Journal. Wirklich löschen?")) return;
            } else {
                if(!confirm("Vertrag wirklich löschen?")) return;
            }

            logAudit('VERTRAG', 'DELETE', `Vertrag von ${window.resolveContactName(c.tenantId)} gelöscht.`);
            u.contracts.splice(idx, 1);
            db.einheiten.set(u.id, u);
            saveLocal();
            
            // Refresh logic
            window.openEinheitMask(u.hausId, u.id); 
            setTimeout(() => window.switchUnitTab('vertrage'), 50);
        };

        window.openContractModalNew = () => {
            currentContractIdx = null;
            document.getElementById('cTenantSelect').value = "";
            
            // Auto-Fill Start Date (Tomorrow)
            const tmr = new Date(); tmr.setDate(tmr.getDate()+1);
            document.getElementById('cStart').value = tmr.toISOString().slice(0,10);
            document.getElementById('cEnd').value = "";
            document.getElementById('cDeposit').value = "";
            document.getElementById('cDebtor').value = ""; // Reset Debtor
            
            // Suggest next Debtor ID
            let maxD = 10000;
            db.einheiten.forEach(u => (u.contracts||[]).forEach(c => { if(parseInt(c.debtor) > maxD) maxD = parseInt(c.debtor); }));
            document.getElementById('cDebtor').value = (maxD + 1);
            window.checkDebtorUniqueness((maxD+1).toString(), 'cDebtorStatus');

            document.getElementById('condListBody').innerHTML = "";
            document.getElementById('contractCostBody').innerHTML = "";
            
            // Standard Condition Row
            window.addCondRow({label:'Kaltmiete', val:0, isM2:false, start: tmr.toISOString().slice(0,10)});
            
            window.updateSum();
            
            // Tenant Dropdown Population
            const sel = document.getElementById('cTenantSelect');
            sel.innerHTML = '<option value="">- Wählen -</option><option value="new" class="font-bold text-blue-600">+ Neuer Kontakt</option>';
            db.kontakte.forEach(k => sel.add(new Option(k.fn, k.id)));
            
            document.getElementById('contractModal').classList.add('active');
        // NEU: Vorgänge laden
            const tenantName = sel.options[sel.selectedIndex].text;
            window.loadLinkedIdeenTickets(tenantName);
        };

        window.openContractModalEdit = (idx) => {
            currentContractIdx = idx;
            const u = db.einheiten.get(currentUnitId);
            const c = u.contracts[idx];
            
            // Tenant Dropdown Population
            const sel = document.getElementById('cTenantSelect');
            sel.innerHTML = '<option value="">- Wählen -</option><option value="new" class="font-bold text-blue-600">+ Neuer Kontakt</option>';
            db.kontakte.forEach(k => sel.add(new Option(k.fn, k.id)));
            sel.value = c.tenantId;

            document.getElementById('cDebtor').value = c.debtor || '';
            window.checkDebtorUniqueness(c.debtor, 'cDebtorStatus');

            document.getElementById('cStart').value = c.start;
            document.getElementById('cEnd').value = c.end;
            document.getElementById('cDeposit').value = c.deposit;
            document.getElementById('cPayType').value = c.payType || 'sepa';

            document.getElementById('condListBody').innerHTML = "";
            (c.conds||[]).forEach(window.addCondRow);
            
            document.getElementById('contractCostBody').innerHTML = "";
            (c.directCosts||[]).forEach(window.addContractCostRow);

            window.updateSum();
            document.getElementById('contractModal').classList.add('active');
        };

        window.addCondRow = (d={}) => {
            const tb = document.getElementById('condListBody');
            const tr = document.createElement('tr');
            // Dropdown from System Defaults
            const typeOpts = db.condTypes.map(t => `<option value="${t.label}" ${d.label===t.label?'selected':''}>${t.label}</option>`).join('');
            // GL Accounts
            const glOpts = db.sachkonten.map(s => `<option value="${s.id}" ${d.gl===s.id?'selected':''}>${s.id}</option>`).join('');
            
            tr.innerHTML = `
                <td><select class="c-lbl input-std text-xs w-32">${typeOpts}</select></td>
                <td><div class="flex"><input type="number" class="c-val input-std text-xs w-20" value="${d.val||0}" oninput="window.calcRowSum(this)"></div></td>
                <td><label class="text-[9px]"><input type="checkbox" class="c-m2" ${d.isM2?'checked':''} onchange="window.calcRowSum(this)">m²</label></td>
                <td class="font-bold text-indigo-600 text-xs text-right pr-4 c-sum">0,00 €</td>
                <td><input type="date" class="c-start input-std text-xs w-24" value="${d.start||''}"></td>
                <td><input type="date" class="c-end input-std text-xs w-24" value="${d.end||''}"></td>
                <td class="flex gap-1">
                    <button onclick="this.closest('tr').remove(); window.updateSum()" class="text-rose-500 hover:bg-rose-50 px-1 rounded">×</button>
                    <input type="hidden" class="c-int" value="${d.intervall||'monat'}">
                    <input type="hidden" class="c-gl" value="${d.gl||'8500'}">
                </td>`;
            tb.appendChild(tr);
            window.calcRowSum(tr.querySelector('.c-val'));
            window.updateSum();
        };

        window.addContractCostRow = (d={}) => {
             const tb = document.getElementById('contractCostBody');
             // Load cost types from master data
             let opts = db.costTypes.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
             tb.innerHTML += `<tr><td><select class="cc-lbl input-std text-xs">${opts}</select></td><td><input type="number" class="cc-val input-std text-xs" value="${d.val||0}"></td><td><button onclick="this.closest('tr').remove()" class="text-rose-500">×</button></td></tr>`;
        };

        window.addUnitCostRow = (d={}) => {
            const tb = document.getElementById('unitDirectCostsBody');
            let opts = db.costTypes.map(c => `<option value="${c.id}" ${d.typeId===c.id?'selected':''}>${c.name}</option>`).join('');
            tb.innerHTML += `<tr>
                <td><select class="uc-type input-std text-xs">${opts}</select></td>
                <td><input type="number" class="uc-qty input-std text-xs w-16" value="${d.qty||1}" placeholder="Anz."></td>
                <td><input type="number" class="uc-amt input-std text-xs w-20" value="${d.amt||0}" placeholder="€"></td>
                <td><input type="date" class="uc-start input-std text-xs w-24" value="${d.start||''}"></td>
                <td><input type="date" class="uc-end input-std text-xs w-24" value="${d.end||''}"></td>
                <td><button onclick="this.closest('tr').remove()" class="text-rose-500">×</button></td>
            </tr>`;
        };

        window.addPersonRow = (d={}) => {
             const tb = document.getElementById('unitPersonList');
             tb.innerHTML += `<tr><td><input type="date" class="p-von input-std text-xs w-24" value="${d.von||''}"></td><td><input type="date" class="p-bis input-std text-xs w-24" value="${d.bis||''}"></td><td><input type="number" class="p-anz input-std text-xs w-12" value="${d.anz||1}"></td><td><input type="text" class="p-not input-std text-xs" value="${d.notiz||''}" placeholder="Name/Info"></td><td><button onclick="this.closest('tr').remove()" class="text-rose-500">×</button></td></tr>`;
        };
        
        window.addMeterRow = (d={}) => {
             const tb = document.getElementById('unitMetersBody');
             const typeOpts = db.meterTypes.map(t => `<option value="${t}" ${d.type===t?'selected':''}>${t}</option>`).join('');
             tb.innerHTML += `<tr>
                <td><select class="m-type input-std text-xs w-24">${typeOpts}</select></td>
                <td><input type="text" class="m-nr input-std text-xs w-24" value="${d.nr||''}" placeholder="Nr."></td>
                <td><input type="number" class="m-val input-std text-xs w-20" value="${d.val||0}" placeholder="Stand"></td>
                <td><input type="date" class="m-date input-std text-xs w-24" value="${d.date||''}"></td>
                <td><input type="date" class="m-valid input-std text-xs w-24" value="${d.valid||''}"></td>
                <td><button onclick="this.closest('tr').remove()" class="text-rose-500">×</button></td>
             </tr>`;
        };

        window.updateSum = () => {
            let sum = 0;
            document.querySelectorAll('#condListBody tr').forEach(r => {
                const txt = r.querySelector('.c-sum').innerText;
                const val = parseFloat(txt.replace('.','').replace(',','.').replace('€','')) || 0;
                
                // Check if active today (simple vis check)
                const start = r.querySelector('.c-start').value;
                const end = r.querySelector('.c-end').value;
                const today = nowStr();
                
                if(start <= today && (!end || end >= today)) {
                     sum += val;
                }
            });
            document.getElementById('contractSum').innerText = formatEuro(sum);
        };

        window.resolveContactName = (id) => { const k = db.kontakte.get(id); return k ? k.fn : 'Unbekannt'; };

        // --- SOLLSTELLUNG ---
        window.openSollMask = () => {
            document.getElementById('sollMonth').value = nowStr().slice(0,7);
            document.getElementById('sollDate').value = nowStr();
            window.updateSollPreview();
            document.getElementById('sollstellungModal').classList.add('active');
        };

        window.updateSollPreview = () => {
            const mStr = document.getElementById('sollMonth').value; 
            if(!mStr) return;
            // Erster Tag des gewählten Monats
            const checkDate = mStr + "-01"; 
            
            sollPreviewData = [];
            const tb = document.getElementById('sollPreviewBody');
            tb.innerHTML = "";
            let total = 0;

            db.einheiten.forEach(u => {
                const o = db.objekte.get(u.objId);
                const h = db.haeuser.get(u.hausId);
                
                // Active Contract check using CheckDate
                const activeC = (u.contracts||[]).find(c => c.start <= checkDate && (!c.end || c.end >= checkDate));
                
                if(activeC) {
                    const tName = window.resolveContactName(activeC.tenantId);
                    
                    // Conditions loop
                    (activeC.conds||[]).forEach(c => {
                        // Check condition validity for that month
                        if(c.start <= checkDate && (!c.end || c.end >= checkDate)) {
                            let amt = parseFloat(c.val);
                            if(c.isM2) amt *= parseFloat(u.area);
                            
                            // Check if already booked
                            const exists = db.finanzen.some(f => 
                                f.einheitId === u.id && 
                                f.typ === 'soll' && 
                                f.buchungsdatum.startsWith(mStr) && 
                                f.text.includes(c.label)
                            );

                            if(!exists) {
                                total += amt;
                                const rowId = uuid();
                                sollPreviewData.push({
                                    id: rowId, uId: u.id, objId: u.objId, tenant: tName, debtor: activeC.debtor,
                                    text: `Soll ${mStr}: ${c.label}`, amt: amt, gl: c.gl || '8500', 
                                    date: document.getElementById('sollDate').value
                                });

                                tb.innerHTML += `<tr>
                                    <td><input type="checkbox" checked class="soll-chk" data-id="${rowId}"></td>
                                    <td>${o.nr} / ${h.name}</td>
                                    <td>${u.name} <span class="text-[9px] text-slate-400">(${tName})</span></td>
                                    <td class="font-mono">${activeC.debtor}</td>
                                    <td class="font-mono text-xs">${c.gl||'8500'}</td>
                                    <td class="text-right font-bold">${formatEuro(amt)}</td>
                                    <td><span class="badge bg-amber-100 text-amber-700">Offen</span></td>
                                </tr>`;
                            }
                        }
                    });
                }
            });
            document.getElementById('sollSumTotal').innerText = formatEuro(total);
            
            if(sollPreviewData.length === 0) {
                 tb.innerHTML = '<tr><td colspan="7" class="p-4 text-center text-slate-400">Keine offenen Sollstellungen für diesen Zeitraum gefunden (oder bereits verbucht).</td></tr>';
            }
        };

        window.toggleAllSoll = (chk) => { document.querySelectorAll('.soll-chk').forEach(c => c.checked = chk); };

        window.executeSollstellung = () => {
            let count = 0;
            let sum = 0;
            const checks = document.querySelectorAll('.soll-chk:checked');
            checks.forEach(c => {
                const id = c.getAttribute('data-id');
                const data = sollPreviewData.find(d => d.id === id);
                if(data) {
                    db.finanzen.push({
                        id: uuid(),
                        objId: data.objId,
                        einheitId: data.uId,
                        buchungsdatum: data.date,
                        valuta: data.date,
                        text: data.text,
                        betrag: roundMoney(data.amt),
                        typ: 'soll',
                        konto: data.gl,
                        beleg: 'SOLL-'+data.date.replace(/-/g,'').substr(2)
                    });
                    count++;
                    sum += data.amt;
                }
            });
            
            if(count > 0) {
                logAudit('FINANZEN', 'SOLLSTELLUNG', `${count} Buchungen erzeugt. Summe: ${formatEuro(sum)}`);
                saveLocal();
                window.closeModals();
                window.renderAll(); // Updates Dashboard & Journal
                alert(`${count} Buchungen erfolgreich erstellt.`);
            } else {
                alert("Keine Buchungen ausgewählt.");
            }
        };

        // --- KONTO / FINANZEN ---
        window.openKontoModal = (uId) => {
            currentKontoUnit = uId;
            const u = db.einheiten.get(uId);
            document.getElementById('kontoTitle').innerText = `Konto: ${u.name}`;
            document.getElementById('mbDatum').value = nowStr();
            window.renderKonto();
            document.getElementById('kontoModal').classList.add('active');
        };

        window.renderKonto = () => {
            const b = document.getElementById('kontoBody');
            b.innerHTML = "";
            let saldo = 0;
            // Filter bookings for this unit
            const bookings = db.finanzen.filter(f => f.einheitId === currentKontoUnit).sort((a,b) => a.buchungsdatum.localeCompare(b.buchungsdatum));
            
            bookings.forEach(f => {
                const val = parseFloat(f.betrag);
                if(f.typ === 'soll') saldo -= val; else saldo += val;
                
                b.innerHTML += `<tr>
                    <td>${f.buchungsdatum}</td>
                    <td>${f.beleg||'-'}</td>
                    <td>${f.text}</td>
                    <td class="text-right text-rose-600">${f.typ==='soll' ? formatEuro(val) : ''}</td>
                    <td class="text-right text-emerald-600">${f.typ==='haben' ? formatEuro(val) : ''}</td>
                    <td class="text-right font-bold ${saldo<0?'text-rose-600':'text-slate-700'}">${formatEuro(saldo)}</td>
                    <td class="text-right"><button onclick="window.deleteBooking('${f.id}')" class="text-slate-300 hover:text-rose-500"><i class="fas fa-trash"></i></button></td>
                </tr>`;
            });
            // Update Dashboard open debts if needed (global recalc later)
        };

        window.saveManualBooking = () => {
             const uId = currentKontoUnit;
             const amt = parseFloat(document.getElementById('mbBetrag').value);
             const txt = document.getElementById('mbText').value;
             if(!amt || !txt) return alert("Fehlende Daten");
             
             db.finanzen.push({
                 id: uuid(),
                 objId: db.einheiten.get(uId).objId,
                 einheitId: uId,
                 buchungsdatum: document.getElementById('mbDatum').value,
                 valuta: document.getElementById('mbDatum').value,
                 text: txt,
                 betrag: amt,
                 typ: document.getElementById('mbTyp').value,
                 konto: '1200', // Default Bank
                 beleg: 'MANUAL'
             });
             saveLocal();
             window.renderKonto();
             window.renderDashboard(); // Update Debts
        };
        
        window.deleteBooking = (id) => {
            if(confirm("Buchung stornieren?")) {
                db.finanzen = db.finanzen.filter(f => f.id !== id);
                saveLocal();
                window.renderKonto();
                window.renderDashboard();
            }
        };

        // --- HAUS MATRIX & MODAL ---
        window.openHausModal = (oid, hid=null) => {
             const h = hid ? db.haeuser.get(hid) : { id: 'h_'+uuid(), objektId: oid, name: '', measoll: 1000, tax: 'auto' };
             document.getElementById('hausId').value = h.id;
             document.getElementById('hausName').value = h.name;
             document.getElementById('hausMeaSoll').value = h.measoll;
             document.getElementById('hausTax').value = h.tax || 'auto';
             
             // MATRIX CALC
             const tb = document.getElementById('hausMatrixBody');
             tb.innerHTML = "";
             if(hid) {
                 const units = Array.from(db.einheiten.values()).filter(u => u.hausId === hid);
                 const types = [...new Set([...db.unitTypes, ...units.map(u => u.type)])].sort(); // BUGFIX: V19 Logic (All Types)
                 types.forEach(t => {
                     const uInType = units.filter(u => u.type === t);
                     const cnt = uInType.length;
                     const areaSum = uInType.reduce((s,x) => s + (parseFloat(x.area)||0), 0);
                     const style = cnt === 0 ? "opacity-50" : "font-bold";
                     tb.innerHTML += `<tr class="${cnt===0?'text-slate-400':''}"><td>${t}</td><td class="text-center text-slate-400">-</td><td class="text-center ${style}">${cnt}</td><td></td><td class="text-right text-slate-400">-</td><td class="text-right ${style}">${areaSum.toFixed(2)}</td><td></td></tr>`;
                 });
             } else {
                 tb.innerHTML = "<tr><td colspan='7' class='text-center text-slate-400 p-4'>Neues Haus - Keine Einheiten</td></tr>";
             }
             
             document.getElementById('btnSaveHaus').onclick = () => {
                 h.name = document.getElementById('hausName').value;
                 h.measoll = document.getElementById('hausMeaSoll').value;
                 h.tax = document.getElementById('hausTax').value;
                 db.haeuser.set(h.id, h);
                 saveLocal(); window.closeModals(); window.renderAll();
             };
             document.getElementById('hausModal').classList.add('active');
        };

        // --- EXPORT PDF STUBS ---
        window.generateUnitPDF = () => {
             const { jsPDF } = window.jspdf;
             const doc = new jsPDF();
             const u = db.einheiten.get(currentUnitId);
             doc.setFontSize(16); doc.text(`Stammblatt: ${u.name}`, 14, 20);
             doc.setFontSize(10); doc.text(`Fläche: ${u.area} m² | Typ: ${u.type}`, 14, 30);
             // ... more details ...
             doc.save(`Einheit_${u.name}.pdf`);
        };
        
        window.generateTenantListPDF = () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text("Mieterliste", 14, 20);
            const rows = [];
            db.einheiten.forEach(u => {
                const c = (u.contracts||[]).find(x => !x.end || x.end >= nowStr());
                if(c) rows.push([u.name, window.resolveContactName(c.tenantId), c.start]);
            });
            doc.autoTable({ head: [['Einheit', 'Mieter', 'Seit']], body: rows, startY: 30 });
            doc.save('Mieterliste.pdf');
        };

        window.exportContractList = () => {
            let csvContent = "data:text/csv;charset=utf-8,Objekt;Einheit;Mieter;Start;Ende;Netto\n";
            db.einheiten.forEach(u => {
                 (u.contracts||[]).forEach(c => {
                      // Simple CSV line
                      csvContent += `${u.name};${window.resolveContactName(c.tenantId)};${c.start};${c.end||''}\n`;
                 });
            });
            const link = document.createElement("a");
            link.setAttribute("href", encodeURI(csvContent));
            link.setAttribute("download", "vertragsliste.csv");
            document.body.appendChild(link);
            link.click();
        };

        // --- AUTH & CLOUD (Mock) ---
        async function getValidToken() { try { const a = await msalInstance.acquireTokenSilent({scopes:["User.Read", "Files.ReadWrite"]}); return a.accessToken; } catch(e) { try { const r = await msalInstance.acquireTokenPopup({scopes:["User.Read", "Files.ReadWrite"]}); return r.accessToken; } catch(ee) { return null; } } }
        async function loadFromCloud() { const t = await getValidToken(); if(!t) return; try { const r = await fetch(`https://graph.microsoft.com/v1.0/me/drive/root:${document.getElementById('onedrivePath').value}:/content`, { headers:{Authorization:`Bearer ${t}`} }); if(r.ok) { const d=await r.text(); const j=JSON.parse(d); db.objekte=new Map(j.o); db.haeuser=new Map(j.h); db.einheiten=new Map(j.e); db.finanzen=j.f||[]; db.audit=j.audit||[]; db.tickets=j.tickets||[]; db.kontakte=new Map(j.k||[]); if(j.s) db.sachkonten=j.s; if(j.ct) db.condTypes=j.ct; if(j.cst) db.costTypes=j.cst; if(j.ut) db.unitTypes=j.ut; if(j.m) db.mandant=j.m; if(j.mt) db.meterTypes=j.mt; saveLocal(); window.renderAll(); } } catch(e) {} }
        window.saveToCloud = async (man=false) => { const t = await getValidToken(); if(!t) return; try { const c = JSON.stringify({o:Array.from(db.objekte), h:Array.from(db.haeuser), e:Array.from(db.einheiten), f:db.finanzen, k:Array.from(db.kontakte), audit:db.audit, tickets:db.tickets, s:db.sachkonten, ct:db.condTypes, cst:db.costTypes, ut:db.unitTypes, m:db.mandant, mt:db.meterTypes}); const u = `https://graph.microsoft.com/v1.0/me/drive/root:${document.getElementById('onedrivePath').value}:/content`; await fetch(u, { method:'PUT', headers:{Authorization:`Bearer ${t}`, 'Content-Type':'application/json'}, body:c }); if(man) alert("Gespeichert!"); } catch(e) { alert("Cloud-Fehler"); } };
        window.handleLogin = async () => { if(!msalInstance) { msalInstance = new msal.PublicClientApplication(MSAL_CFG); } try { const r = await msalInstance.loginPopup({scopes:["User.Read", "Files.ReadWrite"]}); document.getElementById('userDisplay').innerText = r.account.username; document.getElementById('btnLogin').classList.add('hidden'); document.getElementById('btnLogout').classList.remove('hidden'); document.getElementById('btnSave').disabled = false; loadFromCloud(); } catch(e) { console.error(e); } };
        window.handleLogout = () => { msalInstance.logoutPopup(); location.reload(); };

        // --- SAVE / LOAD ---
        function saveLocal() {
            const data = {
                objekte: Array.from(db.objekte.entries()),
                haeuser: Array.from(db.haeuser.entries()),
                einheiten: Array.from(db.einheiten.entries()),
                kontakte: Array.from(db.kontakte.entries()),
                finanzen: db.finanzen,
                audit: db.audit,
                tickets: db.tickets,
                mandant: db.mandant,
                config: {
                    sachkonten: db.sachkonten,
                    condTypes: db.condTypes,
                    costTypes: db.costTypes,
                    unitTypes: db.unitTypes,
                    vKeys: db.vKeys,
                    taxKeys: db.taxKeys,
                    meterTypes: db.meterTypes
                }
            };
            localStorage.setItem('hvp_db_v16_9_17', JSON.stringify(data));
            // Recalc Dash Stats
            const debt = db.finanzen.filter(f => f.typ === 'soll').reduce((s,x) => s+x.betrag, 0) - db.finanzen.filter(f => f.typ === 'haben').reduce((s,x) => s+x.betrag, 0);
            const elDebt = document.getElementById('dashOpenDebts');
            if(elDebt) elDebt.innerText = formatEuro(debt > 0 ? debt : 0);
        }

        function loadLocal() {
            try {
                const raw = localStorage.getItem('hvp_db_v16_9_17');
                if(raw) {
                    const data = JSON.parse(raw);
                    db.objekte = new Map(data.objekte);
                    db.haeuser = new Map(data.haeuser);
                    db.einheiten = new Map(data.einheiten);
                    db.kontakte = new Map(data.kontakte);
                    db.finanzen = data.finanzen || [];
                    db.audit = data.audit || [];
                    db.tickets = data.tickets || [];
                    db.mandant = data.mandant || {};
                    
                    // Config merge
                    if(data.config) {
                        db.sachkonten = data.config.sachkonten || SYSTEM_DEFAULTS.sachkonten;
                        db.condTypes = data.config.condTypes || SYSTEM_DEFAULTS.condTypes;
                        db.costTypes = data.config.costTypes || SYSTEM_DEFAULTS.costTypes;
                        db.unitTypes = data.config.unitTypes || SYSTEM_DEFAULTS.unitTypes;
                        db.vKeys = data.config.vKeys || SYSTEM_DEFAULTS.vKeys;
                        db.taxKeys = data.config.taxKeys || SYSTEM_DEFAULTS.taxKeys;
                        db.meterTypes = data.config.meterTypes || SYSTEM_DEFAULTS.meterTypes;
                    }
                } else {
                    // Init Defaults
                    db.sachkonten = SYSTEM_DEFAULTS.sachkonten;
                    db.condTypes = SYSTEM_DEFAULTS.condTypes;
                    db.costTypes = SYSTEM_DEFAULTS.costTypes;
                    db.unitTypes = SYSTEM_DEFAULTS.unitTypes;
                    db.vKeys = SYSTEM_DEFAULTS.vKeys;
                    db.taxKeys = SYSTEM_DEFAULTS.taxKeys;
                    db.meterTypes = SYSTEM_DEFAULTS.meterTypes;
                }
            } catch (e) {
                console.error("Datenbank korrupt, Reset.", e);
                // Fallback to empty DB to prevent crash
                db.sachkonten = SYSTEM_DEFAULTS.sachkonten;
                // ... (Could add user alert here)
            }
        }
// --- NEU: BACKUP & DMS LOGIK (v16.9.35) ---
        
        window.downloadBackup = () => {
            const data = {
                timestamp: new Date().toISOString(),
                version: "v16.9.35",
                store: {
                    hvp_db_v16_9_17: localStorage.getItem('hvp_db_v16_9_17')
                    // Falls du weitere Keys hast (z.B. gen_last_config), hier hinzufügen
                }
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Hausverwaltung_Backup_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            alert("Backup wurde im Download-Ordner gespeichert.");
        };

        window.restoreBackup = (input) => {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const json = JSON.parse(e.target.result);
                    // Prüfen ob neues Format (mit .store Wrapper) oder altes Format
                    const rawData = json.store ? json.store.hvp_db_v16_9_17 : null;
                    
                    if(rawData) {
                        if(confirm(`Backup vom ${json.timestamp || 'Unbekannt'} laden?\nACHTUNG: Alle aktuellen Daten werden überschrieben!`)) {
                            localStorage.setItem('hvp_db_v16_9_17', rawData);
                            alert("Wiederherstellung erfolgreich! Seite wird neu geladen.");
                            location.reload();
                        }
                    } else {
                        alert("Fehler: Ungültiges Backup-Format.");
                    }
                } catch(err) {
                    alert("Fehler beim Lesen der Datei: " + err.message);
                }
            };
            reader.readAsText(file);
        };

        window.openDMSBridge = () => {
            // Holt den Namen des Mieters aus dem Dropdown oder Input
            const sel = document.getElementById('cTenantSelect');
            let name = "";
            
            if (sel && sel.value && sel.value !== 'new') {
                // Versuche Namen aus Dropdown Text zu holen
                name = sel.options[sel.selectedIndex].text;
            } else {
                // Fallback: Prüfen ob wir im "Einheit Modal" sind und dort ein aktiver Mieter ist
                const u = db.einheiten.get(currentUnitId);
                if(u) {
                    const activeC = (u.contracts||[]).find(c => !c.end || c.end >= nowStr());
                    if(activeC) name = window.resolveContactName(activeC.tenantId);
                }
            }

            if(!name || name === "Unbekannt" || name === "Leerstand") {
                alert("Bitte wählen Sie zuerst einen gültigen Mieter/Vertrag aus.");
                return;
            }

            // Öffnet die Ideen-App (index.html) im gleichen Ordner
            // Übergibt den Namen als Suchparameter ?search=...
            const targetUrl = `index.html?search=${encodeURIComponent(name)}`;
            window.open(targetUrl, '_blank');
        };// --- NEU: Live-Daten aus Ideen-App lesen ---
        window.loadLinkedIdeenTickets = async (tenantName) => {
            const listEl = document.getElementById('externalTicketsList');
            if(!listEl) return;
            listEl.innerHTML = '<div class="text-[10px] text-slate-400 text-center mt-2"><i class="fas fa-spinner fa-spin"></i> Prüfe Cloud...</div>';

            const t = await getValidToken();
            if(!t) {
                listEl.innerHTML = '<div class="text-[10px] text-red-400 text-center">Kein Cloud-Login.</div>';
                return;
            }

            try {
                // Holt die ideen.json direkt aus dem Cloud-Ordner
                const r = await fetch('https://graph.microsoft.com/v1.0/me/drive/root:/ideenapp/ideen.json:/content', {
                    headers: { Authorization: `Bearer ${t}` }
                });
                
                if(r.ok) {
                    const data = await r.json();
                    // Struktur prüfen (Array oder Objekt)
                    let ideen = Array.isArray(data) ? data : (data.ideen || []);
                    
                    // Filtern: Sucht den Mieternamen im Text, Details oder Firmennamen
                    const searchStr = tenantName.toLowerCase();
                    const hits = ideen.filter(i => {
                        const content = (i.text + " " + (i.details||"") + " " + (i.firmenname||"") + " " + (i.mandantennummer||"")).toLowerCase();
                        return content.includes(searchStr);
                    });

                    if(hits.length === 0) {
                        listEl.innerHTML = '<div class="text-[10px] text-slate-400 italic text-center mt-4">Keine Vorgänge gefunden.</div>';
                    } else {
                        // Sortieren: Neueste oben
                        hits.sort((a,b) => (b.vorgangsnummer || 0) - (a.vorgangsnummer || 0));
                        
                        listEl.innerHTML = hits.map(h => `
                            <div class="bg-slate-50 border border-slate-200 rounded p-1.5 flex justify-between items-start hover:bg-indigo-50 transition-colors cursor-help" title="${h.details || ''}">
                                <div class="overflow-hidden">
                                    <div class="font-bold text-[10px] text-indigo-700 flex items-center gap-1">
                                        <span class="bg-indigo-100 px-1 rounded">#${h.vorgangsnummer || '?'}</span>
                                        <span class="truncate">${h.text}</span>
                                    </div>
                                    <div class="text-[9px] text-slate-500 truncate">${h.timestamp ? h.timestamp.substring(0,10) : ''}</div>
                                </div>
                                <span class="text-[10px] ml-2 ${h.erledigt ? 'text-emerald-500' : 'text-amber-500'}">
                                    ${h.erledigt ? '<i class="fas fa-check-circle"></i>' : '<i class="fas fa-clock"></i>'}
                                </span>
                            </div>
                        `).join('');
                    }
                } else {
                    listEl.innerHTML = '<div class="text-[10px] text-slate-400 text-center">Noch keine Ideen-Datenbank.</div>';
                }
            } catch(e) {
                console.error(e);
                listEl.innerHTML = '<div class="text-[10px] text-red-400 text-center">Ladefehler.</div>';
            }
        };

        window.refreshExternalTickets = () => {
            const sel = document.getElementById('cTenantSelect');
            if (sel && sel.value && sel.value !== 'new') {
                const name = sel.options[sel.selectedIndex].text;
                window.loadLinkedIdeenTickets(name);
            }
        };
        // --- ENDE NEU ---
        // --- INIT ---
        window.onload = () => {
            loadLocal();
            window.renderAll();
            // Start Clock / Status check interval
            setInterval(() => {
                const el = document.getElementById('userDisplay');
                // NULL CHECK FIX
                if(el && !el.innerText.includes('Simulated') && !el.innerText.includes('@')) {
                    // Just a static check, avoiding error
                }
            }, 5000);
        };

        // --- MANDANT ---
        window.openMandantMask = () => {
             const m = db.mandant || {};
             document.getElementById('manName').value = m.name || '';
             document.getElementById('manStr').value = m.str || '';
             document.getElementById('manOrt').value = m.ort || '';
             document.getElementById('manGid').value = m.gid || '';
             document.getElementById('mandantModal').classList.add('active');
        };
        window.saveMandant = () => {
             db.mandant = {
                 name: document.getElementById('manName').value,
                 str: document.getElementById('manStr').value,
                 ort: document.getElementById('manOrt').value,
                 gid: document.getElementById('manGid').value
             };
             saveLocal(); window.closeModals();
        };

        window.toggleFilter = (oid) => {
             activeFocus = activeFocus === oid ? null : oid;
             const info = document.getElementById('filterInfo');
             if(info) info.innerText = activeFocus ? `Filter aktiv: ${db.objekte.get(oid).name}` : "Alle Immobilien sichtbar";
             window.renderObjekte();
        };

        window.toggleArchive = () => {
            showArchived = !showArchived;
            const btn = document.getElementById('btnArchiveToggle');
            if(btn) {
                btn.innerText = showArchived ? "Archiv verbergen" : "Archiv anzeigen";
                btn.classList.toggle('bg-amber-100');
                btn.classList.toggle('text-amber-800');
            }
            window.renderObjekte();
        };

        window.archiveObject = () => {
             const o = db.objekte.get(document.getElementById('objId').value);
             if(!o) return;
             if(confirm(`Objekt ${o.name} wirklich archivieren?`)) {
                 o.archived = true;
                 db.objekte.set(o.id, o);
                 saveLocal(); window.closeModals(); window.renderAll();
             }
        };

        // --- AUDIT DETAIL ---
        window.showAuditDetail = (id) => {
            const entry = db.audit.find(a => a.id === id);
            if(entry) {
                document.getElementById('auditDetailContent').innerText = JSON.stringify(entry, null, 2);
                document.getElementById('auditDetailModal').classList.add('active');
            }
        };

        // MODAL TOGGLER FIX: Changed name to avoid ID collision
        window.openObjektMask = (oid) => { 
            const o = oid ? db.objekte.get(oid) : { name:'', nr:'', tax:'opt'}; 
            document.getElementById('objId').value = o.id || ''; document.getElementById('objName').value = o.name; document.getElementById('objNr').value = o.nr || (oid || ''); 
            document.getElementById('objStr').value = o.objStr || ''; document.getElementById('objPlz').value = o.objPlz || ''; document.getElementById('objOrt').value = o.objOrt || '';
            document.getElementById('objBaujahr').value = o.baujahr || ''; document.getElementById('objFlaeche').value = o.flaeche || '';
            document.getElementById('objSteuer').value = o.objSteuer || ''; document.getElementById('objUStId').value = o.objUStId || '';
            document.getElementById('objIban').value = o.objIban || ''; document.getElementById('objGid').value = o.objGid || ''; document.getElementById('objFlur').value = o.objFlur || '';
            document.getElementById('objTax').value = o.tax || 'opt';
            document.getElementById('objSanierung').value = o.sanierung || '';
            document.getElementById('objEnergie').value = o.energie || '';
            document.getElementById('objektModal').classList.add('active'); 
        };
        window.saveObjekt = () => { 
            const hid = document.getElementById('objId').value; const nr = document.getElementById('objNr').value; const id = hid || (nr ? nr : 'o_'+uuid()); 
            const o = db.objekte.get(id) || {};
            db.objekte.set(id, { 
                ...o, id, nr, name: document.getElementById('objName').value, tax: document.getElementById('objTax').value, 
                objStr: document.getElementById('objStr').value, objPlz: document.getElementById('objPlz').value, objOrt: document.getElementById('objOrt').value,
                addr: `${document.getElementById('objStr').value}, ${document.getElementById('objPlz').value} ${document.getElementById('objOrt').value}`,
                baujahr: document.getElementById('objBaujahr').value, flaeche: document.getElementById('objFlaeche').value,
                sanierung: document.getElementById('objSanierung').value, energie: document.getElementById('objEnergie').value,
                objSteuer: document.getElementById('objSteuer').value, objUStId: document.getElementById('objUStId').value,
                objIban: document.getElementById('objIban').value, objGid: document.getElementById('objGid').value, objFlur: document.getElementById('objFlur').value,
                archived: o.archived || false
            }); 
            logAudit('OBJEKT', 'SAVE', `Objekt ${document.getElementById('objName').value} gespeichert`); saveLocal(); window.closeModals(); window.renderAll(); 
        };

        // --- GENERATOR MASK FIX ---
        window.openGeneratorMask = () => { const conf = JSON.parse(localStorage.getItem('gen_last_config') || '{}'); if(conf.objName) document.getElementById('genObjName').value = conf.objName; if(conf.address) document.getElementById('genAddress').value = conf.address; document.getElementById('generatorModal').classList.add('active'); };
        
        // --- TICKET MASK FIX ---
        window.openTicketMask = () => { 
            const selObj = document.getElementById('tickObj'); selObj.innerHTML = '<option value="">- Objekt wählen -</option>';
            db.objekte.forEach(o => selObj.add(new Option(o.name, o.id)));
            document.getElementById('ticketModal').classList.add('active'); 
        };
        window.saveTicket = () => { db.tickets.push({ titel: document.getElementById('tickTitle').value, status: document.getElementById('tickStatus').value, einheitId: document.getElementById('tickUnit').value, date: nowStr() }); logAudit('TICKET', 'CREATE', document.getElementById('tickTitle').value); saveLocal(); window.closeModals(); window.renderAll(); };

        // --- CONTACT MASK FIX ---
        window.openContactMask = () => { 
            document.getElementById('kId').value = 'k_'+uuid(); 
            document.getElementById('kName').value=''; document.getElementById('kStr').value=''; document.getElementById('kPlz').value=''; document.getElementById('kOrt').value=''; document.getElementById('kEmail').value=''; document.getElementById('kTel').value=''; 
            document.getElementById('kIban').value=''; document.getElementById('kBic').value=''; document.getElementById('kBank').value=''; document.getElementById('kMandat').value='';
            document.getElementById('kontaktModal').classList.add('active'); 
        };

        // --- DOSSIER MASK FIX ---
        window.openDossierMask = () => {
            document.getElementById('dossierModal').classList.add('active');
        };

        // --- SOLL MASK FIX ---
        window.openSollMask = () => {
            document.getElementById('sollMonth').value = nowStr().slice(0,7);
            document.getElementById('sollDate').value = nowStr();
            window.updateSollPreview();
            document.getElementById('sollstellungModal').classList.add('active');
        };

        window.closeModals = () => document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('active'));

    </script>
</body>
</html>