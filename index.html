<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Ideen-App Pro</title>
<style>
html,body{box-sizing:border-box;margin:0;padding:0;background:#f4f4f4;width:100vw;max-width:100vw;overflow-x:hidden;}
body{font-family:Arial,sans-serif;margin:0 0 20px 0;}
input,select,textarea{margin-top:10px;padding:10px;font-size:1em;width:400px;max-width:100vw;box-sizing:border-box;display:block;}
textarea{min-height:60px;}
button{padding:10px 18px;font-size:1em;margin-top:10px;margin-right:8px;border-radius:4px;border:1px solid #bbb;background:#eee;cursor:pointer;width:auto;min-width:44px;display:inline-block;}
.buttons,.top-actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;}
.filter-bar{margin:20px 0;}
.filter-bar label, .filter-bar select,.filter-bar input{width:auto;display:inline-block;margin-right:10px;margin-top:0;} /* Adjusted spacing */
.filter-bar button { margin-top: 0; } /* Adjusted spacing */
.idee{width:100%;max-width:100vw;box-sizing:border-box;overflow-wrap:break-word;word-break:break-word;background:white;padding:15px;margin:10px 0;border-radius:8px;box-shadow:0 0 5px #ccc;display:flex;align-items:flex-start;justify-content:space-between;}
.idee.erledigt{background:#f0f0f0;}
.idee-content{flex:1;max-width:100%;overflow-wrap:break-word;word-break:break-word;font-size:1em;line-height:1.5;}
.idee-content h3,.idee-content p,.idee-content small{max-width:100%;overflow-wrap:break-word;word-break:break-word;font-size:1em;}
.idee.erledigt .idee-content h3,.idee.erledigt .idee-content p,.idee.erledigt .idee-content small{text-decoration:line-through;color:#888;}
.beschreibung-historie{margin:8px 0 12px 0;}
.beschreibung-item{margin:4px 0 4px 0;padding:6px 8px;background:#f8f8f8;border-left:3px solid #bbb;font-size:0.98em; display: flex; justify-content: space-between; align-items: center;} /* Flexbox f√ºr Button daneben */
.beschreibung-text-zeit { flex-grow: 1; margin-right: 10px;} /* Text nimmt Platz ein */
.beschreibung-zeit{color:#666;font-size:0.9em;margin-bottom:2px;display:block;}
.beschreibung-eingabe{margin:10px 0;background:#f9f9f9;border-left:3px solid #bbb;padding:8px;}
.idee-checkbox{margin-left:10px;margin-top:5px;min-width:28px;min-height:28px;}
.idee-actions{margin-top:10px;display:flex;gap:5px;flex-wrap:wrap;}
.idee-actions button{width:auto;min-width:44px;padding:6px 10px;font-size:0.95em;}
.prio-btn{background:#eee;border:1px solid #ccc;border-radius:4px;}
.prio-btn.selected{background:#ffd700;border-color:#ff9800;color:#222;}
/* CSS f√ºr die Meldungsboxen */
#warnung { /* Dieses div wird f√ºr alle Meldungen genutzt */
    margin: 10px 0;
    font-weight: bold;
    padding: 10px;
    border-radius: 4px;
    display: none; /* Standardm√§√üig versteckt */
    position: fixed; /* Bleibt oben, auch beim Scrollen */
    top: 10px;
    left: 50%;
    transform: translateX(-50%); /* Zentrieren */
    z-index: 1000; /* √úber anderen Elementen */
    width: auto;
    max-width: 80%; /* Nicht zu breit */
    text-align: center;
}

/* CSS f√ºr Warnmeldungen (rot) */
#warnung.warnung{
    color:#d32f2f; /* Red */
    border: 1px solid #d32f2f;
    background-color: #ffe0e0; /* Light red background */
}

/* CSS f√ºr Erfolgsmeldungen (gr√ºn) */
#warnung.success-message {
    color: #388e3c; /* Green */
    border: 1px solid #388e3c;
    background-color: #e8f5e9; /* Light green background */
}

/* CSS f√ºr Info/Progress Meldungen (blau/grau) */
#warnung.info-message {
    color: #1a73e8; /* Neutral Blue */
    border: 1px solid #1a73e8;
    background-color: #e8f0fe; /* Light neutral background */
}


/* CSS f√ºr den kleinen Bearbeiten-Button neben der Beschreibung */
.beschreibung-item .edit-beschreibung-btn {
    padding: 3px 6px; /* Kleineres Padding */
    font-size: 0.8em; /* Kleinere Schrift */
    margin-top: 0; /* Kein Top-Margin */
    min-width: auto; /* Keine Mindestbreite */
    width: auto;
    height: 24px; /* Feste H√∂he */
    line-height: 1; /* Zeilenh√∂he anpassen */
    display: flex; /* Flexbox zum Zentrieren des Symbols */
    align-items: center; /* Vertikal zentrieren */
    justify-content: center; /* Horizontal zentrieren */
}

/* CSS f√ºr OneDrive Buttons */
.top-actions .onedrive-btn {
    background: #0078d4; /* Microsoft Blau */
    color: white;
    border-color: #005a9e;
}


@media (max-width:600px){
input,select,textarea,button{width:100vw;min-width:0;max-width:100vw;}
.buttons,.top-actions,.filter-bar{flex-direction:column;gap:0;}
.filter-bar label, .filter-bar select, .filter-bar input, .filter-bar button { margin-right: 0; margin-bottom: 10px; } /* Adjusted spacing */
.idee{flex-direction:column;}
.idee-checkbox{margin-left:0;margin-top:10px;}
.idee-content,.idee-actions,.datei-link,.datei-info,.datei-vorschau,.idee-checkbox{max-width:100vw;}
/* Anpassung f√ºr Beschreibungseintr√§ge auf kleinen Bildschirmen */
.beschreibung-item { flex-direction: column; align-items: flex-start; }
.beschreibung-text-zeit { margin-right: 0; margin-bottom: 5px; width: 100%; }
.beschreibung-item .edit-beschreibung-btn { margin-top: 5px; }
/* Anpassung der Meldungsbox f√ºr kleine Bildschirme */
#warnung {
    position: static; /* Nicht fixed auf kleinen Screens */
    transform: none;
    left: auto;
    max-width: 100%;
}

}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://alcdn.msauth.net/browser/2.24.0/js/msal-browser.min.js"></script>
</head>
<body>
<h1>Ideen-App</h1>
<div id="warnung"></div> <div id="loginHinweis" class="warnung" style="display:none;">Anmeldung erforderlich: Bitte melden Sie sich zuerst mit Ihrem Microsoft-Konto an. Ohne Anmeldung sind keine Cloud-Links und keine Synchronisation m√∂glich.</div>

<input type="text" id="ideeText" placeholder="Titel*" />
<textarea id="ideeDetails" placeholder="Beschreibung" rows="3"></textarea>
<input type="text" id="mandantennummer" placeholder="Mandantennummer (optional)" />
<input type="text" id="firmenname" placeholder="Firmenname (optional)" />
<select id="kategorie"></select>
<input type="text" id="neueKategorie" placeholder="Neue Kategorie" />
<button onclick="neueKategorieHinzufuegen()">+ Kategorie</button>
<button class="katLoeschBtn" onclick="kategorieLoeschen()">Kategorie l√∂schen</button>
<span id="katHinweis" class="katHinweis" style="display:none;"></span>
<div class="buttons">
<button id="prioHoch" class="prio-btn" onclick="setzePrioritaet('Hoch')">üî¥ Hoch</button>
<button id="prioMittel" class="prio-btn" onclick="setzePrioritaet('Mittel')">üü† Mittel</button>
<button id="prioNiedrig" class="prio-btn" onclick="setzePrioritaet('Niedrig')">üü¢ Niedrig</button>
</div>
<input type="file" id="dateien" multiple />
<div class="datei-vorschau" id="dateiVorschau"></div>
<div id="preview"></div>
<button id="speichernBtn" onclick="speichereIdee()">üíæ Speichern</button>
<button id="abbrechenBtn" onclick="abbrechenBearbeiten()" style="display:none;">Abbrechen</button>
<div class="filter-bar">
<label>Filter:</label>
<select id="filterKategorie" onchange="zeigeIdeen()">
<option value="" class="filter-option-alle">üéØ Alle Ideen</option>
</select>
<label>Archiv:</label>
<select id="filterArchiv" onchange="zeigeIdeen()">
<option value="nicht_erledigt">Nur nicht erledigt</option>
<option value="erledigt">Nur erledigt</option>
<option value="alle">Alle anzeigen</option>
</select>
<label>Sortierung:</label>
<select id="sortierung" onchange="zeigeIdeen()">
<option value="neu">Neueste zuerst</option>
<option value="alt">√Ñlteste zuerst</option>
<option value="prio">Nach Priorit√§t</option>
</select>
<input type="text" id="filterMandant" placeholder="Mandantennummer filtern" style="width:170px;display:inline-block;"/>
<button onclick="filterNachMandant()">Nach Mandant filtern</button>
<button onclick="filterMandantZuruecksetzen()">Mandantenfilter zur√ºcksetzen</button>
</div>
<div class="top-actions">
<button onclick="exportiereAlsPDF()">üìù PDF</button>
<button onclick="exportiereAlsText()">üìÑ Text</button>
<button onclick="teilePerEmail()">‚úâÔ∏è E-Mail</button>
<button onclick="teilePerWhatsApp()">üì± WhatsApp</button>
<button class="onedrive-btn" onclick="saveToOneDrive()">‚òÅÔ∏è Auf OneDrive speichern</button>
<button class="onedrive-btn" onclick="loadFromOneDrive()">‚òÅÔ∏è Von OneDrive laden</button>
<button onclick="alleIdeenLoeschen()" style="background:#eee;border:1px solid #c00;color:#c00;">Alle Ideen l√∂schen</button>
<button onclick="ausgewaehlteNotizenLoeschen()" style="background:#eee;border:1px solid #c00;color:#c00;">Ausgew√§hlte l√∂schen</button>
<button id="speicherDateiBtn" onclick="speichereIdeenAlsDatei()">Datei speichern</button>
<button id="oeffneDateiBtn" onclick="ladeIdeenAusDatei()">Datei √∂ffnen</button>
<button onclick="handleLogin()" style="background:#e6f4ff;border-color:#0067b8;color:#0067b8;">üîë Mit Microsoft anmelden</button>
<button onclick="handleLogout()" style="background:#ffe0e0;border-color:#c00;color:#c00;">üîí Abmelden</button>
</div>
<div id="ideenListe"></div>
<div id="beschreibungDialog" style="display:none;" class="beschreibung-eingabe">
<textarea id="beschreibungText" placeholder="Weitere Beschreibung" rows="2"></textarea>
<button onclick="beschreibungSpeichern()">üíæ Speichern</button>
<button onclick="beschreibungAbbrechen()">‚ùå Abbrechen</button>
</div>
<script>
const msalConfig={auth:{clientId:"ddf69193-7eab-4847-a995-b6c08f0df9ae",authority:"https://login.microsoftonline.com/683748a6-faf7-45ef-9da3-10e903da0b00",knownAuthorities:["login.microsoftonline.com"],redirectUri:"https://ecki-android.github.io"}};
// bearbeiteId speichert die ID der bearbeiteten Idee oder null
// ausgewaehlt speichert ein Array von IDs
// beschreibungFuerId speichert die ID der Idee, deren Beschreibung hinzugef√ºgt/bearbeitet wird
// beschreibungZuBearbeitenderTimestamp speichert den Timestamp der Beschreibung, die bearbeitet wird (oder null beim Hinzuf√ºgen)
let accessToken = null, msalInstance = null, prioritaet = "", bearbeiteId = null, ausgewaehlt = [], fileHandle = null, beschreibungFuerId = null, beschreibungZuBearbeitenderTimestamp = null, istGespeichert = true, filterMandantValue = "", standardKategorien = ["Aufgaben","Projekte","Privat","Arbeit","Sp√§ter"];

// Funktion zur Generierung einer einfachen UUID v4
function generateUUID() {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
    });
}


async function handleLogin(){try{msalInstance=new msal.PublicClientApplication(msalConfig);const l=await msalInstance.loginPopup({scopes:["Files.ReadWrite","offline_access"]});const t=await msalInstance.acquireTokenSilent({scopes:["Files.ReadWrite"],account:l.account});accessToken=t.accessToken;zeigeWarnung("Erfolgreich bei Microsoft angemeldet!", 'success');pruefeLoginHinweis();return true;}catch(e){zeigeWarnung("Login fehlgeschlagen: "+e.message);return false;}} // R√ºckgabewert und Typ 'success' hinzugef√ºgt
async function handleLogout(){if(!istGespeichert){if(!confirm("Bitte speichern Sie Ihre √Ñnderungen, bevor Sie sich abmelden! Trotzdem abmelden!"))return;}try{if(msalInstance){const a=msalInstance.getAllAccounts()[0];if(a){await msalInstance.logoutPopup({account:a,postLogoutRedirectUri:"https://ecki-android.github.io"});}}accessToken=null;pruefeLoginHinweis();zeigeWarnung("Sie wurden erfolgreich abgemeldet.", 'success');}catch(e){zeigeWarnung("Abmeldung fehlgeschlagen: "+e.message);}} // Typ 'success' hinzugef√ºgt
function pruefeLoginHinweis(){if(!accessToken){document.getElementById("loginHinweis").style.display="block";}else{document.getElementById("loginHinweis").style.display="none";}}

// Ge√§nderte zeigeWarnung Funktion mit Typ (warning/success/info)
function zeigeWarnung(msg, type = 'warning'){
    const w=document.getElementById("warnung");
    w.textContent=msg;
    w.style.display="block";
    // Entferne alle m√∂glichen Stil-Klassen bevor die neue hinzugef√ºgt wird
    w.classList.remove('warnung', 'success-message', 'info-message');

    // F√ºgt die korrekte Klasse basierend auf dem Typ hinzu
    if (type === 'success') {
        w.classList.add('success-message');
    } else if (type === 'info') { // Typ 'info' f√ºr neutrale Meldungen
        w.classList.add('info-message');
    } else { // Standard ist 'warning' (rot)
        w.classList.add('warnung');
    }

    setTimeout(()=>w.style.display="none",6000); // Alle Meldungen verschwinden nach 6 Sekunden
}


function initialisiereKategorien(){const k=JSON.parse(localStorage.getItem("kategorien"))||standardKategorien;const s=document.getElementById("kategorie");s.innerHTML=k.map(n=>`<option>${n}</option>`).join("");const f=document.getElementById("filterKategorie");f.innerHTML='<option value="" class="filter-option-alle">üéØ Alle Ideen</option>';k.forEach(n=>f.add(new Option(n,n)));}
function setzePrioritaet(p){prioritaet=p;["prioHoch","prioMittel","prioNiedrig"].forEach(id=>document.getElementById(id).classList.remove("selected"));if(p)document.getElementById(`prio${p}`).classList.add("selected");istGespeichert=false;}
function filterNachMandant(){filterMandantValue=document.getElementById("filterMandant").value.trim();zeigeIdeen();}
function filterMandantZuruecksetzen(){filterMandantValue="";document.getElementById("filterMandant").value="";zeigeIdeen();}

function speichereIdee(){
    const text = document.getElementById("ideeText").value.trim();
    if(!text) return zeigeWarnung("Titel ist erforderlich!");

    let dateien = [];
    // Verarbeitung von Dateien (Upload falls angemeldet, lokale URL sonst)
    const dateiInput = document.getElementById("dateien").files;
    if(dateiInput.length > 0){
         if(accessToken){
             // Upload zu OneDrive
             zeigeWarnung("Lade Dateien auf OneDrive hoch...", 'info'); // Meldung f√ºr Upload (info)
             Promise.all(Array.from(dateiInput).map(async file => ({
                 name: file.name,
                 type: file.type,
                 link: await uploadToOneDrive(file) // link wird gef√ºllt wenn Upload erfolgreich
             })))
             .then(uploadedFiles => {
                 // Filter: nur erfolgreich hochgeladene Dateien ODER alte Dateien mit Link
                 dateien = uploadedFiles.filter(f => f.link !== null); // Nur erfolgreich hochgeladene
                 // Wenn wir im Bearbeitungsmodus sind, alte Dateien (mit Link) √ºbernehmen
                 if (bearbeiteId !== null) {
                      const originalIdeen = JSON.parse(localStorage.getItem("ideen") || "[]");
                      const ideeInBearbeitung = originalIdeen.find(item => item.id === bearbeiteId);
                      if (ideeInBearbeitung && ideeInBearbeitung.dateien) {
                           // F√ºge alte Dateien hinzu, die einen Link haben (OneDrive-Links behalten)
                           dateien = dateien.concat(ideeInbearbeitung.dateien.filter(oldFile => oldFile.link)); // Nur alte Dateien mit Link behalten
                            // Optional: Logik zum Umgang mit lokalen (blob:) URLs beim Bearbeiten √ºberdenken
                            // Aktuell werden neue lokale Dateien hinzugef√ºgt, alte lokale Dateien verworfen.
                            // Das ist konsistent, da lokale URLs nach Neuladen nicht mehr g√ºltig sind.
                       }
                 }
                 zeigeWarnung("Dateiupload abgeschlossen.", 'success'); // Erfolgsmeldung f√ºr Upload (success)
                 saveIdeeObjekt(text, dateien); // Speichern der Idee nach Upload
             })
             .catch(e => {
                  zeigeWarnung("Fehler beim Datei-Upload: " + e.message); // Bleibt warning
                  // Idee speichern auch wenn Upload fehlschl√§gt? Ja, ohne Dateien.
                  saveIdeeObjekt(text, []); // Speichern der Idee auch bei Upload-Fehler (ohne die fehlgeschlagenen Dateien)
             });
         } else {
             // Lokale Dateien (nur tempor√§re URLs)
             dateien = Array.from(dateiInput).map(file => ({
                 name: file.name,
                 data: URL.createObjectURL(file), // Tempor√§re URL
                 type: file.type,
                 pfad: file.webkitRelativePath || file.name // Pfadinfo
             }));
             // Im Bearbeitungsmodus: alte Dateien √ºbernehmen
              if (bearbeiteId !== null) {
                   const originalIdeen = JSON.parse(localStorage.getItem("ideen") || "[]");
                   const ideeInBearbeitung = originalIdeen.find(item => item.id === bearbeiteId);
                   if (ideeInBearbeitung && ideeInBearbeitung.dateien) {
                        // F√ºge alte Dateien hinzu (auch lokale oder OneDrive, je nachdem was da war)
                        dateien = dateien.concat(ideeInBearbeitung.dateien); // F√ºgt alle alten Dateien hinzu
                   }
              }
             saveIdeeObjekt(text, dateien); // Sofort speichern
         }
    } else {
        // Keine neuen Dateien ausgew√§hlt
        // Im Bearbeitungsmodus: alte Dateien √ºbernehmen
         if (bearbeiteId !== null) {
              const originalIdeen = JSON.parse(localStorage.getItem("ideen") || "[]");
              const ideeInBearbeitung = originalIdeen.find(item => item.id === bearbeiteId);
              if (ideeInBearbeitung && ideeInBearbeitung.dateien) {
                   dateien = ideeInBearbeitung.dateien;
              }
         }
        saveIdeeObjekt(text, dateien); // Sofort speichern
    }
}

function saveIdeeObjekt(text, dateien){
    let ideen = JSON.parse(localStorage.getItem("ideen") || "[]");
    const details = document.getElementById("ideeDetails").value;
    const kategorie = document.getElementById("kategorie").value;
    const mandantennummer = document.getElementById("mandantennummer").value.trim();
    const firmenname = document.getElementById("firmenname").value.trim();
    // Beim Aktualisieren wird der urspr√ºngliche Timestamp beibehalten, bei neuer Idee aktueller Timestamp
    const timestamp = bearbeiteId !== null ? ideen.find(item => item.id === bearbeiteId)?.timestamp || new Date().toISOString() : new Date().toISOString();


    if (bearbeiteId !== null) {
        // Idee wird aktualisiert
        const ideeIndex = ideen.findIndex(item => item.id === bearbeiteId);

        if (ideeIndex !== -1) {
             // √úbernimm existierende erledigt und beschreibungen, falls vorhanden
             const existingIdee = ideen[ideeIndex];
             ideen[ideeIndex] = {
                 id: bearbeiteId, // Behalte die existierende ID
                 text,
                 details,
                 kategorie,
                 prioritaet, // Globale Variable wird hier verwendet
                 mandantennummer,
                 firmenname,
                 dateien, // Neue und √ºbernommene Dateien
                 timestamp: existingIdee.timestamp, // Urspr√ºnglichen Timestamp beibehalten f√ºr Sortierung 'alt'
                 erledigt: existingIdee.erledigt || false,
                 beschreibungen: existingIdee.beschreibungen || []
             };
             localStorage.setItem("ideen", JSON.stringify(ideen));
        } else {
            // Fehler oder Idee w√§hrend Bearbeitung gel√∂scht?
            zeigeWarnung("Fehler: Idee zur Aktualisierung nicht gefunden (ID: " + bearbeiteId + ").");
        }

        bearbeiteId = null; // Bearbeitungsmodus beenden
        document.getElementById("speichernBtn").textContent = "üíæ Speichern";
        document.getElementById("abbrechenBtn").style.display = "none";
    } else {
        // Neue Idee hinzuf√ºgen
        const neueIdee = {
            id: generateUUID(), // Neue eindeutige ID
            text,
            details,
            kategorie,
            prioritaet, // Globale Variable wird hier verwendet
            mandantennummer,
            firmenname,
            dateien,
            timestamp, // Timestamp der Erstellung
            erledigt: false,
            beschreibungen: []
        };
        ideen.push(neueIdee);
        localStorage.setItem("ideen", JSON.stringify(ideen));
    }

    zeigeIdeen(); // Liste neu rendern
    // Formularfelder leeren
    document.getElementById("ideeText").value = "";
    document.getElementById("ideeDetails").value = "";
    document.getElementById("mandantennummer").value = "";
    document.getElementById("firmenname").value = "";
    document.getElementById("dateien").value = "";
    document.getElementById("dateiVorschau").innerHTML = ""; // Dateivorschau leeren
    setzePrioritaet(""); // Priorit√§t zur√ºcksetzen
    istGespeichert = true;
}


function zeigeIdeen(){
    const fullIdeen = JSON.parse(localStorage.getItem("ideen") || "[]");
    let filteredIdeen = [...fullIdeen]; // Kopie f√ºr Filterung

    // Apply category filter
    const filterKategorie = document.getElementById("filterKategorie").value;
    if(filterKategorie) filteredIdeen = filteredIdeen.filter(i => i.kategorie === filterKategorie);

    // Apply mandant filter
    if(filterMandantValue) filteredIdeen = filteredIdeen.filter(i => (i.mandantennummer||"").toLowerCase() === filterMandantValue.toLowerCase());

    // >>> ARCHIVE FILTER START <<<
    const filterArchivValue = document.getElementById("filterArchiv").value;
    if (filterArchivValue === "nicht_erledigt") {
        filteredIdeen = filteredIdeen.filter(i => !(i.erledigt || false)); // Filter out completed items
    } else if (filterArchivValue === "erledigt") {
        filteredIdeen = filteredIdeen.filter(i => (i.erledigt || false)); // Filter for completed items
    }
    // If filterArchivValue is "alle", no filtering based on erledigt is applied here.
    // >>> ARCHIVE FILTER END <<<

    // Apply sorting
    const sortierung = document.getElementById("sortierung").value;
    filteredIdeen.sort((a,b)=>{
        if(sortierung==="prio"){
            const p={"Hoch":3,"Mittel":2,"Niedrig":1};
            return (p[b.prioritaet]||0) - (p[a.prioritaet]||0);
        }
        if(sortierung==="neu"){
            return new Date(b.timestamp) - new Date(a.timestamp);
        }
        // sortierung === "alt"
        return new Date(a.timestamp) - new Date(b.timestamp); // *** Diese Zeile ist jetzt vollst√§ndig ***
    });

    const ideenListeDiv = document.getElementById("ideenListe");
    ideenListeDiv.innerHTML = filteredIdeen.map(idee => {
        // Verwende die Idee.id f√ºr alle Aktionen und die Auswahl
        const ideeId = idee.id; // Die eindeutige ID der Idee

        const erledigt = idee.erledigt || false;
        const anzeigeDatum = new Date(idee.timestamp).toLocaleString("de-DE");

        // Verwende ideeId f√ºr Action button calls und Checkbox
        return`<div class="idee${erledigt?' erledigt':''}"><div class="idee-content"><h3><span class="math-inline">\{idee\.text\}</h3\><p\></span>{idee.details||""}</p>${idee.mandantennummer?`<div>Mandantennummer: <b>${idee.mandantennummer}</b></div>`:""}${idee.firmenname?`<div>Firmenname: <b>${idee.firmenname}</b></div>`:""}${idee.beschreibungen&&idee.beschreibungen.length?`<div class="beschreibung-historie"><b>Weitere Beschreibungen:</b>${idee.beschreibungen.map(b=>`<div class="beschreibung-item"><div class="beschreibung-text-zeit"><span class="beschreibung-zeit"><span class="math-inline">\{b\.timestamp\}</span\></span>{b.text}</div><button class="edit-beschreibung-btn" onclick="bearbeiteEinzelneBeschreibung('<span class="math-inline">\{ideeId\}', '</span>{b.timestamp}')">‚úèÔ∏è</button></div>`).join("")}</div>`:""}<small>${idee.kategorie} | ${idee.prioritaet||"Keine"} | <span class="math-inline">\{anzeigeDatum\}</small\></span>{idee.dateien?.map(file=>`<a class="datei-link" href="${file.link||file.data}" target="_blank">${file.link?'üåê':'üìé'} ${file.name}</a>${file.link?'<div class="datei-info">OneDrive-Link</div>':`<div class="datei-info">Pfad: <i>${file.pfad||file.name}</i></div>`}${file.type?.startsWith("image/")?`<img src="${file.link||file.data}" style="max-width:150px;">`:""}${file.type==="application/pdf"?`<iframe src="${file.link||file.data}" style="width:150px;height:100px;"></iframe>`:""}`).join("")}<div class="idee-actions"><button onclick="verschiebeIdee('<span class="math-inline">\{ideeId\}',\-1\)"\>‚¨ÜÔ∏è</button\><button onclick\="verschiebeIdee\('</span>{ideeId}',1)">‚¨áÔ∏è</button><button onclick="bearbeiteIdee('<span class="math-inline">\{ideeId\}'\)"\>‚úèÔ∏è</button\><button onclick\="toggleErledigt\('</span>{ideeId}')"><span class="math-inline">\{erledigt?"‚Ü©Ô∏è"\:"‚úîÔ∏è"\}</button\><button onclick\="loescheIdee\('</span>{ideeId}')">üóëÔ∏è</button><button onclick="zeigeBeschreibungDialog('<span class="math-inline">\{ideeId\}'\)"\>\+ Beschreibung</button\></div\></div\><input type\="checkbox" class\="idee\-checkbox" onchange\="toggleAuswahl\('</span>{ideeId}',this)" ${ausgewaehlt.includes(ideeId)?"checked":""}></div>`;
    }).join("");

    // Das Bearbeitungsformular schlie√üen, wenn die bearbeitete Idee durch Filter unsichtbar wird
    if (bearbeiteId !== null) {
        const ideeInBearbeitungIstNochSichtbar = filteredIdeen.some(idee => idee.id === bearbeiteId);
        if (!ideeInBearbeitungIstNochSichtbar) {
            abbrechenBearbeiten(); // Bricht ab, wenn bearbeitete Idee nicht mehr in gefilterter Liste ist
        }
    }
    // Das Beschreibungs-Dialog schlie√üen, wenn die Idee durch Filter unsichtbar wird
    if (beschreibungFuerId !== null) {
         const ideeFuerBeschreibungIstNochSichtbar = filteredIdeen.some(idee => idee.id === beschreibungFuerId);
         if (!ideeFuerBeschreibungIstNochSichtbar) {
              beschreibungAbbrechen(); // Bricht ab, wenn Idee nicht mehr in gefilterter Liste ist
         }
    }
}

// Ge√§ndert: Kann nun auch zum Bearbeiten verwendet werden (mit optionalem descTimestamp)
function zeigeBeschreibungDialog(ideeId, descTimestamp = null){
    beschreibungFuerId = ideeId; // Speichern der Idee-ID
    beschreibungZuBearbeitenderTimestamp = descTimestamp; // Speichern des Timestamps (null beim Hinzuf√ºgen)

    const beschreibungTextarea = document.getElementById("beschreibungText");
    // const dialogTitel = document.getElementById("beschreibungDialogTitel"); // F√ºge diesen Titel im HTML hinzu, falls gew√ºnscht

    if (descTimestamp !== null) {
         // Bearbeiten einer vorhandenen Beschreibung
         const ideen = JSON.parse(localStorage.getItem("ideen") || "[]");
         const idee = ideen.find(item => item.id === ideeId);
         const beschreibung = idee?.beschreibungen.find(b => b.timestamp === descTimestamp);

         if (beschreibung) {
              beschreibungTextarea.value = beschreibung.text;
              // if (dialogTitel) dialogTitel.textContent = "Beschreibung bearbeiten";
         } else {
              zeigeWarnung("Fehler: Beschreibung zum Bearbeiten nicht gefunden.");
              beschreibungAbbrechen();
              return;
         }
    } else {
         // Hinzuf√ºgen einer neuen Beschreibung
         beschreibungTextarea.value = "";
         // if (dialogTitel) dialogTitel.textContent = "Weitere Beschreibung hinzuf√ºgen";
    }


    document.getElementById("beschreibungDialog").style.display = "block";
    beschreibungTextarea.focus();
    istGespeichert = false;
}

function beschreibungAbbrechen(){
    document.getElementById("beschreibungDialog").style.display = "none";
    beschreibungFuerId = null;
    beschreibungZuBearbeitenderTimestamp = null; // Zur√ºcksetzen
    document.getElementById("beschreibungText").value = "";
}

// Ge√§ndert: Behandelt nun Hinzuf√ºgen und Bearbeiten
function beschreibungSpeichern(){
    const t = document.getElementById("beschreibungText").value.trim();
    if(!t) return;
    let ideen = JSON.parse(localStorage.getItem("ideen") || "[]");

    // Finde die Idee anhand der gespeicherten ID
    const ideeIndex = ideen.findIndex(item => item.id === beschreibungFuerId);

    if (ideeIndex !== -1) {
         if (beschreibungZuBearbeitenderTimestamp !== null) {
              // Bearbeiten einer vorhandenen Beschreibung
              const beschreibungIndex = ideen[ideeIndex].beschreibungen.findIndex(b => b.timestamp === beschreibungZuBearbeitenderTimestamp);
              if (beschreibungIndex !== -1) {
                   ideen[ideeIndex].beschreibungen[beschreibungIndex].text = t; // Text aktualisieren
                   // Timestamp wird hier nicht ge√§ndert, k√∂nnte man aber
              } else {
                   zeigeWarnung("Fehler: Beschreibungseintrag zum Bearbeiten nicht gefunden.");
              }
         } else {
              // Hinzuf√ºgen einer neuen Beschreibung
              // Generiere einen einzigartigen Timestamp f√ºr neue Eintr√§ge (wichtig f√ºr die Bearbeitungs-ID)
              const timestamp = new Date().toISOString() + '_' + Math.random().toString(36).substr(2, 9); // ISO String + Zufallsteil
              if(!ideen[ideeIndex].beschreibungen) ideen[ideeIndex].beschreibungen = [];
              ideen[ideeIndex].beschreibungen.push({ text: t, timestamp: timestamp }); // Verwende den generierten Timestamp
         }

         localStorage.setItem("ideen", JSON.stringify(ideen));
         zeigeIdeen(); // Liste neu rendern
    } else {
         zeigeWarnung("Fehler: Idee f√ºr Beschreibung nicht gefunden (ID: " + beschreibungFuerId + ").");
    }

    beschreibungAbbrechen(); // Dialog schlie√üen und Hilfsvariablen zur√ºcksetzen
    istGespeichert = true;
}

// Neue Funktion zum Aufruf durch den einzelnen Bearbeiten-Button
function bearbeiteEinzelneBeschreibung(ideeId, descTimestamp) {
    // Sicherstellen, dass der Timestamp √ºbergeben wird
    if (descTimestamp) {
        zeigeBeschreibungDialog(ideeId, descTimestamp); // Ruft den Dialog im Bearbeitungsmodus auf
    } else {
        // Dies sollte nicht passieren, da der Button nur bei bestehenden Beschreibungen erscheint
        zeigeWarnung("Interner Fehler: Timestamp f√ºr Bearbeitung fehlt.");
    }
}


// Ge√§ndert: Nimmt Idee-ID entgegen
function toggleErledigt(ideeId){
    let ideen = JSON.parse(localStorage.getItem("ideen")||"[]");
    const ideeIndex = ideen.findIndex(item => item.id === ideeId);

    if (ideeIndex !== -1) {
        ideen[ideeIndex].erledigt = !(ideen[ideeIndex].erledigt || false);
        localStorage.setItem("ideen", JSON.stringify(ideen));
        zeigeIdeen(); // Liste neu rendern (Filter beachten!)
        istGespeichert = false; // Status√§nderung = ungespeichert
    }
}

// Ge√§ndert: Nimmt Idee-ID entgegen
function bearbeiteIdee(ideeId){
    const ideen = JSON.parse(localStorage.getItem("ideen")||"[]");
    const idee = ideen.find(item => item.id === ideeId); // Finde Idee anhand ID

    if (!idee) {
        zeigeWarnung("Fehler: Idee zum Bearbeiten nicht gefunden (ID: " + ideeId + ").");
        return;
    }

    document.getElementById("ideeText").value = idee.text;
    document.getElementById("ideeDetails").value = idee.details || "";
    document.getElementById("kategorie").value = idee.kategorie;
    document.getElementById("mandantennummer").value = idee.mandantennummer || "";
    document.getElementById("firmenname").value = idee.firmenname || "";
    prioritaet = idee.prioritaet; // Setze die globale prioritaet Variable
    setzePrioritaet(idee.prioritaet); // Aktualisiere UI basierend auf der globalen Variable

    bearbeiteId = ideeId; // Speichere die ID der bearbeiteten Idee

    // Dateivorschau beim Bearbeiten anzeigen (URLs f√ºr lokale Dateien neu generieren)
    const dateiVorschauDiv = document.getElementById("dateiVorschau");
    dateiVorschauDiv.innerHTML = ""; // Leeren
     if (idee.dateien) {
         idee.dateien.forEach(file => {
             const fileUrl = file.link || file.data; // Nutze Link oder lokale URL
             if (fileUrl) {
                 dateiVorschauDiv.innerHTML += `<a class="datei-link" href="<span class="math-inline">\{fileUrl\}" target\="\_blank"\></span>{file.link ? 'üåê' : 'üìé'} <span class="math-inline">\{file\.name\}</a\></span>{file.link?'<div class="datei-info">OneDrive-Link</div>':`<div class="datei-info">Pfad: <i>${file.pfad||file.name}</i></div>`}${file.type?.startsWith("image/")?`<img src="${file.link||file.data}" style="max-width:150px;">`:""}${file.type==="application/pdf"?`<iframe src="${file.link||file.data}" style="width:150px;height:100px;"></iframe>`:""}`;
             }
         });
     }

    document.getElementById("speichernBtn").textContent = "üíæ Aktualisieren";
    document.getElementById("abbrechenBtn").style.display = "";
    istGespeichert = false;
}

function abbrechenBearbeiten(){
    bearbeiteId = null; // Bearbeitungs-ID zur√ºcksetzen
    document.getElementById("ideeText").value = "";
    document.getElementById("ideeDetails").value = "";
    document.getElementById("mandantennummer").value = "";
    document.getElementById("firmenname").value = "";
    document.getElementById("dateien").value = ""; // Dateifeld leeren
    document.getElementById("dateiVorschau").innerHTML = ""; // Dateivorschau leeren
    document.getElementById("speichernBtn").textContent = "üíæ Speichern";
    document.getElementById("abbrechenBtn").style.display = "none";
    setzePrioritaet(""); // Priorit√§t zur√ºcksetzen (setzt globale Var und UI)
    istGespeichert = true;
}

// Ge√§ndert: Nimmt Idee-ID entgegen
function verschiebeIdee(ideeId, richtung){
    let fullIdeen = JSON.parse(localStorage.getItem("ideen")||"[]");
    // Finde die aktuell gefilterte und sortierte Liste, um die Position zu bestimmen
    const filterKategorie = document.getElementById("filterKategorie").value;
    const filterMandantValue = document.getElementById("filterMandant").value.trim();
    const filterArchivValue = document.getElementById("filterArchiv").value;
    const sortierung = document.getElementById("sortierung").value;

    let currentViewIdeen = [...fullIdeen]; // Kopie f√ºr Filterung/Sortierung der Ansicht

    if(filterKategorie) currentViewIdeen = currentViewIdeen.filter(i => i.kategorie === filterKategorie);
    if(filterMandantValue) currentViewIdeen = currentViewIdeen.filter(i => (i.mandantennummer||"").toLowerCase() === filterMandantValue.toLowerCase());
     if (filterArchivValue === "nicht_erledigt") {
         currentViewIdeen = currentViewIdeen.filter(i => !(i.erledigt || false));
     } else if (filterArchivValue === "erledigt") {
         currentViewIdeen = currentViewIdeen.filter(i => (i.erledigt || false));
     }
    currentViewIdeen.sort((a,b)=>{
        if(sortierung==="prio"){
            const p={"Hoch":3,"Mittel":2,"Niedrig":1};
            return (p[b.prioritaet]||0) - (p[a.prioritaet]||0);
        }
        if(sortierung==="neu"){
            return new Date(b.timestamp) - new Date(a.timestamp);
        }
        // sortierung === "alt"
        return new Date(a.timestamp) - new Date(b.timestamp); // *** Diese Zeile ist jetzt vollst√§ndig ***
    });

    const ideenListeDiv = document.getElementById("ideenListe");
    ideenListeDiv.innerHTML = filteredIdeen.map(idee => {
        // Verwende die Idee.id f√ºr alle Aktionen und die Auswahl
        const ideeId = idee.id; // Die eindeutige ID der Idee

        const erledigt = idee.erledigt || false;
        const anzeigeDatum = new Date(idee.timestamp).toLocaleString("de-DE");

        // Verwende ideeId f√ºr Action button calls und Checkbox
        return`<div class="idee${erledigt?' erledigt':''}"><div class="idee-content"><h3><span class="math-inline">\{idee\.text\}</h3\><p\></span>{idee.details||""}</p>${idee.mandantennummer?`<div>Mandantennummer: <b>${idee.mandantennummer}</b></div>`:""}${idee.firmenname?`<div>Firmenname: <b>${idee.firmenname}</b></div>`:""}${idee.beschreibungen&&idee.beschreibungen.length?`<div class="beschreibung-historie"><b>Weitere Beschreibungen:</b>${idee.beschreibungen.map(b=>`<div class="beschreibung-item"><div class="beschreibung-text-zeit"><span class="beschreibung-zeit"><span class="math-inline">\{b\.timestamp\}</span\></span>{b.text}</div><button class="edit-beschreibung-btn" onclick="bearbeiteEinzelneBeschreibung('<span class="math-inline">\{ideeId\}', '</span>{b.timestamp}')">‚úèÔ∏è</button></div>`).join("")}</div>`:""}<small>${idee.kategorie} | ${idee.prioritaet||"Keine"} | <span class="math-inline">\{anzeigeDatum\}</small\></span>{idee.dateien?.map(file=>`<a class="datei-link" href="${file.link||file.data}" target="_blank">${file.link?'üåê':'üìé'} ${file.name}</a>${file.link?'<div class="datei-info">OneDrive-Link</div>':`<div class="datei-info">Pfad: <i>${file.pfad||file.name}</i></div>`}${file.type?.startsWith("image/")?`<img src="${file.link||file.data}" style="max-width:150px;">`:""}${file.type==="application/pdf"?`<iframe src="${file.link||file.data}" style="width:150px;height:100px;"></iframe>`:""}`).join("")}<div class="idee-actions"><button onclick="verschiebeIdee('<span class="math-inline">\{ideeId\}',\-1\)"\>‚¨ÜÔ∏è</button\><button onclick\="verschiebeIdee\('</span>{ideeId}',1)">‚¨áÔ∏è</button><button onclick="bearbeiteIdee('<span class="math-inline">\{ideeId\}'\)"\>‚úèÔ∏è</button\><button onclick\="toggleErledigt\('</span>{ideeId}')"><span class="math-inline">\{erledigt?"‚Ü©Ô∏è"\:"‚úîÔ∏è"\}</button\><button onclick\="loescheIdee\('</span>{ideeId}')">üóëÔ∏è</button><button onclick="zeigeBeschreibungDialog('<span class="math-inline">\{ideeId\}'\)"\>\+ Beschreibung</button\></div\></div\><input type\="checkbox" class\="idee\-checkbox" onchange\="toggleAuswahl\('</span>{ideeId}',this)" ${ausgewaehlt.includes(ideeId)?"checked":""}></div>`;
    }).join("");

    // Das Bearbeitungsformular schlie√üen, wenn die bearbeitete Idee durch Filter unsichtbar wird
    if (bearbeiteId !== null) {
        const ideeInBearbeitungIstNochSichtbar = filteredIdeen.some(idee => idee.id === bearbeiteId);
        if (!ideeInBearbeitungIstNochSichtbar) {
            abbrechenBearbeiten(); // Bricht ab, wenn bearbeitete Idee nicht mehr in gefilterter Liste ist
        }
    }
    // Das Beschreibungs-Dialog schlie√üen, wenn die Idee durch Filter unsichtbar wird
    if (beschreibungFuerId !== null) {
         const ideeFuerBeschreibungIstNochSichtbar = filteredIdeen.some(idee => idee.id === beschreibungFuerId);
         if (!ideeFuerBeschreibungIstNochSichtbar) {
              beschreibungAbbrechen(); // Bricht ab, wenn Idee nicht mehr in gefilterter Liste ist
         }
    }
}

// Ge√§ndert: Kann nun auch zum Bearbeiten verwendet werden (mit optionalem descTimestamp)
function zeigeBeschreibungDialog(ideeId, descTimestamp = null){
    beschreibungFuerId = ideeId; // Speichern der Idee-ID
    beschreibungZuBearbeitenderTimestamp = descTimestamp; // Speichern des Timestamps (null beim Hinzuf√ºgen)

    const beschreibungTextarea = document.getElementById("beschreibungText");
    // const dialogTitel = document.getElementById("beschreibungDialogTitel"); // F√ºge diesen Titel im HTML hinzu, falls gew√ºnscht

    if (descTimestamp !== null) {
         // Bearbeiten einer vorhandenen Beschreibung
         const ideen = JSON.parse(localStorage.getItem("ideen") || "[]");
         const idee = ideen.find(item => item.id === ideeId);
         const beschreibung = idee?.beschreibungen.find(b => b.timestamp === descTimestamp);

         if (beschreibung) {
              beschreibungTextarea.value = beschreibung.text;
              // if (dialogTitel) dialogTitel.textContent = "Beschreibung bearbeiten";
         } else {
              zeigeWarnung("Fehler: Beschreibung zum Bearbeiten nicht gefunden.");
              beschreibungAbbrechen();
              return;
         }
    } else {
         // Hinzuf√ºgen einer neuen Beschreibung
         beschreibungTextarea.value = "";
         // if (dialogTitel) dialogTitel.textContent = "Weitere Beschreibung hinzuf√ºgen";
    }


    document.getElementById("beschreibungDialog").style.display = "block";
    beschreibungTextarea.focus();
    istGespeichert = false;
}

function beschreibungAbbrechen(){
    document.getElementById("beschreibungDialog").style.display = "none";
    beschreibungFuerId = null;
    beschreibungZuBearbeitenderTimestamp = null; // Zur√ºcksetzen
    document.getElementById("beschreibungText").value = "";
}

// Ge√§ndert: Behandelt nun Hinzuf√ºgen und Bearbeiten
function beschreibungSpeichern(){
    const t = document.getElementById("beschreibungText").value.trim();
    if(!t) return;
    let ideen = JSON.parse(localStorage.getItem("ideen") || "[]");

    // Finde die Idee anhand der gespeicherten ID
    const ideeIndex = ideen.findIndex(item => item.id === beschreibungFuerId);

    if (ideeIndex !== -1) {
         if (beschreibungZuBearbeitenderTimestamp !== null) {
              // Bearbeiten einer vorhandenen Beschreibung
              const beschreibungIndex = ideen[ideeIndex].beschreibungen.findIndex(b => b.timestamp === beschreibungZuBearbeitenderTimestamp);
              if (beschreibungIndex !== -1) {
                   ideen[ideeIndex].beschreibungen[beschreibungIndex].text = t; // Text aktualisieren
                   // Timestamp wird hier nicht ge√§ndert, k√∂nnte man aber
              } else {
                   zeigeWarnung("Fehler: Beschreibungseintrag zum Bearbeiten nicht gefunden.");
              }
         } else {
              // Hinzuf√ºgen einer neuen Beschreibung
              // Generiere einen einzigartigen Timestamp f√ºr neue Eintr√§ge (wichtig f√ºr die Bearbeitungs-ID)
              const timestamp = new Date().toISOString() + '_' + Math.random().toString(36).substr(2, 9); // ISO String + Zufallsteil
              if(!ideen[ideeIndex].beschreibungen) ideen[ideeIndex].beschreibungen = [];
              ideen[ideeIndex].beschreibungen.push({ text: t, timestamp: timestamp }); // Verwende den generierten Timestamp
         }

         localStorage.setItem("ideen", JSON.stringify(ideen));
         zeigeIdeen(); // Liste neu rendern
    } else {
         zeigeWarnung("Fehler: Idee f√ºr Beschreibung nicht gefunden (ID: " + beschreibungFuerId + ").");
    }

    beschreibungAbbrechen(); // Dialog schlie√üen und Hilfsvariablen zur√ºcksetzen
    istGespeichert = true;
}

// Neue Funktion zum Aufruf durch den einzelnen Bearbeiten-Button
function bearbeiteEinzelneBeschreibung(ideeId, descTimestamp) {
    // Sicherstellen, dass der Timestamp √ºbergeben wird
    if (descTimestamp) {
        zeigeBeschreibungDialog(ideeId, descTimestamp); // Ruft den Dialog im Bearbeitungsmodus auf
    } else {
        // Dies sollte nicht passieren, da der Button nur bei bestehenden Beschreibungen erscheint
        zeigeWarnung("Interner Fehler: Timestamp f√ºr Bearbeitung fehlt.");
    }
}


// Ge√§ndert: Nimmt Idee-ID entgegen
function toggleErledigt(ideeId){
    let ideen = JSON.parse(localStorage.getItem("ideen")||"[]");
    const ideeIndex = ideen.findIndex(item => item.id === ideeId);

    if (ideeIndex !== -1) {
        ideen[ideeIndex].erledigt = !(ideen[ideeIndex].erledigt || false);
        localStorage.setItem("ideen", JSON.stringify(ideen));
        zeigeIdeen(); // Liste neu rendern (Filter beachten!)
        istGespeichert = false; // Status√§nderung = ungespeichert
    }
}

// Ge√§ndert: Nimmt Idee-ID entgegen
function bearbeiteIdee(ideeId){
    const ideen = JSON.parse(localStorage.getItem("ideen")||"[]");
    const idee = ideen.find(item => item.id === ideeId); // Finde Idee anhand ID

    if (!idee) {
        zeigeWarnung("Fehler: Idee zum Bearbeiten nicht gefunden (ID: " + ideeId + ").");
        return;
    }

    document.getElementById("ideeText").value = idee.text;
    document.getElementById("ideeDetails").value = idee.details || "";
    document.getElementById("kategorie").value = idee.kategorie;
    document.getElementById("mandantennummer").value = idee.mandantennummer || "";
    document.getElementById("firmenname").value = idee.firmenname || "";
    prioritaet = idee.prioritaet; // Setze die globale prioritaet Variable
    setzePrioritaet(idee.prioritaet); // Aktualisiere UI basierend auf der globalen Variable

    bearbeiteId = ideeId; // Speichere die ID der bearbeiteten Idee

    // Dateivorschau beim Bearbeiten anzeigen (URLs f√ºr lokale Dateien neu generieren)
    const dateiVorschauDiv = document.getElementById("dateiVorschau");
    dateiVorschauDiv.innerHTML = ""; // Leeren
     if (idee.dateien) {
         idee.dateien.forEach(file => {
             const fileUrl = file.link || file.data; // Nutze Link oder lokale URL
             if (fileUrl) {
                 dateiVorschauDiv.innerHTML += `<a class="datei-link" href="<span class="math-inline">\{fileUrl\}" target\="\_blank"\></span>{file.link ? 'üåê' : 'üìé'} <span class="math-inline">\{file\.name\}</a\></span>{file.link?'<div class="datei-info">OneDrive-Link</div>':`<div class="datei-info">Pfad: <i>${file.pfad||file.name}</i></div>`}${file.type?.startsWith("image/")?`<img src="${file.link||file.data}" style="max-width:150px;">`:""}${file.type==="application/pdf"?`<iframe src="${file.link||file.data}" style="width:150px;height:100px;"></iframe>`:""}`;
             }
         });
     }

    document.getElementById("speichernBtn").textContent = "üíæ Aktualisieren";
    document.getElementById("abbrechenBtn").style.display = "";
    istGespeichert = false;
}

function abbrechenBearbeiten(){
    bearbeiteId = null; // Bearbeitungs-ID zur√ºcksetzen
    document.getElementById("ideeText").value = "";
    document.getElementById("ideeDetails").value = "";
    document.getElementById("mandantennummer").value = "";
    document.getElementById("firmenname").value = "";
    document.getElementById("dateien").value = ""; // Dateifeld leeren
    document.getElementById("dateiVorschau").innerHTML = ""; // Dateivorschau leeren
    document.getElementById("speichernBtn").textContent = "üíæ Speichern";
    document.getElementById("abbrechenBtn").style.display = "none";
    setzePrioritaet(""); // Priorit√§t zur√ºcksetzen (setzt globale Var und UI)
    istGespeichert = true;
}

// Ge√§ndert: Nimmt Idee-ID entgegen
function verschiebeIdee(ideeId, richtung){
    let fullIdeen = JSON.parse(localStorage.getItem("ideen")||"[]");
    // Finde die aktuell gefilterte und sortierte Liste, um die Position zu bestimmen
    const filterKategorie = document.getElementById("filterKategorie").value;
    const filterMandantValue = document.getElementById("filterMandant").value.trim();
    const filterArchivValue = document.getElementById("filterArchiv").value;
    const sortierung = document.getElementById("sortierung").value;

    let currentViewIdeen = [...fullIdeen]; // Kopie f√ºr Filterung/Sortierung der Ansicht

    if(filterKategorie) currentViewIdeen = currentViewIdeen.filter(i => i.kategorie === filterKategorie);
    if(filterMandantValue) currentViewIdeen = currentViewIdeen.filter(i => (i.mandantennummer||"").toLowerCase() === filterMandantValue.toLowerCase());
     if (filterArchivValue === "nicht_erledigt") {
         currentViewIdeen = currentViewIdeen.filter(i => !(i.erledigt || false));
     } else if (filterArchivValue === "erledigt") {
         currentViewIdeen = currentViewIdeen.filter(i => (i.erledigt || false));
     }
    currentViewIdeen.sort((a,b)=>{
        if(sortierung==="prio"){
            const p={"Hoch":3,"Mittel":2,"Niedrig":1};
            return (p[b.prioritaet]||0) - (p[a.prioritaet]||0);
        }
        if(sortierung==="neu"){
            return new Date(b.timestamp) - new Date(a.timestamp);
        }
        // sortierung === "alt"
        return new Date(a.timestamp) - new Date(b.timestamp); // *** Diese Zeile ist jetzt vollst√§ndig ***
    });

    const ideenListeDiv = document.getElementById("ideenListe");
    ideenListeDiv.innerHTML = filteredIdeen.map(idee => {
        // Verwende die Idee.id f√ºr alle Aktionen und die Auswahl
        const ideeId = idee.id; // Die eindeutige ID der Idee

        const erledigt = idee.erledigt || false;
        const anzeigeDatum = new Date(idee.timestamp).toLocaleString("de-DE");

        // Verwende ideeId f√ºr Action button calls und Checkbox
        return`<div class="idee${erledigt?' erledigt':''}"><div class="idee-content"><h3><span class="math-inline">\{idee\.text\}</h3\><p\></span>{idee.details||""}</p>${idee.mandantennummer?`<div>Mandantennummer: <b>${idee.mandantennummer}</b></div>`:""}${idee.firmenname?`<div>Firmenname: <b>${idee.firmenname}</b></div>`:""}${idee.beschreibungen&&idee.beschreibungen.length?`<div class="beschreibung-historie"><b>Weitere Beschreibungen:</b>${idee.beschreibungen.map(b=>`<div class="beschreibung-item"><div class="beschreibung-text-zeit"><span class="beschreibung-zeit"><span class="math-inline">\{b\.timestamp\}</span\></span>{b.text}</div><button class="edit-beschreibung-btn" onclick="bearbeiteEinzelneBeschreibung('<span class="math-inline">\{ideeId\}', '</span>{b.timestamp}')">‚úèÔ∏è</button></div>`).join("")}</div>`:""}<small>${idee.kategorie} | ${idee.prioritaet||"Keine"} | <span class="math-inline">\{anzeigeDatum\}</small\></span>{idee.dateien?.map(file=>`<a class="datei-link" href="${file.link||file.data}" target="_blank">${file.link?'üåê':'üìé'} ${file.name}</a>${file.link?'<div class="datei-info">OneDrive-Link</div>':`<div class="datei-info">Pfad: <i>${file.pfad||file.name}</i></div>`}${file.type?.startsWith("image/")?`<img src="${file.link||file.data}" style="max-width:150px;">`:""}${file.type==="application/pdf"?`<iframe src="${file.link||file.data}" style="width:150px;height:100px;"></iframe>`:""}`).join("")}<div class="idee-actions"><button onclick="verschiebeIdee('<span class="math-inline">\{ideeId\}',\-1\)"\>‚¨ÜÔ∏è</button\><button onclick\="verschiebeIdee\('</span>{ideeId}',1)">‚¨áÔ∏è</button><button onclick="bearbeiteIdee('<span class="math-inline">\{ideeId\}'\)"\>‚úèÔ∏è</button\><button onclick\="toggleErledigt\('</span>{ideeId}')"><span class="math-inline">\{erledigt?"‚Ü©Ô∏è"\:"‚úîÔ∏è"\}</button\><button onclick\="loescheIdee\('</span>{ideeId}')">üóëÔ∏è</button><button onclick="zeigeBeschreibungDialog('<span class="math-inline">\{ideeId\}'\)"\>\+ Beschreibung</button\></div\></div\><input type\="checkbox" class\="idee\-checkbox" onchange\="toggleAuswahl\('</span>{ideeId}',this)" ${ausgewaehlt.includes(ideeId)?"checked":""}></div>`;
    }).join("");

    // Das Bearbeitungsformular schlie√üen, wenn die bearbeitete Idee durch Filter unsichtbar wird
    if (bearbeiteId !== null) {
        const ideeInBearbeitungIstNochSichtbar = filteredIdeen.some(idee => idee.id === bearbeiteId);
        if (!ideeInBearbeitungIstNochSichtbar) {
            abbrechenBearbeiten(); // Bricht ab, wenn bearbeitete Idee nicht mehr in gefilterter Liste ist
        }
    }
    // Das Beschreibungs-Dialog schlie√üen, wenn die Idee durch Filter unsichtbar wird
    if (beschreibungFuerId !== null) {
         const ideeFuerBeschreibungIstNochSichtbar = filteredIdeen.some(idee => idee.id === beschreibungFuerId);
         if (!ideeFuerBeschreibungIstNochSichtbar) {
              beschreibungAbbrechen(); // Bricht ab, wenn Idee nicht mehr in gefilterter Liste ist
         }
    }
}

// Ge√§ndert: Kann nun auch zum Bearbeiten verwendet werden (mit optionalem descTimestamp)
function zeigeBeschreibungDialog(ideeId, descTimestamp = null){
    beschreibungFuerId = ideeId; // Speichern der Idee-ID
    beschreibungZuBearbeitenderTimestamp = descTimestamp; // Speichern des Timestamps (null beim Hinzuf√ºgen)

    const beschreibungTextarea = document.getElementById("beschreibungText");
    // const dialogTitel = document.getElementById("beschreibungDialogTitel"); // F√ºge diesen Titel im HTML hinzu, falls gew√ºnscht

    if (descTimestamp !== null) {
         // Bearbeiten einer vorhandenen Beschreibung
         const ideen = JSON.parse(localStorage.getItem("ideen") || "[]");
         const idee = ideen.find(item => item.id === ideeId);
         const beschreibung = idee?.beschreibungen.find(b => b.timestamp === descTimestamp);

         if (beschreibung) {
              beschreibungTextarea.value = beschreibung.text;
              // if (dialogTitel) dialogTitel.textContent = "Beschreibung bearbeiten";
         } else {
              zeigeWarnung("Fehler: Beschreibung zum Bearbeiten nicht gefunden.");
              beschreibungAbbrechen();
              return;
         }
    } else {
         // Hinzuf√ºgen einer neuen Beschreibung
         beschreibungTextarea.value = "";
         // if (dialogTitel) dialogTitel.textContent = "Weitere Beschreibung hinzuf√ºgen";
    }


    document.getElementById("beschreibungDialog").style.display = "block";
    beschreibungTextarea.focus();
    istGespeichert = false;
}

function beschreibungAbbrechen(){
    document.getElementById("beschreibungDialog").style.display = "none";
    beschreibungFuerId = null;
    beschreibungZuBearbeitenderTimestamp = null; // Zur√ºcksetzen
    document.getElementById("beschreibungText").value = "";
}

// Ge√§ndert: Behandelt nun Hinzuf√ºgen und Bearbeiten
function beschreibungSpeichern(){
    const t = document.getElementById("beschreibungText").value.trim();
    if(!t) return;
    let ideen = JSON.parse(localStorage.getItem("ideen") || "[]");

    // Finde die Idee anhand der gespeicherten ID
    const ideeIndex = ideen.findIndex(item => item.id === beschreibungFuerId);

    if (ideeIndex !== -1) {
         if (beschreibungZuBearbeitenderTimestamp !== null) {
              // Bearbeiten einer vorhandenen Beschreibung
              const beschreibungIndex = ideen[ideeIndex].beschreibungen.findIndex(b => b.timestamp === beschreibungZuBearbeitenderTimestamp);
              if (beschreibungIndex !== -1) {
                   ideen[ideeIndex].beschreibungen[beschreibungIndex].text = t; // Text aktualisieren
                   // Timestamp wird hier nicht ge√§ndert, k√∂nnte man aber
              } else {
                   zeigeWarnung("Fehler: Beschreibungseintrag zum Bearbeiten nicht gefunden.");
              }
         } else {
              // Hinzuf√ºgen einer neuen Beschreibung
              // Generiere einen einzigartigen Timestamp f√ºr neue Eintr√§ge (wichtig f√ºr die Bearbeitungs-ID)
              const timestamp = new Date().toISOString() + '_' + Math.random().toString(36).substr(2, 9); // ISO String + Zufallsteil
              if(!ideen[ideeIndex].beschreibungen) ideen[ideeIndex].beschreibungen = [];
              ideen[ideeIndex].beschreibungen.push({ text: t, timestamp: timestamp }); // Verwende den generierten Timestamp
         }

         localStorage.setItem("ideen", JSON.stringify(ideen));
         zeigeIdeen(); // Liste neu rendern
    } else {
         zeigeWarnung("Fehler: Idee f√ºr Beschreibung nicht gefunden (ID: " + beschreibungFuerId + ").");
    }

    beschreibungAbbrechen(); // Dialog schlie√üen und Hilfsvariablen zur√ºcksetzen
    istGespeichert = true;
}

// Neue Funktion zum Aufruf durch den einzelnen Bearbeiten-Button
function bearbeiteEinzelneBeschreibung(ideeId, descTimestamp) {
    // Sicherstellen, dass der Timestamp √ºbergeben wird
    if (descTimestamp) {
        zeigeBeschreibungDialog(ideeId, descTimestamp); // Ruft den Dialog im Bearbeitungsmodus auf
    } else {
        // Dies sollte nicht passieren, da der Button nur bei bestehenden Beschreibungen erscheint
        zeigeWarnung("Interner Fehler: Timestamp f√ºr Bearbeitung fehlt.");
    }
}


// Ge√§ndert: Nimmt Idee-ID entgegen
function toggleErledigt(ideeId){
    let ideen = JSON.parse(localStorage.getItem("ideen")||"[]");
    const ideeIndex = ideen.findIndex(item => item.id === ideeId);

    if (ideeIndex !== -1) {
        ideen[ideeIndex].erledigt = !(ideen[ideeIndex].erledigt || false);
        localStorage.setItem("ideen", JSON.stringify(ideen));
        zeigeIdeen(); // Liste neu rendern (Filter beachten!)
        istGespeichert = false; // Status√§nderung = ungespeichert
    }
}

// Ge√§ndert: Nimmt Idee-ID entgegen
function bearbeiteIdee(ideeId){
    const ideen = JSON.parse(localStorage.getItem("ideen")||"[]");
    const idee = ideen.find(item => item.id === ideeId); // Finde Idee anhand ID

    if (!idee) {
        zeigeWarnung("Fehler: Idee zum Bearbeiten nicht gefunden (ID: " + ideeId + ").");
        return;
    }

    document.getElementById("ideeText").value = idee.text;
    document.getElementById("ideeDetails").value = idee.details || "";
    document.getElementById("kategorie").value = idee.kategorie;
    document.getElementById("mandantennummer").value = idee.mandantennummer || "";
    document.getElementById("firmenname").value = idee.firmenname || "";
    prioritaet = idee.prioritaet; // Setze die globale prioritaet Variable
    setzePrioritaet(idee.prioritaet); // Aktualisiere UI basierend auf der globalen Variable

    bearbeiteId = ideeId; // Speichere die ID der bearbeiteten Idee

    // Dateivorschau beim Bearbeiten anzeigen (URLs f√ºr lokale Dateien neu generieren)
    const dateiVorschauDiv = document.getElementById("dateiVorschau");
    dateiVorschauDiv.innerHTML = ""; // Leeren
     if (idee.dateien) {
         idee.dateien.forEach(file => {
             const fileUrl = file.link || file.data; // Nutze Link oder lokale URL
             if (fileUrl) {
                 dateiVorschauDiv.innerHTML += `<a class="datei-link" href="<span class="math-inline">\{fileUrl\}" target\="\_blank"\></span>{file.link ? 'üåê' : 'üìé'} <span class="math-inline">\{file\.name\}</a\></span>{file.link?'<div class="datei-info">OneDrive-Link</div>':`<div class="datei-info">Pfad: <i>${file.pfad||file.name}</i></div>`}${file.type?.startsWith("image/")?`<img src="${file.link||file.data}" style="max-width:150px;">`:""}${file.type==="application/pdf"?`<iframe src="${file.link||file.data}" style="width:150px;height:100px;"></iframe>`:""}`;
             }
         });
     }

    document.getElementById("speichernBtn").textContent = "üíæ Aktualisieren";
    document.getElementById("abbrechenBtn").style.display = "";
    istGespeichert = false;
}

function abbrechenBearbeiten(){
    bearbeiteId = null; // Bearbeitungs-ID zur√ºcksetzen
    document.getElementById("ideeText").value = "";
    document.getElementById("ideeDetails").value = "";
    document.getElementById("mandantennummer").value = "";
    document.getElementById("firmenname").value = "";
    document.getElementById("dateien").value = ""; // Dateifeld leeren
    document.getElementById("dateiVorschau").innerHTML = ""; // Dateivorschau leeren
    document.getElementById("speichernBtn").textContent = "üíæ Speichern";
    document.getElementById("abbrechenBtn").style.display = "none";
    setzePrioritaet(""); // Priorit√§t zur√ºcksetzen (setzt globale Var und UI)
    istGespeichert = true;
}

// Ge√§ndert: Nimmt Idee-ID entgegen
function verschiebeIdee(ideeId, richtung){
    let fullIdeen = JSON.parse(localStorage.getItem("ideen")||"[]");
    // Finde die aktuell gefilterte und sortierte Liste, um die Position zu bestimmen
    const filterKategorie = document.getElementById("filterKategorie").value;
    const filterMandantValue = document.getElementById("filterMandant").value.trim();
    const filterArchivValue = document.getElementById("filterArchiv").value;
    const sortierung = document.getElementById("sortierung").value;

    let currentViewIdeen = [...fullIdeen]; // Kopie f√ºr Filterung/Sortierung der Ansicht

    if(filterKategorie) currentViewIdeen = currentViewIdeen.filter(i => i.kategorie === filterKategorie);
    if(filterMandantValue) currentViewIdeen = currentViewIdeen.filter(i => (i.mandantennummer||"").toLowerCase() === filterMandantValue.toLowerCase());
     if (filterArchivValue === "nicht_erledigt") {
         currentViewIdeen = currentViewIdeen.filter(i => !(i.erledigt || false));
     } else if (filterArchivValue === "erledigt") {
         currentViewIdeen = currentViewIdeen.filter(i => (i.erledigt || false));
     }
    currentViewIdeen.sort((a,b)=>{
        if(sortierung==="prio"){
            const p={"Hoch":3,"Mittel":2,"Niedrig":1};
            return (p[b.prioritaet]||0) - (p[a.prioritaet]||0);
        }
        if(sortierung==="neu"){
            return new Date(b.timestamp) - new Date(a.timestamp);
        }
        // sortierung === "alt"
        return new Date(a.timestamp) - new Date(b.timestamp); // *** Diese Zeile ist jetzt vollst√§ndig ***
    });

    const ideenListeDiv = document.getElementById("ideenListe");
    ideenListeDiv.innerHTML = filteredIdeen.map(idee => {
        // Verwende die Idee.id f√ºr alle Aktionen und die Auswahl
        const ideeId = idee.id; // Die eindeutige ID der Idee

        const erledigt = idee.erledigt || false;
        const anzeigeDatum = new Date(idee.timestamp).toLocaleString("de-DE");

        // Verwende ideeId f√ºr Action button calls und Checkbox
        return`<div class="idee${erledigt?' erledigt':''}"><div class="idee-content"><h3><span class="math-inline">\{idee\.text\}</h3\><p\></span>{idee.details||""}</p>${idee.mandantennummer?`<div>Mandantennummer: <b>${idee.mandantennummer}</b></div>`:""}${idee.firmenname?`<div>Firmenname: <b>${idee.firmenname}</b></div>`:""}${idee.beschreibungen&&idee.beschreibungen.length?`<div class="beschreibung-historie"><b>Weitere Beschreibungen:</b>${idee.beschreibungen.map(b=>`<div class="beschreibung-item"><div class="beschreibung-text-zeit"><span class="beschreibung-zeit"><span class="math-inline">\{b\.timestamp\}</span\></span>{b.text}</div><button class="edit-beschreibung-btn" onclick="bearbeiteEinzelneBeschreibung('<span class="math-inline">\{ideeId\}', '</span>{b.timestamp}')">‚úèÔ∏è</button></div>`).join("")}</div>`:""}<small>${idee.kategorie} | ${idee.prioritaet||"Keine"} | <span class="math-inline">\{anzeigeDatum\}</small\></span>{idee.dateien?.map(file=>`<a class="datei-link" href="${file.link||file.data}" target="_blank">${file.link?'üåê':'üìé'} ${file.name}</a>${file.link?'<div class="datei-info">OneDrive-Link</div>':`<div class="datei-info">Pfad: <i>${file.pfad||file.name}</i></div>`}${file.type?.startsWith("image/")?`<img src="${file.link||file.data}" style="max-width:150px;">`:""}${file.type==="application/pdf"?`<iframe src="${file.link||file.data}" style="width:150px;height:100px;"></iframe>`:""}`).join("")}<div class="idee-actions"><button onclick="verschiebeIdee('<span class="math-inline">\{ideeId\}',\-1\)"\>‚¨ÜÔ∏è</button\><button onclick\="verschiebeIdee\('</span>{ideeId}',1)">‚¨áÔ∏è</button><button onclick="bearbeiteIdee('<span class="math-inline">\{ideeId\}'\)"\>‚úèÔ∏è</button\><button onclick\="toggleErledigt\('</span>{ideeId}')"><span class="math-inline">\{erledigt?"‚Ü©Ô∏è"\:"‚úîÔ∏è"\}</button\><button onclick\="loescheIdee\('</span>{ideeId}')">üóëÔ∏è</button><button onclick="zeigeBeschreibungDialog('<span class="math-inline">\{ideeId\}'\)"\>\+ Beschreibung</button\></div\></div\><input type\="checkbox" class\="idee\-checkbox" onchange\="toggleAuswahl\('</span>{ideeId}',this)" ${ausgewaehlt.includes(ideeId)?"checked":""}></div>`;
    }).join("");

    // Das Bearbeitungsformular schlie√üen, wenn die bearbeitete Idee durch Filter unsichtbar wird
    if (bearbeiteId !== null) {
        const ideeInBearbeitungIstNochSichtbar = filteredIdeen.some(idee => idee.id === bearbeiteId);
        if (!ideeInBearbeitungIstNochSichtbar) {
            abbrechenBearbeiten(); // Bricht ab, wenn bearbeitete Idee nicht mehr in gefilterter Liste ist
        }
    }
    // Das Beschreibungs-Dialog schlie√üen, wenn die Idee durch Filter unsichtbar wird
    if (beschreibungFuerId !== null) {
         const ideeFuerBeschreibungIstNochSichtbar = filteredIdeen.some(idee => idee.id === beschreibungFuerId);
         if (!ideeFuerBeschreibungIstNochSichtbar) {
              beschreibungAbbrechen(); // Bricht ab, wenn Idee nicht mehr in gefilterter Liste ist
         }
    }
}

// Ge√§ndert: Kann nun auch zum Bearbeiten verwendet werden (mit optionalem descTimestamp)
function zeigeBeschreibungDialog(ideeId, descTimestamp = null){
    beschreibungFuerId = ideeId; // Speichern der Idee-ID
    beschreibungZuBearbeitenderTimestamp = descTimestamp; // Speichern des Timestamps (null beim Hinzuf√ºgen)

    const beschreibungTextarea = document.getElementById("beschreibungText");
    // const dialogTitel = document.getElementById("beschreibungDialogTitel"); // F√ºge diesen Titel im HTML hinzu, falls gew√ºnscht

    if (descTimestamp !== null) {
         // Bearbeiten einer vorhandenen Beschreibung
         const ideen = JSON.parse(localStorage.getItem("ideen") || "[]");
         const idee = ideen.find(item => item.id === ideeId);
         const beschreibung = idee?.beschreibungen.find(b => b.timestamp === descTimestamp);

         if (beschreibung) {
              beschreibungTextarea.value = beschreibung.text;
              // if (dialogTitel) dialogTitel.textContent = "Beschreibung bearbeiten";
         } else {
              zeigeWarnung("Fehler: Beschreibung zum Bearbeiten nicht gefunden.");
              beschreibungAbbrechen();
              return;
         }
    } else {
         // Hinzuf√ºgen einer neuen Beschreibung
         beschreibungTextarea.value = "";
         // if (dialogTitel) dialogTitel.textContent = "Weitere Beschreibung hinzuf√ºgen";
    }


    document.getElementById("beschreibungDialog").style.display = "block";
    beschreibungTextarea.focus();
    istGespeichert = false;
}

function beschreibungAbbrechen(){
    document.getElementById("beschreibungDialog").style.display = "none";
    beschreibungFuerId = null;
    beschreibungZuBearbeitenderTimestamp = null; // Zur√ºcksetzen
    document.getElementById("beschreibungText").value = "";
}

// Ge√§ndert: Behandelt nun Hinzuf√ºgen und Bearbeiten
function beschreibungSpeichern(){
    const t = document.getElementById("beschreibungText").value.trim();
    if(!t) return;
    let ideen = JSON.parse(localStorage.getItem("ideen") || "[]");

    // Finde die Idee anhand der gespeicherten ID
    const ideeIndex = ideen.findIndex(item => item.id === beschreibungFuerId);

    if (ideeIndex !== -1) {
         if (beschreibungZuBearbeitenderTimestamp !== null) {
              // Bearbeiten einer vorhandenen Beschreibung
              const beschreibungIndex = ideen[ideeIndex].beschreibungen.findIndex(b => b.timestamp === beschreibungZuBearbeitenderTimestamp);
              if (beschreibungIndex !== -1) {
                   ideen[ideeIndex].beschreibungen[beschreibungIndex].text = t; // Text aktualisieren
                   // Timestamp wird hier nicht ge√§ndert, k√∂nnte man aber
              } else {
                   zeigeWarnung("Fehler: Beschreibungseintrag zum Bearbeiten nicht gefunden.");
              }
         } else {
              // Hinzuf√ºgen einer neuen Beschreibung
              // Generiere einen einzigartigen Timestamp f√ºr neue Eintr√§ge (wichtig f√ºr die Bearbeitungs-ID)
              const timestamp = new Date().toISOString() + '_' + Math.random().toString(36).substr(2, 9); // ISO String + Zufallsteil
              if(!ideen[ideeIndex].beschreibungen) ideen[ideeIndex].beschreibungen = [];
              ideen[ideeIndex].beschreibungen.push({ text: t, timestamp: timestamp }); // Verwende den generierten Timestamp
         }

         localStorage.setItem("ideen", JSON.stringify(ideen));
         zeigeIdeen(); // Liste neu rendern
    } else {
         zeigeWarnung("Fehler: Idee f√ºr Beschreibung nicht gefunden (ID: " + beschreibungFuerId + ").");
    }

    beschreibungAbbrechen(); // Dialog schlie√üen und Hilfsvariablen zur√ºcksetzen
    istGespeichert = true;
}

// Neue Funktion zum Aufruf durch den einzelnen Bearbeiten-Button
function bearbeiteEinzelneBeschreibung(ideeId, descTimestamp) {
    // Sicherstellen, dass der Timestamp √ºbergeben wird
    if (descTimestamp) {
        zeigeBeschreibungDialog(ideeId, descTimestamp); // Ruft den Dialog im Bearbeitungsmodus auf
    } else {
        // Dies sollte nicht passieren, da der Button nur bei bestehenden Beschreibungen erscheint
        zeigeWarnung("Interner Fehler: Timestamp f√ºr Bearbeitung fehlt.");
    }
}


// Ge√§ndert: Nimmt Idee-ID entgegen
function toggleErledigt(ideeId){
    let ideen = JSON.parse(localStorage.getItem("ideen")||"[]");
    const ideeIndex = ideen.findIndex(item => item.id === ideeId);

    if (ideeIndex !== -1) {
        ideen[ideeIndex].erledigt = !(ideen[ideeIndex].erledigt || false);
        localStorage.setItem("ideen", JSON.stringify(ideen));
        zeigeIdeen(); // Liste neu rendern (Filter beachten!)
        istGespeichert = false; // Status√§nderung = ungespeichert
    }
}

// Ge√§ndert: Nimmt Idee-ID entgegen
function bearbeiteIdee(ideeId){
    const ideen = JSON.parse(localStorage.getItem("ideen")||"[]");
    const idee = ideen.find(item => item.id === ideeId); // Finde Idee anhand ID

    if (!idee) {
        zeigeWarnung("Fehler: Idee zum Bearbeiten nicht gefunden (ID: " + ideeId + ").");
        return;
    }

    document.getElementById("ideeText").value = idee.text;
    document.getElementById("ideeDetails").value = idee.details || "";
    document.getElementById("kategorie").value = idee.kategorie;
    document.getElementById("mandantennummer").value = idee.mandantennummer || "";
    document.getElementById("firmenname").value = idee.firmenname || "";
    prioritaet = idee.prioritaet; // Setze die globale prioritaet Variable
    setzePrioritaet(idee.prioritaet); // Aktualisiere UI basierend auf der globalen Variable

    bearbeiteId = ideeId; // Speichere die ID der bearbeiteten Idee

    // Dateivorschau beim Bearbeiten anzeigen (URLs f√ºr lokale Dateien neu generieren)
    const dateiVorschauDiv = document.getElementById("dateiVorschau");
    dateiVorschauDiv.innerHTML = ""; // Leeren
     if (idee.dateien) {
         idee.dateien.forEach(file => {
             const fileUrl = file.link || file.data; // Nutze Link oder lokale URL
             if (fileUrl) {
                 dateiVorschauDiv.innerHTML += `<a class="datei-link" href="<span class="math-inline">\{fileUrl\}" target\="\_blank"\></span>{file.link ? 'üåê' : 'üìé'} <span class="math-inline">\{file\.name\}</a\></span>{file.link?'<div class="datei-info">OneDrive-Link</div>':`<div class="datei-info">Pfad: <i>${file.pfad||file.name}</i></div>`}${file.type?.startsWith("image/")?`<img src="${file.link||file.data}" style="max-width:150px;">`:""}${file.type==="application/pdf"?`<iframe src="${file.link||file.data}" style="width:150px;height:100px;"></iframe>`:""}`;
             }
         });
     }

    document.getElementById("speichernBtn").textContent = "üíæ Aktualisieren";
    document.getElementById("abbrechenBtn").style.display = "";
    istGespeichert = false;
}

function abbrechenBearbeiten(){
    bearbeiteId = null; // Bearbeitungs-ID zur√ºcksetzen
    document.getElementById("ideeText").value = "";
    document.getElementById("ideeDetails").value = "";
    document.getElementById("mandantennummer").value = "";
    document.getElementById("firmenname").value = "";
    document.getElementById("dateien").value = ""; // Dateifeld leeren
    document.getElementById("dateiVorschau").innerHTML = ""; // Dateivorschau leeren
    document.getElementById("speichernBtn").textContent = "üíæ Speichern";
    document.getElementById("abbrechenBtn").style.display = "none";
    setzePrioritaet(""); // Priorit√§t zur√ºcksetzen (setzt globale Var und UI)
    istGespeichert = true;
}

// Ge√§ndert: Nimmt Idee-ID entgegen
function verschiebeIdee(ideeId, richtung){
    let fullIdeen = JSON.parse(localStorage.getItem("ideen")||"[]");
    // Finde die aktuell gefilterte und sortierte Liste, um die Position zu bestimmen
    const filterKategorie = document.getElementById("filterKategorie").value;
    const filterMandantValue = document.getElementById("filterMandant").value.trim();
    const filterArchivValue = document.getElementById("filterArchiv").value;
    const sortierung = document.getElementById("sortierung").value;

    let currentViewIdeen = [...fullIdeen]; // Kopie f√ºr Filterung/Sortierung der Ansicht

    if(filterKategorie) currentViewIdeen = currentViewIdeen.filter(i => i.kategorie === filterKategorie);
    if(filterMandantValue) currentViewIdeen = currentViewIdeen.filter(i => (i.mandantennummer||"").toLowerCase() === filterMandantValue.toLowerCase());
     if (filterArchivValue === "nicht_erledigt") {
         currentViewIdeen = currentViewIdeen.filter(i => !(i.erledigt || false));
     } else if (filterArchivValue === "erledigt") {
         currentViewIdeen = currentViewIdeen.filter(i => (i.erledigt || false));
     }
    currentViewIdeen.sort((a,b)=>{
        if(sortierung==="prio"){
            const p={"Hoch":3,"Mittel":2,"Niedrig":1};
            return (p[b.prioritaet]||0) - (p[a.prioritaet]||0);
        }
        if(sortierung==="neu"){
            return new Date(b.timestamp) - new Date(a.timestamp);
        }
        // sortierung === "alt"
        return new Date(a.timestamp) - new Date(b.timestamp); // *** Diese Zeile ist jetzt vollst√§ndig ***
    });

    const ideenListeDiv = document.getElementById("ideenListe");
    ideenListeDiv.innerHTML = filteredIdeen.map(idee => {
        // Verwende die Idee.id f√ºr alle Aktionen und die Auswahl
        const ideeId = idee.id; // Die eindeutige ID der Idee

        const erledigt = idee.erledigt || false;
        const anzeigeDatum = new Date(idee.timestamp).toLocaleString("de-DE");

        // Verwende ideeId f√ºr Action button calls und Checkbox
        return`<div class="idee${erledigt?' erledigt':''}"><div class="idee-content"><h3><span class="math-inline">\{idee\.text\}</h3\><p\></span>{idee.details||""}</p>${idee.mandantennummer?`<div>Mandantennummer: <b>${idee.mandantennummer}</b></div>`:""}${idee.firmenname?`<div>Firmenname: <b>${idee.firmenname}</b></div>`:""}${idee.beschreibungen&&idee.beschreibungen.length?`<div class="beschreibung-historie"><b>Weitere Beschreibungen:</b>${idee.beschreibungen.map(b=>`<div class="beschreibung-item"><div class="beschreibung-text-zeit"><span class="beschreibung-zeit"><span class="math-inline">\{b\.timestamp\}</span\></span>{b.text}</div><button class="edit-beschreibung-btn" onclick="bearbeiteEinzelneBeschreibung('<span class="math-inline">\{ideeId\}', '</span>{b.timestamp}')">‚úèÔ∏è</button></div>`).join("")}</div>`:""}<small>${idee.kategorie} | ${idee.prioritaet||"Keine"} | <span class="math-inline">\{anzeigeDatum\}</small\></span>{idee.dateien?.map(file=>`<a class="datei-link" href="${file.link||file.data}" target="_blank">${file.link?'üåê':'üìé'} ${file.name}</a>${file.link?'<div class="datei-info">OneDrive-Link</div>':`<div class="datei-info">Pfad: <i>${file.pfad||file.name}</i></div>`}${file.type?.startsWith("image/")?`<img src="${file.link||file.data}" style="max-width:150px;">`:""}${file.type==="application/pdf"?`<iframe src="${file.link||file.data}" style="width:150px;height:100px;"></iframe>`:""}`).join("")}<div class="idee-actions"><button onclick="verschiebeIdee('<span class="math-inline">\{ideeId\}',\-1\)"\>‚¨ÜÔ∏è</button\><button onclick\="verschiebeIdee\('</span>{ideeId}',1)">‚¨áÔ∏è</button><button onclick="bearbeiteIdee('<span class="math-inline">\{ideeId\}'\)"\>‚úèÔ∏è</button\><button onclick\="toggleErledigt\('</span>{ideeId}')"><span class="math-inline">\{erledigt?"‚Ü©Ô∏è"\:"‚úîÔ∏è"\}</button\><button onclick\="loescheIdee\('</span>{ideeId}')">üóëÔ∏è</button><button onclick="zeigeBeschreibungDialog('<span class="math-inline">\{ideeId\}'\)"\>\+ Beschreibung</button\></div\></div\><input type\="checkbox" class\="idee\-checkbox" onchange\="toggleAuswahl\('</span>{ideeId}',this)" ${ausgewaehlt.includes(ideeId)?"checked":""}></div>`;
    }).join("");

    // Das Bearbeitungsformular schlie√üen, wenn die bearbeitete Idee durch Filter unsichtbar wird
    if (bearbeiteId !== null) {
        const ideeInBearbeitungIstNochSichtbar = filteredIdeen.some(idee => idee.id === bearbeiteId);
        if (!ideeInBearbeitungIstNochSichtbar) {
            abbrechenBearbeiten(); // Bricht ab, wenn bearbeitete Idee nicht mehr in gefilterter Liste ist
        }
    }
    // Das Beschreibungs-Dialog schlie√üen, wenn die Idee durch Filter unsichtbar wird
    if (beschreibungFuerId !== null) {
         const ideeFuerBeschreibungIstNochSichtbar = filteredIdeen.some(idee => idee.id === beschreibungFuerId);
         if (!ideeFuerBeschreibungIstNochSichtbar) {
              beschreibungAbbrechen(); // Bricht ab, wenn Idee nicht mehr in gefilterter Liste ist
         }
    }
}

// Ge√§ndert: Kann nun auch zum Bearbeiten verwendet werden (mit optionalem descTimestamp)
function zeigeBeschreibungDialog(ideeId, descTimestamp = null){
    beschreibungFuerId = ideeId; // Speichern der Idee-ID
    beschreibungZuBearbeitenderTimestamp = descTimestamp; // Speichern des Timestamps (null beim Hinzuf√ºgen)

    const beschreibungTextarea = document.getElementById("beschreibungText");
    // const dialogTitel = document.getElementById("beschreibungDialogTitel"); // F√ºge diesen Titel im HTML hinzu, falls gew√ºnscht

    if (descTimestamp !== null) {
         // Bearbeiten einer vorhandenen Beschreibung
         const ideen = JSON.parse(localStorage.getItem("ideen") || "[]");
         const idee = ideen.find(item => item.id === ideeId);
         const beschreibung = idee?.beschreibungen.find(b => b.timestamp === descTimestamp);

         if (beschreibung) {
              beschreibungTextarea.value = beschreibung.text;
              // if (dialogTitel) dialogTitel.textContent = "Beschreibung bearbeiten";
         } else {
              zeigeWarnung("Fehler: Beschreibung zum Bearbeiten nicht gefunden.");
              beschreibungAbbrechen();
              return;
         }
    } else {
         // Hinzuf√ºgen einer neuen Beschreibung
         beschreibungTextarea.value = "";
         // if (dialogTitel) dialogTitel.textContent = "Weitere Beschreibung hinzuf√ºgen";
    }


    document.getElementById("beschreibungDialog").style.display = "block";
    beschreibungTextarea.focus();
    istGespeichert = false;
}

function beschreibungAbbrechen(){
    document.getElementById("beschreibungDialog").style.display = "none";
    beschreibungFuerId = null;
    beschreibungZuBearbeitenderTimestamp = null; // Zur√ºcksetzen
    document.getElementById("beschreibungText").value = "";
}

// Ge√§ndert: Behandelt nun Hinzuf√ºgen und Bearbeiten
function beschreibungSpeichern(){
    const t = document.getElementById("beschreibungText").value.trim();
    if(!t) return;
    let ideen = JSON.parse(localStorage.getItem("ideen") || "[]");

    // Finde die Idee anhand der gespeicherten ID
    const ideeIndex = ideen.findIndex(item => item.id === beschreibungFuerId);

    if (ideeIndex !== -1) {
         if (beschreibungZuBearbeitenderTimestamp !== null) {
              // Bearbeiten einer vorhandenen Beschreibung
              const beschreibungIndex = ideen[ideeIndex].beschreibungen.findIndex(b => b.timestamp === beschreibungZuBearbeitenderTimestamp);
              if (beschreibungIndex !== -1) {
                   ideen[ideeIndex].beschreibungen[beschreibungIndex].text = t; // Text aktualisieren
                   // Timestamp wird hier nicht ge√§ndert, k√∂nnte man aber
              } else {
                   zeigeWarnung("Fehler: Beschreibungseintrag zum Bearbeiten nicht gefunden.");
              }
         } else {
              // Hinzuf√ºgen einer neuen Beschreibung
              // Generiere einen einzigartigen Timestamp f√ºr neue Eintr√§ge (wichtig f√ºr die Bearbeitungs-ID)
              const timestamp = new Date().toISOString() + '_' + Math.random().toString(36).substr(2, 9); // ISO String + Zufallsteil
              if(!ideen[ideeIndex].beschreibungen) ideen[ideeIndex].beschreibungen = [];
              ideen[ideeIndex].beschreibungen.push({ text: t, timestamp: timestamp }); // Verwende den generierten Timestamp
         }

         localStorage.setItem("ideen", JSON.stringify(ideen));
         zeigeIdeen(); // Liste neu rendern
    } else {
         zeigeWarnung("Fehler: Idee f√ºr Beschreibung nicht gefunden (ID: " + beschreibungFuerId + ").");
    }

    beschreibungAbbrechen(); // Dialog schlie√üen und Hilfsvariablen zur√ºcksetzen
    istGespeichert = true;
}

// Neue Funktion zum Aufruf durch den einzelnen Bearbeiten-Button
function bearbeiteEinzelneBeschreibung(ideeId, descTimestamp) {
    // Sicherstellen, dass der Timestamp √ºbergeben wird
    if (descTimestamp) {
        zeigeBeschreibungDialog(ideeId, descTimestamp); // Ruft den Dialog im Bearbeitungsmodus auf
    } else {
        // Dies sollte nicht passieren, da der Button nur bei bestehenden Beschreibungen erscheint
        zeigeWarnung("Interner Fehler: Timestamp f√ºr Bearbeitung fehlt.");
    }
}


// Ge√§ndert: Nimmt Idee-ID entgegen
function toggleErledigt(ideeId){
    let ideen = JSON.parse(localStorage.getItem("ideen")||"[]");
    const ideeIndex = ideen.findIndex(item => item.id === ideeId);

    if (ideeIndex !== -1) {
        ideen[ideeIndex].erledigt = !(ideen[ideeIndex].erledigt || false);
        localStorage.setItem("ideen", JSON.stringify(ideen));
        zeigeIdeen(); // Liste neu rendern (Filter beachten!)
        istGespeichert = false; // Status√§nderung = ungespeichert
    }
}

// Ge√§ndert: Nimmt Idee-ID entgegen
function bearbeiteIdee(ideeId){
    const ideen = JSON.parse(localStorage.getItem("ideen")||"[]");
    const idee = ideen.find(item => item.id === ideeId); // Finde Idee anhand ID

    if (!idee) {
        zeigeWarnung("Fehler: Idee zum Bearbeiten nicht gefunden (ID: " + ideeId + ").");
        return;
    }

    document.getElementById("ideeText").value = idee.text;
    document.getElementById("ideeDetails").value = idee.details || "";
    document.getElementById("kategorie").value = idee.kategorie;
    document.getElementById("mandantennummer").value = idee.mandantennummer || "";
    document.getElementById("firmenname").value = idee.firmenname || "";
    prioritaet = idee.prioritaet; // Setze die globale prioritaet Variable
    setzePrioritaet(idee.prioritaet); // Aktualisiere UI basierend auf der globalen Variable

    bearbeiteId = ideeId; // Speichere die ID der bearbeiteten Idee

    // Dateivorschau beim Bearbeiten anzeigen (URLs f√ºr lokale Dateien neu generieren)
    const dateiVorschauDiv = document.getElementById("dateiVorschau");
    dateiVorschauDiv.innerHTML = ""; // Leeren
     if (idee.dateien) {
         idee.dateien.forEach(file => {
             const fileUrl = file.link || file.data; // Nutze Link oder lokale URL
             if (fileUrl) {
                 dateiVorschauDiv.innerHTML += `<a class="datei-link" href="<span class="math-inline">\{fileUrl\}" target\="\_blank"\></span>{file.link ? 'üåê' : 'üìé'} <span class="math-inline">\{file\.name\}</a\></span>{file.link?'<div class="datei-info">OneDrive-Link</div>':`<div class="datei-info">Pfad: <i>${file.pfad||file.name}</i></div>`}${file.type?.startsWith("image/")?`<img src="${file.link||file.data}" style="max-width:150px;">`:""}${file.type==="application/pdf"?`<iframe src="${file.link||file.data}" style="width:150px;height:100px;"></iframe>`:""}`;
             }
         });
     }

    document.getElementById("speichernBtn").textContent = "üíæ Aktualisieren";
    document.getElementById("abbrechenBtn").style.display = "";
    istGespeichert = false;
}

function abbrechenBearbeiten(){
    bearbeiteId = null; // Bearbeitungs-ID zur√ºcksetzen
    document.getElementById("ideeText").value = "";
    document.getElementById("ideeDetails").value = "";
    document.getElementById("mandantennummer").value = "";
    document.getElementById("firmenname").value = "";
    document.getElementById("dateien").value = ""; // Dateifeld leeren
    document.getElementById("dateiVorschau").innerHTML = ""; // Dateivorschau leeren
    document.getElementById("speichernBtn").textContent = "üíæ Speichern";
    document.getElementById("abbrechenBtn").style.display = "none";
    setzePrioritaet(""); // Priorit√§t zur√ºcksetzen (setzt globale Var und UI)
    istGespeichert = true;
}

// Ge√§ndert: Nimmt Idee-ID entgegen
function verschiebeIdee(ideeId, richtung){
    let fullIdeen = JSON.parse(localStorage.getItem("ideen")||"[]");
    // Finde die aktuell gefilterte und sortierte Liste, um die Position zu bestimmen
    const filterKategorie = document.getElementById("filterKategorie").value;
    const filterMandantValue = document.getElementById("filterMandant").value.trim();
    const filterArchivValue = document.getElementById("filterArchiv").value;
    const sortierung = document.getElementById("sortierung").value;

    let currentViewIdeen = [...fullIdeen]; // Kopie f√ºr Filterung/Sortierung der Ansicht

    if(filterKategorie) currentViewIdeen = currentViewIdeen.filter(i => i.kategorie === filterKategorie);
    if(filterMandantValue) currentViewIdeen = currentViewIdeen.filter(i => (i.mandantennummer||"").toLowerCase() === filterMandantValue.toLowerCase());
     if (filterArchivValue === "nicht_erledigt") {
         currentViewIdeen = currentViewIdeen.filter(i => !(i.erledigt || false));
     } else if (filterArchivValue === "erledigt") {
         currentViewIdeen = currentViewIdeen.filter(i => (i.erledigt || false));
     }
    currentViewIdeen.sort((a,b)=>{
        if(sortierung==="prio"){
            const p={"Hoch":3,"Mittel":2,"Niedrig":1};
            return (p[b.prioritaet]||0) - (p[a.prioritaet]||0);
        }
        if(sortierung==="neu"){
            return new Date(b.timestamp) - new Date(a.timestamp);
        }
        // sortierung === "alt"
        return new Date(a.timestamp) - new Date(b.timestamp); // *** Diese Zeile ist jetzt vollst√§ndig ***
    });

    const ideenListeDiv = document.getElementById("ideenListe");
    ideenListeDiv.innerHTML = filteredIdeen.map(idee => {
        // Verwende die Idee.id f√ºr alle Aktionen und die Auswahl
        const ideeId = idee.id; // Die eindeutige ID der Idee

        const erledigt = idee.erledigt || false;
        const anzeigeDatum = new Date(idee.timestamp).toLocaleString("de-DE");

        // Verwende ideeId f√ºr Action button calls und Checkbox
        return`<div class="idee${erledigt?' erledigt':''}"><div class="idee-content"><h3><span class="math-inline">\{idee\.text\}</h3\><p\></span>{idee.details||""}</p>${idee.mandantennummer?`<div>Mandantennummer: <b>${idee.mandantennummer}</b></div>`:""}${idee.firmenname?`<div>Firmenname: <b>${idee.firmenname}</b></div>`:""}${idee.beschreibungen&&idee.beschreibungen.length?`<div class="beschreibung-historie"><b>Weitere Beschreibungen:</b>${idee.beschreibungen.map(b=>`<div class="beschreibung-item"><div class="beschreibung-text-zeit"><span class="beschreibung-zeit"><span class="math-inline">\{b\.timestamp\}</span\></span>{b.text}</div><button class="edit-beschreibung-btn" onclick="bearbeiteEinzelneBeschreibung('<span class="math-inline">\{ideeId\}', '</span>{b.timestamp}')">‚úèÔ∏è</button></div>`).join("")}</div>`:""}<small>${idee.kategorie} | ${idee.prioritaet||"Keine"} | <span class="math-inline">\{anzeigeDatum\}</small\></span>{idee.dateien?.map(file=>`<a class="datei-link" href="${file.link||file.data}" target="_blank">${file.link?'üåê':'üìé'} ${file.name}</a>${file.link?'<div class="datei-info">OneDrive-Link</div>':`<div class="datei-info">Pfad: <i>${file.pfad||file.name}</i></div>`}${file.type?.startsWith("image/")?`<img src="${file.link||file.data}" style="max-width:150px;">`:""}${file.type==="application/pdf"?`<iframe src="${file.link||file.data}" style="width:150px;height:100px;"></iframe>`:""}`).join("")}<div class="idee-actions"><button onclick="verschiebeIdee('<span class="math-inline">\{ideeId\}',\-1\)"\>‚¨ÜÔ∏è</button\><button onclick\="verschiebeIdee\('</span>{ideeId}',1)">‚¨áÔ∏è</button><button onclick="bearbeiteIdee('<span class="math-inline">\{ideeId\}'\)"\>‚úèÔ∏è</button\><button onclick\="toggleErledigt\('</span>{ideeId}')"><span class="math-inline">\{erledigt?"‚Ü©Ô∏è"\:"‚úîÔ∏è"\}</button\><button onclick\="loescheIdee\('</span>{ideeId}')">üóëÔ∏è</button><button onclick="zeigeBeschreibungDialog('<span class="math-inline">\{ideeId\}'\)"\>\+ Beschreibung</button\></div\></div\><input type\="checkbox" class\="idee\-checkbox" onchange\="toggleAuswahl\('</span>{ideeId}',this)" ${ausgewaehlt.includes(ideeId)?"checked":""}></div>`;
    }).join("");

    // Das Bearbeitungsformular schlie√üen, wenn die bearbeitete Idee durch Filter unsichtbar wird
    if (bearbeiteId !== null) {
        const ideeInBearbeitungIstNochSichtbar = filteredIdeen.some(idee => idee.id === bearbeiteId);
        if (!ideeInBearbeitungIstNochSichtbar) {
            abbrechenBearbeiten(); // Bricht ab, wenn bearbeitete Idee nicht mehr in gefilterter Liste ist
        }
    }
    // Das Beschreibungs-Dialog schlie√üen, wenn die Idee durch Filter unsichtbar wird
    if (beschreibungFuerId !== null) {
         const ideeFuerBeschreibungIstNochSichtbar = filteredIdeen.some(idee => idee.id === beschreibungFuerId);
         if (!ideeFuerBeschreibungIstNochSichtbar) {
              beschreibungAbbrechen(); // Bricht ab, wenn Idee nicht mehr in gefilterter Liste ist
         }
    }
}

// Ge√§ndert: Kann nun auch zum Bearbeiten verwendet werden (mit optionalem descTimestamp)
function zeigeBeschreibungDialog(ideeId, descTimestamp = null){
    beschreibungFuerId = ideeId; // Speichern der Idee-ID
    beschreibungZuBearbeitenderTimestamp = descTimestamp; // Speichern des Timestamps (null beim Hinzuf√ºgen)

    const beschreibungTextarea = document.getElementById("beschreibungText");
    // const dialogTitel = document.getElementById("beschreibungDialogTitel"); // F√ºge diesen Titel im HTML hinzu, falls gew√ºnscht

    if (descTimestamp !== null) {
         // Bearbeiten einer vorhandenen Beschreibung
         const ideen = JSON.parse(localStorage.getItem("ideen") || "[]");
         const idee = ideen.find(item => item.id === ideeId);
         const beschreibung = idee?.beschreibungen.find(b => b.timestamp === descTimestamp);

         if (beschreibung) {
              beschreibungTextarea.value = beschreibung.text;
              // if (dialogTitel) dialogTitel.textContent = "Beschreibung bearbeiten";
         } else {
              zeigeWarnung("Fehler: Beschreibung zum Bearbeiten nicht gefunden.");
              beschreibungAbbrechen();
              return;
         }
    } else {
         // Hinzuf√ºgen einer neuen Beschreibung
         beschreibungTextarea.value = "";
         // if (dialogTitel) dialogTitel.textContent = "Weitere Beschreibung hinzuf√ºgen";
    }


    document.getElementById("beschreibungDialog").style.display = "block";
    beschreibungTextarea.focus();
    istGespeichert = false;
}

function beschreibungAbbrechen(){
    document.getElementById("beschreibungDialog").style.display = "none";
    beschreibungFuerId = null;
    beschreibungZuBearbeitenderTimestamp = null; // Zur√ºcksetzen
    document.getElementById("beschreibungText").value = "";
}

// Ge√§ndert: Behandelt nun Hinzuf√ºgen und Bearbeiten
function beschreibungSpeichern(){
    const t = document.getElementById("beschreibungText").value.trim();
    if(!t) return;
    let ideen = JSON.parse(localStorage.getItem("ideen") || "[]");

    // Finde die Idee anhand der gespeicherten ID
    const ideeIndex = ideen.findIndex(item => item.id === beschreibungFuerId);

    if (ideeIndex !== -1) {
         if (beschreibungZuBearbeitenderTimestamp !== null) {
              // Bearbeiten einer vorhandenen Beschreibung
              const beschreibungIndex = ideen[ideeIndex].beschreibungen.findIndex(b => b.timestamp === beschreibungZuBearbeitenderTimestamp);
              if (beschreibungIndex !== -1) {
                   ideen[ideeIndex].beschreibungen[beschreibungIndex].text = t; // Text aktualisieren
                   // Timestamp wird hier nicht ge√§ndert, k√∂nnte man aber
              } else {
                   zeigeWarnung("Fehler: Beschreibungseintrag zum Bearbeiten nicht gefunden.");
              }
         } else {
              // Hinzuf√ºgen einer neuen Beschreibung
              // Generiere einen einzigartigen Timestamp f√ºr neue Eintr√§ge (wichtig f√ºr die Bearbeitungs-ID)
              const timestamp = new Date().toISOString() + '_' + Math.random().toString(36).substr(2, 9); // ISO String + Zufallsteil
              if(!ideen[ideeIndex].beschreibungen) ideen[ideeIndex].beschreibungen = [];
              ideen[ideeIndex].beschreibungen.push({ text: t, timestamp: timestamp }); // Verwende den generierten Timestamp
         }

         localStorage.setItem("ideen", JSON.stringify(ideen));
         zeigeIdeen(); // Liste neu rendern
    } else {
         zeigeWarnung("Fehler: Idee f√ºr Beschreibung nicht gefunden (ID: " + beschreibungFuerId + ").");
    }

    beschreibungAbbrechen(); // Dialog schlie√üen und Hilfsvariablen zur√ºcksetzen
    istGespeichert = true;
}

// Neue Funktion zum Aufruf durch den einzelnen Bearbeiten-Button
function bearbeiteEinzelneBeschreibung(ideeId, descTimestamp) {
    // Sicherstellen, dass der Timestamp √ºbergeben wird
    if (descTimestamp) {
        zeigeBeschreibungDialog(ideeId, descTimestamp); // Ruft den Dialog im Bearbeitungsmodus auf
    } else {
        // Dies sollte nicht passieren, da der Button nur bei bestehenden Beschreibungen erscheint
        zeigeWarnung("Interner Fehler: Timestamp f√ºr Bearbeitung fehlt.");
    }
}


// Ge√§ndert: Nimmt Idee-ID entgegen
function toggleErledigt(ideeId){
    let ideen = JSON.parse(localStorage.getItem("ideen")||"[]");
    const ideeIndex = ideen.findIndex(item => item.id === ideeId);

    if (ideeIndex !== -1) {
        ideen[ideeIndex].erledigt = !(ideen[ideeIndex].erledigt || false);
        localStorage.setItem("ideen", JSON.stringify(ideen));
        zeigeIdeen(); // Liste neu rendern (Filter beachten!)
        istGespeichert = false; // Status√§nderung = ungespeichert
    }
}

// Ge√§ndert: Nimmt Idee-ID entgegen
function bearbeiteIdee(ideeId){
    const ideen = JSON.parse(localStorage.getItem("ideen")||"[]");
    const idee = ideen.find(item => item.id === ideeId); // Finde Idee anhand ID

    if (!idee) {
        zeigeWarnung("Fehler: Idee zum Bearbeiten nicht gefunden (ID: " + ideeId + ").");
        return;
    }

    document.getElementById("ideeText").value = idee.text;
    document.getElementById("ideeDetails").value = idee.details || "";
    document.getElementById("kategorie").value = idee.kategorie;
    document.getElementById("mandantennummer").value = idee.mandantennummer || "";
    document.getElementById("firmenname").value = idee.firmenname || "";
    prioritaet = idee.prioritaet; // Setze die globale prioritaet Variable
    setzePrioritaet(idee.prioritaet); // Aktualisiere UI basierend auf der globalen Variable

    bearbeiteId = ideeId; // Speichere die ID der bearbeiteten Idee

    // Dateivorschau beim Bearbeiten anzeigen (URLs f√ºr lokale Dateien neu generieren)
    const dateiVorschauDiv = document.getElementById("dateiVorschau");
    dateiVorschauDiv.innerHTML = ""; // Leeren
     if (idee.dateien) {
         idee.dateien.forEach(file => {
             const fileUrl = file.link || file.data; // Nutze Link oder lokale URL
             if (fileUrl) {
                 dateiVorschauDiv.innerHTML += `<a class="datei-link" href="<span class="math-inline">\{fileUrl\}" target\="\_blank"\></span>{file.link ? 'üåê' : 'üìé'} <span class="math-inline">\{file\.name\}</a\></span>{file.link?'<div class="datei-info">OneDrive-Link</div>':`<div class="datei-info">Pfad: <i>${file.pfad||file.name}</i></div>`}${file.type?.startsWith("image/")?`<img src="${file.link||file.data}" style="max-width:150px;">`:""}${file.type==="application/pdf"?`<iframe src="${file.link||file.data}" style="width:150px;height:100px;"></iframe>`:""}`;
             }
         });
     }

    document.getElementById("speichernBtn").textContent = "üíæ Aktualisieren";
    document.getElementById("abbrechenBtn").style.display = "";
    istGespeichert = false;
}

function abbrechenBearbeiten(){
    bearbeiteId = null; // Bearbeitungs-ID zur√ºcksetzen
    document.getElementById("ideeText").value = "";
    document.getElementById("ideeDetails").value = "";
    document.getElementById("mandantennummer").value = "";
    document.getElementById("firmenname").value = "";
    document.getElementById("dateien").value = ""; // Dateifeld leeren
    document.getElementById("dateiVorschau").innerHTML = ""; // Dateivorschau leeren
    document.getElementById("speichernBtn").textContent = "üíæ Speichern";
    document.getElementById("abbrechenBtn").style.display = "none";
    setzePrioritaet(""); // Priorit√§t zur√ºcksetzen (setzt globale Var und UI)
    istGespeichert = true;
}

// Ge√§ndert: Nimmt Idee-ID entgegen
function verschiebeIdee(ideeId, richtung){
    let fullIdeen = JSON.parse(localStorage.getItem("ideen")||"[]");
    // Finde die aktuell gefilterte und sortierte Liste, um die Position zu bestimmen
    const filterKategorie = document.getElementById("filterKategorie").value;
    const filterMandantValue = document.getElementById("filterMandant").value.trim();
    const filterArchivValue = document.getElementById("filterArchiv").value;
    const sortierung = document.getElementById("sortierung").value;

    let currentViewIdeen = [...fullIdeen]; // Kopie f√ºr Filterung/Sortierung der Ansicht

    if(filterKategorie) currentViewIdeen = currentViewIdeen.filter(i => i.kategorie === filterKategorie);
    if(filterMandantValue) currentViewIdeen = currentViewIdeen.filter(i => (i.mandantennummer||"").toLowerCase() === filterMandantValue.toLowerCase());
     if (filterArchivValue === "nicht_erledigt") {
         currentViewIdeen = currentViewIdeen.filter(i => !(i.erledigt || false));
     } else if (filterArchivValue === "erledigt") {
         currentViewIdeen = currentViewIdeen.filter(i => (i.erledigt || false));
     }
    currentViewIdeen.sort((a,b)=>{
        if(sortierung==="prio"){
            const p={"Hoch":3,"Mittel":2,"Niedrig":1};
            return (p[b.prioritaet]||0) - (p[a.prioritaet]||0);
        }
        if(sortierung==="neu"){
            return new Date(b.timestamp) - new Date(a.timestamp);
        }
        // sortierung === "alt"
        return new Date(a.timestamp) - new Date(b.timestamp); // *** Diese Zeile ist jetzt vollst√§ndig ***
    });

    const ideenListeDiv = document.getElementById("ideenListe");
    ideenListeDiv.innerHTML = filteredIdeen.map(idee => {
        // Verwende die Idee.id f√ºr alle Aktionen und die Auswahl
        const ideeId = idee.id; // Die eindeutige ID der Idee

        const erledigt = idee.erledigt || false;
        const anzeigeDatum = new Date(idee.timestamp).toLocaleString("de-DE");

        // Verwende ideeId f√ºr Action button calls und Checkbox
        return`<div class="idee${