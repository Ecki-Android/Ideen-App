<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Ideen-App Pro</title>
<style>
html,body{box-sizing:border-box;margin:0;padding:0;background:#f4f4f4;width:100vw;max-width:100vw;overflow-x:hidden;}
body{font-family:Arial,sans-serif;margin:0 0 20px 0;}
input,select,textarea{margin-top:10px;padding:10px;font-size:1em;width:400px;max-width:100vw;box-sizing:border-box;display:block;}
textarea{min-height:60px;}
button{padding:10px 18px;font-size:1em;margin-top:10px;margin-right:8px;border-radius:4px;border:1px solid #bbb;background:#eee;cursor:pointer;width:auto;min-width:44px;display:inline-block;}
.buttons,.top-actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;}
.filter-bar{margin:20px 0;}
.filter-bar select,.filter-bar input{width:auto;display:inline-block;}
.idee{width:100%;max-width:100vw;box-sizing:border-box;overflow-wrap:break-word;word-break:break-word;background:white;padding:15px;margin:10px 0;border-radius:8px;box-shadow:0 0 5px #ccc;display:flex;align-items:flex-start;justify-content:space-between;}
.idee.erledigt{background:#f0f0f0;}
.idee-content{flex:1;max-width:100%;overflow-wrap:break-word;word-break:break-word;font-size:1em;line-height:1.5;}
.idee-content h3,.idee-content p,.idee-content small{max-width:100%;overflow-wrap:break-word;word-break:break-word;font-size:1em;}
.idee.erledigt .idee-content h3,.idee.erledigt .idee-content p,.idee.erledigt .idee-content small{text-decoration:line-through;color:#888;}
.beschreibung-historie{margin:8px 0 12px 0;}
.beschreibung-item{margin:4px 0 4px 0;padding:6px 8px;background:#f8f8f8;border-left:3px solid #bbb;font-size:0.98em;}
.beschreibung-zeit{color:#666;font-size:0.9em;margin-bottom:2px;display:block;}
.beschreibung-eingabe{margin:10px 0;background:#f9f9f9;border-left:3px solid #bbb;padding:8px;}
.idee-checkbox{margin-left:10px;margin-top:5px;min-width:28px;min-height:28px;}
.idee-actions{margin-top:10px;display:flex;gap:5px;flex-wrap:wrap;}
.idee-actions button{width:auto;min-width:44px;padding:6px 10px;font-size:0.95em;}
.prio-btn{background:#eee;border:1px solid #ccc;border-radius:4px;}
.prio-btn.selected{background:#ffd700;border-color:#ff9800;color:#222;}
.warnung{color:#d32f2f;margin:10px 0;font-weight:bold;}
.datei-link{color:#1a0dab;text-decoration:underline;cursor:pointer;font-weight:bold;display:inline-block;margin-bottom:8px;max-width:100%;overflow-wrap:break-word;word-break:break-word;}
.datei-info{font-size:0.96em;color:#333;margin-bottom:8px;max-width:100%;overflow-wrap:break-word;word-break:break-word;}
.datei-vorschau{margin:10px 0;}
.datei-vorschau a{display:block;margin:3px 0;}
.filter-option-alle{color:#666;font-style:italic;}
.katHinweis{color:#c00;font-size:0.95em;margin-left:10px;}
.katLoeschBtn{background:#eee;border:1px solid #c00;color:#c00;}
#preview img{max-width:300px;max-height:200px;display:block;margin-top:8px;border:1px solid #888;}
#preview iframe{width:300px;height:200px;border:1px solid #888;margin-top:8px;display:block;}
@media (max-width:600px){
input,select,textarea,button{width:100vw;min-width:0;max-width:100vw;}
.buttons,.top-actions{flex-direction:column;gap:0;}
.idee{flex-direction:column;}
.idee-checkbox{margin-left:0;margin-top:10px;}
.idee-content,.idee-actions,.datei-link,.datei-info,.datei-vorschau,.idee-checkbox{max-width:100vw;}
}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://alcdn.msauth.net/browser/2.24.0/js/msal-browser.min.js"></script>
</head>
<body>
<h1>Ideen-App</h1>
<div id="loginHinweis" class="warnung" style="display:none;">Anmeldung erforderlich: Bitte melden Sie sich zuerst mit Ihrem Microsoft-Konto an. Ohne Anmeldung sind keine Cloud-Links und keine Synchronisation m√∂glich.</div>
<div id="warnung" class="warnung" style="display:none;"></div>
<input type="text" id="ideeText" placeholder="Titel*" />
<textarea id="ideeDetails" placeholder="Beschreibung" rows="3"></textarea>
<input type="text" id="mandantennummer" placeholder="Mandantennummer (optional)" />
<input type="text" id="firmenname" placeholder="Firmenname (optional)" />
<select id="kategorie"></select>
<input type="text" id="neueKategorie" placeholder="Neue Kategorie" />
<button onclick="neueKategorieHinzufuegen()">+ Kategorie</button>
<button class="katLoeschBtn" onclick="kategorieLoeschen()">Kategorie l√∂schen</button>
<span id="katHinweis" class="katHinweis" style="display:none;"></span>
<div class="buttons">
<button id="prioHoch" class="prio-btn" onclick="setzePrioritaet('Hoch')">üî¥ Hoch</button>
<button id="prioMittel" class="prio-btn" onclick="setzePrioritaet('Mittel')">üü† Mittel</button>
<button id="prioNiedrig" class="prio-btn" onclick="setzePrioritaet('Niedrig')">üü¢ Niedrig</button>
</div>
<input type="file" id="dateien" multiple />
<div class="datei-vorschau" id="dateiVorschau"></div>
<div id="preview"></div>
<button id="speichernBtn" onclick="speichereIdee()">üíæ Speichern</button>
<button id="abbrechenBtn" onclick="abbrechenBearbeiten()" style="display:none;">Abbrechen</button>
<div class="filter-bar">
<label>Filter:</label>
<select id="filterKategorie" onchange="zeigeIdeen()">
<option value="" class="filter-option-alle">üéØ Alle Ideen</option>
</select>
<label>Sortierung:</label>
<select id="sortierung" onchange="zeigeIdeen()">
<option value="neu">Neueste zuerst</option>
<option value="alt">√Ñlteste zuerst</option>
<option value="prio">Nach Priorit√§t</option>
</select>
<input type="text" id="filterMandant" placeholder="Mandantennummer filtern" style="width:170px;display:inline-block;"/>
<button onclick="filterNachMandant()">Nach Mandant filtern</button>
<button onclick="filterMandantZuruecksetzen()">Mandantenfilter zur√ºcksetzen</button>
</div>
<div class="top-actions">
<button onclick="exportiereAlsPDF()">üìù PDF</button>
<button onclick="exportiereAlsText()">üìÑ Text</button>
<button onclick="teilePerEmail()">‚úâÔ∏è E-Mail</button>
<button onclick="teilePerWhatsApp()">üì± WhatsApp</button>
<button onclick="alleIdeenLoeschen()" style="background:#eee;border:1px solid #c00;color:#c00;">Alle Ideen l√∂schen</button>
<button onclick="ausgewaehlteNotizenLoeschen()" style="background:#eee;border:1px solid #c00;color:#c00;">Ausgew√§hlte l√∂schen</button>
<button id="speicherDateiBtn" onclick="speichereIdeenAlsDatei()">Datei speichern</button>
<button id="oeffneDateiBtn" onclick="ladeIdeenAusDatei()">Datei √∂ffnen</button>
<button onclick="handleLogin()" style="background:#e6f4ff;border-color:#0067b8;color:#0067b8;">üîë Mit Microsoft anmelden</button>
<button onclick="handleLogout()" style="background:#ffe0e0;border-color:#c00;color:#c00;">üîí Abmelden</button>
</div>
<div id="ideenListe"></div>
<div id="beschreibungDialog" style="display:none;" class="beschreibung-eingabe">
<textarea id="beschreibungText" placeholder="Weitere Beschreibung" rows="2"></textarea>
<button onclick="beschreibungSpeichern()">üíæ Speichern</button>
<button onclick="beschreibungAbbrechen()">‚ùå Abbrechen</button>
</div>
<script>
// MSAL-Konfiguration und globale Variablen
const msalConfig = {
  auth: {
    clientId: "ddf69193-7eab-4847-a995-b6c08f0df9ae",
    authority: "https://login.microsoftonline.com/683748a6-faf7-45ef-9da3-10e903da0b00",
    knownAuthorities: ["login.microsoftonline.com"],
    redirectUri: "https://ecki-android.github.io"
  }
};
let accessToken = null;
let msalInstance = null;
let prioritaet = "";
let bearbeiteIndex = null;
let ausgewaehlt = [];
let fileHandle = null;
let beschreibungFuerIndex = null;
let istGespeichert = true;
let filterMandantValue = "";
const standardKategorien = ["Aufgaben", "Projekte", "Privat", "Arbeit", "Sp√§ter"];

// Login-Funktionen
async function handleLogin() {
  try {
    msalInstance = new msal.PublicClientApplication(msalConfig);
    const loginResponse = await msalInstance.loginPopup({
      scopes: ["Files.ReadWrite", "offline_access"]
    });
    const tokenResponse = await msalInstance.acquireTokenSilent({
      scopes: ["Files.ReadWrite"],
      account: loginResponse.account
    });
    accessToken = tokenResponse.accessToken;
    zeigeWarnung("Erfolgreich bei Microsoft angemeldet!");
    pruefeLoginHinweis();
  } catch (err) {
    zeigeWarnung("Login fehlgeschlagen: " + err.message);
  }
}

async function handleLogout() {
  if (!istGespeichert) {
    if (!confirm("Bitte speichern Sie Ihre √Ñnderungen, bevor Sie sich abmelden! Trotzdem abmelden?")) return;
  }
  try {
    if (msalInstance) {
      const currentAccount = msalInstance.getAllAccounts()[0];
      if (currentAccount) {
        await msalInstance.logoutPopup({
          account: currentAccount,
          postLogoutRedirectUri: "https://ecki-android.github.io"
        });
      }
    }
    accessToken = null;
    pruefeLoginHinweis();
    zeigeWarnung("Sie wurden erfolgreich abgemeldet.");
  } catch (err) {
    zeigeWarnung("Abmeldung fehlgeschlagen: " + err.message);
  }
}

// OneDrive-Upload
async function uploadToOneDrive(file) {
  if (!accessToken) {
    zeigeWarnung("Bitte zuerst mit Microsoft anmelden!");
    return null;
  }
  try {
    const fileName = `ideenapp/${Date.now()}_${file.name}`;
    const uploadResponse = await fetch(
      `https://graph.microsoft.com/v1.0/me/drive/root:/${fileName}:/content`,
      {
        method: "PUT",
        headers: {
          "Authorization": `Bearer ${accessToken}`,
          "Content-Type": file.type
        },
        body: file
      }
    );
    const data = await uploadResponse.json();
    const shareResponse = await fetch(
      `https://graph.microsoft.com/v1.0/me/drive/items/${data.id}/createLink`,
      {
        method: "POST",
        headers: {
          "Authorization": `Bearer ${accessToken}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ type: "view", scope: "anonymous" })
      }
    );
    const shareData = await shareResponse.json();
    return shareData.link.webUrl;
  } catch (err) {
    zeigeWarnung("OneDrive-Fehler: " + err.message);
    return null;
  }
}

// Hilfsfunktionen
function pruefeLoginHinweis() {
  if (!accessToken) {
    document.getElementById("loginHinweis").style.display = "block";
  } else {
    document.getElementById("loginHinweis").style.display = "none";
  }
}

function zeigeWarnung(msg) {
  const warnung = document.getElementById("warnung");
  warnung.textContent = msg;
  warnung.style.display = "block";
  setTimeout(() => warnung.style.display = "none", 3000);
}

function initialisiereKategorien() {
  const kategorien = JSON.parse(localStorage.getItem("kategorien")) || standardKategorien;
  const select = document.getElementById("kategorie");
  select.innerHTML = kategorien.map(k => `<option>${k}</option>`).join("");
  const filterSelect = document.getElementById("filterKategorie");
  filterSelect.innerHTML = '<option value="" class="filter-option-alle">üéØ Alle Ideen</option>';
  kategorien.forEach(k => filterSelect.add(new Option(k, k)));
}

function setzePrioritaet(p) {
  prioritaet = p;
  ["prioHoch", "prioMittel", "prioNiedrig"].forEach(id => 
    document.getElementById(id).classList.remove("selected")
  );
  if (p) document.getElementById(`prio${p}`).classList.add("selected");
  istGespeichert = false;
}
// Ideen-Verwaltungsfunktionen
function speichereIdee() {
  const text = document.getElementById("ideeText").value.trim();
  if (!text) return zeigeWarnung("Titel ist erforderlich!");
  
  let dateien = [];
  if (accessToken) {
    Promise.all(
      Array.from(document.getElementById("dateien").files).map(async file => ({
        name: file.name,
        type: file.type,
        link: await uploadToOneDrive(file)
      }))
    ).then(d => {
      dateien = d;
      saveIdeeObjekt(dateien);
    });
  } else {
    dateien = Array.from(document.getElementById("dateien").files).map(file => ({
      name: file.name,
      data: URL.createObjectURL(file),
      type: file.type,
      pfad: file.webkitRelativePath || file.name
    }));
    saveIdeeObjekt(dateien);
  }
}

function saveIdeeObjekt(dateien) {
  let ideen = JSON.parse(localStorage.getItem("ideen") || "[]");
  const erledigt = bearbeiteIndex !== null ? (ideen[bearbeiteIndex]?.erledigt || false) : false;
  const beschreibungen = bearbeiteIndex !== null ? (ideen[bearbeiteIndex]?.beschreibungen || []) : [];
  
  const idee = {
    text: document.getElementById("ideeText").value.trim(),
    details: document.getElementById("ideeDetails").value,
    kategorie: document.getElementById("kategorie").value,
    prioritaet,
    mandantennummer: document.getElementById("mandantennummer").value.trim(),
    firmenname: document.getElementById("firmenname").value.trim(),
    dateien,
    timestamp: new Date().toLocaleString("de-DE"),
    erledigt,
    beschreibungen
  };
  
  if (bearbeiteIndex !== null) {
    ideen[bearbeiteIndex] = idee;
    bearbeiteIndex = null;
    document.getElementById("speichernBtn").textContent = "üíæ Speichern";
    document.getElementById("abbrechenBtn").style.display = "none";
  } else {
    ideen.push(idee);
  }
  
  localStorage.setItem("ideen", JSON.stringify(ideen));
  zeigeIdeen();
  document.getElementById("ideeText").value = "";
  document.getElementById("ideeDetails").value = "";
  document.getElementById("mandantennummer").value = "";
  document.getElementById("firmenname").value = "";
  document.getElementById("dateien").value = "";
  setzePrioritaet("");
  istGespeichert = true;
}

// Filter-Funktionen
function filterNachMandant() {
  filterMandantValue = document.getElementById("filterMandant").value.trim();
  zeigeIdeen();
}

function filterMandantZuruecksetzen() {
  filterMandantValue = "";
  document.getElementById("filterMandant").value = "";
  zeigeIdeen();
}

function zeigeIdeen() {
  const filter = document.getElementById("filterKategorie").value;
  const sortierung = document.getElementById("sortierung").value;
  let ideen = JSON.parse(localStorage.getItem("ideen") || "[]");
  
  // Kategoriefilter anwenden
  if (filter) {
    ideen = ideen.filter(i => i.kategorie === filter);
  }
  
  // Mandantenfilter anwenden (nur wenn ein Wert eingegeben wurde)
  if (filterMandantValue) {
    ideen = ideen.filter(i => {
      // Sicherstellen, dass mandantennummer existiert (f√ºr √§ltere Datens√§tze)
      const mandant = i.mandantennummer || "";
      return mandant.toLowerCase() === filterMandantValue.toLowerCase();
    });
  }
  
  // Sortierung anwenden
  ideen = ideen.sort((a, b) => {
    if (sortierung === "prio") {
      const p = { "Hoch": 3, "Mittel": 2, "Niedrig": 1 };
      return (p[b.prioritaet] || 0) - (p[a.prioritaet] || 0);
    }
    return sortierung === "neu" 
      ? new Date(b.timestamp) - new Date(a.timestamp) 
      : new Date(a.timestamp) - new Date(b.timestamp);
  });
  
  // Ideen anzeigen
  document.getElementById("ideenListe").innerHTML = ideen.map((idee, idx) => {
    const erledigt = idee.erledigt || false;
    return `
    <div class="idee${erledigt ? ' erledigt' : ''}">
      <div class="idee-content">
        <h3>${idee.text}</h3>
        <p>${idee.details || ""}</p>
        ${idee.mandantennummer ? `<div>Mandantennummer: <b>${idee.mandantennummer}</b></div>` : ""}
        ${idee.firmenname ? `<div>Firmenname: <b>${idee.firmenname}</b></div>` : ""}
        ${idee.beschreibungen && idee.beschreibungen.length ? `
          <div class="beschreibung-historie">
            <b>Weitere Beschreibungen:</b>
            ${idee.beschreibungen.map(b => `
              <div class="beschreibung-item">
                <span class="beschreibung-zeit">${b.timestamp}</span>
                ${b.text}
              </div>
            `).join("")}
          </div>
        ` : ""}
        <small>${idee.kategorie} | ${idee.prioritaet || "Keine"} | ${idee.timestamp}</small>
        ${idee.dateien?.map(file => `
          <a class="datei-link" href="${file.link || file.data}" target="_blank">${file.link ? 'üåê' : 'üìé'} ${file.name}</a>
          ${file.link ? '<div class="datei-info">OneDrive-Link</div>' : `<div class="datei-info">Pfad: <i>${file.pfad || file.name}</i></div>`}
          ${file.type?.startsWith("image/") ? `<img src="${file.link || file.data}" style="max-width:150px;">` : ""}
          ${file.type === "application/pdf" ? `<iframe src="${file.link || file.data}" style="width:150px;height:100px;"></iframe>` : ""}
        `).join("")}
        <div class="idee-actions">
          <button onclick="verschiebeIdee(${idx}, -1)">‚¨ÜÔ∏è</button>
          <button onclick="verschiebeIdee(${idx}, 1)">‚¨áÔ∏è</button>
          <button onclick="bearbeiteIdee(${idx})">‚úèÔ∏è</button>
          <button onclick="toggleErledigt(${idx})">${erledigt ? "‚Ü©Ô∏è" : "‚úîÔ∏è"}</button>
          <button onclick="loescheIdee(${idx})">üóëÔ∏è</button>
          <button onclick="zeigeBeschreibungDialog(${idx})">+ Beschreibung</button>
        </div>
      </div>
      <input type="checkbox" class="idee-checkbox" 
             onchange="toggleAuswahl(${idx}, this)" 
             ${ausgewaehlt.includes(idx) ? "checked" : ""}>
    </div>`;
  }).join("");
}
// Beschreibungsfunktionen
function zeigeBeschreibungDialog(idx) {
  beschreibungFuerIndex = idx;
  document.getElementById("beschreibungDialog").style.display = "block";
  document.getElementById("beschreibungText").value = "";
  document.getElementById("beschreibungText").focus();
  istGespeichert = false;
}

function beschreibungAbbrechen() {
  document.getElementById("beschreibungDialog").style.display = "none";
  beschreibungFuerIndex = null;
  document.getElementById("beschreibungText").value = "";
}

function beschreibungSpeichern() {
  const text = document.getElementById("beschreibungText").value.trim();
  if (!text) return;
  const timestamp = new Date().toLocaleString("de-DE");
  let ideen = JSON.parse(localStorage.getItem("ideen") || "[]");
  let idx = beschreibungFuerIndex;
  if (!ideen[idx].beschreibungen) ideen[idx].beschreibungen = [];
  ideen[idx].beschreibungen.push({ text, timestamp });
  localStorage.setItem("ideen", JSON.stringify(ideen));
  zeigeIdeen();
  beschreibungAbbrechen();
  istGespeichert = true;
}

// Status-Funktionen
function toggleErledigt(idx) {
  let ideen = JSON.parse(localStorage.getItem("ideen") || "[]");
  ideen[idx].erledigt = !ideen[idx].erledigt;
  localStorage.setItem("ideen", JSON.stringify(ideen));
  zeigeIdeen();
  istGespeichert = true;
}

// Bearbeitungsfunktionen
function bearbeiteIdee(idx) {
  const ideen = JSON.parse(localStorage.getItem("ideen") || "[]");
  const idee = ideen[idx];
  document.getElementById("ideeText").value = idee.text;
  document.getElementById("ideeDetails").value = idee.details || "";
  document.getElementById("kategorie").value = idee.kategorie;
  document.getElementById("mandantennummer").value = idee.mandantennummer || "";
  document.getElementById("firmenname").value = idee.firmenname || "";
  setzePrioritaet(idee.prioritaet);
  bearbeiteIndex = idx;
  document.getElementById("speichernBtn").textContent = "üíæ Aktualisieren";
  document.getElementById("abbrechenBtn").style.display = "";
  istGespeichert = false;
}

function abbrechenBearbeiten() {
  bearbeiteIndex = null;
  document.getElementById("ideeText").value = "";
  document.getElementById("ideeDetails").value = "";
  document.getElementById("mandantennummer").value = "";
  document.getElementById("firmenname").value = "";
  document.getElementById("dateien").value = "";
  document.getElementById("speichernBtn").textContent = "üíæ Speichern";
  document.getElementById("abbrechenBtn").style.display = "none";
  setzePrioritaet("");
  istGespeichert = true;
}

// Positionierungsfunktionen
function verschiebeIdee(idx, richtung) {
  let ideen = JSON.parse(localStorage.getItem("ideen") || "[]");
  const neuePos = idx + richtung;
  if (neuePos >= 0 && neuePos < ideen.length) {
    [ideen[idx], ideen[neuePos]] = [ideen[neuePos], ideen[idx]];
    localStorage.setItem("ideen", JSON.stringify(ideen));
    zeigeIdeen();
    istGespeichert = false;
  }
}

// L√∂schfunktionen
function loescheIdee(idx) {
  if (!confirm("Wirklich l√∂schen?")) return;
  let ideen = JSON.parse(localStorage.getItem("ideen") || "[]");
  ideen.splice(idx, 1);
  localStorage.setItem("ideen", JSON.stringify(ideen));
  zeigeIdeen();
  abbrechenBearbeiten();
  istGespeichert = true;
}

// Kategoriefunktionen
function neueKategorieHinzufuegen() {
  const neueKat = document.getElementById("neueKategorie").value.trim();
  if (!neueKat) return;
  let kategorien = JSON.parse(localStorage.getItem("kategorien")) || standardKategorien;
  if (!kategorien.includes(neueKat)) {
    kategorien.push(neueKat);
    localStorage.setItem("kategorien", JSON.stringify(kategorien));
    initialisiereKategorien();
    document.getElementById("neueKategorie").value = "";
    zeigeWarnung("Kategorie hinzugef√ºgt: " + neueKat);
  } else {
    zeigeWarnung("Kategorie existiert bereits!");
  }
}

function kategorieLoeschen() {
  const kat = document.getElementById("neueKategorie").value.trim();
  const hinweis = document.getElementById("katHinweis");
  if (!kat) {
    hinweis.textContent = "Bitte Kategorie angeben!";
    hinweis.style.display = "";
    return;
  }
  let kategorien = JSON.parse(localStorage.getItem("kategorien")) || standardKategorien;
  let ideen = JSON.parse(localStorage.getItem("ideen") || "[]");
  if (!kategorien.includes(kat)) {
    hinweis.textContent = "Kategorie existiert nicht!";
    hinweis.style.display = "";
    return;
  }
  if (ideen.some(i => i.kategorie === kat)) {
    hinweis.textContent = "Kategorie wird noch verwendet! Bitte alle Notizen dieser Kategorie zuerst √§ndern oder l√∂schen.";
    hinweis.style.display = "";
    return;
  }
  if (confirm(`Kategorie "${kat}" wirklich l√∂schen?`)) {
    kategorien = kategorien.filter(k => k !== kat);
    localStorage.setItem("kategorien", JSON.stringify(kategorien));
    initialisiereKategorien();
    hinweis.textContent = "Kategorie gel√∂scht.";
    hinweis.style.display = "";
    setTimeout(() => { hinweis.style.display = "none"; }, 2000);
    document.getElementById("neueKategorie").value = "";
  }
}
// Auswahlfunktionen
function toggleAuswahl(idx, box) {
  if (box.checked) {
    if (!ausgewaehlt.includes(idx)) ausgewaehlt.push(idx);
  } else {
    ausgewaehlt = ausgewaehlt.filter(i => i !== idx);
  }
}

function ausgewaehlteNotizenLoeschen() {
  if (!confirm("Ausgew√§hlte Notizen l√∂schen?")) return;
  let ideen = JSON.parse(localStorage.getItem("ideen") || "[]");
  ideen = ideen.filter((_, idx) => !ausgewaehlt.includes(idx));
  localStorage.setItem("ideen", JSON.stringify(ideen));
  ausgewaehlt = [];
  zeigeIdeen();
  istGespeichert = true;
}

function alleIdeenLoeschen() {
  if (!confirm("Wirklich ALLE Ideen l√∂schen?")) return;
  localStorage.setItem("ideen", "[]");
  ausgewaehlt = [];
  zeigeIdeen();
  abbrechenBearbeiten();
  istGespeichert = true;
}

// Exportfunktionen
function getExportIdeen() {
  let alle = JSON.parse(localStorage.getItem("ideen") || "[]");
  if (ausgewaehlt.length > 0) {
    return ausgewaehlt.map(idx => alle[idx]).filter(Boolean);
  }
  
  const filter = document.getElementById("filterKategorie").value;
  let ideen = filter ? alle.filter(i => i.kategorie === filter) : alle;
  
  if (filterMandantValue) {
    ideen = ideen.filter(i => {
      const mandant = i.mandantennummer || "";
      return mandant.toLowerCase() === filterMandantValue.toLowerCase();
    });
  }
  
  return ideen;
}

function exportiereAlsPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  const margin = 15;
  const pageHeight = doc.internal.pageSize.getHeight();
  let y = margin;
  const ideen = getExportIdeen();
  
  ideen.forEach((idee, idx) => {
    const titel = `Idee ${idx + 1}: ${idee.text}`;
    const titelLines = doc.splitTextToSize(titel, 180);
    titelLines.forEach(line => {
      if (y + 10 > pageHeight - margin) {
        doc.addPage();
        y = margin;
      }
      doc.text(line, margin, y);
      y += 10;
    });
    
    const meta = [
      `Kategorie: ${idee.kategorie}`,
      `Priorit√§t: ${idee.prioritaet || "Keine"}`,
      `Datum: ${idee.timestamp}`
    ];
    
    if (idee.mandantennummer) meta.push(`Mandantennummer: ${idee.mandantennummer}`);
    if (idee.firmenname) meta.push(`Firmenname: ${idee.firmenname}`);
    
    meta.forEach(text => {
      if (y + 10 > pageHeight - margin) {
        doc.addPage();
        y = margin;
      }
      doc.text(text, margin, y);
      y += 10;
    });
    
    if (idee.details) {
      const detailLines = doc.splitTextToSize(idee.details, 180);
      detailLines.forEach(line => {
        if (y + 10 > pageHeight - margin) {
          doc.addPage();
          y = margin;
        }
        doc.text(line, margin, y);
        y += 10;
      });
    }
    
    if (idee.beschreibungen && idee.beschreibungen.length) {
      doc.text("Weitere Beschreibungen:", margin, y);
      y += 10;
      idee.beschreibungen.forEach(b => {
        const beschr = `[${b.timestamp}] ${b.text}`;
        const lines = doc.splitTextToSize(beschr, 180);
        lines.forEach(line => {
          if (y + 10 > pageHeight - margin) {
            doc.addPage();
            y = margin;
          }
          doc.text(line, margin, y);
          y += 10;
        });
      });
    }
    
    idee.dateien?.forEach(file => {
      if (y + 10 > pageHeight - margin) {
        doc.addPage();
        y = margin;
      }
      doc.setTextColor(0, 0, 255);
      if (doc.textWithLink) {
        doc.textWithLink(`üåê ${file.name}`, margin, y, { url: file.link || file.data });
      } else {
        doc.text(`üåê ${file.name}`, margin, y);
      }
      doc.setTextColor(0, 0, 0);
      y += 10;
    });
    
    y += 15;
    if (y > pageHeight - margin) {
      doc.addPage();
      y = margin;
    }
  });
  
  doc.save("ideen-export.pdf");
}

function exportiereAlsText() {
  const ideen = getExportIdeen();
  const text = ideen.map(idee => 
    `=== ${idee.text} ===\n` +
    `Kategorie: ${idee.kategorie}\n` +
    `Priorit√§t: ${idee.prioritaet || "Keine"}\n` +
    `Datum: ${idee.timestamp}\n` +
    (idee.mandantennummer ? `Mandantennummer: ${idee.mandantennummer}\n` : "") +
    (idee.firmenname ? `Firmenname: ${idee.firmenname}\n` : "") +
    (idee.beschreibungen && idee.beschreibungen.length
      ? "Weitere Beschreibungen:\n" + idee.beschreibungen.map(b => `[${b.timestamp}] ${b.text}`).join("\n")
      : "") +
    `\nAnh√§nge: ${idee.dateien?.map(f => f.name).join(", ") || "Keine"}\n`
  ).join("\n\n");
  
  const blob = new Blob([text], { type: "text/plain" });
  const url = URL.createObjectURL(blob);
  const link = document.createElement("a");
  link.href = url;
  link.download = "ideen-export.txt";
  link.click();
}

// Teilen-Funktionen
function teilePerEmail() {
  const ideen = getExportIdeen();
  const text = ideen.map(idee => 
    `*${idee.text}*\n` +
    `Kategorie: ${idee.kategorie}\n` +
    `Priorit√§t: ${idee.prioritaet || "Keine"}\n` +
    `Datum: ${idee.timestamp}\n` +
    (idee.mandantennummer ? `Mandantennummer: ${idee.mandantennummer}\n` : "") +
    (idee.firmenname ? `Firmenname: ${idee.firmenname}\n` : "") +
    (idee.beschreibungen && idee.beschreibungen.length
      ? "Weitere Beschreibungen:\n" + idee.beschreibungen.map(b => `[${b.timestamp}] ${b.text}`).join("\n")
      : "") +
    `\nAnh√§nge: ${idee.dateien?.map(f => f.name).join(", ") || "Keine"}\n`
  ).join("\n\n") + "\n\n[Bitte Anh√§nge manuell hinzuf√ºgen]";
  
  window.location.href = `mailto:?subject=Ideen-Export&body=${encodeURIComponent(text)}`;
}

function teilePerWhatsApp() {
  const ideen = getExportIdeen();
  const text = ideen.map(idee => 
    `*${idee.text}*\n` +
    `üìÅ Kategorie: ${idee.kategorie}\n` +
    `üîñ Priorit√§t: ${idee.prioritaet || "Keine"}\n` +
    `üìÖ ${idee.timestamp}\n` +
    `üìù ${idee.details || ""}\n` +
    (idee.mandantennummer ? `Mandantennummer: ${idee.mandantennummer}\n` : "") +
    (idee.firmenname ? `Firmenname: ${idee.firmenname}\n` : "") +
    (idee.beschreibungen && idee.beschreibungen.length
      ? "Weitere Beschreibungen:\n" + idee.beschreibungen.map(b => `[${b.timestamp}] ${b.text}`).join("\n")
      : "") +
    `\nüìé Anh√§nge: ${idee.dateien?.map(f => f.name).join(", ") || "Keine"}\n`
  ).join("\n\n");
  
  window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, "_blank");
}
// Dateifunktionen
async function speichereIdeenAlsDatei() {
  try {
    const ideen = JSON.parse(localStorage.getItem("ideen") || "[]");
    if (window.showSaveFilePicker) {
      fileHandle = await window.showSaveFilePicker({
        suggestedName: "ideen.json",
        types: [{ description: "JSON-Dateien", accept: { "application/json": [".json"] } }]
      });
      const writable = await fileHandle.createWritable();
      await writable.write(JSON.stringify(ideen, null, 2));
      await writable.close();
      alert("Datei erfolgreich gespeichert!");
      istGespeichert = true;
    } else {
      const blob = new Blob([JSON.stringify(ideen)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = url;
      link.download = "ideen.json";
      link.click();
      istGespeichert = true;
    }
  } catch (err) {
    if (err.name !== "AbortError") alert("Fehler beim Speichern: " + err.message);
  }
}

async function ladeIdeenAusDatei() {
  try {
    let file;
    if (window.showOpenFilePicker) {
      [fileHandle] = await window.showOpenFilePicker({
        types: [{ description: "JSON-Dateien", accept: { "application/json": [".json"] } }]
      });
      file = await fileHandle.getFile();
    } else {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      input.onchange = e => file = e.target.files[0];
      input.click();
      await new Promise(resolve => input.onchange = resolve);
    }
    const content = await file.text();
    const ideen = JSON.parse(content);
    if (!Array.isArray(ideen)) throw new Error("Ung√ºltiges Dateiformat");
    localStorage.setItem("ideen", JSON.stringify(ideen));
    ausgewaehlt = [];
    zeigeIdeen();
    alert("Datei erfolgreich geladen!");
    istGespeichert = true;
  } catch (err) {
    if (err.name !== "AbortError") alert("Fehler beim Laden: " + err.message);
  }
}

// Event-Listener
document.getElementById("ideeText").addEventListener("input", () => {
  istGespeichert = false;
});
document.getElementById("ideeDetails").addEventListener("input", () => {
  istGespeichert = false;
});
document.getElementById("mandantennummer").addEventListener("input", () => {
  istGespeichert = false;
});
document.getElementById("firmenname").addEventListener("input", () => {
  istGespeichert = false;
});

document.getElementById("dateien").addEventListener("change", function(e) {
  const vorschau = document.getElementById("dateiVorschau");
  vorschau.innerHTML = "";
  Array.from(e.target.files).forEach(file => {
    const url = URL.createObjectURL(file);
    vorschau.innerHTML += `
      <a class="datei-link" href="${url}" target="_blank">üìÑ ${file.name}</a>
      <div class="datei-info">Pfad: <i>${file.webkitRelativePath || file.name}</i></div>
      ${file.type.startsWith("image/") ? `<img src="${url}" style="max-width:150px;">` : ""}
      ${file.type === "application/pdf" ? `<iframe src="${url}" style="width:150px;height:100px;"></iframe>` : ""}
    `;
  });
  istGespeichert = false;
});

window.addEventListener("beforeunload", function (event) {
  if (!istGespeichert) {
    const confirmationMessage = "Sie haben ungespeicherte √Ñnderungen. M√∂chten Sie die Seite wirklich verlassen?";
    event.preventDefault();
    event.returnValue = confirmationMessage;
    return confirmationMessage;
  }
});

// Initialisierung
initialisiereKategorien();
zeigeIdeen();
pruefeLoginHinweis();
</script>
</body>
</html>
