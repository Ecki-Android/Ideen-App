<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ideen-App Pro</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f4f4f4; }
    h1 { color: #333; }
    input, select, textarea, button { margin-top: 10px; padding: 10px; width: 100%; max-width: 500px; }
    .idee { background: white; padding: 15px; margin: 10px 0; border-radius: 8px; box-shadow: 0 0 5px #ccc; }
    .buttons { display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap; }
    .filter-bar { margin: 20px 0; }
    .filter-bar select { width: auto; }
    .idee-actions { margin-top: 10px; display: flex; gap: 5px; flex-wrap: wrap; }
    .idee-actions button { padding: 5px 10px; font-size: 0.9em; }
    .prio-btn { background: #eee; border: 1px solid #ccc; border-radius: 4px; }
    .prio-btn.selected { background: #ffd700; border-color: #ff9800; color: #222; }
    .warnung { color: #d32f2f; margin: 10px 0; font-weight: bold; }
    .datei-link { color: #1a73e8; text-decoration: underline; cursor: pointer; margin: 5px 0; }
    .export-link-dialog { background: #fff; border: 1px solid #888; padding: 20px; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1000; }
    .overlay { position: fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.2); z-index:999; }
    .vorschau-btn { background: #f0f0f0; border: 1px solid #bbb; border-radius: 4px; margin-left: 5px; cursor: pointer; }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
  <h1>Ideen-App</h1>
  <div id="warnung" class="warnung" style="display:none;"></div>

  <input type="text" id="ideeText" placeholder="Titel*" />
  <textarea id="ideeDetails" placeholder="Beschreibung" rows="3"></textarea>
  <select id="kategorie"></select>
  <input type="text" id="neueKategorie" placeholder="Neue Kategorie" />
  <button onclick="neueKategorieHinzufuegen()">+ Kategorie</button>

  <div class="buttons">
    <button id="prioHoch" class="prio-btn" onclick="setzePrioritaet('Hoch')">ğŸ”´ Hoch</button>
    <button id="prioMittel" class="prio-btn" onclick="setzePrioritaet('Mittel')">ğŸŸ  Mittel</button>
    <button id="prioNiedrig" class="prio-btn" onclick="setzePrioritaet('Niedrig')">ğŸŸ¢ Niedrig</button>
  </div>

  <input type="file" id="dateien" multiple />
  <button id="speichernBtn" onclick="speichereIdee()">ğŸ’¾ Speichern</button>
  <button id="abbrechenBtn" onclick="abbrechenBearbeiten()" style="display:none;">Abbrechen</button>

  <div class="filter-bar">
    <select id="filterKategorie" onchange="zeigeIdeen()">
      <option value="">Alle Kategorien</option>
    </select>
    <select id="sortierung" onchange="zeigeIdeen()">
      <option value="neu">Neueste zuerst</option>
      <option value="alt">Ã„lteste zuerst</option>
      <option value="prio">PrioritÃ¤t</option>
    </select>
  </div>

  <button onclick="exportiereAlsPDF()">ğŸ“ PDF</button>
  <button onclick="exportiereAlsText()">ğŸ“„ Text</button>
  <button onclick="teilePerEmail()">âœ‰ï¸ E-Mail</button>
  <button onclick="teilePerWhatsApp()">ğŸ“± WhatsApp</button>

  <div id="ideenListe"></div>
  <div id="exportLinkDialog" style="display:none;"></div>
  <div id="overlay" class="overlay" style="display:none;"></div>

  <script>
    let prioritaet = "";
    let bearbeiteIndex = null;
    const standardKategorien = ["Arbeit", "Privat", "Projekte"];

    function initialisiereKategorien() {
      const kategorien = JSON.parse(localStorage.getItem("kategorien")) || standardKategorien;
      const select = document.getElementById("kategorie");
      const filter = document.getElementById("filterKategorie");
      select.innerHTML = filter.innerHTML = kategorien.map(k => `<option>${k}</option>`).join("");
    }

    function speichereIdee() {
      const text = document.getElementById("ideeText").value.trim();
      if (!text) {
        zeigeWarnung("Titel ist erforderlich!");
        return;
      }

      const dateien = Array.from(document.getElementById("dateien").files).map(file => ({
        name: file.name.replace(/\s+/g, '_'),
        data: URL.createObjectURL(file)
      }));

      let ideen = JSON.parse(localStorage.getItem("ideen") || "[]");
      const idee = {
        text,
        details: document.getElementById("ideeDetails").value,
        kategorie: document.getElementById("kategorie").value,
        prioritaet,
        dateien: dateien.length > 0 ? dateien : (bearbeiteIndex !== null ? ideen[bearbeiteIndex].dateien : []),
        timestamp: bearbeiteIndex !== null ? ideen[bearbeiteIndex].timestamp : new Date().toLocaleString("de-DE")
      };

      if (bearbeiteIndex !== null) {
        ideen[bearbeiteIndex] = idee;
        bearbeiteIndex = null;
        document.getElementById("speichernBtn").innerText = "ğŸ’¾ Speichern";
        document.getElementById("abbrechenBtn").style.display = "none";
      } else {
        ideen.push(idee);
      }
      localStorage.setItem("ideen", JSON.stringify(ideen));
      zeigeIdeen();
      document.getElementById("ideeText").value = "";
      document.getElementById("ideeDetails").value = "";
      document.getElementById("dateien").value = "";
      setzePrioritaet("");
    }

    function zeigeIdeen() {
      const ideen = JSON.parse(localStorage.getItem("ideen") || "[]")
        .filter(i => !document.getElementById("filterKategorie").value || i.kategorie === document.getElementById("filterKategorie").value)
        .sort((a, b) => {
          if (document.getElementById("sortierung").value === "prio") {
            const prio = { "Hoch": 3, "Mittel": 2, "Niedrig": 1 };
            return prio[b.prioritaet] - prio[a.prioritaet];
          }
          return document.getElementById("sortierung").value === "neu" ? 
            new Date(b.timestamp) - new Date(a.timestamp) : 
            new Date(a.timestamp) - new Date(b.timestamp);
        });

      document.getElementById("ideenListe").innerHTML = ideen.map((idee, idx) => `
        <div class="idee">
          <h3>${idee.text}</h3>
          <p>${idee.details}</p>
          <small>${idee.kategorie} | ${idee.prioritaet} | ${idee.timestamp}</small>
          ${idee.dateien.map((file, fidx) => `
            <div>
              <a class="datei-link" href="${file.data}" target="_blank" rel="noopener">
                ğŸ“ ${file.name}
              </a>
              <button class="vorschau-btn" onclick="vorschauDatei('${file.data}')">ğŸ“„ Vorschau</button>
            </div>
          `).join("")}
          <div class="idee-actions">
            <button onclick="verschiebeIdee(${idx}, -1)">â¬†ï¸</button>
            <button onclick="verschiebeIdee(${idx}, 1)">â¬‡ï¸</button>
            <button onclick="bearbeiteIdee(${idx})">âœï¸</button>
            <button onclick="loescheIdee(${idx})">ğŸ—‘ï¸</button>
            ${idee.dateien?.length ? `<button onclick="exportiereAnlagenLink(${idx})">ğŸ”—</button>` : ''}
          </div>
        </div>
      `).join("");
    }

    function vorschauDatei(dataurl) {
      window.open(dataurl, "_blank");
    }

    function verschiebeIdee(idx, richtung) {
      let ideen = JSON.parse(localStorage.getItem("ideen"));
      const neuePos = idx + richtung;
      if (neuePos < 0 || neuePos >= ideen.length) return;
      [ideen[idx], ideen[neuePos]] = [ideen[neuePos], ideen[idx]];
      localStorage.setItem("ideen", JSON.stringify(ideen));
      zeigeIdeen();
    }

    function bearbeiteIdee(idx) {
      const ideen = JSON.parse(localStorage.getItem("ideen"));
      const idee = ideen[idx];
      document.getElementById("ideeText").value = idee.text;
      document.getElementById("ideeDetails").value = idee.details;
      document.getElementById("kategorie").value = idee.kategorie;
      setzePrioritaet(idee.prioritaet);
      bearbeiteIndex = idx;
      document.getElementById("speichernBtn").innerText = "ğŸ’¾ Aktualisieren";
      document.getElementById("abbrechenBtn").style.display = "";
    }

    function abbrechenBearbeiten() {
      bearbeiteIndex = null;
      document.getElementById("ideeText").value = "";
      document.getElementById("ideeDetails").value = "";
      document.getElementById("dateien").value = "";
      document.getElementById("speichernBtn").innerText = "ğŸ’¾ Speichern";
      document.getElementById("abbrechenBtn").style.display = "none";
      setzePrioritaet("");
    }

    function loescheIdee(idx) {
      if (!confirm("Wirklich lÃ¶schen?")) return;
      const ideen = JSON.parse(localStorage.getItem("ideen"));
      ideen.splice(idx, 1);
      localStorage.setItem("ideen", JSON.stringify(ideen));
      zeigeIdeen();
      abbrechenBearbeiten();
    }

    function exportiereAlsPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.text("Ideen-Export", 10, 10);
      JSON.parse(localStorage.getItem("ideen")).forEach((idee, i) => {
        const y = 20 + (i * 40);
        doc.text(`Idee ${i + 1}: ${idee.text}`, 10, y);
        doc.text(`Kategorie: ${idee.kategorie}`, 10, y + 5);
        doc.text(`PrioritÃ¤t: ${idee.prioritaet}`, 10, y + 10);
        idee.dateien?.forEach((file, j) => {
          if (doc.textWithLink) {
            doc.textWithLink(`ğŸ“ ${file.name}`, 10, y + 15 + (j * 5), { url: file.data });
          } else {
            doc.text(`ğŸ“ ${file.name}`, 10, y + 15 + (j * 5));
          }
        });
      });
      doc.save("ideen-export.pdf");
    }

    function exportiereAlsText() {
      const ideen = JSON.parse(localStorage.getItem("ideen") || "[]");
      const text = ideen.map(idee => 
        `=== ${idee.text} ===\n` +
        `Kategorie: ${idee.kategorie}\n` +
        `PrioritÃ¤t: ${idee.prioritaet}\n` +
        `Datum: ${idee.timestamp}\n` +
        `Details: ${idee.details}\n` +
        `AnhÃ¤nge: ${idee.dateien?.map(f => f.name).join(", ") || "Keine"}\n`
      ).join("\n\n");
      const blob = new Blob([text], { type: "text/plain" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = url;
      link.download = "ideen-export.txt";
      link.click();
    }

    function teilePerEmail() {
      const ideen = JSON.parse(localStorage.getItem("ideen") || "[]");
      const text = ideen.map(idee => 
        `*${idee.text}*\n` +
        `Kategorie: ${idee.kategorie}\n` +
        `PrioritÃ¤t: ${idee.prioritaet}\n` +
        `Datum: ${idee.timestamp}\n` +
        `Details: ${idee.details}\n` +
        `AnhÃ¤nge: ${idee.dateien?.map(f => f.name).join(", ")}\n`
      ).join("\n\n");
      window.location.href = `mailto:?subject=Ideen-Export&body=${encodeURIComponent(text)}`;
    }

    function teilePerWhatsApp() {
      const ideen = JSON.parse(localStorage.getItem("ideen") || "[]");
      const text = ideen.map(idee => 
        `*${idee.text}*\n` +
        `ğŸ“ Kategorie: ${idee.kategorie}\n` +
        `ğŸ”– PrioritÃ¤t: ${idee.prioritaet}\n` +
        `ğŸ“… ${idee.timestamp}\n` +
        `ğŸ“ ${idee.details}\n` +
        `ğŸ“ AnhÃ¤nge: ${idee.dateien?.map(f => f.name).join(", ") || "Keine"}\n`
      ).join("\n\n");
      window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, "_blank");
    }

    function neueKategorieHinzufuegen() {
      const neueKat = document.getElementById("neueKategorie").value.trim();
      if (!neueKat) return;
      let kategorien = JSON.parse(localStorage.getItem("kategorien")) || standardKategorien;
      if (!kategorien.includes(neueKat)) {
        kategorien.push(neueKat);
        localStorage.setItem("kategorien", JSON.stringify(kategorien));
        initialisiereKategorien();
        document.getElementById("neueKategorie").value = "";
      }
    }

    function exportiereAnlagenLink(idx) {
      const idee = JSON.parse(localStorage.getItem("ideen"))[idx];
      document.getElementById("exportLinkDialog").innerHTML = `
        <div class="export-link-dialog">
          <h3>${idee.dateien[0].name}</h3>
          <textarea rows="3">${idee.dateien[0].data}</textarea>
          <button onclick="navigator.clipboard.writeText('${idee.dateien[0].data}')">ğŸ“‹ Kopieren</button>
          <button onclick="schliesseExportDialog()">âœ–ï¸ SchlieÃŸen</button>
        </div>
      `;
      document.getElementById("exportLinkDialog").style.display = "block";
      document.getElementById("overlay").style.display = "block";
    }

    function schliesseExportDialog() {
      document.getElementById("exportLinkDialog").style.display = "none";
      document.getElementById("overlay").style.display = "none";
    }

    function zeigeWarnung(msg) {
      const warnung = document.getElementById("warnung");
      warnung.textContent = msg;
      warnung.style.display = "block";
      setTimeout(() => warnung.style.display = "none", 3000);
    }

    // Initialisierung
    initialisiereKategorien();
    zeigeIdeen();
  </script>
</body>
</html>
