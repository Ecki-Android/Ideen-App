<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ideen-App Pro</title>
  <style>
    html, body { box-sizing: border-box; margin: 0; padding: 0; background: #f4f4f4; width: 100vw; max-width: 100vw; overflow-x: hidden; }
    body { font-family: Arial, sans-serif; margin: 0 0 20px 0; }
    input, select, textarea { margin-top: 10px; padding: 10px; font-size: 1em; width: 400px; max-width: 100vw; box-sizing: border-box; display: block; }
    textarea { min-height: 60px; }
    button { padding: 10px 18px; font-size: 1em; margin-top: 10px; margin-right: 8px; border-radius: 4px; border: 1px solid #bbb; background: #eee; cursor: pointer; width: auto; min-width: 44px; display: inline-block; }
    .buttons, .top-actions { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
    .filter-bar { margin: 20px 0; }
    .filter-bar select { width: auto; }
    .idee { width: 100%; max-width: 100vw; box-sizing: border-box; overflow-wrap: break-word; word-break: break-word; background: white; padding: 15px; margin: 10px 0; border-radius: 8px; box-shadow: 0 0 5px #ccc; display: flex; align-items: flex-start; justify-content: space-between; }
    .idee.erledigt { background: #f0f0f0; }
    .idee-content { flex: 1; max-width: 100%; overflow-wrap: break-word; word-break: break-word; font-size: 1em; line-height: 1.5; }
    .idee-content h3, .idee-content p, .idee-content small { max-width: 100%; overflow-wrap: break-word; word-break: break-word; font-size: 1em; }
    .idee.erledigt .idee-content h3, 
    .idee.erledigt .idee-content p, 
    .idee.erledigt .idee-content small { text-decoration: line-through; color: #888; }
    .beschreibung-historie { margin: 8px 0 12px 0; }
    .beschreibung-item { margin: 4px 0 4px 0; padding: 6px 8px; background: #f8f8f8; border-left: 3px solid #bbb; font-size: 0.98em; }
    .beschreibung-zeit { color: #666; font-size: 0.9em; margin-bottom: 2px; display: block;}
    .idee-checkbox { margin-left: 10px; margin-top: 5px; min-width: 28px; min-height: 28px; }
    .idee-actions { margin-top: 10px; display: flex; gap: 5px; flex-wrap: wrap; }
    .idee-actions button { width: auto; min-width: 44px; padding: 6px 10px; font-size: 0.95em; }
    .prio-btn { background: #eee; border: 1px solid #ccc; border-radius: 4px; }
    .prio-btn.selected { background: #ffd700; border-color: #ff9800; color: #222; }
    .warnung { color: #d32f2f; margin: 10px 0; font-weight: bold; }
    .datei-link { color: #1a0dab; text-decoration: underline; cursor: pointer; font-weight: bold; display: inline-block; margin-bottom: 8px; max-width: 100%; overflow-wrap: break-word; word-break: break-word;}
    .datei-info { font-size: 0.96em; color: #333; margin-bottom: 8px; max-width: 100%; overflow-wrap: break-word; word-break: break-word;}
    .datei-vorschau { margin: 10px 0; }
    .datei-vorschau a { display: block; margin: 3px 0; }
    .filter-option-alle { color: #666; font-style: italic; }
    .katHinweis { color: #c00; font-size: 0.95em; margin-left: 10px; }
    .katLoeschBtn { background:#eee;border:1px solid #c00;color:#c00; }
    #preview img { max-width: 300px; max-height: 200px; display: block; margin-top: 8px; border: 1px solid #888; }
    #preview iframe { width: 300px; height: 200px; border: 1px solid #888; margin-top: 8px; display: block; }
    @media (max-width: 600px) {
      input, select, textarea, button { width: 100vw; min-width: 0; max-width: 100vw; }
      .buttons, .top-actions { flex-direction: column; gap: 0; }
      .idee { flex-direction: column; }
      .idee-checkbox { margin-left: 0; margin-top: 10px; }
      .idee-content, .idee-actions, .datei-link, .datei-info, .datei-vorschau, .idee-checkbox { max-width: 100vw; }
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
  <h1>Ideen-App</h1>
  <div id="warnung" class="warnung" style="display:none;"></div>

  <input type="text" id="ideeText" placeholder="Titel*" />
  <textarea id="ideeDetails" placeholder="Beschreibung" rows="3"></textarea>
  <select id="kategorie"></select>
  <input type="text" id="neueKategorie" placeholder="Neue Kategorie" />
  <button onclick="neueKategorieHinzufuegen()">+ Kategorie</button>
  <button class="katLoeschBtn" onclick="kategorieLoeschen()">Kategorie l√∂schen</button>
  <span id="katHinweis" class="katHinweis" style="display:none;"></span>
  <button id="addBeschreibungBtn" type="button" onclick="zeigeBeschreibungEingabe()">+ Beschreibung</button>
  <div id="beschreibungEingabe" style="display:none; margin-top:10px;">
    <textarea id="beschreibungText" placeholder="Neue Beschreibung" rows="2"></textarea>
    <button onclick="beschreibungSpeichern()">üíæ Speichern</button>
    <button onclick="beschreibungAbbrechen()">‚ùå Abbrechen</button>
  </div>

  <div class="buttons">
    <button id="prioHoch" class="prio-btn" onclick="setzePrioritaet('Hoch')">üî¥ Hoch</button>
    <button id="prioMittel" class="prio-btn" onclick="setzePrioritaet('Mittel')">üü† Mittel</button>
    <button id="prioNiedrig" class="prio-btn" onclick="setzePrioritaet('Niedrig')">üü¢ Niedrig</button>
  </div>

  <input type="file" id="dateien" multiple />
  <div class="datei-vorschau" id="dateiVorschau"></div>
  <div id="preview"></div>
  
  <button id="speichernBtn" onclick="speichereIdee()">üíæ Speichern</button>
  <button id="abbrechenBtn" onclick="abbrechenBearbeiten()" style="display:none;">Abbrechen</button>

  <div class="filter-bar">
    <label>Filter:</label>
    <select id="filterKategorie" onchange="zeigeIdeen()">
      <option value="" class="filter-option-alle">üéØ Alle Ideen</option>
    </select>
    <label>Sortierung:</label>
    <select id="sortierung" onchange="zeigeIdeen()">
      <option value="neu">Neueste zuerst</option>
      <option value="alt">√Ñlteste zuerst</option>
      <option value="prio">Nach Priorit√§t</option>
    </select>
  </div>

  <div class="top-actions">
    <button onclick="exportiereAlsPDF()">üìù PDF</button>
    <button onclick="exportiereAlsText()">üìÑ Text</button>
    <button onclick="teilePerEmail()">‚úâÔ∏è E-Mail</button>
    <button onclick="teilePerWhatsApp()">üì± WhatsApp</button>
    <button onclick="alleIdeenLoeschen()" style="background:#eee;border:1px solid #c00;color:#c00;">Alle Ideen l√∂schen</button>
    <button onclick="ausgewaehlteNotizenLoeschen()" style="background:#eee;border:1px solid #c00;color:#c00;">Ausgew√§hlte l√∂schen</button>
    <button id="speicherDateiBtn" onclick="speichereIdeenAlsDatei()">Datei speichern</button>
    <button id="oeffneDateiBtn" onclick="ladeIdeenAusDatei()">Datei √∂ffnen</button>
  </div>

  <div id="ideenListe"></div>

  <script>
    let prioritaet = "";
    let bearbeiteIndex = null;
    let ausgewaehlt = [];
    let fileHandle = null;
    let beschreibungFuerIndex = null;
    const standardKategorien = ["Aufgaben", "Projekte", "Privat", "Arbeit", "Sp√§ter"];

    function initialisiereKategorien() {
      const kategorien = JSON.parse(localStorage.getItem("kategorien")) || standardKategorien;
      const select = document.getElementById("kategorie");
      select.innerHTML = kategorien.map(k => `<option>${k}</option>`).join("");
      const filterSelect = document.getElementById("filterKategorie");
      filterSelect.innerHTML = '<option value="" class="filter-option-alle">üéØ Alle Ideen</option>';
      kategorien.forEach(k => filterSelect.add(new Option(k, k)));
    }

    function setzePrioritaet(p) {
      prioritaet = p;
      ["prioHoch", "prioMittel", "prioNiedrig"].forEach(id => 
        document.getElementById(id).classList.remove("selected")
      );
      document.getElementById(`prio${p}`).classList.add("selected");
    }

    function speichereIdee() {
      const text = document.getElementById("ideeText").value.trim();
      if (!text) return zeigeWarnung("Titel ist erforderlich!");
      const dateien = Array.from(document.getElementById("dateien").files).map(file => ({
        name: file.name,
        data: URL.createObjectURL(file),
        type: file.type,
        pfad: file.webkitRelativePath || file.name
      }));
      let ideen = JSON.parse(localStorage.getItem("ideen") || "[]");
      const erledigt = bearbeiteIndex !== null ? (ideen[bearbeiteIndex]?.erledigt || false) : false;
      const beschreibungen = bearbeiteIndex !== null ? (ideen[bearbeiteIndex]?.beschreibungen || []) : [];
      const idee = {
        text,
        details: document.getElementById("ideeDetails").value,
        kategorie: document.getElementById("kategorie").value,
        prioritaet,
        dateien,
        timestamp: new Date().toLocaleString("de-DE"),
        erledigt,
        beschreibungen
      };
      if (bearbeiteIndex !== null) {
        ideen[bearbeiteIndex] = idee;
        bearbeiteIndex = null;
        document.getElementById("speichernBtn").textContent = "üíæ Speichern";
        document.getElementById("abbrechenBtn").style.display = "none";
      } else {
        ideen.push(idee);
      }
      localStorage.setItem("ideen", JSON.stringify(ideen));
      zeigeIdeen();
      autoSpeichern && autoSpeichern();
      document.getElementById("ideeText").value = "";
      document.getElementById("ideeDetails").value = "";
      document.getElementById("dateien").value = "";
      setzePrioritaet("");
    }

    function zeigeIdeen() {
      const filter = document.getElementById("filterKategorie").value;
      const sortierung = document.getElementById("sortierung").value;
      let ideen = JSON.parse(localStorage.getItem("ideen") || "[]")
        .filter(i => !filter || i.kategorie === filter)
        .sort((a, b) => {
          if (sortierung === "prio") {
            const prioWerte = { "Hoch": 3, "Mittel": 2, "Niedrig": 1 };
            return prioWerte[b.prioritaet] - prioWerte[a.prioritaet];
          }
          return sortierung === "neu" 
            ? new Date(b.timestamp) - new Date(a.timestamp) 
            : new Date(a.timestamp) - new Date(b.timestamp);
        });

      document.getElementById("ideenListe").innerHTML = ideen.map((idee, idx) => {
        const erledigt = idee.erledigt || false;
        return `
        <div class="idee${erledigt ? ' erledigt' : ''}">
          <div class="idee-content">
            <h3>${idee.text}</h3>
            <p>${idee.details}</p>
            ${idee.beschreibungen && idee.beschreibungen.length ? `
              <div class="beschreibung-historie">
                <b>Weitere Beschreibungen:</b>
                ${idee.beschreibungen.map(b => `
                  <div class="beschreibung-item">
                    <span class="beschreibung-zeit">${b.timestamp}</span>
                    ${b.text}
                  </div>
                `).join("")}
              </div>
            ` : ""}
            <small>${idee.kategorie} | ${idee.prioritaet} | ${idee.timestamp}</small>
            ${idee.dateien?.map(file => `
              <a class="datei-link" href="${file.data}" target="_blank">üìé ${file.name}</a>
              <div class="datei-info">Pfad: <i>${file.pfad || file.name}</i></div>
              ${file.type?.startsWith("image/") ? `<img src="${file.data}" style="max-width:150px;">` : ""}
              ${file.type === "application/pdf" ? `<iframe src="${file.data}" style="width:150px;height:100px;"></iframe>` : ""}
            `).join("")}
            <div class="idee-actions">
              <button onclick="verschiebeIdee(${idx}, -1)">‚¨ÜÔ∏è</button>
              <button onclick="verschiebeIdee(${idx}, 1)">‚¨áÔ∏è</button>
              <button onclick="bearbeiteIdee(${idx})">‚úèÔ∏è</button>
              <button onclick="toggleErledigt(${idx})">${erledigt ? "‚Ü©Ô∏è" : "‚úîÔ∏è"}</button>
              <button onclick="loescheIdee(${idx})">üóëÔ∏è</button>
              <button onclick="zeigeBeschreibungEingabe(${idx})">+ Beschreibung</button>
            </div>
          </div>
          <input type="checkbox" class="idee-checkbox" 
                 onchange="toggleAuswahl(${idx}, this)" 
                 ${ausgewaehlt.includes(idx) ? "checked" : ""}>
        </div>`;
      }).join("");
    }

    function zeigeBeschreibungEingabe(idx) {
      beschreibungFuerIndex = idx;
      document.getElementById("beschreibungEingabe").style.display = "block";
      document.getElementById("beschreibungText").value = "";
      document.getElementById("beschreibungText").focus();
    }

    function beschreibungAbbrechen() {
      document.getElementById("beschreibungEingabe").style.display = "none";
      beschreibungFuerIndex = null;
      document.getElementById("beschreibungText").value = "";
    }

    function beschreibungSpeichern() {
      const text = document.getElementById("beschreibungText").value.trim();
      if (!text) return;
      const timestamp = new Date().toLocaleString("de-DE");
      let ideen = JSON.parse(localStorage.getItem("ideen") || "[]");
      let idx = beschreibungFuerIndex !== null ? beschreibungFuerIndex : (bearbeiteIndex !== null ? bearbeiteIndex : ideen.length - 1);
      if (!ideen[idx].beschreibungen) ideen[idx].beschreibungen = [];
      ideen[idx].beschreibungen.push({ text, timestamp });
      localStorage.setItem("ideen", JSON.stringify(ideen));
      zeigeIdeen();
      beschreibungAbbrechen();
    }

    // ... Restliche Funktionen bleiben wie in deiner Version (bearbeiteIdee, abbrechenBearbeiten, verschiebeIdee, loescheIdee, Kategorien, Export, Datei speichern/√∂ffnen etc.) ...

    initialisiereKategorien();
    zeigeIdeen();
  </script>
</body>
</html>
