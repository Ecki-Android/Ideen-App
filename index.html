<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ideen-App Pro</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f4f4f4; }
    input, select, textarea, button { margin-top: 10px; padding: 10px; width: 100%; max-width: 500px; }
    .idee { background: white; padding: 15px; margin: 10px 0; border-radius: 8px; box-shadow: 0 0 5px #ccc; display: flex; align-items: flex-start; }
    .idee-content { flex: 1; }
    .idee-checkbox { margin-right: 10px; margin-top: 5px; }
    .buttons { display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap; }
    .filter-bar { margin: 20px 0; }
    .filter-bar select { width: auto; }
    .idee-actions { margin-top: 10px; display: flex; gap: 5px; flex-wrap: wrap; }
    .idee-actions button { padding: 5px 10px; font-size: 0.9em; }
    .prio-btn { background: #eee; border: 1px solid #ccc; border-radius: 4px; }
    .prio-btn.selected { background: #ffd700; border-color: #ff9800; color: #222; }
    .warnung { color: #d32f2f; margin: 10px 0; font-weight: bold; }
    .datei-link { color: #1a0dab; text-decoration: underline; cursor: pointer; font-weight: bold; display: inline-block; margin-bottom: 8px; }
    .datei-info { font-size: 0.96em; color: #333; margin-bottom: 8px; }
    .datei-vorschau { margin: 10px 0; }
    .datei-vorschau a { display: block; margin: 3px 0; }
    .filter-option-alle { color: #666; font-style: italic; }
    .katHinweis { color: #c00; font-size: 0.95em; margin-left: 10px; }
    .katLoeschBtn { background:#eee;border:1px solid #c00;color:#c00; }
    #preview img { max-width: 300px; max-height: 200px; display: block; margin-top: 8px; border: 1px solid #888; }
    #preview iframe { width: 300px; height: 200px; border: 1px solid #888; margin-top: 8px; display: block; }
    .top-actions { margin-bottom: 12px; display: flex; gap: 10px; flex-wrap: wrap; }
    .hyperlink-container { margin: 10px 0 0 0; }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
  <h1>Ideen-App</h1>
  <div id="mobileHinweis" style="display:none; color:#1976d2; font-weight:bold; margin-bottom:10px;"></div>
  <div id="warnung" class="warnung" style="display:none;"></div>

  <input type="text" id="ideeText" placeholder="Titel*" />
  <textarea id="ideeDetails" placeholder="Beschreibung" rows="3"></textarea>
  <button id="hyperlinkBtn" type="button">Datei als Hyperlink einf√ºgen</button>
  <input type="file" id="hyperlinkFile" style="display:none">
  <div id="hyperlinkContainer" class="hyperlink-container"></div>

  <select id="kategorie"></select>
  <input type="text" id="neueKategorie" placeholder="Neue Kategorie" />
  <button onclick="neueKategorieHinzufuegen()">+ Kategorie</button>
  <button class="katLoeschBtn" onclick="kategorieLoeschen()">Kategorie l√∂schen</button>
  <span id="katHinweis" class="katHinweis" style="display:none;"></span>

  <div class="buttons">
    <button id="prioHoch" class="prio-btn" onclick="setzePrioritaet('Hoch')">üî¥ Hoch</button>
    <button id="prioMittel" class="prio-btn" onclick="setzePrioritaet('Mittel')">üü† Mittel</button>
    <button id="prioNiedrig" class="prio-btn" onclick="setzePrioritaet('Niedrig')">üü¢ Niedrig</button>
  </div>

  <input type="file" id="dateien" multiple />
  <div class="datei-vorschau" id="dateiVorschau"></div>
  <div id="preview"></div>
  
  <button id="speichernBtn" onclick="speichereIdee()">üíæ Speichern</button>
  <button id="abbrechenBtn" onclick="abbrechenBearbeiten()" style="display:none;">Abbrechen</button>

  <div class="filter-bar">
    <label>Filter:</label>
    <select id="filterKategorie" onchange="zeigeIdeen()">
      <option value="" class="filter-option-alle">üéØ Alle Ideen</option>
    </select>
    <label>Sortierung:</label>
    <select id="sortierung" onchange="zeigeIdeen()">
      <option value="neu">Neueste zuerst</option>
      <option value="alt">√Ñlteste zuerst</option>
      <option value="prio">Nach Priorit√§t</option>
    </select>
  </div>

  <div class="top-actions">
    <button onclick="exportiereAlsPDF()">üìù PDF</button>
    <button onclick="exportiereAlsText()">üìÑ Text</button>
    <button onclick="teilePerEmail()">‚úâÔ∏è E-Mail</button>
    <button onclick="teilePerWhatsApp()">üì± WhatsApp</button>
    <button onclick="alleIdeenLoeschen()" style="background:#eee;border:1px solid #c00;color:#c00;">Alle Ideen l√∂schen</button>
    <button onclick="ausgewaehlteNotizenLoeschen()" style="background:#eee;border:1px solid #c00;color:#c00;">Ausgew√§hlte l√∂schen</button>
  </div>

  <div id="ideenListe"></div>
  <div id="exportLinkDialog" style="display:none;"></div>
  <div id="overlay" class="overlay" style="display:none;"></div>

  <script>
    let prioritaet = "";
    let bearbeiteIndex = null;
    let ausgewaehlt = [];
    let hyperlinkFileObj = null;
    const standardKategorien = ["Aufgaben", "Projekte", "Privat", "Arbeit", "Sp√§ter"];

    function istMobil() {
      return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    }
    window.addEventListener("DOMContentLoaded", function() {
      if(istMobil()) {
        document.getElementById("mobileHinweis").style.display = "";
        document.getElementById("mobileHinweis").textContent =
          "Hinweis: Auf Mobilger√§ten ist die Sortierung nicht m√∂glich. Es werden alle Notizen unter Aufgaben angezeigt.";
      }
    });

    // Hyperlink-Funktionalit√§t
    document.getElementById("hyperlinkBtn").onclick = function() {
      document.getElementById("hyperlinkFile").click();
    };
    document.getElementById("hyperlinkFile").onchange = function(e) {
      const file = e.target.files[0];
      const container = document.getElementById("hyperlinkContainer");
      container.innerHTML = "";
      hyperlinkFileObj = null;
      if (!file) return;
      const url = URL.createObjectURL(file);
      const link = document.createElement("a");
      link.href = url;
      link.textContent = file.name;
      link.className = "datei-link";
      link.target = "_blank";
      link.rel = "noopener";
      container.appendChild(link);
      hyperlinkFileObj = { name: file.name, data: url, type: file.type };
    };

    function initialisiereKategorien() {
      let gespeicherteKategorien = JSON.parse(localStorage.getItem("kategorien")) || standardKategorien;
      const select = document.getElementById("kategorie");
      select.innerHTML = gespeicherteKategorien.map(k => `<option>${k}</option>`).join("");
      const filterSelect = document.getElementById("filterKategorie");
      filterSelect.innerHTML = '<option value="" class="filter-option-alle">üéØ Alle Ideen</option>';
      gespeicherteKategorien.forEach(k => {
        filterSelect.add(new Option(k, k));
      });
    }

    document.getElementById("dateien").addEventListener("change", function(e) {
      const vorschau = document.getElementById("dateiVorschau");
      const preview = document.getElementById("preview");
      vorschau.innerHTML = "";
      preview.innerHTML = "";
      Array.from(e.target.files).forEach(file => {
        const url = URL.createObjectURL(file);
        vorschau.innerHTML += `<a class="datei-link" href="${url}" target="_blank">üìÑ ${file.name}</a>`;
        vorschau.innerHTML += `<div class="datei-info">Speicherort: <i>${file.webkitRelativePath || "(lokal ausgew√§hlt)"}</i></div>`;
        if (file.type.startsWith("image/")) {
          preview.innerHTML += `<b>Vorschau:</b><br><img src="${url}" alt="${file.name}">`;
        } else if (file.type === "application/pdf") {
          preview.innerHTML += `<b>Vorschau:</b><br><iframe src="${url}"></iframe>`;
        } else {
          preview.innerHTML += "<b>Vorschau:</b> (Keine Vorschau verf√ºgbar f√ºr diesen Dateityp)<br>";
        }
      });
    });

    function speichereIdee() {
      const text = document.getElementById("ideeText").value.trim();
      if (!text) {
        zeigeWarnung("Titel ist erforderlich!");
        return;
      }
      const dateien = Array.from(document.getElementById("dateien").files).map(file => ({
        name: file.name.replace(/\s+/g, '_'),
        data: URL.createObjectURL(file),
        type: file.type
      }));
      // Hyperlink-Datei ggf. anh√§ngen
      if (hyperlinkFileObj) {
        dateien.unshift(hyperlinkFileObj);
        hyperlinkFileObj = null;
        document.getElementById("hyperlinkContainer").innerHTML = "";
        document.getElementById("hyperlinkFile").value = "";
      }
      const idee = {
        text,
        details: document.getElementById("ideeDetails").value,
        kategorie: document.getElementById("kategorie").value,
        prioritaet,
        dateien,
        timestamp: new Date().toLocaleString("de-DE")
      };
      let ideen = JSON.parse(localStorage.getItem("ideen") || "[]");
      if (bearbeiteIndex !== null) {
        ideen[bearbeiteIndex] = idee;
        bearbeiteIndex = null;
        document.getElementById("speichernBtn").textContent = "üíæ Speichern";
        document.getElementById("abbrechenBtn").style.display = "none";
      } else {
        ideen.push(idee);
      }
      localStorage.setItem("ideen", JSON.stringify(ideen));
      zeigeIdeen();
      document.getElementById("ideeText").value = "";
      document.getElementById("ideeDetails").value = "";
      document.getElementById("dateien").value = "";
      document.getElementById("dateiVorschau").innerHTML = "";
      document.getElementById("preview").innerHTML = "";
      setzePrioritaet("");
    }

    function zeigeIdeen() {
      const filter = document.getElementById("filterKategorie").value;
      const sortierung = document.getElementById("sortierung").value;
      let ideen = JSON.parse(localStorage.getItem("ideen") || "[]");
      let gefilterteIdeen = filter ? ideen.filter(i => i.kategorie === filter) : ideen.slice();

      if (sortierung === "neu") {
        gefilterteIdeen.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
      } else if (sortierung === "alt") {
        gefilterteIdeen.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
      } else if (sortierung === "prio") {
        const prio = { "Hoch": 3, "Mittel": 2, "Niedrig": 1 };
        gefilterteIdeen.sort((a, b) => prio[b.prioritaet] - prio[a.prioritaet]);
      }

      document.getElementById("ideenListe").innerHTML = gefilterteIdeen.map((idee, idx) => {
        const globalIdx = ideen.findIndex(i => i === idee);
        return `
        <div class="idee">
          <input type="checkbox" class="idee-checkbox" onchange="toggleAuswahl(${globalIdx},this)" ${ausgewaehlt.includes(globalIdx) ? "checked" : ""}>
          <div class="idee-content">
            <h3>${idee.text}</h3>
            <p>${idee.details}</p>
            <small>${idee.kategorie} | ${idee.prioritaet} | ${idee.timestamp}</small>
            ${idee.dateien.map(file => `
              <a class="datei-link" href="${file.data}" target="_blank">üìé ${file.name}</a>
              <div class="datei-info">Speicherort: <i>${file.name}</i></div>
              ${
                file.type && file.type.startsWith("image/") 
                  ? `<img src="${file.data}" alt="${file.name}" style="max-width:150px;max-height:100px;border:1px solid #888;margin-bottom:8px;">`
                  : file.type === "application/pdf"
                    ? `<iframe src="${file.data}" style="width:150px;height:100px;border:1px solid #888;margin-bottom:8px;"></iframe>`
                    : ""
              }
            `).join("")}
            <div class="idee-actions">
              <button onclick="verschiebeIdee(${globalIdx}, -1)">‚¨ÜÔ∏è</button>
              <button onclick="verschiebeIdee(${globalIdx}, 1)">‚¨áÔ∏è</button>
              <button onclick="bearbeiteIdee(${globalIdx})">‚úèÔ∏è</button>
              <button onclick="loescheIdee(${globalIdx})">üóëÔ∏è</button>
            </div>
          </div>
        </div>
      `;
      }).join("");
    }

    function toggleAuswahl(idx, box) {
      if (box.checked) {
        if (!ausgewaehlt.includes(idx)) ausgewaehlt.push(idx);
      } else {
        ausgewaehlt = ausgewaehlt.filter(i => i !== idx);
      }
    }

    function ausgewaehlteNotizenLoeschen() {
      if (!ausgewaehlt.length) {
        zeigeWarnung("Bitte mindestens eine Notiz ausw√§hlen!");
        return;
      }
      if (!confirm("Wirklich die ausgew√§hlten Notizen l√∂schen?")) return;
      let ideen = JSON.parse(localStorage.getItem("ideen") || "[]");
      ideen = ideen.filter((_, idx) => !ausgewaehlt.includes(idx));
      localStorage.setItem("ideen", JSON.stringify(ideen));
      ausgewaehlt = [];
      zeigeIdeen();
      abbrechenBearbeiten();
    }

    function alleIdeenLoeschen() {
      if (!confirm("Wirklich ALLE Ideen l√∂schen?")) return;
      localStorage.setItem("ideen", "[]");
      ausgewaehlt = [];
      zeigeIdeen();
      abbrechenBearbeiten();
    }

    function verschiebeIdee(idx, richtung) {
      let ideen = JSON.parse(localStorage.getItem("ideen") || "[]");
      const neuePos = idx + richtung;
      if (neuePos < 0 || neuePos >= ideen.length) return;
      [ideen[idx], ideen[neuePos]] = [ideen[neuePos], ideen[idx]];
      localStorage.setItem("ideen", JSON.stringify(ideen));
      zeigeIdeen();
    }

    function bearbeiteIdee(idx) {
      let ideen = JSON.parse(localStorage.getItem("ideen") || "[]");
      const idee = ideen[idx];
      document.getElementById("ideeText").value = idee.text;
      document.getElementById("ideeDetails").value = idee.details;
      document.getElementById("kategorie").value = idee.kategorie;
      setzePrioritaet(idee.prioritaet);
      bearbeiteIndex = idx;
      document.getElementById("speichernBtn").textContent = "üíæ Aktualisieren";
      document.getElementById("abbrechenBtn").style.display = "";
      document.getElementById("dateiVorschau").innerHTML = idee.dateien.map(file => `
        <a href="${file.data}" target="_blank">üìé ${file.name}</a>
        <div class="datei-info">Speicherort: <i>${file.name}</i></div>
      `).join("");
      document.getElementById("preview").innerHTML = idee.dateien.map(file => {
        if (file.type && file.type.startsWith("image/")) {
          return `<img src="${file.data}" alt="${file.name}" style="max-width:150px;max-height:100px;border:1px solid #888;margin-bottom:8px;">`;
        } else if (file.type === "application/pdf") {
          return `<iframe src="${file.data}" style="width:150px;height:100px;border:1px solid #888;margin-bottom:8px;"></iframe>`;
        } else {
          return "";
        }
      }).join("");
    }

    function abbrechenBearbeiten() {
      bearbeiteIndex = null;
      document.getElementById("ideeText").value = "";
      document.getElementById("ideeDetails").value = "";
      document.getElementById("dateien").value = "";
      document.getElementById("speichernBtn").textContent = "üíæ Speichern";
      document.getElementById("abbrechenBtn").style.display = "none";
      document.getElementById("dateiVorschau").innerHTML = "";
      document.getElementById("preview").innerHTML = "";
      setzePrioritaet("");
    }

    function loescheIdee(idx) {
      if (!confirm("Wirklich l√∂schen?")) return;
      let ideen = JSON.parse(localStorage.getItem("ideen") || "[]");
      ideen.splice(idx, 1);
      localStorage.setItem("ideen", JSON.stringify(ideen));
      zeigeIdeen();
      abbrechenBearbeiten();
    }

    function exportiereAlsPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      let y = 20;
      let ideen = JSON.parse(localStorage.getItem("ideen") || "[]");
      ideen.forEach((idee, idx) => {
        if (y > 270) { doc.addPage(); y = 20; }
        doc.setTextColor(0, 0, 0);
        doc.text(`Idee ${idx + 1}: ${idee.text}`, 10, y);
        y += 10;
        doc.text(`Kategorie: ${idee.kategorie}`, 10, y);
        y += 10;
        doc.text(`Priorit√§t: ${idee.prioritaet}`, 10, y);
        y += 10;
        if (idee.details) {
          const lines = doc.splitTextToSize(idee.details, 180);
          doc.text(lines, 10, y);
          y += lines.length * 7;
        }
        idee.dateien?.forEach(file => {
          doc.setTextColor(0, 0, 255);
          if (doc.textWithLink) {
            doc.textWithLink(`üìé ${file.name}`, 10, y, { url: file.data, underline: true });
          } else {
            doc.text(`üìé ${file.name}`, 10, y);
          }
          y += 10;
          doc.setTextColor(0, 0, 0);
        });
        y += 10;
      });
      doc.save("ideen-export.pdf");
    }

    function exportiereAlsText() {
      const ideen = JSON.parse(localStorage.getItem("ideen") || "[]");
      const text = ideen.map(idee => 
        `=== ${idee.text} ===\n` +
        `Kategorie: ${idee.kategorie}\n` +
        `Priorit√§t: ${idee.prioritaet}\n` +
        `Datum: ${idee.timestamp}\n` +
        `Details: ${idee.details}\n` +
        `Anh√§nge: ${idee.dateien?.map(f => f.name).join(", ") || "Keine"}\n`
      ).join("\n\n");
      const blob = new Blob([text], { type: "text/plain" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = url;
      link.download = "ideen-export.txt";
      link.click();
    }

    function teilePerEmail() {
      const ideen = JSON.parse(localStorage.getItem("ideen") || "[]");
      const text = ideen.map(idee => 
        `*${idee.text}*\n` +
        `Kategorie: ${idee.kategorie}\n` +
        `Priorit√§t: ${idee.prioritaet}\n` +
        `Datum: ${idee.timestamp}\n` +
        `Details: ${idee.details}\n` +
        `Anh√§nge: ${idee.dateien?.map(f => f.name).join(", ")}\n`
      ).join("\n\n") + "\n\n[Bitte Anh√§nge manuell hinzuf√ºgen]";
      window.location.href = `mailto:?subject=Ideen-Export&body=${encodeURIComponent(text)}`;
    }

    function teilePerWhatsApp() {
      const ideen = JSON.parse(localStorage.getItem("ideen") || "[]");
      const text = ideen.map(idee => 
        `*${idee.text}*\n` +
        `üìÅ Kategorie: ${idee.kategorie}\n` +
        `üîñ Priorit√§t: ${idee.prioritaet}\n` +
        `üìÖ ${idee.timestamp}\n` +
        `üìù ${idee.details}\n` +
        `üìé Anh√§nge: ${idee.dateien?.map(f => f.name).join(", ") || "Keine"}\n`
      ).join("\n\n");
      window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, "_blank");
    }

    function setzePrioritaet(p) {
      prioritaet = p;
      ["prioHoch", "prioMittel", "prioNiedrig"].forEach(id => 
        document.getElementById(id).classList.remove("selected")
      );
      document.getElementById(`prio${p}`).classList.add("selected");
    }

    function neueKategorieHinzufuegen() {
      const neueKat = document.getElementById("neueKategorie").value.trim();
      if (!neueKat) return;
      let kategorien = JSON.parse(localStorage.getItem("kategorien")) || standardKategorien;
      if (!kategorien.includes(neueKat)) {
        kategorien.push(neueKat);
        localStorage.setItem("kategorien", JSON.stringify(kategorien));
        initialisiereKategorien();
        document.getElementById("neueKategorie").value = "";
      }
    }

    function kategorieLoeschen() {
      const kat = document.getElementById("neueKategorie").value.trim();
      const hinweis = document.getElementById("katHinweis");
      if (!kat) {
        hinweis.textContent = "Bitte Kategorie angeben!";
        hinweis.style.display = "";
        return;
      }
      let kategorien = JSON.parse(localStorage.getItem("kategorien")) || standardKategorien;
      let ideen = JSON.parse(localStorage.getItem("ideen") || "[]");
      if (!kategorien.includes(kat)) {
        hinweis.textContent = "Kategorie existiert nicht!";
        hinweis.style.display = "";
        return;
      }
      if (ideen.some(i => i.kategorie === kat)) {
        hinweis.textContent = "Kategorie wird noch verwendet! Bitte alle Notizen dieser Kategorie zuerst √§ndern oder l√∂schen.";
        hinweis.style.display = "";
        return;
      }
      if (confirm(`Kategorie "${kat}" wirklich l√∂schen?`)) {
        kategorien = kategorien.filter(k => k !== kat);
        localStorage.setItem("kategorien", JSON.stringify(kategorien));
        initialisiereKategorien();
        hinweis.textContent = "Kategorie gel√∂scht.";
        hinweis.style.display = "";
        setTimeout(() => { hinweis.style.display = "none"; }, 2000);
        document.getElementById("neueKategorie").value = "";
      }
    }

    function zeigeWarnung(msg) {
      const warnung = document.getElementById("warnung");
      warnung.textContent = msg;
      warnung.style.display = "block";
      setTimeout(() => warnung.style.display = "none", 3000);
    }

    // Initialisierung
    initialisiereKategorien();
    zeigeIdeen();
  </script>
</body>
</html>
