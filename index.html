<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Ideen-App Pro</title>
<style>
/* --- CSS Styles --- */
html,body{box-sizing:border-box;margin:0;padding:0;background:#f4f4f4;width:100vw;max-width:100vw;overflow-x:hidden;}
body{font-family:Arial,sans-serif;margin:0 0 20px 0;}
input,select,textarea{margin-top:10px;padding:10px;font-size:1em;width:400px;max-width:100vw;box-sizing:border-box;display:block;}
textarea{min-height:60px;}
button{padding:10px 18px;font-size:1em;margin-top:10px;margin-right:8px;border-radius:4px;border:1px solid #bbb;background:#eee;cursor:pointer;width:auto;min-width:44px;display:inline-block;}
button:disabled { cursor: not-allowed; opacity: 0.6; }
.buttons,.top-actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;}
.filter-bar{margin:20px 0;}
.filter-bar label, .filter-bar select,.filter-bar input{width:auto;display:inline-block;margin-right:10px;margin-top:0;}
.filter-bar button { margin-top: 0; }
.idee{width:100%;max-width:100vw;box-sizing:border-box;overflow-wrap:break-word;word-break:break-word;background:white;padding:15px;margin:10px 0;border-radius:8px;box-shadow:0 0 5px #ccc;display:flex;align-items:flex-start;justify-content:space-between;}
.idee.erledigt{background:#f0f0f0;}
.idee-content{flex:1;max-width:100%;overflow-wrap:break-word;word-break:break-word;font-size:1em;line-height:1.5;}
.idee-content h3,.idee-content p,.idee-content small{max-width:100%;overflow-wrap:break-word;word-break:break-word;font-size:1em;}
.idee.erledigt .idee-content h3,.idee.erledigt .idee-content p,.idee.erledigt .idee-content small{text-decoration:line-through;color:#888;}
.beschreibung-historie{margin:8px 0 12px 0;}
.beschreibung-item{margin:4px 0 4px 0;padding:6px 8px;background:#f8f8f8;border-left:3px solid #bbb;font-size:0.98em;display:flex;justify-content:space-between;align-items:center;box-sizing:border-box;transition:opacity .3s ease;}
.beschreibung-text-zeit { flex-grow: 1; margin-right: 10px; overflow-wrap: break-word; word-break: break-word; }
.beschreibung-zeit{color:#666;font-size:0.9em;margin-bottom:2px;display:block;}
.beschreibung-eingabe, .erinnerung-dialog-content {margin:10px 0;background:#f9f9f9;border-left:3px solid #bbb;padding:15px; border-radius: 5px;}
.idee-checkbox{margin-left:10px;margin-top:5px;min-width:28px;min-height:28px;}
.idee-actions{margin-top:10px;display:flex;gap:5px;flex-wrap:wrap;}
.idee-actions button{width:auto;min-width:44px;padding:6px 10px;font-size:0.95em;}
.prio-btn{background:#eee;border:1px solid #ccc;border-radius:4px;}
.prio-btn.selected{background:#ffd700;border-color:#ff9800;color:#222;}
#vorgangsnummerAnzeigeInput { margin-top: 15px; margin-bottom: -5px; font-size: 0.9em; color: #555; }
.vorgangsnummer-anzeige-liste { font-weight: bold; font-size: 0.95em; color: #333; margin-bottom: 5px; }
#warnung { margin: 10px 0; font-weight: bold; padding: 10px; border-radius: 4px; display: none; position: fixed; top: 10px; left: 50%; transform: translateX(-50%); z-index: 1000; width: auto; max-width: 80%; text-align: center; }
#warnung.warnung{ color:#d32f2f; border: 1px solid #d32f2f; background-color: #ffe0e0; }
#warnung.success-message { color: #388e3c; border: 1px solid #388e3c; background-color: #e8f5e9; }
#warnung.info-message { color: #1a73e8; border: 1px solid #1a73e8; background-color: #e8f0fe; }
#sessionExpiredWarning { margin: 10px 0; font-weight: bold; padding: 10px; border-radius: 4px; display: none; background-color: #fffbe6; border: 1px solid #ffc107; color: #ff8f00; }
.beschreibung-item .edit-beschreibung-btn, .beschreibung-item .add-anhang-beschreibung-btn { padding: 3px 6px; font-size: 0.8em; margin-top: 0; min-width: auto; width: auto; height: 24px; line-height: 1; display: flex; align-items: center; justify-content: center; }
.top-actions .onedrive-btn { background: #0078d4; color: white; border-color: #005a9e; }
/* NEUE STILE F√úR STATUSANZEIGE */
.onedrive-status {
    display: none; /* Initial ausgeblendet */
    align-items: center;
    padding: 0 12px;
    font-size: 0.9em;
    font-weight: 500;
    border-radius: 4px;
    transition: all 0.3s ease;
    min-height: 38px; /* Passt zur Button-H√∂he */
    margin-top: 10px;
    border: 1px solid transparent;
}
.onedrive-status.dirty { /* √Ñnderungen vorhanden */
    color: #b45309;
    background-color: #fef3c7;
    border-color: #fde68a;
}
.onedrive-status.saving { /* Wird gespeichert */
    color: #0c4a6e;
    background-color: #e0f2fe;
    border-color: #bae6fd;
}
.onedrive-status.saved { /* Gespeichert/Synchron */
    color: #14532d;
    background-color: #dcfce7;
    border-color: #bbf7d0;
}
.onedrive-status.error { /* Fehler */
    color: #991b1b;
    background-color: #fee2e2;
    border-color: #fecaca;
}
.anhang-veraltet { opacity: 0.7; }
.anhang-veraltet .datei-link { text-decoration: line-through; color: grey !important; }
.toggle-anhang-sichtbarkeit-btn { padding: 1px 4px !important; font-size: 0.8em !important; margin-left: 8px !important; line-height: 1 !important; min-width: auto !important; width: auto !important; margin-top: 0 !important; vertical-align: middle !important; border-radius: 3px !important; border: 1px solid #ccc !important; background: #f0f0f0 !important; cursor: pointer; }
.beschreibung-item-actions { display: flex; gap: 3px; align-items: center; flex-shrink: 0; }
.move-beschreibung-btn { padding: 3px 5px !important; font-size: 1em !important; line-height: 1 !important; min-width: auto !important; width: auto !important; height: 24px !important; margin: 0 !important; vertical-align: middle; background-color: #f0f0f0 !important; border: 1px solid #ccc !important; border-radius: 3px !important; cursor: pointer; }
.beschreibung-veraltet { opacity: 0.6; }
.beschreibung-veraltet .beschreibung-text-zeit { color: grey; }
.toggle-beschreibung-sichtbarkeit-btn { padding: 1px 4px !important; font-size: 0.8em !important; margin-left: 3px !important; line-height: 1 !important; min-width: auto !important; width: auto !important; margin-top: 0 !important; vertical-align: middle !important; border-radius: 3px !important; border: 1px solid #ccc !important; background: #f0f0f0 !important; cursor: pointer; height: 24px !important; display: flex; align-items: center; justify-content: center; }
.beschreibung-anhaenge { font-size: 0.9em; margin-top: 5px; padding-left: 10px; border-left: 2px solid #ddd; }
.beschreibung-anhang-item { display: flex; align-items: center; margin-bottom: 2px; }
.erinnerung-info { font-size: 0.85em; color: #0078d4; margin-top: 5px; }
.beschreibung-erinnerung-info { font-size: 0.9em; color: #0078d4; margin-top: 4px; padding: 3px 0 3px 10px; }
.erinnerung-dialog-content label { display: block; margin-top:10px; font-weight: bold;}
.erinnerung-dialog-content input[type="datetime-local"], .erinnerung-dialog-content select, .erinnerung-dialog-content input[type="number"], .erinnerung-dialog-content input[type="text"] { width: calc(100% - 22px); }
.erinnerung-dialog-content .checkbox-label { display: inline-block; font-weight: normal; margin-left: 5px;}
.erinnerung-dialog-content input[type="checkbox"] { width: auto; display: inline-block; margin-right: 5px; vertical-align: middle;}
#adminPanel { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 500px; background: white; border: 1px solid #ccc; box-shadow: 0 5px 15px rgba(0,0,0,0.3); z-index: 2000; padding: 20px; }
#adminPanel h3 { margin-top: 0; }
#whitelistEditor { width: 100%; height: 150px; }
#accessDeniedMessage { display: none; text-align: center; padding: 40px; background: #fff; margin: 20px; border-radius: 8px; }
.app-container.hidden { display: none; }
@media (max-width:600px){
    input,select,textarea,button{width:100vw;min-width:0;max-width:100vw;}
    .buttons,.top-actions,.filter-bar{flex-direction:column;gap:0;}
    .filter-bar label, .filter-bar select, .filter-bar input, .filter-bar button { margin-right: 0; margin-bottom: 10px; }
    .idee{flex-direction:column;}
    .idee-checkbox{margin-left:0;margin-top:10px;}
    .idee-content,.idee-actions,.datei-link,.datei-info,.datei-vorschau,.idee-checkbox{max-width:100vw;}
    .beschreibung-item { flex-direction: column; align-items: flex-start; width: 100% !important; margin-left: 0 !important; padding-left: 8px; }
    .beschreibung-text-zeit { margin-right: 0; margin-bottom: 5px; width: 100%; }
    .beschreibung-item-actions { margin-top: 5px; width: 100%; justify-content: flex-start; flex-wrap: wrap; }
    #warnung { position: static; transform: none; left: auto; max-width: 100%; }
    .toggle-anhang-sichtbarkeit-btn { float: right; }
    .erinnerung-dialog-content input[type="datetime-local"], .erinnerung-dialog-content select, .erinnerung-dialog-content input[type="number"], .erinnerung-dialog-content input[type="text"] { width: 100%; }
    .onedrive-status { margin-top: 5px; width: 100%; justify-content: center; box-sizing: border-box;} /* NEU: F√ºr mobile Ansicht */
}

/* --- NEU: Stile f√ºr Telefonnummern-Liste --- */
#telefonNummerContainer {
    border: 1px solid #ddd;
    background: #fdfdfd;
    padding: 10px;
    margin-top: 10px;
    border-radius: 5px;
    max-height: 200px;
    overflow-y: auto;
}
.telefon-nummer-zeile {
    display: flex;
    gap: 8px;
    margin-bottom: 8px;
    align-items: center;
}
.telefon-nummer-zeile input[type="text"] {
    flex: 1;
    margin-top: 0;
    width: auto;
    min-width: 100px;
}
.telefon-nummer-zeile input[type="tel"] {
    flex: 2;
    margin-top: 0;
    width: auto;
}
.telefon-loeschen-btn {
    padding: 6px 10px !important;
    font-size: 0.9em !important;
    margin-top: 0 !important;
    min-width: auto !important;
    width: auto !important;
    background: #fbe9e7 !important;
    color: #c00 !important;
    border-color: #ffccbc !important;
    cursor: pointer;
}
#addTelefonNummerBtn {
    margin-top: 5px;
    padding: 8px 12px;
    font-size: 0.9em;
    background: #e8f5e9;
    border-color: #c8e6c9;
    color: #2e7d32;
}

/* --- NEU: Stile f√ºr Anruf-Auswahl-Dialog (Modal) --- */
.anruf-modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.6);
    z-index: 2500;
    justify-content: center;
    align-items: center;
}
.anruf-modal-content {
    background: white;
    padding: 25px;
    border-radius: 8px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    width: 90%;
    max-width: 450px;
}
.anruf-modal-content h3 {
    margin-top: 0;
    border-bottom: 1px solid #eee;
    padding-bottom: 10px;
}
.anruf-modal-content .nummer-wahl-btn {
    display: block;
    width: 100%;
    text-align: left;
    margin-top: 10px;
    padding: 12px;
    font-size: 1em;
    background: #f4f4f4;
    border-color: #ddd;
}
.anruf-modal-content .nummer-wahl-btn:hover {
    background: #e0e0e0;
}
.anruf-modal-content .nummer-wahl-btn strong {
    color: #0078d4;
    display: block;
    font-size: 0.9em;
}
.anruf-modal-content .modal-abbrechen-btn {
    margin-top: 20px;
    background: #eee;
    border-color: #ccc;
    width: 100%;
}

/* --- NEU: Stile f√ºr Telefonnummern-Anzeige in der Liste --- */
.telefon-nummer-anzeige-liste {
    font-size: 0.95em;
    margin-top: 8px;
    padding-left: 10px;
    border-left: 2px solid #0078d4;
}
.telefon-nummer-anzeige-item {
    display: block;
    margin-bottom: 3px;
    color: #333;
}
.telefon-nummer-anzeige-item strong {
    color: #005a9e;
}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://alcdn.msauth.net/browser/2.24.0/js/msal-browser.min.js"></script>
</head>
<body>

<div id="accessDeniedMessage">
    <h2>Zugriff verweigert</h2>
    <p>Sie sind nicht berechtigt, diese Anwendung zu nutzen.</p>
    <p>Bitte kontaktieren Sie den Administrator, um eine Freischaltung zu beantragen.</p>
</div>

<div class="app-container">
    <h1>Ideen-App Pro <span id="loggedInUser" style="display:none; font-size: 0.6em; font-weight: normal; color: #555;"></span></h1>
    <div id="warnung"></div>
    <div id="sessionExpiredWarning">Ihre Sitzung ist abgelaufen. Bitte melden Sie sich erneut an, um Datenverlust zu vermeiden.</div>
    <div id="loginHinweis" class="warnung" style="display:none;">Anmeldung erforderlich: Bitte melden Sie sich an, um Cloud-Funktionen wie Synchronisation und Dateianh√§nge zu nutzen.</div>

    <div id="vorgangsnummerAnzeigeInput">N√§chste Vorgangsnummer: <span id="naechsteNummerAnzeige">1</span></div>
    <input type="text" id="ideeText" placeholder="Titel*" />
    <textarea id="ideeDetails" placeholder="Beschreibung" rows="3"></textarea>
    
    <!-- MANDANTEN LOGIK -->
    <input type="text" id="mandantennummer" placeholder="Mandantennummer (optional) - Tippen f√ºr Auto-Fill" />
    <input type="text" id="firmenname" placeholder="Firmenname (optional)" />

    <!-- KONTAINER f√ºr Telefonnummern -->
    <div id="telefonNummerContainerVorschau" style="font-size: 0.9em; margin-top: 10px; padding: 5px; background: #f9f9f9; border-radius: 4px; display: none;">
        <b>Gespeicherte Nummern:</b> <span id="telefonNummerListeAnzeige"></span>
    </div>
    <div id="telefonNummerContainer">
        <!-- Dynamische Telefonnummer-Zeilen werden hier per JS eingef√ºgt -->
    </div>
    <button id="addTelefonNummerBtn" type="button">+ Telefonnummer hinzuf√ºgen</button>
    
    <!-- KATEGORIE & BENUTZER -->
    <select id="kategorie"></select> 
    <input type="text" id="neueKategorie" placeholder="Neue Kategorie" /> 
    <button onclick="neueKategorieHinzufuegen()">+ Kat</button> 
    <button class="katLoeschBtn" onclick="kategorieLoeschen()">Kat l√∂schen</button> 
    
    <!-- INTELLIGENTER BENUTZER SELECT -->
    <select id="benutzer" onchange="handleBenutzerChange()"></select> 
    <input type="text" id="neuerBenutzer" placeholder="Neuer Benutzer" /> 
    <button onclick="neuenBenutzerHinzufuegen()">+ User</button> 
    <button class="benutzerLoeschBtn" onclick="benutzerLoeschen()">User l√∂schen</button> 
    
    <div class="buttons"> 
        <button id="prioHoch" class="prio-btn" onclick="setzePrioritaet('Hoch')">üî¥ Hoch</button> 
        <button id="prioMittel" class="prio-btn" onclick="setzePrioritaet('Mittel')">üü† Mittel</button> 
        <button id="prioNiedrig" class="prio-btn" onclick="setzePrioritaet('Niedrig')">üü¢ Niedrig</button> 
    </div>
    
    <input type="file" id="dateien" multiple /> <div class="datei-vorschau" id="dateiVorschau"></div>
    <button id="speichernBtn" onclick="speichereIdee()">üíæ Speichern</button> <button id="abbrechenBtn" onclick="abbrechenBearbeiten()" style="display:none;">Abbrechen</button>

  <div class="filter-bar">
    <label>Filter:</label> 
    <select id="filterKategorie" onchange="zeigeIdeen(); updateVorgangsnummerDropdown()">
        <option value="" class="filter-option-alle">üéØ Alle Ideen</option>
    </select>
    <label>Archiv:</label> 
    <select id="filterArchiv" onchange="zeigeIdeen(); updateVorgangsnummerDropdown()">
        <option value="nicht_erledigt">Nur nicht erledigt</option>
        <option value="erledigt">Nur erledigt</option>
        <option value="alle">Alle anzeigen</option>
    </select>

    <label>Benutzer:</label> 
    <select id="filterBenutzer" onchange="filterNachBenutzer(); updateVorgangsnummerDropdown()"></select>
    <label>Mandant:</label> 
    <select id="filterMandant" onchange="filterNachMandant(); updateVorgangsnummerDropdown()">
        <option value="">üè¢ Alle Mandanten</option>
    </select>
    <label>Vorgang:</label>
    <select id="filterVorgangsnummer" onchange="zeigeIdeen()" style="min-width: 100px; border: 2px solid #0078d4; font-weight: bold;">
        <option value=""># Alle</option>
    </select>
    <label>Sortierung:</label> 
    <select id="sortierung" onchange="zeigeIdeen()">
        <option value="standard">Standard</option>
        <option value="neu">Neueste zuerst</option>
        <option value="alt">√Ñlteste zuerst</option>
        <option value="prio">Nach Priorit√§t</option>
    </select>
</div>

    <div class="top-actions">
    <button onclick="showAdminPanel()" id="adminButton" style="display:none; background:#ffc107; color: black; border-color: #e0a800;">üë§ Admin Panel</button>
    <button onclick="exportiereAlsPDF()">üìù PDF</button> <button onclick="exportiereAlsText()">üìÑ Text</button> <button onclick="teilePerEmail()">‚úâÔ∏è E-Mail</button> <button onclick="teilePerWhatsApp()">üì± WhatsApp</button>
    <input type="text" id="onedrivePath" placeholder="/ideenapp/ideen.json" style="width: 250px; margin-top: 0;"/>
    <button class="onedrive-btn" onclick="startLoadFromOneDrive()">‚òÅÔ∏è OneDrive Laden</button>
    <button class="onedrive-btn" onclick="saveToOneDrive(true)">‚òÅÔ∏è OneDrive Speichern</button>
    <span id="onedriveStatus" class="onedrive-status"></span>
    <button onclick="alleIdeenLoeschen()" style="background:#eee;border:1px solid #c00;color:#c00;">Alle l√∂schen</button> <button onclick="ausgewaehlteNotizenLoeschen()" style="background:#eee;border:1px solid #c00;color:#c00;">Auswahl l√∂schen</button>
    <button id="speicherDateiBtn" onclick="speichereIdeenAlsDatei()">Datei speichern</button> <button id="oeffneDateiBtn" onclick="ladeIdeenAusDatei()">Datei √∂ffnen</button>
    
    <button id="microsoftLoginBtn" onclick="handleMicrosoftLogin()" style="background:#e6f4ff;border-color:#0067b8;color:#0067b8;">üîë Anmelden (Microsoft)</button>
    <button id="githubLoginBtn" onclick="handleGithubLogin()" style="background:#333;border-color:#111;color:white;">üîë Anmelden (GitHub)</button>
    <button id="logoutBtn" onclick="handleLogout()" style="display:none; background:#ffe0e0;border-color:#c00;color:#c00;">üîí Abmelden</button>
    </div>

    <div id="ideenListe"></div>
    <div id="beschreibungDialog" style="display:none;" class="beschreibung-eingabe"> <textarea id="beschreibungText" placeholder="Weitere Beschreibung" rows="2"></textarea> <button id="beschreibungSpeichernBtn" onclick="beschreibungSpeichern()">üíæ Speichern</button> <button onclick="beschreibungAbbrechen()">‚ùå Abbrechen</button> </div>

    <input type="file" id="beschreibungAnhangInput" style="display: none;" onchange="handleBeschreibungAnhangUpload(event)" multiple>

    <div id="erinnerungDialog" style="display:none;" class="erinnerung-dialog-content">
        <h3>Erinnerung einstellen</h3>
        <label for="erinnerungTerminInput">Termin (Datum und Uhrzeit):</label>
        <input type="datetime-local" id="erinnerungTerminInput" />

        <label for="erinnerungIntervallTypSelect">Intervall:</label>
        <select id="erinnerungIntervallTypSelect" onchange="toggleErinnerungIntervallWert()">
            <option value="einmalig">Einmalig</option>
            <option value="tage">Alle X Tage</option>
            <option value="woechentlich">W√∂chentlich</option>
            <option value="monatlich">Monatlich</option>
            <option value="vierteljaehrlich">Viertelj√§hrlich</option>
            <option value="jaehrlich">J√§hrlich</option>
        </select>
        <div id="erinnerungIntervallWertContainer" style="display:none;">
          <label for="erinnerungIntervallWertInput">Anzahl Tage:</label>
          <input type="number" id="erinnerungIntervallWertInput" min="1" value="1" />
        </div>

        <input type="checkbox" id="erinnerungVorabCheckbox" onchange="toggleErinnerungVorabDetails()">
        <label for="erinnerungVorabCheckbox" class="checkbox-label">Vorab-Erinnerung</label>

        <div id="erinnerungVorabDetailsContainer" style="display:none;">
            <label for="erinnerungVorabWertInput">Vorab-Wert:</label>
            <input type="number" id="erinnerungVorabWertInput" min="1" value="10"/>
            <label for="erinnerungVorabEinheitSelect">Vorab-Einheit:</label>
            <select id="erinnerungVorabEinheitSelect">
                <option value="minuten">Minute(n)</option>
                <option value="stunden">Stunde(n)</option>
                <option value="tage">Tag(e)</option>
                <option value="wochen">Woche(n)</option>
            </select>
        </div>
        <div class="buttons">
            <button onclick="erinnerungSpeichern()">üíæ Speichern</button>
            <button onclick="erinnerungLoeschen()">üóëÔ∏è L√∂schen</button>
            <button onclick="beschreibungAbbrechen()">‚ùå Abbrechen</button>
        </div>
    </div>

    <div id="terminDialog" style="display:none;" class="erinnerung-dialog-content">
        <h3>Neuen Kalendertermin erstellen</h3>
        <label for="terminTitelInput">Titel des Termins:</label>
        <input type="text" id="terminTitelInput" />

        <label for="terminStartInput">Startzeit:</label>
        <input type="datetime-local" id="terminStartInput" />

        <label for="terminEndeInput">Endzeit:</label>
        <input type="datetime-local" id="terminEndeInput" />

        <label for="terminOrtInput">Ort (optional):</label>
        <input type="text" id="terminOrtInput" placeholder="Ort des Termins" />

        <p style="font-size:0.9em; margin-top:15px;">Hinweis: Die Beschreibungen der Idee werden automatisch in die Terminbeschreibung √ºbernommen.</p>

        <div class="buttons">
            <button onclick="kalenderTerminErstellenUndSpeichern()">üóìÔ∏è Kalenderlink erstellen & Vermerk speichern</button>
            <button onclick="terminDialogAbbrechen()">‚ùå Abbrechen</button>
        </div>
    </div>
</div>

<div id="adminPanel">
    <h3>Benutzerverwaltung (Whitelist)</h3>
    <p>F√ºgen Sie hier die E-Mail-Adressen der berechtigten Benutzer hinzu (eine pro Zeile). Diese Liste dient nur als lokales Backup oder zur Vorbereitung.</p>
    <p><b>Wichtig:</b> Die Live-Zugriffssteuerung erfolgt √ºber die <code>userlist.json</code> auf GitHub.</p>
    <textarea id="whitelistEditor"></textarea>
    <div class="buttons">
        <button onclick="saveWhitelistToLocalStorage()">Lokal speichern</button>
        <button onclick="saveWhitelistToOneDrive()">Backup in OneDrive speichern</button>
        <button onclick="closeAdminPanel()">Schlie√üen</button>
    </div>
</div>

<!-- NEU: Anruf-Auswahl-Dialog (Modal) -->
<div id="anrufModalOverlay" class="anruf-modal-overlay">
    <div class="anruf-modal-content">
        <h3 id="anrufModalTitel">Nummer f√ºr Anruf ausw√§hlen</h3>
        <div id="anrufModalNummerListe">
            <!-- Nummern-Buttons werden hier per JS eingef√ºgt -->
        </div>
        <button id="anrufModalAbbrechenBtn" class="modal-abbrechen-btn" onclick="closeAnrufModal()">Abbrechen</button>
    </div>
</div>
<!-- ENDE: Anruf-Auswahl-Dialog -->

<script>
console.log("Script started");
/* --- START BLOCK 4: Script Start, Variables & Initializers --- */
// WICHTIG: Ersetzen Sie diesen Link mit einem DIREKTEN Link zur userlist.json.
const whitelistUrl = "https://raw.githubusercontent.com/Ecki-Android/Ideen-App/main/userlist.json";

// Admin-E-Mail f√ºr direkte Erkennung und f√ºr das neue Antrags-System
const adminEmail = "admin@unimakgmbh.onmicrosoft.com";
const adminPasswordHash = "NDUwMV9raXdpMg=="; // Base64 kodiertes Passwort "4501_kiwi2"

// --- Microsoft MSAL Konfiguration ---
const msalConfig={auth:{clientId:"c3cd3be4-3540-46dd-a24c-82eb6ed5542d",authority:"https://login.microsoftonline.com/common",redirectUri: window.location.origin + window.location.pathname}};

// --- GitHub OAuth Konfiguration ---
const githubClientId = "Ov23liCVFN3ohObMAPqA";
const tokenProxyUrl = "https://musical-praline-fc16d2.netlify.app/.netlify/functions/github-auth";

let accessToken = null, // Microsoft Access Token
    githubAccessToken = null, // GitHub Access Token
    msalInstance = null, 
    prioritaet = "", 
    bearbeiteId = null, 
    ausgewaehlt = [], 
    fileHandle = null, 
    beschreibungFuerId = null, 
    beschreibungZuBearbeitenderTimestamp = null, 
    beschreibungAntwortAufTimestamp = null, // NEU: Merkt sich die Eltern-Beschreibung f√ºr eine Antwort
    istGespeichert = true;
// NEU: Globale Variable f√ºr den Namen des angemeldeten Benutzers
let aktuellerBenutzerName = null;
let erinnerungFuerId = null;
let erinnerungFuerBeschreibungTimestamp = null;
let terminFuerId = null;
let terminFuerBeschreibungTimestamp = null; // NEU f√ºr Einzel-Termine
let anhangFuerBeschreibungZiel = { ideeId: null, timestamp: null };
// NEU: Globale Variablen f√ºr Anruf-Dialog
let anrufModalCallbackData = { ideeId: null, timestamp: null };
let whitelist = [];
let currentLoginType = null; // 'microsoft' or 'github'
let tokenRefreshIntervalId = null; // "Wachhund" Intervall ID

const standardKategorien=["Aufgaben","Projekte","Privat","Arbeit","Sp√§ter"];
let kategorien=[];
let benutzerliste=[];
let filterMandantValue="";
let filterBenutzerValue="";
let naechsteVorgangsnummer=1;
let benachrichtigungsIntervallId = null;

/* --- SHARED DATA LOGIC (STAMMDATEN) --- */
// Erweiterte Struktur auch f√ºr Verkn√ºpfungen
let sharedStammdaten = { mandanten: [], kontakte: [], verknuepfungen: [] };
let selectedUserEmail = null; // Zum Merken der E-Mail des ausgew√§hlten Benutzers

async function loadSharedStammdaten() {
    if (currentLoginType !== 'microsoft' || !accessToken) return;
    
    // Pfad zur Datei, die von der Kontakt-App erstellt wird
    const path = "/ideenapp/stammdaten.json"; 
    
    try {
        const url = `https://graph.microsoft.com/v1.0/me/drive/root:${path}:/content`;
        const res = await fetch(url, {
            method: "GET",
            headers: { "Authorization": `Bearer ${accessToken}` }
        });
        
        if (res.ok) {
            const data = await res.json();
            
            // Konvertieren der Map-Strukturen (Arrays von [Key, Value]) in nutzbare Objekte
            if (data.mandanten) {
                sharedStammdaten.mandanten = data.mandanten.map(entry => entry[1]); 
            }
            if (data.kontakte) {
                sharedStammdaten.kontakte = data.kontakte.map(entry => entry[1]);
            }
            // NEU: Verkn√ºpfungen laden
            if (data.verknuepfungen) {
                sharedStammdaten.verknuepfungen = data.verknuepfungen.map(entry => entry[1]);
            }
            
            console.log("Stammdaten geladen:", sharedStammdaten);
            
            // UI aktualisieren: Benutzerliste mit echten Kontakten erweitern
            initialisiereBenutzer();
            
            // Pr√ºfen, ob f√ºr den aktuell angemeldeten User eine Mandanten-Verkn√ºpfung existiert (optionales Feature)
            // checkEigeneVerknuepfung(); 
            
        } else {
            console.warn("Stammdaten konnten nicht geladen werden (404?).");
        }
    } catch (e) {
        console.error("Fehler beim Laden der Stammdaten:", e);
    }
}

// Event Listener f√ºr Mandantennummer-Eingabe (Auto-Fill R√ºckw√§rts)
// Wenn man die Nummer tippt, f√ºllt sich der Firmenname
document.getElementById('mandantennummer').addEventListener('input', function(e) {
    const val = e.target.value.trim();
    if (!val || !sharedStammdaten.mandanten.length) return;
    
    const mandant = sharedStammdaten.mandanten.find(m => m.mandantennummer === val);
    if (mandant) {
        document.getElementById('firmenname').value = mandant.firmenname || "";
        triggerAutoSave();
    }
});

// Erweiterte Benutzer-Initialisierung (mischt lokale Benutzer und Cloud-Kontakte)
function initialisiereBenutzer() {
    // 1. Lokale Benutzerliste laden
    let localUsers = JSON.parse(localStorage.getItem("benutzerliste") || "[]");
    if (!Array.isArray(localUsers)) localUsers = [];
    
    // 2. Kontakte aus Stammdaten holen
    const kontaktNamen = sharedStammdaten.kontakte.map(k => k.fn).filter(n => n);
    
    // 3. Listen zusammenf√ºhren und Duplikate entfernen
    const alleBenutzer = [...new Set([...localUsers, ...kontaktNamen])].sort();
    
    // 4. Dropdowns f√ºllen
    const sel = document.getElementById("benutzer");
    const currentVal = sel.value;
    sel.innerHTML = '<option value="">-- Benutzer / Zust√§ndig --</option>';
    alleBenutzer.forEach(b => sel.add(new Option(b, b)));
    if (currentVal && alleBenutzer.includes(currentVal)) sel.value = currentVal;

    const fSel = document.getElementById("filterBenutzer");
    const currentFilter = fSel.value;
    fSel.innerHTML = '<option value="">üë§ Alle Benutzer</option>';
    alleBenutzer.forEach(b => fSel.add(new Option(b, b)));
    if (currentFilter && alleBenutzer.includes(currentFilter)) fSel.value = currentFilter;
}

// INTELLIGENTE FUNKTION: Wenn Benutzer ausgew√§hlt wird
function handleBenutzerChange() {
    const userName = document.getElementById('benutzer').value;
    selectedUserEmail = null; // Reset
    
    // Felder leeren, falls "Kein Benutzer" gew√§hlt wurde
    if (!userName) return;

    // Wir suchen in den geladenen Kontakten
    const kontakt = sharedStammdaten.kontakte.find(k => k.fn === userName);
    
    if (kontakt) {
        zeigeWarnung(`Kontakt gefunden: ${kontakt.fn}`, "info");

        // 1. E-Mail merken (f√ºr den E-Mail-Button)
        if (kontakt.email && Array.isArray(kontakt.email) && kontakt.email.length > 0) {
            selectedUserEmail = kontakt.email[0].address;
            console.log("E-Mail gemerkt:", selectedUserEmail);
        }

        // 2. Telefonnummern automatisch hinzuf√ºgen
        if (kontakt.telefon && Array.isArray(kontakt.telefon)) {
            const container = document.getElementById('telefonNummerContainer');
            kontakt.telefon.forEach(t => {
                // Pr√ºfen, ob Nummer schon da ist, um Duplikate zu vermeiden
                const exists = Array.from(container.querySelectorAll('.telefon-nummer')).some(inp => inp.value === t.number);
                if (!exists) {
                    addTelefonNummerInput(t.type || 'Mobil', t.number);
                }
            });
        }

        // 3. Mandanten-Verkn√ºpfung pr√ºfen (Das ist der neue, wichtige Teil!)
        // Wir suchen in der Verkn√ºpfungstabelle, ob dieser Kontakt zu einem Mandanten geh√∂rt.
        if (sharedStammdaten.verknuepfungen && sharedStammdaten.verknuepfungen.length > 0) {
            const link = sharedStammdaten.verknuepfungen.find(v => v.kontaktId === kontakt.id);
            
            if (link) {
                // Link gefunden! Jetzt den passenden Mandanten suchen
                const mandant = sharedStammdaten.mandanten.find(m => m.id === link.mandantId);
                if (mandant) {
                    document.getElementById('mandantennummer').value = mandant.mandantennummer || "";
                    document.getElementById('firmenname').value = mandant.firmenname || "";
                    zeigeWarnung(`Verkn√ºpfter Mandant geladen: ${mandant.firmenname}`, "success");
                }
            } else {
                // Fallback: Wenn keine feste Verkn√ºpfung, pr√ºfen wir "Organisation" im Kontakt
                if (kontakt.org && !document.getElementById('firmenname').value) {
                    document.getElementById('firmenname').value = kontakt.org;
                }
            }
        }
        
        triggerAutoSave();
    }
}
// --- ENDE SHARED DATA LOGIC ---


// --- NEU: Funktion zur Anzeige des OneDrive-Status ---
function updateOneDriveStatus(status, message) {
    const statusEl = document.getElementById("onedriveStatus");
    if (!statusEl) return;

    // Status nur anzeigen, wenn ein Cloud-Login aktiv ist
    if (currentLoginType !== 'microsoft') {
        statusEl.style.display = 'none';
        return;
    }

    // Klassen zur√ºcksetzen
    statusEl.className = 'onedrive-status';

    if (status === 'hidden' || !message) {
        statusEl.textContent = '';
        statusEl.style.display = 'none';
    } else {
        statusEl.textContent = message;
        statusEl.classList.add(status); // 'dirty', 'saving', 'saved', 'error'
        statusEl.style.display = 'flex';
    }
}


// --- Debounce-Funktion f√ºr automatisches Speichern (MODIFIZIERT) ---
let debounceTimer;
async function triggerAutoSave() {
    istGespeichert = false;
    updateOneDriveStatus('dirty', '√Ñnderungen vorhanden');
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(async () => {
        console.log("Auto-Save ausgel√∂st...");
        await saveToOneDrive(); // isManual defaults to false
    }, 2000); // Speichert 2 Sekunden nach der letzten √Ñnderung
}

function generateUUID(){return'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,function(c){var r=Math.random()*16|0,v=c=='x'?r:(r&0x3|0x8);return v.toString(16)})}
function pruebeLoginHinweis(){document.getElementById("loginHinweis").style.display=(accessToken || githubAccessToken)?"none":"block"}

// --- "WACHHUND" F√úR MICROSOFT-SITZUNG ---

function handleExpiredSession() {
    console.warn("Microsoft-Sitzung ist abgelaufen oder ung√ºltig.");
    accessToken = null; // Wichtig: Token zur√ºcksetzen
    updateOneDriveStatus('error', 'Sitzung abgelaufen'); // Status aktualisieren

    document.getElementById('sessionExpiredWarning').style.display = 'block';
    
    // Deaktiviere Eingabefelder und Speicher-Buttons
    document.getElementById('ideeText').disabled = true;
    document.getElementById('ideeDetails').disabled = true;
    document.getElementById('mandantennummer').disabled = true;
    document.getElementById('firmenname').disabled = true;
    document.getElementById('dateien').disabled = true;
    document.getElementById('speichernBtn').disabled = true;
    document.getElementById('beschreibungText').disabled = true;
    document.getElementById('beschreibungSpeichernBtn').disabled = true;
    document.querySelectorAll('.onedrive-btn').forEach(btn => btn.disabled = true);

    // Zeige Anmelde-Button wieder an
    updateButtonVisibility(null);
    pruebeLoginHinweis();
}

function restoreSessionUI() {
    document.getElementById('sessionExpiredWarning').style.display = 'none';

    // Aktiviere Felder wieder
    document.getElementById('ideeText').disabled = false;
    document.getElementById('ideeDetails').disabled = false;
    document.getElementById('mandantennummer').disabled = false;
    document.getElementById('firmenname').disabled = false;
    document.getElementById('dateien').disabled = false;
    document.getElementById('speichernBtn').disabled = false;
    document.getElementById('beschreibungText').disabled = false;
    document.getElementById('beschreibungSpeichernBtn').disabled = false;
    document.querySelectorAll('.onedrive-btn').forEach(btn => btn.disabled = false);
}

/**
 * Stellt sicher, dass ein g√ºltiges MSAL-Token vorhanden ist.
 * Versucht eine stille Erneuerung und als Fallback eine interaktive (Popup).
 * @param {boolean} interactive - Wenn true, wird bei Bedarf ein Popup zur Interaktion angezeigt.
 * @param {boolean} onSilentFail_expireSession - Wenn true und die stille Erneuerung fehlschl√§gt, wird die Sitzung als abgelaufen behandelt.
 * @returns {string|null} Das g√ºltige Access Token oder null bei Fehler.
 */
async function getValidToken(interactive = false, onSilentFail_expireSession = true) {
    if (currentLoginType !== 'microsoft' || !msalInstance) {
        if(interactive) zeigeWarnung("Bitte zuerst mit Microsoft anmelden.", "warnung");
        return null;
    }
    const account = msalInstance.getActiveAccount();
    if (!account) {
        handleExpiredSession();
        return null;
    }

    try {
        const silentResponse = await msalInstance.acquireTokenSilent({
            scopes: ["Files.ReadWrite", "User.Read", "offline_access"],
            account: account
        });
        accessToken = silentResponse.accessToken;
        console.log("Token still und erfolgreich abgerufen/erneuert.");
        restoreSessionUI(); // Stellt sicher, dass die UI nach einer stillen Erneuerung aktiv ist
        return accessToken;
    } catch (error) {
        if (error instanceof msal.InteractionRequiredAuthError) {
            if (interactive) {
                zeigeWarnung("Ihre Sitzung muss erneuert werden. Bitte best√§tigen Sie im Popup.", "info");
                try {
                    const popupResponse = await msalInstance.acquireTokenPopup({
                        scopes: ["Files.ReadWrite", "User.Read", "offline_access"],
                        account: account
                    });
                    accessToken = popupResponse.accessToken;
                    console.log("Token interaktiv erfolgreich erneuert.");
                    restoreSessionUI();
                    return accessToken;
                } catch (popupError) {
                    console.error("Fehler bei interaktiver Token-Erneuerung:", popupError);
                    handleExpiredSession(); // Wenn das Popup fehlschl√§gt, ist die Sitzung wirklich verloren
                    return null;
                }
            } else {
                console.warn("Stille Token-Erneuerung fehlgeschlagen, Interaktion erforderlich.", error);
                if (onSilentFail_expireSession) {
                     handleExpiredSession();
                }
                return null;
            }
        } else {
            console.error("Unerwarteter Fehler bei Token-Erneuerung:", error);
            handleExpiredSession();
            return null;
        }
    }
}


// --- ZENTRALE FUNKTION ZUR BUTTON-STEUERUNG (ANGEPASST) ---
function updateButtonVisibility(userEmail = null) {
    const microsoftLoginBtn = document.getElementById('microsoftLoginBtn');
    const githubLoginBtn = document.getElementById('githubLoginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const adminBtn = document.getElementById('adminButton');

    const isLoggedIn = !!userEmail;
    const isAdmin = isLoggedIn && (userEmail.toLowerCase() === adminEmail.toLowerCase());

    // Anmelde-Buttons nur zeigen, wenn ausgeloggt
    microsoftLoginBtn.style.display = isLoggedIn ? 'none' : 'inline-block';
    githubLoginBtn.style.display = isLoggedIn ? 'none' : 'inline-block';
    
    // Abmelde-Button nur zeigen, wenn eingeloggt
    logoutBtn.style.display = isLoggedIn ? 'inline-block' : 'none';
    
    // Admin-Button nur f√ºr den Admin
    adminBtn.style.display = isAdmin ? 'inline-block' : 'none';
}


// --- GITHUB LOGIN FUNKTIONEN (ANGEPASST F√úR ANTRAGS-SYSTEM) ---

function handleGithubLogin() {
    if (!githubClientId || githubClientId.includes("IHRE")) {
        zeigeWarnung("GitHub Client ID ist nicht konfiguriert.", "warnung");
        return;
    }
    const redirectUri = window.location.origin + window.location.pathname;
    const githubAuthUrl = `https://github.com/login/oauth/authorize?client_id=${githubClientId}&redirect_uri=${encodeURIComponent(redirectUri)}&scope=read:user,user:email`;
    window.location.href = githubAuthUrl;
}

async function handleGithubCallback(code) {
    // URL nach der Verarbeitung bereinigen
    window.history.replaceState({}, document.title, window.location.pathname);

    if (!tokenProxyUrl || tokenProxyUrl.includes("IHRE")) {
        zeigeWarnung("Der GitHub Token-Proxy ist nicht konfiguriert.", "warnung");
        return;
    }
    
    zeigeWarnung("GitHub-Anmeldung wird √ºberpr√ºft...", "info");
    try {
        const response = await fetch(tokenProxyUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ code: code })
        });

        const data = await response.json();

        if (!response.ok || data.error) {
            throw new Error(data.error_description || data.error || "Unbekannter Fehler beim Token-Austausch.");
        }
        
        githubAccessToken = data.access_token;
        if (!githubAccessToken) {
            throw new Error("Kein Access Token von GitHub erhalten.");
        }

        // Benutzerdaten und E-Mail von GitHub abrufen
        const [userResponse, emailsResponse] = await Promise.all([
             fetch('https://api.github.com/user', { headers: { 'Authorization': `token ${githubAccessToken}` } }),
             fetch('https://api.github.com/user/emails', { headers: { 'Authorization': `token ${githubAccessToken}` } })
        ]);

        if (!userResponse.ok || !emailsResponse.ok) {
            throw new Error("Fehler beim Abrufen der GitHub Benutzerdaten.");
        }

        const userData = await userResponse.json();
        const emailsData = await emailsResponse.json();
        
        const primaryEmail = emailsData.find(email => email.primary && email.verified);
        if (!primaryEmail) {
             throw new Error("Keine verifizierte prim√§re E-Mail-Adresse im GitHub-Konto gefunden.");
        }
        const userEmail = primaryEmail.email.toLowerCase();

        // --- NEUE LOGIK: PR√úFEN UND ANTRAG STELLEN ---
        const isAllowed = await checkUserAccess(userEmail);
        if (isAllowed) {
            // Benutzer ist berechtigt -> Normaler Login
            currentLoginType = 'github';
            aktuellerBenutzerName = userData.name || userData.login;

            // *** NEUE SESSION-LOGIK ***
            sessionStorage.setItem('loginType', 'github');
            sessionStorage.setItem('userEmail', userEmail);
            sessionStorage.setItem('userName', aktuellerBenutzerName);

            updateLoggedInUI(aktuellerBenutzerName, userEmail);
            updateButtonVisibility(userEmail);
            zeigeWarnung("Erfolgreich mit GitHub angemeldet!", 'success');
        } else {
            // Benutzer ist NICHT berechtigt -> Antrags-Prozess
            promptForAccessRequest(userData.name || userData.login, userEmail);
            // Wichtig: Token nicht speichern und UI nicht als eingeloggt anzeigen
            githubAccessToken = null;
            currentLoginType = null;
            aktuellerBenutzerName = null;
            updateButtonVisibility(null);
        }

    } catch (e) {
        zeigeWarnung("GitHub Login fehlgeschlagen: " + e.message, "warnung");
        console.error("GitHub Callback-Fehler:", e);
        githubAccessToken = null;
        currentLoginType = null;
        aktuellerBenutzerName = null;
        updateButtonVisibility(null);
    } finally {
        pruebeLoginHinweis();
    }
}

function promptForAccessRequest(userName, userEmail) {
    const message = `Hallo ${userName},\n\nIhre E-Mail-Adresse "${userEmail}" ist noch nicht f√ºr die Nutzung dieser App freigeschaltet.\n\nM√∂chten Sie jetzt eine Zugriffsanfrage an den Administrator senden?`;
    
    if (confirm(message)) {
        const subject = "Zugriffsanfrage f√ºr Ideen-App Pro";
        const body = `Hallo,\n\nbitte schalten Sie den folgenden Benutzer f√ºr die Ideen-App Pro frei:\n\nName: ${userName}\nE-Mail: ${userEmail}\n\nDiese E-Mail wurde automatisch generiert. Bitte f√ºgen Sie die E-Mail-Adresse zur userlist.json hinzu.\n\nVielen Dank!`;
        const mailtoLink = `mailto:${adminEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        
        window.location.href = mailtoLink;
        
        zeigeWarnung("Ihr E-Mail-Programm wird ge√∂ffnet, um die Anfrage zu senden.", "info");
    } else {
        zeigeWarnung("Zugriffsanfrage abgebrochen.", "info");
    }
}


// --- MICROSOFT LOGIN FUNKTION (Angepasst f√ºr "Wachhund" und Session Storage) ---

async function handleMicrosoftLogin() {
    try {
        if (!msalInstance) {
            msalInstance = new msal.PublicClientApplication(msalConfig);
        }
        const loginRequest = {
            scopes: ["Files.ReadWrite", "User.Read", "offline_access"],
            prompt: 'select_account' 
        };
        const loginResponse = await msalInstance.loginPopup(loginRequest);
        
        const account = loginResponse.account;
        const userEmail = account.username.toLowerCase();
        
        const isAllowed = await checkUserAccess(userEmail);
        if (!isAllowed) {
            blockAppAccess(); // Harter Block bleibt f√ºr MS Login
            return false;
        }
        
        const tokenResponse = await msalInstance.acquireTokenSilent({ scopes: ["Files.ReadWrite", "User.Read"], account: account });
        accessToken = tokenResponse.accessToken;
        currentLoginType = 'microsoft';
        
        aktuellerBenutzerName = account.name;
        
        // *** NEUE SESSION-LOGIK ***
        sessionStorage.setItem('loginType', 'microsoft');
        sessionStorage.setItem('userEmail', userEmail);
        sessionStorage.setItem('userName', aktuellerBenutzerName);
        sessionStorage.setItem('msalAccountIdentifier', account.homeAccountId);


        updateLoggedInUI(account.name, userEmail);
        updateButtonVisibility(userEmail); 
        restoreSessionUI(); // Stelle sicher, dass UI aktiv ist
        
        // Starte den "Wachhund"
        clearInterval(tokenRefreshIntervalId);
        tokenRefreshIntervalId = setInterval(() => getValidToken(false, true), 10 * 60 * 1000); // alle 10 Minuten
        console.log("Token-√úberwachung ('Wachhund') gestartet.");

        await loadFromOneDrive(); // Initial-Load
        
        // NEU: Stammdaten laden
        loadSharedStammdaten();
        
        return true;

    } catch (e) {
        zeigeWarnung("Microsoft Login fehlgeschlagen: " + e.message, "warnung");
        console.error("Login-Fehler:", e);
        accessToken = null;
        msalInstance = null;
        currentLoginType = null;
        aktuellerBenutzerName = null;
        updateButtonVisibility(null); 
        return false;
    } finally {
        pruebeLoginHinweis();
    }
}


// --- HILFSFUNKTIONEN F√úR LOGIN ---

function updateLoggedInUI(displayName, userEmail) {
    const userDisplay = document.getElementById('loggedInUser');
    const userIdentifier = displayName ? `${displayName} (${userEmail})` : userEmail;
    userDisplay.textContent = `(Angemeldet als: ${userIdentifier})`;
    userDisplay.style.display = 'inline';

    document.querySelector('.app-container').classList.remove('hidden');
    document.getElementById('accessDeniedMessage').style.display = 'none';
}

async function checkUserAccess(userEmail) {
    if (userEmail.toLowerCase() === adminEmail.toLowerCase()) {
        return true;
    }
    console.log(`Pr√ºfe Zugriff f√ºr: ${userEmail}`);

    if (!whitelistUrl || whitelistUrl.includes("IHR-NAME")) {
        console.warn("Whitelist-URL ist nicht konfiguriert.");
        zeigeWarnung("Fehler: Der Link zur Benutzerliste ist nicht konfiguriert.", "warnung");
        return false;
    }

    try {
        const response = await fetch(whitelistUrl, { cache: 'no-store' });
        
        if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
        }
        const userList = await response.json();
        whitelist = userList.map(email => email.toLowerCase());
        
        return whitelist.includes(userEmail.toLowerCase());

    } catch (error) {
        console.error("Fehler beim Pr√ºfen der Zugriffsberechtigung:", error);
        if (error instanceof TypeError) {
             zeigeWarnung("Zugriffs-Fehler: Der Link zur Benutzerliste wird vom Browser blockiert (CORS-Problem). Bitte verwenden Sie einen direkten Link (z.B. von GitHub Raw).", "warnung");
        } else if (error.message.includes('HTTP error')) {
             zeigeWarnung(`Zugriffs-Fehler: Die Benutzerliste konnte nicht geladen werden (${error.message}). Ist der Link korrekt und √∂ffentlich?`, "warnung");
        } else {
             zeigeWarnung("Fehler beim Pr√ºfen der Zugriffsberechtigung. Pr√ºfen Sie die Browser-Konsole f√ºr Details.", "warnung");
        }
        return false;
    }
}

function blockAppAccess() {
    document.querySelector('.app-container').classList.add('hidden');
    document.getElementById('accessDeniedMessage').style.display = 'block';
    accessToken = null;
    githubAccessToken = null;
    currentLoginType = null;
    aktuellerBenutzerName = null;
    updateButtonVisibility(null);
}

async function handleLogout(confirmFirst = true) {
    if(confirmFirst) {
        let confirmMessage = "Wirklich abmelden?";

        if (currentLoginType === 'microsoft' && msalInstance) {
            const accountToLogout = msalInstance.getActiveAccount();
            if (accountToLogout) {
                 confirmMessage = `Vom Microsoft-Konto "${accountToLogout.username}" abmelden?`;
            }
        } else if (currentLoginType === 'github') {
            confirmMessage = "Vom GitHub-Konto abmelden?";
        }

        if (!istGespeichert) {
            if (!confirm(confirmMessage + "\n\nEs gibt ungespeicherte √Ñnderungen, die verloren gehen! Trotzdem fortfahren?")) {
                return;
            }
        } else {
            if (!confirm(confirmMessage)) {
                return;
            }
        }
    }

    if (currentLoginType === 'microsoft' && msalInstance) {
        try {
            const accountToLogout = msalInstance.getActiveAccount();
            if (accountToLogout) {
                await msalInstance.logoutPopup({ account: accountToLogout });
            }
        } catch (e) {
            console.error("Microsoft Abmeldung fehlgeschlagen:", e);
        }
    }
    
    // Stoppe den "Wachhund"
    clearInterval(tokenRefreshIntervalId);
    tokenRefreshIntervalId = null;

    accessToken = null;
    githubAccessToken = null;
    msalInstance = null;
    currentLoginType = null;
    aktuellerBenutzerName = null;
    istGespeichert = true;
    updateOneDriveStatus('hidden', ''); // Status bei Abmeldung ausblenden

    // *** NEUE SESSION-LOGIK: Session Storage leeren ***
    sessionStorage.removeItem('loginType');
    sessionStorage.removeItem('userEmail');
    sessionStorage.removeItem('userName');
    sessionStorage.removeItem('msalAccountIdentifier');
    
    document.getElementById('loggedInUser').textContent = '';
    document.getElementById('loggedInUser').style.display = 'none';
    updateButtonVisibility(null);
    restoreSessionUI(); // Setzt die UI in den Ausgangszustand zur√ºck
    
    localStorage.removeItem("ideen");
    localStorage.removeItem("kategorien");
    localStorage.removeItem("benutzerliste");
    localStorage.removeItem("naechsteVorgangsnummer");
    
    initialisiereKategorien();
    initialisiereBenutzer();
    initialisiereVorgangsnummer();
    zeigeIdeen();
    pruebeLoginHinweis();
    
    if (confirmFirst) {
        zeigeWarnung("Erfolgreich abgemeldet.", 'success');
    }
}


function zeigeWarnung(msg,type='warning'){const w=document.getElementById("warnung");w.textContent=msg;w.style.display="block";w.className="";if(type==='success')w.classList.add('success-message');else if(type==='info')w.classList.add('info-message');else w.classList.add('warnung');setTimeout(()=>w.style.display="none",6e3)}

// --- Admin Panel Funktionen ---
function showAdminPanel() {
    try {
        const password = prompt("Bitte geben Sie das Administrator-Passwort ein:");
        if (password === null) return;
        if (btoa(password) === adminPasswordHash) {
            loadWhitelistForEditing();
            document.getElementById('adminPanel').style.display = 'block';
        } else {
            alert("Falsches Passwort!");
        }
    } catch(e) {
        console.error("Fehler bei der Passwortpr√ºfung (btoa wird in unsicheren Kontexten blockiert):", e);
        alert("Passwortpr√ºfung fehlgeschlagen. Stellen Sie sicher, dass die Seite √ºber HTTPS geladen wird.");
    }
}

function closeAdminPanel() {
    document.getElementById('adminPanel').style.display = 'none';
}

function loadWhitelistForEditing() {
    const storedList = localStorage.getItem('whitelist_local') || '[]';
    const userArray = JSON.parse(storedList);
    document.getElementById('whitelistEditor').value = userArray.join('\n');
}

function saveWhitelistToLocalStorage() {
    const editorValue = document.getElementById('whitelistEditor').value;
    const userArray = editorValue.split('\n').map(email => email.trim()).filter(email => email);
    localStorage.setItem('whitelist_local', JSON.stringify(userArray));
    zeigeWarnung('Liste lokal zwischengespeichert.', 'info');
}

async function saveWhitelistToOneDrive() {
    if (!(await getValidToken(true))) { 
        zeigeWarnung("Ihre Sitzung ist abgelaufen. Bitte melden Sie sich erneut an.", "warnung"); 
        return; 
    }
    
    if (currentLoginType !== 'microsoft' || !accessToken) {
        zeigeWarnung("Sie m√ºssen als Administrator mit einem Microsoft-Konto angemeldet sein.", "warnung");
        return;
    }
    const editorValue = document.getElementById('whitelistEditor').value;
    const userArray = editorValue.split('\n').map(email => email.trim()).filter(email => email);
    const userListString = JSON.stringify(userArray, null, 2);

    const whitelistPath = "/ideenapp/userlist_backup.json";
    zeigeWarnung("Speichere Backup der Benutzerliste in OneDrive...", "info");
    try {
        const url = `https://graph.microsoft.com/v1.0/me/drive/root:${whitelistPath}:/content`;
        const res = await fetch(url, {
            method: "PUT",
            headers: { "Authorization": `Bearer ${accessToken}`, "Content-Type": "application/json" },
            body: userListString
        });
        if (res.ok) {
            zeigeWarnung("Backup der Benutzerliste erfolgreich in OneDrive gespeichert!", 'success');
            alert("Hinweis: Dies hat nur ein Backup auf OneDrive gespeichert. Um die Benutzerberechtigungen live zu √§ndern, m√ºssen Sie die 'userlist.json' Datei direkt auf GitHub bearbeiten.");
            closeAdminPanel();
        } else {
            const err = await res.json().catch(() => null);
            const msg = err?.error?.message || res.statusText;
            throw new Error(msg);
        }
    } catch(e) {
        zeigeWarnung("Fehler beim Speichern des Backups: " + e.message, "warnung");
    }
}


function initialisiereKategorien(){
    let loadedKategorien = null;
    try { loadedKategorien = JSON.parse(localStorage.getItem("kategorien")); } catch (e) { console.error("Fehler beim Parsen der Kategorien:", e); localStorage.removeItem("kategorien"); }
    let kategorienHabenSichGeaendert = false;
    if (!Array.isArray(loadedKategorien)) { kategorien = [...standardKategorien]; kategorienHabenSichGeaendert = true; } else { kategorien = loadedKategorien; }
    if (kategorienHabenSichGeaendert) { localStorage.setItem("kategorien", JSON.stringify(kategorien)); }
    const selectKategorie = document.getElementById("kategorie"); selectKategorie.innerHTML = '<option value="">-- Kategorie --</option>'; if (Array.isArray(kategorien)) { kategorien.forEach(katName => selectKategorie.add(new Option(katName, katName))); }
    const filterSelectKategorie = document.getElementById("filterKategorie"); filterSelectKategorie.innerHTML = '<option value="" class="filter-option-alle">üéØ Alle Ideen</option>'; if (Array.isArray(kategorien)) { kategorien.forEach(katName => filterSelectKategorie.add(new Option(katName, katName))); }
}

function neueKategorieHinzufuegen(){const input=document.getElementById("neueKategorie");const name=input.value.trim();if(!name){zeigeWarnung("Bitte Kategorienamen eingeben.");return}kategorien=JSON.parse(localStorage.getItem("kategorien")||"[]");if(!Array.isArray(kategorien))kategorien=[...standardKategorien];if(kategorien.includes(name)){zeigeWarnung(`Kategorie "${name}" existiert bereits!`);return}kategorien.push(name);kategorien.sort();localStorage.setItem("kategorien",JSON.stringify(kategorien));triggerAutoSave();initialisiereKategorien();input.value="";input.focus();zeigeWarnung(`Kategorie "${name}" hinzugef√ºgt.`,'success');}
function kategorieLoeschen(){const sel=document.getElementById("kategorie");const name=sel.value;const noDel=["Aufgaben","Projekte","Privat","Arbeit","Sp√§ter"];if(!name||name===""){zeigeWarnung("Bitte Kategorie zum L√∂schen w√§hlen.");return}if(noDel.includes(name)){zeigeWarnung(`Standardkategorie "${name}" kann nicht gel√∂scht werden.`);return}kategorien=JSON.parse(localStorage.getItem("kategorien")||"[]");if(!Array.isArray(kategorien))kategorien=[];if(!kategorien.includes(name)){zeigeWarnung(`Kategorie "${name}" nicht gefunden.`);return}const ideen=JSON.parse(localStorage.getItem("ideen")||"[]");const count=ideen.filter(i=>i&&i.kategorie===name).length;let msg=`Kategorie "${name}" wirklich l√∂schen?`;if(count>0)msg+=` ${count} Notiz(en) verlieren diese Kategorie.`;if(!confirm(msg))return;const idx=kategorien.indexOf(name);if(idx>-1){kategorien.splice(idx,1);localStorage.setItem("kategorien",JSON.stringify(kategorien));let changed=!1;ideen.forEach(i=>{if(i&&i.kategorie===name){i.kategorie="";changed=!0}});if(changed){localStorage.setItem("ideen",JSON.stringify(ideen));}initialisiereKategorien();triggerAutoSave();const fSel=document.getElementById("filterKategorie");if(fSel.value===name)fSel.value="";zeigeWarnung(`Kategorie "${name}" gel√∂scht.`,'success');zeigeIdeen();}else{zeigeWarnung(`Interner Fehler: Kategorie "${name}" nicht gefunden.`);}}
// initialisiereBenutzer und neuenBenutzerHinzufuegen sind oben bei SHARED DATA angepasst oder ersetzt.
function neuenBenutzerHinzufuegen(){const input=document.getElementById("neuerBenutzer");const name=input.value.trim();if(!name){zeigeWarnung("Bitte Benutzernamen eingeben.");return}benutzerliste=JSON.parse(localStorage.getItem("benutzerliste")||"[]");if(!Array.isArray(benutzerliste))benutzerliste=[];if(benutzerliste.includes(name)){zeigeWarnung(`Benutzer "${name}" existiert bereits!`);return}benutzerliste.push(name);benutzerliste.sort();localStorage.setItem("benutzerliste",JSON.stringify(benutzerliste));triggerAutoSave();initialisiereBenutzer();input.value="";input.focus();zeigeWarnung(`Benutzer "${name}" hinzugef√ºgt.`,'success');}
function benutzerLoeschen(){const sel=document.getElementById("benutzer");const name=sel.value;if(!name||name===""){zeigeWarnung("Bitte Benutzer zum L√∂schen w√§hlen.");return}benutzerliste=JSON.parse(localStorage.getItem("benutzerliste")||"[]");if(!Array.isArray(benutzerliste))benutzerliste=[];if(!benutzerliste.includes(name)){zeigeWarnung(`Benutzer "${name}" nicht gefunden.`);return}if(!confirm(`Benutzer "${name}" WIRKLICH l√∂schen? ALLE Notizen dieses Benutzers werden gel√∂scht!`))return;const idx=benutzerliste.indexOf(name);if(idx>-1){benutzerliste.splice(idx,1);localStorage.setItem("benutzerliste",JSON.stringify(benutzerliste));let ideen=JSON.parse(localStorage.getItem("ideen")||"[]");const len=ideen.length;const origIdeen=JSON.parse(localStorage.getItem("ideen")||"[]");ideen=ideen.filter(i=>i&&i.benutzer!==name);const deletedCount=len-ideen.length;if(deletedCount>0){localStorage.setItem("ideen",JSON.stringify(ideen));const remM=new Set(ideen.filter(i=>i).map(i=>(i.mandantennummer||"").toLowerCase()).filter(m=>m!==""));const allM=new Set(origIdeen.filter(i=>i).map(i=>(i.mandantennummer||"").toLowerCase()).filter(m=>m!==""));let updM=!1;allM.forEach(m=>{if(!remM.has(m))updM=!0});if(updM)aktualisiereMandantenFilterDropdown()}initialisiereBenutzer();triggerAutoSave();if(filterBenutzerValue===name){filterBenutzerValue="";document.getElementById("filterBenutzer").value=""}if(bearbeiteId!==null&&!ideen.some(i=>i&&i.id===bearbeiteId)){abbrechenBearbeiten()}if(beschreibungFuerId!==null&&!ideen.some(i=>i&&i.id===beschreibungFuerId)){beschreibungAbbrechen()}zeigeWarnung(`Benutzer "${name}" und ${deletedCount} Notiz(en) gel√∂scht.`,'success');zeigeIdeen();}else{zeigeWarnung(`Interner Fehler: Benutzer "${name}" nicht gefunden.`);}}
function aktualisiereMandantenFilterDropdown(){const ideen=JSON.parse(localStorage.getItem("ideen")||"[]");if(!Array.isArray(ideen))return; const set=new Set(ideen.filter(i=>i).map(i=>(i.mandantennummer||"").trim()).filter(m=>m!==""));const list=Array.from(set).sort();const sel=document.getElementById("filterMandant");const current=sel.value;sel.innerHTML='<option value="">üè¢ Alle Mandanten</option>';list.forEach(m=>sel.add(new Option(m,m)));if(current&&list.includes(current)){sel.value=current;filterMandantValue=current}else{sel.value="";filterMandantValue=""}}
function initialisiereVorgangsnummer(){const saved=localStorage.getItem("naechsteVorgangsnummer");naechsteVorgangsnummer=saved?parseInt(saved,10):1;if(isNaN(naechsteVorgangsnummer)||naechsteVorgangsnummer<1){naechsteVorgangsnummer=1;localStorage.setItem("naechsteVorgangsnummer",naechsteVorgangsnummer.toString())}zeigeNaechsteNummer()}
function zeigeNaechsteNummer(){const el=document.getElementById("naechsteNummerAnzeige");if(el)el.textContent=naechsteVorgangsnummer}
function filterNachMandant(){filterMandantValue=document.getElementById("filterMandant").value;zeigeIdeen()}
function filterNachBenutzer(){filterBenutzerValue=document.getElementById("filterBenutzer").value;zeigeIdeen()}
function setzePrioritaet(p){prioritaet=p;["prioHoch","prioMittel","prioNiedrig"].forEach(id=>document.getElementById(id).classList.remove("selected"));if(p)document.getElementById(`prio${p}`).classList.add("selected");triggerAutoSave();}

/* --- NEU: Funktion zum Hinzuf√ºgen einer Telefonnummer-Zeile (UI) --- */
function addTelefonNummerInput(bezeichnung = '', nummer = '') {
    const container = document.getElementById('telefonNummerContainer');
    const zeile = document.createElement('div');
    zeile.className = 'telefon-nummer-zeile';
    
    // Erstellt die HTML-Struktur f√ºr eine Eingabezeile
    zeile.innerHTML = `
        <input type="text" class="telefon-bezeichnung" placeholder="Bezeichnung (z.B. Zentrale)" value="${bezeichnung.replace(/"/g, '&quot;')}">
        <input type="tel" class="telefon-nummer" placeholder="Telefonnummer" value="${nummer.replace(/"/g, '&quot;')}">
        <button type="button" class="telefon-loeschen-btn" onclick="this.parentElement.remove(); triggerAutoSave();">üóëÔ∏è</button>
    `;
    container.appendChild(zeile);
    
    // Event Listener f√ºr Auto-Save hinzuf√ºgen, wenn sich der Inhalt √§ndert
    zeile.querySelector('.telefon-bezeichnung').addEventListener('input', triggerAutoSave);
    zeile.querySelector('.telefon-nummer').addEventListener('input', triggerAutoSave);
}

/* --- NEU: Anruf-Auswahl-Dialog (Modal) Funktionen --- */
// Schlie√üt das Auswahlfenster f√ºr Telefonnummern
function closeAnrufModal() {
    document.getElementById('anrufModalOverlay').style.display = 'none';
}

// √ñffnet das Auswahlfenster und zeigt die Nummern der Idee an
async function starteAnrufDialog(ideeId, beschreibungTimestamp) {
    const ideen = JSON.parse(localStorage.getItem("ideen") || "[]");
    const idee = ideen.find(i => i && i.id === ideeId);

    if (!idee) {
        return zeigeWarnung("Fehler: Zugeh√∂rige Idee nicht gefunden.", "warnung");
    }
    
    const telefonNummern = idee.telefonNummern || [];
    if (telefonNummern.length === 0) {
        // Zeigt eine Info, wenn keine Nummern gespeichert sind
        return zeigeWarnung("F√ºr diese Idee sind keine Telefonnummern hinterlegt.", "info");
    }

    // Speichert, von wo der Anruf gestartet wurde (um den Protokolleintrag korrekt zu platzieren)
    anrufModalCallbackData = { ideeId, beschreibungTimestamp };

    const nummerListeDiv = document.getElementById('anrufModalNummerListe');
    nummerListeDiv.innerHTML = ''; // Alte Liste leeren

    if (telefonNummern.length === 1) {
        // Wenn nur eine Nummer da ist -> nicht fragen, sofort anrufen!
        await finalisiereAnruf(telefonNummern[0].nummer, telefonNummern[0].bezeichnung);
    } else {
        // Bei mehreren Nummern -> Auswahlfenster (Modal) anzeigen
        telefonNummern.forEach(tel => {
            const btn = document.createElement('button');
            btn.className = 'nummer-wahl-btn';
            btn.innerHTML = `<strong>${tel.bezeichnung || 'Ohne Bezeichnung'}</strong>${tel.nummer}`;
            // Setzt den Klick-Handler, um den Anruf mit dieser Nummer zu finalisieren
            btn.onclick = () => finalisiereAnruf(tel.nummer, tel.bezeichnung);
            nummerListeDiv.appendChild(btn);
        });
        
        document.getElementById('anrufModalTitel').textContent = `Anruf f√ºr "${idee.text}"`;
        document.getElementById('anrufModalOverlay').style.display = 'flex';
    }
}

// Wird aufgerufen, wenn eine Nummer ausgew√§hlt wurde (oder wenn es nur eine gab)
async function finalisiereAnruf(nummer, bezeichnung) {
    const { ideeId, beschreibungTimestamp } = anrufModalCallbackData;
    if (!ideeId) {
        return zeigeWarnung("Fehler: Anruf-Kontext verloren.", "warnung");
    }

    closeAnrufModal(); // Dialog schlie√üen

    const anrufZeit = new Date().toLocaleString("de-DE");
    const protokollText = `Anruf an "${bezeichnung || 'Unbekannt'}" (${nummer}) gestartet am ${anrufZeit}.`;

    // F√ºgt einen Protokolleintrag (als "Beschreibung") hinzu
    addProtokollEintrag(ideeId, beschreibungTimestamp, protokollText);
    
    // UI aktualisieren, damit der neue Eintrag sofort sichtbar ist
    zeigeIdeen(); 

    // Speichern in der Cloud (OneDrive) ausl√∂sen
    // Wichtig: Wir warten NICHT auf das Speichern, der Anruf soll sofort erfolgen.
    // triggerAutoSave() l√∂st das Speichern mit Verz√∂gerung aus.
    // F√ºr sofortiges Speichern VOR dem Verlassen der Seite (was tel: tut):
    await saveToOneDrive();
    
    // Erst jetzt den Anruf-Link (tel:) ausf√ºhren, der die App verlassen k√∂nnte
    window.location.href = 'tel:' + nummer.replace(/[^0-9+]/g, ''); // Bereinigt die Nummer
}

async function speichereIdee() {
    const text = document.getElementById("ideeText").value.trim();
    if (!text) return zeigeWarnung("Titel ist erforderlich!");

    const fileInput = document.getElementById("dateien");
    let neuHochgeladeneDateien = [];

    if (fileInput.files.length > 0) {
        if (currentLoginType === 'microsoft') {
            if (!(await getValidToken(true))) { 
                zeigeWarnung("Sitzung abgelaufen. Bitte anmelden, um Dateien hochzuladen.", "warnung"); 
                return; 
            }
            
            zeigeWarnung("Lade Dateien hoch...", 'info');
            try {
                neuHochgeladeneDateien = await Promise.all(Array.from(fileInput.files).map(async f => {
                    const link = await uploadToOneDrive(f);
                    return { id: generateUUID(), name: f.name, link: link, type: f.type, sichtbar: true };
                }));
                neuHochgeladeneDateien = neuHochgeladeneDateien.filter(f => f && f.link);
                zeigeWarnung("Upload fertig.", 'success');
            } catch (e) {
                zeigeWarnung("Upload Fehler: " + e.message);
                neuHochgeladeneDateien = [];
            }
        } else {
             if (currentLoginType === 'github') {
                   zeigeWarnung("Dateianh√§nge sind nur mit Microsoft-Login m√∂glich. Dateien werden lokal vermerkt.", "info");
             }
            neuHochgeladeneDateien = Array.from(fileInput.files).map(f => ({
                id: generateUUID(), name: f.name, type: f.type, sichtbar: true, isLocal: true
            }));
        }
    }

    let finaleDateiliste = [];
    if (bearbeiteId !== null) {
        const ideen = JSON.parse(localStorage.getItem("ideen") || "[]");
        const idee = ideen.find(i => i && i.id === bearbeiteId);
        if (idee && idee.dateien) {
             finaleDateiliste = idee.dateien.filter(alt => alt && alt.id && !neuHochgeladeneDateien.some(neu => neu.name === alt.name));
        }
        finaleDateiliste = finaleDateiliste.concat(neuHochgeladeneDateien);
    } else {
        finaleDateiliste = neuHochgeladeneDateien;
    }
    saveIdeeObjekt(text, finaleDateiliste);
    fileInput.value = "";
}

/**
 * Speichert eine neue Idee oder aktualisiert eine bestehende.
 * JETZT AKTUALISIERT: Sammelt auch Telefonnummern.
 */
function saveIdeeObjekt(text, dateien) {
    let ideen = JSON.parse(localStorage.getItem("ideen") || "[]");
    const details = document.getElementById("ideeDetails").value;
    const kat = document.getElementById("kategorie").value;
    const mnr = document.getElementById("mandantennummer").value.trim();
    const firma = document.getElementById("firmenname").value.trim();
    const user = document.getElementById("benutzer").value;

    // --- NEUER TEIL ---
    // Sammelt alle eingegebenen Telefonnummern aus dem Formular
    const telefonNummern = [];
    document.querySelectorAll('#telefonNummerContainer .telefon-nummer-zeile').forEach(zeile => {
        const bezeichnung = zeile.querySelector('.telefon-bezeichnung').value.trim();
        const nummer = zeile.querySelector('.telefon-nummer').value.trim();
        if (nummer) { // Nur speichern, wenn eine Nummer vorhanden ist
            telefonNummern.push({ bezeichnung: bezeichnung, nummer: nummer });
        }
    });
    // --- ENDE NEUER TEIL ---

    const prozessierteDateien = dateien.filter(d => d && d.id).map(d => ({
        id: d.id, name: d.name, link: d.link || null, type: d.type,
        sichtbar: typeof d.sichtbar === 'boolean' ? d.sichtbar : true
    }));
    
    let finalDetails = details;
    const MAX_DETAILS_LENGTH = 20000;
    if (finalDetails.length > MAX_DETAILS_LENGTH) {
        finalDetails = finalDetails.substring(0, MAX_DETAILS_LENGTH);
        zeigeWarnung("Die Hauptbeschreibung war sehr lang und wurde gek√ºrzt.", "info");
    }
    finalDetails = finalDetails.trim();


    if (bearbeiteId !== null) {
        // Idee aktualisieren
        const idx = ideen.findIndex(i => i && i.id === bearbeiteId);
        if (idx !== -1) {
            const old = ideen[idx];
            const erinnerung = old.erinnerung || getDefaultErinnerung(text, old.vorgangsnummer);
            erinnerung.titel = text; 
            erinnerung.vorgangsnummer = old.vorgangsnummer;

            // 'telefonNummern' zum Update-Objekt hinzugef√ºgt
            ideen[idx] = { ...old, text, details: finalDetails, kategorie: kat, prioritaet, mandantennummer: mnr, telefonNummern: telefonNummern, firmenname: firma, benutzer: user, dateien: prozessierteDateien, erinnerung: erinnerung };
            localStorage.setItem("ideen", JSON.stringify(ideen));
            bearbeiteId = null; 
            document.getElementById("speichernBtn").textContent = "üíæ Speichern"; 
            document.getElementById("abbrechenBtn").style.display = "none";
        } else { zeigeWarnung("Fehler: Idee nicht gefunden."); return; }
    } else {
        // Neue Idee erstellen
        const num = naechsteVorgangsnummer;
        const erinnerung = getDefaultErinnerung(text, num);

        const neu = { 
            id: generateUUID(), 
            vorgangsnummer: num, 
            text, 
            details: finalDetails, 
            kategorie: kat, 
            prioritaet, 
            mandantennummer: mnr, 
            telefonNummern: telefonNummern, // 'telefonNummern' beim Erstellen hinzugef√ºgt
            firmenname: firma, 
            benutzer: user, 
            dateien: prozessierteDateien, 
            timestamp: new Date().toISOString(), 
            erledigt: false, 
            beschreibungen: [], 
            erinnerung: erinnerung,
            ersteller: aktuellerBenutzerName || "Unbekannt"
        };
        ideen.push(neu);
        localStorage.setItem("ideen", JSON.stringify(ideen));
        naechsteVorgangsnummer++; 
        localStorage.setItem("naechsteVorgangsnummer", naechsteVorgangsnummer.toString()); 
        zeigeNaechsteNummer();
    }
    
    aktualisiereMandantenFilterDropdown(); 
    zeigeIdeen();
    
    // Formularfelder zur√ºcksetzen
    document.getElementById("ideeText").value = ""; 
    document.getElementById("ideeDetails").value = ""; 
    document.getElementById("mandantennummer").value = ""; 
    document.getElementById("firmenname").value = ""; 
    document.getElementById("dateien").value = ""; 
    document.getElementById("dateiVorschau").innerHTML = "";
    document.getElementById("telefonNummerContainer").innerHTML = ""; // NEU: Telefon-Container leeren
    document.getElementById("telefonNummerContainerVorschau").style.display = "none"; // NEU: Vorschau ausblenden
    
    setzePrioritaet(""); 
    document.getElementById("benutzer").value = ""; 
    document.getElementById("kategorie").value = "";
    selectedUserEmail = null; // Reset
    
    triggerAutoSave();
}


/**
 * Stellt die Liste der Ideen auf der Seite dar.
 * JETZT AKTUALISIERT: F√ºgt den Anruf-Button (üìû) bei Beschreibungen hinzu.
 * JETZT AKTUALISIERT: Zeigt Telefonnummern in der Hauptansicht an.
 * JETZT AKTUALISIERT: Zeigt Dateiendungen bei Audio-Dateien an.
 */
function zeigeIdeen() {
    let fIdeen = [];
    try { fIdeen = JSON.parse(localStorage.getItem("ideen") || "[]"); } catch(e) { console.error("Fehler beim Laden der Ideen:", e); localStorage.removeItem("ideen"); fIdeen = []; }
    if (!Array.isArray(fIdeen)) fIdeen = [];

    let filtered = fIdeen.filter(i => i && i.id); 

    /* ANFANG √ÑNDERUNG: Filter-Logik f√ºr Vorgangsnummer */
    const fNummer = document.getElementById("filterVorgangsnummer")?.value;
    if (fNummer) {
        filtered = filtered.filter(i => i.vorgangsnummer == fNummer);
    }
    /* ENDE √ÑNDERUNG */

    // ... (Filter- und Sortierlogik bleibt unver√§ndert) ...
    const fKat=document.getElementById("filterKategorie")?.value;if(fKat)filtered=filtered.filter(i=>i.kategorie===fKat);
    filterMandantValue=document.getElementById("filterMandant")?.value;if(filterMandantValue)filtered=filtered.filter(i=>(i.mandantennummer||"").toLowerCase()===filterMandantValue.toLowerCase());
    filterBenutzerValue=document.getElementById("filterBenutzer")?.value;if(filterBenutzerValue)filtered=filtered.filter(i=>(i.benutzer||"").toLowerCase()===filterBenutzerValue.toLowerCase());
    const fArchiv=document.getElementById("filterArchiv")?.value;if(fArchiv==="nicht_erledigt")filtered=filtered.filter(i=>!(i.erledigt||false));else if(fArchiv==="erledigt")filtered=filtered.filter(i=>(i.erledigt||false));

    const sort=document.getElementById("sortierung")?.value;if(sort && sort!=="standard"){filtered.sort((a,b)=>{if (!a || !b) return 0; if(sort==="prio"){const p={"Hoch":3,"Mittel":2,"Niedrig":1};return(p[b.prioritaet]||0)-(p[a.prioritaet]||0)}let tA=-Infinity,tB=-Infinity;try{tA=new Date(a.timestamp?.split('_')[0]).getTime();if(isNaN(tA))tA=(sort==="neu"?-Infinity:Infinity)}catch(e){tA=(sort==="neu"?-Infinity:Infinity)}try{tB=new Date(b.timestamp?.split('_')[0]).getTime();if(isNaN(tB))tB=(sort==="neu"?-Infinity:Infinity)}catch(e){tB=(sort==="neu"?-Infinity:Infinity)}if(sort==="neu")return tB-tA;if(sort==="alt")return tA-tB;return 0})}

    // Helper-Funktion zum Extrahieren der Dateiendung
    const getFileExtension = (filename) => {
        if (!filename || !filename.includes('.')) return '';
        const ext = filename.split('.').pop();
        return ext ? `.${ext}` : '';
    };

    const listDiv = document.getElementById("ideenListe");
    listDiv.innerHTML = filtered.map(idee => {
      try { 
        const id = idee.id;
        const erledigt = idee.erledigt || false;
        let datum = getFormattedDate(idee.timestamp);
        const vNumHtml = idee.vorgangsnummer ? `<div class="vorgangsnummer-anzeige-liste">Vorgang: <b>${idee.vorgangsnummer}</b></div>` : '';
        const erstellerHtml = idee.ersteller ? `<small>Erstellt von: <b>${idee.ersteller.replace(/</g, "&lt;")}</b></small><br>` : '';

        let dateiHtml = "";
        if (idee.dateien && idee.dateien.length > 0) {
            // ... (Datei-HTML-Logik) ...
            dateiHtml = idee.dateien.filter(f => f && f.id).map(f => {
                const url = f.link || '#'; const istSichtbar = f.sichtbar === true; const anhangKlasse = istSichtbar ? "" : " anhang-veraltet"; const anhangPraefix = istSichtbar ? "" : "[Veraltet] ";
                const icon = f.link ? 'üåê' : 'üìé'; const buttonSymbol = istSichtbar ? 'üëÅÔ∏è' : 'üôà'; const buttonTitle = istSichtbar ? 'Anhang ausblenden' : 'Anhang einblenden';
                
                let anhangElementHtml = '';

                // --- NEUE AUDIO-PLAYER-LOGIK (mit Dateiendung) ---
                if (f.type && f.type.startsWith('audio/') && f.link && f.link.includes('onedrive.live.com/redir?')) {
                    const embedUrl = f.link.replace('/redir?', '/embed?');
                    const fileExt = getFileExtension(f.name); // Dateiendung holen
                    
                    anhangElementHtml = `
                        <div style="margin-bottom: 5px; width: 100%;">
                            <span class="datei-info" style="font-size: 0.9em; font-weight: bold; display: block; margin-bottom: 3px;">
                                ${icon} ${anhangPraefix}${f.name || 'Unbekannt'}
                            </span>
                            <audio controls style="width: 100%; height: 40px;" preload="metadata">
                                <source src="${embedUrl}" type="${f.type}">
                                Ihr Browser unterst√ºtzt dieses Audio-Format nicht (${fileExt}).
                            </audio>
                        </div>
                    `;
                } else {
                    // Fallback: Die Bisherige-Link-Anzeige
                    anhangElementHtml = `
                        <a class="datei-link" href="${url}" target="_blank" title="${f.name || ''}">${icon} ${anhangPraefix}${f.name || 'Unbekannt'}</a>
                        <span class="datei-info" style="font-size:0.8em; color: #555; margin-left: 5px;"> (${f.link ? 'OneDrive' : 'Lokal'})</span>
                    `;
                }
                // --- ENDE NEUE LOGIK ---

                return `<div class="anhang-eintrag${anhangKlasse}" style="margin-bottom: 3px; display: flex; align-items: center; flex-wrap: wrap;">
                            <div style="flex-grow: 1; min-width: 200px; max-width: 100%;">${anhangElementHtml}</div>
                            <button class="toggle-anhang-sichtbarkeit-btn" title="${buttonTitle}" onclick="toggleAnhangSichtbarkeit('${id}', '${f.id}')" style="margin-left: auto; flex-shrink: 0;">${buttonSymbol}</button>
                        </div>`;
            }).join("");
            if (dateiHtml) { dateiHtml = `<div class="anhaenge-liste" style="margin-top: 8px; display: flex; flex-direction: column; align-items: flex-start;"><b>Anh√§nge:</b>${dateiHtml}</div>`; }
        
        }
        
        // --- NEUER TEIL: Telefonnummern-HTML-Anzeige ---
        let telefonNummernHtml = "";
        if (idee.telefonNummern && idee.telefonNummern.length > 0) {
            telefonNummernHtml = `<div class="telefon-nummer-anzeige-liste"><b>Telefonnummern:</b>${
                idee.telefonNummern.map(tel => {
                    return `<span class="telefon-nummer-anzeige-item"><strong>${tel.bezeichnung || 'Ohne Bez.'}:</strong> ${tel.nummer}</span>`;
                }).join("")
            }</div>`;
        }
        // --- ENDE NEUER TEIL ---

        const beschreibungenHtml = idee.beschreibungen?.length ? `<div class="beschreibung-historie"><b>Weitere Beschr.:</b>${
            idee.beschreibungen.filter(b => b && b.text !== undefined).map(b => {
                // ... (Logik f√ºr Beschreibungstext, Anh√§nge, Erinnerungen) ...
                const autorInfo = b.autor ? ` von <b>${b.autor.replace(/</g, "&lt;")}</b>` : "";
                let btsText = `${getFormattedDate(b.timestamp)}${autorInfo}`; 
                
                const indentLevel = b.level || 0; const indentMargin = indentLevel * 20; const itemWidth = `calc(100% - ${indentMargin}px)`;
                const istSichtbar = b.sichtbar === true; const beschreibungKlasse = istSichtbar ? "" : " beschreibung-veraltet"; const sichtbarkeitButtonSymbol = istSichtbar ? 'üëÅÔ∏è' : 'üôà';
                const sichtbarkeitButtonTitle = istSichtbar ? 'Beschreibung ausblenden' : 'Beschreibung einblenden'; const praefix = istSichtbar ? "" : "[Ausgeblendet] ";
                const sanierterBeschreibungstext = (b.text || "").replace(/</g, "&lt;").replace(/>/g, "&gt;");
                
                let beschreibungAnhaengeHtml = "";
                if (b.attachments && b.attachments.length > 0) {
                    beschreibungAnhaengeHtml = `<div class="beschreibung-anhaenge">${
                        b.attachments.map(anhang => {
                            const anhangUrl = anhang.link || '#';
                            const anhangIcon = anhang.link ? 'üåê' : 'üìé';

                            // --- NEUE AUDIO-PLAYER-LOGIK (BESCHR. mit Dateiendung) ---
                            if (anhang.type && anhang.type.startsWith('audio/') && anhangUrl.includes('onedrive.live.com/redir?')) {
                                const embedUrl = anhangUrl.replace('/redir?', '/embed?');
                                const fileExt = getFileExtension(anhang.name); // Dateiendung holen
                                return `<div class="beschreibung-anhang-item" style="display: block; margin-top: 5px;">
                                            <span style="font-size: 0.95em; display: block; margin-bottom: 3px;">${anhangIcon} ${anhang.name || 'Unbekannt'}</span>
                                            <audio controls style="width: 100%; height: 35px;" preload="metadata">
                                                <source src="${embedUrl}" type="${anhang.type}">
                                                Browser unterst√ºtzt Audio nicht (${fileExt}).
                                            </audio>
                                        </div>`;
                            } else {
                                // Fallback: Bisherige-Link-Anzeige
                                return `<div class="beschreibung-anhang-item">
                                            <a href="${anhangUrl}" target="_blank" title="${anhang.name || ''}">${anhangIcon} ${anhang.name || 'Unbekannt'}</a>
                                        </div>`;
                            }
                            // --- ENDE NEUE LOGIK (BESCHR.) ---
                        }).join('')
                    }</div>`;
                }

                let beschreibungErinnerungHtml = "";
                if (b.erinnerung && b.erinnerung.aktiv) {
                    let erinnerungText = `üîî Erinnerung: ${getFormattedDate(b.erinnerung.termin)}`;
                     if (b.erinnerung.intervallTyp !== 'einmalig') {
                         erinnerungText += `, Intervall: ${b.erinnerung.intervallTyp}`;
                          if(b.erinnerung.intervallTyp === 'tage' && b.erinnerung.intervallWert) {
                               erinnerungText += ` (${b.erinnerung.intervallWert} Tage)`;
                          }
                    }
                    beschreibungErinnerungHtml = `<div class="beschreibung-erinnerung-info">${erinnerungText}</div>`;
                } else if (b.erinnerung && !b.erinnerung.aktiv && b.erinnerung.termin) {
                    beschreibungErinnerungHtml = `<div class="beschreibung-erinnerung-info" style="opacity:0.6;">üîî Erinnerung (inaktiv): ${getFormattedDate(b.erinnerung.termin)}</div>`;
                }


                // --- AKTUALISIERTER TEIL (üìû Symbol UND ‚Ü≥ Symbol) ---
                return `<div class="beschreibung-item${beschreibungKlasse}" style="margin-left: ${indentMargin}px; width: ${itemWidth};">
                            <div class="beschreibung-text-zeit">
                                <span class="beschreibung-zeit">${btsText}</span>${praefix}${sanierterBeschreibungstext}
                                ${beschreibungAnhaengeHtml}
                                ${beschreibungErinnerungHtml}
                            </div>
                            <div class="beschreibung-item-actions">
                                <button class="edit-beschreibung-btn" title="Bearbeiten" onclick="bearbeiteEinzelneBeschreibung('${id}','${b.timestamp}')">‚úèÔ∏è</button>
                                <button class="add-anhang-beschreibung-btn" title="Antworten" onclick="zeigeBeschreibungAntwortDialog('${id}','${b.timestamp}')">‚Ü≥</button>
                                <button class="add-anhang-beschreibung-btn" title="Anruf starten" onclick="starteAnrufDialog('${id}','${b.timestamp}')">üìû</button>
                                <button class="move-beschreibung-btn" title="Nach oben" onclick="verschiebeBeschreibung('${id}','${b.timestamp}', -1)">‚¨ÜÔ∏è</button>
                                <button class="move-beschreibung-btn" title="Nach unten" onclick="verschiebeBeschreibung('${id}','${b.timestamp}', 1)">‚¨áÔ∏è</button>
                                <button class="move-beschreibung-btn" title="Ausr√ºcken" onclick="aendereEinrueckungBeschreibung('${id}','${b.timestamp}', -1)" ${indentLevel === 0 ? 'disabled' : ''}>‚¨ÖÔ∏è</button>
                                <button class="move-beschreibung-btn" title="Einr√ºcken" onclick="aendereEinrueckungBeschreibung('${id}','${b.timestamp}', 1)">‚û°Ô∏è</button>
                                <button class="add-anhang-beschreibung-btn" title="Anhang" onclick="starteAnhangUploadFuerBeschreibung('${id}','${b.timestamp}')">üìé</button>
                                <button class="add-anhang-beschreibung-btn" title="Erinnerung" onclick="zeigeBeschreibungErinnerungDialog('${id}','${b.timestamp}')">üîî</button>
                                <button class="add-anhang-beschreibung-btn" title="Termin erstellen" onclick="zeigeBeschreibungTerminDialog('${id}','${b.timestamp}')">üóìÔ∏è</button>
                                <button class="add-anhang-beschreibung-btn" title="Per E-Mail teilen" onclick="teileBeschreibungPerEmail('${id}','${b.timestamp}')">‚úâÔ∏è</button>
                                <button class="add-anhang-beschreibung-btn" title="Per WhatsApp teilen" onclick="teileBeschreibungPerWhatsApp('${id}','${b.timestamp}')">üì±</button>
                                <button class="toggle-beschreibung-sichtbarkeit-btn" title="${sichtbarkeitButtonTitle}" onclick="toggleBeschreibungSichtbarkeit('${id}', '${b.timestamp}')">${sichtbarkeitButtonSymbol}</button>

                            </div>
                        </div>`;
                // --- ENDE AKTUALISIERTER TEIL ---
            }).join("")
        }</div>` : "";

        let erinnerungHtml = "";
        // ... (Logik f√ºr Haupt-Erinnerung) ...
        if (idee.erinnerung && idee.erinnerung.aktiv) {
            let erinnerungText = `üîî Erinnerung: ${getFormattedDate(idee.erinnerung.termin)}`;
            if (idee.erinnerung.intervallTyp !== 'einmalig') {
                erinnerungText += `, Intervall: ${idee.erinnerung.intervallTyp}`;
                if(idee.erinnerung.intervallTyp === 'tage' && idee.erinnerung.intervallWert) {
                    erinnerungText += ` (${idee.erinnerung.intervallWert} Tage)`;
                }
            }
            erinnerungHtml = `<div class="erinnerung-info">${erinnerungText}</div>`;
        } else if (idee.erinnerung && !idee.erinnerung.aktiv && idee.erinnerung.termin) {
             erinnerungHtml = `<div class="erinnerung-info" style="opacity:0.6;">üîî Erinnerung (inaktiv): ${getFormattedDate(idee.erinnerung.termin)}</div>`;
        }


        const sanierterIdeeText = (idee.text || 'Ohne Titel').replace(/</g, "&lt;").replace(/>/g, "&gt;");
        const sanierterIdeeDetails = (idee.details || "").replace(/</g, "&lt;").replace(/>/g, "&gt;");
        
        // --- AKTUALISIERTER TEIL (Telefonnummern-HTML eingef√ºgt) ---
        return `<div class="idee${erledigt ? ' erledigt' : ''}" data-idee-id="${id}">
                    <div class="idee-content">
                        ${vNumHtml}<h3>${sanierterIdeeText}</h3><p>${sanierterIdeeDetails}</p>
                        ${idee.benutzer ? `<div>Zust.: <b>${idee.benutzer}</b></div>` : ""} ${idee.mandantennummer ? `<div>Mandant: <b>${idee.mandantennummer}</b></div>` : ""} ${idee.firmenname ? `<div>Firma: <b>${idee.firmenname}</b></div>` : ""}
                        ${telefonNummernHtml}
                        ${beschreibungenHtml}
                        <small>${idee.kategorie || '-'} | ${idee.prioritaet || "-"} | ${datum}</small><br>
                        ${erstellerHtml}
                        ${erinnerungHtml}
                        ${dateiHtml}
                        <div class="idee-actions">
                            <button onclick="verschiebeIdee('${id}',-1)">‚¨ÜÔ∏è</button>
                            <button onclick="verschiebeIdee('${id}',1)">‚¨áÔ∏è</button>
                            <button onclick="bearbeiteIdee('${id}')">‚úèÔ∏è</button>
                            <button onclick="toggleErledigt('${id}')">${erledigt ? "‚Ü©Ô∏è" : "‚úîÔ∏è"}</button>
                            <button onclick="loescheIdee('${id}')">üóëÔ∏è</button>
                            <button onclick="zeigeBeschreibungDialog('${id}')">+ Beschr</button>
                            <button onclick="zeigeErinnerungDialog('${id}')">üîî Erinnerung</button>
                            <button onclick="zeigeTerminDialog('${id}')">üóìÔ∏è Termin</button> 
                        </div>
                    </div>
                    <input type="checkbox" class="idee-checkbox" onchange="toggleAuswahl('${id}',this)" ${ausgewaehlt.includes(id) ? "checked" : ""}>
                </div>`;
      } catch (e) {
        // ... (Error-Handling) ...
        console.error("Fehler beim Darstellen einer Idee (m√∂glicherweise korrupte Daten):", idee, e);
        if (idee && idee.id) {
            return `<div class="idee erledigt" data-idee-id="${id}">
                        <div class="idee-content">
                            <h3>Fehlerhafte Idee (ID: ${idee.id})</h3>
                            <p>Diese Idee konnte nicht korrekt geladen werden. Bitte √ºberpr√ºfen Sie die Daten oder l√∂schen Sie den Eintrag.</p>
                            <p>Fehlermeldung: ${e.message}</p>
                            <div class="idee-actions">
                                 <button onclick="loescheIdee('${idee.id}')">üóëÔ∏è Diesen Eintrag l√∂schen</button>
                            </div>
                        </div>
                         <input type="checkbox" class="idee-checkbox" style="display:none;">
                        </div>`;
        }
        return ""; 
      
      }
    }).join("");

    if (bearbeiteId !== null && !filtered.some(i => i && i.id === bearbeiteId)) abbrechenBearbeiten();
    if (beschreibungFuerId !== null && !filtered.some(i => i && i.id === beschreibungFuerId)) beschreibungAbbrechen();
    if (erinnerungFuerId !== null && !filtered.some(i => i && i.id === erinnerungFuerId)) erinnerungAbbrechen();
    if (terminFuerId !== null && !filtered.some(i => i && i.id === terminFuerId)) terminDialogAbbrechen();
}

function toggleErledigt(id){
    let ideen=JSON.parse(localStorage.getItem("ideen")||"[]");
    const idx=ideen.findIndex(i=>i&&i.id===id);
    if(idx!==-1){
        ideen[idx].erledigt=!(ideen[idx].erledigt||!1);
        if(ideen[idx].erledigt && ideen[idx].erinnerung && ideen[idx].erinnerung.aktiv) {
            ideen[idx].erinnerung.aktiv = false; 
        }
        localStorage.setItem("ideen",JSON.stringify(ideen));
        zeigeIdeen();
        triggerAutoSave();
    }
}

/**
 * √ñffnet eine Idee zum Bearbeiten im oberen Formular.
 * JETZT AKTUALISIERT: F√ºllt auch die Telefonnummern-Felder.
 */
function bearbeiteIdee(id){
    const ideen=JSON.parse(localStorage.getItem("ideen")||"[]");
    const idee=ideen.find(i=>i&&i.id===id);
    if(!idee){zeigeWarnung("Fehler: Idee nicht gefunden.");return}
    
    document.getElementById("ideeText").value=idee.text;
    document.getElementById("ideeDetails").value=idee.details||"";
    document.getElementById("kategorie").value=idee.kategorie||"";
    document.getElementById("mandantennummer").value=idee.mandantennummer||"";
    document.getElementById("firmenname").value=idee.firmenname||"";
    document.getElementById("benutzer").value=idee.benutzer||"";
    setzePrioritaet(idee.prioritaet||"");
    bearbeiteId=id;

    // --- NEUER TEIL ---
    // F√ºllt die Telefonnummern-Eingabefelder f√ºr die Bearbeitung
    const telContainer = document.getElementById("telefonNummerContainer");
    telContainer.innerHTML = ''; // Zuerst leeren
    const telVorschau = document.getElementById("telefonNummerContainerVorschau");
    telVorschau.style.display = 'none'; // Vorschau im Bearbeiten-Modus ausblenden

    if (idee.telefonNummern && Array.isArray(idee.telefonNummern)) {
        idee.telefonNummern.forEach(tel => {
            addTelefonNummerInput(tel.bezeichnung, tel.nummer);
        });
    }
    // --- ENDE NEUER TEIL ---

    const v=document.getElementById("dateiVorschau");
    v.innerHTML="";
    if(idee.dateien){
        idee.dateien.filter(f=>f&&f.id).forEach(f=>{
            const url=f.link;
            if(url){
                const istVeraltet = f.sichtbar===false; 
                v.innerHTML+=`<div style="display:inline-block;margin:5px;text-align:center;max-width:150px;vertical-align:top; ${istVeraltet?'opacity:0.6;':''}"><a href="${url}" target="_blank" title="${f.name}" style="${istVeraltet?'text-decoration:line-through;':''}">${f.type?.startsWith("image/")?'<img src="'+url+'" style="max-height:80px;display:block;margin:auto;object-fit:cover;">':''}${f.type==="application/pdf"?'<iframe src="'+url+'" style="width:100%;height:80px;border:1px solid #ccc;"></iframe>':''}${!f.type?.startsWith("image/")&&f.type!=="application/pdf"?'<span style="font-size:2em;display:block;">'+(f.link?'üåê':'üìé')+'</span>':''}<span style="font-size:.8em;word-break:break-all;display:block;">${f.name}</span></a><div style="font-size:.7em;color:grey;">${f.link?'OneDrive':'Lokal'} (${f.sichtbar?'Sichtbar':'Veraltet'})</div></div>`
            }
        });
    }
    document.getElementById("speichernBtn").textContent="üíæ Aktualisieren";
    document.getElementById("abbrechenBtn").style.display="";
    istGespeichert=false
}

/**
 * Bricht den Bearbeitungsmodus ab und leert das Formular.
 * JETZT AKTUALISIERT: Leert auch die Telefon-Felder.
 */
function abbrechenBearbeiten(){
    bearbeiteId=null;
    document.getElementById("ideeText").value="";
    document.getElementById("ideeDetails").value="";
    document.getElementById("mandantennummer").value="";
    document.getElementById("firmenname").value="";
    document.getElementById("dateien").value="";
    document.getElementById("dateiVorschau").innerHTML="";
    
    // --- NEUER TEIL ---
    document.getElementById("telefonNummerContainer").innerHTML = ""; 
    document.getElementById("telefonNummerContainerVorschau").style.display = "none";
    // --- ENDE NEUER TEIL ---
    
    document.getElementById("speichernBtn").textContent="üíæ Speichern";
    document.getElementById("abbrechenBtn").style.display="none";
    setzePrioritaet("");
    document.getElementById("benutzer").value="";
    document.getElementById("kategorie").value="";
    selectedUserEmail = null; // Reset
} 

function verschiebeIdee(id,dir){let ideen=JSON.parse(localStorage.getItem("ideen")||"[]");const idx=ideen.findIndex(i=>i&&i.id===id);if(idx===-1)return;const targetIdx=idx+dir;if(targetIdx>=0&&targetIdx<ideen.length){[ideen[idx],ideen[targetIdx]]=[ideen[targetIdx],ideen[idx]];localStorage.setItem("ideen",JSON.stringify(ideen));zeigeIdeen();triggerAutoSave();}}
function loescheIdee(id){if(!confirm("Wirklich l√∂schen?"))return;let ideen=JSON.parse(localStorage.getItem("ideen")||"[]");const idx=ideen.findIndex(i=>i&&i.id===id);if(idx!==-1){const del=ideen[idx];ideen.splice(idx,1);localStorage.setItem("ideen",JSON.stringify(ideen));const mExists=ideen.some(i=>i&&i.mandantennummer&&(i.mandantennummer||"").toLowerCase()===(del.mandantennummer||"").toLowerCase());const uExists=ideen.some(i=>i&&i.benutzer&&(i.benutzer||"").toLowerCase()===(del.benutzer||"").toLowerCase());if(!mExists&&del.mandantennummer)aktualisiereMandantenFilterDropdown();if(!uExists&&del.benutzer)aktualisiereBenutzerDropdowns();ausgewaehlt=ausgewaehlt.filter(i=>i!==id);if(bearbeiteId===id)abbrechenBearbeiten();if(beschreibungFuerId===id)beschreibungAbbrechen(); if(erinnerungFuerId===id)erinnerungAbbrechen(); if(terminFuerId===id)terminDialogAbbrechen(); zeigeIdeen();triggerAutoSave();}else{zeigeWarnung("Fehler: Idee nicht gefunden.");}}

function zeigeBeschreibungDialog(id,ts=null){
    beschreibungFuerId=id;
    beschreibungZuBearbeitenderTimestamp=ts;
    beschreibungAntwortAufTimestamp = null; // NEU: Zur√ºcksetzen, da dies "Bearbeiten" oder "Neu (Level 0)" ist
    const area=document.getElementById("beschreibungText");
    if(ts!==null){
        const ideen=JSON.parse(localStorage.getItem("ideen")||"[]");
        const idee=ideen.find(i=>i&&i.id===id);
        const desc=idee?.beschreibungen?.find(b=>b&&b.timestamp===ts);
        if(desc)area.value=desc.text;
        else{zeigeWarnung("Fehler: Beschreibung nicht gefunden.");beschreibungAbbrechen();return}
    }else{
        area.value=""
    }
    document.getElementById("beschreibungDialog").style.display="block";
    area.focus();
    istGespeichert=false
}

// NEU: Diese Funktion wird vom "Antworten" (‚Ü≥) Button aufgerufen
function zeigeBeschreibungAntwortDialog(id, elternTimestamp) {
    beschreibungFuerId = id;
    beschreibungZuBearbeitenderTimestamp = null; // Wir bearbeiten nicht
    beschreibungAntwortAufTimestamp = elternTimestamp; // Wir merken uns die Eltern-ID
    
    const area = document.getElementById("beschreibungText");
    area.value = ""; // Textfeld leeren f√ºr die neue Antwort
    area.placeholder = "Antwort auf Beschreibung..."; // Optional: Platzhalter √§ndern

    document.getElementById("beschreibungDialog").style.display = "block";
    area.focus();
    istGespeichert = false;
}

function beschreibungAbbrechen(){
    document.getElementById("beschreibungDialog").style.display="none";
    beschreibungFuerId=null;
    beschreibungZuBearbeitenderTimestamp=null;
    beschreibungAntwortAufTimestamp = null; // NEU: Auch hier zur√ºcksetzen
    document.getElementById("beschreibungText").value="";
    document.getElementById("beschreibungText").placeholder = "Weitere Beschreibung"; // Optional: Platzhalter zur√ºcksetzen
}

function beschreibungSpeichern(){
    let t = document.getElementById("beschreibungText").value;
    const MAX_DESC_LENGTH = 10000; 

    if (t.length > MAX_DESC_LENGTH) {
        t = t.substring(0, MAX_DESC_LENGTH);
        zeigeWarnung("Die Beschreibung war zu lang und wurde gek√ºrzt.", "info");
    }
    t = t.trim();
    if(!t)return;

    let ideen=JSON.parse(localStorage.getItem("ideen")||"[]");
    const idx=ideen.findIndex(i=>i&&i.id===beschreibungFuerId);
    
    if(idx!==-1){
        if (!ideen[idx].beschreibungen) ideen[idx].beschreibungen = [];

        // Fall 1: Bearbeiten einer bestehenden Beschreibung
        if(beschreibungZuBearbeitenderTimestamp!==null){
            const dIdx=ideen[idx].beschreibungen.findIndex(b=>b&&b.timestamp===beschreibungZuBearbeitenderTimestamp);
            if(dIdx!==-1) { 
                ideen[idx].beschreibungen[dIdx].text=t; 
            }
            else { zeigeWarnung("Fehler: Beschreibung zum Bearbeiten nicht gefunden."); }
        
        // Fall 2: NEU - Antworten auf eine bestehende Beschreibung
        } else if (beschreibungAntwortAufTimestamp !== null) {
            const quellIndex = ideen[idx].beschreibungen.findIndex(b => b && b.timestamp === beschreibungAntwortAufTimestamp);
            if (quellIndex === -1) {
                zeigeWarnung("Fehler: Eltern-Beschreibung f√ºr Antwort nicht gefunden.");
                beschreibungAbbrechen();
                return;
            }

            const basisLevel = ideen[idx].beschreibungen[quellIndex].level || 0;
            const neuesLevel = basisLevel + 1;
            
            // Finde die korrekte Einf√ºgeposition:
            // Direkt nach dem Elternteil und all seinen Kindern (ganzer Block)
            let einfuegePosition = quellIndex + 1;
            for (let i = quellIndex + 1; i < ideen[idx].beschreibungen.length; i++) {
                const naechstesLevel = ideen[idx].beschreibungen[i].level || 0;
                if (naechstesLevel > basisLevel) {
                    einfuegePosition = i + 1; // Nach diesem Kind einf√ºgen
                } else {
                    break; // Ende des Blocks erreicht
                }
            }

            const ts = new Date().toISOString()+'_'+Math.random().toString(36).substr(2,9);
            const neueBeschreibung = {
                text: t, 
                timestamp: ts, 
                level: neuesLevel, // Ein Level tiefer als das Elternelement
                sichtbar: true, 
                attachments: [], 
                erinnerung: getDefaultErinnerung(),
                autor: aktuellerBenutzerName || "Unbekannt"
            };
            
            // An der berechneten Position einf√ºgen
            ideen[idx].beschreibungen.splice(einfuegePosition, 0, neueBeschreibung);

        // Fall 3: Hinzuf√ºgen einer neuen Top-Level-Beschreibung
        } else {
            const ts=new Date().toISOString()+'_'+Math.random().toString(36).substr(2,9);
            const neueBeschreibung = {
                text:t, 
                timestamp:ts, 
                level: 0, // Standard-Level 0
                sichtbar: true, 
                attachments: [], 
                erinnerung: getDefaultErinnerung(),
                autor: aktuellerBenutzerName || "Unbekannt"
            };
            ideen[idx].beschreibungen.push(neueBeschreibung);
        }
        
        localStorage.setItem("ideen",JSON.stringify(ideen));
        zeigeIdeen();
    } else { zeigeWarnung("Fehler: Idee nicht gefunden."); }
    
    beschreibungAbbrechen(); 
    triggerAutoSave();
}

function starteAnhangUploadFuerBeschreibung(ideeId, timestamp) {
    anhangFuerBeschreibungZiel = { ideeId: ideeId, timestamp: timestamp };
    const fileInput = document.getElementById('beschreibungAnhangInput');
    fileInput.value = ''; 
    fileInput.click();
}

async function handleBeschreibungAnhangUpload(event) {
    const { ideeId, timestamp } = anhangFuerBeschreibungZiel;
    if (!ideeId || !timestamp || !event.target.files) {
        return;
    }

    const files = event.target.files;
    if (files.length === 0) return;
    
    if (currentLoginType === 'microsoft') {
        if (!(await getValidToken(true))) { 
            zeigeWarnung("Sitzung abgelaufen. Bitte anmelden, um Dateien hochzuladen.", "warnung"); 
            return; 
        }
    }

    zeigeWarnung(`Lade ${files.length} Datei(en) f√ºr Beschreibung hoch...`, 'info');

    let neueAnhaenge = [];
    if (currentLoginType === 'microsoft' && accessToken) {
        try {
            neueAnhaenge = await Promise.all(Array.from(files).map(async f => {
                const link = await uploadToOneDrive(f);
                return { id: generateUUID(), name: f.name, link: link, type: f.type };
            }));
            neueAnhaenge = neueAnhaenge.filter(f => f && f.link);
        } catch (e) {
            zeigeWarnung("Fehler beim OneDrive-Upload: " + e.message, 'warnung');
            return;
        }
    } else {
        if (currentLoginType === 'github') {
            zeigeWarnung("Dateianh√§nge sind nur mit Microsoft-Login m√∂glich. Dateien werden lokal vermerkt.", "info");
        }
        neueAnhaenge = Array.from(files).map(f => ({
            id: generateUUID(), name: f.name, link: null, type: f.type
        }));
    }

    if (neueAnhaenge.length === 0 && currentLoginType === 'microsoft') {
        zeigeWarnung("Keine Anh√§nge erfolgreich hochgeladen.", 'warnung');
        return;
    }

    let ideen = JSON.parse(localStorage.getItem("ideen") || "[]");
    const ideeIndex = ideen.findIndex(i => i && i.id === ideeId);
    if (ideeIndex === -1) {
        zeigeWarnung("Fehler: Zugeh√∂rige Idee nicht gefunden.", 'warnung');
        return;
    }

    const beschreibungIndex = ideen[ideeIndex].beschreibungen.findIndex(b => b && b.timestamp === timestamp);
    if (beschreibungIndex === -1) {
        zeigeWarnung("Fehler: Zugeh√∂rige Beschreibung nicht gefunden.", 'warnung');
        return;
    }

    if (!Array.isArray(ideen[ideeIndex].beschreibungen[beschreibungIndex].attachments)) {
        ideen[ideeIndex].beschreibungen[beschreibungIndex].attachments = [];
    }
    
    ideen[ideeIndex].beschreibungen[beschreibungIndex].attachments.push(...neueAnhaenge);

    localStorage.setItem("ideen", JSON.stringify(ideen));
    zeigeWarnung(`${neueAnhaenge.length} Anhang/Anh√§nge zur Beschreibung hinzugef√ºgt.`, 'success');
    zeigeIdeen();
    triggerAutoSave();

    anhangFuerBeschreibungZiel = { ideeId: null, timestamp: null };
}


function bearbeiteEinzelneBeschreibung(id,ts){if(ts)zeigeBeschreibungDialog(id,ts);else zeigeWarnung("Interner Fehler: Timestamp fehlt.")}
function toggleAuswahl(id,box){if(box.checked){if(!ausgewaehlt.includes(id))ausgewaehlt.push(id)}else{ausgewaehlt=ausgewaehlt.filter(i=>i!==id)}}
function ausgewaehlteNotizenLoeschen(){if(ausgewaehlt.length===0){zeigeWarnung("Keine Notizen ausgew√§hlt.");return}if(!confirm(`Wirklich ${ausgewaehlt.length} Notiz(en) l√∂schen?`))return;let ideen=JSON.parse(localStorage.getItem("ideen")||"[]");const delM=new Set();const delU=new Set();ideen.filter(i=>i&&ausgewaehlt.includes(i.id)).forEach(i=>{if(i.mandantennummer)delM.add((i.mandantennummer).toLowerCase());if(i.benutzer)delU.add((i.benutzer).toLowerCase())});const newList=ideen.filter(i=>!i || !ausgewaehlt.includes(i.id));localStorage.setItem("ideen",JSON.stringify(newList));const remM=new Set(newList.filter(i=>i).map(i=>(i.mandantennummer||"").toLowerCase()).filter(m=>m!==""));const remU=new Set(newList.filter(i=>i).map(i=>(i.benutzer||"").toLowerCase()).filter(b=>b!==""));let uM=!1;delM.forEach(m=>{if(!remM.has(m))uM=!0});let uU=!1;delU.forEach(u=>{if(!remU.has(u))uU=!0});if(uM)aktualisiereMandantenFilterDropdown();if(uU)aktualisiereBenutzerDropdowns();if(bearbeiteId!==null&&ausgewaehlt.includes(bearbeiteId))abbrechenBearbeiten();if(beschreibungFuerId!==null&&ausgewaehlt.includes(beschreibungFuerId))beschreibungAbbrechen(); if(erinnerungFuerId!==null&&ausgewaehlt.includes(erinnerungFuerId))erinnerungAbbrechen(); if(terminFuerId!==null&&ausgewaehlt.includes(terminFuerId))terminDialogAbbrechen(); ausgewaehlt=[];zeigeIdeen();triggerAutoSave();}
function alleIdeenLoeschen(){if(!confirm("Wirklich ALLE Ideen, Kategorien, Benutzer etc. l√∂schen?"))return;localStorage.removeItem("ideen"); localStorage.removeItem("kategorien"); localStorage.removeItem("benutzerliste"); localStorage.removeItem("naechsteVorgangsnummer"); naechsteVorgangsnummer=1; kategorien = []; benutzerliste = []; zeigeNaechsteNummer(); initialisiereKategorien(); initialisiereBenutzer(); aktualisiereMandantenFilterDropdown(); ausgewaehlt=[];bearbeiteId=null;beschreibungFuerId=null;beschreibungZuBearbeitenderTimestamp=null;beschreibungAntwortAufTimestamp=null; erinnerungFuerId=null; terminFuerId=null; zeigeIdeen();abbrechenBearbeiten();triggerAutoSave();}
//aktualisiereBenutzerDropdowns wurde durch initialisiereBenutzer() ersetzt im SHARED Teil

function toggleAnhangSichtbarkeit(ideeId, anhangId) {
    if (!ideeId || !anhangId) { return; }
    let ideen = JSON.parse(localStorage.getItem("ideen") || "[]");
    const ideeIndex = ideen.findIndex(i => i && i.id === ideeId);
    if (ideeIndex === -1) { zeigeWarnung("Fehler: Idee nicht gefunden."); return; }
    if (!Array.isArray(ideen[ideeIndex].dateien)) { return; }
    const anhangIndex = ideen[ideeIndex].dateien.findIndex(f => f && f.id === anhangId);
    if (anhangIndex === -1) { zeigeWarnung("Fehler: Anhang nicht gefunden."); return; }
    ideen[ideeIndex].dateien[anhangIndex].sichtbar = !(ideen[ideeIndex].dateien[anhangIndex].sichtbar === true);
    localStorage.setItem("ideen", JSON.stringify(ideen));
    zeigeIdeen(); 
    triggerAutoSave();
}

function verschiebeBeschreibung(ideeId, beschreibungTimestamp, richtung) {
    if (!ideeId || !beschreibungTimestamp || (richtung !== -1 && richtung !== 1)) { return; }
    let ideen = JSON.parse(localStorage.getItem("ideen") || "[]");
    const ideeIndex = ideen.findIndex(i => i && i.id === ideeId);
    if (ideeIndex === -1) return zeigeWarnung("Idee nicht gefunden.");
    if (!ideen[ideeIndex].beschreibungen || !Array.isArray(ideen[ideeIndex].beschreibungen)) return;
    const beschreibungen = ideen[ideeIndex].beschreibungen;
    const currentIndex = beschreibungen.findIndex(b => b && b.timestamp === beschreibungTimestamp);
    if (currentIndex === -1) return zeigeWarnung("Beschreibung nicht gefunden.");
    const targetIndex = currentIndex + richtung;
    if (targetIndex < 0 || targetIndex >= beschreibungen.length) { return; }
    [beschreibungen[currentIndex], beschreibungen[targetIndex]] = [beschreibungen[targetIndex], beschreibungen[currentIndex]];
    localStorage.setItem("ideen", JSON.stringify(ideen));
    zeigeIdeen(); 
    triggerAutoSave();
}

function aendereEinrueckungBeschreibung(ideeId, beschreibungTimestamp, richtung) {
    if (!ideeId || !beschreibungTimestamp || (richtung !== -1 && richtung !== 1)) { return; }
    let ideen = JSON.parse(localStorage.getItem("ideen") || "[]");
    const ideeIndex = ideen.findIndex(i => i && i.id === ideeId);
    if (ideeIndex === -1) return zeigeWarnung("Idee nicht gefunden.");
    if (!ideen[ideeIndex].beschreibungen || !Array.isArray(ideen[ideeIndex].beschreibungen)) return;
    const beschrIndex = ideen[ideeIndex].beschreibungen.findIndex(b => b && b.timestamp === beschreibungTimestamp);
    if (beschrIndex === -1) return zeigeWarnung("Beschreibung nicht gefunden.");
    const aktuellesLevel = ideen[ideeIndex].beschreibungen[beschrIndex].level || 0;
    let neuesLevel = aktuellesLevel + richtung;
    const maxLevel = 5;
    if (neuesLevel < 0) neuesLevel = 0;
    if (neuesLevel > maxLevel) neuesLevel = maxLevel;
    if (aktuellesLevel === neuesLevel) { return; }
    ideen[ideeIndex].beschreibungen[beschrIndex].level = neuesLevel;
    localStorage.setItem("ideen", JSON.stringify(ideen));
    zeigeIdeen(); 
    triggerAutoSave();
}

function toggleBeschreibungSichtbarkeit(ideeId, beschreibungTimestamp) {
    if (!ideeId || !beschreibungTimestamp) { return; }
    let ideen = JSON.parse(localStorage.getItem("ideen") || "[]");
    const ideeIndex = ideen.findIndex(i => i && i.id === ideeId);
    if (ideeIndex === -1) { zeigeWarnung("Fehler: Idee nicht gefunden."); return; }
    if (!Array.isArray(ideen[ideeIndex].beschreibungen)) { return; }
    const beschrIndex = ideen[ideeIndex].beschreibungen.findIndex(b => b && b.timestamp === beschreibungTimestamp);
    if (beschrIndex === -1) { zeigeWarnung("Fehler: Beschreibung nicht gefunden."); return; }
    ideen[ideeIndex].beschreibungen[beschrIndex].sichtbar = !(ideen[ideeIndex].beschreibungen[beschrIndex].sichtbar === true);
    localStorage.setItem("ideen", JSON.stringify(ideen));
    zeigeIdeen(); 
    triggerAutoSave();
}

function getDefaultErinnerung(titel = "", vorgangsnummer = null) {
    return {
        aktiv: false, termin: null, intervallTyp: 'einmalig', intervallWert: null,
        vorabErinnerungAktiv: false, vorabWert: 10, vorabEinheit: 'minuten',
        titel: titel, vorgangsnummer: vorgangsnummer
    };
}

function zeigeErinnerungDialog(id) {
    erinnerungFuerId = id;
    erinnerungFuerBeschreibungTimestamp = null; // Wichtig: Zur√ºcksetzen
    const ideen = JSON.parse(localStorage.getItem("ideen") || "[]");
    const idee = ideen.find(i => i && i.id === id);

    if (!idee) { zeigeWarnung("Fehler: Idee f√ºr Erinnerung nicht gefunden."); erinnerungAbbrechen(); return; }
    if (idee.erledigt) { zeigeWarnung("Erinnerungen k√∂nnen nicht f√ºr erledigte Notizen eingestellt werden.", "info"); return; }

    const erinnerung = idee.erinnerung || getDefaultErinnerung(idee.text, idee.vorgangsnummer);

    document.getElementById("erinnerungTerminInput").value = erinnerung.termin ? erinnerung.termin.substring(0, 16) : "";
    document.getElementById("erinnerungIntervallTypSelect").value = erinnerung.intervallTyp || 'einmalig';
    document.getElementById("erinnerungIntervallWertInput").value = erinnerung.intervallWert || 1;
    document.getElementById("erinnerungVorabCheckbox").checked = erinnerung.vorabErinnerungAktiv || false;
    document.getElementById("erinnerungVorabWertInput").value = erinnerung.vorabWert || 10;
    document.getElementById("erinnerungVorabEinheitSelect").value = erinnerung.vorabEinheit || 'minuten';

    toggleErinnerungIntervallWert();
    toggleErinnerungVorabDetails();

    document.getElementById("erinnerungDialog").style.display = "block";
    document.getElementById("erinnerungTerminInput").focus();
}

function zeigeBeschreibungErinnerungDialog(ideeId, beschreibungTimestamp) {
    erinnerungFuerId = ideeId;
    erinnerungFuerBeschreibungTimestamp = beschreibungTimestamp; // Timestamp der Beschreibung setzen

    const ideen = JSON.parse(localStorage.getItem("ideen") || "[]");
    const idee = ideen.find(i => i && i.id === ideeId);
    if (!idee) { zeigeWarnung("Fehler: Zugeh√∂rige Idee nicht gefunden."); erinnerungAbbrechen(); return; }
    
    const beschreibung = idee.beschreibungen.find(b => b && b.timestamp === beschreibungTimestamp);
    if (!beschreibung) { zeigeWarnung("Fehler: Beschreibung f√ºr Erinnerung nicht gefunden."); erinnerungAbbrechen(); return; }

    const erinnerung = beschreibung.erinnerung || getDefaultErinnerung();

    document.getElementById("erinnerungTerminInput").value = erinnerung.termin ? erinnerung.termin.substring(0, 16) : "";
    document.getElementById("erinnerungIntervallTypSelect").value = erinnerung.intervallTyp || 'einmalig';
    document.getElementById("erinnerungIntervallWertInput").value = erinnerung.intervallWert || 1;
    document.getElementById("erinnerungVorabCheckbox").checked = erinnerung.vorabErinnerungAktiv || false;
    document.getElementById("erinnerungVorabWertInput").value = erinnerung.vorabWert || 10;
    document.getElementById("erinnerungVorabEinheitSelect").value = erinnerung.vorabEinheit || 'minuten';

    toggleErinnerungIntervallWert();
    toggleErinnerungVorabDetails();
    
    document.getElementById("erinnerungDialog").style.display = "block";
    document.getElementById("erinnerungTerminInput").focus();
}

function erinnerungAbbrechen() {
    document.getElementById("erinnerungDialog").style.display = "none";
    erinnerungFuerId = null;
    erinnerungFuerBeschreibungTimestamp = null; // Wichtig
    document.getElementById("erinnerungTerminInput").value = "";
    document.getElementById("erinnerungIntervallTypSelect").value = "einmalig";
    document.getElementById("erinnerungIntervallWertInput").value = "1";
    document.getElementById("erinnerungVorabCheckbox").checked = false;
    document.getElementById("erinnerungVorabWertInput").value = "10";
    document.getElementById("erinnerungVorabEinheitSelect").value = "minuten";
    toggleErinnerungIntervallWert();
    toggleErinnerungVorabDetails();
}

function erinnerungSpeichern() {
    if (!erinnerungFuerId) return;
    const terminValue = document.getElementById("erinnerungTerminInput").value;
    if (!terminValue) { zeigeWarnung("Bitte geben Sie einen Termin f√ºr die Erinnerung an."); return; }
    const termin = new Date(terminValue).toISOString();
    const intervallTyp = document.getElementById("erinnerungIntervallTypSelect").value;
    const intervallWert = intervallTyp === 'tage' ? parseInt(document.getElementById("erinnerungIntervallWertInput").value, 10) : null;
    const vorabErinnerungAktiv = document.getElementById("erinnerungVorabCheckbox").checked;
    const vorabWert = vorabErinnerungAktiv ? parseInt(document.getElementById("erinnerungVorabWertInput").value, 10) : null;
    const vorabEinheit = vorabErinnerungAktiv ? document.getElementById("erinnerungVorabEinheitSelect").value : null;

    if (intervallTyp === 'tage' && (!intervallWert || intervallWert < 1)) { zeigeWarnung("Bitte eine g√ºltige Anzahl von Tagen angeben."); return; }
    if (vorabErinnerungAktiv && (!vorabWert || vorabWert < 1)) { zeigeWarnung("Bitte einen g√ºltigen Wert f√ºr die Vorab-Erinnerung angeben."); return; }

    if (Notification.permission === "default") {
        zeigeWarnung("Um Benachrichtigungen zu erhalten, bitte diese im Browser erlauben.", "info");
    } else if (Notification.permission === "denied") {
        zeigeWarnung("Benachrichtigungen sind blockiert. Sie werden nicht per Browser-Notification erinnert.", "warnung");
    }

    let ideen = JSON.parse(localStorage.getItem("ideen") || "[]");
    const ideeIndex = ideen.findIndex(i => i && i.id === erinnerungFuerId);

    if (ideeIndex !== -1) {
        const idee = ideen[ideeIndex];
        const erinnerungsDaten = {
            aktiv: true, termin: termin, intervallTyp: intervallTyp, intervallWert: intervallWert,
            vorabErinnerungAktiv: vorabErinnerungAktiv, vorabWert: vorabWert, vorabEinheit: vorabEinheit
        };

        if (erinnerungFuerBeschreibungTimestamp) {
            // Speichern f√ºr eine Beschreibung
            const beschreibungIndex = idee.beschreibungen.findIndex(b => b && b.timestamp === erinnerungFuerBeschreibungTimestamp);
            if (beschreibungIndex !== -1) {
                ideen[ideeIndex].beschreibungen[beschreibungIndex].erinnerung = {
                        ...erinnerungsDaten,
                        titel: null,
                        vorgangsnummer: null
                };
            } else {
                zeigeWarnung("Fehler: Beschreibung zum Speichern der Erinnerung nicht gefunden.");
                erinnerungAbbrechen();
                return;
            }
        } else {
            // Speichern f√ºr die Haupt-Idee
            if (idee.erledigt) { zeigeWarnung("Erinnerung kann nicht gespeichert werden (Notiz erledigt).", "info"); erinnerungAbbrechen(); return; }
            ideen[ideeIndex].erinnerung = {
                ...erinnerungsDaten,
                titel: idee.text,
                vorgangsnummer: idee.vorgangsnummer
            };
        }

        localStorage.setItem("ideen", JSON.stringify(ideen));
        zeigeWarnung("Erinnerung gespeichert.", "success");
        zeigeIdeen(); 
        triggerAutoSave();
    } else { zeigeWarnung("Fehler: Idee zum Speichern der Erinnerung nicht gefunden."); }
    erinnerungAbbrechen();
}

function erinnerungLoeschen() {
    if (!erinnerungFuerId) return;
    if (!confirm("M√∂chten Sie diese Erinnerung wirklich l√∂schen?")) return;
    let ideen = JSON.parse(localStorage.getItem("ideen") || "[]");
    const ideeIndex = ideen.findIndex(i => i && i.id === erinnerungFuerId);
    
    if (ideeIndex !== -1) {
        if (erinnerungFuerBeschreibungTimestamp) {
            // L√∂schen f√ºr eine Beschreibung
            const beschreibungIndex = ideen[ideeIndex].beschreibungen.findIndex(b => b && b.timestamp === erinnerungFuerBeschreibungTimestamp);
            if (beschreibungIndex !== -1) {
                ideen[ideeIndex].beschreibungen[beschreibungIndex].erinnerung = getDefaultErinnerung();
            } else {
                zeigeWarnung("Fehler: Beschreibung zum L√∂schen der Erinnerung nicht gefunden.");
                erinnerungAbbrechen();
                return;
            }
        } else {
            // L√∂schen f√ºr die Haupt-Idee
            ideen[ideeIndex].erinnerung = getDefaultErinnerung(ideen[ideeIndex].text, ideen[ideeIndex].vorgangsnummer);
        }

        localStorage.setItem("ideen", JSON.stringify(ideen));
        zeigeWarnung("Erinnerung gel√∂scht.", "success");
        zeigeIdeen(); 
        triggerAutoSave();
    } else { zeigeWarnung("Fehler: Idee zum L√∂schen der Erinnerung nicht gefunden."); }
    erinnerungAbbrechen();
}


function toggleErinnerungIntervallWert() {
    const typ = document.getElementById("erinnerungIntervallTypSelect").value;
    document.getElementById("erinnerungIntervallWertContainer").style.display = (typ === 'tage') ? 'block' : 'none';
}

function toggleErinnerungVorabDetails() {
    const checked = document.getElementById("erinnerungVorabCheckbox").checked;
    document.getElementById("erinnerungVorabDetailsContainer").style.display = checked ? 'block' : 'none';
}

function getFormattedDate(timestamp) { if (timestamp) { let ts = timestamp; if (typeof ts === 'string' && ts.includes('_')) { ts = ts.split('_')[0]; } try { const d = new Date(ts); if (!isNaN(d.getTime())) { return d.toLocaleString("de-DE", { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' }); } } catch (e) { } } return 'N/A'; }
function getExportIdeen() { let resultIdeen = []; try { let ideen = []; try { ideen = JSON.parse(localStorage.getItem("ideen") || "[]"); if (!Array.isArray(ideen)) { ideen = []; localStorage.setItem("ideen", "[]"); } } catch (e) { localStorage.removeItem("ideen"); ideen = []; } const aktuellAusgewaehlteCheckboxes = Array.from(document.querySelectorAll('.idee-checkbox:checked')); let aktuellAusgewaehlteIDs = []; if (aktuellAusgewaehlteCheckboxes.length > 0) { aktuellAusgewaehlteIDs = aktuellAusgewaehlteCheckboxes.map(cb => { try { let parentIdeeDiv = cb.closest('.idee'); if (parentIdeeDiv) { return parentIdeeDiv.dataset.ideeId; } } catch (e) { } return null; }).filter(id => id !== null); if (aktuellAusgewaehlteIDs.length > 0) { resultIdeen = ideen.filter(i => i && i.id && aktuellAusgewaehlteIDs.includes(i.id)); } else { resultIdeen = []; } } else { let fIdeen = [...ideen.filter(i=>i&&i.id)]; const fKat = document.getElementById("filterKategorie")?.value; if (fKat) fIdeen = fIdeen.filter(i => i.kategorie === fKat); const fMdt = document.getElementById("filterMandant")?.value; if (fMdt) fIdeen = fIdeen.filter(i => (i.mandantennummer || "").toLowerCase() === fMdt.toLowerCase()); const fUser = document.getElementById("filterBenutzer")?.value; if (fUser) fIdeen = fIdeen.filter(i => (i.benutzer || "").toLowerCase() === fUser.toLowerCase()); const fArchiv = document.getElementById("filterArchiv")?.value; if (fArchiv === "nicht_erledigt") fIdeen = fIdeen.filter(i => !(i.erledigt || false)); else if (fArchiv === "erledigt") fIdeen = fIdeen.filter(i => (i.erledigt || false)); const sort=document.getElementById("sortierung")?.value; if(sort && sort!=="standard"){ fIdeen.sort((a,b)=>{ if (!a || !b) return 0; if(sort==="prio"){ const p={"Hoch":3,"Mittel":2,"Niedrig":1}; return(p[b.prioritaet]||0)-(p[a.prioritaet]||0); } let tA=-Infinity,tB=-Infinity; try{tA=new Date(a.timestamp?.split('_')[0]).getTime();if(isNaN(tA))tA=(sort==="neu"?-Infinity:Infinity)}catch(e){tA=(sort==="neu"?-Infinity:Infinity)} try{tB=new Date(b.timestamp?.split('_')[0]).getTime();if(isNaN(tB))tB=(sort==="neu"?-Infinity:Infinity)}catch(e){tB=(sort==="neu"?-Infinity:Infinity)} if(sort==="neu")return tB-tA; if(sort==="alt")return tA-tB; return 0; }); } resultIdeen = fIdeen; } } catch (error) { resultIdeen = []; } if (!Array.isArray(resultIdeen)) { return []; } return resultIdeen; }

function formatErinnerungForExport(erinnerung) {
    if (!erinnerung || !erinnerung.termin) return "";
    let text = `Erinnerung (${erinnerung.aktiv ? 'Aktiv' : 'Inaktiv'}):\n`;
    text += `  Termin: ${getFormattedDate(erinnerung.termin)}\n`;
    if(erinnerung.titel) text += `  Titel (f√ºr Erinnerung): ${erinnerung.titel || '-'}\n`;
    if(erinnerung.vorgangsnummer) text += `  Vorgangsnr. (f√ºr Erinnerung): ${erinnerung.vorgangsnummer || '-'}\n`;
    text += `  Intervall: ${erinnerung.intervallTyp || 'einmalig'}`;
    if (erinnerung.intervallTyp === 'tage' && erinnerung.intervallWert) {
        text += ` (alle ${erinnerung.intervallWert} Tage)`;
    }
    text += "\n";
    if (erinnerung.vorabErinnerungAktiv && erinnerung.vorabWert && erinnerung.vorabEinheit) {
        text += `  Vorab-Erinnerung: ${erinnerung.vorabWert} ${erinnerung.vorabEinheit} vorher\n`;
    }
    return text;
}

function exportiereAlsText() {
    const ideenToExport = getExportIdeen();
    if (ideenToExport.length === 0) { zeigeWarnung("Keine Notizen zum Exportieren.", "info"); return; }
    let textContent = `Ideen-Export - ${new Date().toLocaleString("de-DE")}\n==================================================\n\n`;
    ideenToExport.forEach(idee => {
        if (!idee) return;
        textContent += `${idee.erledigt ? '[ERLEDIGT] ' : ''}${idee.vorgangsnummer ? `[Vorgang ${idee.vorgangsnummer}] ` : ''}${idee.text || 'Ohne Titel'}\n--------------------------------------------------\n`;
        if (idee.kategorie) textContent += `Kategorie: ${idee.kategorie}\n`;
        if (idee.prioritaet) textContent += `Priorit√§t: ${idee.prioritaet}\n`;
        textContent += `Erstellt am: ${getFormattedDate(idee.timestamp)}\n`;
        if (idee.ersteller) textContent += `Erstellt von: ${idee.ersteller}\n`;
        if (idee.benutzer) textContent += `Zust√§ndig: ${idee.benutzer}\n`;
        if (idee.mandantennummer) textContent += `Mandantennummer: ${idee.mandantennummer}\n`;
        if (idee.firmenname) textContent += `Firmenname: ${idee.firmenname}\n`;
        
        // NEU: Telefonnummern zum Export hinzuf√ºgen
        if (idee.telefonNummern && idee.telefonNummern.length > 0) {
            textContent += `Telefonnummern:\n`;
            idee.telefonNummern.forEach(tel => {
                textContent += `  - ${tel.bezeichnung || 'Ohne Bezeichnung'}: ${tel.nummer}\n`;
            });
        }
        
        if (idee.details) textContent += `\nBeschreibung:\n${idee.details}\n`;

        if (idee.erinnerung && idee.erinnerung.termin) {
            textContent += `\n${formatErinnerungForExport(idee.erinnerung)}`;
        }

        if (idee.beschreibungen && idee.beschreibungen.length > 0) {
             textContent += `\nWeitere Beschreibungen:\n`;
             idee.beschreibungen.forEach(b => {
                 if (b && b.text !== undefined) {
                      const indentSpaces = "  ".repeat(b.level || 0);
                      const praefix = b.sichtbar === false ? "[Ausgeblendet] " : "";
                      const autorText = b.autor ? ` (von ${b.autor})` : "";
                      textContent += `${indentSpaces}- [${getFormattedDate(b.timestamp)}]${autorText} ${praefix}${b.text}\n`;
                      if (b.attachments && b.attachments.length > 0) {
                          b.attachments.forEach(anhang => {
                               textContent += `${indentSpaces}      -> Anhang: ${anhang.name} ${anhang.link ? `(${anhang.link})` : '(Lokal)'}\n`;
                          });
                      }
                      if (b.erinnerung && b.erinnerung.termin) {
                          textContent += `${indentSpaces}  ${formatErinnerungForExport(b.erinnerung).replace(/\n/g, `\n${indentSpaces}  `)}`;
                      }
                 }
             });
        }

        if (idee.dateien && idee.dateien.length > 0) {
            textContent += `\nAnh√§nge:\n`;
            idee.dateien.forEach(f => {
                 if (!f || !f.id) return;
                const praefix = f.sichtbar === false ? "[Veraltet] " : "";
                textContent += `  - Name: ${praefix}${f.name || 'Unbekannt'}\n`;
                if (f.link) { textContent += `    Link: ${f.link}\n`; }
                else { textContent += `    (Lokale Datei)\n`; }
            });
        }
        textContent += `\n==================================================\n\n`;
    });
    const blob = new Blob([textContent], { type: "text/plain;charset=utf-8" }); const url = URL.createObjectURL(blob); const a = document.createElement("a"); a.href = url; a.download = "ideen-export.txt"; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); zeigeWarnung("Text-Export gestartet.", "success");
}

function sanitizeFilename(name) {
    if (!name) return "Unbenannte_Idee";
    let sanitized = name.replace(/[\\/:*?"<>|#%&{}]/g, '');
    sanitized = sanitized.replace(/\s+/g, '_');
    sanitized = sanitized.replace(/√§/g, 'ae').replace(/√∂/g, 'oe').replace(/√º/g, 'ue');
    sanitized = sanitized.replace(/√Ñ/g, 'Ae').replace(/√ñ/g, 'Oe').replace(/√ú/g, 'Ue');
    sanitized = sanitized.replace(/√ü/g, 'ss');
    return sanitized.substring(0, 100);
}

function exportiereAlsPDF(fileName = "ideen-export.pdf") {
    const ideenToExport = getExportIdeen();
    if (ideenToExport.length === 0) {
        zeigeWarnung("Keine Notizen zum Exportieren.", "info");
        return false; 
    }
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });

    let pdfMetadataTitle;
    if (ideenToExport.length === 1) {
        const idee = ideenToExport[0];
        let titleParts = [];
        if (idee.vorgangsnummer) {
            titleParts.push(`Vorgang ${idee.vorgangsnummer}`);
        }
        titleParts.push(idee.text || 'Unbenannte Idee');
        titleParts.push(`(${fileName})`);
        pdfMetadataTitle = titleParts.join(' - ');
    } else {
        pdfMetadataTitle = `Export von ${ideenToExport.length} Ideen - (${fileName})`;
    }

    doc.setProperties({
        title: pdfMetadataTitle, 
        subject: 'Exportierte Ideen aus der Ideen-App Pro',
        author: 'Ideen-App Pro',
        creator: 'Ideen-App Pro'
    });

    let yPosition = 15;
    const leftMargin = 15;
    const rightMargin = 15;
    const pageHeight = doc.internal.pageSize.height;
    const contentWidth = doc.internal.pageSize.width - leftMargin - rightMargin;
    const defaultLineSpacing = 5;
    const sectionSpacing = 8;
    const ideaSpacing = 15;
    const anhangFontSize = 10;
    const anhangLineHeight = 5;

    function checkAddPage(neededHeight) {
        if (yPosition + neededHeight > pageHeight - 15) {
            doc.addPage();
            yPosition = 15;
            return true;
        }
        return false;
    }

    function addWrappedText(text, x, maxWidth, options = {}) {
        const fontSize = options.fontSize || 10;
        const fontStyle = options.fontStyle || 'normal';
        const color = options.color || [0, 0, 0];
        const lineHeight = options.lineHeight || defaultLineSpacing;
        doc.setFontSize(fontSize);
        doc.setFont(undefined, fontStyle);
        doc.setTextColor(color[0], color[1], color[2]);
        const lines = doc.splitTextToSize(text || "N/A", maxWidth);
        for (let i = 0; i < lines.length; i++) {
            checkAddPage(lineHeight);
            if (options.link && i === 0) {
                const textWidth = doc.getTextWidth(lines[i]);
                const charHeight = doc.getFontSize() / doc.internal.scaleFactor;
                doc.text(lines[i], x, yPosition);
                doc.link(x, yPosition - charHeight + 1, textWidth, charHeight, { url: options.link });
            } else {
                doc.text(lines[i], x, yPosition);
            }
            yPosition += lineHeight;
        }
    }

    doc.setFontSize(18);
    doc.setFont(undefined, 'bold');
    addWrappedText(`Ideen-Export - ${new Date().toLocaleDateString("de-DE")}`, leftMargin, contentWidth, { fontSize: 18, fontStyle: 'bold', lineHeight: 7 });
    yPosition += 5;

    ideenToExport.forEach((idee, index) => {
        if (!idee) return;
        if (index > 0) {
            yPosition += (ideaSpacing / 2);
        }
        checkAddPage(40); 
        if (index > 0) {
            doc.setDrawColor(180, 180, 180);
            doc.line(leftMargin, yPosition - (ideaSpacing / 4), doc.internal.pageSize.width - rightMargin, yPosition - (ideaSpacing / 4));
        }

        let titleText = `${idee.erledigt ? '[ERLEDIGT] ' : ''}${idee.vorgangsnummer ? `[Vorgang ${idee.vorgangsnummer}] ` : ''}${idee.text || 'Ohne Titel'}`;
        addWrappedText(titleText, leftMargin, contentWidth, { fontSize: 14, fontStyle: 'bold', lineHeight: 7 });

        let metaText1 = `Kategorie: ${idee.kategorie || '-'} | Priorit√§t: ${idee.prioritaet || '-'} | Datum: ${getFormattedDate(idee.timestamp)}`;
        addWrappedText(metaText1, leftMargin, contentWidth, { fontSize: 9, color: [51, 51, 51], lineHeight: 4 });
        if(idee.ersteller) {
            let metaText2 = `Erstellt von: ${idee.ersteller}`;
            addWrappedText(metaText2, leftMargin, contentWidth, { fontSize: 9, color: [51, 51, 51], lineHeight: 4 });
        }
        yPosition += 2;

        if (idee.benutzer) addWrappedText(`Zust√§ndig: ${idee.benutzer}`, leftMargin, contentWidth, { fontSize: 10, lineHeight: defaultLineSpacing });
        if (idee.mandantennummer) addWrappedText(`Mandant: ${idee.mandantennummer}`, leftMargin, contentWidth, { fontSize: 10, lineHeight: defaultLineSpacing });
        if (idee.firmenname) addWrappedText(`Firma: ${idee.firmenname}`, leftMargin, contentWidth, { fontSize: 10, lineHeight: defaultLineSpacing });
        
        // NEU: Telefonnummern zum PDF hinzuf√ºgen
        if (idee.telefonNummern && idee.telefonNummern.length > 0) {
            checkAddPage(sectionSpacing + defaultLineSpacing);
            addWrappedText("Telefonnummern:", leftMargin, contentWidth, { fontSize: 11, fontStyle: 'bold', lineHeight: 6 });
            idee.telefonNummern.forEach(tel => {
                addWrappedText(`- ${tel.bezeichnung || 'Ohne Bezeichnung'}: ${tel.nummer}`, leftMargin + 5, contentWidth - 5, { fontSize: 10, lineHeight: defaultLineSpacing });
            });
            yPosition += (sectionSpacing / 2);
        } else {
             if (idee.benutzer || idee.mandantennummer || idee.firmenname) yPosition += (sectionSpacing / 2);
        }


        if (idee.details) {
            checkAddPage(sectionSpacing + defaultLineSpacing);
            addWrappedText("Beschreibung:", leftMargin, contentWidth, { fontSize: 11, fontStyle: 'bold', lineHeight: 6 });
            addWrappedText(idee.details, leftMargin, contentWidth, { fontSize: 10, lineHeight: defaultLineSpacing });
            yPosition += (sectionSpacing / 2);
        }

        if (idee.erinnerung && idee.erinnerung.termin) {
            checkAddPage(sectionSpacing + defaultLineSpacing * 4);
            addWrappedText("Erinnerung:", leftMargin, contentWidth, { fontSize: 11, fontStyle: 'bold', lineHeight: 6 });
            const erinnerungTextPDF = formatErinnerungForExport(idee.erinnerung).replace(/\n$/, "");
            addWrappedText(erinnerungTextPDF, leftMargin + 3, contentWidth - 3, { fontSize: 9, lineHeight: 4 });
            yPosition += (sectionSpacing / 2);
        }

        if (idee.beschreibungen && idee.beschreibungen.length > 0) {
            checkAddPage(sectionSpacing + defaultLineSpacing);
            addWrappedText("Weitere Beschreibungen:", leftMargin, contentWidth, { fontSize: 11, fontStyle: 'bold', lineHeight: 6 });
            idee.beschreibungen.forEach(b => {
                if (b && b.text !== undefined) {
                    checkAddPage(defaultLineSpacing);
                    const indentMM = (b.level || 0) * 5;
                    const startX = leftMargin + 5 + indentMM;
                    const maxWidth = contentWidth - 5 - indentMM;
                    const praefix = b.sichtbar === false ? "[Ausgeblendet] " : "";
                    const autorText = b.autor ? ` (von ${b.autor})` : "";
                    const textToDisplay = `- [${getFormattedDate(b.timestamp)}]${autorText} ${praefix}${b.text}`;
                    const textColor = b.sichtbar === false ? [128, 128, 128] : [0, 0, 0];
                    if (maxWidth > 0) {
                        addWrappedText(textToDisplay, startX, maxWidth, { fontSize: 10, lineHeight: defaultLineSpacing, color: textColor });
                    } else { 
                        addWrappedText(textToDisplay, leftMargin + 5, contentWidth - 5, { fontSize: 10, lineHeight: defaultLineSpacing, color: textColor });
                    }
                    if(b.attachments && b.attachments.length > 0) {
                        checkAddPage(defaultLineSpacing);
                        b.attachments.forEach(anhang => {
                            const anhangText = `         -> ${anhang.name}`;
                            const anhangColor = anhang.link ? [0, 0, 238] : [0,0,0];
                            addWrappedText(anhangText, startX + 5, maxWidth - 5, {fontSize: 9, color: anhangColor, lineHeight: 4, link: anhang.link});
                        });
                        yPosition += 2;
                    }
                     if (b.erinnerung && b.erinnerung.termin) {
                         checkAddPage(defaultLineSpacing * 3);
                         const erinnerungTextPDF = formatErinnerungForExport(b.erinnerung).replace(/\n$/, "").replace(/^/gm, "  ");
                         addWrappedText(erinnerungTextPDF, startX, maxWidth, { fontSize: 9, lineHeight: 4 });
                         yPosition += 2;
                     }
                }
            });
            yPosition += (sectionSpacing / 2);
        }

        if (idee.dateien && idee.dateien.length > 0) {
            checkAddPage(sectionSpacing + anhangLineHeight);
            addWrappedText("Anh√§nge:", leftMargin, contentWidth, { fontSize: 11, fontStyle: 'bold', lineHeight: 6 });
            let currentX = leftMargin + 5;
            for (let i = 0; i < idee.dateien.length; i++) {
                const f = idee.dateien[i];
                if (!f || !f.id) continue;
                const isLast = i === idee.dateien.length - 1;
                const istVeraltet = f.sichtbar === false;
                const praefix = istVeraltet ? "[Veraltet] " : "";
                let anhangDisplayName = `${praefix}${f.name || "Unbenannter Anhang"}`;
                const anhangTextMitKomma = anhangDisplayName + (isLast ? "" : ", ");
                doc.setFontSize(anhangFontSize);
                const textWidth = doc.getTextWidth(anhangTextMitKomma);
                const nameWidthForLink = doc.getTextWidth(anhangDisplayName);

                if (currentX + textWidth > doc.internal.pageSize.width - rightMargin && currentX > leftMargin + 5) {
                    currentX = leftMargin + 5;
                    yPosition += anhangLineHeight;
                    checkAddPage(anhangLineHeight);
                }
                const textY = yPosition;
                const charHeight = doc.getFontSize() / doc.internal.scaleFactor;

                if (f.link) {
                    const linkColor = istVeraltet ? [128, 128, 128] : [0, 0, 238];
                    doc.setTextColor(linkColor[0], linkColor[1], linkColor[2]);
                    doc.text(anhangTextMitKomma, currentX, textY);
                    doc.setDrawColor(linkColor[0], linkColor[1], linkColor[2]);
                    doc.line(currentX, textY + 1, currentX + nameWidthForLink, textY + 1); 
                    doc.link(currentX, textY - charHeight + 1, nameWidthForLink, charHeight, { url: f.link });
                    doc.setTextColor(0, 0, 0); 
                } else {
                    const textColor = istVeraltet ? [128, 128, 128] : [0, 0, 0];
                    doc.setTextColor(textColor[0], textColor[1], textColor[2]);
                    doc.text(anhangTextMitKomma, currentX, textY);
                    doc.setTextColor(0,0,0); 
                }
                currentX += textWidth;
            }
            yPosition += anhangLineHeight;
            yPosition += (sectionSpacing / 2);
        }
        yPosition += ideaSpacing;
    });

    doc.save(fileName);
    return true; 
}

async function teilePerEmail() {
    const ideenToExport = getExportIdeen();
    if (ideenToExport.length === 0) {
        zeigeWarnung("Keine Notizen f√ºr Export ausgew√§hlt oder Filter aktiv.", "info");
        return;
    }

    // --- MODIFIZIERTER EMAIL TEIL ---
    // Standard: Ausgew√§hlter Benutzer-Email
    let vorschlag = selectedUserEmail || "";
    
    const recipientInput = prompt("An wen soll die Information gesendet werden (E-Mail-Adresse)? Oder 'ich', 'mandant', 'support', 'andere' f√ºr interne Vermerke.", vorschlag);
    
    let recipientInfo = recipientInput ? recipientInput.trim().toLowerCase() : "";
    if (!recipientInfo) {
        zeigeWarnung("E-Mail-Versand abgebrochen.", "info");
        return;
    }
    
    let recipientEmailAddress = '';
    if (recipientInput.includes('@')) {
        recipientEmailAddress = encodeURIComponent(recipientInput.trim());
    } else if (!["ich", "mandant", "support", "andere"].includes(recipientInfo) && !recipientInfo.startsWith("andere:")) {
        recipientInfo = `Direkte Eingabe: ${recipientInput.trim()}`;
    } else if (recipientInfo === "andere") {
        const otherDetails = prompt("Zus√§tzliche Info f√ºr den Vermerk bei 'andere'?");
        if (!otherDetails?.trim()) {
            zeigeWarnung("Export abgebrochen, da keine Details f√ºr 'andere' angegeben wurden.");
            return;
        }
        recipientInfo = `Andere: ${otherDetails.trim()}`;
    }

    // 1. Log entry erstellen und lokal speichern
    let ideenImSpeicher = JSON.parse(localStorage.getItem("ideen") || "[]");
    const ausgewaehlteIDs = ideenToExport.map(i => i.id);
    const exportTimestamp = new Date().toLocaleString("de-DE");
    let pdfFileName; // Wird unten gesetzt
    let emailSubject; // Wird unten gesetzt

    ausgewaehlteIDs.forEach(ideeId => {
        const ideeIndex = ideenImSpeicher.findIndex(i => i && i.id === ideeId);
        if (ideeIndex !== -1) {
            if (ideenToExport.length === 1) {
                const idee = ideenToExport[0];
                pdfFileName = `Idee_${sanitizeFilename(idee.text || 'Unbenannte_Idee')}.pdf`;
                emailSubject = `Idee: ${idee.text || 'Unbenannte Idee'}`;
            } else {
                pdfFileName = `Ideen-Export_(${ideenToExport.length}_Notizen).pdf`;
                emailSubject = `Ideen-Export (${ideenToExport.length} Notizen)`;
            }

            const desc = `Informationen zur Weiterleitung per E-Mail an '${recipientInfo}' vorbereitet am ${exportTimestamp}.`;
            // Diese Art von Protokolleintrag wird nicht einger√ºckt, da sie sich auf die Haupt-Idee bezieht
            addProtokollEintrag(ideeId, null, desc);
        }
    });

    localStorage.setItem("ideen", JSON.stringify(ideenImSpeicher));
    zeigeIdeen();

    // 2. In OneDrive speichern
    const saveSuccess = await saveToOneDrive();

    // 3. Nur bei Erfolg die externe Aktion ausf√ºhren
    if (saveSuccess) {
        try {
            const pdfErstellt = exportiereAlsPDF(pdfFileName);
            if (!pdfErstellt) { 
                zeigeWarnung(`PDF "${pdfFileName}" konnte nicht erstellt werden.`, 'warnung');
                return;
            }
            zeigeWarnung(`PDF "${pdfFileName}" wurde heruntergeladen. Bitte manuell an die E-Mail anh√§ngen.`, 'success');
        } catch (e) {
            zeigeWarnung(`Fehler beim Erstellen der PDF: ${e.message}`, 'warnung');
            return;
        }

        const emailBody = encodeURIComponent(
            `Hallo,\n\nanbei die angeforderte Idee/die angeforderten Ideen als PDF-Datei.\n\n` +
            `Bitte h√§ngen Sie die Datei "${pdfFileName}", die zuvor heruntergeladen wurde, manuell an diese E-Mail an.\n\n` +
            `Mit freundlichen Gr√º√üen\nIhre Ideen-App`
        );

        const mailtoLink = `mailto:${recipientEmailAddress}?subject=${encodeURIComponent(emailSubject)}&body=${emailBody}`;

        try {
            setTimeout(() => { window.location.href = mailtoLink; }, 100);
            zeigeWarnung("Versuche, E-Mail-Client zu √∂ffnen...", "info");
        } catch (e) {
            zeigeWarnung(`Fehler beim √ñffnen des Mail-Programms: ${e.message}.`, "warnung");
        }
    } else {
        zeigeWarnung("Speichern fehlgeschlagen (Sitzung abgelaufen?). Der Vermerk wurde lokal gesichert. Bitte melden Sie sich an und versuchen Sie es erneut.", "warnung");
    }
}
/**
 * Sammelt eine Start-Beschreibung und alle hierarchisch untergeordneten Beschreibungen.
 * @param {string} ideeId Die ID der √ºbergeordneten Idee.
 * @param {string} startBeschreibungTimestamp Der Timestamp der Beschreibung, bei der der Block beginnt.
 * @returns {{idee: object, block: object[]}|null} Ein Objekt mit der Idee und dem Array des Beschreibungs-Blocks, oder null bei Fehler.
 */
function sammleBeschreibungsBlock(ideeId, startBeschreibungTimestamp) {
    const ideen = JSON.parse(localStorage.getItem("ideen") || "[]");
    const idee = ideen.find(i => i.id === ideeId);
    if (!idee || !idee.beschreibungen) {
        return null;
    }

    const startIndex = idee.beschreibungen.findIndex(b => b.timestamp === startBeschreibungTimestamp);
    if (startIndex === -1) {
        return null;
    }

    const startBeschreibung = idee.beschreibungen[startIndex];
    const startLevel = startBeschreibung.level || 0;
    const block = [startBeschreibung];

    for (let i = startIndex + 1; i < idee.beschreibungen.length; i++) {
        const naechsteBeschreibung = idee.beschreibungen[i];
        const naechstesLevel = naechsteBeschreibung.level || 0;

        if (naechstesLevel > startLevel) {
            block.push(naechsteBeschreibung);
        } else {
            // Der Block ist hier zu Ende, da das Level gleich oder kleiner ist.
            break;
        }
    }
    return { idee, block };
}


async function teileBeschreibungPerEmail(ideeId, beschreibungTimestamp) {
    if (!ideeId || !beschreibungTimestamp) { return; }
    
    // --- MODIFIZIERTER EMAIL TEIL (Beschreibung) ---
    // Da Beschreibungen einen Autor haben k√∂nnen, k√∂nnten wir hier auch schauen. 
    // Aber wir nehmen den global ausgew√§hlten User als Vorschlag.
    
    const recipientInput = prompt("An wen soll dieser Beschreibungs-Block gesendet werden (E-Mail-Adresse)? Oder 'ich', 'mandant', 'support', 'andere' f√ºr interne Vermerke.", selectedUserEmail || "");
    
    let recipientInfo = recipientInput ? recipientInput.trim().toLowerCase() : "";
    if (!recipientInfo) { zeigeWarnung("E-Mail-Versand abgebrochen.", "info"); return; }

    let recipientEmailAddress = '';
    if (recipientInput.includes('@')) {
        recipientEmailAddress = encodeURIComponent(recipientInput.trim());
    } else if (!["ich", "mandant", "support", "andere"].includes(recipientInfo) && !recipientInfo.startsWith("andere:")) {
        recipientInfo = `Direkte Eingabe: ${recipientInput.trim()}`;
    } else if (recipientInfo === "andere") {
        const otherDetails = prompt("Zus√§tzliche Info f√ºr den Vermerk bei 'andere'?");
        if (!otherDetails?.trim()) {
            zeigeWarnung("Versand abgebrochen, da keine Details f√ºr 'andere' angegeben wurden.");
            return;
        }
        recipientInfo = `Andere: ${otherDetails.trim()}`;
    }
    
    const exportTimestamp = new Date().toLocaleString("de-DE");
    const logDesc = `Beschreibungs-Block (beginnend mit Eintrag vom ${getFormattedDate(beschreibungTimestamp)}) weitergeleitet via E-Mail an: ${recipientInfo} am ${exportTimestamp}.`;
    
    if (!addProtokollEintrag(ideeId, beschreibungTimestamp, logDesc)) {
        zeigeWarnung("Fehler beim Erstellen des Protokolleintrags.", "warnung");
        return;
    }
    
    zeigeIdeen();

    const saveSuccess = await saveToOneDrive();

    if (saveSuccess) {
        const sammlung = sammleBeschreibungsBlock(ideeId, beschreibungTimestamp);
        if (!sammlung) {
            zeigeWarnung("Der zu teilende Block konnte nicht gefunden werden. Der Protokolleintrag wurde dennoch gespeichert.", "warnung");
            return;
        }
        const { idee, block } = sammlung;

        const emailSubject = `Teil-Information aus Vorgang ${idee.vorgangsnummer || 'N/A'}: ${idee.text || 'Ohne Titel'}`;
        
        let emailBody = `Hallo,\n\nhier die gew√ºnschten Informationen:\n\n`;
        emailBody += `--------------------------------------------------\n`;
        emailBody += `AUS VORGANG: ${idee.vorgangsnummer || 'N/A'} - ${idee.text || 'Ohne Titel'}\n`;
        emailBody += `--------------------------------------------------\n\n`;

        const startLevel = block[0].level || 0;

        block.forEach(beschreibung => {
            if (!beschreibung) return;
            const relativerIndent = (beschreibung.level || 0) - startLevel;
            const indentSpaces = "  ".repeat(relativerIndent);
            const autorText = beschreibung.autor ? ` (von ${beschreibung.autor})` : "";
            
            emailBody += `${indentSpaces}Beschreibung vom ${getFormattedDate(beschreibung.timestamp)}${autorText}:\n`;
            emailBody += `${indentSpaces}${beschreibung.text.replace(/\n/g, `\n${indentSpaces}`)}\n\n`;

            if (beschreibung.attachments && beschreibung.attachments.length > 0) {
                emailBody += `${indentSpaces}  Zugeh√∂rige Anh√§nge:\n`;
                beschreibung.attachments.forEach(anhang => {
                    emailBody += `${indentSpaces}  - ${anhang.name}`;
                    if (anhang.link) {
                        emailBody += `\n${indentSpaces}    Link: ${anhang.link}\n`;
                    } else {
                        emailBody += ` (Lokale Datei, nicht angeh√§ngt)\n`;
                    }
                });
                emailBody += `\n`;
            }
            
            if (beschreibung.erinnerung && beschreibung.erinnerung.aktiv && beschreibung.erinnerung.termin) {
                 const erinnerungText = formatErinnerungForExport(beschreibung.erinnerung).replace(/\n/g, `\n${indentSpaces}  `);
                 emailBody += `${indentSpaces}  Zugeh√∂rige Erinnerung:\n${indentSpaces}  ${erinnerungText}\n`;
            }
        });

        emailBody += `\nMit freundlichen Gr√º√üen\n\nIhre Ideen-App`;
        
        const mailtoLink = `mailto:${recipientEmailAddress}?subject=${encodeURIComponent(emailSubject)}&body=${encodeURIComponent(emailBody)}`;
        
        try {
            window.location.href = mailtoLink;
        } catch (e) {
            zeigeWarnung("Fehler beim √ñffnen des E-Mail-Programms: " + e.message, "warnung");
        }
    } else {
         zeigeWarnung("Speichern fehlgeschlagen (Sitzung abgelaufen?). Der Vermerk wurde lokal gesichert. Bitte melden Sie sich an und versuchen Sie es erneut.", "warnung");
    }
}

/**
 * NEU: Generiert einen vollst√§ndigen Text-String f√ºr eine Idee, inkl. aller Beschreibungen und Anh√§nge.
 * JETZT AKTUALISIERT: Bezieht Telefonnummern mit ein.
 * @param {object} idee - Das Ideen-Objekt.
 * @param {'text' | 'plain'} format - 'text' f√ºr WhatsApp (mit Markdown), 'plain' f√ºr Kalender (ohne).
 * @param {number | null} maxLaenge - Maximale L√§nge, wenn null, unbegrenzt.
 * @returns {string} Der formatierte Text-String.
 */
function generiereIdeenTextKomplett(idee, format = 'text', maxLaenge = null) {
    if (!idee) return "";

    const boldStart = format === 'text' ? '*' : '';
    const boldEnd = format === 'text' ? '*' : '';
    const italicStart = format === 'text' ? '_' : '';
    const italicEnd = format === 'text' ? '_' : '';
    const nl = '\n';
    let content = "";

    // 1. Titel und Metadaten
    content += `${idee.erledigt ? (format === 'text' ? '_[ERLEDIGT]_ ' : '[ERLEDIGT] ') : ''}${boldStart}${idee.vorgangsnummer ? `[Vorgang ${idee.vorgangsnummer}] ` : ''}${idee.text || 'Ohne Titel'}${boldEnd}${nl}`;
    content += `üìÅ Kat.: ${idee.kategorie||'-'}${nl}`;
    if(idee.benutzer) content += `üßë‚Äçüíª Zust.: ${idee.benutzer}${nl}`;
    content += `üîñ Prio: ${idee.prioritaet||"-"}${nl}`;
    content += `üìÖ ${getFormattedDate(idee.timestamp)}${idee.ersteller ? ` (von ${idee.ersteller})` : ''}${nl}`;
    if(idee.mandantennummer) content += `üè¢ Mandant: ${idee.mandantennummer}${nl}`;
    if(idee.firmenname) content += `üè≠ Firma: ${idee.firmenname}${nl}`;

    // NEU: Telefonnummern
    if (idee.telefonNummern && idee.telefonNummern.length > 0) {
        content += `${italicStart}Telefonnummern:${italicEnd}${nl}`;
        idee.telefonNummern.forEach(tel => {
            content += `  - ${tel.bezeichnung || 'Ohne Bez.'}: ${tel.nummer}${nl}`;
        });
    }

    // 2. Hauptbeschreibung
    if (idee.details) {
        content += `${nl}${boldStart}üìù Beschreibung:${boldEnd}${nl}${idee.details}${nl}`;
    }

    // 3. Haupt-Anh√§nge
    if (idee.dateien && idee.dateien.length > 0) {
        let sichtbareDateien = idee.dateien.filter(f => f && f.id && f.sichtbar !== false && f.link);
        if (sichtbareDateien.length > 0) {
            content += `${nl}${italicStart}Anh√§nge (Haupt):${italicEnd}${nl}`;
            sichtbareDateien.forEach(f => {
                content += `  - ${f.name || 'Anhang'}:${nl}    ${f.link}${nl}`;
            });
        }
    }

    // 4. Weitere Beschreibungen
    if (idee.beschreibungen && idee.beschreibungen.length > 0) {
        let sichtbareBeschreibungen = idee.beschreibungen.filter(b => b && b.text !== undefined && b.sichtbar !== false);
        if (sichtbareBeschreibungen.length > 0) {
            content += `${nl}${boldStart}Weitere Beschreibungen:${boldEnd}${nl}`;
            sichtbareBeschreibungen.forEach(b => {
                const indentSpaces = "  ".repeat(b.level || 0);
                const autorText = b.autor ? ` ${italicStart}(von ${b.autor})${italicEnd}` : "";
                content += `${nl}${indentSpaces}- [${getFormattedDate(b.timestamp)}]${autorText}:${nl}${indentSpaces}  ${b.text.replace(/\n/g, `\n${indentSpaces}  `)}${nl}`;
                
                if (b.attachments && b.attachments.length > 0) {
                    let sichtbareAnhaenge = b.attachments.filter(a => a && a.link);
                    if (sichtbareAnhaenge.length > 0) {
                         content += `${indentSpaces}  ${italicStart}Zugeh√∂rige Anh√§nge:${italicEnd}${nl}`;
                        sichtbareAnhaenge.forEach(anhang => {
                            content += `${indentSpaces}    - ${anhang.name}:${nl}${indentSpaces}      ${anhang.link}${nl}`;
                        });
                    }
                }
            });
        }
    }
    
    // 5. L√§ngenpr√ºfung und K√ºrzung
    if (maxLaenge !== null && content.length > maxLaenge) {
        const kuerzungsHinweis = `${nl}${nl}[... Inhalt gek√ºrzt, da zu lang f√ºr Kalendereintrag.]`;
        content = content.substring(0, maxLaenge - kuerzungsHinweis.length) + kuerzungsHinweis;
    }

    return content;
}


/* --- START BLOCK: WhatsApp Funktionen (Optimiert: Keine K√ºrzung + iOS/Desktop Fix) --- */

async function teilePerWhatsApp() {
    const ideenToExport = getExportIdeen();
    if (ideenToExport.length === 0) { zeigeWarnung("Bitte w√§hlen Sie Notizen f√ºr Export aus."); return; }

    // SCHRITT 1: ZUERST fragen (verhindert Fokus-Verlust am PC)
    const recipientInput = prompt("An wen soll exportiert werden? (z.B. 'Kunde', 'Chef')");
    
    if (recipientInput === null) { 
        zeigeWarnung("Export abgebrochen."); 
        return; 
    }
    
    let recipientInfo = recipientInput.trim() || "Unbekannt";

    // SCHRITT 2: Fenster SOFORT √∂ffnen (Apple- & Popup-Blocker-Trick)
    const waWindow = window.open('', '_blank');
    if (waWindow) {
        waWindow.document.write(`
            <html>
            <head><title>WhatsApp Export</title><style>body{font-family:sans-serif;padding:20px;text-align:center;a{text-decoration:none;}}</style></head>
            <body>
                <h2>WhatsApp wird vorbereitet...</h2>
                <p>Bitte warten Sie kurz, Ihre Daten werden gesichert.</p>
                <div id="loading" style="margin: 20px; font-size: 2em;">‚è≥</div>
                <div id="manualLink" style="display:none; margin-top:30px;">
                    <p>Daten bereit! Falls WhatsApp nicht automatisch √∂ffnet:</p>
                    <a id="waLinkTarget" href="#" style="background:#25D366; color:white; padding:15px 25px; border-radius:5px; font-weight:bold; font-size:1.2em; display:inline-block;">Jetzt an WhatsApp senden üöÄ</a>
                </div>
            </body>
            </html>
        `);
    }

    // SCHRITT 3: Protokoll erstellen
    const ausgewaehlteIDs = ideenToExport.map(i => i.id);
    const exportTimestamp = new Date().toLocaleString("de-DE");

    ausgewaehlteIDs.forEach(ideeId => {
        const desc = `Weiterleitung via WhatsApp vorbereitet f√ºr: ${recipientInfo} am ${exportTimestamp}`;
        addProtokollEintrag(ideeId, null, desc);
    });

    zeigeIdeen(); 

    // SCHRITT 4: Speichern (Warten auf Cloud)
    const saveSuccess = await saveToOneDrive();

    // SCHRITT 5: Link generieren und √∂ffnen (OHNE K√úRZUNG)
    if (waWindow) {
        const loadingDiv = waWindow.document.getElementById('loading');
        const manualLinkDiv = waWindow.document.getElementById('manualLink');
        const waLinkTarget = waWindow.document.getElementById('waLinkTarget');

        if (saveSuccess) {
            loadingDiv.style.display = 'none';
            manualLinkDiv.style.display = 'block';

            // Hier wird 'null' √ºbergeben = KEINE L√§ngenbegrenzung
            let text = ideenToExport.map(idee => {
                 return generiereIdeenTextKomplett(idee, 'text', null); 
            }).filter(Boolean).join("\n\n------------------------------------\n\n");

            text += `\n\n_[Gesendet via Ideen-App Pro]_`;
            
            // Text kodieren f√ºr die URL
            const waLink = `https://wa.me/?text=${encodeURIComponent(text)}`;
            
            // Link in den Button setzen (als Fallback)
            if(waLinkTarget) waLinkTarget.href = waLink;

            // Automatische Weiterleitung versuchen
            waWindow.location.href = waLink;
            
        } else {
            if(waWindow.document.body) {
                waWindow.document.body.innerHTML = "<h2 style='color:red'>Fehler beim Speichern!</h2><p>WhatsApp wird nicht ge√∂ffnet, da die Datensicherung fehlgeschlagen ist.</p>";
            }
            zeigeWarnung("Speichern fehlgeschlagen.", "warnung");
        }
    }
}

async function teileBeschreibungPerWhatsApp(ideeId, beschreibungTimestamp) {
    if (!ideeId || !beschreibungTimestamp) { return; }

    // SCHRITT 1: Fragen
    const recipientInput = prompt("An wen soll dieser Block gesendet werden?");
    
    if (recipientInput === null) { 
        zeigeWarnung("Export abgebrochen."); 
        return; 
    }
    
    let recipientInfo = recipientInput.trim() || "Unbekannt";

    // SCHRITT 2: Fenster √∂ffnen
    const waWindow = window.open('', '_blank');
    if (waWindow) {
        waWindow.document.write(`
            <html>
            <head><title>WhatsApp Export</title><style>body{font-family:sans-serif;padding:20px;text-align:center;}</style></head>
            <body>
                <h2>WhatsApp wird vorbereitet...</h2>
                <div id="loading" style="margin: 20px; font-size: 2em;">‚è≥</div>
            </body>
            </html>
        `);
    }

    // SCHRITT 3: Protokoll
    const exportTimestamp = new Date().toLocaleString("de-DE");
    const logDesc = `Beschreibungs-Block weitergeleitet via WhatsApp an: ${recipientInfo} am ${exportTimestamp}.`;
    
    addProtokollEintrag(ideeId, beschreibungTimestamp, logDesc);
    zeigeIdeen();

    // SCHRITT 4: Speichern
    const saveSuccess = await saveToOneDrive();

    // SCHRITT 5: WhatsApp (OHNE K√úRZUNG)
    if (saveSuccess) {
        const sammlung = sammleBeschreibungsBlock(ideeId, beschreibungTimestamp);
        if (!sammlung) {
            if(waWindow) waWindow.close();
            return zeigeWarnung("Datenfehler.");
        }
        const { idee, block } = sammlung;

        let text = `*Teil-Information aus Vorgang ${idee.vorgangsnummer || 'N/A'}: ${idee.text || 'Ohne Titel'}*\n\n`;
        const startLevel = block[0].level || 0;

        block.forEach(beschreibung => {
            if (!beschreibung) return;
            const relativerIndent = (beschreibung.level || 0) - startLevel;
            const indentSpaces = "   ".repeat(relativerIndent);
            const autorText = beschreibung.autor ? ` _(von ${beschreibung.autor})_` : "";
            
            text += `${indentSpaces}*Beschreibung vom ${getFormattedDate(beschreibung.timestamp)}${autorText}:*\n`;
            text += `${indentSpaces}${beschreibung.text}\n`;

            if (beschreibung.attachments && beschreibung.attachments.length > 0) {
                text += `${indentSpaces}  *Anh√§nge:*\n`;
                beschreibung.attachments.forEach(anhang => {
                    text += `${indentSpaces}  - ${anhang.name}`;
                    if (anhang.link) text += `\n${indentSpaces}    Link: ${anhang.link}\n`;
                });
            }
            text += '\n';
        });
        
        text += `\n\n_[Gesendet via Ideen-App Pro]_`;
        
        const waLink = `https://wa.me/?text=${encodeURIComponent(text)}`;
        
        if (waWindow) {
            waWindow.location.href = waLink;
        }
    } else {
         zeigeWarnung("Speichern fehlgeschlagen.", "warnung");
         if(waWindow) waWindow.close();
    }
}
/* --- ENDE BLOCK: WhatsApp Funktionen --- */

// --- FUNKTIONEN F√úR KALENDERTERMINERSTELLUNG ---

function zeigeTerminDialog(ideeId) {
    terminFuerId = ideeId;
    terminFuerBeschreibungTimestamp = null; // Sicherstellen, dass der alte Modus aktiv ist
    const ideen = JSON.parse(localStorage.getItem("ideen") || "[]");
    const idee = ideen.find(i => i && i.id === ideeId);

    if (!idee) {
        zeigeWarnung("Fehler: Idee f√ºr Termin nicht gefunden.", "warnung");
        return;
    }

    document.getElementById("terminTitelInput").value = idee.text || "Neuer Termin";

    const jetzt = new Date();
    const startStunde = jetzt.getHours() + 1;
    jetzt.setHours(startStunde);
    jetzt.setMinutes(0); 
    jetzt.setSeconds(0);
    jetzt.setMilliseconds(0);

    const startVorschlag = new Date(jetzt);
    const endeVorschlag = new Date(startVorschlag.getTime() + 60 * 60 * 1000);

    const toLocalISOString = (date) => {
        const year = date.getFullYear();
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const day = date.getDate().toString().padStart(2, '0');
        const hours = date.getHours().toString().padStart(2, '0');
        const minutes = date.getMinutes().toString().padStart(2, '0');
        return `${year}-${month}-${day}T${hours}:${minutes}`;
    };

    document.getElementById("terminStartInput").value = toLocalISOString(startVorschlag);
    document.getElementById("terminEndeInput").value = toLocalISOString(endeVorschlag);
    document.getElementById("terminOrtInput").value = "";

    document.getElementById("terminDialog").style.display = "block";
    document.getElementById("terminTitelInput").focus();
}

function zeigeBeschreibungTerminDialog(ideeId, beschreibungTimestamp) {
    terminFuerId = ideeId;
    terminFuerBeschreibungTimestamp = beschreibungTimestamp;

    const ideen = JSON.parse(localStorage.getItem("ideen") || "[]");
    const idee = ideen.find(i => i && i.id === ideeId);
    if (!idee) {
        zeigeWarnung("Fehler: Zugeh√∂rige Idee nicht gefunden.", "warnung");
        return;
    }
    const beschreibung = idee.beschreibungen.find(b => b && b.timestamp === beschreibungTimestamp);
    if (!beschreibung) {
        zeigeWarnung("Fehler: Beschreibung f√ºr Termin nicht gefunden.", "warnung");
        return;
    }

    let titelVorschlag = `${idee.text}: ${beschreibung.text}`;
    if (titelVorschlag.length > 50) {
        titelVorschlag = titelVorschlag.substring(0, 47) + "...";
    }
    document.getElementById("terminTitelInput").value = titelVorschlag;
    
    const jetzt = new Date();
    const startStunde = jetzt.getHours() + 1;
    jetzt.setHours(startStunde);
    jetzt.setMinutes(0); 
    jetzt.setSeconds(0);
    jetzt.setMilliseconds(0);

    const startVorschlag = new Date(jetzt);
    const endeVorschlag = new Date(startVorschlag.getTime() + 60 * 60 * 1000);

    const toLocalISOString = (date) => {
        const year = date.getFullYear();
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const day = date.getDate().toString().padStart(2, '0');
        const hours = date.getHours().toString().padStart(2, '0');
        const minutes = date.getMinutes().toString().padStart(2, '0');
        return `${year}-${month}-${day}T${hours}:${minutes}`;
    };

    document.getElementById("terminStartInput").value = toLocalISOString(startVorschlag);
    document.getElementById("terminEndeInput").value = toLocalISOString(endeVorschlag);
    document.getElementById("terminOrtInput").value = "";

    document.getElementById("terminDialog").style.display = "block";
    document.getElementById("terminTitelInput").focus();
}

function terminDialogAbbrechen() {
    document.getElementById("terminDialog").style.display = "none";
    terminFuerId = null;
    terminFuerBeschreibungTimestamp = null;
    document.getElementById("terminTitelInput").value = "";
    document.getElementById("terminStartInput").value = "";
    document.getElementById("terminEndeInput").value = "";
    document.getElementById("terminOrtInput").value = "";
}

/* --- START BLOCK: Kalender Funktionen (ICS / Apple Kompatibel) --- */

// Hilfsfunktion: Erstellt eine ICS-Datei (Standard Kalenderformat)
function downloadICSFile(titel, startInput, endInput, beschreibung, ort) {
    const formatDateForICS = (dateStr) => {
        const date = new Date(dateStr);
        return date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
    };

    const start = formatDateForICS(startInput);
    const end = formatDateForICS(endInput);
    const now = new Date().toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
    
    // Text sicher formatieren f√ºr Kalender-Datei
    const escapedDesc = (beschreibung || "").replace(/\n/g, "\\n").replace(/,/g, "\\,");
    const escapedTitel = (titel || "").replace(/,/g, "\\,");
    const escapedOrt = (ort || "").replace(/,/g, "\\,");

    const icsContent = [
        "BEGIN:VCALENDAR",
        "VERSION:2.0",
        "PRODID:-//IdeenAppPro//DE",
        "CALSCALE:GREGORIAN",
        "BEGIN:VEVENT",
        `DTSTAMP:${now}`,
        `DTSTART:${start}`,
        `DTEND:${end}`,
        `SUMMARY:${escapedTitel}`,
        `DESCRIPTION:${escapedDesc}`,
        `LOCATION:${escapedOrt}`,
        "STATUS:CONFIRMED",
        "END:VEVENT",
        "END:VCALENDAR"
    ].join("\r\n");

    const blob = new Blob([icsContent], { type: "text/calendar;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.href = url;
    link.setAttribute("download", "termin.ics"); // Dateiname
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
}

async function kalenderTerminErstellenUndSpeichern() {
    if (!terminFuerId) return;
    const MAX_KALENDER_BESCHREIBUNG = 7500;
    const titel = document.getElementById("terminTitelInput").value.trim();
    const startZeitValue = document.getElementById("terminStartInput").value;
    const endeZeitValue = document.getElementById("terminEndeInput").value;
    const ort = document.getElementById("terminOrtInput").value.trim();

    if (!titel || !startZeitValue || !endeZeitValue) {
        zeigeWarnung("Bitte alle Pflichtfelder ausf√ºllen.", "warnung");
        return;
    }
    
    let ideen = JSON.parse(localStorage.getItem("ideen") || "[]");
    const ideeIndex = ideen.findIndex(i => i.id === terminFuerId);
    if (ideeIndex === -1) { zeigeWarnung("Idee nicht gefunden.", "warnung"); return; }
    
    const idee = ideen[ideeIndex];
    let terminBeschreibungText = "";
    let nachweisText = "";
    
    // Beschreibung zusammenbauen
    if (terminFuerBeschreibungTimestamp) {
        const sammlung = sammleBeschreibungsBlock(terminFuerId, terminFuerBeschreibungTimestamp);
        if (sammlung) {
            terminBeschreibungText = `Auszug aus Vorgang ${idee.vorgangsnummer}: ${idee.text}\n\n`;
            sammlung.block.forEach(b => {
                 terminBeschreibungText += `- ${b.text}\n`;
            });
            nachweisText = `Kalendertermin (ICS) erstellt f√ºr Teil-Block. Titel: "${titel}".`;
        }
    } else {
        terminBeschreibungText = generiereIdeenTextKomplett(idee, 'plain', MAX_KALENDER_BESCHREIBUNG);
        nachweisText = `Kalendertermin (ICS) erstellt f√ºr Termin: ${getFormattedDate(startZeitValue)}.`;
    }

    // 1. Protokolleintrag erstellen
    addProtokollEintrag(terminFuerId, terminFuerBeschreibungTimestamp, nachweisText);
    zeigeIdeen();

    // 2. ERST SPEICHERN
    const saveSuccess = await saveToOneDrive();

    // 3. DANN DATEI DOWNLOADEN
    if (saveSuccess) {
        downloadICSFile(titel, startZeitValue, endeZeitValue, terminBeschreibungText, ort);
        zeigeWarnung("Termin-Datei (.ics) geladen. Bitte √∂ffnen!", "success");
        terminDialogAbbrechen();
    } else {
        zeigeWarnung("Speichern fehlgeschlagen. Termin-Datei wird nicht erstellt.", "warnung");
    }
}
/* --- ENDE BLOCK: Kalender Funktionen --- */
async function initialisiereUndStarteBenachrichtigungspruefung() {
    if (!("Notification" in window)) {
        console.warn("Dieser Browser unterst√ºtzt keine Desktop-Benachrichtigungen.");
        zeigeWarnung("Browser unterst√ºtzt keine Benachrichtigungen.", "info");
        return;
    }

    if (Notification.permission === "granted") {
        starteBenachrichtigungspruefung();
    } else if (Notification.permission !== "denied") {
        try {
            const permission = await Notification.requestPermission();
            if (permission === "granted") {
                zeigeWarnung("Benachrichtigungen wurden aktiviert!", "success");
                starteBenachrichtigungspruefung();
            } else {
                zeigeWarnung("Benachrichtigungen wurden nicht aktiviert.", "info");
            }
        } catch (error) {
            console.error("Fehler beim Anfordern der Benachrichtigungsberechtigung:", error);
            zeigeWarnung("Fehler bei Benachrichtigungs-Berechtigung.", "warnung");
        }
    } else {
        zeigeWarnung("Benachrichtigungen sind blockiert. Bitte in den Browser-Einstellungen √§ndern.", "info");
    }
}

function starteBenachrichtigungspruefung() {
    if (benachrichtigungsIntervallId) {
        clearInterval(benachrichtigungsIntervallId);
    }
    benachrichtigungsIntervallId = setInterval(pruefeUndZeigeBenachrichtigungen, 60000);
    console.log("Benachrichtigungspr√ºfung gestartet.");
    pruefeUndZeigeBenachrichtigungen(); 
}

function pruefeUndZeigeBenachrichtigungen() {
    if (Notification.permission !== "granted") {
        return;
    }

    let ideen = JSON.parse(localStorage.getItem("ideen") || "[]");
    if (!Array.isArray(ideen)) return;

    const jetzt = new Date();
    let aenderungenVorgenommen = false;

    ideen.forEach(idee => {
        if (!idee) return;

        const handleFrist = (erinnerungObjekt, istBeschreibung = false, beschreibungText = "") => {
            const terminDatum = new Date(erinnerungObjekt.termin);
            if (terminDatum <= jetzt) {
                let titel, bodyText, tag;
                if (istBeschreibung) {
                    titel = `Vorgang ${idee.vorgangsnummer || 'N/A'}: ${idee.text}`;
                    bodyText = `Detail-Erinnerung: "${beschreibungText}"`;
                    tag = idee.id + '_' + erinnerungObjekt.termin + '_desc';
                } else {
                    titel = erinnerungObjekt.titel || idee.text || "Ideen-App Erinnerung";
                    bodyText = `Ihre Erinnerung f√ºr "${titel}" (Vorgang: ${idee.vorgangsnummer || 'N/A'}) ist jetzt f√§llig.`;
                    tag = idee.id + '_' + erinnerungObjekt.termin;
                }
                
                try {
                    const notification = new Notification(titel, { body: bodyText, tag: tag });
                    notification.onclick = function() {
                        window.focus(); 
                        this.close();
                    };
                } catch (e) {
                    console.error("Fehler beim Erstellen der Benachrichtigung:", e);
                }

                if (erinnerungObjekt.intervallTyp === 'einmalig') {
                    erinnerungObjekt.aktiv = false;
                } else {
                    let naechsterTermin = new Date(terminDatum);
                    let intervallValid = true;
                    switch (erinnerungObjekt.intervallTyp) {
                        case 'tage':
                            if (erinnerungObjekt.intervallWert > 0) naechsterTermin.setDate(terminDatum.getDate() + parseInt(erinnerungObjekt.intervallWert, 10)); else intervallValid = false;
                            break;
                        case 'woechentlich': naechsterTermin.setDate(terminDatum.getDate() + 7); break;
                        case 'monatlich': naechsterTermin.setMonth(terminDatum.getMonth() + 1); break;
                        case 'vierteljaehrlich': naechsterTermin.setMonth(terminDatum.getMonth() + 3); break;
                        case 'jaehrlich': naechsterTermin.setFullYear(terminDatum.getFullYear() + 1); break;
                        default: intervallValid = false; break;
                    }

                    if (!intervallValid) {
                        erinnerungObjekt.aktiv = false;
                    } else if (erinnerungObjekt.aktiv) {
                        while (naechsterTermin <= jetzt && (erinnerungObjekt.intervallTyp === 'tage' && erinnerungObjekt.intervallWert > 0)) {
                           naechsterTermin.setDate(naechsterTermin.getDate() + parseInt(erinnerungObjekt.intervallWert, 10));
                        }
                        if (naechsterTermin > jetzt) {
                            erinnerungObjekt.termin = naechsterTermin.toISOString();
                        } else {
                            erinnerungObjekt.aktiv = false;
                        }
                    }
                }
                aenderungenVorgenommen = true;
            }
        };

        if (idee.erinnerung && idee.erinnerung.aktiv && idee.erinnerung.termin) {
            handleFrist(idee.erinnerung, false);
        }

        if (idee.beschreibungen && Array.isArray(idee.beschreibungen)) {
            idee.beschreibungen.forEach(beschreibung => {
                if (beschreibung && beschreibung.erinnerung && beschreibung.erinnerung.aktiv && beschreibung.erinnerung.termin) {
                    handleFrist(beschreibung.erinnerung, true, beschreibung.text);
                }
            });
        }
    });

    if (aenderungenVorgenommen) {
        localStorage.setItem("ideen", JSON.stringify(ideen));
        zeigeIdeen(); 
        triggerAutoSave();
        console.log("Ideenliste nach Benachrichtigungspr√ºfung aktualisiert.");
    }
}

/* ANFANG √ÑNDERUNG: Neuer Upload f√ºr gro√üe Dateien (Chunking) */
async function uploadToOneDrive(file) {
    if (currentLoginType !== 'microsoft') {
        zeigeWarnung("Bitte zuerst mit Microsoft anmelden!");
        return null;
    }

    const fileName = `ideenapp/${Date.now()}_${file.name}`;
    // Wir teilen die Datei in 10 MB St√ºcke (Microsoft empfiehlt Vielfache von 320 KB)
    const CHUNK_SIZE = 10485760; // ~10 MB

    try {
        // --- FALL 1: KLEINE DATEI (< 4 MB) ---
        // Schneller Standard-Upload wie bisher
        if (file.size < 4000000) {
            let uploadUrl = `https://graph.microsoft.com/v1.0/me/drive/root:/${fileName}:/content`;
            let uploadOptions = {
                method: "PUT",
                headers: { "Authorization": `Bearer ${accessToken}`, "Content-Type": file.type },
                body: file
            };

            let uploadResponse = await fetch(uploadUrl, uploadOptions);

            // Token Refresh bei Fehler 401
            if (uploadResponse.status === 401) {
                const newToken = await getValidToken(true);
                if (newToken) {
                    uploadOptions.headers["Authorization"] = `Bearer ${newToken}`;
                    uploadResponse = await fetch(uploadUrl, uploadOptions);
                } else { return null; }
            }

            if (!uploadResponse.ok) {
                const errData = await uploadResponse.json().catch(() => ({}));
                throw new Error(errData.error?.message || uploadResponse.statusText);
            }

            const uploadData = await uploadResponse.json();
            return await createSharingLink(uploadData.id);
        }

        // --- FALL 2: GROSSE DATEI (> 4 MB) - Neuer "Gest√ºckelter" Upload ---
        else {
            zeigeWarnung(`Starte Upload f√ºr gro√üe Datei (${(file.size / 1024 / 1024).toFixed(1)} MB)... Bitte warten.`, 'info');

            // Schritt A: Upload-Sitzung bei Microsoft anmelden
            const sessionUrl = `https://graph.microsoft.com/v1.0/me/drive/root:/${fileName}:/createUploadSession`;
            let sessionResponse = await fetch(sessionUrl, {
                method: "POST",
                headers: {
                    "Authorization": `Bearer ${accessToken}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    item: { "@microsoft.graph.conflictBehavior": "rename" }
                })
            });

            if (!sessionResponse.ok) throw new Error("Upload-Session konnte nicht gestartet werden.");
            const sessionData = await sessionResponse.json();
            const uploadUrl = sessionData.uploadUrl;

            // Schritt B: Datei scheibchenweise hochladen
            let start = 0;
            let end = 0;

            while (start < file.size) {
                end = Math.min(start + CHUNK_SIZE, file.size);
                const chunk = file.slice(start, end);

                // Fortschritt berechnen und anzeigen
                const percent = Math.round((end / file.size) * 100);
                zeigeWarnung(`Upload l√§uft: ${percent}% (${file.name})`, 'info');
                console.log(`Upload Chunk: ${start}-${end} von ${file.size}`);

                const chunkResponse = await fetch(uploadUrl, {
                    method: "PUT",
                    headers: {
                        "Content-Length": chunk.size,
                        "Content-Range": `bytes ${start}-${end - 1}/${file.size}`
                    },
                    body: chunk
                });

                if (!chunkResponse.ok) {
                    throw new Error(`Fehler beim Upload von Teil ${start}-${end}`);
                }

                // Wenn Status 201 oder 200 kommt, ist die Datei komplett fertig
                if (chunkResponse.status === 201 || chunkResponse.status === 200) {
                    const uploadData = await chunkResponse.json();
                    zeigeWarnung("Upload abgeschlossen! Erstelle Freigabelink...", 'success');
                    return await createSharingLink(uploadData.id);
                }

                // Weitermachen mit dem n√§chsten St√ºck
                start = end;
            }
        }

    } catch (e) {
        console.error("OneDrive Upload Fehler:", e);
        zeigeWarnung("Fehler beim Upload: " + e.message, 'warnung');
        return null;
    }
}

// Hilfsfunktion: Erstellt den √∂ffentlichen Link f√ºr eine hochgeladene Datei
async function createSharingLink(itemId) {
    let linkUrl = `https://graph.microsoft.com/v1.0/me/drive/items/${itemId}/createLink`;
    let linkOptions = {
        method: "POST",
        headers: { "Authorization": `Bearer ${accessToken}`, "Content-Type": "application/json" },
        body: JSON.stringify({ type: "view", scope: "anonymous" })
    };
    
    let linkResponse = await fetch(linkUrl, linkOptions);

    // Token Refresh falls zwischendurch abgelaufen
    if (linkResponse.status === 401) {
        const newToken = await getValidToken(true);
        if (newToken) {
            linkOptions.headers["Authorization"] = `Bearer ${newToken}`;
            linkResponse = await fetch(linkUrl, linkOptions);
        } else { return null; }
    }

    if (!linkResponse.ok) throw new Error("Link konnte nicht erstellt werden.");
    const linkData = await linkResponse.json();
    return linkData.link.webUrl;
}
/* ENDE √ÑNDERUNG */
async function saveToOneDrive(isManual = false){ 
    if(currentLoginType !== 'microsoft' || !msalInstance) { 
        if (isManual) { 
            zeigeWarnung("Bitte f√ºr die Speicherung mit Microsoft anmelden.", "info");
        }
        return false;
    } 
    if (!(await getValidToken(isManual))) { // Bei manuellem Speichern interaktiven Refresh erlauben
        if (isManual) zeigeWarnung("Sitzung konnte nicht erneuert werden. Speichern fehlgeschlagen.", "warnung");
        return false;
    }

    clearTimeout(debounceTimer);
    updateOneDriveStatus('saving', 'Wird gespeichert...');
    
    try { 
        const ideen=JSON.parse(localStorage.getItem("ideen")||"[]"); 
        const benutzer=JSON.parse(localStorage.getItem("benutzerliste")||"[]"); 
        const kategorien=JSON.parse(localStorage.getItem("kategorien")||"[]"); 
        const nummer=localStorage.getItem("naechsteVorgangsnummer")||"1"; 
        const data={ideen,benutzerliste:benutzer,kategorien,naechsteVorgangsnummer:nummer}; 
        const dataStr=JSON.stringify(data,null,2); 
        const path=(document.getElementById("onedrivePath").value.trim()||"/ideenapp/ideen.json"); 
        const finalPath=path.startsWith('/')?path:'/'+path; 
        if(!finalPath||finalPath==='/'){
            updateOneDriveStatus('error', '‚úó Ung√ºltiger Pfad');
            zeigeWarnung("OneDrive Speichern: Ung√ºltiger Pfad.");
            return false;
        }
        const url=`https://graph.microsoft.com/v1.0/me/drive/root:${finalPath}:/content`; 
        const res=await fetch(url,{method:"PUT",headers:{"Authorization":`Bearer ${accessToken}`,"Content-Type":"application/json"},body:dataStr}); 
        if(res.ok){
            istGespeichert=true;
            updateOneDriveStatus('saved', '‚úì Gespeichert');
            console.log("Daten erfolgreich auf OneDrive gespeichert.");
            if (!isManual) {
                setTimeout(() => {
                    if (istGespeichert) { 
                        updateOneDriveStatus('hidden', '');
                    }
                }, 4000);
            }
            return true;
        }else{
             if (res.status === 401) {
                 handleExpiredSession();
            } else {
                const err=await res.json().catch(()=>null); 
                const msg=err?.error?.message||res.statusText; 
                zeigeWarnung(`OneDrive Speichern Fehler: ${msg}`);
            }
            istGespeichert = false;
            updateOneDriveStatus('error', '‚úó Fehler beim Speichern');
            return false;
        }
    }catch(e){
        zeigeWarnung("OneDrive Speichern Fehler: "+e.message);
        istGespeichert = false;
        updateOneDriveStatus('error', '‚úó Fehler beim Speichern');
        return false;
    }
}

async function startLoadFromOneDrive() {
    if (!istGespeichert && !confirm("Sie haben ungespeicherte lokale √Ñnderungen. M√∂chten Sie diese verwerfen und die Daten von OneDrive neu laden?")) {
        return;
    }
    if (await getValidToken(true)) {
        await loadFromOneDrive();
    } else {
        zeigeWarnung("Sitzung konnte nicht erneuert werden. Laden fehlgeschlagen.", "warnung");
    }
}

async function loadFromOneDrive(){ 
    const path=(document.getElementById("onedrivePath").value.trim()||"/ideenapp/ideen.json"); 
    const finalPath=path.startsWith('/')?path:'/'+path; 
    if(!finalPath||finalPath==='/'){
        updateOneDriveStatus('error', '‚úó Ung√ºltiger Pfad');
        zeigeWarnung("OneDrive Laden: Ung√ºltiger Pfad.");
        return;
    }
    zeigeWarnung(`Lade Daten von OneDrive: ${finalPath}...`,'info'); 
    updateOneDriveStatus('saving', 'Lade Daten...');
    try{ 
        const url=`https://graph.microsoft.com/v1.0/me/drive/root:${finalPath}:/content`; 
        const res=await fetch(url,{method:"GET",headers:{"Authorization":`Bearer ${accessToken}`}}); 
        if(res.ok){ 
            const content=await res.text(); 
            const loadedData=JSON.parse(content); 
            let ideen=[], benutzerliste=[], kategorienAusDatei=null, nummer=1; 
            if(loadedData&&typeof loadedData==='object'&&Array.isArray(loadedData.ideen)){ 
                ideen=loadedData.ideen; 
                benutzerliste=Array.isArray(loadedData.benutzerliste)?loadedData.benutzerliste:[]; 
                kategorienAusDatei=Array.isArray(loadedData.kategorien)?loadedData.kategorien:null; 
                nummer=parseInt(loadedData.naechsteVorgangsnummer,10)||1; 
            } else if(Array.isArray(loadedData)){
                ideen=loadedData; 
                benutzerliste=[]; 
                kategorienAusDatei=null; 
                nummer=1;
            } else {
                throw new Error("Ung√ºltiges Dateiformat");
            }
            localStorage.setItem("ideen",JSON.stringify(ideen)); 
            localStorage.setItem("benutzerliste",JSON.stringify(benutzerliste)); 
            if(kategorienAusDatei!==null){localStorage.setItem("kategorien",JSON.stringify(kategorienAusDatei));} 
            localStorage.setItem("naechsteVorgangsnummer", nummer.toString()); 
            
            ausgewaehlt=[]; 
            initialisiereKategorien(); 
            initialisiereBenutzer(); 
            initialisiereVorgangsnummer(); 
            ensureIdeasHaveIds(); 
            aktualisiereMandantenFilterDropdown(); 
            zeigeIdeen(); 
            zeigeWarnung(`Daten von OneDrive geladen! (${finalPath})`,'success'); 
            istGespeichert=true; 
            updateOneDriveStatus('saved', '‚úì Geladen & Synchron');
            setTimeout(() => {
                if (istGespeichert) { updateOneDriveStatus('hidden', ''); }
            }, 5000);
        } else if(res.status===404){
            zeigeWarnung(`Keine bestehende Datenbank unter '${finalPath}' gefunden. Eine neue wird beim ersten Speichern angelegt.`, 'info');
            localStorage.removeItem("ideen");
            localStorage.removeItem("kategorien");
            localStorage.removeItem("benutzerliste");
            localStorage.removeItem("naechsteVorgangsnummer");
            naechsteVorgangsnummer = 1;
            kategorien = [];
            benutzerliste = [];
            initialisiereKategorien();
            initialisiereBenutzer();
            initialisiereVorgangsnummer();
            zeigeIdeen();
            istGespeichert = true;
            updateOneDriveStatus('saved', '‚úì Neue Datei bereit');
        }else{ 
            if (res.status === 401) { // Unauthorized
                handleExpiredSession();
                return;
            }
            const err=await res.json().catch(()=>null); 
            const msg=err?.error?.message||res.statusText;
            updateOneDriveStatus('error', '‚úó Fehler beim Laden');
            zeigeWarnung(`OneDrive Laden Fehler (${res.status}): ${msg}`);
        }
    }catch(e){
        updateOneDriveStatus('error', '‚úó Fehler beim Laden');
        zeigeWarnung("OneDrive Laden Fehler: "+e.message);
    }
}

async function speichereIdeenAlsDatei(){ try{ const ideen = JSON.parse(localStorage.getItem("ideen")||"[]"); const benutzerData = JSON.parse(localStorage.getItem("benutzerliste")||"[]"); const kategorienData = JSON.parse(localStorage.getItem("kategorien")||"[]"); const nummer = localStorage.getItem("naechsteVorgangsnummer")||"1"; const combinedData = { ideen, benutzerliste: benutzerData, kategorien: kategorienData, naechsteVorgangsnummer: nummer }; const dataToSave = JSON.stringify(combinedData, null, 2); if(window.showSaveFilePicker){ fileHandle = await window.showSaveFilePicker({ suggestedName: "ideen.json", types: [{ description: "JSON-Dateien", accept: { "application/json": [".json"] } }] }); const writable = await fileHandle.createWritable(); await writable.write(dataToSave); await writable.close(); zeigeWarnung("Datei lokal gespeichert!", 'success'); } else { const blob = new Blob([dataToSave], { type: "application/json" }); const url = URL.createObjectURL(blob); const link = document.createElement("a"); link.href = url; link.download = "ideen.json"; link.click(); URL.revokeObjectURL(url); zeigeWarnung("Datei-Download gestartet.", 'success'); }} catch(e) { if(e.name !== "AbortError") { zeigeWarnung("Fehler beim lokalen Speichern: " + e.message); } }}
async function ladeIdeenAusDatei(){ try{ let fileContent; if(window.showOpenFilePicker){ [fileHandle] = await window.showOpenFilePicker({ types: [{ description: "JSON-Dateien", accept: { "application/json": [".json"] } }] }); const file = await fileHandle.getFile(); fileContent = await file.text(); } else { const input = document.createElement('input'); input.type = 'file'; input.accept = '.json'; await new Promise((resolve, reject) => { input.onchange = async (e) => { if (e.target.files && e.target.files.length > 0) { const file = e.target.files[0]; const reader = new FileReader(); reader.onload = (event) => { fileContent = event.target.result; resolve(); }; reader.onerror = (error) => reject(error); reader.readAsText(file); } else { reject(new Error("Keine Datei ausgew√§hlt")); } }; input.click(); }); } if (!fileContent) { throw new Error("Kein Dateiinhalt geladen."); } const loadedData = JSON.parse(fileContent); let ideen = [], benutzerliste = [], kategorienAusDatei = null, nummer = 1; if (loadedData && typeof loadedData === 'object' && Array.isArray(loadedData.ideen)) { ideen = loadedData.ideen; benutzerliste = Array.isArray(loadedData.benutzerliste) ? loadedData.benutzerliste : []; kategorienAusDatei = Array.isArray(loadedData.kategorien) ? loadedData.kategorien : null; nummer = parseInt(loadedData.naechsteVorgangsnummer, 10) || 1; } else if (Array.isArray(loadedData)) { ideen = loadedData; benutzerliste = []; kategorienAusDatei = null; nummer = 1; } else { throw new Error("Ung√ºltiges Dateiformat"); } localStorage.setItem("ideen", JSON.stringify(ideen)); localStorage.setItem("benutzerliste", JSON.stringify(benutzerliste)); if (kategorienAusDatei !== null) { localStorage.setItem("kategorien", JSON.stringify(kategorienAusDatei)); } localStorage.setItem("naechsteVorgangsnummer", nummer.toString()); ausgewaehlt = []; initialisiereKategorien(); initialisiereBenutzer(); initialisiereVorgangsnummer(); ensureIdeasHaveIds(); aktualisiereMandantenFilterDropdown(); zeigeIdeen(); zeigeWarnung(`Daten lokal geladen!`, 'success'); triggerAutoSave(); } catch(e) { if(e.name !== "AbortError" && e.message !== "Keine Datei ausgew√§hlt" && e.message !== "Kein Dateiinhalt geladen.") { zeigeWarnung("Fehler beim lokalen Laden: " + e.message); } }}

/**
 * F√ºgt einen neuen Protokolleintrag (eine spezielle 'Beschreibung') hinzu,
 * wobei dieser automatisch eine Stufe tiefer als der Quell-Eintrag einger√ºckt wird.
 * @param {string} ideeId Die ID der √ºbergeordneten Idee.
 * @param {string|null} quellBeschreibungTimestamp Timestamp des Eintrags, der diese Aktion ausgel√∂st hat. Bei null wird der Eintrag auf Level 0 am Ende hinzugef√ºgt.
 * @param {string} protokollText Der Text f√ºr den neuen Protokolleintrag.
 * @returns {boolean} True bei Erfolg, false bei Misserfolg.
 */
function addProtokollEintrag(ideeId, quellBeschreibungTimestamp, protokollText) {
    let ideen = JSON.parse(localStorage.getItem("ideen") || "[]");
    const ideeIndex = ideen.findIndex(i => i && i.id === ideeId);
    if (ideeIndex === -1) {
        console.error("Idee f√ºr Protokolleintrag nicht gefunden.");
        return false;
    }

    if (!ideen[ideeIndex].beschreibungen) {
        ideen[ideeIndex].beschreibungen = [];
    }
    
    let basisLevel = 0;
    let einfuegePosition = ideen[ideeIndex].beschreibungen.length; // Standard: am Ende der Liste

    if (quellBeschreibungTimestamp) {
        const quellIndex = ideen[ideeIndex].beschreibungen.findIndex(b => b && b.timestamp === quellBeschreibungTimestamp);
        if (quellIndex !== -1) {
            basisLevel = (ideen[ideeIndex].beschreibungen[quellIndex].level || 0) + 1;
            
            // Finde das Ende des Blocks (alle untergeordneten Punkte), um den neuen Eintrag korrekt danach einzuf√ºgen
            let letzterUnterpunktIndex = quellIndex;
            for (let i = quellIndex + 1; i < ideen[ideeIndex].beschreibungen.length; i++) {
                if ((ideen[ideeIndex].beschreibungen[i].level || 0) > (ideen[ideeIndex].beschreibungen[quellIndex].level || 0)) {
                    letzterUnterpunktIndex = i;
                } else {
                    break; // Ende des Blocks erreicht
                }
            }
            einfuegePosition = letzterUnterpunktIndex + 1;

        } else {
            console.warn("Quell-Beschreibung f√ºr Protokolleintrag nicht gefunden. F√ºge am Ende an.");
        }
    }

    const ts = new Date().toISOString() + '_' + Math.random().toString(36).substr(2, 9);
    const neuerEintrag = {
        text: protokollText,
        timestamp: ts,
        level: basisLevel, // Setzt das neue, einger√ºckte Level
        sichtbar: true,
        attachments: [],
        erinnerung: getDefaultErinnerung(),
        autor: aktuellerBenutzerName || "System"
    };

    ideen[ideeIndex].beschreibungen.splice(einfuegePosition, 0, neuerEintrag);
    
    localStorage.setItem("ideen", JSON.stringify(ideen));
    return true;
}


// --- Event Listener f√ºr √Ñnderungen und Auto-Save ---
document.getElementById("ideeText").addEventListener("input", triggerAutoSave);
document.getElementById("ideeDetails").addEventListener("input", triggerAutoSave);
document.getElementById("mandantennummer").addEventListener("input", triggerAutoSave);
document.getElementById("firmenname").addEventListener("input", triggerAutoSave);
document.getElementById("kategorie").addEventListener("change", triggerAutoSave);
document.getElementById("benutzer").addEventListener("change", triggerAutoSave);
document.getElementById("dateien").addEventListener("change",function(e){
    const v=document.getElementById("dateiVorschau");
    v.innerHTML="Ausgew√§hlte Dateien (werden beim Speichern hinzugef√ºgt):<br>";
    Array.from(e.target.files).forEach(file=>{
       v.innerHTML+=`<span style="display:inline-block; margin:3px; font-size:0.9em; background:#eee; padding: 2px 5px; border-radius: 3px;">üìÑ ${file.name}</span>`;
    });
    triggerAutoSave();
});
window.addEventListener("beforeunload",function(e){if(!istGespeichert){const msg="Ungespeicherte √Ñnderungen! Seite wirklich verlassen?";e.preventDefault();e.returnValue=msg;return msg;}});

/**
 * Stellt sicher, dass alle Ideen-Objekte die moderne Datenstruktur haben.
 * F√ºhrt Migrationen f√ºr alte Datenstrukturen durch.
 * JETZT AKTUALISIERT: F√ºgt das 'telefonNummern'-Array hinzu, falls es fehlt.
 */
function ensureIdeasHaveIds() {
    let ideen = [];
    try {
        const storedIdeen = localStorage.getItem("ideen");
        if (storedIdeen) { ideen = JSON.parse(storedIdeen); }
    } catch(e) { 
        console.error("Fehler beim Parsen von 'ideen' aus localStorage in ensureIdeasHaveIds:", e);
        localStorage.removeItem("ideen"); 
        ideen = []; 
    }

    let changed = false;
    if (!Array.isArray(ideen)) { 
        ideen = []; 
        changed = true; 
    }

    const initialIdeenLength = ideen.length;
    ideen = ideen.filter(idee => idee && typeof idee === 'object' && idee.id && typeof idee.id === 'string');
    if (ideen.length < initialIdeenLength) { 
        changed = true; 
        console.warn("Einige Ideen wurden entfernt, da sie keine valide Struktur oder ID hatten.");
    }

    ideen.forEach(idee => {
        if (idee.ersteller === undefined) {
            idee.ersteller = null;
            changed = true;
        }

        if (!Array.isArray(idee.beschreibungen)) { idee.beschreibungen = []; changed = true; }
        else {
            if (idee.beschreibungen.length > 0 && typeof idee.beschreibungen[0] === 'string') {
                idee.beschreibungen = idee.beschreibungen.map(text => ({ text: text, timestamp: new Date().toISOString() + '_' + Math.random().toString(36).substr(2, 9), level: 0, sichtbar: true, attachments: [], erinnerung: getDefaultErinnerung(), autor: null }));
                changed = true;
            } else {
                const originalLengthDesc = idee.beschreibungen.length;
                idee.beschreibungen = idee.beschreibungen.filter(b => b && typeof b === 'object' && typeof b.text === 'string');
                idee.beschreibungen.forEach(b => {
                    if (b.autor === undefined) {
                        b.autor = null;
                        changed = true;
                    }
                    if (!b.timestamp || typeof b.timestamp !== 'string') { b.timestamp = new Date().toISOString() + '_' + Math.random().toString(36).substr(2, 9); changed = true; }
                    if (typeof b.level !== 'number' || b.level < 0) { b.level = 0; changed = true; }
                    if (typeof b.sichtbar !== 'boolean') { b.sichtbar = true; changed = true; }
                    if (!Array.isArray(b.attachments)) { b.attachments = []; changed = true; }
                    if (!b.erinnerung || typeof b.erinnerung !== 'object') { b.erinnerung = getDefaultErinnerung(); changed = true; }
                });
                if (idee.beschreibungen.length < originalLengthDesc) { changed = true; }
            }
        }

        if (!Array.isArray(idee.dateien)) { idee.dateien = []; changed = true; }
        else {
            const originalLengthFiles = idee.dateien.length;
            idee.dateien = idee.dateien.filter(d => d && typeof d === 'object');
            idee.dateien.forEach(datei => {
                if (!datei.id || typeof datei.id !== 'string') { datei.id = generateUUID(); changed = true; }
                if (typeof datei.sichtbar !== 'boolean') { datei.sichtbar = true; changed = true; }
                if (datei.link === undefined) { datei.link = null; changed = true; }
                if (datei.data) { delete datei.data; changed = true; }
                if (datei.pfad) { delete datei.pfad; changed = true; }
            });
             if (idee.dateien.length < originalLengthFiles) { changed = true; }
        }

        const defaultErinnerung = getDefaultErinnerung(idee.text, idee.vorgangsnummer);
        if (!idee.erinnerung || typeof idee.erinnerung !== 'object') {
            idee.erinnerung = { ...defaultErinnerung };
            changed = true;
        } else {
            let erinnerungChanged = false;
            for (const key in defaultErinnerung) {
                if (idee.erinnerung[key] === undefined) {
                    idee.erinnerung[key] = defaultErinnerung[key];
                    erinnerungChanged = true;
                }
            }
            if (typeof idee.erinnerung.aktiv !== 'boolean') { idee.erinnerung.aktiv = defaultErinnerung.aktiv; erinnerungChanged = true; }
            if (idee.erinnerung.termin && typeof idee.erinnerung.termin !== 'string') { idee.erinnerung.termin = null; erinnerungChanged = true;}
            if (typeof idee.erinnerung.intervallTyp !== 'string') { idee.erinnerung.intervallTyp = defaultErinnerung.intervallTyp; erinnerungChanged = true; }
            
            if (idee.erinnerung.intervallTyp === 'tage' && (typeof idee.erinnerung.intervallWert !== 'number' || idee.erinnerung.intervallWert < 1) && idee.erinnerung.intervallWert !== null) {
                idee.erinnerung.intervallWert = defaultErinnerung.intervallWert; 
                erinnerungChanged = true;
            } else if (idee.erinnerung.intervallTyp !== 'tage') { 
                if (idee.erinnerung.intervallWert !== null) {
                    idee.erinnerung.intervallWert = null;
                    erinnerungChanged = true;
                }
            }

            if (typeof idee.erinnerung.vorabErinnerungAktiv !== 'boolean') { idee.erinnerung.vorabErinnerungAktiv = defaultErinnerung.vorabErinnerungAktiv; erinnerungChanged = true; }
            if (idee.erinnerung.vorabErinnerungAktiv) {
                if ((typeof idee.erinnerung.vorabWert !== 'number' || idee.erinnerung.vorabWert < 1) && idee.erinnerung.vorabWert !== null) {
                    idee.erinnerung.vorabWert = defaultErinnerung.vorabWert; erinnerungChanged = true;
                }
                if (typeof idee.erinnerung.vorabEinheit !== 'string') {
                    idee.erinnerung.vorabEinheit = defaultErinnerung.vorabEinheit; erinnerungChanged = true;
                }
            } else { 
                 if (idee.erinnerung.vorabWert !== null) { idee.erinnerung.vorabWert = null; erinnerungChanged = true; }
                 if (idee.erinnerung.vorabEinheit !== null) { idee.erinnerung.vorabEinheit = null; erinnerungChanged = true; }
            }
            if (idee.erinnerung.titel !== idee.text) { idee.erinnerung.titel = idee.text; erinnerungChanged = true;}
            if (idee.erinnerung.vorgangsnummer !== idee.vorgangsnummer) { idee.erinnerung.vorgangsnummer = idee.vorgangsnummer; erinnerungChanged = true;}
            if(erinnerungChanged) changed = true;
        }

        // --- NEUER TEIL ---
        // Stellt sicher, dass das 'telefonNummern'-Array existiert
        if (!Array.isArray(idee.telefonNummern)) {
            idee.telefonNummern = [];
            changed = true;
        }
        // --- ENDE NEUER TEIL ---

        if (idee.benutzer === undefined) { idee.benutzer = ""; changed = true; }
        if (idee.mandantennummer === undefined) { idee.mandantennummer = ""; changed = true; }
        if (idee.firmenname === undefined) { idee.firmenname = ""; changed = true; }
        if (typeof idee.erledigt !== 'boolean') { idee.erledigt = false; changed = true; }
        if (idee.vorgangsnummer === undefined) { idee.vorgangsnummer = null; changed = true; } 
        if (idee.prioritaet === undefined) { idee.prioritaet = ""; changed = true; }
        if (!idee.timestamp || typeof idee.timestamp !== 'string') { idee.timestamp = new Date().toISOString(); changed = true; }
    });

    if (changed) {
        try { 
            localStorage.setItem("ideen", JSON.stringify(ideen)); 
            console.log("Datenmigration in ensureIdeasHaveIds durchgef√ºhrt und gespeichert.");
        }
        catch (e) { 
            zeigeWarnung("Speicherfehler nach Datenmigration!"); 
            console.error("Fehler beim Speichern nach ensureIdeasHaveIds:", e);
        }
    }
}

async function versucheSitzungWiederherzustellen() {
    const savedLoginType = sessionStorage.getItem('loginType');
    const savedUserEmail = sessionStorage.getItem('userEmail');
    const savedUserName = sessionStorage.getItem('userName');

    if (!savedLoginType || !savedUserEmail || !savedUserName) {
        console.log("Keine gespeicherte Sitzung gefunden.");
        updateButtonVisibility(null);
        return;
    }

    console.log(`Versuche, Sitzung f√ºr ${savedUserEmail} wiederherzustellen...`);

    if (savedLoginType === 'microsoft') {
        const savedAccountId = sessionStorage.getItem('msalAccountIdentifier');
        if (!savedAccountId) {
            console.warn("Microsoft-Sitzung gefunden, aber keine Account-ID. Erneute Anmeldung erforderlich.");
            handleLogout(false);
            return;
        }
        
        if (!msalInstance) {
            msalInstance = new msal.PublicClientApplication(msalConfig);
        }

        await msalInstance.initialize();
        const account = await msalInstance.getAccountByHomeId(savedAccountId);

        if (account) {
            msalInstance.setActiveAccount(account);
            currentLoginType = 'microsoft';
            
            const token = await getValidToken(false, false); 
            
            if (token) {
                aktuellerBenutzerName = savedUserName;
                updateLoggedInUI(savedUserName, savedUserEmail);
                updateButtonVisibility(savedUserEmail);
                
                clearInterval(tokenRefreshIntervalId);
                tokenRefreshIntervalId = setInterval(() => getValidToken(false, true), 10 * 60 * 1000);
                console.log("Token-√úberwachung ('Wachhund') nach Sitzungswiederherstellung gestartet.");
                
                await loadFromOneDrive();
                
                // NEU: Auch beim Reload Stammdaten laden
                loadSharedStammdaten();
            } else {
                 console.log("Stille Sitzungswiederherstellung fehlgeschlagen. Alte Sitzungsdaten werden gel√∂scht.");
                 handleLogout(false);
            }
        } else {
             console.log("Gespeicherter MSAL Account konnte nicht gefunden werden. Erneute Anmeldung erforderlich.");
             handleLogout(false);
        }

    } else if (savedLoginType === 'github') {
        currentLoginType = 'github';
        aktuellerBenutzerName = savedUserName;
        updateLoggedInUI(savedUserName, savedUserEmail);
        updateButtonVisibility(savedUserEmail);
        console.log("GitHub UI-Sitzung wiederhergestellt.");
    }
}

document.addEventListener('DOMContentLoaded', async () => {
    try {
        initialisiereKategorien();
        initialisiereBenutzer();
        initialisiereVorgangsnummer();
        ensureIdeasHaveIds(); // Stellt sicher, dass auch 'telefonNummern' initialisiert wird
        aktualisiereMandantenFilterDropdown();
        zeigeIdeen();
        initialisiereUndStarteBenachrichtigungspruefung();

        const urlParams = new URLSearchParams(window.location.search);
        const githubCode = urlParams.get('code');
        
        if (githubCode) {
            await handleGithubCallback(githubCode);
        } else {
            await versucheSitzungWiederherzustellen();
        }

        pruebeLoginHinweis(); 
        
        // --- NEUER TEIL ---
        // F√ºgt den Klick-Listener f√ºr den "Telefonnummer hinzuf√ºgen"-Button hinzu
        document.getElementById('addTelefonNummerBtn').onclick = () => addTelefonNummerInput();
        // --- ENDE NEUER TEIL ---
        
    } catch (initError) {
        console.error("Fehler w√§hrend der Initialisierung:", initError);
        zeigeWarnung("Ein Fehler ist beim Starten der App aufgetreten.", "warnung");
    }
});
/* ANFANG √ÑNDERUNG: Verbesserte Logik inklusive Archiv-Filter */
function updateVorgangsnummerDropdown() {
    const selMandant = document.getElementById("filterMandant")?.value.toLowerCase() || "";
    const selKategorie = document.getElementById("filterKategorie")?.value || "";
    const selBenutzer = document.getElementById("filterBenutzer")?.value.toLowerCase() || "";
    // NEU: Archiv-Status abrufen
    const selArchiv = document.getElementById("filterArchiv")?.value || "alle";
    
    const selVorgang = document.getElementById("filterVorgangsnummer");
    
    // Aktuelle Auswahl merken
    const aktuelleWahl = selVorgang.value;

    let ideen = [];
    try { ideen = JSON.parse(localStorage.getItem("ideen") || "[]"); } catch (e) { return; }

    // Nur Nummern holen, die zu den aktuellen Filtern passen
    const relevanteIdeen = ideen.filter(i => {
        if (!i || !i.vorgangsnummer) return false;
        
        // Bestehende Filter
        if (selMandant && (i.mandantennummer || "").toLowerCase() !== selMandant) return false;
        if (selKategorie && i.kategorie !== selKategorie) return false;
        if (selBenutzer && (i.benutzer || "").toLowerCase() !== selBenutzer) return false;

        // NEU: Archiv-Filter anwenden
        if (selArchiv === "nicht_erledigt" && i.erledigt) return false;
        if (selArchiv === "erledigt" && !i.erledigt) return false;

        return true;
    });

    // Nummern sortieren (Neueste oben)
    const nummern = [...new Set(relevanteIdeen.map(i => i.vorgangsnummer))].sort((a, b) => b - a);

    // Dropdown neu bef√ºllen
    selVorgang.innerHTML = '<option value=""># Alle</option>';
    nummern.forEach(num => {
        const opt = document.createElement("option");
        opt.value = num;
        opt.textContent = `Vorgang ${num}`;
        selVorgang.appendChild(opt);
    });

    // Alte Auswahl wiederherstellen, falls noch g√ºltig
    if (aktuelleWahl && nummern.includes(parseInt(aktuelleWahl))) {
        selVorgang.value = aktuelleWahl;
    } else {
        selVorgang.value = "";
    }
}

// Initialisierung beim Start
document.addEventListener('DOMContentLoaded', () => {
    setTimeout(updateVorgangsnummerDropdown, 500);
});
/* ENDE √ÑNDERUNG */
</script>
</body>
</html>