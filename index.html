<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Ideen-App Pro</title>
<style>
/* --- CSS Styles --- */
html,body{box-sizing:border-box;margin:0;padding:0;background:#f4f4f4;width:100vw;max-width:100vw;overflow-x:hidden;}
body{font-family:Arial,sans-serif;margin:0 0 20px 0;}
input,select,textarea{margin-top:10px;padding:10px;font-size:1em;width:400px;max-width:100vw;box-sizing:border-box;display:block;}
textarea{min-height:60px;}
button{padding:10px 18px;font-size:1em;margin-top:10px;margin-right:8px;border-radius:4px;border:1px solid #bbb;background:#eee;cursor:pointer;width:auto;min-width:44px;display:inline-block;}
button:disabled { cursor: not-allowed; opacity: 0.6; }
.buttons,.top-actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;}
.filter-bar{margin:20px 0;}
.filter-bar label, .filter-bar select,.filter-bar input{width:auto;display:inline-block;margin-right:10px;margin-top:0;}
.filter-bar button { margin-top: 0; }
.idee{width:100%;max-width:100vw;box-sizing:border-box;overflow-wrap:break-word;word-break:break-word;background:white;padding:15px;margin:10px 0;border-radius:8px;box-shadow:0 0 5px #ccc;display:flex;align-items:flex-start;justify-content:space-between;}
.idee.erledigt{background:#f0f0f0;}
.idee-content{flex:1;max-width:100%;overflow-wrap:break-word;word-break:break-word;font-size:1em;line-height:1.5;}
.idee-content h3,.idee-content p,.idee-content small{max-width:100%;overflow-wrap:break-word;word-break:break-word;font-size:1em;}
.idee.erledigt .idee-content h3,.idee.erledigt .idee-content p,.idee.erledigt .idee-content small{text-decoration:line-through;color:#888;}
.beschreibung-historie{margin:8px 0 12px 0;}
.beschreibung-item{margin:4px 0 4px 0;padding:6px 8px;background:#f8f8f8;border-left:3px solid #bbb;font-size:0.98em;display:flex;justify-content:space-between;align-items:center;box-sizing:border-box;transition:opacity .3s ease;}
.beschreibung-text-zeit { flex-grow: 1; margin-right: 10px; overflow-wrap: break-word; word-break: break-word; }
.beschreibung-zeit{color:#666;font-size:0.9em;margin-bottom:2px;display:block;}
.beschreibung-eingabe, .erinnerung-dialog-content {margin:10px 0;background:#f9f9f9;border-left:3px solid #bbb;padding:15px; border-radius: 5px;}
.idee-checkbox{margin-left:10px;margin-top:5px;min-width:28px;min-height:28px;}
.idee-actions{margin-top:10px;display:flex;gap:5px;flex-wrap:wrap;}
.idee-actions button{width:auto;min-width:44px;padding:6px 10px;font-size:0.95em;}
.prio-btn{background:#eee;border:1px solid #ccc;border-radius:4px;}
.prio-btn.selected{background:#ffd700;border-color:#ff9800;color:#222;}
#vorgangsnummerAnzeigeInput { margin-top: 15px; margin-bottom: -5px; font-size: 0.9em; color: #555; }
.vorgangsnummer-anzeige-liste { font-weight: bold; font-size: 0.95em; color: #333; margin-bottom: 5px; }
#warnung { margin: 10px 0; font-weight: bold; padding: 10px; border-radius: 4px; display: none; position: fixed; top: 10px; left: 50%; transform: translateX(-50%); z-index: 1000; width: auto; max-width: 80%; text-align: center; }
#warnung.warnung{ color:#d32f2f; border: 1px solid #d32f2f; background-color: #ffe0e0; }
#warnung.success-message { color: #388e3c; border: 1px solid #388e3c; background-color: #e8f5e9; }
#warnung.info-message { color: #1a73e8; border: 1px solid #1a73e8; background-color: #e8f0fe; }
.beschreibung-item .edit-beschreibung-btn, .beschreibung-item .add-anhang-beschreibung-btn { padding: 3px 6px; font-size: 0.8em; margin-top: 0; min-width: auto; width: auto; height: 24px; line-height: 1; display: flex; align-items: center; justify-content: center; }
.top-actions .onedrive-btn { background: #0078d4; color: white; border-color: #005a9e; }
.anhang-veraltet { opacity: 0.7; }
.anhang-veraltet .datei-link { text-decoration: line-through; color: grey !important; }
.toggle-anhang-sichtbarkeit-btn { padding: 1px 4px !important; font-size: 0.8em !important; margin-left: 8px !important; line-height: 1 !important; min-width: auto !important; width: auto !important; margin-top: 0 !important; vertical-align: middle !important; border-radius: 3px !important; border: 1px solid #ccc !important; background: #f0f0f0 !important; cursor: pointer; }
.beschreibung-item-actions { display: flex; gap: 3px; align-items: center; flex-shrink: 0; }
.move-beschreibung-btn { padding: 3px 5px !important; font-size: 1em !important; line-height: 1 !important; min-width: auto !important; width: auto !important; height: 24px !important; margin: 0 !important; vertical-align: middle; background-color: #f0f0f0 !important; border: 1px solid #ccc !important; border-radius: 3px !important; cursor: pointer; }
.beschreibung-veraltet { opacity: 0.6; }
.beschreibung-veraltet .beschreibung-text-zeit { color: grey; }
.toggle-beschreibung-sichtbarkeit-btn { padding: 1px 4px !important; font-size: 0.8em !important; margin-left: 3px !important; line-height: 1 !important; min-width: auto !important; width: auto !important; margin-top: 0 !important; vertical-align: middle !important; border-radius: 3px !important; border: 1px solid #ccc !important; background: #f0f0f0 !important; cursor: pointer; height: 24px !important; display: flex; align-items: center; justify-content: center; }
.beschreibung-anhaenge { font-size: 0.9em; margin-top: 5px; padding-left: 10px; border-left: 2px solid #ddd; }
.beschreibung-anhang-item { display: flex; align-items: center; margin-bottom: 2px; }
.erinnerung-info { font-size: 0.85em; color: #0078d4; margin-top: 5px; }
.beschreibung-erinnerung-info { font-size: 0.9em; color: #0078d4; margin-top: 4px; padding: 3px 0 3px 10px; }
.erinnerung-dialog-content label { display: block; margin-top:10px; font-weight: bold;}
.erinnerung-dialog-content input[type="datetime-local"], .erinnerung-dialog-content select, .erinnerung-dialog-content input[type="number"], .erinnerung-dialog-content input[type="text"] { width: calc(100% - 22px); }
.erinnerung-dialog-content .checkbox-label { display: inline-block; font-weight: normal; margin-left: 5px;}
.erinnerung-dialog-content input[type="checkbox"] { width: auto; display: inline-block; margin-right: 5px; vertical-align: middle;}
#adminPanel { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 500px; background: white; border: 1px solid #ccc; box-shadow: 0 5px 15px rgba(0,0,0,0.3); z-index: 2000; padding: 20px; }
#adminPanel h3 { margin-top: 0; }
#whitelistEditor { width: 100%; height: 150px; }
#accessDeniedMessage { display: none; text-align: center; padding: 40px; background: #fff; margin: 20px; border-radius: 8px; }
.app-container.hidden { display: none; }
@media (max-width:600px){
    input,select,textarea,button{width:100vw;min-width:0;max-width:100vw;}
    .buttons,.top-actions,.filter-bar{flex-direction:column;gap:0;}
    .filter-bar label, .filter-bar select, .filter-bar input, .filter-bar button { margin-right: 0; margin-bottom: 10px; }
    .idee{flex-direction:column;}
    .idee-checkbox{margin-left:0;margin-top:10px;}
    .idee-content,.idee-actions,.datei-link,.datei-info,.datei-vorschau,.idee-checkbox{max-width:100vw;}
    .beschreibung-item { flex-direction: column; align-items: flex-start; width: 100% !important; margin-left: 0 !important; padding-left: 8px; }
    .beschreibung-text-zeit { margin-right: 0; margin-bottom: 5px; width: 100%; }
    .beschreibung-item-actions { margin-top: 5px; width: 100%; justify-content: flex-start; flex-wrap: wrap; }
    #warnung { position: static; transform: none; left: auto; max-width: 100%; }
    .toggle-anhang-sichtbarkeit-btn { float: right; }
    .erinnerung-dialog-content input[type="datetime-local"], .erinnerung-dialog-content select, .erinnerung-dialog-content input[type="number"], .erinnerung-dialog-content input[type="text"] { width: 100%; }
}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://alcdn.msauth.net/browser/2.24.0/js/msal-browser.min.js"></script>
</head>
<body>

<div id="accessDeniedMessage">
    <h2>Zugriff verweigert</h2>
    <p>Sie sind nicht berechtigt, diese Anwendung zu nutzen.</p>
    <p>Bitte kontaktieren Sie den Administrator, um eine Freischaltung zu beantragen.</p>
</div>

<div class="app-container">
    <h1>Ideen-App Pro</h1>
    <div id="warnung"></div> <div id="loginHinweis" class="warnung" style="display:none;">Anmeldung erforderlich: Bitte melden Sie sich zuerst mit Ihrem Microsoft-Konto an. Ohne Anmeldung sind keine Cloud-Links und keine Synchronisation möglich.</div>

    <div id="vorgangsnummerAnzeigeInput">Nächste Vorgangsnummer: <span id="naechsteNummerAnzeige">1</span></div>
    <input type="text" id="ideeText" placeholder="Titel*" />
    <textarea id="ideeDetails" placeholder="Beschreibung" rows="3"></textarea>
    <input type="text" id="mandantennummer" placeholder="Mandantennummer (optional)" />
    <input type="text" id="firmenname" placeholder="Firmenname (optional)" />
    <select id="kategorie"></select> <input type="text" id="neueKategorie" placeholder="Neue Kategorie" /> <button onclick="neueKategorieHinzufuegen()">+ Kat</button> <button class="katLoeschBtn" onclick="kategorieLoeschen()">Kat löschen</button> <select id="benutzer"></select> <input type="text" id="neuerBenutzer" placeholder="Neuer Benutzer" /> <button onclick="neuenBenutzerHinzufuegen()">+ User</button> <button class="benutzerLoeschBtn" onclick="benutzerLoeschen()">User löschen</button> <div class="buttons"> <button id="prioHoch" class="prio-btn" onclick="setzePrioritaet('Hoch')">🔴 Hoch</button> <button id="prioMittel" class="prio-btn" onclick="setzePrioritaet('Mittel')">🟠 Mittel</button> <button id="prioNiedrig" class="prio-btn" onclick="setzePrioritaet('Niedrig')">🟢 Niedrig</button> </div>
    <input type="file" id="dateien" multiple /> <div class="datei-vorschau" id="dateiVorschau"></div>
    <button id="speichernBtn" onclick="speichereIdee()">💾 Speichern</button> <button id="abbrechenBtn" onclick="abbrechenBearbeiten()" style="display:none;">Abbrechen</button>

    <div class="filter-bar">
    <label>Filter:</label> <select id="filterKategorie" onchange="zeigeIdeen()"><option value="" class="filter-option-alle">🎯 Alle Ideen</option></select>
    <label>Archiv:</label> <select id="filterArchiv" onchange="zeigeIdeen()"><option value="nicht_erledigt">Nur nicht erledigt</option><option value="erledigt">Nur erledigt</option><option value="alle">Alle anzeigen</option></select>
    <label>Benutzer:</label> <select id="filterBenutzer" onchange="filterNachBenutzer()"></select>
    <label>Mandant:</label> <select id="filterMandant" onchange="filterNachMandant()"><option value="">🏢 Alle Mandanten</option></select>
    <label>Sortierung:</label> <select id="sortierung" onchange="zeigeIdeen()"><option value="standard">Standard</option><option value="neu">Neueste zuerst</option><option value="alt">Älteste zuerst</option><option value="prio">Nach Priorität</option></select>
    </div>

    <div class="top-actions">
    <button onclick="showAdminPanel()" id="adminButton" style="display:none; background:#ffc107; color: black; border-color: #e0a800;">👤 Benutzer verwalten</button>
    <button onclick="exportiereAlsPDF()">📝 PDF</button> <button onclick="exportiereAlsText()">📄 Text</button> <button onclick="teilePerEmail()">✉️ E-Mail</button> <button onclick="teilePerWhatsApp()">📱 WhatsApp</button>
    <input type="text" id="onedrivePath" placeholder="/ideenapp/ideen.json" style="width: 250px; margin-top: 0;"/> <button class="onedrive-btn" onclick="saveToOneDrive()">☁️ OneDrive Speichern</button> <button class="onedrive-btn" onclick="loadFromOneDrive()">☁️ OneDrive Laden</button>
    <button onclick="alleIdeenLoeschen()" style="background:#eee;border:1px solid #c00;color:#c00;">Alle löschen</button> <button onclick="ausgewaehlteNotizenLoeschen()" style="background:#eee;border:1px solid #c00;color:#c00;">Auswahl löschen</button>
    <button id="speicherDateiBtn" onclick="speichereIdeenAlsDatei()">Datei speichern</button> <button id="oeffneDateiBtn" onclick="ladeIdeenAusDatei()">Datei öffnen</button>
    <button onclick="anmeldenUndLaden()" style="background:#005a9e; color: white; border-color: #004578;">🔑☁️ Anmelden & Laden</button>
    <button onclick="handleLogin()" style="background:#e6f4ff;border-color:#0067b8;color:#0067b8;">🔑 Anmelden</button> 
    <button onclick="handleLogout()" style="background:#ffe0e0;border-color:#c00;color:#c00;">🔒 Abmelden</button>
    </div>

    <div id="ideenListe"></div>
    <div id="beschreibungDialog" style="display:none;" class="beschreibung-eingabe"> <textarea id="beschreibungText" placeholder="Weitere Beschreibung" rows="2"></textarea> <button onclick="beschreibungSpeichern()">💾 Speichern</button> <button onclick="beschreibungAbbrechen()">❌ Abbrechen</button> </div>

    <input type="file" id="beschreibungAnhangInput" style="display: none;" onchange="handleBeschreibungAnhangUpload(event)" multiple>

    <div id="erinnerungDialog" style="display:none;" class="erinnerung-dialog-content">
        <h3>Erinnerung einstellen</h3>
        <label for="erinnerungTerminInput">Termin (Datum und Uhrzeit):</label>
        <input type="datetime-local" id="erinnerungTerminInput" />

        <label for="erinnerungIntervallTypSelect">Intervall:</label>
        <select id="erinnerungIntervallTypSelect" onchange="toggleErinnerungIntervallWert()">
            <option value="einmalig">Einmalig</option>
            <option value="tage">Alle X Tage</option>
            <option value="woechentlich">Wöchentlich</option>
            <option value="monatlich">Monatlich</option>
            <option value="vierteljaehrlich">Vierteljährlich</option>
            <option value="jaehrlich">Jährlich</option>
        </select>
        <div id="erinnerungIntervallWertContainer" style="display:none;">
          <label for="erinnerungIntervallWertInput">Anzahl Tage:</label>
          <input type="number" id="erinnerungIntervallWertInput" min="1" value="1" />
        </div>

        <input type="checkbox" id="erinnerungVorabCheckbox" onchange="toggleErinnerungVorabDetails()">
        <label for="erinnerungVorabCheckbox" class="checkbox-label">Vorab-Erinnerung</label>

        <div id="erinnerungVorabDetailsContainer" style="display:none;">
            <label for="erinnerungVorabWertInput">Vorab-Wert:</label>
            <input type="number" id="erinnerungVorabWertInput" min="1" value="10"/>
            <label for="erinnerungVorabEinheitSelect">Vorab-Einheit:</label>
            <select id="erinnerungVorabEinheitSelect">
                <option value="minuten">Minute(n)</option>
                <option value="stunden">Stunde(n)</option>
                <option value="tage">Tag(e)</option>
                <option value="wochen">Woche(n)</option>
            </select>
        </div>
        <div class="buttons">
            <button onclick="erinnerungSpeichern()">💾 Speichern</button>
            <button onclick="erinnerungLoeschen()">🗑️ Löschen</button>
            <button onclick="erinnerungAbbrechen()">❌ Abbrechen</button>
        </div>
    </div>

    <div id="terminDialog" style="display:none;" class="erinnerung-dialog-content">
        <h3>Neuen Kalendertermin erstellen</h3>
        <label for="terminTitelInput">Titel des Termins:</label>
        <input type="text" id="terminTitelInput" />

        <label for="terminStartInput">Startzeit:</label>
        <input type="datetime-local" id="terminStartInput" />

        <label for="terminEndeInput">Endzeit:</label>
        <input type="datetime-local" id="terminEndeInput" />

        <label for="terminOrtInput">Ort (optional):</label>
        <input type="text" id="terminOrtInput" placeholder="Ort des Termins" />

        <p style="font-size:0.9em; margin-top:15px;">Hinweis: Die Beschreibungen der Idee werden automatisch in die Terminbeschreibung übernommen.</p>

        <div class="buttons">
            <button onclick="kalenderTerminErstellenUndSpeichern()">🗓️ Kalenderlink erstellen & Vermerk speichern</button>
            <button onclick="terminDialogAbbrechen()">❌ Abbrechen</button>
        </div>
    </div>
</div>

<div id="adminPanel">
    <h3>Benutzerverwaltung</h3>
    <p>Fügen Sie hier die E-Mail-Adressen der berechtigten Benutzer hinzu (eine pro Zeile).</p>
    <textarea id="whitelistEditor"></textarea>
    <div class="buttons">
        <button onclick="saveWhitelistToLocalStorage()">Lokal speichern</button>
        <button onclick="saveWhitelistToOneDrive()">Liste in OneDrive speichern</button>
        <button onclick="closeAdminPanel()">Schließen</button>
    </div>
</div>

<script>
console.log("Script started");
/* --- START BLOCK 4: Script Start, Variables & Initializers --- */
// KORRIGIERT: Der Platzhalter wurde durch den bereitgestellten Link ersetzt.
// HINWEIS: SharePoint-Links können beim direkten Abruf (fetch) zu CORS-Fehlern führen.
// Ein direkter, anonymer Download-Link (z. B. von einem Public Repo oder Blob Storage) ist zuverlässiger.
const whitelistUrl = "https://unimakgmbh-my.sharepoint.com/:u:/g/personal/admin_unimakgmbh_onmicrosoft_com/EdC-9NYTxy9Or3fpEa8EQpkBfkeFvYQwBOPaw3x4_KI3_A?e=PnchDd&download=1";

const adminEmail = "admin@unimakgmbh.onmicrosoft.com";
const adminPasswordHash = "NDUwMV9raXdpMg=="; // Base64 kodiertes Passwort "4501_kiwi2"

const msalConfig={auth:{clientId:"c3cd3be4-3540-46dd-a24c-82eb6ed5542d",authority:"https://login.microsoftonline.com/common",redirectUri: "https://ecki-android.github.io"}};
let accessToken=null, msalInstance=null, prioritaet="", bearbeiteId=null, ausgewaehlt=[], fileHandle=null, beschreibungFuerId=null, beschreibungZuBearbeitenderTimestamp=null, istGespeichert=!0;
let erinnerungFuerId = null;
let erinnerungFuerBeschreibungTimestamp = null;
let terminFuerId = null;
let anhangFuerBeschreibungZiel = { ideeId: null, timestamp: null };
let whitelist = [];

const standardKategorien=["Aufgaben","Projekte","Privat","Arbeit","Später"];
let kategorien=[];
let benutzerliste=[];
let filterMandantValue="";
let filterBenutzerValue="";
let naechsteVorgangsnummer=1;
let benachrichtigungsIntervallId = null;

function generateUUID(){return'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,function(c){var r=Math.random()*16|0,v=c=='x'?r:(r&0x3|0x8);return v.toString(16)})}
function pruebeLoginHinweis(){document.getElementById("loginHinweis").style.display=accessToken?"none":"block"}

async function handleLogin() {
    try {
        if (!msalInstance) {
            msalInstance = new msal.PublicClientApplication(msalConfig);
        }
        const loginResponse = await msalInstance.loginPopup({ scopes: ["Files.ReadWrite", "offline_access"] });
        
        const account = loginResponse.account;
        const userEmail = account.username.toLowerCase();
        
        // --- Zugriffskontrolle ---
        const isAllowed = await checkUserAccess(userEmail);
        if (!isAllowed) {
            blockAppAccess(); // Blockiert den Zugriff und bereinigt den Zustand, ohne ein weiteres Popup
            return false; // Login-Prozess abbrechen
        }
        
        const tokenResponse = await msalInstance.acquireTokenSilent({ scopes: ["Files.ReadWrite"], account: account });
        accessToken = tokenResponse.accessToken;
        
        zeigeWarnung("Erfolgreich angemeldet!", 'success');
        pruebeLoginHinweis();
        
        // Admin-Button nur für Admin anzeigen
        if (userEmail === adminEmail.toLowerCase()) {
            document.getElementById("adminButton").style.display = 'inline-block';
        }

        // App-Inhalt anzeigen, falls er blockiert war
        document.querySelector('.app-container').classList.remove('hidden');
        document.getElementById('accessDeniedMessage').style.display = 'none';

        return true;
    } catch (e) {
        zeigeWarnung("Login fehlgeschlagen: " + e.message);
        console.error("Login-Fehler:", e);
        // Zustand bei Fehler zurücksetzen
        accessToken = null;
        msalInstance = null;
        return false;
    }
}

async function checkUserAccess(userEmail) {
    // Der Admin hat immer Zugriff
    if (userEmail === adminEmail.toLowerCase()) {
        return true;
    }

    if (!whitelistUrl || whitelistUrl.includes("BITTE_HIER_DEN")) {
        console.warn("Whitelist-URL ist nicht konfiguriert. Zugriff nur für Admin gewährt.");
        return false;
    }

    try {
        const response = await fetch(whitelistUrl);
        if (!response.ok) {
            throw new Error(`Fehler beim Laden der Benutzerliste: ${response.statusText}`);
        }
        const userList = await response.json();
        whitelist = userList.map(email => email.toLowerCase());
        
        return whitelist.includes(userEmail);

    } catch (error) {
        console.error("Fehler beim Prüfen der Zugriffsberechtigung:", error);
        zeigeWarnung("Fehler beim Prüfen der Zugriffsberechtigung. Der Freigabelink ist möglicherweise nicht öffentlich zugänglich.", "warnung");
        return false;
    }
}

// KORRIGIERT: Diese Funktion zwingt den Benutzer nicht mehr zu einem verwirrenden zweiten Logout-Popup.
function blockAppAccess() {
    document.querySelector('.app-container').classList.add('hidden');
    document.getElementById('accessDeniedMessage').style.display = 'block';
    
    // Anstatt den Benutzer mit einem weiteren Popup zu konfrontieren,
    // setzen wir den internen Zustand der App leise zurück.
    // Der Benutzer ist weiterhin bei Microsoft angemeldet, aber nicht in unserer App.
    accessToken = null;
    msalInstance = null; // Wichtig für einen sauberen Neuanmeldeversuch
}

// KORRIGIERT: Die Logout-Funktion wurde komplett überarbeitet, um das "Einfrieren" zu verhindern.
// Sie lädt die Seite nicht mehr neu, sondern setzt den Anwendungszustand sauber zurück.
async function handleLogout() {
    if (!istGespeichert && !confirm("Es gibt ungespeicherte Änderungen. Wirklich abmelden?")) {
        return;
    }
    try {
        if (msalInstance) {
            // logoutPopup löst auf, wenn das Popup geschlossen wird. Kein Redirect nötig.
            await msalInstance.logoutPopup();
        }
        
        zeigeWarnung("Erfolgreich abgemeldet.", 'success');

    } catch (e) {
        console.error("Abmeldung fehlgeschlagen:", e);
        zeigeWarnung("Abmeldung fehlgeschlagen: " + e.message, "warnung");
    } finally {
        // WICHTIG: Setze den Zustand immer zurück, auch wenn das Popup einen Fehler wirft.
        accessToken = null;
        msalInstance = null; // Sehr wichtig, um Konflikte bei der Neuanmeldung zu vermeiden
        istGespeichert = true; // Verhindert die "Seite verlassen?"-Warnung

        // UI-Elemente aktualisieren
        pruebeLoginHinweis(); // Zeigt den "Bitte anmelden"-Hinweis an
        document.getElementById("adminButton").style.display = 'none';
        
        // App-Daten ausblenden, um Verwirrung zu vermeiden
        document.getElementById("ideenListe").innerHTML = ""; 
        
        // Filter zurücksetzen, um eine saubere Ansicht nach Neuanmeldung zu gewährleisten
        document.getElementById("filterKategorie").value = "";
        document.getElementById("filterArchiv").value = "nicht_erledigt";
        document.getElementById("filterBenutzer").value = "";
        document.getElementById("filterMandant").value = "";
        filterMandantValue = "";
        filterBenutzerValue = "";
    }
}

async function anmeldenUndLaden() { const anmeldungErfolgreich = await handleLogin(); if (anmeldungErfolgreich) { await loadFromOneDrive(); }}
function zeigeWarnung(msg,type='warning'){const w=document.getElementById("warnung");w.textContent=msg;w.style.display="block";w.className="";if(type==='success')w.classList.add('success-message');else if(type==='info')w.classList.add('info-message');else w.classList.add('warnung');setTimeout(()=>w.style.display="none",6e3)}

// --- Admin Panel Funktionen ---
function showAdminPanel() {
    try {
        const password = prompt("Bitte geben Sie das Administrator-Passwort ein:");
        if (password === null) return; // Benutzer hat Abbrechen geklickt
        
        if (btoa(password) === adminPasswordHash) {
            loadWhitelistForEditing();
            document.getElementById('adminPanel').style.display = 'block';
        } else {
            alert("Falsches Passwort!");
        }
    } catch(e) {
        console.error("Fehler bei der Passwortprüfung (btoa wird in unsicheren Kontexten blockiert):", e);
        alert("Passwortprüfung fehlgeschlagen. Stellen Sie sicher, dass die Seite über HTTPS geladen wird.");
    }
}

function closeAdminPanel() {
    document.getElementById('adminPanel').style.display = 'none';
}

function loadWhitelistForEditing() {
    const storedList = localStorage.getItem('whitelist_local') || '[]';
    const userArray = JSON.parse(storedList);
    document.getElementById('whitelistEditor').value = userArray.join('\n');
}

function saveWhitelistToLocalStorage() {
    const editorValue = document.getElementById('whitelistEditor').value;
    const userArray = editorValue.split('\n').map(email => email.trim()).filter(email => email);
    localStorage.setItem('whitelist_local', JSON.stringify(userArray));
    zeigeWarnung('Liste lokal zwischengespeichert.', 'info');
}

async function saveWhitelistToOneDrive() {
    if (!accessToken) {
        zeigeWarnung("Sie müssen als Administrator angemeldet sein, um die Liste zu speichern.", "warnung");
        return;
    }
    saveWhitelistToLocalStorage(); // Erst lokal sichern

    const storedList = localStorage.getItem('whitelist_local') || '[]';
    const whitelistPath = "/ideenapp/userlist.json";
    
    zeigeWarnung("Speichere Benutzerliste in OneDrive...", "info");
    try {
        const url = `https://graph.microsoft.com/v1.0/me/drive/root:${whitelistPath}:/content`;
        const res = await fetch(url, {
            method: "PUT",
            headers: { "Authorization": `Bearer ${accessToken}`, "Content-Type": "application/json" },
            body: storedList
        });

        if (res.ok) {
            zeigeWarnung("Benutzerliste erfolgreich in OneDrive gespeichert!", 'success');
            closeAdminPanel();
        } else {
            const err = await res.json().catch(() => null);
            const msg = err?.error?.message || res.statusText;
            throw new Error(msg);
        }
    } catch(e) {
        zeigeWarnung("Fehler beim Speichern der Benutzerliste: " + e.message, "warnung");
    }
}

function initialisiereKategorien(){
    let loadedKategorien = null;
    try { loadedKategorien = JSON.parse(localStorage.getItem("kategorien")); } catch (e) { console.error("Fehler beim Parsen der Kategorien:", e); localStorage.removeItem("kategorien"); }
    let kategorienHabenSichGeaendert = false;
    if (!Array.isArray(loadedKategorien)) { kategorien = [...standardKategorien]; kategorienHabenSichGeaendert = true; } else { kategorien = loadedKategorien; }
    if (kategorienHabenSichGeaendert) { localStorage.setItem("kategorien", JSON.stringify(kategorien)); }
    const selectKategorie = document.getElementById("kategorie"); selectKategorie.innerHTML = '<option value="">-- Kategorie --</option>'; if (Array.isArray(kategorien)) { kategorien.forEach(katName => selectKategorie.add(new Option(katName, katName))); }
    const filterSelectKategorie = document.getElementById("filterKategorie"); filterSelectKategorie.innerHTML = '<option value="" class="filter-option-alle">🎯 Alle Ideen</option>'; if (Array.isArray(kategorien)) { kategorien.forEach(katName => filterSelectKategorie.add(new Option(katName, katName))); }
}

function neueKategorieHinzufuegen(){const input=document.getElementById("neueKategorie");const name=input.value.trim();if(!name){zeigeWarnung("Bitte Kategorienamen eingeben.");return}kategorien=JSON.parse(localStorage.getItem("kategorien")||"[]");if(!Array.isArray(kategorien))kategorien=[...standardKategorien];if(kategorien.includes(name)){zeigeWarnung(`Kategorie "${name}" existiert bereits!`);return}kategorien.push(name);kategorien.sort();localStorage.setItem("kategorien",JSON.stringify(kategorien));saveToOneDrive();initialisiereKategorien();input.value="";input.focus();zeigeWarnung(`Kategorie "${name}" hinzugefügt.`,'success');istGespeichert=!1}
function kategorieLoeschen(){const sel=document.getElementById("kategorie");const name=sel.value;const noDel=["Aufgaben","Projekte","Privat","Arbeit","Später"];if(!name||name===""){zeigeWarnung("Bitte Kategorie zum Löschen wählen.");return}if(noDel.includes(name)){zeigeWarnung(`Standardkategorie "${name}" kann nicht gelöscht werden.`);return}kategorien=JSON.parse(localStorage.getItem("kategorien")||"[]");if(!Array.isArray(kategorien))kategorien=[];if(!kategorien.includes(name)){zeigeWarnung(`Kategorie "${name}" nicht gefunden.`);return}const ideen=JSON.parse(localStorage.getItem("ideen")||"[]");const count=ideen.filter(i=>i&&i.kategorie===name).length;let msg=`Kategorie "${name}" wirklich löschen?`;if(count>0)msg+=` ${count} Notiz(en) verlieren diese Kategorie.`;if(!confirm(msg))return;const idx=kategorien.indexOf(name);if(idx>-1){kategorien.splice(idx,1);localStorage.setItem("kategorien",JSON.stringify(kategorien));saveToOneDrive();let changed=!1;ideen.forEach(i=>{if(i&&i.kategorie===name){i.kategorie="";changed=!0}});if(changed){localStorage.setItem("ideen",JSON.stringify(ideen));saveToOneDrive()}initialisiereKategorien();const fSel=document.getElementById("filterKategorie");if(fSel.value===name)fSel.value="";zeigeWarnung(`Kategorie "${name}" gelöscht.`,'success');zeigeIdeen();istGespeichert=false;}else{zeigeWarnung(`Interner Fehler: Kategorie "${name}" nicht gefunden.`);}}
function initialisiereBenutzer(){benutzerliste=JSON.parse(localStorage.getItem("benutzerliste")||"[]");if(!Array.isArray(benutzerliste)){benutzerliste=[];localStorage.setItem("benutzerliste","[]")}const sel=document.getElementById("benutzer");sel.innerHTML='<option value="">-- Benutzer --</option>';benutzerliste.forEach(b=>sel.add(new Option(b,b)));const fSel=document.getElementById("filterBenutzer");fSel.innerHTML='<option value="">👤 Alle Benutzer</option>';benutzerliste.forEach(b=>fSel.add(new Option(b,b)))}
function neuenBenutzerHinzufuegen(){const input=document.getElementById("neuerBenutzer");const name=input.value.trim();if(!name){zeigeWarnung("Bitte Benutzernamen eingeben.");return}benutzerliste=JSON.parse(localStorage.getItem("benutzerliste")||"[]");if(!Array.isArray(benutzerliste))benutzerliste=[];if(benutzerliste.includes(name)){zeigeWarnung(`Benutzer "${name}" existiert bereits!`);return}benutzerliste.push(name);benutzerliste.sort();localStorage.setItem("benutzerliste",JSON.stringify(benutzerliste));saveToOneDrive();aktualisiereBenutzerDropdowns();input.value="";input.focus();zeigeWarnung(`Benutzer "${name}" hinzugefügt.`,'success');istGespeichert=!1}
function benutzerLoeschen(){const sel=document.getElementById("benutzer");const name=sel.value;if(!name||name===""){zeigeWarnung("Bitte Benutzer zum Löschen wählen.");return}benutzerliste=JSON.parse(localStorage.getItem("benutzerliste")||"[]");if(!Array.isArray(benutzerliste))benutzerliste=[];if(!benutzerliste.includes(name)){zeigeWarnung(`Benutzer "${name}" nicht gefunden.`);return}if(!confirm(`Benutzer "${name}" WIRKLICH löschen? ALLE Notizen dieses Benutzers werden gelöscht!`))return;const idx=benutzerliste.indexOf(name);if(idx>-1){benutzerliste.splice(idx,1);localStorage.setItem("benutzerliste",JSON.stringify(benutzerliste));saveToOneDrive();let ideen=JSON.parse(localStorage.getItem("ideen")||"[]");const len=ideen.length;const origIdeen=JSON.parse(localStorage.getItem("ideen")||"[]");ideen=ideen.filter(i=>i&&i.benutzer!==name);const deletedCount=len-ideen.length;if(deletedCount>0){localStorage.setItem("ideen",JSON.stringify(ideen));saveToOneDrive();const remM=new Set(ideen.filter(i=>i).map(i=>(i.mandantennummer||"").toLowerCase()).filter(m=>m!==""));const allM=new Set(origIdeen.filter(i=>i).map(i=>(i.mandantennummer||"").toLowerCase()).filter(m=>m!==""));let updM=!1;allM.forEach(m=>{if(!remM.has(m))updM=!0});if(updM)aktualisiereMandantenFilterDropdown()}aktualisiereBenutzerDropdowns();if(filterBenutzerValue===name){filterBenutzerValue="";document.getElementById("filterBenutzer").value=""}if(bearbeiteId!==null&&!ideen.some(i=>i&&i.id===bearbeiteId)){abbrechenBearbeiten()}if(beschreibungFuerId!==null&&!ideen.some(i=>i&&i.id===beschreibungFuerId)){beschreibungAbbrechen()}zeigeWarnung(`Benutzer "${name}" und ${deletedCount} Notiz(en) gelöscht.`,'success');zeigeIdeen();istGespeichert=false;}else{zeigeWarnung(`Interner Fehler: Benutzer "${name}" nicht gefunden.`);}}
function aktualisiereBenutzerDropdowns(){initialisiereBenutzer()}
function aktualisiereMandantenFilterDropdown(){const ideen=JSON.parse(localStorage.getItem("ideen")||"[]");const set=new Set(ideen.filter(i=>i).map(i=>(i.mandantennummer||"").trim()).filter(m=>m!==""));const list=Array.from(set).sort();const sel=document.getElementById("filterMandant");const current=sel.value;sel.innerHTML='<option value="">🏢 Alle Mandanten</option>';list.forEach(m=>sel.add(new Option(m,m)));if(current&&list.includes(current)){sel.value=current;filterMandantValue=current}else{sel.value="";filterMandantValue=""}}
function initialisiereVorgangsnummer(){const saved=localStorage.getItem("naechsteVorgangsnummer");naechsteVorgangsnummer=saved?parseInt(saved,10):1;if(isNaN(naechsteVorgangsnummer)||naechsteVorgangsnummer<1){naechsteVorgangsnummer=1;localStorage.setItem("naechsteVorgangsnummer",naechsteVorgangsnummer.toString())}zeigeNaechsteNummer()}
function zeigeNaechsteNummer(){const el=document.getElementById("naechsteNummerAnzeige");if(el)el.textContent=naechsteVorgangsnummer}
function filterNachMandant(){filterMandantValue=document.getElementById("filterMandant").value;zeigeIdeen()}
function filterNachBenutzer(){filterBenutzerValue=document.getElementById("filterBenutzer").value;zeigeIdeen()}
function setzePrioritaet(p){prioritaet=p;["prioHoch","prioMittel","prioNiedrig"].forEach(id=>document.getElementById(id).classList.remove("selected"));if(p)document.getElementById(`prio${p}`).classList.add("selected");istGespeichert=!1}
/* --- START BLOCK 5a: Save Idea --- */
async function speichereIdee() {
    const text = document.getElementById("ideeText").value.trim();
    if (!text) return zeigeWarnung("Titel ist erforderlich!");

    let dateienFuerSpeicherung = [];
    const fileInput = document.getElementById("dateien");
    let neuHochgeladeneDateien = [];

    if (fileInput.files.length > 0) {
        if (accessToken) {
            zeigeWarnung("Lade Dateien hoch...", 'info');
            try {
                neuHochgeladeneDateien = await Promise.all(Array.from(fileInput.files).map(async f => {
                    const link = await uploadToOneDrive(f);
                    return { id: generateUUID(), name: f.name, link: link, type: f.type, sichtbar: true };
                }));
                neuHochgeladeneDateien = neuHochgeladeneDateien.filter(f => f.link !== null);
                zeigeWarnung("Upload fertig.", 'success');
            } catch (e) {
                zeigeWarnung("Upload Fehler: " + e.message);
                neuHochgeladeneDateien = [];
            }
        } else {
            neuHochgeladeneDateien = Array.from(fileInput.files).map(f => ({
                id: generateUUID(), name: f.name, type: f.type, sichtbar: true, isLocal: true
            }));
        }
    }

    let finaleDateiliste = [];
    if (bearbeiteId !== null) {
        const ideen = JSON.parse(localStorage.getItem("ideen") || "[]");
        const idee = ideen.find(i => i && i.id === bearbeiteId);
        if (idee && idee.dateien) {
             finaleDateiliste = idee.dateien.filter(alt => alt && alt.id && !neuHochgeladeneDateien.some(neu => neu.name === alt.name));
        }
        finaleDateiliste = finaleDateiliste.concat(neuHochgeladeneDateien);
    } else {
        finaleDateiliste = neuHochgeladeneDateien;
    }
    saveIdeeObjekt(text, finaleDateiliste);
    fileInput.value = "";
}

function saveIdeeObjekt(text, dateien) {
    let ideen = JSON.parse(localStorage.getItem("ideen") || "[]");
    const details = document.getElementById("ideeDetails").value;
    const kat = document.getElementById("kategorie").value;
    const mnr = document.getElementById("mandantennummer").value.trim();
    const firma = document.getElementById("firmenname").value.trim();
    const user = document.getElementById("benutzer").value;

    const prozessierteDateien = dateien.filter(d => d && d.id).map(d => ({
        id: d.id, name: d.name, link: d.link || null, type: d.type,
        sichtbar: typeof d.sichtbar === 'boolean' ? d.sichtbar : true
    }));
    
    let finalDetails = details;
    const MAX_DETAILS_LENGTH = 20000;
    if (finalDetails.length > MAX_DETAILS_LENGTH) {
        finalDetails = finalDetails.substring(0, MAX_DETAILS_LENGTH);
        zeigeWarnung("Die Hauptbeschreibung war sehr lang und wurde gekürzt.", "info");
    }
    finalDetails = finalDetails.trim();


    if (bearbeiteId !== null) {
        const idx = ideen.findIndex(i => i && i.id === bearbeiteId);
        if (idx !== -1) {
            const old = ideen[idx];
            const erinnerung = old.erinnerung || getDefaultErinnerung(text, old.vorgangsnummer);
            erinnerung.titel = text; 
            erinnerung.vorgangsnummer = old.vorgangsnummer;

            ideen[idx] = { ...old, text, details: finalDetails, kategorie: kat, prioritaet, mandantennummer: mnr, firmenname: firma, benutzer: user, dateien: prozessierteDateien, erinnerung: erinnerung };
            localStorage.setItem("ideen", JSON.stringify(ideen));
            bearbeiteId = null; document.getElementById("speichernBtn").textContent = "💾 Speichern"; document.getElementById("abbrechenBtn").style.display = "none";
        } else { zeigeWarnung("Fehler: Idee nicht gefunden."); return; }
    } else {
        const num = naechsteVorgangsnummer;
        const erinnerung = getDefaultErinnerung(text, num);

        const neu = { id: generateUUID(), vorgangsnummer: num, text, details: finalDetails, kategorie: kat, prioritaet, mandantennummer: mnr, firmenname: firma, benutzer: user, dateien: prozessierteDateien, timestamp: new Date().toISOString(), erledigt: false, beschreibungen: [], erinnerung: erinnerung };
        ideen.push(neu);
        localStorage.setItem("ideen", JSON.stringify(ideen));
        naechsteVorgangsnummer++; localStorage.setItem("naechsteVorgangsnummer", naechsteVorgangsnummer.toString()); zeigeNaechsteNummer();
    }
    aktualisiereMandantenFilterDropdown(); zeigeIdeen();
    document.getElementById("ideeText").value = ""; document.getElementById("ideeDetails").value = ""; document.getElementById("mandantennummer").value = ""; document.getElementById("firmenname").value = ""; document.getElementById("dateiVorschau").innerHTML = "";
    setzePrioritaet(""); document.getElementById("benutzer").value = ""; document.getElementById("kategorie").value = "";
    istGespeichert = false;
    if (typeof saveToOneDrive === "function") saveToOneDrive();
}
/* --- END BLOCK 5a --- */

/* --- START BLOCK 5b: Display Ideas (MODIFIZIERT) --- */
function zeigeIdeen() {
    let fIdeen = [];
    try { fIdeen = JSON.parse(localStorage.getItem("ideen") || "[]"); } catch(e) { console.error("Fehler beim Laden der Ideen:", e); localStorage.removeItem("ideen"); fIdeen = []; }
    if (!Array.isArray(fIdeen)) fIdeen = [];

    let filtered = fIdeen.filter(i => i && i.id); 

    const fKat=document.getElementById("filterKategorie")?.value;if(fKat)filtered=filtered.filter(i=>i.kategorie===fKat);
    filterMandantValue=document.getElementById("filterMandant")?.value;if(filterMandantValue)filtered=filtered.filter(i=>(i.mandantennummer||"").toLowerCase()===filterMandantValue.toLowerCase());
    filterBenutzerValue=document.getElementById("filterBenutzer")?.value;if(filterBenutzerValue)filtered=filtered.filter(i=>(i.benutzer||"").toLowerCase()===filterBenutzerValue.toLowerCase());
    const fArchiv=document.getElementById("filterArchiv")?.value;if(fArchiv==="nicht_erledigt")filtered=filtered.filter(i=>!(i.erledigt||false));else if(fArchiv==="erledigt")filtered=filtered.filter(i=>(i.erledigt||false));

    const sort=document.getElementById("sortierung")?.value;if(sort && sort!=="standard"){filtered.sort((a,b)=>{if (!a || !b) return 0; if(sort==="prio"){const p={"Hoch":3,"Mittel":2,"Niedrig":1};return(p[b.prioritaet]||0)-(p[a.prioritaet]||0)}let tA=-Infinity,tB=-Infinity;try{tA=new Date(a.timestamp?.split('_')[0]).getTime();if(isNaN(tA))tA=(sort==="neu"?-Infinity:Infinity)}catch(e){tA=(sort==="neu"?-Infinity:Infinity)}try{tB=new Date(b.timestamp?.split('_')[0]).getTime();if(isNaN(tB))tB=(sort==="neu"?-Infinity:Infinity)}catch(e){tB=(sort==="neu"?-Infinity:Infinity)}if(sort==="neu")return tB-tA;if(sort==="alt")return tA-tB;return 0})}

    const listDiv = document.getElementById("ideenListe");
    listDiv.innerHTML = filtered.map(idee => {
      try { 
        const id = idee.id;
        const erledigt = idee.erledigt || false;
        let datum = getFormattedDate(idee.timestamp);
        const vNumHtml = idee.vorgangsnummer ? `<div class="vorgangsnummer-anzeige-liste">Vorgang: <b>${idee.vorgangsnummer}</b></div>` : '';

        let dateiHtml = "";
        if (idee.dateien && idee.dateien.length > 0) {
            dateiHtml = idee.dateien.filter(f => f && f.id).map(f => {
                const url = f.link || '#'; const istSichtbar = f.sichtbar === true; const anhangKlasse = istSichtbar ? "" : " anhang-veraltet"; const anhangPraefix = istSichtbar ? "" : "[Veraltet] ";
                const icon = f.link ? '🌐' : '📎'; const buttonSymbol = istSichtbar ? '👁️' : '🙈'; const buttonTitle = istSichtbar ? 'Anhang ausblenden' : 'Anhang einblenden';
                return `<div class="anhang-eintrag${anhangKlasse}" style="margin-bottom: 3px; display: flex; align-items: center;">
                            <a class="datei-link" href="${url}" target="_blank" title="${f.name || ''}">${icon} ${anhangPraefix}${f.name || 'Unbekannt'}</a>
                            <span class="datei-info" style="font-size:0.8em; color: #555; margin-left: 5px;"> (${f.link ? 'OneDrive' : 'Lokal'})</span>
                            <button class="toggle-anhang-sichtbarkeit-btn" title="${buttonTitle}" onclick="toggleAnhangSichtbarkeit('${id}', '${f.id}')">${buttonSymbol}</button>
                        </div>`;
            }).join("");
            if (dateiHtml) { dateiHtml = `<div class="anhaenge-liste" style="margin-top: 8px; display: flex; flex-direction: column; align-items: flex-start;"><b>Anhänge:</b>${dateiHtml}</div>`; }
        }

        const beschreibungenHtml = idee.beschreibungen?.length ? `<div class="beschreibung-historie"><b>Weitere Beschr.:</b>${
            idee.beschreibungen.filter(b => b && b.text !== undefined).map(b => {
                let btsText = getFormattedDate(b.timestamp); const indentLevel = b.level || 0; const indentMargin = indentLevel * 20; const itemWidth = `calc(100% - ${indentMargin}px)`;
                const istSichtbar = b.sichtbar === true; const beschreibungKlasse = istSichtbar ? "" : " beschreibung-veraltet"; const sichtbarkeitButtonSymbol = istSichtbar ? '👁️' : '🙈';
                const sichtbarkeitButtonTitle = istSichtbar ? 'Beschreibung ausblenden' : 'Beschreibung einblenden'; const praefix = istSichtbar ? "" : "[Ausgeblendet] ";
                const sanierterBeschreibungstext = (b.text || "").replace(/</g, "&lt;").replace(/>/g, "&gt;");
                
                let beschreibungAnhaengeHtml = "";
                if (b.attachments && b.attachments.length > 0) {
                    beschreibungAnhaengeHtml = `<div class="beschreibung-anhaenge">${
                        b.attachments.map(anhang => {
                            const anhangUrl = anhang.link || '#';
                            const anhangIcon = anhang.link ? '🌐' : '📎';
                            return `<div class="beschreibung-anhang-item">
                                        <a href="${anhangUrl}" target="_blank" title="${anhang.name || ''}">${anhangIcon} ${anhang.name || 'Unbekannt'}</a>
                                    </div>`;
                        }).join('')
                    }</div>`;
                }

                let beschreibungErinnerungHtml = "";
                if (b.erinnerung && b.erinnerung.aktiv) {
                    let erinnerungText = `🔔 Erinnerung: ${getFormattedDate(b.erinnerung.termin)}`;
                     if (b.erinnerung.intervallTyp !== 'einmalig') {
                         erinnerungText += `, Intervall: ${b.erinnerung.intervallTyp}`;
                          if(b.erinnerung.intervallTyp === 'tage' && b.erinnerung.intervallWert) {
                               erinnerungText += ` (${b.erinnerung.intervallWert} Tage)`;
                          }
                    }
                    beschreibungErinnerungHtml = `<div class="beschreibung-erinnerung-info">${erinnerungText}</div>`;
                } else if (b.erinnerung && !b.erinnerung.aktiv && b.erinnerung.termin) {
                    beschreibungErinnerungHtml = `<div class="beschreibung-erinnerung-info" style="opacity:0.6;">🔔 Erinnerung (inaktiv): ${getFormattedDate(b.erinnerung.termin)}</div>`;
                }

                return `<div class="beschreibung-item${beschreibungKlasse}" style="margin-left: ${indentMargin}px; width: ${itemWidth};">
                            <div class="beschreibung-text-zeit">
                                <span class="beschreibung-zeit">${btsText}</span>${praefix}${sanierterBeschreibungstext}
                                ${beschreibungAnhaengeHtml}
                                ${beschreibungErinnerungHtml}
                            </div>
                            <div class="beschreibung-item-actions">
                                <button class="edit-beschreibung-btn" title="Bearbeiten" onclick="bearbeiteEinzelneBeschreibung('${id}','${b.timestamp}')">✏️</button>
                                <button class="move-beschreibung-btn" title="Nach oben" onclick="verschiebeBeschreibung('${id}','${b.timestamp}', -1)">⬆️</button>
                                <button class="move-beschreibung-btn" title="Nach unten" onclick="verschiebeBeschreibung('${id}','${b.timestamp}', 1)">⬇️</button>
                                <button class="move-beschreibung-btn" title="Ausrücken" onclick="aendereEinrueckungBeschreibung('${id}','${b.timestamp}', -1)" ${indentLevel === 0 ? 'disabled' : ''}>⬅️</button>
                                <button class="move-beschreibung-btn" title="Einrücken" onclick="aendereEinrueckungBeschreibung('${id}','${b.timestamp}', 1)">➡️</button>
                                <button class="add-anhang-beschreibung-btn" title="Anhang" onclick="starteAnhangUploadFuerBeschreibung('${id}','${b.timestamp}')">📎</button>
                                <button class="add-anhang-beschreibung-btn" title="Erinnerung" onclick="zeigeBeschreibungErinnerungDialog('${id}','${b.timestamp}')">🔔</button>
                                <button class="add-anhang-beschreibung-btn" title="Per WhatsApp teilen" onclick="teileBeschreibungPerWhatsApp('${id}','${b.timestamp}')">📱</button>
                                <button class="toggle-beschreibung-sichtbarkeit-btn" title="${sichtbarkeitButtonTitle}" onclick="toggleBeschreibungSichtbarkeit('${id}', '${b.timestamp}')">${sichtbarkeitButtonSymbol}</button>
                            </div>
                        </div>`;
            }).join("")
        }</div>` : "";

        let erinnerungHtml = "";
        if (idee.erinnerung && idee.erinnerung.aktiv) {
            let erinnerungText = `🔔 Erinnerung: ${getFormattedDate(idee.erinnerung.termin)}`;
            if (idee.erinnerung.intervallTyp !== 'einmalig') {
                erinnerungText += `, Intervall: ${idee.erinnerung.intervallTyp}`;
                if(idee.erinnerung.intervallTyp === 'tage' && idee.erinnerung.intervallWert) {
                    erinnerungText += ` (${idee.erinnerung.intervallWert} Tage)`;
                }
            }
            erinnerungHtml = `<div class="erinnerung-info">${erinnerungText}</div>`;
        } else if (idee.erinnerung && !idee.erinnerung.aktiv && idee.erinnerung.termin) {
             erinnerungHtml = `<div class="erinnerung-info" style="opacity:0.6;">🔔 Erinnerung (inaktiv): ${getFormattedDate(idee.erinnerung.termin)}</div>`;
        }

        const sanierterIdeeText = (idee.text || 'Ohne Titel').replace(/</g, "&lt;").replace(/>/g, "&gt;");
        const sanierterIdeeDetails = (idee.details || "").replace(/</g, "&lt;").replace(/>/g, "&gt;");

        return `<div class="idee${erledigt ? ' erledigt' : ''}" data-idee-id="${id}">
                    <div class="idee-content">
                        ${vNumHtml}<h3>${sanierterIdeeText}</h3><p>${sanierterIdeeDetails}</p>
                        ${idee.benutzer ? `<div>Zust.: <b>${idee.benutzer}</b></div>` : ""} ${idee.mandantennummer ? `<div>Mandant: <b>${idee.mandantennummer}</b></div>` : ""} ${idee.firmenname ? `<div>Firma: <b>${idee.firmenname}</b></div>` : ""}
                        ${beschreibungenHtml}
                        <small>${idee.kategorie || '-'} | ${idee.prioritaet || "-"} | ${datum}</small>
                        ${erinnerungHtml}
                        ${dateiHtml}
                        <div class="idee-actions">
                            <button onclick="verschiebeIdee('${id}',-1)">⬆️</button>
                            <button onclick="verschiebeIdee('${id}',1)">⬇️</button>
                            <button onclick="bearbeiteIdee('${id}')">✏️</button>
                            <button onclick="toggleErledigt('${id}')">${erledigt ? "↩️" : "✔️"}</button>
                            <button onclick="loescheIdee('${id}')">🗑️</button>
                            <button onclick="zeigeBeschreibungDialog('${id}')">+ Beschr</button>
                            <button onclick="zeigeErinnerungDialog('${id}')">🔔 Erinnerung</button>
                            <button onclick="zeigeTerminDialog('${id}')">🗓️ Termin</button> 
                        </div>
                    </div>
                    <input type="checkbox" class="idee-checkbox" onchange="toggleAuswahl('${id}',this)" ${ausgewaehlt.includes(id) ? "checked" : ""}>
                </div>`;
      } catch (e) {
        console.error("Fehler beim Darstellen einer Idee (möglicherweise korrupte Daten):", idee, e);
        if (idee && idee.id) {
            return `<div class="idee erledigt" data-idee-id="${id}">
                        <div class="idee-content">
                            <h3>Fehlerhafte Idee (ID: ${idee.id})</h3>
                            <p>Diese Idee konnte nicht korrekt geladen werden. Bitte überprüfen Sie die Daten oder löschen Sie den Eintrag.</p>
                            <p>Fehlermeldung: ${e.message}</p>
                            <div class="idee-actions">
                                 <button onclick="loescheIdee('${idee.id}')">🗑️ Diesen Eintrag löschen</button>
                            </div>
                        </div>
                         <input type="checkbox" class="idee-checkbox" style="display:none;">
                        </div>`;
        }
        return ""; 
      }
    }).join("");

    if (bearbeiteId !== null && !filtered.some(i => i && i.id === bearbeiteId)) abbrechenBearbeiten();
    if (beschreibungFuerId !== null && !filtered.some(i => i && i.id === beschreibungFuerId)) beschreibungAbbrechen();
    if (erinnerungFuerId !== null && !filtered.some(i => i && i.id === erinnerungFuerId)) erinnerungAbbrechen();
    if (terminFuerId !== null && !filtered.some(i => i && i.id === terminFuerId)) terminDialogAbbrechen();
}
/* --- END BLOCK 5b --- */
/* --- START BLOCK 5c: Idea Actions --- */
function toggleErledigt(id){
    let ideen=JSON.parse(localStorage.getItem("ideen")||"[]");
    const idx=ideen.findIndex(i=>i&&i.id===id);
    if(idx!==-1){
        ideen[idx].erledigt=!(ideen[idx].erledigt||!1);
        if(ideen[idx].erledigt && ideen[idx].erinnerung && ideen[idx].erinnerung.aktiv) {
            ideen[idx].erinnerung.aktiv = false; 
        }
        localStorage.setItem("ideen",JSON.stringify(ideen));
        zeigeIdeen();istGespeichert=!1;
        if (typeof saveToOneDrive === "function") saveToOneDrive();
    }
}
function bearbeiteIdee(id){const ideen=JSON.parse(localStorage.getItem("ideen")||"[]");const idee=ideen.find(i=>i&&i.id===id);if(!idee){zeigeWarnung("Fehler: Idee nicht gefunden.");return}document.getElementById("ideeText").value=idee.text;document.getElementById("ideeDetails").value=idee.details||"";document.getElementById("kategorie").value=idee.kategorie||"";document.getElementById("mandantennummer").value=idee.mandantennummer||"";document.getElementById("firmenname").value=idee.firmenname||"";document.getElementById("benutzer").value=idee.benutzer||"";setzePrioritaet(idee.prioritaet||"");bearbeiteId=id;const v=document.getElementById("dateiVorschau");v.innerHTML="";if(idee.dateien){idee.dateien.filter(f=>f&&f.id).forEach(f=>{const url=f.link;if(url){const istVeraltet = f.sichtbar===false; v.innerHTML+=`<div style="display:inline-block;margin:5px;text-align:center;max-width:150px;vertical-align:top; ${istVeraltet?'opacity:0.6;':''}"><a href="${url}" target="_blank" title="${f.name}" style="${istVeraltet?'text-decoration:line-through;':''}">${f.type?.startsWith("image/")?'<img src="'+url+'" style="max-height:80px;display:block;margin:auto;object-fit:cover;">':''}${f.type==="application/pdf"?'<iframe src="'+url+'" style="width:100%;height:80px;border:1px solid #ccc;"></iframe>':''}${!f.type?.startsWith("image/")&&f.type!=="application/pdf"?'<span style="font-size:2em;display:block;">'+(f.link?'🌐':'📎')+'</span>':''}<span style="font-size:.8em;word-break:break-all;display:block;">${f.name}</span></a><div style="font-size:.7em;color:grey;">${f.link?'OneDrive':'Lokal'} (${f.sichtbar?'Sichtbar':'Veraltet'})</div></div>`}})}document.getElementById("speichernBtn").textContent="💾 Aktualisieren";document.getElementById("abbrechenBtn").style.display="";istGespeichert=!1}
function abbrechenBearbeiten(){bearbeiteId=null;document.getElementById("ideeText").value="";document.getElementById("ideeDetails").value="";document.getElementById("mandantennummer").value="";document.getElementById("firmenname").value="";document.getElementById("dateien").value="";document.getElementById("dateiVorschau").innerHTML="";document.getElementById("speichernBtn").textContent="💾 Speichern";document.getElementById("abbrechenBtn").style.display="none";setzePrioritaet("");document.getElementById("benutzer").value="";document.getElementById("kategorie").value="";istGespeichert=!0} 
function verschiebeIdee(id,dir){let ideen=JSON.parse(localStorage.getItem("ideen")||"[]");const idx=ideen.findIndex(i=>i&&i.id===id);if(idx===-1)return;const targetIdx=idx+dir;if(targetIdx>=0&&targetIdx<ideen.length){[ideen[idx],ideen[targetIdx]]=[ideen[targetIdx],ideen[idx]];localStorage.setItem("ideen",JSON.stringify(ideen));zeigeIdeen();istGespeichert=!1;if (typeof saveToOneDrive === "function") saveToOneDrive()}}
function loescheIdee(id){if(!confirm("Wirklich löschen?"))return;let ideen=JSON.parse(localStorage.getItem("ideen")||"[]");const idx=ideen.findIndex(i=>i&&i.id===id);if(idx!==-1){const del=ideen[idx];ideen.splice(idx,1);localStorage.setItem("ideen",JSON.stringify(ideen));const mExists=ideen.some(i=>i&&i.mandantennummer&&(i.mandantennummer||"").toLowerCase()===(del.mandantennummer||"").toLowerCase());const uExists=ideen.some(i=>i&&i.benutzer&&(i.benutzer||"").toLowerCase()===(del.benutzer||"").toLowerCase());if(!mExists&&del.mandantennummer)aktualisiereMandantenFilterDropdown();if(!uExists&&del.benutzer)aktualisiereBenutzerDropdowns();ausgewaehlt=ausgewaehlt.filter(i=>i!==id);if(bearbeiteId===id)abbrechenBearbeiten();if(beschreibungFuerId===id)beschreibungAbbrechen(); if(erinnerungFuerId===id)erinnerungAbbrechen(); if(terminFuerId===id)terminDialogAbbrechen(); zeigeIdeen();istGespeichert=false;if (typeof saveToOneDrive === "function") saveToOneDrive()}else{zeigeWarnung("Fehler: Idee nicht gefunden.");}}
/* --- END BLOCK 5c --- */

/* --- START BLOCK 5d (Mit allen neuen Funktionen & Erinnerungsfunktionen - MODIFIZIERT) --- */
function zeigeBeschreibungDialog(id,ts=null){beschreibungFuerId=id;beschreibungZuBearbeitenderTimestamp=ts;const area=document.getElementById("beschreibungText");if(ts!==null){const ideen=JSON.parse(localStorage.getItem("ideen")||"[]");const idee=ideen.find(i=>i&&i.id===id);const desc=idee?.beschreibungen?.find(b=>b&&b.timestamp===ts);if(desc)area.value=desc.text;else{zeigeWarnung("Fehler: Beschreibung nicht gefunden.");beschreibungAbbrechen();return}}else{area.value=""}document.getElementById("beschreibungDialog").style.display="block";area.focus();istGespeichert=!1}
function beschreibungAbbrechen(){document.getElementById("beschreibungDialog").style.display="none";beschreibungFuerId=null;beschreibungZuBearbeitenderTimestamp=null;document.getElementById("beschreibungText").value=""}

function beschreibungSpeichern(){
    let t = document.getElementById("beschreibungText").value;
    const MAX_DESC_LENGTH = 10000; 

    if (t.length > MAX_DESC_LENGTH) {
        t = t.substring(0, MAX_DESC_LENGTH);
        zeigeWarnung("Die Beschreibung war zu lang und wurde gekürzt.", "info");
    }
    t = t.trim();
    if(!t)return;

    let ideen=JSON.parse(localStorage.getItem("ideen")||"[]");
    const idx=ideen.findIndex(i=>i&&i.id===beschreibungFuerId);
    if(idx!==-1){
        if(beschreibungZuBearbeitenderTimestamp!==null){
            if (!ideen[idx].beschreibungen) ideen[idx].beschreibungen = [];
            const dIdx=ideen[idx].beschreibungen.findIndex(b=>b&&b.timestamp===beschreibungZuBearbeitenderTimestamp);
            if(dIdx!==-1) { ideen[idx].beschreibungen[dIdx].text=t; }
            else { zeigeWarnung("Fehler: Beschreibung zum Bearbeiten nicht gefunden."); }
        } else {
            const ts=new Date().toISOString()+'_'+Math.random().toString(36).substr(2,9);
            if(!ideen[idx].beschreibungen) ideen[idx].beschreibungen=[];
            ideen[idx].beschreibungen.push({text:t, timestamp:ts, level: 0, sichtbar: true, attachments: [], erinnerung: getDefaultErinnerung()});
        }
        localStorage.setItem("ideen",JSON.stringify(ideen));
        zeigeIdeen();
    } else { zeigeWarnung("Fehler: Idee nicht gefunden."); }
    beschreibungAbbrechen(); istGespeichert=false; 
    if (typeof saveToOneDrive === "function") saveToOneDrive();
}

function starteAnhangUploadFuerBeschreibung(ideeId, timestamp) {
    anhangFuerBeschreibungZiel = { ideeId: ideeId, timestamp: timestamp };
    const fileInput = document.getElementById('beschreibungAnhangInput');
    fileInput.value = ''; 
    fileInput.click();
}

async function handleBeschreibungAnhangUpload(event) {
    const { ideeId, timestamp } = anhangFuerBeschreibungZiel;
    if (!ideeId || !timestamp || !event.target.files) {
        return;
    }

    const files = event.target.files;
    if (files.length === 0) return;

    zeigeWarnung(`Lade ${files.length} Datei(en) für Beschreibung hoch...`, 'info');

    let neueAnhaenge = [];
    if (accessToken) {
        try {
            neueAnhaenge = await Promise.all(Array.from(files).map(async f => {
                const link = await uploadToOneDrive(f);
                return { id: generateUUID(), name: f.name, link: link, type: f.type };
            }));
            neueAnhaenge = neueAnhaenge.filter(f => f.link !== null);
        } catch (e) {
            zeigeWarnung("Fehler beim OneDrive-Upload: " + e.message, 'warnung');
            return;
        }
    } else {
        neueAnhaenge = Array.from(files).map(f => ({
            id: generateUUID(), name: f.name, link: null, type: f.type
        }));
    }

    if (neueAnhaenge.length === 0) {
        zeigeWarnung("Keine Anhänge erfolgreich verarbeitet.", 'warnung');
        return;
    }

    let ideen = JSON.parse(localStorage.getItem("ideen") || "[]");
    const ideeIndex = ideen.findIndex(i => i && i.id === ideeId);
    if (ideeIndex === -1) {
        zeigeWarnung("Fehler: Zugehörige Idee nicht gefunden.", 'warnung');
        return;
    }

    const beschreibungIndex = ideen[ideeIndex].beschreibungen.findIndex(b => b && b.timestamp === timestamp);
    if (beschreibungIndex === -1) {
        zeigeWarnung("Fehler: Zugehörige Beschreibung nicht gefunden.", 'warnung');
        return;
    }

    if (!Array.isArray(ideen[ideeIndex].beschreibungen[beschreibungIndex].attachments)) {
        ideen[ideeIndex].beschreibungen[beschreibungIndex].attachments = [];
    }
    
    ideen[ideeIndex].beschreibungen[beschreibungIndex].attachments.push(...neueAnhaenge);

    localStorage.setItem("ideen", JSON.stringify(ideen));
    zeigeWarnung(`${neueAnhaenge.length} Anhang/Anhänge zur Beschreibung hinzugefügt.`, 'success');
    zeigeIdeen();
    istGespeichert = false;
    if (typeof saveToOneDrive === "function") saveToOneDrive();

    anhangFuerBeschreibungZiel = { ideeId: null, timestamp: null };
}


function bearbeiteEinzelneBeschreibung(id,ts){if(ts)zeigeBeschreibungDialog(id,ts);else zeigeWarnung("Interner Fehler: Timestamp fehlt.")}
function toggleAuswahl(id,box){if(box.checked){if(!ausgewaehlt.includes(id))ausgewaehlt.push(id)}else{ausgewaehlt=ausgewaehlt.filter(i=>i!==id)}}
function ausgewaehlteNotizenLoeschen(){if(ausgewaehlt.length===0){zeigeWarnung("Keine Notizen ausgewählt.");return}if(!confirm(`Wirklich ${ausgewaehlt.length} Notiz(en) löschen?`))return;let ideen=JSON.parse(localStorage.getItem("ideen")||"[]");const delM=new Set();const delU=new Set();ideen.filter(i=>i&&ausgewaehlt.includes(i.id)).forEach(i=>{if(i.mandantennummer)delM.add((i.mandantennummer).toLowerCase());if(i.benutzer)delU.add((i.benutzer).toLowerCase())});const newList=ideen.filter(i=>!i || !ausgewaehlt.includes(i.id));localStorage.setItem("ideen",JSON.stringify(newList));const remM=new Set(newList.filter(i=>i).map(i=>(i.mandantennummer||"").toLowerCase()).filter(m=>m!==""));const remU=new Set(newList.filter(i=>i).map(i=>(i.benutzer||"").toLowerCase()).filter(b=>b!==""));let uM=!1;delM.forEach(m=>{if(!remM.has(m))uM=!0});let uU=!1;delU.forEach(u=>{if(!remU.has(u))uU=!0});if(uM)aktualisiereMandantenFilterDropdown();if(uU)aktualisiereBenutzerDropdowns();if(bearbeiteId!==null&&ausgewaehlt.includes(bearbeiteId))abbrechenBearbeiten();if(beschreibungFuerId!==null&&ausgewaehlt.includes(beschreibungFuerId))beschreibungAbbrechen(); if(erinnerungFuerId!==null&&ausgewaehlt.includes(erinnerungFuerId))erinnerungAbbrechen(); if(terminFuerId!==null&&ausgewaehlt.includes(terminFuerId))terminDialogAbbrechen(); ausgewaehlt=[];zeigeIdeen();istGespeichert=false;if (typeof saveToOneDrive === "function") saveToOneDrive()}
function alleIdeenLoeschen(){if(!confirm("Wirklich ALLE Ideen, Kategorien, Benutzer etc. löschen?"))return;localStorage.removeItem("ideen"); localStorage.removeItem("kategorien"); localStorage.removeItem("benutzerliste"); localStorage.removeItem("naechsteVorgangsnummer"); naechsteVorgangsnummer=1; kategorien = []; benutzerliste = []; zeigeNaechsteNummer(); initialisiereKategorien(); initialisiereBenutzer(); aktualisiereMandantenFilterDropdown(); ausgewaehlt=[];bearbeiteId=null;beschreibungFuerId=null;beschreibungZuBearbeitenderTimestamp=null; erinnerungFuerId=null; terminFuerId=null; zeigeIdeen();abbrechenBearbeiten();istGespeichert=true;if (typeof saveToOneDrive === "function") saveToOneDrive()}

function toggleAnhangSichtbarkeit(ideeId, anhangId) {
    if (!ideeId || !anhangId) { return; }
    let ideen = JSON.parse(localStorage.getItem("ideen") || "[]");
    const ideeIndex = ideen.findIndex(i => i && i.id === ideeId);
    if (ideeIndex === -1) { zeigeWarnung("Fehler: Idee nicht gefunden."); return; }
    if (!Array.isArray(ideen[ideeIndex].dateien)) { return; }
    const anhangIndex = ideen[ideeIndex].dateien.findIndex(f => f && f.id === anhangId);
    if (anhangIndex === -1) { zeigeWarnung("Fehler: Anhang nicht gefunden."); return; }
    ideen[ideeIndex].dateien[anhangIndex].sichtbar = !(ideen[ideeIndex].dateien[anhangIndex].sichtbar === true);
    localStorage.setItem("ideen", JSON.stringify(ideen));
    zeigeIdeen(); istGespeichert = false; 
    if (typeof saveToOneDrive === "function") saveToOneDrive();
}

function verschiebeBeschreibung(ideeId, beschreibungTimestamp, richtung) {
    if (!ideeId || !beschreibungTimestamp || (richtung !== -1 && richtung !== 1)) { return; }
    let ideen = JSON.parse(localStorage.getItem("ideen") || "[]");
    const ideeIndex = ideen.findIndex(i => i && i.id === ideeId);
    if (ideeIndex === -1) return zeigeWarnung("Idee nicht gefunden.");
    if (!ideen[ideeIndex].beschreibungen || !Array.isArray(ideen[ideeIndex].beschreibungen)) return;
    const beschreibungen = ideen[ideeIndex].beschreibungen;
    const currentIndex = beschreibungen.findIndex(b => b && b.timestamp === beschreibungTimestamp);
    if (currentIndex === -1) return zeigeWarnung("Beschreibung nicht gefunden.");
    const targetIndex = currentIndex + richtung;
    if (targetIndex < 0 || targetIndex >= beschreibungen.length) { return; }
    [beschreibungen[currentIndex], beschreibungen[targetIndex]] = [beschreibungen[targetIndex], beschreibungen[currentIndex]];
    localStorage.setItem("ideen", JSON.stringify(ideen));
    zeigeIdeen(); istGespeichert = false; 
    if (typeof saveToOneDrive === "function") saveToOneDrive();
}

function aendereEinrueckungBeschreibung(ideeId, beschreibungTimestamp, richtung) {
    if (!ideeId || !beschreibungTimestamp || (richtung !== -1 && richtung !== 1)) { return; }
    let ideen = JSON.parse(localStorage.getItem("ideen") || "[]");
    const ideeIndex = ideen.findIndex(i => i && i.id === ideeId);
    if (ideeIndex === -1) return zeigeWarnung("Idee nicht gefunden.");
    if (!ideen[ideeIndex].beschreibungen || !Array.isArray(ideen[ideeIndex].beschreibungen)) return;
    const beschrIndex = ideen[ideeIndex].beschreibungen.findIndex(b => b && b.timestamp === beschreibungTimestamp);
    if (beschrIndex === -1) return zeigeWarnung("Beschreibung nicht gefunden.");
    const aktuellesLevel = ideen[ideeIndex].beschreibungen[beschrIndex].level || 0;
    let neuesLevel = aktuellesLevel + richtung;
    const maxLevel = 5;
    if (neuesLevel < 0) neuesLevel = 0;
    if (neuesLevel > maxLevel) neuesLevel = maxLevel;
    if (aktuellesLevel === neuesLevel) { return; }
    ideen[ideeIndex].beschreibungen[beschrIndex].level = neuesLevel;
    localStorage.setItem("ideen", JSON.stringify(ideen));
    zeigeIdeen(); istGespeichert = false; 
    if (typeof saveToOneDrive === "function") saveToOneDrive();
}

function toggleBeschreibungSichtbarkeit(ideeId, beschreibungTimestamp) {
    if (!ideeId || !beschreibungTimestamp) { return; }
    let ideen = JSON.parse(localStorage.getItem("ideen") || "[]");
    const ideeIndex = ideen.findIndex(i => i && i.id === ideeId);
    if (ideeIndex === -1) { zeigeWarnung("Fehler: Idee nicht gefunden."); return; }
    if (!Array.isArray(ideen[ideeIndex].beschreibungen)) { return; }
    const beschrIndex = ideen[ideeIndex].beschreibungen.findIndex(b => b && b.timestamp === beschreibungTimestamp);
    if (beschrIndex === -1) { zeigeWarnung("Fehler: Beschreibung nicht gefunden."); return; }
    ideen[ideeIndex].beschreibungen[beschrIndex].sichtbar = !(ideen[ideeIndex].beschreibungen[beschrIndex].sichtbar === true);
    localStorage.setItem("ideen", JSON.stringify(ideen));
    zeigeIdeen(); istGespeichert = false; 
    if (typeof saveToOneDrive === "function") saveToOneDrive();
}

function getDefaultErinnerung(titel = "", vorgangsnummer = null) {
    return {
        aktiv: false, termin: null, intervallTyp: 'einmalig', intervallWert: null,
        vorabErinnerungAktiv: false, vorabWert: 10, vorabEinheit: 'minuten',
        titel: titel, vorgangsnummer: vorgangsnummer
    };
}

function zeigeErinnerungDialog(id) {
    erinnerungFuerId = id;
    erinnerungFuerBeschreibungTimestamp = null; // Wichtig: Zurücksetzen
    const ideen = JSON.parse(localStorage.getItem("ideen") || "[]");
    const idee = ideen.find(i => i && i.id === id);

    if (!idee) { zeigeWarnung("Fehler: Idee für Erinnerung nicht gefunden."); erinnerungAbbrechen(); return; }
    if (idee.erledigt) { zeigeWarnung("Erinnerungen können nicht für erledigte Notizen eingestellt werden.", "info"); return; }

    const erinnerung = idee.erinnerung || getDefaultErinnerung(idee.text, idee.vorgangsnummer);

    document.getElementById("erinnerungTerminInput").value = erinnerung.termin ? erinnerung.termin.substring(0, 16) : "";
    document.getElementById("erinnerungIntervallTypSelect").value = erinnerung.intervallTyp || 'einmalig';
    document.getElementById("erinnerungIntervallWertInput").value = erinnerung.intervallWert || 1;
    document.getElementById("erinnerungVorabCheckbox").checked = erinnerung.vorabErinnerungAktiv || false;
    document.getElementById("erinnerungVorabWertInput").value = erinnerung.vorabWert || 10;
    document.getElementById("erinnerungVorabEinheitSelect").value = erinnerung.vorabEinheit || 'minuten';

    toggleErinnerungIntervallWert();
    toggleErinnerungVorabDetails();

    document.getElementById("erinnerungDialog").style.display = "block";
    document.getElementById("erinnerungTerminInput").focus();
    istGespeichert = false;
}

function zeigeBeschreibungErinnerungDialog(ideeId, beschreibungTimestamp) {
    erinnerungFuerId = ideeId;
    erinnerungFuerBeschreibungTimestamp = beschreibungTimestamp; // Timestamp der Beschreibung setzen

    const ideen = JSON.parse(localStorage.getItem("ideen") || "[]");
    const idee = ideen.find(i => i && i.id === ideeId);
    if (!idee) { zeigeWarnung("Fehler: Zugehörige Idee nicht gefunden."); erinnerungAbbrechen(); return; }
    
    const beschreibung = idee.beschreibungen.find(b => b && b.timestamp === beschreibungTimestamp);
    if (!beschreibung) { zeigeWarnung("Fehler: Beschreibung für Erinnerung nicht gefunden."); erinnerungAbbrechen(); return; }

    const erinnerung = beschreibung.erinnerung || getDefaultErinnerung();

    document.getElementById("erinnerungTerminInput").value = erinnerung.termin ? erinnerung.termin.substring(0, 16) : "";
    document.getElementById("erinnerungIntervallTypSelect").value = erinnerung.intervallTyp || 'einmalig';
    document.getElementById("erinnerungIntervallWertInput").value = erinnerung.intervallWert || 1;
    document.getElementById("erinnerungVorabCheckbox").checked = erinnerung.vorabErinnerungAktiv || false;
    document.getElementById("erinnerungVorabWertInput").value = erinnerung.vorabWert || 10;
    document.getElementById("erinnerungVorabEinheitSelect").value = erinnerung.vorabEinheit || 'minuten';

    toggleErinnerungIntervallWert();
    toggleErinnerungVorabDetails();
    
    document.getElementById("erinnerungDialog").style.display = "block";
    document.getElementById("erinnerungTerminInput").focus();
    istGespeichert = false;
}

function erinnerungAbbrechen() {
    document.getElementById("erinnerungDialog").style.display = "none";
    erinnerungFuerId = null;
    erinnerungFuerBeschreibungTimestamp = null; // Wichtig
    document.getElementById("erinnerungTerminInput").value = "";
    document.getElementById("erinnerungIntervallTypSelect").value = "einmalig";
    document.getElementById("erinnerungIntervallWertInput").value = "1";
    document.getElementById("erinnerungVorabCheckbox").checked = false;
    document.getElementById("erinnerungVorabWertInput").value = "10";
    document.getElementById("erinnerungVorabEinheitSelect").value = "minuten";
    toggleErinnerungIntervallWert();
    toggleErinnerungVorabDetails();
}

function erinnerungSpeichern() {
    if (!erinnerungFuerId) return;
    const terminValue = document.getElementById("erinnerungTerminInput").value;
    if (!terminValue) { zeigeWarnung("Bitte geben Sie einen Termin für die Erinnerung an."); return; }
    const termin = new Date(terminValue).toISOString();
    const intervallTyp = document.getElementById("erinnerungIntervallTypSelect").value;
    const intervallWert = intervallTyp === 'tage' ? parseInt(document.getElementById("erinnerungIntervallWertInput").value, 10) : null;
    const vorabErinnerungAktiv = document.getElementById("erinnerungVorabCheckbox").checked;
    const vorabWert = vorabErinnerungAktiv ? parseInt(document.getElementById("erinnerungVorabWertInput").value, 10) : null;
    const vorabEinheit = vorabErinnerungAktiv ? document.getElementById("erinnerungVorabEinheitSelect").value : null;

    if (intervallTyp === 'tage' && (!intervallWert || intervallWert < 1)) { zeigeWarnung("Bitte eine gültige Anzahl von Tagen angeben."); return; }
    if (vorabErinnerungAktiv && (!vorabWert || vorabWert < 1)) { zeigeWarnung("Bitte einen gültigen Wert für die Vorab-Erinnerung angeben."); return; }

    if (Notification.permission === "default") {
        zeigeWarnung("Um Benachrichtigungen zu erhalten, bitte diese im Browser erlauben.", "info");
    } else if (Notification.permission === "denied") {
        zeigeWarnung("Benachrichtigungen sind blockiert. Sie werden nicht per Browser-Notification erinnert.", "warnung");
    }

    let ideen = JSON.parse(localStorage.getItem("ideen") || "[]");
    const ideeIndex = ideen.findIndex(i => i && i.id === erinnerungFuerId);

    if (ideeIndex !== -1) {
        const idee = ideen[ideeIndex];
        const erinnerungsDaten = {
            aktiv: true, termin: termin, intervallTyp: intervallTyp, intervallWert: intervallWert,
            vorabErinnerungAktiv: vorabErinnerungAktiv, vorabWert: vorabWert, vorabEinheit: vorabEinheit
        };

        if (erinnerungFuerBeschreibungTimestamp) {
            // Speichern für eine Beschreibung
            const beschreibungIndex = idee.beschreibungen.findIndex(b => b && b.timestamp === erinnerungFuerBeschreibungTimestamp);
            if (beschreibungIndex !== -1) {
                ideen[ideeIndex].beschreibungen[beschreibungIndex].erinnerung = {
                        ...erinnerungsDaten,
                        titel: null,
                        vorgangsnummer: null
                };
            } else {
                zeigeWarnung("Fehler: Beschreibung zum Speichern der Erinnerung nicht gefunden.");
                erinnerungAbbrechen();
                return;
            }
        } else {
            // Speichern für die Haupt-Idee
            if (idee.erledigt) { zeigeWarnung("Erinnerung kann nicht gespeichert werden (Notiz erledigt).", "info"); erinnerungAbbrechen(); return; }
            ideen[ideeIndex].erinnerung = {
                ...erinnerungsDaten,
                titel: idee.text,
                vorgangsnummer: idee.vorgangsnummer
            };
        }

        localStorage.setItem("ideen", JSON.stringify(ideen));
        zeigeWarnung("Erinnerung gespeichert.", "success");
        zeigeIdeen(); 
        if (typeof saveToOneDrive === "function") saveToOneDrive();
    } else { zeigeWarnung("Fehler: Idee zum Speichern der Erinnerung nicht gefunden."); }
    erinnerungAbbrechen(); istGespeichert = false;
}

function erinnerungLoeschen() {
    if (!erinnerungFuerId) return;
    if (!confirm("Möchten Sie diese Erinnerung wirklich löschen?")) return;
    let ideen = JSON.parse(localStorage.getItem("ideen") || "[]");
    const ideeIndex = ideen.findIndex(i => i && i.id === erinnerungFuerId);
    
    if (ideeIndex !== -1) {
        if (erinnerungFuerBeschreibungTimestamp) {
            // Löschen für eine Beschreibung
            const beschreibungIndex = ideen[ideeIndex].beschreibungen.findIndex(b => b && b.timestamp === erinnerungFuerBeschreibungTimestamp);
            if (beschreibungIndex !== -1) {
                ideen[ideeIndex].beschreibungen[beschreibungIndex].erinnerung = getDefaultErinnerung();
            } else {
                zeigeWarnung("Fehler: Beschreibung zum Löschen der Erinnerung nicht gefunden.");
                erinnerungAbbrechen();
                return;
            }
        } else {
            // Löschen für die Haupt-Idee
            ideen[ideeIndex].erinnerung = getDefaultErinnerung(ideen[ideeIndex].text, ideen[ideeIndex].vorgangsnummer);
        }

        localStorage.setItem("ideen", JSON.stringify(ideen));
        zeigeWarnung("Erinnerung gelöscht.", "success");
        zeigeIdeen(); 
        if (typeof saveToOneDrive === "function") saveToOneDrive();
    } else { zeigeWarnung("Fehler: Idee zum Löschen der Erinnerung nicht gefunden."); }
    erinnerungAbbrechen(); istGespeichert = false;
}


function toggleErinnerungIntervallWert() {
    const typ = document.getElementById("erinnerungIntervallTypSelect").value;
    document.getElementById("erinnerungIntervallWertContainer").style.display = (typ === 'tage') ? 'block' : 'none';
}

function toggleErinnerungVorabDetails() {
    const checked = document.getElementById("erinnerungVorabCheckbox").checked;
    document.getElementById("erinnerungVorabDetailsContainer").style.display = checked ? 'block' : 'none';
}
/* --- END BLOCK 5d --- */
/* --- START BLOCK 6 (MODIFIZIERT) --- */
function getFormattedDate(timestamp) { if (timestamp) { let ts = timestamp; if (typeof ts === 'string' && ts.includes('_')) { ts = ts.split('_')[0]; } try { const d = new Date(ts); if (!isNaN(d.getTime())) { return d.toLocaleString("de-DE", { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' }); } } catch (e) { } } return 'N/A'; }
function getExportIdeen() { let resultIdeen = []; try { let ideen = []; try { ideen = JSON.parse(localStorage.getItem("ideen") || "[]"); if (!Array.isArray(ideen)) { ideen = []; localStorage.setItem("ideen", "[]"); } } catch (e) { localStorage.removeItem("ideen"); ideen = []; } const aktuellAusgewaehlteCheckboxes = Array.from(document.querySelectorAll('.idee-checkbox:checked')); let aktuellAusgewaehlteIDs = []; if (aktuellAusgewaehlteCheckboxes.length > 0) { aktuellAusgewaehlteIDs = aktuellAusgewaehlteCheckboxes.map(cb => { try { let parentIdeeDiv = cb.closest('.idee'); if (parentIdeeDiv) { const buttonsMitId = parentIdeeDiv.querySelectorAll('button[onclick*="loescheIdee("], button[onclick*="bearbeiteIdee("], button[onclick*="toggleErledigt("]'); for(let btn of buttonsMitId) { if (btn.onclick) { const match = btn.onclick.toString().match(/\('([^']+)'\)/); if (match && match[1]) return match[1]; } } } } catch (e) { } return null; }).filter(id => id !== null); if (aktuellAusgewaehlteIDs.length > 0) { resultIdeen = ideen.filter(i => i && i.id && aktuellAusgewaehlteIDs.includes(i.id)); } else { resultIdeen = []; } } else { let fIdeen = [...ideen.filter(i=>i&&i.id)]; const fKat = document.getElementById("filterKategorie")?.value; if (fKat) fIdeen = fIdeen.filter(i => i.kategorie === fKat); const fMdt = document.getElementById("filterMandant")?.value; if (fMdt) fIdeen = fIdeen.filter(i => (i.mandantennummer || "").toLowerCase() === fMdt.toLowerCase()); const fUser = document.getElementById("filterBenutzer")?.value; if (fUser) fIdeen = fIdeen.filter(i => (i.benutzer || "").toLowerCase() === fUser.toLowerCase()); const fArchiv = document.getElementById("filterArchiv")?.value; if (fArchiv === "nicht_erledigt") fIdeen = fIdeen.filter(i => !(i.erledigt || false)); else if (fArchiv === "erledigt") fIdeen = fIdeen.filter(i => (i.erledigt || false)); const sort=document.getElementById("sortierung")?.value; if(sort && sort!=="standard"){ fIdeen.sort((a,b)=>{ if (!a || !b) return 0; if(sort==="prio"){ const p={"Hoch":3,"Mittel":2,"Niedrig":1}; return(p[b.prioritaet]||0)-(p[a.prioritaet]||0); } let tA=-Infinity,tB=-Infinity; try{tA=new Date(a.timestamp?.split('_')[0]).getTime();if(isNaN(tA))tA=(sort==="neu"?-Infinity:Infinity)}catch(e){tA=(sort==="neu"?-Infinity:Infinity)} try{tB=new Date(b.timestamp?.split('_')[0]).getTime();if(isNaN(tB))tB=(sort==="neu"?-Infinity:Infinity)}catch(e){tB=(sort==="neu"?-Infinity:Infinity)} if(sort==="neu")return tB-tA; if(sort==="alt")return tA-tB; return 0; }); } resultIdeen = fIdeen; } } catch (error) { resultIdeen = []; } if (!Array.isArray(resultIdeen)) { return []; } return resultIdeen; }

function formatErinnerungForExport(erinnerung) {
    if (!erinnerung || !erinnerung.termin) return "";
    let text = `Erinnerung (${erinnerung.aktiv ? 'Aktiv' : 'Inaktiv'}):\n`;
    text += `  Termin: ${getFormattedDate(erinnerung.termin)}\n`;
    if(erinnerung.titel) text += `  Titel (für Erinnerung): ${erinnerung.titel || '-'}\n`;
    if(erinnerung.vorgangsnummer) text += `  Vorgangsnr. (für Erinnerung): ${erinnerung.vorgangsnummer || '-'}\n`;
    text += `  Intervall: ${erinnerung.intervallTyp || 'einmalig'}`;
    if (erinnerung.intervallTyp === 'tage' && erinnerung.intervallWert) {
        text += ` (alle ${erinnerung.intervallWert} Tage)`;
    }
    text += "\n";
    if (erinnerung.vorabErinnerungAktiv && erinnerung.vorabWert && erinnerung.vorabEinheit) {
        text += `  Vorab-Erinnerung: ${erinnerung.vorabWert} ${erinnerung.vorabEinheit} vorher\n`;
    }
    return text;
}

function exportiereAlsText() {
    const ideenToExport = getExportIdeen();
    if (ideenToExport.length === 0) { zeigeWarnung("Keine Notizen zum Exportieren.", "info"); return; }
    let textContent = `Ideen-Export - ${new Date().toLocaleString("de-DE")}\n==================================================\n\n`;
    ideenToExport.forEach(idee => {
        if (!idee) return;
        textContent += `${idee.erledigt ? '[ERLEDIGT] ' : ''}${idee.vorgangsnummer ? `[Vorgang ${idee.vorgangsnummer}] ` : ''}${idee.text || 'Ohne Titel'}\n--------------------------------------------------\n`;
        if (idee.kategorie) textContent += `Kategorie: ${idee.kategorie}\n`;
        if (idee.prioritaet) textContent += `Priorität: ${idee.prioritaet}\n`;
        textContent += `Erstellt/Aktualisiert: ${getFormattedDate(idee.timestamp)}\n`;
        if (idee.benutzer) textContent += `Zuständig: ${idee.benutzer}\n`;
        if (idee.mandantennummer) textContent += `Mandantennummer: ${idee.mandantennummer}\n`;
        if (idee.firmenname) textContent += `Firmenname: ${idee.firmenname}\n`;
        if (idee.details) textContent += `\nBeschreibung:\n${idee.details}\n`;

        if (idee.erinnerung && idee.erinnerung.termin) {
            textContent += `\n${formatErinnerungForExport(idee.erinnerung)}`;
        }

        if (idee.beschreibungen && idee.beschreibungen.length > 0) {
              textContent += `\nWeitere Beschreibungen:\n`;
              idee.beschreibungen.forEach(b => {
                  if (b && b.text !== undefined) {
                      const indentSpaces = "  ".repeat(b.level || 0);
                      const praefix = b.sichtbar === false ? "[Ausgeblendet] " : "";
                      textContent += `${indentSpaces}- [${getFormattedDate(b.timestamp)}] ${praefix}${b.text}\n`;
                      if (b.attachments && b.attachments.length > 0) {
                          b.attachments.forEach(anhang => {
                              textContent += `${indentSpaces}   -> Anhang: ${anhang.name} ${anhang.link ? `(${anhang.link})` : '(Lokal)'}\n`;
                          });
                      }
                      if (b.erinnerung && b.erinnerung.termin) {
                          textContent += `${indentSpaces}  ${formatErinnerungForExport(b.erinnerung).replace(/\n/g, `\n${indentSpaces}  `)}`;
                      }
                  }
              });
        }

        if (idee.dateien && idee.dateien.length > 0) {
            textContent += `\nAnhänge:\n`;
            idee.dateien.forEach(f => {
                 if (!f || !f.id) return;
                const praefix = f.sichtbar === false ? "[Veraltet] " : "";
                textContent += `  - Name: ${praefix}${f.name || 'Unbekannt'}\n`;
                if (f.link) { textContent += `    Link: ${f.link}\n`; }
                else { textContent += `    (Lokale Datei)\n`; }
            });
        }
        textContent += `\n==================================================\n\n`;
    });
    const blob = new Blob([textContent], { type: "text/plain;charset=utf-8" }); const url = URL.createObjectURL(blob); const a = document.createElement("a"); a.href = url; a.download = "ideen-export.txt"; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); zeigeWarnung("Text-Export gestartet.", "success");
}

function sanitizeFilename(name) {
    if (!name) return "Unbenannte_Idee";
    let sanitized = name.replace(/[\\/:*?"<>|#%&{}]/g, '');
    sanitized = sanitized.replace(/\s+/g, '_');
    sanitized = sanitized.replace(/ä/g, 'ae').replace(/ö/g, 'oe').replace(/ü/g, 'ue');
    sanitized = sanitized.replace(/Ä/g, 'Ae').replace(/Ö/g, 'Oe').replace(/Ü/g, 'Ue');
    sanitized = sanitized.replace(/ß/g, 'ss');
    return sanitized.substring(0, 100);
}

function exportiereAlsPDF(fileName = "ideen-export.pdf") {
    const ideenToExport = getExportIdeen();
    if (ideenToExport.length === 0) {
        zeigeWarnung("Keine Notizen zum Exportieren.", "info");
        return false; 
    }
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });

    let pdfMetadataTitle;
    if (ideenToExport.length === 1) {
        const idee = ideenToExport[0];
        let titleParts = [];
        if (idee.vorgangsnummer) {
            titleParts.push(`Vorgang ${idee.vorgangsnummer}`);
        }
        titleParts.push(idee.text || 'Unbenannte Idee');
        titleParts.push(`(${fileName})`);
        pdfMetadataTitle = titleParts.join(' - ');
    } else {
        pdfMetadataTitle = `Export von ${ideenToExport.length} Ideen - (${fileName})`;
    }

    doc.setProperties({
        title: pdfMetadataTitle, 
        subject: 'Exportierte Ideen aus der Ideen-App Pro',
        author: 'Ideen-App Pro',
        creator: 'Ideen-App Pro'
    });

    let yPosition = 15;
    const leftMargin = 15;
    const rightMargin = 15;
    const pageHeight = doc.internal.pageSize.height;
    const contentWidth = doc.internal.pageSize.width - leftMargin - rightMargin;
    const defaultLineSpacing = 5;
    const sectionSpacing = 8;
    const ideaSpacing = 15;
    const anhangFontSize = 10;
    const anhangLineHeight = 5;

    function checkAddPage(neededHeight) {
        if (yPosition + neededHeight > pageHeight - 15) {
            doc.addPage();
            yPosition = 15;
            return true;
        }
        return false;
    }

    function addWrappedText(text, x, maxWidth, options = {}) {
        const fontSize = options.fontSize || 10;
        const fontStyle = options.fontStyle || 'normal';
        const color = options.color || [0, 0, 0];
        const lineHeight = options.lineHeight || defaultLineSpacing;
        doc.setFontSize(fontSize);
        doc.setFont(undefined, fontStyle);
        doc.setTextColor(color[0], color[1], color[2]);
        const lines = doc.splitTextToSize(text || "N/A", maxWidth);
        for (let i = 0; i < lines.length; i++) {
            checkAddPage(lineHeight);
            if (options.link && i === 0) {
                const textWidth = doc.getTextWidth(lines[i]);
                const charHeight = doc.getFontSize() / doc.internal.scaleFactor;
                doc.text(lines[i], x, yPosition);
                doc.link(x, yPosition - charHeight + 1, textWidth, charHeight, { url: options.link });
            } else {
                doc.text(lines[i], x, yPosition);
            }
            yPosition += lineHeight;
        }
    }

    doc.setFontSize(18);
    doc.setFont(undefined, 'bold');
    addWrappedText(`Ideen-Export - ${new Date().toLocaleDateString("de-DE")}`, leftMargin, contentWidth, { fontSize: 18, fontStyle: 'bold', lineHeight: 7 });
    yPosition += 5;

    ideenToExport.forEach((idee, index) => {
        if (!idee) return;
        if (index > 0) {
            yPosition += (ideaSpacing / 2);
        }
        checkAddPage(40); 
        if (index > 0) {
            doc.setDrawColor(180, 180, 180);
            doc.line(leftMargin, yPosition - (ideaSpacing / 4), doc.internal.pageSize.width - rightMargin, yPosition - (ideaSpacing / 4));
        }

        let titleText = `${idee.erledigt ? '[ERLEDIGT] ' : ''}${idee.vorgangsnummer ? `[Vorgang ${idee.vorgangsnummer}] ` : ''}${idee.text || 'Ohne Titel'}`;
        addWrappedText(titleText, leftMargin, contentWidth, { fontSize: 14, fontStyle: 'bold', lineHeight: 7 });

        let metaText = `Kategorie: ${idee.kategorie || '-'} | Priorität: ${idee.prioritaet || '-'} | Datum: ${getFormattedDate(idee.timestamp)}`;
        addWrappedText(metaText, leftMargin, contentWidth, { fontSize: 9, color: [51, 51, 51], lineHeight: 4 });
        yPosition += 2;

        if (idee.benutzer) addWrappedText(`Zuständig: ${idee.benutzer}`, leftMargin, contentWidth, { fontSize: 10, lineHeight: defaultLineSpacing });
        if (idee.mandantennummer) addWrappedText(`Mandant: ${idee.mandantennummer}`, leftMargin, contentWidth, { fontSize: 10, lineHeight: defaultLineSpacing });
        if (idee.firmenname) addWrappedText(`Firma: ${idee.firmenname}`, leftMargin, contentWidth, { fontSize: 10, lineHeight: defaultLineSpacing });
        if (idee.benutzer || idee.mandantennummer || idee.firmenname) yPosition += (sectionSpacing / 2);

        if (idee.details) {
            checkAddPage(sectionSpacing + defaultLineSpacing);
            addWrappedText("Beschreibung:", leftMargin, contentWidth, { fontSize: 11, fontStyle: 'bold', lineHeight: 6 });
            addWrappedText(idee.details, leftMargin, contentWidth, { fontSize: 10, lineHeight: defaultLineSpacing });
            yPosition += (sectionSpacing / 2);
        }

        if (idee.erinnerung && idee.erinnerung.termin) {
            checkAddPage(sectionSpacing + defaultLineSpacing * 4);
            addWrappedText("Erinnerung:", leftMargin, contentWidth, { fontSize: 11, fontStyle: 'bold', lineHeight: 6 });
            const erinnerungTextPDF = formatErinnerungForExport(idee.erinnerung).replace(/\n$/, "");
            addWrappedText(erinnerungTextPDF, leftMargin + 3, contentWidth - 3, { fontSize: 9, lineHeight: 4 });
            yPosition += (sectionSpacing / 2);
        }

        if (idee.beschreibungen && idee.beschreibungen.length > 0) {
            checkAddPage(sectionSpacing + defaultLineSpacing);
            addWrappedText("Weitere Beschreibungen:", leftMargin, contentWidth, { fontSize: 11, fontStyle: 'bold', lineHeight: 6 });
            idee.beschreibungen.forEach(b => {
                if (b && b.text !== undefined) {
                    checkAddPage(defaultLineSpacing);
                    const indentMM = (b.level || 0) * 5;
                    const startX = leftMargin + 5 + indentMM;
                    const maxWidth = contentWidth - 5 - indentMM;
                    const praefix = b.sichtbar === false ? "[Ausgeblendet] " : "";
                    const textToDisplay = `- [${getFormattedDate(b.timestamp)}] ${praefix}${b.text}`;
                    const textColor = b.sichtbar === false ? [128, 128, 128] : [0, 0, 0];
                    if (maxWidth > 0) {
                        addWrappedText(textToDisplay, startX, maxWidth, { fontSize: 10, lineHeight: defaultLineSpacing, color: textColor });
                    } else { 
                        addWrappedText(textToDisplay, leftMargin + 5, contentWidth - 5, { fontSize: 10, lineHeight: defaultLineSpacing, color: textColor });
                    }
                    if(b.attachments && b.attachments.length > 0) {
                        checkAddPage(defaultLineSpacing);
                        b.attachments.forEach(anhang => {
                            const anhangText = `   -> ${anhang.name}`;
                            const anhangColor = anhang.link ? [0, 0, 238] : [0,0,0];
                            addWrappedText(anhangText, startX + 5, maxWidth - 5, {fontSize: 9, color: anhangColor, lineHeight: 4, link: anhang.link});
                        });
                        yPosition += 2;
                    }
                     if (b.erinnerung && b.erinnerung.termin) {
                         checkAddPage(defaultLineSpacing * 3);
                         const erinnerungTextPDF = formatErinnerungForExport(b.erinnerung).replace(/\n$/, "").replace(/^/gm, "  ");
                         addWrappedText(erinnerungTextPDF, startX, maxWidth, { fontSize: 9, lineHeight: 4 });
                         yPosition += 2;
                     }
                }
            });
            yPosition += (sectionSpacing / 2);
        }

        if (idee.dateien && idee.dateien.length > 0) {
            checkAddPage(sectionSpacing + anhangLineHeight);
            addWrappedText("Anhänge:", leftMargin, contentWidth, { fontSize: 11, fontStyle: 'bold', lineHeight: 6 });
            let currentX = leftMargin + 5;
            for (let i = 0; i < idee.dateien.length; i++) {
                const f = idee.dateien[i];
                if (!f || !f.id) continue;
                const isLast = i === idee.dateien.length - 1;
                const istVeraltet = f.sichtbar === false;
                const praefix = istVeraltet ? "[Veraltet] " : "";
                let anhangDisplayName = `${praefix}${f.name || "Unbenannter Anhang"}`;
                const anhangTextMitKomma = anhangDisplayName + (isLast ? "" : ", ");
                doc.setFontSize(anhangFontSize);
                const textWidth = doc.getTextWidth(anhangTextMitKomma);
                const nameWidthForLink = doc.getTextWidth(anhangDisplayName);

                if (currentX + textWidth > doc.internal.pageSize.width - rightMargin && currentX > leftMargin + 5) {
                    currentX = leftMargin + 5;
                    yPosition += anhangLineHeight;
                    checkAddPage(anhangLineHeight);
                }
                const textY = yPosition;
                const charHeight = doc.getFontSize() / doc.internal.scaleFactor;

                if (f.link) {
                    const linkColor = istVeraltet ? [128, 128, 128] : [0, 0, 238];
                    doc.setTextColor(linkColor[0], linkColor[1], linkColor[2]);
                    doc.text(anhangTextMitKomma, currentX, textY);
                    doc.setDrawColor(linkColor[0], linkColor[1], linkColor[2]);
                    doc.line(currentX, textY + 1, currentX + nameWidthForLink, textY + 1); 
                    doc.link(currentX, textY - charHeight + 1, nameWidthForLink, charHeight, { url: f.link });
                    doc.setTextColor(0, 0, 0); 
                } else {
                    const textColor = istVeraltet ? [128, 128, 128] : [0, 0, 0];
                    doc.setTextColor(textColor[0], textColor[1], textColor[2]);
                    doc.text(anhangTextMitKomma, currentX, textY);
                    doc.setTextColor(0,0,0); 
                }
                currentX += textWidth;
            }
            yPosition += anhangLineHeight;
            yPosition += (sectionSpacing / 2);
        }
        yPosition += ideaSpacing;
    });

    doc.save(fileName);
    return true; 
}

async function teilePerEmail() {
    const ideenToExport = getExportIdeen();
    if (ideenToExport.length === 0) {
        zeigeWarnung("Keine Notizen für Export ausgewählt oder Filter aktiv.", "info");
        return;
    }

    let pdfFileName;
    let emailSubject;

    if (ideenToExport.length === 1) {
        const idee = ideenToExport[0];
        const sanitizedTitle = sanitizeFilename(idee.text || 'Unbenannte_Idee');
        pdfFileName = `Idee_${sanitizedTitle}.pdf`;
        emailSubject = `Idee: ${idee.text || 'Unbenannte Idee'}`;
    } else {
        pdfFileName = `Ideen-Export_(${ideenToExport.length}_Notizen).pdf`;
        emailSubject = `Ideen-Export (${ideenToExport.length} Notizen)`;
    }

    try {
        const pdfErstellt = exportiereAlsPDF(pdfFileName);
        if (!pdfErstellt) { 
            zeigeWarnung(`PDF "${pdfFileName}" konnte nicht erstellt werden (keine Notizen).`, 'warnung');
            return;
        }
        zeigeWarnung(`PDF "${pdfFileName}" wurde heruntergeladen. Bitte manuell an die E-Mail anhängen.`, 'success');
    } catch (e) {
        zeigeWarnung(`Fehler beim Erstellen der PDF: ${e.message}`, 'warnung');
        console.error("Fehler beim PDF-Export für E-Mail:", e);
        return;
    }

    const recipientInput = prompt("An wen soll die Information gesendet werden (E-Mail-Adresse)? Oder 'ich', 'mandant', 'support', 'andere' für interne Vermerke.");
    let recipientInfo = recipientInput ? recipientInput.trim().toLowerCase() : "";

    if (!recipientInfo) {
        zeigeWarnung("E-Mail-Versand abgebrochen, da kein Empfänger angegeben wurde.");
        return;
    }

    let recipientEmailAddress = '';
    if (recipientInput.includes('@')) {
        recipientEmailAddress = encodeURIComponent(recipientInput.trim());
    } else {
        if (!["ich", "mandant", "support"].includes(recipientInfo) && recipientInfo !== "andere" && !recipientInfo.startsWith("andere:")) {
            recipientInfo = `Direkte Eingabe: ${recipientInput.trim()}`;
        } else if (recipientInfo === "andere") {
            const otherDetails = prompt("Zusätzliche Info für den Vermerk bei 'andere'?");
            if (!otherDetails?.trim()) {
                zeigeWarnung("Export abgebrochen, da keine Details für 'andere' angegeben wurden.");
                return;
            }
            recipientInfo = `Andere: ${otherDetails.trim()}`;
        }
    }

    const emailBody = encodeURIComponent(
        `Hallo,\n\n` +
        `anbei die angeforderte Idee/die angeforderten Ideen als PDF-Datei.\n\n` +
        `Bitte hängen Sie die Datei "${pdfFileName}", die zuvor heruntergeladen wurde, manuell an diese E-Mail an.\n\n` +
        `Mit freundlichen Grüßen\n` +
        `Ihre Ideen-App`
    );

    const mailtoLink = `mailto:${recipientEmailAddress}?subject=${encodeURIComponent(emailSubject)}&body=${emailBody}`;
    console.log("Generierter Mailto-Link:", mailtoLink);

    try {
        setTimeout(() => {
            window.location.href = mailtoLink;
        }, 100);
        zeigeWarnung("Versuche, E-Mail-Client zu öffnen...", "info");
    } catch (e) {
        console.error("Mailto Fehler:", e);
        zeigeWarnung(`Fehler beim Öffnen des Mail-Programms: ${e.message}. Sie können den Link manuell aus der Konsole kopieren.`, "warnung");
    }

    await new Promise(resolve => setTimeout(resolve, 300));
    let ideenImSpeicher = JSON.parse(localStorage.getItem("ideen") || "[]");
    let changed = false;
    const ausgewaehlteIDsFuerMail = ideenToExport.map(i => i.id);
    const exportTimestamp = new Date().toLocaleString("de-DE");

    ideenImSpeicher.forEach(idee => {
        if (idee && idee.id && ausgewaehlteIDsFuerMail.includes(idee.id)) {
            const desc = `Informationen weitergeleitet (PDF-Download für E-Mail '${recipientInfo}') am ${exportTimestamp}. PDF-Name: ${pdfFileName}`;
            if (!idee.beschreibungen) { idee.beschreibungen = []; }
            const ts = new Date().toISOString() + '_' + Math.random().toString(36).substr(2, 9);
            idee.beschreibungen.push({ text: desc, timestamp: ts, level: 0, sichtbar: true, attachments: [], erinnerung: getDefaultErinnerung() });
            changed = true;
        }
    });

    if (changed) {
        localStorage.setItem("ideen", JSON.stringify(ideenImSpeicher));
        zeigeIdeen();
        istGespeichert = false;
        if (typeof saveToOneDrive === "function") await saveToOneDrive();
    }
}


async function teilePerWhatsApp(){
    const ideenToExport = getExportIdeen();
    if(ideenToExport.length === 0) { zeigeWarnung("Bitte wählen Sie Notizen für Export aus."); return; }
    const recipientInput = prompt("An wen soll exportiert werden? Info oder 'ich', 'mandant', 'support', 'andere'"); let recipientInfo = recipientInput ? recipientInput.trim().toLowerCase() : ""; if (!recipientInfo) { zeigeWarnung("Export abgebrochen."); return; } if (!["ich", "mandant", "support"].includes(recipientInfo) && recipientInfo !== "andere" && !recipientInfo.startsWith("andere:")) { recipientInfo = `Direkte Eingabe: ${recipientInput.trim()}`; } else if (recipientInfo === "andere") { const other=prompt("Info für 'andere'?"); if (!other?.trim()){zeigeWarnung("Abgebrochen."); return;} recipientInfo = `Andere: ${other.trim()}`; }

    let text = ideenToExport.map(idee => {
        if (!idee) return "";
         let datumTextWA = getFormattedDate(idee.timestamp);
         let hauptBeschreibungTextWA = idee.details ? `\n📝 *Beschreibung:*\n${idee.details}\n` : "";
         const beschreibungenText = idee.beschreibungen && idee.beschreibungen.length ?
               `\n*Weitere Beschreibungen:*\n${
                     idee.beschreibungen.filter(b => b && b.text !== undefined).map(b => {
                         const indentSpacesWA = "  ".repeat(b.level || 0);
                         const praefix = b.sichtbar === false ? "[Ausgeblendet] " : "";
                         let anhangTextWA = "";
                         if(b.attachments && b.attachments.length > 0) {
                             anhangTextWA = "\n" + b.attachments.map(anhang => {
                                 return `${indentSpacesWA}   -> Anhang: ${anhang.name} ${anhang.link ? `(${anhang.link})` : ''}`;
                             }).join("\n");
                         }
                         let erinnerungTextBWA = "";
                         if(b.erinnerung && b.erinnerung.termin) {
                             erinnerungTextBWA = `\n${indentSpacesWA}  🔔 _Erinnerung: ${getFormattedDate(b.erinnerung.termin)} (${b.erinnerung.intervallTyp})_`
                         }

                         return `${indentSpacesWA}  - _[${getFormattedDate(b.timestamp)}]_ ${praefix}${b.text}${anhangTextWA}${erinnerungTextBWA}`;
                     }).join("\n")
               }` : "";
        let anhaengeTextForWhatsApp = "\n📎 Anhänge: Keine";
        if (idee.dateien && idee.dateien.length > 0) {
            anhaengeTextForWhatsApp = `\n📎 *Anhänge:*\n${idee.dateien.filter(f => f && f.id).map(f => {
                const praefix = f.sichtbar === false ? "[Veraltet] " : "";
                return `  - ${praefix}${f.name || 'Unbekannt'} ${f.link ? `(${f.link})` : '(Lokal)'}`;
            }).join("\n")}`;
        }
        let erinnerungTextWA = "";
        if (idee.erinnerung && idee.erinnerung.termin) {
            erinnerungTextWA = `\n🔔 *Erinnerung (${idee.erinnerung.aktiv ? 'Aktiv' : 'Inaktiv'})*:\n  Termin: ${getFormattedDate(idee.erinnerung.termin)}\n  Titel: ${idee.erinnerung.titel}\n  VNr.: ${idee.erinnerung.vorgangsnummer}\n  Intervall: ${idee.erinnerung.intervallTyp || 'einmalig'}`;
            if (idee.erinnerung.intervallTyp === 'tage' && idee.erinnerung.intervallWert) erinnerungTextWA += ` (${idee.erinnerung.intervallWert} T.)`;
            if (idee.erinnerung.vorabErinnerungAktiv) erinnerungTextWA += `\n  Vorab: ${idee.erinnerung.vorabWert} ${idee.erinnerung.vorabEinheit}`;
        }

        return ( `${idee.erledigt ? '_[ERLEDIGT]_ ' : ''}*${idee.vorgangsnummer ? `[Vorgang ${idee.vorgangsnummer}] ` : ''}${idee.text || 'Ohne Titel'}*\n` +
                     `📁 Kat.: ${idee.kategorie||'-'}\n` + `${idee.benutzer?`🧑‍💻 Zust.: ${idee.benutzer}\n`:""}` + `🔖 Prio: ${idee.prioritaet||"-"}\n` + `📅 ${datumTextWA}\n` +
                     `${hauptBeschreibungTextWA}` +
                     `${idee.mandantennummer?`🏢 Mandant: ${idee.mandantennummer}\n`:""}` + `${idee.firmenname?`🏭 Firma: ${idee.firmenname}\n`:""}` +
                     `${erinnerungTextWA}` +
                     `${beschreibungenText}` + `${anhaengeTextForWhatsApp}` );
    }).filter(s => s !== "").join("\n\n------------------------------------\n\n");

    const exportTimestamp = new Date().toLocaleString("de-DE"); const weitergeleitetText = `\n\n_[Notiz(en) markiert als: Weitergeleitet an ${recipientInfo} am ${exportTimestamp}]_`; text += weitergeleitetText; const waLink = `https://wa.me/?text=${encodeURIComponent(text)}`; try { const waWindow = window.open(waLink,"_blank"); if (!waWindow) { zeigeWarnung("WhatsApp konnte nicht geöffnet werden.", "warning"); } } catch (e) { console.error("WhatsApp Fehler:", e); zeigeWarnung("Fehler WhatsApp: " + e.message); }
    await new Promise(resolve => setTimeout(resolve, 100)); let ideenImSpeicher = JSON.parse(localStorage.getItem("ideen") || "[]"); let changed = false; const ausgewaehlteIDsFuerWA = ideenToExport.map(i => i.id); ideenImSpeicher.forEach(idee => { if (idee && idee.id && ausgewaehlteIDsFuerWA.includes(idee.id)) { const desc = `Weitergeleitet via WhatsApp an: ${recipientInfo} am ${exportTimestamp}`; if (!idee.beschreibungen){idee.beschreibungen = [];} const ts = new Date().toISOString() + '_' + Math.random().toString(36).substr(2, 9); idee.beschreibungen.push({ text: desc, timestamp: ts, level: 0, sichtbar: true, attachments: [], erinnerung: getDefaultErinnerung() }); changed = true; }}); if (changed) { localStorage.setItem("ideen", JSON.stringify(ideenImSpeicher)); zeigeIdeen(); istGespeichert = false; if (typeof saveToOneDrive === "function") await saveToOneDrive(); }
}

/**
 * NEU HINZUGEFÜGT: Funktion zum Teilen einer einzelnen Beschreibung per WhatsApp.
 * @param {string} ideeId - Die ID der Haupt-Idee.
 * @param {string} beschreibungTimestamp - Der eindeutige Zeitstempel der zu teilenden Beschreibung.
 */
async function teileBeschreibungPerWhatsApp(ideeId, beschreibungTimestamp) {
    if (!ideeId || !beschreibungTimestamp) {
        zeigeWarnung("Fehler: ID für das Teilen fehlt.", "warnung");
        return;
    }

    // Daten aus dem Speicher laden
    let ideen = JSON.parse(localStorage.getItem("ideen") || "[]");
    const idee = ideen.find(i => i && i.id === ideeId);
    if (!idee) {
        zeigeWarnung("Zugehörige Idee nicht gefunden.", "warnung");
        return;
    }
    const beschreibung = idee.beschreibungen?.find(b => b && b.timestamp === beschreibungTimestamp);
    if (!beschreibung) {
        zeigeWarnung("Spezifische Beschreibung nicht gefunden.", "warnung");
        return;
    }
    
    // Empfänger abfragen
    const recipientInput = prompt("An wen soll diese Beschreibung gesendet werden? Info oder 'ich', 'mandant', 'support', 'andere'");
    let recipientInfo = recipientInput ? recipientInput.trim().toLowerCase() : "";
    if (!recipientInfo) {
        zeigeWarnung("Export abgebrochen, kein Empfänger angegeben.");
        return;
    }
    if (!["ich", "mandant", "support"].includes(recipientInfo) && recipientInfo !== "andere" && !recipientInfo.startsWith("andere:")) {
        recipientInfo = `Direkte Eingabe: ${recipientInput.trim()}`;
    } else if (recipientInfo === "andere") {
        const other = prompt("Zusätzliche Info für den Vermerk bei 'andere'?");
        if (!other?.trim()) {
            zeigeWarnung("Abgebrochen, keine Details für 'andere' angegeben.");
            return;
        }
        recipientInfo = `Andere: ${other.trim()}`;
    }

    // WhatsApp-Nachricht erstellen
    let text = `*Teil-Information aus Vorgang ${idee.vorgangsnummer || 'N/A'}: ${idee.text || 'Ohne Titel'}*\n\n`;
    text += `*Beschreibung vom ${getFormattedDate(beschreibung.timestamp)}:*\n`;
    text += `${beschreibung.text || 'Kein Text'}`;

    if (beschreibung.attachments && beschreibung.attachments.length > 0) {
        text += `\n\n*Anhänge zu dieser Beschreibung:*\n`;
        text += beschreibung.attachments.map(att => `  - ${att.name || 'Unbekannt'} ${att.link ? `(${att.link})` : '(Lokal)'}`).join('\n');
    }

    const exportTimestamp = new Date().toLocaleString("de-DE");
    text += `\n\n_[Diese einzelne Beschreibung wurde weitergeleitet an: ${recipientInfo} am ${exportTimestamp}]_`;

    // WhatsApp-Link öffnen
    const waLink = `https://wa.me/?text=${encodeURIComponent(text)}`;
    try {
        const waWindow = window.open(waLink, "_blank");
        if (!waWindow) {
            zeigeWarnung("WhatsApp konnte nicht im neuen Tab geöffnet werden. Prüfen Sie Ihren Pop-up-Blocker.", "warning");
        }
    } catch (e) {
        console.error("WhatsApp Link Fehler:", e);
        zeigeWarnung("Fehler beim Öffnen von WhatsApp: " + e.message, "warnung");
    }

    // Protokoll-Eintrag in der App speichern
    await new Promise(resolve => setTimeout(resolve, 100)); 
    const ideeIndex = ideen.findIndex(i => i && i.id === ideeId);
    if (ideeIndex !== -1) {
        const logDesc = `Einzelne Beschreibung (vom ${getFormattedDate(beschreibung.timestamp)}) weitergeleitet via WhatsApp an: ${recipientInfo} am ${exportTimestamp}.`;
        const ts = new Date().toISOString() + '_' + Math.random().toString(36).substr(2, 9);
        ideen[ideeIndex].beschreibungen.push({ text: logDesc, timestamp: ts, level: 0, sichtbar: true, attachments: [], erinnerung: getDefaultErinnerung() });
        
        localStorage.setItem("ideen", JSON.stringify(ideen));
        zeigeIdeen();
        istGespeichert = false;
        if (typeof saveToOneDrive === "function") {
            await saveToOneDrive();
        }
    }
}


/* --- END BLOCK 6 --- */
// --- FUNKTIONEN FÜR KALENDERTERMINERSTELLUNG ---

function zeigeTerminDialog(ideeId) {
    terminFuerId = ideeId;
    const ideen = JSON.parse(localStorage.getItem("ideen") || "[]");
    const idee = ideen.find(i => i && i.id === ideeId);

    if (!idee) {
        zeigeWarnung("Fehler: Idee für Termin nicht gefunden.", "warnung");
        return;
    }

    document.getElementById("terminTitelInput").value = idee.text || "Neuer Termin";

    const jetzt = new Date();
    const startStunde = jetzt.getHours() + 1;
    jetzt.setHours(startStunde);
    jetzt.setMinutes(0); 
    jetzt.setSeconds(0);
    jetzt.setMilliseconds(0);

    const startVorschlag = new Date(jetzt);
    const endeVorschlag = new Date(startVorschlag.getTime() + 60 * 60 * 1000);

    const toLocalISOString = (date) => {
        const year = date.getFullYear();
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const day = date.getDate().toString().padStart(2, '0');
        const hours = date.getHours().toString().padStart(2, '0');
        const minutes = date.getMinutes().toString().padStart(2, '0');
        return `${year}-${month}-${day}T${hours}:${minutes}`;
    };

    document.getElementById("terminStartInput").value = toLocalISOString(startVorschlag);
    document.getElementById("terminEndeInput").value = toLocalISOString(endeVorschlag);
    document.getElementById("terminOrtInput").value = "";

    document.getElementById("terminDialog").style.display = "block";
    document.getElementById("terminTitelInput").focus();
}

function terminDialogAbbrechen() {
    document.getElementById("terminDialog").style.display = "none";
    terminFuerId = null;
    document.getElementById("terminTitelInput").value = "";
    document.getElementById("terminStartInput").value = "";
    document.getElementById("terminEndeInput").value = "";
    document.getElementById("terminOrtInput").value = "";
}
async function kalenderTerminErstellenUndSpeichern() {
    if (!terminFuerId) return;

    const titel = document.getElementById("terminTitelInput").value.trim();
    const startZeitValue = document.getElementById("terminStartInput").value;
    const endeZeitValue = document.getElementById("terminEndeInput").value;
    const ort = document.getElementById("terminOrtInput").value.trim();

    if (!titel) {
        zeigeWarnung("Bitte einen Titel für den Termin angeben.", "warnung");
        return;
    }
    if (!startZeitValue || !endeZeitValue) {
        zeigeWarnung("Bitte Start- und Endzeit für den Termin angeben.", "warnung");
        return;
    }

    const startDatum = new Date(startZeitValue);
    const endeDatum = new Date(endeZeitValue);

    if (endeDatum <= startDatum) {
        zeigeWarnung("Die Endzeit muss nach der Startzeit liegen.", "warnung");
        return;
    }

    let ideen = JSON.parse(localStorage.getItem("ideen") || "[]");
    const ideeIndex = ideen.findIndex(i => i && i.id === terminFuerId);
    if (ideeIndex === -1) {
        zeigeWarnung("Fehler: Zugehörige Idee nicht gefunden.", "warnung");
        terminDialogAbbrechen();
        return;
    }
    const idee = ideen[ideeIndex];

    let terminBeschreibungText = idee.details || "";

    if (idee.beschreibungen && idee.beschreibungen.length > 0) {
        terminBeschreibungText += "\n\n--- Weitere Beschreibungen ---";
        idee.beschreibungen.forEach(b => {
            if (b && b.sichtbar !== false && b.text) { 
                terminBeschreibungText += `\n\nBeschreibung vom ${getFormattedDate(b.timestamp)}:\n${b.text}`;
                if (b.attachments && b.attachments.length > 0) {
                    terminBeschreibungText += "\nAnhänge zu dieser Beschreibung:";
                    b.attachments.forEach(anhang => {
                        if (anhang.link) {
                            terminBeschreibungText += `\n- ${anhang.name}: ${anhang.link}`;
                        }
                    });
                }
            }
        });
    }

    if (idee.dateien && idee.dateien.length > 0) {
        let anhangLinksText = "";
        idee.dateien.forEach(datei => {
            if (datei && datei.link && datei.sichtbar !== false) { 
                if (anhangLinksText === "") { 
                    anhangLinksText += "\n\n--- Haupt-Anhänge ---";
                }
                anhangLinksText += `\n${datei.name || 'Unbenannter Anhang'}: ${datei.link}`;
            } else if (datei && datei.name && datei.sichtbar !== false) { 
                 if (anhangLinksText === "") { 
                    anhangLinksText += "\n\n--- Haupt-Anhänge ---";
                }
                anhangLinksText += `\n${datei.name || 'Unbenannter Anhang'} (Lokale Datei, kein direkter Link verfügbar)`;
            }
        });
        terminBeschreibungText += anhangLinksText;
    }
    
    let finalTerminBeschreibungText = terminBeschreibungText;
    const MAX_URL_DESC_LENGTH = 1800; 
    if (finalTerminBeschreibungText.length > MAX_URL_DESC_LENGTH) {
        finalTerminBeschreibungText = finalTerminBeschreibungText.substring(0, MAX_URL_DESC_LENGTH) + "\n... (Inhalt für Kalenderlink gekürzt)";
        zeigeWarnung("Die Terminbeschreibung (inkl. Anhänge) war für den Kalenderlink zu lang und wurde automatisch gekürzt.", "info");
    }
    
    const toUTCGoogleFormat = (date) => {
        return date.getUTCFullYear() +
               ('0' + (date.getUTCMonth() + 1)).slice(-2) +
               ('0' + date.getUTCDate()).slice(-2) +
               'T' +
               ('0' + date.getUTCHours()).slice(-2) +
               ('0' + date.getUTCMinutes()).slice(-2) +
               ('0' + date.getUTCSeconds()).slice(-2) +
               'Z';
    };

    let calendarUrl = `https://www.google.com/calendar/render?action=TEMPLATE`;
    calendarUrl += `&text=${encodeURIComponent(titel)}`;
    calendarUrl += `&dates=${toUTCGoogleFormat(startDatum)}/${toUTCGoogleFormat(endeDatum)}`;
    calendarUrl += `&details=${encodeURIComponent(finalTerminBeschreibungText.replace(/\n/g, '\r\n'))}`; 
    if (ort) {
        calendarUrl += `&location=${encodeURIComponent(ort)}`;
    }

    console.log("Generierter Kalender-URL:", calendarUrl);
    console.log("Länge des Kalender-URLs:", calendarUrl.length);

    window.open(calendarUrl, '_blank');
    zeigeWarnung("Kalenderlink wurde erstellt und geöffnet. Bitte Termin dort bestätigen/speichern.", "success");

    const nachweisText = `Kalendertermin erstellt für: ${getFormattedDate(startDatum)} bis ${getFormattedDate(endeDatum)}. Titel: "${titel}" ${ort ? `, Ort: "${ort}"` : ''}. Links zu Anhängen wurden ggf. mitübertragen.`;
    if (!ideen[ideeIndex].beschreibungen) {
        ideen[ideeIndex].beschreibungen = [];
    }
    const timestamp = new Date().toISOString() + '_' + Math.random().toString(36).substr(2, 9);
    ideen[ideeIndex].beschreibungen.push({ text: nachweisText, timestamp: timestamp, level: 0, sichtbar: true, attachments: [], erinnerung: getDefaultErinnerung() });

    localStorage.setItem("ideen", JSON.stringify(ideen));
    zeigeIdeen(); 
    if (typeof saveToOneDrive === "function") { 
       await saveToOneDrive();
    } else {
      console.warn("saveToOneDrive Funktion nicht gefunden, Überspringe OneDrive Sync für Terminvermerk.");
    }

    terminDialogAbbrechen();
    istGespeichert = false; 
}
// --- ENDE FUNKTIONEN FÜR KALENDERTERMINERSTELLUNG ---


/* --- FUNKTIONEN FÜR BROWSER-BENACHRICHTIGUNGEN (MODIFIZIERT) --- */
async function initialisiereUndStarteBenachrichtigungspruefung() {
    if (!("Notification" in window)) {
        console.warn("Dieser Browser unterstützt keine Desktop-Benachrichtigungen.");
        zeigeWarnung("Browser unterstützt keine Benachrichtigungen.", "info");
        return;
    }

    if (Notification.permission === "granted") {
        starteBenachrichtigungspruefung();
    } else if (Notification.permission !== "denied") {
        try {
            const permission = await Notification.requestPermission();
            if (permission === "granted") {
                zeigeWarnung("Benachrichtigungen wurden aktiviert!", "success");
                starteBenachrichtigungspruefung();
            } else {
                zeigeWarnung("Benachrichtigungen wurden nicht aktiviert.", "info");
            }
        } catch (error) {
            console.error("Fehler beim Anfordern der Benachrichtigungsberechtigung:", error);
            zeigeWarnung("Fehler bei Benachrichtigungs-Berechtigung.", "warnung");
        }
    } else {
        zeigeWarnung("Benachrichtigungen sind blockiert. Bitte in den Browser-Einstellungen ändern.", "info");
    }
}

function starteBenachrichtigungspruefung() {
    if (benachrichtigungsIntervallId) {
        clearInterval(benachrichtigungsIntervallId);
    }
    benachrichtigungsIntervallId = setInterval(pruefeUndZeigeBenachrichtigungen, 60000);
    console.log("Benachrichtigungsprüfung gestartet.");
    pruefeUndZeigeBenachrichtigungen(); 
}

function pruefeUndZeigeBenachrichtigungen() {
    if (Notification.permission !== "granted") {
        return;
    }

    let ideen = JSON.parse(localStorage.getItem("ideen") || "[]");
    if (!Array.isArray(ideen)) return;

    const jetzt = new Date();
    let aenderungenVorgenommen = false;

    ideen.forEach(idee => {
        if (!idee) return;

        const handleFrist = (erinnerungObjekt, istBeschreibung = false, beschreibungText = "") => {
            const terminDatum = new Date(erinnerungObjekt.termin);
            if (terminDatum <= jetzt) {
                let titel, bodyText, tag;
                if (istBeschreibung) {
                    titel = `Vorgang ${idee.vorgangsnummer || 'N/A'}: ${idee.text}`;
                    bodyText = `Detail-Erinnerung: "${beschreibungText}"`;
                    tag = idee.id + '_' + erinnerungObjekt.termin + '_desc';
                } else {
                    titel = erinnerungObjekt.titel || idee.text || "Ideen-App Erinnerung";
                    bodyText = `Ihre Erinnerung für "${titel}" (Vorgang: ${idee.vorgangsnummer || 'N/A'}) ist jetzt fällig.`;
                    tag = idee.id + '_' + erinnerungObjekt.termin;
                }
                
                try {
                    const notification = new Notification(titel, { body: bodyText, tag: tag });
                    notification.onclick = function() {
                        window.focus(); 
                        this.close();
                    };
                } catch (e) {
                    console.error("Fehler beim Erstellen der Benachrichtigung:", e);
                }

                if (erinnerungObjekt.intervallTyp === 'einmalig') {
                    erinnerungObjekt.aktiv = false;
                } else {
                    let naechsterTermin = new Date(terminDatum);
                    let intervallValid = true;
                    switch (erinnerungObjekt.intervallTyp) {
                        case 'tage':
                            if (erinnerungObjekt.intervallWert > 0) naechsterTermin.setDate(terminDatum.getDate() + parseInt(erinnerungObjekt.intervallWert, 10)); else intervallValid = false;
                            break;
                        case 'woechentlich': naechsterTermin.setDate(terminDatum.getDate() + 7); break;
                        case 'monatlich': naechsterTermin.setMonth(terminDatum.getMonth() + 1); break;
                        case 'vierteljaehrlich': naechsterTermin.setMonth(terminDatum.getMonth() + 3); break;
                        case 'jaehrlich': naechsterTermin.setFullYear(terminDatum.getFullYear() + 1); break;
                        default: intervallValid = false; break;
                    }

                    if (!intervallValid) {
                        erinnerungObjekt.aktiv = false;
                    } else if (erinnerungObjekt.aktiv) {
                        while (naechsterTermin <= jetzt && (erinnerungObjekt.intervallTyp === 'tage' && erinnerungObjekt.intervallWert > 0)) {
                           naechsterTermin.setDate(naechsterTermin.getDate() + parseInt(erinnerungObjekt.intervallWert, 10));
                        }
                        if (naechsterTermin > jetzt) {
                            erinnerungObjekt.termin = naechsterTermin.toISOString();
                        } else {
                            erinnerungObjekt.aktiv = false;
                        }
                    }
                }
                aenderungenVorgenommen = true;
            }
        };

        if (idee.erinnerung && idee.erinnerung.aktiv && idee.erinnerung.termin) {
            handleFrist(idee.erinnerung, false);
        }

        if (idee.beschreibungen && Array.isArray(idee.beschreibungen)) {
            idee.beschreibungen.forEach(beschreibung => {
                if (beschreibung && beschreibung.erinnerung && beschreibung.erinnerung.aktiv && beschreibung.erinnerung.termin) {
                    handleFrist(beschreibung.erinnerung, true, beschreibung.text);
                }
            });
        }
    });

    if (aenderungenVorgenommen) {
        localStorage.setItem("ideen", JSON.stringify(ideen));
        zeigeIdeen(); 
        if (typeof saveToOneDrive === "function") { 
            saveToOneDrive(); 
        } else {
            console.warn("saveToOneDrive Funktion nicht gefunden, Überspringe OneDrive Sync für Benachrichtigungsupdate.");
        }
        console.log("Ideenliste nach Benachrichtigungsprüfung aktualisiert.");
    }
}
/* --- ENDE FUNKTIONEN FÜR BROWSER-BENACHRICHTIGUNGEN --- */
/* --- START BLOCK 7: File & OneDrive --- */
async function uploadToOneDrive(f){if(!accessToken){zeigeWarnung("Bitte zuerst mit Microsoft anmelden!");return null;}try{const n=`ideenapp/${Date.now()}_${f.name}`;const u=await fetch(`https://graph.microsoft.com/v1.0/me/drive/root:/${n}:/content`,{method:"PUT",headers:{"Authorization":`Bearer ${accessToken}`,"Content-Type":f.type},body:f});const d=await u.json();if(!u.ok){throw new Error(`OneDrive Upload Error ${u.status}: ${d?.error?.message||'Unknown'}`);}const s=await fetch(`https://graph.microsoft.com/v1.0/me/drive/items/${d.id}/createLink`,{method:"POST",headers:{"Authorization":`Bearer ${accessToken}`,"Content-Type":"application/json"},body:JSON.stringify({type:"view",scope:"anonymous"})});const j=await s.json();if(!s.ok){throw new Error(`OneDrive Link Error ${s.status}: ${j?.error?.message||'Unknown'}`);}return j.link.webUrl;}catch(e){console.error("OneDrive Upload/Link Fehler:",e);zeigeWarnung("OneDrive-Fehler: "+e.message);return null;}}
async function saveToOneDrive(){ if(!accessToken){ return; } try { const ideen=JSON.parse(localStorage.getItem("ideen")||"[]"); const benutzer=JSON.parse(localStorage.getItem("benutzerliste")||"[]"); const kategorien=JSON.parse(localStorage.getItem("kategorien")||"[]"); const nummer=localStorage.getItem("naechsteVorgangsnummer")||"1"; const data={ideen,benutzerliste:benutzer,kategorien,naechsteVorgangsnummer:nummer}; const dataStr=JSON.stringify(data,null,2); const path=(document.getElementById("onedrivePath").value.trim()||"/ideenapp/ideen.json"); const finalPath=path.startsWith('/')?path:'/'+path; if(!finalPath||finalPath==='/'){zeigeWarnung("OneDrive Speichern: Ungültiger Pfad.");return;} const url=`https://graph.microsoft.com/v1.0/me/drive/root:${finalPath}:/content`; const res=await fetch(url,{method:"PUT",headers:{"Authorization":`Bearer ${accessToken}`,"Content-Type":"application/json"},body:dataStr}); if(res.ok){istGespeichert=true;}else{const err=await res.json().catch(()=>null); const msg=err?.error?.message||res.statusText; zeigeWarnung(`OneDrive Speichern Fehler: ${msg}`);}}catch(e){zeigeWarnung("OneDrive Speichern Fehler: "+e.message);}}
async function loadFromOneDrive(){ if(!accessToken){ const ok=await handleLogin(); if(!ok||!accessToken){return;} } const path=(document.getElementById("onedrivePath").value.trim()||"/ideenapp/ideen.json"); const finalPath=path.startsWith('/')?path:'/'+path; if(!finalPath||finalPath==='/'){zeigeWarnung("OneDrive Laden: Ungültiger Pfad.");return;} zeigeWarnung(`Lade Daten von OneDrive: ${finalPath}...`,'info'); try{ const url=`https://graph.microsoft.com/v1.0/me/drive/root:${finalPath}:/content`; const res=await fetch(url,{method:"GET",headers:{"Authorization":`Bearer ${accessToken}`}}); if(res.ok){ const content=await res.text(); const loadedData=JSON.parse(content); let ideen=[], benutzerliste=[], kategorienAusDatei=null, nummer=1; if(loadedData&&typeof loadedData==='object'&&Array.isArray(loadedData.ideen)){ ideen=loadedData.ideen; benutzerliste=Array.isArray(loadedData.benutzerliste)?loadedData.benutzerliste:[]; kategorienAusDatei=Array.isArray(loadedData.kategorien)?loadedData.kategorien:null; nummer=parseInt(loadedData.naechsteVorgangsnummer,10)||1; }else if(Array.isArray(loadedData)){ideen=loadedData; benutzerliste=[]; kategorienAusDatei=null; nummer=1;}else{throw new Error("Ungültiges Dateiformat");} localStorage.setItem("ideen",JSON.stringify(ideen)); localStorage.setItem("benutzerliste",JSON.stringify(benutzerliste)); if(kategorienAusDatei!==null){localStorage.setItem("kategorien",JSON.stringify(kategorienAusDatei));} localStorage.setItem("naechsteVorgangsnummer", nummer.toString()); ausgewaehlt=[]; initialisiereKategorien(); initialisiereBenutzer(); initialisiereVorgangsnummer(); ensureIdeasHaveIds(); aktualisiereMandantenFilterDropdown(); zeigeIdeen(); zeigeWarnung(`Daten von OneDrive geladen! (${finalPath})`,'success'); istGespeichert=true; }else if(res.status===404){zeigeWarnung(`Datei nicht gefunden: ${finalPath}.`,'warning');}else{ const err=await res.json().catch(()=>null); const msg=err?.error?.message||res.statusText; zeigeWarnung(`OneDrive Laden Fehler (${res.status}): ${msg}`);}}catch(e){zeigeWarnung("OneDrive Laden Fehler: "+e.message);}}
async function speichereIdeenAlsDatei(){ try{ const ideen = JSON.parse(localStorage.getItem("ideen")||"[]"); const benutzerData = JSON.parse(localStorage.getItem("benutzerliste")||"[]"); const kategorienData = JSON.parse(localStorage.getItem("kategorien")||"[]"); const nummer = localStorage.getItem("naechsteVorgangsnummer")||"1"; const combinedData = { ideen, benutzerliste: benutzerData, kategorien: kategorienData, naechsteVorgangsnummer: nummer }; const dataToSave = JSON.stringify(combinedData, null, 2); if(window.showSaveFilePicker){ fileHandle = await window.showSaveFilePicker({ suggestedName: "ideen.json", types: [{ description: "JSON-Dateien", accept: { "application/json": [".json"] } }] }); const writable = await fileHandle.createWritable(); await writable.write(dataToSave); await writable.close(); zeigeWarnung("Datei lokal gespeichert!", 'success'); istGespeichert = true; } else { const blob = new Blob([dataToSave], { type: "application/json" }); const url = URL.createObjectURL(blob); const link = document.createElement("a"); link.href = url; link.download = "ideen.json"; link.click(); URL.revokeObjectURL(url); zeigeWarnung("Datei-Download gestartet.", 'success'); istGespeichert = true; }} catch(e) { if(e.name !== "AbortError") { zegeWarnung("Fehler beim lokalen Speichern: " + e.message); } }}
async function ladeIdeenAusDatei(){ try{ let fileContent; if(window.showOpenFilePicker){ [fileHandle] = await window.showOpenFilePicker({ types: [{ description: "JSON-Dateien", accept: { "application/json": [".json"] } }] }); const file = await fileHandle.getFile(); fileContent = await file.text(); } else { const input = document.createElement('input'); input.type = 'file'; input.accept = '.json'; await new Promise((resolve, reject) => { input.onchange = async (e) => { if (e.target.files && e.target.files.length > 0) { const file = e.target.files[0]; const reader = new FileReader(); reader.onload = (event) => { fileContent = event.target.result; resolve(); }; reader.onerror = (error) => reject(error); reader.readAsText(file); } else { reject(new Error("Keine Datei ausgewählt")); } }; input.click(); }); } if (!fileContent) { throw new Error("Kein Dateiinhalt geladen."); } const loadedData = JSON.parse(fileContent); let ideen = [], benutzerliste = [], kategorienAusDatei = null, nummer = 1; if (loadedData && typeof loadedData === 'object' && Array.isArray(loadedData.ideen)) { ideen = loadedData.ideen; benutzerliste = Array.isArray(loadedData.benutzerliste) ? loadedData.benutzerliste : []; kategorienAusDatei = Array.isArray(loadedData.kategorien) ? loadedData.kategorien : null; nummer = parseInt(loadedData.naechsteVorgangsnummer, 10) || 1; } else if (Array.isArray(loadedData)) { ideen = loadedData; benutzerliste = []; kategorienAusDatei = null; nummer = 1; } else { throw new Error("Ungültiges Dateiformat"); } localStorage.setItem("ideen", JSON.stringify(ideen)); localStorage.setItem("benutzerliste", JSON.stringify(benutzerliste)); if (kategorienAusDatei !== null) { localStorage.setItem("kategorien", JSON.stringify(kategorienAusDatei)); } localStorage.setItem("naechsteVorgangsnummer", nummer.toString()); ausgewaehlt = []; initialisiereKategorien(); initialisiereBenutzer(); initialisiereVorgangsnummer(); ensureIdeasHaveIds(); aktualisiereMandantenFilterDropdown(); zeigeIdeen(); zeigeWarnung(`Daten lokal geladen!`, 'success'); istGespeichert = true; } catch(e) { if(e.name !== "AbortError" && e.message !== "Keine Datei ausgewählt" && e.message !== "Kein Dateiinhalt geladen.") { zeigeWarnung("Fehler beim lokalen Laden: " + e.message); } }}
/* --- END BLOCK 7 --- */
/* --- START BLOCK 8: Init & Listeners (MODIFIZIERT) --- */
document.getElementById("ideeText").addEventListener("input",()=>{istGespeichert=!1});
document.getElementById("ideeDetails").addEventListener("input",()=>{istGespeichert=!1});
document.getElementById("mandantennummer").addEventListener("input",()=>{istGespeichert=!1});
document.getElementById("firmenname").addEventListener("input",()=>{istGespeichert=!1});
document.getElementById("kategorie").addEventListener("change",()=>{istGespeichert=!1});
document.getElementById("neueKategorie").addEventListener("input",()=>{istGespeichert=!1});
document.getElementById("benutzer").addEventListener("change",()=>{istGespeichert=!1});
document.getElementById("neuerBenutzer").addEventListener("input",()=>{istGespeichert=!1});
document.getElementById("dateien").addEventListener("change",function(e){
    const v=document.getElementById("dateiVorschau");
    v.innerHTML="Ausgewählte Dateien (werden beim Speichern hinzugefügt):<br>";
    Array.from(e.target.files).forEach(file=>{
       v.innerHTML+=`<span style="display:inline-block; margin:3px; font-size:0.9em; background:#eee; padding: 2px 5px; border-radius: 3px;">📄 ${file.name}</span>`;
    });
    istGespeichert=!1;
});
window.addEventListener("beforeunload",function(e){if(!istGespeichert){const msg="Ungespeicherte Änderungen! Seite wirklich verlassen?";e.preventDefault();e.returnValue=msg;return msg;}});

function ensureIdeasHaveIds() {
    let ideen = [];
    try {
        const storedIdeen = localStorage.getItem("ideen");
        if (storedIdeen) { ideen = JSON.parse(storedIdeen); }
    } catch(e) { 
        console.error("Fehler beim Parsen von 'ideen' aus localStorage in ensureIdeasHaveIds:", e);
        localStorage.removeItem("ideen"); 
        ideen = []; 
    }

    let changed = false;
    if (!Array.isArray(ideen)) { 
        ideen = []; 
        changed = true; 
    }

    const initialIdeenLength = ideen.length;
    ideen = ideen.filter(idee => idee && typeof idee === 'object' && idee.id && typeof idee.id === 'string');
    if (ideen.length < initialIdeenLength) { 
        changed = true; 
        console.warn("Einige Ideen wurden entfernt, da sie keine valide Struktur oder ID hatten.");
    }

    ideen.forEach(idee => {
        if (!Array.isArray(idee.beschreibungen)) { idee.beschreibungen = []; changed = true; }
        else {
            if (idee.beschreibungen.length > 0 && typeof idee.beschreibungen[0] === 'string') {
                idee.beschreibungen = idee.beschreibungen.map(text => ({ text: text, timestamp: new Date().toISOString() + '_' + Math.random().toString(36).substr(2, 9), level: 0, sichtbar: true, attachments: [], erinnerung: getDefaultErinnerung() }));
                changed = true;
            } else {
                const originalLengthDesc = idee.beschreibungen.length;
                idee.beschreibungen = idee.beschreibungen.filter(b => b && typeof b === 'object' && typeof b.text === 'string');
                idee.beschreibungen.forEach(b => {
                    if (!b.timestamp || typeof b.timestamp !== 'string') { b.timestamp = new Date().toISOString() + '_' + Math.random().toString(36).substr(2, 9); changed = true; }
                    if (typeof b.level !== 'number' || b.level < 0) { b.level = 0; changed = true; }
                    if (typeof b.sichtbar !== 'boolean') { b.sichtbar = true; changed = true; }
                    if (!Array.isArray(b.attachments)) { b.attachments = []; changed = true; }
                    if (!b.erinnerung || typeof b.erinnerung !== 'object') { b.erinnerung = getDefaultErinnerung(); changed = true; }
                });
                if (idee.beschreibungen.length < originalLengthDesc) { changed = true; }
            }
        }

        if (!Array.isArray(idee.dateien)) { idee.dateien = []; changed = true; }
        else {
            const originalLengthFiles = idee.dateien.length;
            idee.dateien = idee.dateien.filter(d => d && typeof d === 'object');
            idee.dateien.forEach(datei => {
                if (!datei.id || typeof datei.id !== 'string') { datei.id = generateUUID(); changed = true; }
                if (typeof datei.sichtbar !== 'boolean') { datei.sichtbar = true; changed = true; }
                if (datei.link === undefined) { datei.link = null; changed = true; }
                if (datei.data) { delete datei.data; changed = true; }
                if (datei.pfad) { delete datei.pfad; changed = true; }
            });
             if (idee.dateien.length < originalLengthFiles) { changed = true; }
        }

        const defaultErinnerung = getDefaultErinnerung(idee.text, idee.vorgangsnummer);
        if (!idee.erinnerung || typeof idee.erinnerung !== 'object') {
            idee.erinnerung = { ...defaultErinnerung };
            changed = true;
        } else {
            let erinnerungChanged = false;
            for (const key in defaultErinnerung) {
                if (idee.erinnerung[key] === undefined) {
                    idee.erinnerung[key] = defaultErinnerung[key];
                    erinnerungChanged = true;
                }
            }
            if (typeof idee.erinnerung.aktiv !== 'boolean') { idee.erinnerung.aktiv = defaultErinnerung.aktiv; erinnerungChanged = true; }
            if (idee.erinnerung.termin && typeof idee.erinnerung.termin !== 'string') { idee.erinnerung.termin = null; erinnerungChanged = true;}
            if (typeof idee.erinnerung.intervallTyp !== 'string') { idee.erinnerung.intervallTyp = defaultErinnerung.intervallTyp; erinnerungChanged = true; }
            
            if (idee.erinnerung.intervallTyp === 'tage' && (typeof idee.erinnerung.intervallWert !== 'number' || idee.erinnerung.intervallWert < 1) && idee.erinnerung.intervallWert !== null) {
                idee.erinnerung.intervallWert = defaultErinnerung.intervallWert; 
                erinnerungChanged = true;
            } else if (idee.erinnerung.intervallTyp !== 'tage') { 
                if (idee.erinnerung.intervallWert !== null) {
                    idee.erinnerung.intervallWert = null;
                    erinnerungChanged = true;
                }
            }

            if (typeof idee.erinnerung.vorabErinnerungAktiv !== 'boolean') { idee.erinnerung.vorabErinnerungAktiv = defaultErinnerung.vorabErinnerungAktiv; erinnerungChanged = true; }
            if (idee.erinnerung.vorabErinnerungAktiv) {
                if ((typeof idee.erinnerung.vorabWert !== 'number' || idee.erinnerung.vorabWert < 1) && idee.erinnerung.vorabWert !== null) {
                    idee.erinnerung.vorabWert = defaultErinnerung.vorabWert; erinnerungChanged = true;
                }
                if (typeof idee.erinnerung.vorabEinheit !== 'string') {
                    idee.erinnerung.vorabEinheit = defaultErinnerung.vorabEinheit; erinnerungChanged = true;
                }
            } else { 
                 if (idee.erinnerung.vorabWert !== null) { idee.erinnerung.vorabWert = null; erinnerungChanged = true; }
                 if (idee.erinnerung.vorabEinheit !== null) { idee.erinnerung.vorabEinheit = null; erinnerungChanged = true; }
            }
            if (idee.erinnerung.titel !== idee.text) { idee.erinnerung.titel = idee.text; erinnerungChanged = true;}
            if (idee.erinnerung.vorgangsnummer !== idee.vorgangsnummer) { idee.erinnerung.vorgangsnummer = idee.vorgangsnummer; erinnerungChanged = true;}
            if(erinnerungChanged) changed = true;
        }

        if (idee.benutzer === undefined) { idee.benutzer = ""; changed = true; }
        if (idee.mandantennummer === undefined) { idee.mandantennummer = ""; changed = true; }
        if (idee.firmenname === undefined) { idee.firmenname = ""; changed = true; }
        if (typeof idee.erledigt !== 'boolean') { idee.erledigt = false; changed = true; }
        if (idee.vorgangsnummer === undefined) { idee.vorgangsnummer = null; changed = true; } 
        if (idee.prioritaet === undefined) { idee.prioritaet = ""; changed = true; }
        if (!idee.timestamp || typeof idee.timestamp !== 'string') { idee.timestamp = new Date().toISOString(); changed = true; }
    });

    if (changed) {
        try { 
            localStorage.setItem("ideen", JSON.stringify(ideen)); 
            console.log("Datenmigration in ensureIdeasHaveIds durchgeführt und gespeichert.");
        }
        catch (e) { 
            zeigeWarnung("Speicherfehler nach Datenmigration!"); 
            console.error("Fehler beim Speichern nach ensureIdeasHaveIds:", e);
        }
    }
}

document.addEventListener('DOMContentLoaded', () => {
    try {
        initialisiereKategorien();
        initialisiereBenutzer();
        initialisiereVorgangsnummer();
        ensureIdeasHaveIds(); // Stellt die Datenintegrität sicher
        aktualisiereMandantenFilterDropdown();
        zeigeIdeen();
        initialisiereUndStarteBenachrichtigungspruefung();
        pruebeLoginHinweis(); // Initialer Check, ob der User angemeldet sein sollte
    } catch (initError) {
        console.error("Fehler während der Initialisierung:", initError);
        zeigeWarnung("Ein Fehler ist beim Starten der App aufgetreten.", "warnung");
    }
});
/* --- END BLOCK 8 --- */
</script>
</body>
</html>

