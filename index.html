<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Ideen-App Pro</title>
<style>
/* --- START BLOCK 2: CSS Styles --- */
html,body{box-sizing:border-box;margin:0;padding:0;background:#f4f4f4;width:100vw;max-width:100vw;overflow-x:hidden;}
body{font-family:Arial,sans-serif;margin:0 0 20px 0;}
input,select,textarea{margin-top:10px;padding:10px;font-size:1em;width:400px;max-width:100vw;box-sizing:border-box;display:block;}
textarea{min-height:60px;}
button{padding:10px 18px;font-size:1em;margin-top:10px;margin-right:8px;border-radius:4px;border:1px solid #bbb;background:#eee;cursor:pointer;width:auto;min-width:44px;display:inline-block;}
.buttons,.top-actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;}
.filter-bar{margin:20px 0;}
.filter-bar label, .filter-bar select,.filter-bar input{width:auto;display:inline-block;margin-right:10px;margin-top:0;} /* Adjusted spacing */
.filter-bar button { margin-top: 0; } /* Adjusted spacing */
.idee{width:100%;max-width:100vw;box-sizing:border-box;overflow-wrap:break-word;word-break:break-word;background:white;padding:15px;margin:10px 0;border-radius:8px;box-shadow:0 0 5px #ccc;display:flex;align-items:flex-start;justify-content:space-between;}
.idee.erledigt{background:#f0f0f0;}
.idee-content{flex:1;max-width:100%;overflow-wrap:break-word;word-break:break-word;font-size:1em;line-height:1.5;}
.idee-content h3,.idee-content p,.idee-content small{max-width:100%;overflow-wrap:break-word;word-break:break-word;font-size:1em;}
.idee.erledigt .idee-content h3,.idee.erledigt .idee-content p,.idee.erledigt .idee-content small{text-decoration:line-through;color:#888;}
.beschreibung-historie{margin:8px 0 12px 0;}
.beschreibung-item{margin:4px 0 4px 0;padding:6px 8px;background:#f8f8f8;border-left:3px solid #bbb;font-size:0.98em; display: flex; justify-content: space-between; align-items: center;} /* Flexbox f√ºr Button daneben */
.beschreibung-text-zeit { flex-grow: 1; margin-right: 10px;} /* Text nimmt Platz ein */
.beschreibung-zeit{color:#666;font-size:0.9em;margin-bottom:2px;display:block;}
.beschreibung-eingabe{margin:10px 0;background:#f9f9f9;border-left:3px solid #bbb;padding:8px;}
.idee-checkbox{margin-left:10px;margin-top:5px;min-width:28px;min-height:28px;}
.idee-actions{margin-top:10px;display:flex;gap:5px;flex-wrap:wrap;}
.idee-actions button{width:auto;min-width:44px;padding:6px 10px;font-size:0.95em;}
.prio-btn{background:#eee;border:1px solid #ccc;border-radius:4px;}
.prio-btn.selected{background:#ffd700;border-color:#ff9800;color:#222;}

/* --- NEU: CSS f√ºr Vorgangsnummer-Anzeige --- */
#vorgangsnummerAnzeigeInput { /* Div um die Anzeige */
    margin-top: 15px;
    margin-bottom: -5px; /* Etwas n√§her ans Titelfeld */
    font-size: 0.9em;
    color: #555;
}
.vorgangsnummer-anzeige-liste { /* Div in der Ideenliste */
    font-weight: bold;
    font-size: 0.95em;
    color: #333;
    margin-bottom: 5px;
}
/* --- ENDE NEU --- */


/* CSS f√ºr die Meldungsboxen */
#warnung { /* Dieses div wird f√ºr alle Meldungen genutzt */
    margin: 10px 0;
    font-weight: bold;
    padding: 10px;
    border-radius: 4px;
    display: none; /* Standardm√§√üig versteckt */
    position: fixed; /* Bleibt oben, auch beim Scrollen */
    top: 10px;
    left: 50%;
    transform: translateX(-50%); /* Zentrieren */
    z-index: 1000; /* √úber anderen Elementen */
    width: auto;
    max-width: 80%; /* Nicht zu breit */
    text-align: center;
}

/* CSS f√ºr Warnmeldungen (rot) */
#warnung.warnung{
    color:#d32f2f; /* Red */
    border: 1px solid #d32f2f;
    background-color: #ffe0e0; /* Light red background */
}

/* CSS f√ºr Erfolgsmeldungen (gr√ºn) */
#warnung.success-message {
    color: #388e3c; /* Green */
    border: 1px solid #388e3c;
    background-color: #e8f5e9; /* Light green background */
}

/* CSS f√ºr Info/Progress Meldungen (blau/grau) */
#warnung.info-message {
    color: #1a73e8; /* Neutral Blue */
    border: 1px solid #1a73e8;
    background-color: #e8f0fe; /* Light neutral background */
}


/* CSS f√ºr den kleinen Bearbeiten-Button neben der Beschreibung */
.beschreibung-item .edit-beschreibung-btn {
    padding: 3px 6px; /* Kleineres Padding */
    font-size: 0.8em; /* Kleinere Schrift */
    margin-top: 0; /* Kein Top-Margin */
    min-width: auto; /* Keine Mindestbreite */
    width: auto;
    height: 24px; /* Feste H√∂he */
    line-height: 1; /* Zeilenh√∂he anpassen */
    display: flex; /* Flexbox zum Zentrieren des Symbols */
    align-items: center; /* Vertikal zentrieren */
    justify-content: center; /* Horizontal zentrieren */
}

/* CSS f√ºr OneDrive Buttons */
.top-actions .onedrive-btn {
    background: #0078d4; /* Microsoft Blau */
    color: white;
    border-color: #005a9e;
}


@media (max-width:600px){
input,select,textarea,button{width:100vw;min-width:0;max-width:100vw;}
.buttons,.top-actions,.filter-bar{flex-direction:column;gap:0;}
.filter-bar label, .filter-bar select, .filter-bar input, .filter-bar button { margin-right: 0; margin-bottom: 10px; } /* Adjusted spacing */
.idee{flex-direction:column;}
.idee-checkbox{margin-left:0;margin-top:10px;}
.idee-content,.idee-actions,.datei-link,.datei-info,.datei-vorschau,.idee-checkbox{max-width:100vw;}
/* Anpassung f√ºr Beschreibungseintr√§ge auf kleinen Bildschirmen */
.beschreibung-item { flex-direction: column; align-items: flex-start; }
.beschreibung-text-zeit { margin-right: 0; margin-bottom: 5px; width: 100%; }
.beschreibung-item .edit-beschreibung-btn { margin-top: 5px; }
/* Anpassung der Meldungsbox f√ºr kleine Bildschirme */
#warnung {
    position: static; /* Nicht fixed auf kleinen Screens */
    transform: none;
    left: auto;
    max-width: 100%;
}

}
/* --- END BLOCK 2: CSS Styles --- */
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://alcdn.msauth.net/browser/2.24.0/js/msal-browser.min.js"></script>
</head>
<body>
<h1>Ideen-App</h1>
<div id="warnung"></div> <div id="loginHinweis" class="warnung" style="display:none;">Anmeldung erforderlich: Bitte melden Sie sich zuerst mit Ihrem Microsoft-Konto an. Ohne Anmeldung sind keine Cloud-Links und keine Synchronisation m√∂glich.</div>

<div id="vorgangsnummerAnzeigeInput">N√§chste Vorgangsnummer: <span id="naechsteNummerAnzeige">1</span></div>

<input type="text" id="ideeText" placeholder="Titel*" />
<textarea id="ideeDetails" placeholder="Beschreibung" rows="3"></textarea>
<input type="text" id="mandantennummer" placeholder="Mandantennummer (optional)" />
<input type="text" id="firmenname" placeholder="Firmenname (optional)" />

<select id="kategorie"></select> <input type="text" id="neueKategorie" placeholder="Neue Kategorie" /> <button onclick="neueKategorieHinzufuegen()">+ Kategorie</button> <button class="katLoeschBtn" onclick="kategorieLoeschen()">Kategorie l√∂schen</button> <span id="katHinweis" class="katHinweis" style="display:none;"></span> <select id="benutzer"></select> <input type="text" id="neuerBenutzer" placeholder="Neuer Benutzer" /> <button onclick="neuenBenutzerHinzufuegen()">+ Benutzer</button> <button class="benutzerLoeschBtn" onclick="benutzerLoeschen()">Benutzer l√∂schen</button> <span id="benutzerHinweis" class="benutzerHinweis" style="display:none;"></span> <div class="buttons">
<button id="prioHoch" class="prio-btn" onclick="setzePrioritaet('Hoch')">üî¥ Hoch</button>
<button id="prioMittel" class="prio-btn" onclick="setzePrioritaet('Mittel')">üü† Mittel</button>
<button id="prioNiedrig" class="prio-btn" onclick="setzePrioritaet('Niedrig')">üü¢ Niedrig</button>
</div>
<input type="file" id="dateien" multiple />
<div class="datei-vorschau" id="dateiVorschau"></div>
<div id="preview"></div>
<button id="speichernBtn" onclick="speichereIdee()">üíæ Speichern</button>
<button id="abbrechenBtn" onclick="abbrechenBearbeiten()" style="display:none;">Abbrechen</button>

<div class="filter-bar">
<label>Filter:</label>
<select id="filterKategorie" onchange="zeigeIdeen()">
<option value="" class="filter-option-alle">üéØ Alle Ideen</option>
</select>
<label>Archiv:</label>
<select id="filterArchiv" onchange="zeigeIdeen()">
<option value="nicht_erledigt">Nur nicht erledigt</option>
<option value="erledigt">Nur erledigt</option>
<option value="alle">Alle anzeigen</option>
</select>
<label>Benutzer:</label>
<select id="filterBenutzer" onchange="filterNachBenutzer()">
    </select>
<label>Mandant:</label>
<select id="filterMandant" onchange="filterNachMandant()">
    <option value="">üè¢ Alle Mandanten</option> </select>
<label>Sortierung:</label>
<select id="sortierung" onchange="zeigeIdeen()">
<option value="standard">Standard</option> <option value="neu">Neueste zuerst</option>
<option value="alt">√Ñlteste zuerst</option>
<option value="prio">Nach Priorit√§t</option>
</select>

</div>

<div class="top-actions">
<button onclick="exportiereAlsPDF()">üìù PDF</button>
<button onclick="exportiereAlsText()">üìÑ Text</button>
<button onclick="teilePerEmail()">‚úâÔ∏è E-Mail</button>
<button onclick="teilePerWhatsApp()">üì± WhatsApp</button>
<input type="text" id="onedrivePath" placeholder="/ideenapp/ideen.json" style="width: 250px; margin-top: 0;"/>
<button class="onedrive-btn" onclick="saveToOneDrive()">‚òÅÔ∏è Auf OneDrive speichern</button>
<button class="onedrive-btn" onclick="loadFromOneDrive()">‚òÅÔ∏è Von OneDrive laden</button>
<button onclick="alleIdeenLoeschen()" style="background:#eee;border:1px solid #c00;color:#c00;">Alle Ideen l√∂schen</button>
<button onclick="ausgewaehlteNotizenLoeschen()" style="background:#eee;border:1px solid #c00;color:#c00;">Ausgew√§hlte l√∂schen</button>
<button id="speicherDateiBtn" onclick="speichereIdeenAlsDatei()">Datei speichern</button>
<button id="oeffneDateiBtn" onclick="ladeIdeenAusDatei()">Datei √∂ffnen</button>
<button onclick="handleLogin()" style="background:#e6f4ff;border-color:#0067b8;color:#0067b8;">üîë Mit Microsoft anmelden</button>
<button onclick="handleLogout()" style="background:#ffe0e0;border-color:#c00;color:#c00;">üîí Abmelden</button>
</div>

<div id="ideenListe"></div>

<div id="beschreibungDialog" style="display:none;" class="beschreibung-eingabe">
<textarea id="beschreibungText" placeholder="Weitere Beschreibung" rows="2"></textarea>
<button onclick="beschreibungSpeichern()">üíæ Speichern</button>
<button onclick="beschreibungAbbrechen()">‚ùå Abbrechen</button>
</div>

<script>
console.log("Script started"); // Meldung am Anfang des Skripts
/* --- START BLOCK 4: Script Start, Variables & Initializers --- */

const msalConfig={auth:{clientId:"ddf69193-7eab-4847-a995-b6c08f0df9ae",authority:"https://login.microsoftonline.com/683748a6-faf7-45ef-9da3-10e903da0b00",knownAuthorities:["login.microsoftonline.com"],redirectUri:"https://ecki-android.github.io"}};
// >>> VARIABLEN F√úR FILTER UND LISTEN <<<
let accessToken = null, msalInstance = null, prioritaet = "", bearbeiteId = null, ausgewaehlt = [], fileHandle = null, beschreibungFuerId = null, beschreibungZuBearbeitenderTimestamp = null, istGespeichert = true, standardKategorien = ["Aufgaben","Projekte","Privat","Arbeit","Sp√§ter"], kategorien = [], benutzerliste = [], filterMandantValue = "", filterBenutzerValue = "";
// NEUE VARIABLE f√ºr Vorgangsnummer
let naechsteVorgangsnummer = 1;
// >>> ENDE VARIABLEN <<<


// Funktion zur Generierung einer einfachen UUID v4
function generateUUID() {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
    });
}

// Funktion zum Pr√ºfen und Anzeigen/Verbergen des Login-Hinweises
function pruebeLoginHinweis(){if(!accessToken){document.getElementById("loginHinweis").style.display="block";}else{document.getElementById("loginHinweis").style.display="none";}}


async function handleLogin(){try{msalInstance=new msal.PublicClientApplication(msalConfig);const l=await msalInstance.loginPopup({scopes:["Files.ReadWrite","offline_access"]});const t=await msalInstance.acquireTokenSilent({scopes:["Files.ReadWrite"],account:l.account});accessToken=t.accessToken;zeigeWarnung("Erfolgreich bei Microsoft angemeldet!", 'success');pruebeLoginHinweis();return true;}catch(e){zeigeWarnung("Login fehlgeschlagen: "+e.message);return false;}}
async function handleLogout(){if(!istGespeichert){if(!confirm("Bitte speichern Sie Ihre √Ñnderungen, bevor Sie sich abmelden! Trotzdem abmelden!"))return;}try{if(msalInstance){const a=msalInstance.getAllAccounts()[0];if(a){await msalInstance.logoutPopup({account:a,postLogoutRedirectUri:"https://ecki-android.github.io"});}}accessToken=null;pruebeLoginHinweis();zeigeWarnung("Sie wurden erfolgreich abgemeldet.", 'success');}catch(e){zeigeWarnung("Abmeldung fehlgeschlagen: "+e.message);}}


// Ge√§nderte zeigeWarnung Funktion mit Typ (warning/success/info)
function zeigeWarnung(msg, type = 'warning'){
    const w=document.getElementById("warnung");
    w.textContent=msg;
    w.style.display="block";
    w.classList.remove('warnung', 'success-message', 'info-message');
    if (type === 'success') { w.classList.add('success-message'); }
    else if (type === 'info') { w.classList.add('info-message'); }
    else { w.classList.add('warnung'); }
    setTimeout(()=>w.style.display="none",6000);
}

// Funktion zum Initialisieren der Kategorienliste und Dropdowns
function initialisiereKategorien(){
    let loadedKategorien = JSON.parse(localStorage.getItem("kategorien"));
    let changed = false;
    if (!Array.isArray(loadedKategorien)) {
        kategorien = [...standardKategorien]; // Kopie von Standard verwenden
        changed = true;
    } else {
        kategorien = loadedKategorien;
    }
    if (changed) {
        localStorage.setItem("kategorien", JSON.stringify(kategorien));
    }

    const s=document.getElementById("kategorie");
    s.innerHTML='<option value="">-- Kategorie ausw√§hlen --</option>';
    if (Array.isArray(kategorien)) {
        kategorien.forEach(n=>s.add(new Option(n,n)));
    }

    const f=document.getElementById("filterKategorie");
    f.innerHTML='<option value="" class="filter-option-alle">üéØ Alle Ideen</option>';
    if (Array.isArray(kategorien)) {
        kategorien.forEach(n=>f.add(new Option(n,n)));
    }
}

// Funktion zum Hinzuf√ºgen einer neuen Kategorie
function neueKategorieHinzufuegen(){
    const neueKategorieInput = document.getElementById("neueKategorie");
    const neueKategorieName = neueKategorieInput.value.trim();
    if (!neueKategorieName) {
        zeigeWarnung("Bitte geben Sie einen Kategorienamen ein.");
        return;
    }
    kategorien = JSON.parse(localStorage.getItem("kategorien") || "[]");
    if (!Array.isArray(kategorien)) { kategorien = []; }
    if (kategorien.includes(neueKategorieName)) {
        zeigeWarnung(`Kategorie "${neueKategorieName}" existiert bereits!`);
        return;
    }
    kategorien.push(neueKategorieName);
    kategorien.sort();
    localStorage.setItem("kategorien", JSON.stringify(kategorien));
    saveToOneDrive(); // Auto-Save
    initialisiereKategorien();
    neueKategorieInput.value = "";
    neueKategorieInput.focus();
    zeigeWarnung(`Kategorie "${neueKategorieName}" hinzugef√ºgt.`, 'success');
    istGespeichert = false; // Liste wurde ge√§ndert
}

// Funktion zum L√∂schen einer Kategorie
function kategorieLoeschen(){
    const kategorieSelect = document.getElementById("kategorie");
    const kategorienameZuLoeschen = kategorieSelect.value;
    const nichtLoeschbareKategorien = ["Aufgaben", "Projekte", "Privat", "Arbeit", "Sp√§ter"];

    if (!kategorienameZuLoeschen || kategorienameZuLoeschen === "") {
        zeigeWarnung("Bitte w√§hlen Sie zuerst eine Kategorie zum L√∂schen aus."); return; }
    if (nichtLoeschbareKategorien.includes(kategorienameZuLoeschen)) {
         zeigeWarnung(`Die Standardkategorie "${kategorienameZuLoeschen}" kann nicht gel√∂scht werden.`); return; }

    kategorien = JSON.parse(localStorage.getItem("kategorien") || "[]");
    if (!Array.isArray(kategorien)) { kategorien = []; }
    if (!kategorien.includes(kategorienameZuLoeschen)) {
         zeigeWarnung(`Kategorie "${kategorienameZuLoeschen}" nicht in der Liste gefunden.`); return; }

    const ideen = JSON.parse(localStorage.getItem("ideen") || "[]");
    const anzahlIdeenMitKategorie = ideen.filter(idee => idee.kategorie === kategorienameZuLoeschen).length;
    let confirmMessage = `Soll die Kategorie "${kategorienameZuLoeschen}" WIRKLICH gel√∂scht werden?`;
    if (anzahlIdeenMitKategorie > 0) { confirmMessage += ` ${anzahlIdeenMitKategorie} Notiz(en) sind dieser Kategorie zugeordnet und werden dann *keiner Kategorie* mehr zugeordnet sein.`; }
    if (!confirm(confirmMessage)) { return; }

    const index = kategorien.indexOf(kategorienameZuLoeschen);
    if (index > -1) {
        kategorien.splice(index, 1);
        localStorage.setItem("kategorien", JSON.stringify(kategorien));
        saveToOneDrive(); // Auto-Save

        let ideenChanged = false;
        ideen.forEach(idee => {
            if (idee.kategorie === kategorienameZuLoeschen) {
                idee.kategorie = "";
                ideenChanged = true;
            }
        });
        if(ideenChanged) {
            localStorage.setItem("ideen", JSON.stringify(ideen));
            saveToOneDrive(); // Auto-Save
        }

        initialisiereKategorien();
        const filterKategorieSelect = document.getElementById("filterKategorie");
        if (filterKategorieSelect.value === kategorienameZuLoeschen) { filterKategorieSelect.value = ""; }

        zeigeWarnung(`Kategorie "${kategorienameZuLoeschen}" erfolgreich gel√∂scht.`, 'success');
        zeigeIdeen();
        istGespeichert = true; // √Ñnderungen wurden gespeichert
    } else {
        zeigeWarnung(`Ein interner Fehler ist aufgetreten: Kategorie "${kategorienameZuLoeschen}" konnte nicht gefunden werden.`);
    }
}


// Funktion zum Initialisieren der Benutzerliste und Dropdowns
function initialisiereBenutzer() {
    benutzerliste = JSON.parse(localStorage.getItem("benutzerliste") || "[]");
    if (!Array.isArray(benutzerliste)) {
         benutzerliste = [];
         localStorage.setItem("benutzerliste", "[]");
    }
    const benutzerSelect = document.getElementById("benutzer");
    benutzerSelect.innerHTML = '<option value="">-- Benutzer ausw√§hlen --</option>';
    benutzerliste.forEach(benutzer => { benutzerSelect.add(new Option(benutzer, benutzer)); });

     const filterBenutzerSelect = document.getElementById("filterBenutzer");
     filterBenutzerSelect.innerHTML = '<option value="">üë§ Alle Benutzer</option>';
     benutzerliste.forEach(benutzer => { filterBenutzerSelect.add(new Option(benutzer, benutzer)); });
}

// Funktion zum Hinzuf√ºgen eines neuen Benutzers
function neuenBenutzerHinzufuegen(){
    const neuerBenutzerInput = document.getElementById("neuerBenutzer");
    const neuerBenutzerName = neuerBenutzerInput.value.trim();
    if (!neuerBenutzerName) { zeigeWarnung("Bitte geben Sie einen Benutzernamen ein."); return; }

    benutzerliste = JSON.parse(localStorage.getItem("benutzerliste") || "[]");
    if (!Array.isArray(benutzerliste)) { benutzerliste = []; }
    if (benutzerliste.includes(neuerBenutzerName)) { zeigeWarnung(`Benutzer "${neuerBenutzerName}" existiert bereits!`); return; }

    benutzerliste.push(neuerBenutzerName);
    benutzerliste.sort();
    localStorage.setItem("benutzerliste", JSON.stringify(benutzerliste));
    saveToOneDrive(); // Auto-Save

    aktualisiereBenutzerDropdowns();
    neuerBenutzerInput.value = "";
    neuerBenutzerInput.focus();
    zeigeWarnung(`Benutzer "${neuerBenutzerName}" hinzugef√ºgt.`, 'success');
    istGespeichert = false; // Liste wurde ge√§ndert
}

// Funktion zum L√∂schen eines Benutzers
function benutzerLoeschen(){
    const benutzerSelect = document.getElementById("benutzer");
    const benutzernameZuLoeschen = benutzerSelect.value;

    if (!benutzernameZuLoeschen || benutzernameZuLoeschen === "") { zeigeWarnung("Bitte w√§hlen Sie zuerst einen Benutzer zum L√∂schen aus."); return; }

    benutzerliste = JSON.parse(localStorage.getItem("benutzerliste") || "[]");
    if (!Array.isArray(benutzerliste)) { benutzerliste = []; }
    if (!benutzerliste.includes(benutzernameZuLoeschen)) { zeigeWarnung(`Benutzer "${benutzernameZuLoeschen}" nicht in der Liste gefunden.`); return; }

    if (!confirm(`Soll der Benutzer "${benutzernameZuLoeschen}" WIRKLICH gel√∂scht werden? ALLE Notizen, die diesem Benutzer zugeordnet sind, werden ebenfalls gel√∂scht!`)) { return; }

    const index = benutzerliste.indexOf(benutzernameZuLoeschen);
    if (index > -1) {
        benutzerliste.splice(index, 1);
        localStorage.setItem("benutzerliste", JSON.stringify(benutzerliste));
        saveToOneDrive(); // Auto-Save Benutzerliste

        let ideen = JSON.parse(localStorage.getItem("ideen") || "[]");
        const ursprungsLaenge = ideen.length;
        ideen = ideen.filter(idee => idee.benutzer !== benutzernameZuLoeschen);
        const anzahlGeloeschterNotizen = ursprungsLaenge - ideen.length;

        if(anzahlGeloeschterNotizen > 0) {
            localStorage.setItem("ideen", JSON.stringify(ideen));
            saveToOneDrive(); // Auto-Save Ideenliste
             // Mandanten-Dropdown nur pr√ºfen, wenn Notizen gel√∂scht wurden
            const remainingMandanten = new Set(ideen.map(i => (i.mandantennummer || "").toLowerCase()).filter(m => m !== ""));
            const allOriginalMandanten = new Set(JSON.parse(localStorage.getItem("ideen") || "[]").map(i => (i.mandantennummer || "").toLowerCase()).filter(m => m !== "")); // Lese urspr√ºngliche nochmal
            let updateMandantenDropdown = false;
            allOriginalMandanten.forEach(mandant => { if (!remainingMandanten.has(mandant)) updateMandantenDropdown = true; });
            if (updateMandantenDropdown) aktualisiereMandantenFilterDropdown();
        }


        aktualisiereBenutzerDropdowns();
        if (filterBenutzerValue === benutzernameZuLoeschen) {
             filterBenutzerValue = "";
             document.getElementById("filterBenutzer").value = "";
        }
        if (bearbeiteId !== null && !ideen.some(idee => idee.id === bearbeiteId)) { abbrechenBearbeiten(); }
        if (beschreibungFuerId !== null && !ideen.some(idee => idee.id === beschreibungFuerId)) { beschreibungAbbrechen(); }

        zeigeWarnung(`Benutzer "${benutzernameZuLoeschen}" und ${anzahlGeloeschterNotizen} zugeordnete Notiz(en) erfolgreich gel√∂scht.`, 'success');
        zeigeIdeen();
        istGespeichert = true; // √Ñnderungen wurden gespeichert
    } else {
        zeigeWarnung(`Ein interner Fehler ist aufgetreten: Benutzer "${benutzernameZuLoeschen}" konnte nicht gefunden werden.`);
    }
}

// Funktion zum Aktualisieren der Benutzer-Dropdowns
function aktualisiereBenutzerDropdowns() { initialisiereBenutzer(); }

// Funktion zum Aktualisieren der Mandanten-Filter-Dropdowns
function aktualisiereMandantenFilterDropdown() {
    const ideen = JSON.parse(localStorage.getItem("ideen") || "[]");
    const mandantenSet = new Set(ideen.map(idee => (idee.mandantennummer || "").trim()).filter(mandant => mandant !== ""));
    const mandantenListe = Array.from(mandantenSet).sort();

    const filterMandantSelect = document.getElementById("filterMandant");
    const aktuellerFilterValue = filterMandantSelect.value;

    filterMandantSelect.innerHTML = '<option value="">üè¢ Alle Mandanten</option>';
    mandantenListe.forEach(mandant => { filterMandantSelect.add(new Option(mandant, mandant)); });

    if (aktuellerFilterValue && mandantenListe.includes(aktuellerFilterValue)) { // Nur setzen wenn noch vorhanden
        filterMandantSelect.value = aktuellerFilterValue;
        filterMandantValue = aktuellerFilterValue;
    } else {
        filterMandantSelect.value = ""; // Zur√ºcksetzen wenn nicht mehr vorhanden
        filterMandantValue = "";
    }
}

// --- NEUE Funktionen f√ºr Vorgangsnummer ---
function initialisiereVorgangsnummer() {
    const gespeichert = localStorage.getItem("naechsteVorgangsnummer");
    naechsteVorgangsnummer = gespeichert ? parseInt(gespeichert, 10) : 1;
    // Korrektur, falls ung√ºltiger Wert gespeichert wurde
    if (isNaN(naechsteVorgangsnummer) || naechsteVorgangsnummer < 1) {
         naechsteVorgangsnummer = 1;
         localStorage.setItem("naechsteVorgangsnummer", naechsteVorgangsnummer.toString());
    }
    zeigeNaechsteNummer();
}
function zeigeNaechsteNummer() {
    const anzeigeElement = document.getElementById("naechsteNummerAnzeige");
    if (anzeigeElement) {
        anzeigeElement.textContent = naechsteVorgangsnummer;
    }
}
// --- ENDE NEUE Funktionen ---


// Filterfunktionen
function filterNachMandant(){ filterMandantValue = document.getElementById("filterMandant").value; zeigeIdeen(); }
function filterNachBenutzer(){ filterBenutzerValue = document.getElementById("filterBenutzer").value; zeigeIdeen(); }
function setzePrioritaet(p){prioritaet=p;["prioHoch","prioMittel","prioNiedrig"].forEach(id=>document.getElementById(id).classList.remove("selected"));if(p)document.getElementById(`prio${p}`).classList.add("selected");istGespeichert=false;}

/* --- END BLOCK 4: Script Start, Variables & Initializers --- */
/* --- START BLOCK 5a: Save Idea Functions --- */

function speichereIdee(){
    const text = document.getElementById("ideeText").value.trim();
    if(!text) return zeigeWarnung("Titel ist erforderlich!");

    let dateien = [];
    const dateiInput = document.getElementById("dateien").files;
    if(dateiInput.length > 0){
         if(accessToken){
             zeigeWarnung("Lade Dateien auf OneDrive hoch...", 'info');
             Promise.all(Array.from(dateiInput).map(async file => ({
                 name: file.name, type: file.type, link: await uploadToOneDrive(file)
             })))
             .then(uploadedFiles => {
                 dateien = uploadedFiles.filter(f => f.link !== null);
                 if (bearbeiteId !== null) {
                      const originalIdeen = JSON.parse(localStorage.getItem("ideen") || "[]");
                      const ideeInBearbeitung = originalIdeen.find(item => item.id === bearbeiteId);
                      if (ideeInBearbeitung?.dateien) { dateien = dateien.concat(ideeInBearbeitung.dateien.filter(oldFile => oldFile.link)); }
                 }
                 zeigeWarnung("Dateiupload abgeschlossen.", 'success');
                 saveIdeeObjekt(text, dateien); // Ruft saveIdeeObjekt NACH dem Upload auf
             })
             .catch(e => { zeigeWarnung("Fehler beim Datei-Upload: " + e.message); saveIdeeObjekt(text, []); });
         } else {
             dateien = Array.from(dateiInput).map(file => ({
                 name: file.name, data: URL.createObjectURL(file), type: file.type, pfad: file.webkitRelativePath || file.name }));
              if (bearbeiteId !== null) {
                   const originalIdeen = JSON.parse(localStorage.getItem("ideen") || "[]");
                   const ideeInBearbeitung = originalIdeen.find(item => item.id === bearbeiteId);
                   if (ideeInBearbeitung?.dateien) { dateien = dateien.concat(ideeInBearbeitung.dateien); }
              }
             saveIdeeObjekt(text, dateien); // Ruft saveIdeeObjekt direkt auf
         }
    } else {
         if (bearbeiteId !== null) {
              const originalIdeen = JSON.parse(localStorage.getItem("ideen") || "[]");
              const ideeInBearbeitung = originalIdeen.find(item => item.id === bearbeiteId);
              if (ideeInBearbeitung?.dateien) { dateien = ideeInBearbeitung.dateien; }
         }
        saveIdeeObjekt(text, dateien); // Ruft saveIdeeObjekt direkt auf
    }
}

// Diese Funktion wird jetzt von speichereIdee aufgerufen, nachdem die Dateien verarbeitet wurden
function saveIdeeObjekt(text, dateien){
    let ideen = JSON.parse(localStorage.getItem("ideen") || "[]");
    const details = document.getElementById("ideeDetails").value;
    const kategorie = document.getElementById("kategorie").value;
    const mandantennummer = document.getElementById("mandantennummer").value.trim();
    const firmenname = document.getElementById("firmenname").value.trim();
    const benutzer = document.getElementById("benutzer").value;

    if (bearbeiteId !== null) {
        // Idee aktualisieren
        const ideeIndex = ideen.findIndex(item => item.id === bearbeiteId);
        if (ideeIndex !== -1) {
             const existingIdee = ideen[ideeIndex];
             ideen[ideeIndex] = {
                 id: bearbeiteId,
                 vorgangsnummer: existingIdee.vorgangsnummer, // Behalte vorhandene Nummer
                 text, details, kategorie, prioritaet, mandantennummer, firmenname, benutzer, dateien,
                 timestamp: existingIdee.timestamp, // Behalte alten Timestamp
                 erledigt: existingIdee.erledigt || false,
                 beschreibungen: existingIdee.beschreibungen || []
             };
             localStorage.setItem("ideen", JSON.stringify(ideen));
             bearbeiteId = null;
             document.getElementById("speichernBtn").textContent = "üíæ Speichern";
             document.getElementById("abbrechenBtn").style.display = "none";
        } else { zeigeWarnung("Fehler: Idee zur Aktualisierung nicht gefunden."); return; } // Fr√ºhzeitiger Ausstieg bei Fehler
    } else {
        // Neue Idee hinzuf√ºgen
        const aktuelleNummer = naechsteVorgangsnummer; // Nummer f√ºr DIESE Idee
        const neueIdee = {
            id: generateUUID(),
            vorgangsnummer: aktuelleNummer, // Nummer hier zuweisen
            text, details, kategorie, prioritaet, mandantennummer, firmenname, benutzer, dateien,
            timestamp: new Date().toISOString(),
            erledigt: false,
            beschreibungen: []
        };
        ideen.push(neueIdee);
        localStorage.setItem("ideen", JSON.stringify(ideen));

        // N√ÑCHSTE Nummer erh√∂hen und speichern
        naechsteVorgangsnummer++;
        localStorage.setItem("naechsteVorgangsnummer", naechsteVorgangsnummer.toString());
        zeigeNaechsteNummer(); // Anzeige aktualisieren
    }

    // Nach erfolgreichem Speichern (neu oder Update)
    aktualisiereMandantenFilterDropdown(); // Mandantenliste ggf. aktualisieren
    zeigeIdeen(); // Liste neu rendern
    // Formular leeren
    document.getElementById("ideeText").value = "";
    document.getElementById("ideeDetails").value = "";
    document.getElementById("mandantennummer").value = "";
    document.getElementById("firmenname").value = "";
    document.getElementById("dateien").value = "";
    document.getElementById("dateiVorschau").innerHTML = "";
    setzePrioritaet("");
    document.getElementById("benutzer").value = "";
    document.getElementById("kategorie").value = ""; // Kategorie auch zur√ºcksetzen
    istGespeichert = true; // Erfolgreich gespeichert
    saveToOneDrive(); // Auto-Save nach Speichern
}

/* --- END BLOCK 5a: Save Idea Functions --- */
/* --- START BLOCK 5b: Display Ideas Function --- */

function zeigeIdeen(){
    const fullIdeen = JSON.parse(localStorage.getItem("ideen") || "[]");
    let filteredIdeen = [...fullIdeen];

    const filterKategorie = document.getElementById("filterKategorie").value;
    if(filterKategorie) filteredIdeen = filteredIdeen.filter(i => i.kategorie === filterKategorie);
    filterMandantValue = document.getElementById("filterMandant").value;
    if(filterMandantValue) { filteredIdeen = filteredIdeen.filter(i => (i.mandantennummer||"").toLowerCase() === filterMandantValue.toLowerCase()); }
    filterBenutzerValue = document.getElementById("filterBenutzer").value;
    if(filterBenutzerValue) { filteredIdeen = filteredIdeen.filter(i => (i.benutzer||"").toLowerCase() === filterBenutzerValue.toLowerCase()); }

    const filterArchivValue = document.getElementById("filterArchiv").value;
    if (filterArchivValue === "nicht_erledigt") { filteredIdeen = filteredIdeen.filter(i => !(i.erledigt || false)); }
    else if (filterArchivValue === "erledigt") { filteredIdeen = filteredIdeen.filter(i => (i.erledigt || false)); }

    const sortierung = document.getElementById("sortierung").value;
    if (sortierung !== "standard") {
        filteredIdeen.sort((a,b)=>{
            if(sortierung==="prio"){ const p={"Hoch":3,"Mittel":2,"Niedrig":1}; return (p[b.prioritaet]||0) - (p[a.prioritaet]||0); }
            let timeA = 0, timeB = 0; // Default f√ºr ung√ºltige Daten
             try { timeA = new Date(a.timestamp).getTime(); if(isNaN(timeA)) timeA = (sortierung === "neu" ? 0 : Infinity);} catch(e){ timeA = (sortierung === "neu" ? 0 : Infinity); }
             try { timeB = new Date(b.timestamp).getTime(); if(isNaN(timeB)) timeB = (sortierung === "neu" ? 0 : Infinity);} catch(e){ timeB = (sortierung === "neu" ? 0 : Infinity); }
            if(sortierung==="neu"){ return timeB - timeA; }
            if(sortierung==="alt"){ return timeA - timeB; }
            return 0; // Default f√ºr unbekannte Sortierung
        });
    }

    const ideenListeDiv = document.getElementById("ideenListe");
    ideenListeDiv.innerHTML = filteredIdeen.map(idee => {
        const ideeId = idee.id;
        const erledigt = idee.erledigt || false;
        let datumText = "Ung√ºltiges Datum";
        if (idee.timestamp) {
            let ts = idee.timestamp;
            if (typeof ts === 'string' && ts.includes('_')) { ts = ts.split('_')[0]; }
            try { const d = new Date(ts); if (!isNaN(d.getTime())) { datumText = d.toLocaleString("de-DE"); }} catch(e){}
        }

        // --- NEU: Vorgangsnummer anzeigen ---
        const vorgangsnummerHtml = idee.vorgangsnummer ? `<div class="vorgangsnummer-anzeige-liste">Vorgang: <b>${idee.vorgangsnummer}</b></div>` : '';
        // --- ENDE NEU ---

        return`<div class="idee${erledigt?' erledigt':''}"><div class="idee-content">${vorgangsnummerHtml}<h3>${idee.text}</h3><p>${idee.details||""}</p>${idee.benutzer?`<div>Zust√§ndig: <b>${idee.benutzer}</b></div>`:""}${idee.mandantennummer?`<div>Mandantennummer: <b>${idee.mandantennummer}</b></div>`:""}${idee.firmenname?`<div>Firmenname: <b>${idee.firmenname}</b></div>`:""}${idee.beschreibungen&&idee.beschreibungen.length?`<div class="beschreibung-historie"><b>Weitere Beschreibungen:</b>${idee.beschreibungen.map(b=>{
             let beschrTimestampText = "Ung√ºltiges Datum";
            if (b.timestamp) {
                 let bts = b.timestamp;
                 if (typeof bts === 'string' && bts.includes('_')) { bts = bts.split('_')[0]; }
                 try{ const bd = new Date(bts); if (!isNaN(bd.getTime())) { beschrTimestampText = bd.toLocaleString("de-DE"); }} catch(e){}
            }
            return `<div class="beschreibung-item"><div class="beschreibung-text-zeit"><span class="beschreibung-zeit">${beschrTimestampText}</span>${b.text}</div><button class="edit-beschreibung-btn" onclick="bearbeiteEinzelneBeschreibung('${ideeId}', '${b.timestamp}')">‚úèÔ∏è</button></div>`;
        }).join("")}</div>`:""}<small>${idee.kategorie||'Keine'} | ${idee.prioritaet||"Keine"} | ${datumText}</small>${idee.dateien?.map(file=>`<a class="datei-link" href="${file.link||file.data}" target="_blank">${file.link?'üåê':'üìé'} ${file.name}</a>${file.link?'<div class="datei-info">OneDrive-Link</div>':`<div class="datei-info">Pfad: <i>${file.pfad||file.name}</i></div>`}${file.type?.startsWith("image/")?`<img src="${file.link||file.data}" style="max-width:150px;">`:""}${file.type==="application/pdf"?`<iframe src="${file.link||file.data}" style="width:150px;height:100px;"></iframe>`:""}`).join("")}<div class="idee-actions"><button onclick="verschiebeIdee('${ideeId}',-1)">‚¨ÜÔ∏è</button><button onclick="verschiebeIdee('${ideeId}',1)">‚¨áÔ∏è</button><button onclick="bearbeiteIdee('${ideeId}')">‚úèÔ∏è</button><button onclick="toggleErledigt('${ideeId}')">${erledigt?"‚Ü©Ô∏è":"‚úîÔ∏è"}</button><button onclick="loescheIdee('${ideeId}')">üóëÔ∏è</button><button onclick="zeigeBeschreibungDialog('${ideeId}')">+ Beschreibung</button></div></div><input type="checkbox" class="idee-checkbox" onchange="toggleAuswahl('${ideeId}',this)" ${ausgewaehlt.includes(ideeId)?"checked":""}></div>`;
    }).join("");

    // UI-Updates bei Filterung
    if (bearbeiteId !== null && !filteredIdeen.some(idee => idee.id === bearbeiteId)) { abbrechenBearbeiten(); }
    if (beschreibungFuerId !== null && !filteredIdeen.some(idee => idee.id === beschreibungFuerId)) { beschreibungAbbrechen(); }
}

/* --- END BLOCK 5b: Display Ideas Function --- */
/* --- START BLOCK 5c: Individual Idea Actions --- */

function toggleErledigt(ideeId){
    let ideen = JSON.parse(localStorage.getItem("ideen")||"[]");
    const ideeIndex = ideen.findIndex(item => item.id === ideeId);
    if (ideeIndex !== -1) {
        ideen[ideeIndex].erledigt = !(ideen[ideeIndex].erledigt || false);
        localStorage.setItem("ideen", JSON.stringify(ideen));
        zeigeIdeen(); istGespeichert = false; saveToOneDrive(); }
}

function bearbeiteIdee(ideeId){
    const ideen = JSON.parse(localStorage.getItem("ideen")||"[]");
    const idee = ideen.find(item => item.id === ideeId);
    if (!idee) { zeigeWarnung("Fehler: Idee zum Bearbeiten nicht gefunden."); return; }

    document.getElementById("ideeText").value = idee.text;
    document.getElementById("ideeDetails").value = idee.details || "";
    document.getElementById("kategorie").value = idee.kategorie || ""; // Fallback auf Leerstring
    document.getElementById("mandantennummer").value = idee.mandantennummer || "";
    document.getElementById("firmenname").value = idee.firmenname || "";
    document.getElementById("benutzer").value = idee.benutzer || "";
    setzePrioritaet(idee.prioritaet || ""); // Setze Prio-Buttons

    bearbeiteId = ideeId;

    const dateiVorschauDiv = document.getElementById("dateiVorschau");
    dateiVorschauDiv.innerHTML = "";
     if (idee.dateien) {
         idee.dateien.forEach(file => {
             const fileUrl = file.link || file.data;
             if (fileUrl) { dateiVorschauDiv.innerHTML += `<a class="datei-link" href="${fileUrl}" target="_blank">${file.link ? 'üåê' : 'üìé'} ${file.name}</a>...`; } // Gek√ºrzt f√ºr Lesbarkeit
         });
     }
    document.getElementById("speichernBtn").textContent = "üíæ Aktualisieren";
    document.getElementById("abbrechenBtn").style.display = "";
    istGespeichert = false;
}

function abbrechenBearbeiten(){
    bearbeiteId = null;
    document.getElementById("ideeText").value = "";
    document.getElementById("ideeDetails").value = "";
    document.getElementById("mandantennummer").value = "";
    document.getElementById("firmenname").value = "";
    document.getElementById("dateien").value = "";
    document.getElementById("dateiVorschau").innerHTML = "";
    document.getElementById("speichernBtn").textContent = "üíæ Speichern";
    document.getElementById("abbrechenBtn").style.display = "none";
    setzePrioritaet("");
    document.getElementById("benutzer").value = "";
    document.getElementById("kategorie").value = "";
    istGespeichert = true; // Keine ungespeicherten √Ñnderungen mehr im Formular
}

function verschiebeIdee(ideeId, richtung){
    let fullIdeen = JSON.parse(localStorage.getItem("ideen")||"[]");
    // Filter/Sortierungswerte aus UI holen
    const filterKategorieValue = document.getElementById("filterKategorie").value;
    const filterMandantValue = document.getElementById("filterMandant").value;
    const filterBenutzerValue = document.getElementById("filterBenutzer").value;
    const filterArchivValue = document.getElementById("filterArchiv").value;
    const sortierung = document.getElementById("sortierung").value;

    // Aktuelle gefilterte/sortierte Ansicht simulieren
    let currentViewIdeen = [...fullIdeen];
    if(filterKategorieValue) currentViewIdeen = currentViewIdeen.filter(i => i.kategorie === filterKategorieValue);
    if(filterMandantValue) currentViewIdeen = currentViewIdeen.filter(i => (i.mandantennummer||"").toLowerCase() === filterMandantValue.toLowerCase());
    if(filterBenutzerValue) currentViewIdeen = currentViewIdeen.filter(i => (i.benutzer||"").toLowerCase() === filterBenutzerValue.toLowerCase());
    if (filterArchivValue === "nicht_erledigt") { currentViewIdeen = currentViewIdeen.filter(i => !(i.erledigt || false)); }
    else if (filterArchivValue === "erledigt") { currentViewIdeen = currentViewIdeen.filter(i => (i.erledigt || false)); }
    if (sortierung !== "standard") { /* ... Sortierlogik wie in zeigeIdeen ... */ }

    const currentViewPos = currentViewIdeen.findIndex(item => item.id === ideeId);
    if (currentViewPos === -1) { return; } // Nicht in aktueller Ansicht

    const targetViewPos = currentViewPos + richtung;
    if (targetViewPos >= 0 && targetViewPos < currentViewIdeen.length) {
        const targetIdeeId = currentViewIdeen[targetViewPos].id;
        const originalSourceIdx = fullIdeen.findIndex(item => item.id === ideeId);
        const originalTargetIdx = fullIdeen.findIndex(item => item.id === targetIdeeId);
        if (originalSourceIdx !== -1 && originalTargetIdx !== -1) {
            [fullIdeen[originalSourceIdx], fullIdeen[originalTargetIdx]] = [fullIdeen[originalTargetIdx], fullIdeen[originalSourceIdx]];
            localStorage.setItem("ideen", JSON.stringify(fullIdeen));
            zeigeIdeen(); istGespeichert = false; saveToOneDrive();
        } else { zeigeWarnung("Interner Fehler beim Verschieben."); }
    }
}

function loescheIdee(ideeId){
    if(!confirm("Wirklich l√∂schen?")) return;
    let ideen = JSON.parse(localStorage.getItem("ideen")||"[]");
    const ideeIndex = ideen.findIndex(item => item.id === ideeId);
    if (ideeIndex !== -1) {
        const deletedIdee = ideen[ideeIndex];
        ideen.splice(ideeIndex, 1);
        localStorage.setItem("ideen", JSON.stringify(ideen));
        const mandantExistsElsewhere = ideen.some(i => i.mandantennummer && (i.mandantennummer || "").toLowerCase() === (deletedIdee.mandantennummer || "").toLowerCase());
        const benutzerExistsElsewhere = ideen.some(i => i.benutzer && (i.benutzer || "").toLowerCase() === (deletedIdee.benutzer || "").toLowerCase());
        if (!mandantExistsElsewhere && deletedIdee.mandantennummer) { aktualisiereMandantenFilterDropdown(); }
        if (!benutzerExistsElsewhere && deletedIdee.benutzer) { aktualisiereBenutzerDropdowns(); }
        ausgewaehlt = ausgewaehlt.filter(id => id !== ideeId);
        if (bearbeiteId === ideeId) { abbrechenBearbeiten(); }
        if (beschreibungFuerId === ideeId) { beschreibungAbbrechen(); }
        zeigeIdeen(); istGespeichert = true; saveToOneDrive();
    } else { zeigeWarnung("Fehler: Idee zum L√∂schen nicht gefunden."); }
}

/* --- END BLOCK 5c: Individual Idea Actions --- */
/* --- START BLOCK 5d: Descriptions, Selection & User Management --- */

function zeigeBeschreibungDialog(ideeId, descTimestamp = null){
    beschreibungFuerId = ideeId; beschreibungZuBearbeitenderTimestamp = descTimestamp;
    const beschreibungTextarea = document.getElementById("beschreibungText");
    if (descTimestamp !== null) {
         const ideen = JSON.parse(localStorage.getItem("ideen") || "[]");
         const idee = ideen.find(item => item.id === ideeId);
         const beschreibung = idee?.beschreibungen.find(b => b.timestamp === descTimestamp);
         if (beschreibung) { beschreibungTextarea.value = beschreibung.text; }
         else { zeigeWarnung("Fehler: Beschreibung zum Bearbeiten nicht gefunden."); beschreibungAbbrechen(); return; }
    } else { beschreibungTextarea.value = ""; }
    document.getElementById("beschreibungDialog").style.display = "block";
    beschreibungTextarea.focus(); istGespeichert = false;
}

function beschreibungAbbrechen(){
    document.getElementById("beschreibungDialog").style.display = "none";
    beschreibungFuerId = null; beschreibungZuBearbeitenderTimestamp = null;
    document.getElementById("beschreibungText").value = "";
}

function beschreibungSpeichern(){
    const t = document.getElementById("beschreibungText").value.trim();
    if(!t) return;
    let ideen = JSON.parse(localStorage.getItem("ideen") || "[]");
    const ideeIndex = ideen.findIndex(item => item.id === beschreibungFuerId);
    if (ideeIndex !== -1) {
         if (beschreibungZuBearbeitenderTimestamp !== null) { // Bearbeiten
              const beschreibungIndex = ideen[ideeIndex].beschreibungen.findIndex(b => b.timestamp === beschreibungZuBearbeitenderTimestamp);
              if (beschreibungIndex !== -1) { ideen[ideeIndex].beschreibungen[beschreibungIndex].text = t; }
              else { zeigeWarnung("Fehler: Beschreibungseintrag zum Bearbeiten nicht gefunden."); }
         } else { // Hinzuf√ºgen
              const timestamp = new Date().toISOString() + '_' + Math.random().toString(36).substr(2, 9);
              if(!ideen[ideeIndex].beschreibungen) ideen[ideeIndex].beschreibungen = [];
              ideen[ideeIndex].beschreibungen.push({ text: t, timestamp: timestamp });
         }
         localStorage.setItem("ideen", JSON.stringify(ideen));
         zeigeIdeen();
    } else { zeigeWarnung("Fehler: Idee f√ºr Beschreibung nicht gefunden."); }
    beschreibungAbbrechen(); istGespeichert = true; saveToOneDrive();
}

function bearbeiteEinzelneBeschreibung(ideeId, descTimestamp) {
    if (descTimestamp) { zeigeBeschreibungDialog(ideeId, descTimestamp); }
    else { zeigeWarnung("Interner Fehler: Timestamp f√ºr Bearbeitung fehlt."); }
}

function toggleAuswahl(ideeId,box){
    if(box.checked){ if(!ausgewaehlt.includes(ideeId)) ausgewaehlt.push(ideeId); }
    else { ausgewaehlt = ausgewaehlt.filter(id => id !== ideeId); }
}

function ausgewaehlteNotizenLoeschen(){
    if(ausgewaehlt.length === 0) { zeigeWarnung("Keine Notizen ausgew√§hlt."); return; }
    if(!confirm(`Wirklich ${ausgewaehlt.length} ausgew√§hlte Notiz(en) l√∂schen?`)) return;
    let ideen = JSON.parse(localStorage.getItem("ideen")||"[]");
    const deletedMandanten = new Set(); const deletedBenutzer = new Set();
    ideen.filter(item => ausgewaehlt.includes(item.id)).forEach(item => {
        if (item.mandantennummer) deletedMandanten.add((item.mandantennummer).toLowerCase());
        if (item.benutzer) deletedBenutzer.add((item.benutzer).toLowerCase()); });
    const neueIdeenListe = ideen.filter(item => !ausgewaehlt.includes(item.id));
    localStorage.setItem("ideen", JSON.stringify(neueIdeenListe));
    const remainingMandanten = new Set(neueIdeenListe.map(i => (i.mandantennummer || "").toLowerCase()).filter(m => m !== ""));
    const remainingBenutzer = new Set(neueIdeenListe.map(i => (i.benutzer || "").toLowerCase()).filter(b => b !== ""));
    let updateMandanten = false; deletedMandanten.forEach(m => { if (!remainingMandanten.has(m)) updateMandanten = true; });
    let updateBenutzer = false; deletedBenutzer.forEach(b => { if (!remainingBenutzer.has(b)) updateBenutzer = true; });
    if (updateMandanten) aktualisiereMandantenFilterDropdown();
    if (updateBenutzer) aktualisiereBenutzerDropdowns();
    if (bearbeiteId !== null && ausgewaehlt.includes(bearbeiteId)) { abbrechenBearbeiten(); }
    if (beschreibungFuerId !== null && ausgewaehlt.includes(beschreibungFuerId)) { beschreibungAbbrechen(); }
    ausgewaehlt = []; zeigeIdeen(); istGespeichert = true; saveToOneDrive();
}

function alleIdeenLoeschen(){
    if(!confirm("Wirklich ALLE Ideen l√∂schen?"))return;
    localStorage.setItem("ideen","[]");
    aktualisiereMandantenFilterDropdown(); aktualisiereBenutzerDropdowns();
    ausgewaehlt=[]; bearbeiteId = null; beschreibungFuerId = null; beschreibungZuBearbeitenderTimestamp = null;
    zeigeIdeen(); abbrechenBearbeiten(); istGespeichert=true;
    // Vorgangsnummer Z√§hler zur√ºcksetzen? Entscheidung: Ja.
    naechsteVorgangsnummer = 1;
    localStorage.setItem("naechsteVorgangsnummer", "1");
    zeigeNaechsteNummer();
    // --- Ende Reset Vorgangsnummer ---
    saveToOneDrive();
}

/* --- END BLOCK 5d: Descriptions, Selection & User Management --- */
/* --- START BLOCK 6: Export Functions --- */

function getExportIdeen(){
    let ideen = JSON.parse(localStorage.getItem("ideen")||"[]");
    if(ausgewaehlt.length > 0){ return ideen.filter(item => ausgewaehlt.includes(item.id)); }
    // Filter/Sortierung f√ºr Export anwenden
    const filterKategorie = document.getElementById("filterKategorie").value;
    const filterMandant = document.getElementById("filterMandant").value;
    const filterBenutzer = document.getElementById("filterBenutzer").value;
    const filterArchivValue = document.getElementById("filterArchiv").value;
    const sortierung = document.getElementById("sortierung").value;
    let exportIdeen = [...ideen];
    if(filterKategorie) exportIdeen = exportIdeen.filter(i => i.kategorie === filterKategorie);
    if(filterMandant) exportIdeen = exportIdeen.filter(i => (i.mandantennummer||"").toLowerCase() === filterMandant.toLowerCase());
    if(filterBenutzer) exportIdeen = exportIdeen.filter(i => (i.benutzer||"").toLowerCase() === filterBenutzer.toLowerCase());
    if (filterArchivValue === "nicht_erledigt") { exportIdeen = exportIdeen.filter(i => !(i.erledigt || false)); }
    else if (filterArchivValue === "erledigt") { exportIdeen = exportIdeen.filter(i => (i.erledigt || false)); }
    if (sortierung !== "standard") { /* ... Sortierlogik wie in zeigeIdeen ... */ }
    return exportIdeen;
}


function exportiereAlsPDF(){const{jsPDF}=window.jspdf;const doc=new jsPDF();const margin=15;const pageHeight=doc.internal.pageSize.getHeight();let y=margin;const ideen=getExportIdeen();ideen.forEach((idee,idx)=>{
    const titel=`${idee.vorgangsnummer ? `[Vorgang ${idee.vorgangsnummer}] ` : ''}${idee.text}${idee.benutzer ? ` (Zust.: ${idee.benutzer})` : ''}`; // Vorgangsnummer im Titel
    const titelLines=doc.splitTextToSize(titel,180);doc.setFontSize(12); titelLines.forEach(line=>{if(y+7>pageHeight-margin){doc.addPage();y=margin;}doc.text(line,margin,y);y+=7;});
    const metaLines = [];
    metaLines.push(`Kat.: ${idee.kategorie||'-'}`);
    // if(idee.benutzer) metaLines.push(`Zust.: ${idee.benutzer}`); // Bereits im Titel
    metaLines.push(`Prio: ${idee.prioritaet||"-"}`);
    let datumTextPDF = "-"; if (idee.timestamp) { let ts=idee.timestamp; if(typeof ts==='string'&&ts.includes('_')){ts=ts.split('_')[0];} try{const d=new Date(ts); if(!isNaN(d.getTime())){datumTextPDF=d.toLocaleString("de-DE");}}catch(e){} } metaLines.push(`Datum: ${datumTextPDF}`);
    if(idee.mandantennummer) metaLines.push(`Mandant: ${idee.mandantennummer}`); if(idee.firmenname) metaLines.push(`Firma: ${idee.firmenname}`);
    doc.setFontSize(10); metaLines.forEach(text=>{if(y+6>pageHeight-margin){doc.addPage();y=margin;}doc.text(text,margin,y);y+=6;});
    if(idee.details){ doc.setFontSize(10); const detailLines=doc.splitTextToSize(idee.details,180); detailLines.forEach(line=>{if(y+6>pageHeight-margin){doc.addPage();y=margin;}doc.text(line,margin,y);y+=6;}); }
    if(idee.beschreibungen&&idee.beschreibungen.length){ doc.setFontSize(10); doc.text("Weitere Beschreibungen:",margin,y); y+=6; idee.beschreibungen.forEach(b=>{ let btsText="-"; if(b.timestamp){let bts=b.timestamp; if(typeof bts==='string'&&bts.includes('_')){bts=bts.split('_')[0];} try{const bd=new Date(bts); if(!isNaN(bd.getTime())){btsText=bd.toLocaleString("de-DE");}}catch(e){}} const beschr=`[${btsText}] ${b.text}`; const lines=doc.splitTextToSize(beschr,180); lines.forEach(line=>{if(y+6>pageHeight-margin){doc.addPage();y=margin;}doc.text(line,margin,y);y+=6;}); }); }
    if(idee.dateien?.length > 0){ doc.setFontSize(10); doc.text("Anh√§nge:", margin, y); y += 6; idee.dateien.forEach(file=>{ if(y+6>pageHeight-margin){doc.addPage();y=margin; doc.setFontSize(10); doc.text("Anh√§nge:", margin, y); y+=6;} doc.setTextColor(0,0,255); const linkText = `üåê ${file.name}`; if (doc.textWithLink) { doc.textWithLink(linkText, margin, y, { url: file.link || file.data }); } else { doc.text(linkText, margin, y); } doc.setTextColor(0,0,0); y+=6; }); }
    y+=10; if(y>pageHeight-margin && idx < ideen.length - 1){doc.addPage();y=margin;}});doc.save("ideen-export.pdf");}

function exportiereAlsText(){const ideen=getExportIdeen();const text=ideen.map(idee=>{
    let datumTextTXT = "-"; if (idee.timestamp) { let ts=idee.timestamp; if(typeof ts==='string'&&ts.includes('_')){ts=ts.split('_')[0];} try{const d=new Date(ts); if(!isNaN(d.getTime())){datumTextTXT=d.toLocaleString("de-DE");}}catch(e){} }
    return (
    `=== ${idee.vorgangsnummer ? `[Vorgang ${idee.vorgangsnummer}] ` : ''}${idee.text} ===\n` + // Vorgangsnummer
    `Kategorie: ${idee.kategorie||'-'}\n` +
    `${idee.benutzer?`Zust√§ndig: ${idee.benutzer}\n`:""}` +
    `Priorit√§t: ${idee.prioritaet||"-"}\n` +
    `Datum: ${datumTextTXT}\n` +
    `${idee.mandantennummer?"Mandantennummer: "+idee.mandantennummer+"\n":""}` +
    `${idee.firmenname?"Firmenname: "+idee.firmenname+"\n":""}` +
    `${idee.details?`Beschreibung: ${idee.details}\n`:""}` +
    `${idee.beschreibungen&&idee.beschreibungen.length?`Weitere Beschreibungen:\n${idee.beschreibungen.map(b=>{ let btsText="-"; if(b.timestamp){let bts=b.timestamp; if(typeof bts==='string'&&bts.includes('_')){bts=bts.split('_')[0];} try{const bd=new Date(bts); if(!isNaN(bd.getTime())){btsText=bd.toLocaleString("de-DE");}}catch(e){}} return `  - [${btsText}] ${b.text}`; }).join("\n")}\n`:""}` +
    `Anh√§nge: ${idee.dateien?.map(f=>f.name).join(", ")||"Keine"}\n`
    );
}).join("\n\n");const blob=new Blob([text],{type:"text/plain"});const url=URL.createObjectURL(blob);const link=document.createElement("a");link.href=url;link.download="ideen-export.txt";link.click();URL.revokeObjectURL(url);}

// Funktion zum Teilen per E-Mail (NUR mit Dateinamen in Anh√§ngen)
async function teilePerEmail(){
    if(ausgewaehlt.length === 0) { zeigeWarnung("Bitte w√§hlen Sie Notizen f√ºr den Export aus."); return; }
    const recipientInput = prompt("An wen soll exportiert werden? Geben Sie eine E-Mail-Adresse ein oder w√§hlen Sie eine Option: 'ich', 'mandant', 'support', oder 'andere (variable Eingabe)'");
    let recipientInfo = recipientInput ? recipientInput.trim().toLowerCase() : "";
    if (!recipientInfo) { zeigeWarnung("Export abgebrochen: Kein Empf√§nger angegeben."); return; }
    if (!["ich", "mandant", "support"].includes(recipientInfo) && recipientInfo !== "andere" && !recipientInfo.startsWith("andere:")) { recipientInfo = `Direkte Eingabe: ${recipientInput.trim()}`;
    } else if (recipientInfo === "andere") { const other = prompt("Bitte geben Sie Info f√ºr 'andere' an:"); if (!other?.trim()) { zeigeWarnung("Export abgebrochen."); return; } recipientInfo = `Andere: ${other.trim()}`; }

    let ideen = JSON.parse(localStorage.getItem("ideen") || "[]"); let changed = false;
    ideen.forEach(idee => { if (ausgewaehlt.includes(idee.id)) { const desc = `Weitergeleitet via E-Mail an: ${recipientInfo} am ${new Date().toLocaleString("de-DE")}`; if (!idee.beschreibungen) {idee.beschreibungen = [];} const ts = new Date().toISOString() + '_' + Math.random().toString(36).substr(2, 9); idee.beschreibungen.push({ text: desc, timestamp: ts }); changed = true; }});
    if (changed) { localStorage.setItem("ideen", JSON.stringify(ideen)); zeigeIdeen(); istGespeichert = false; await saveToOneDrive(); }

    const ideenToExport = getExportIdeen();
    const text = ideenToExport.map(idee => {
        let datumTextEmail="-"; if(idee.timestamp){let ts=idee.timestamp; if(typeof ts==='string'&&ts.includes('_')){ts=ts.split('_')[0];} try{const d=new Date(ts); if(!isNaN(d.getTime())){datumTextEmail=d.toLocaleString("de-DE");}}catch(e){}}
        return (
            `*${idee.vorgangsnummer ? `[Vorgang ${idee.vorgangsnummer}] ` : ''}${idee.text}*\n` + // Vorgangsnummer
            `Kategorie: ${idee.kategorie||'-'}\n` + `${idee.benutzer?`Zust√§ndig: ${idee.benutzer}\n`:""}` + `Priorit√§t: ${idee.prioritaet||"-"}\n` + `Datum: ${datumTextEmail}\n` +
            `${idee.mandantennummer?"Mandant: "+idee.mandantennummer+"\n":""}` + `${idee.firmenname?"Firma: "+idee.firmenname+"\n":""}` + `${idee.details?`Beschreibung: ${idee.details}\n`:""}` +
            `${idee.beschreibungen&&idee.beschreibungen.length?`Weitere Beschreibungen:\n${idee.beschreibungen.map(b=>{ let btsText="-"; if(b.timestamp){let bts=b.timestamp; if(typeof bts==='string'&&bts.includes('_')){bts=bts.split('_')[0];} try{const bd=new Date(bts); if(!isNaN(bd.getTime())){btsText=bd.toLocaleString("de-DE");}}catch(e){}} return `  - [${btsText}] ${b.text}`; }).join("\n")}\n`:""}` +
            `\nAnh√§nge: ${idee.dateien?.map(f => f.name).join(", ") || "Keine"}\n` // Nur Namen
        ); }).join("\n\n")+"\n\n[Bitte Anh√§nge manuell hinzuf√ºgen]";
    const emailSubject = encodeURIComponent("Ideen-Export"); const emailBody = encodeURIComponent(text);
    const finalRecipient = recipientInput.includes('@') ? encodeURIComponent(recipientInput.trim()) : '';
    const mailtoLink = `mailto:${finalRecipient}?subject=${emailSubject}&body=${emailBody}`;
    try { window.location.href = mailtoLink; } catch (e) { console.error("Mailto Fehler:", e); zeigeWarnung("Fehler beim √ñffnen des Mail-Programms: " + e.message); }
    ausgewaehlt = []; zeigeIdeen(); // Checkboxen zur√ºcksetzen
}

// Funktion zum Teilen per WhatsApp (UNVER√ÑNDERT bez√ºglich Links)
async function teilePerWhatsApp(){
     if(ausgewaehlt.length === 0) { zeigeWarnung("Bitte w√§hlen Sie Notizen f√ºr den Export aus."); return; }
     const recipientInput = prompt("An wen soll exportiert werden? Info oder 'ich', 'mandant', 'support', 'andere'");
     let recipientInfo = recipientInput ? recipientInput.trim().toLowerCase() : "";
     if (!recipientInfo) { zeigeWarnung("Export abgebrochen."); return; }
     if (!["ich", "mandant", "support"].includes(recipientInfo) && recipientInfo !== "andere" && !recipientInfo.startsWith("andere:")) { recipientInfo = `Direkte Eingabe: ${recipientInput.trim()}`;
     } else if (recipientInfo === "andere") { const other=prompt("Info f√ºr 'andere'?"); if (!other?.trim()){zeigeWarnung("Abgebrochen."); return;} recipientInfo = `Andere: ${other.trim()}`; }

     let ideen = JSON.parse(localStorage.getItem("ideen") || "[]"); let changed = false;
     ideen.forEach(idee => { if (ausgewaehlt.includes(idee.id)) { const desc = `Weitergeleitet via WhatsApp an: ${recipientInfo} am ${new Date().toLocaleString("de-DE")}`; if (!idee.beschreibungen){idee.beschreibungen = [];} const ts = new Date().toISOString() + '_' + Math.random().toString(36).substr(2, 9); idee.beschreibungen.push({ text: desc, timestamp: ts }); changed = true; }});
     if (changed) { localStorage.setItem("ideen", JSON.stringify(ideen)); zeigeIdeen(); istGespeichert = false; await saveToOneDrive(); }

     const ideenToExport = getExportIdeen();
     const text = ideenToExport.map(idee => {
         let datumTextWA="-"; if(idee.timestamp){let ts=idee.timestamp; if(typeof ts==='string'&&ts.includes('_')){ts=ts.split('_')[0];} try{const d=new Date(ts); if(!isNaN(d.getTime())){datumTextWA=d.toLocaleString("de-DE");}}catch(e){}}
         return ( `*${idee.vorgangsnummer ? `[Vorgang ${idee.vorgangsnummer}] ` : ''}${idee.text}*\n` + // Vorgangsnummer
         `üìÅ Kat.: ${idee.kategorie||'-'}\n` + `${idee.benutzer?`üßë‚Äçüíª Zust.: ${idee.benutzer}\n`:""}` + `üîñ Prio: ${idee.prioritaet||"-"}\n` + `üìÖ ${datumTextWA}\n` +
         `${idee.details?`üìù ${idee.details}\n`:""}` + `${idee.mandantennummer?`Mandant: ${idee.mandantennummer}\n`:""}` + `${idee.firmenname?`Firma: ${idee.firmenname}\n`:""}` +
         `${idee.beschreibungen&&idee.beschreibungen.length?`Weitere Beschreibungen:\n${idee.beschreibungen.map(b=>{ let btsText="-"; if(b.timestamp){let bts=b.timestamp; if(typeof bts==='string'&&bts.includes('_')){bts=bts.split('_')[0];} try{const bd=new Date(bts); if(!isNaN(bd.getTime())){btsText=bd.toLocaleString("de-DE");}}catch(e){}} return `  - [${btsText}] ${b.text}`; }).join("\n")}\n`:""}` +
         `üìé Anh√§nge: ${idee.dateien?.map(f=>`${f.name} (${f.link||f.data||'Kein Link'})`).join(", ")||"Keine"}\n` ); // Links bleiben hier drin
     }).join("\n\n");
     try { window.open(`https://wa.me/?text=${encodeURIComponent(text)}`,"_blank"); } catch (e) { console.error("WhatsApp Fehler:", e); zeigeWarnung("Fehler beim √ñffnen von WhatsApp: " + e.message); }
     ausgewaehlt = []; zeigeIdeen();
}

/* --- END BLOCK 6: Export Functions --- */
/* --- START BLOCK 7: OneDrive & Local File Functions --- */

async function uploadToOneDrive(f){if(!accessToken){zeigeWarnung("Bitte zuerst mit Microsoft anmelden!");return null;}try{const n=`ideenapp/${Date.now()}_${f.name}`;const u=await fetch(`https://graph.microsoft.com/v1.0/me/drive/root:/${n}:/content`,{method:"PUT",headers:{"Authorization":`Bearer ${accessToken}`,"Content-Type":f.type},body:f});const d=await u.json();if(!u.ok){throw new Error(`OneDrive Upload Error ${u.status}: ${d?.error?.message||'Unknown'}`);}const s=await fetch(`https://graph.microsoft.com/v1.0/me/drive/items/${d.id}/createLink`,{method:"POST",headers:{"Authorization":`Bearer ${accessToken}`,"Content-Type":"application/json"},body:JSON.stringify({type:"view",scope:"anonymous"})});const j=await s.json();if(!s.ok){throw new Error(`OneDrive Link Error ${s.status}: ${j?.error?.message||'Unknown'}`);}return j.link.webUrl;}catch(e){console.error("OneDrive Upload/Link Fehler:",e);zeigeWarnung("OneDrive-Fehler: "+e.message);return null;}}
async function saveToOneDrive(){ if(!accessToken){ console.log("OneDrive-Speicherung √ºbersprungen: nicht angemeldet."); return; } try { const ideen=JSON.parse(localStorage.getItem("ideen")||"[]"); const benutzer=JSON.parse(localStorage.getItem("benutzerliste")||"[]"); const kategorien=JSON.parse(localStorage.getItem("kategorien")||"[]"); const nummer=localStorage.getItem("naechsteVorgangsnummer")||"1"; const data={ideen,benutzerliste:benutzer,kategorien,naechsteVorgangsnummer:nummer}; const dataStr=JSON.stringify(data,null,2); const path=(document.getElementById("onedrivePath").value.trim()||"/ideenapp/ideen.json"); const finalPath=path.startsWith('/')?path:'/'+path; if(!finalPath||finalPath==='/'){zeigeWarnung("OneDrive Speichern: Ung√ºltiger Pfad.");return;} const url=`https://graph.microsoft.com/v1.0/me/drive/root:${finalPath}:/content`; const res=await fetch(url,{method:"PUT",headers:{"Authorization":`Bearer ${accessToken}`,"Content-Type":"application/json"},body:dataStr}); if(res.ok){console.log(`OneDrive: Gespeichert in ${finalPath}.`);istGespeichert=true;}else{const err=await res.json().catch(()=>null); const msg=err?.error?.message||res.statusText; console.error(`OneDrive Speichern Fehler (${res.status}) f√ºr ${finalPath}: ${msg}`,err); zeigeWarnung(`OneDrive Speichern Fehler: ${msg}`);}}catch(e){console.error('OneDrive Speichern Exception:',e);zeigeWarnung("OneDrive Speichern Fehler: "+e.message);}}
async function loadFromOneDrive(){ if(!accessToken){ const ok=await handleLogin(); if(!ok||!accessToken){return;} } const path=(document.getElementById("onedrivePath").value.trim()||"/ideenapp/ideen.json"); const finalPath=path.startsWith('/')?path:'/'+path; if(!finalPath||finalPath==='/'){zeigeWarnung("OneDrive Laden: Ung√ºltiger Pfad.");return;} zeigeWarnung(`Lade Daten von OneDrive: ${finalPath}...`,'info'); try{ const url=`https://graph.microsoft.com/v1.0/me/drive/root:${finalPath}:/content`; const res=await fetch(url,{method:"GET",headers:{"Authorization":`Bearer ${accessToken}`}}); if(res.ok){ const content=await res.text(); const loadedData=JSON.parse(content); let ideen=[], benutzerliste=[], kategorienAusDatei=null, nummer=1; if(loadedData&&typeof loadedData==='object'&&Array.isArray(loadedData.ideen)){ ideen=loadedData.ideen; benutzerliste=Array.isArray(loadedData.benutzerliste)?loadedData.benutzerliste:[]; kategorienAusDatei=Array.isArray(loadedData.kategorien)?loadedData.kategorien:null; nummer=parseInt(loadedData.naechsteVorgangsnummer,10)||1; }else if(Array.isArray(loadedData)){ideen=loadedData; benutzerliste=[]; kategorienAusDatei=null; nummer=1;}else{throw new Error("Ung√ºltiges Dateiformat");} localStorage.setItem("ideen",JSON.stringify(ideen)); localStorage.setItem("benutzerliste",JSON.stringify(benutzerliste)); if(kategorienAusDatei!==null){localStorage.setItem("kategorien",JSON.stringify(kategorienAusDatei));} localStorage.setItem("naechsteVorgangsnummer", nummer.toString()); ausgewaehlt=[]; initialisiereKategorien(); initialisiereBenutzer(); initialisiereVorgangsnummer(); ensureIdeasHaveIds(); aktualisiereMandantenFilterDropdown(); zeigeIdeen(); zeigeWarnung(`Daten erfolgreich von OneDrive geladen! (${finalPath})`,'success'); istGespeichert=true; }else if(res.status===404){zeigeWarnung(`Datei nicht gefunden: ${finalPath}.`,'warning');}else{ const err=await res.json().catch(()=>null); const msg=err?.error?.message||res.statusText; console.error(`OneDrive Laden Fehler (${res.status}) f√ºr ${finalPath}: ${msg}`,err); zeigeWarnung(`OneDrive Laden Fehler (${res.status}): ${msg}`);}}catch(e){console.error('OneDrive Laden Exception:',e);zeigeWarnung("OneDrive Laden Fehler: "+e.message);}}
async function speichereIdeenAlsDatei(){try{ const ideen=JSON.parse(localStorage.getItem("ideen")||"[]"); const benutzer=JSON.parse(localStorage.getItem("benutzerliste")||"[]"); const kategorien=JSON.parse(localStorage.getItem("kategorien")||"[]"); const nummer=localStorage.getItem("naechsteVorgangsnummer")||"1"; const data={ideen,benutzerliste:benutzer,kategorien,naechsteVorgangsnummer:nummer}; const dataStr=JSON.stringify(data,null,2); if(window.showSaveFilePicker){fileHandle=await window.showSaveFilePicker({suggestedName:"ideen.json",types:[{description:"JSON",accept:{"application/json":[".json"]}}]}); const w=await fileHandle.createWritable(); await w.write(dataStr); await w.close(); zeigeWarnung("Datei gespeichert!",'success'); istGespeichert=true;}else{const blob=new Blob([dataStr],{type:"application/json"}); const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download="ideen.json"; a.click(); URL.revokeObjectURL(url); zeigeWarnung("Download gestartet.",'success'); istGespeichert=true;}}catch(e){if(e.name!=="AbortError")zeigeWarnung("Lokales Speichern Fehler: "+e.message);}}
async function ladeIdeenAusDatei(){try{ let fileContent; if(window.showOpenFilePicker){[fileHandle]=await window.showOpenFilePicker({types:[{description:"JSON",accept:{"application/json":[".json"]}}]}); const file=await fileHandle.getFile(); fileContent=await file.text();}else{const input=document.createElement('input'); input.type='file'; input.accept='.json'; await new Promise((resolve,reject)=>{input.onchange=async e=>{if(e.target.files&&e.target.files.length>0){const reader=new FileReader(); reader.onload=ev=>{fileContent=ev.target.result;resolve();}; reader.onerror=err=>reject(err); reader.readAsText(e.target.files[0]);}else{reject(new Error("No file"));}}; input.click();});} if(!fileContent){throw new Error("Kein Inhalt");} const loadedData=JSON.parse(fileContent); let ideen=[], benutzerliste=[], kategorienAusDatei=null, nummer=1; if(loadedData&&typeof loadedData==='object'&&Array.isArray(loadedData.ideen)){ ideen=loadedData.ideen; benutzerliste=Array.isArray(loadedData.benutzerliste)?loadedData.benutzerliste:[]; kategorienAusDatei=Array.isArray(loadedData.kategorien)?loadedData.kategorien:null; nummer=parseInt(loadedData.naechsteVorgangsnummer,10)||1; }else if(Array.isArray(loadedData)){ideen=loadedData; benutzerliste=[]; kategorienAusDatei=null; nummer=1;}else{throw new Error("Ung√ºltiges Format");} localStorage.setItem("ideen",JSON.stringify(ideen)); localStorage.setItem("benutzerliste",JSON.stringify(benutzerliste)); if(kategorienAusDatei!==null){localStorage.setItem("kategorien",JSON.stringify(kategorienAusDatei));} localStorage.setItem("naechsteVorgangsnummer", nummer.toString()); ausgewaehlt=[]; initialisiereKategorien(); initialisiereBenutzer(); initialisiereVorgangsnummer(); ensureIdeasHaveIds(); aktualisiereMandantenFilterDropdown(); zeigeIdeen(); zeigeWarnung(`Daten lokal geladen!`,'success'); istGespeichert=true;}catch(e){if(e.name!=="AbortError"&&e.message!=="No file"&&e.message!=="Kein Inhalt"){zeigeWarnung("Lokales Laden Fehler: "+e.message);}else{console.log("Lokales Laden abgebrochen.");}}}

/* --- END BLOCK 7: OneDrive & Local File Functions --- */
/* --- START BLOCK 8: Event Listeners & Initialization --- */

document.getElementById("ideeText").addEventListener("input",()=>{istGespeichert=false;});
document.getElementById("ideeDetails").addEventListener("input",()=>{istGespeichert=false;});
document.getElementById("mandantennummer").addEventListener("input",()=>{istGespeichert=false;});
document.getElementById("firmenname").addEventListener("input",()=>{istGespeichert=false;});
document.getElementById("kategorie").addEventListener("change",()=>{istGespeichert=false;});
document.getElementById("neueKategorie").addEventListener("input",()=>{istGespeichert=false;});
document.getElementById("benutzer").addEventListener("change",()=>{istGespeichert=false;});
document.getElementById("neuerBenutzer").addEventListener("input",()=>{istGespeichert=false;});
// Kein Listener f√ºr onedrivePath, da keine direkte Bearbeitung der Ideen

document.getElementById("dateien").addEventListener("change",function(e){const v=document.getElementById("dateiVorschau");v.innerHTML="";Array.from(e.target.files).forEach(file=>{const url=URL.createObjectURL(file);v.innerHTML+=`<a class="datei-link" href="${url}" target="_blank">üìÑ ${file.name}</a>...`;});istGespeichert=false;});
window.addEventListener("beforeunload",function(e){if(!istGespeichert){const msg="Ungespeicherte √Ñnderungen! Seite wirklich verlassen?";e.preventDefault();e.returnValue=msg;return msg;}});

// Funktion zur Migration und Validierung von Daten beim Laden (localStorage)
function ensureIdeasHaveIds() {
    let ideen = JSON.parse(localStorage.getItem("ideen") || "[]");
    let changed = false;
    if (!Array.isArray(ideen)) { ideen = []; changed = true; }

    ideen.forEach(idee => {
        if (!idee.id) { idee.id = generateUUID(); changed = true; }
        if (!Array.isArray(idee.beschreibungen)) { idee.beschreibungen = []; changed = true;
        } else if (idee.beschreibungen.length > 0 && typeof idee.beschreibungen[0] === 'string') {
             idee.beschreibungen = idee.beschreibungen.map(text => ({ text: text, timestamp: new Date().toISOString() + '_' + Math.random().toString(36).substr(2, 9) })); changed = true; }
        if (idee.benutzer === undefined) { idee.benutzer = ""; changed = true; }
        if (idee.mandantennummer === undefined) { idee.mandantennummer = ""; changed = true; }
        if (idee.firmenname === undefined) { idee.firmenname = ""; changed = true; }
        if (idee.erledigt === undefined) { idee.erledigt = false; changed = true; }
        // --- NEU: Vorgangsnummer hinzuf√ºgen/pr√ºfen ---
        if (idee.vorgangsnummer === undefined) { idee.vorgangsnummer = null; changed = true; } // Alten Notizen null zuweisen

        // Timestamp Validierung
        if (!idee.timestamp) { idee.timestamp = new Date().toISOString(); changed = true; }
        else { let ts=idee.timestamp; if(typeof ts==='string'&&ts.includes('_')){ts=ts.split('_')[0];} try{if(isNaN(new Date(ts).getTime())){idee.timestamp=new Date().toISOString(); changed=true;}}catch(e){idee.timestamp=new Date().toISOString(); changed=true;} }
        // Timestamp Validierung f√ºr Beschreibungen
        if (Array.isArray(idee.beschreibungen)) {
            idee.beschreibungen.forEach(b => { if (b && typeof b.text === 'string') { if (!b.timestamp) { b.timestamp = new Date().toISOString() + '_' + Math.random().toString(36).substr(2, 9); changed = true; } else { let bts = b.timestamp; let needsUpdate = false; if(typeof bts === 'string' && bts.includes('_')) { const dp = bts.split('_')[0]; try { if(isNaN(new Date(dp).getTime())) needsUpdate = true; } catch(e){ needsUpdate = true; } } else { try { if(isNaN(new Date(bts).getTime())) needsUpdate = true; } catch(e){ needsUpdate = true; } } if(needsUpdate) { b.timestamp = new Date().toISOString() + '_' + Math.random().toString(36).substr(2, 9); changed = true; console.warn("Invalid desc timestamp replaced", b); } } } });
            // Malformed Eintr√§ge filtern
            const initialLength = idee.beschreibungen.length;
            idee.beschreibungen = idee.beschreibungen.filter(b => b && typeof b.text === 'string' && b.timestamp);
            if (idee.beschreibungen.length < initialLength) { changed = true; console.log("Removed malformed description entries."); }
        }
    });

    if (changed) { console.log("Datenmigration angewendet."); localStorage.setItem("ideen", JSON.stringify(ideen)); }
    ausgewaehlt = []; // Auswahl immer zur√ºcksetzen bei Migration/Init
}


/* --- AUFRUFE DER INITIALISIERUNGSFUNKTIONEN BEIM LADEN DER SEITE START --- */
initialisiereKategorien();
initialisiereBenutzer();
initialisiereVorgangsnummer(); // NEU
ensureIdeasHaveIds(); // Pr√ºft/Migriert Ideen (inkl. Vorgangsnummer = null f√ºr alte)
aktualisiereMandantenFilterDropdown(); // Muss NACH ensureIdeasHaveIds aufgerufen werden
zeigeIdeen(); // Zeigt Ideen (inkl. Vorgangsnummer)
pruebeLoginHinweis();
/* --- AUFRUFE DER INITIALISIERUNGSFUNKTIONEN BEIM LADEN DER SEITE ENDE --- */

/* --- END BLOCK 8: Event Listeners & Initialization --- */
</script>
</body>
</html>