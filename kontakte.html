<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kontakte-Verwaltung (Master)</title>
    <!-- PDF-Export-Bibliothek & AutoTable Plugin -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <!-- Microsoft Authentication Library (MSAL) -->
    <script src="https://alcdn.msauth.net/browser/2.24.0/js/msal-browser.min.js"></script>
    
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; padding: 15px; background-color: #f4f7f6; margin: 0; }
        
        /* --- Top Bar & Cloud Styles --- */
        .app-header { background: white; padding: 15px; border-bottom: 1px solid #ddd; margin: -15px -15px 20px -15px; display: flex; flex-wrap: wrap; align-items: center; justify-content: space-between; gap: 10px; }
        .app-title { font-size: 1.2em; font-weight: bold; color: #0078d4; margin: 0; }
        .cloud-actions { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        
        button { padding: 8px 12px; font-size: 0.9em; border-radius: 4px; border: 1px solid #bbb; background: #eee; cursor: pointer; }
        button:hover { background: #ddd; }
        button:disabled { opacity: 0.6; cursor: not-allowed; }
        
        .primary-btn { background: #0078d4; color: white; border-color: #005a9e; }
        .warn-btn { background: #d9534f; color: white; border-color: #d43f3a; }
        .success-btn { background: #28a745; color: white; border-color: #218838; }
        .onedrive-btn { background: #0078d4; color: white; border-color: #005a9e; }
        .convert-btn { background: #6c757d; color: white; border-color: #545b62; }
        
        /* --- Status-Anzeige --- */
        .onedrive-status { 
            display: none; align-items: center; padding: 6px 12px; font-size: 0.9em; font-weight: 500; 
            border-radius: 4px; transition: all 0.3s ease; margin-left: 10px; 
        }
        .onedrive-status.saving { background-color: #e0f2fe; color: #0c4a6e; border: 1px solid #bae6fd; }
        .onedrive-status.success { background-color: #dcfce7; color: #14532d; border: 1px solid #bbf7d0; }
        .onedrive-status.error { background-color: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
        .onedrive-status.info { background-color: #fffbeb; color: #92400e; border: 1px solid #fde68a; }

        /* --- Wachhund Warnung --- */
        #sessionExpiredWarning { 
            margin: 0 0 15px 0; font-weight: bold; padding: 10px; border-radius: 4px; 
            display: none; background-color: #fffbe6; border: 1px solid #ffc107; color: #ff8f00; 
            text-align: center; width: 100%; box-sizing: border-box;
        }

        /* --- Main Layout --- */
        h1, h2, h3 { color: #333; border-bottom: 2px solid #0078d4; padding-bottom: 5px; margin-top: 20px; }
        .tab-bar { margin-bottom: 15px; display: flex; flex-wrap: wrap; align-items: center; gap: 5px; }
        .tab-btn { background: #f9f9f9; border-bottom: 3px solid transparent; border-radius: 4px 4px 0 0; padding: 10px 15px; }
        .tab-btn.active { border-bottom: 3px solid #0078d4; font-weight: bold; background: white; }
        
        .pdf-actions { margin-left: auto; display: flex; gap: 10px; }

        .panel { display: none; background: white; padding: 15px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .panel.active { display: block; }
        
        .liste-item { border: 1px solid #ddd; border-radius: 4px; padding: 10px; margin-bottom: 10px; background: #fff; }
        .liste-item h4 { margin-top: 0; color: #0078d4; border-bottom: none; }
        .zuordnungen { padding-left: 20px; border-left: 3px solid #0078d4; margin-top: 10px; font-size: 0.9em; color: #555; }
        .action-buttons { display: flex; gap: 5px; }
        
        /* --- Modal/Pflegemaske Styles --- */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; justify-content: center; align-items: center; }
        .modal-overlay.active { display: flex; }
        .modal-content { background: white; padding: 25px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; }
        .modal-content input, .modal-content select, .modal-content textarea { width: 100%; padding: 8px; margin-top: 5px; margin-bottom: 15px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
        
        /* --- Dynamic Lists --- */
        .dynamic-input-row, .dynamic-address-row { display: flex; gap: 5px; margin-bottom: 5px; align-items: center; }
        .dynamic-address-row { flex-direction: column; align-items: stretch; border: 1px dashed #ccc; padding: 10px; background: #fdfdfd; }
        .address-row-1, .address-row-2 { display: flex; gap: 10px; margin-bottom: 5px; }
        .input-group { flex: 1; }
        .input-group label { font-size: 0.75em; color: #666; display: block; }

        #importProtokoll { width: 100%; height: 100px; font-family: monospace; font-size: 0.85em; background: #333; color: #0f0; border: 1px solid #666; margin-top: 10px; }
    </style>
</head>
<body>

    <div id="sessionExpiredWarning">Ihre Sitzung ist abgelaufen. Bitte melden Sie sich erneut an, um Datenverlust zu vermeiden.</div>

    <!-- Header mit Cloud-Funktionen -->
    <div class="app-header">
        <div class="app-title">Adress-Verwaltung <span id="loggedInUser" style="font-size:0.6em; font-weight:normal; color:#555;"></span></div>
        <div class="cloud-actions">
            <input type="text" id="onedrivePath" value="/ideenapp/stammdaten.json" style="padding: 5px; width: 200px; font-size: 0.9em;" title="Pfad in OneDrive">
            
            <button id="msLoginBtn" onclick="handleMicrosoftLogin()" class="onedrive-btn">🔑 Login</button>
            <button id="msLogoutBtn" onclick="handleLogout()" class="warn-btn" style="display:none;">🔒 Logout</button>
            
            <span style="border-left: 1px solid #ccc; height: 20px; margin: 0 5px;"></span>
            
            <button id="cloudLoadBtn" onclick="loadFromOneDrive()" disabled>☁️ Laden</button>
            <button id="cloudSaveBtn" onclick="saveToOneDrive(true)" disabled>💾 Manuell Speichern</button>
            
            <!-- Der Status-Button -->
            <span id="onedriveStatus" class="onedrive-status"></span>
        </div>
    </div>

    <!-- Hauptinhalt -->
    <div style="max-width: 1200px; margin: 0 auto;">
        
        <!-- VCF Import & Protokoll -->
        <details>
            <summary><strong>Werkzeuge: VCF Import (Outlook) & Protokoll</strong></summary>
            <div style="padding: 10px; background: #fff; border: 1px solid #ddd; margin-top: 5px;">
                <input type="file" id="vcfImportInput" accept=".vcf" multiple>
                <textarea id="importProtokoll" readonly placeholder="Import-Protokoll..."></textarea>
            </div>
        </details>

        <h2>Datenverwaltung</h2>
        <div class="tab-bar">
            <div>
                <button class="tab-btn active" onclick="switchTab('mandanten')">🏢 Mandanten (Firmen)</button>
                <button class="tab-btn" onclick="switchTab('kontakte')">👤 Kontakte (Personen)</button>
            </div>
            
            <div class="pdf-actions">
                <button onclick="exportMandantenReportPDF()">🖨️ Mandanten-PDF</button>
                <button onclick="exportPersonenReportPDF()">🖨️ Kontakte-PDF</button>
            </div>
        </div>

        <!-- Ansicht A: Mandanten -->
        <div id="panelMandanten" class="panel active">
            <button class="success-btn" onclick="openMandantMask()">+ Neuen Mandant anlegen</button>
            <div id="mandantenListe" style="margin-top: 15px;"></div>
        </div>

        <!-- Ansicht B: Kontakte -->
        <div id="panelKontakte" class="panel">
            <button class="success-btn" onclick="openKontaktMask()">+ Neuen Kontakt anlegen</button>
            <div id="kontakteListe" style="margin-top: 15px;"></div>
        </div>
    </div>

    <!-- ======================================================= -->
    <!-- MODALS (PFLEGEMASKEN) -->
    <!-- ======================================================= -->

    <!-- Maske für Mandant -->
    <div id="mandantModal" class="modal-overlay" onclick="closeModals(event)">
        <div class="modal-content">
            <h3 id="mandantModalTitle">Mandant bearbeiten</h3>
            <input type="hidden" id="mandantIdInput">
            
            <label>Mandantennummer (ID)*:</label>
            <input type="text" id="mandantNummerInput" placeholder="z.B. 1001">
            
            <label>Firmenname*:</label>
            <input type="text" id="mandantNameInput" placeholder="z.B. Muster GmbH">
            
            <div style="display:flex; gap:10px;">
                <div style="flex:1;"><label>USt-IdNr.:</label><input type="text" id="mandantUstIdInput"></div>
                <div style="flex:1;"><label>Steuernummer:</label><input type="text" id="mandantSteuerNrInput"></div>
            </div>
            <label>IBAN:</label><input type="text" id="mandantIbanInput">

            <label>Kommunikation:</label>
            <div id="mandantTelefonListe"></div>
            <button type="button" onclick="addDynamicInput('mandantTelefonListe', 'telefon')">+ Telefon</button>
            <div id="mandantEmailListe" style="margin-top:5px;"></div>
            <button type="button" onclick="addDynamicInput('mandantEmailListe', 'email')">+ E-Mail</button>
            
            <label style="margin-top:10px; display:block;">Adressen:</label>
            <div id="mandantAdressListe"></div>
            <button type="button" onclick="addDynamicAddressInput('mandantAdressListe')">+ Adresse</button>

            <label style="margin-top:10px; display:block;">Notizen:</label>
            <textarea id="mandantNotizenInput" rows="2"></textarea>

            <div style="margin-top:20px; text-align:right;">
                <button type="button" onclick="exportMandantAsVCF()" id="mandantExportVCFBtn" style="float:left;">VCF Export</button>
                <button type="button" onclick="closeModals()">Abbrechen</button>
                <button class="primary-btn" onclick="saveMandant()">Speichern</button>
                <button class="warn-btn" id="mandantDeleteBtn" onclick="deleteMandant()">Löschen</button>
            </div>
        </div>
    </div>

    <!-- Maske für Kontakt -->
    <div id="kontaktModal" class="modal-overlay" onclick="closeModals(event)">
        <div class="modal-content">
            <h3 id="kontaktModalTitle">Kontakt bearbeiten</h3>
            <input type="hidden" id="kontaktIdInput">

            <label>Name (FN)*:</label>
            <input type="text" id="kontaktNameInput" placeholder="Max Mustermann">

            <label>Organisation (aus VCF):</label>
            <input type="text" id="kontaktOrgInput">

            <label>Kommunikation:</label>
            <div id="kontaktTelefonListe"></div>
            <button type="button" onclick="addDynamicInput('kontaktTelefonListe', 'telefon')">+ Telefon</button>
            <div id="kontaktEmailListe" style="margin-top:5px;"></div>
            <button type="button" onclick="addDynamicInput('kontaktEmailListe', 'email')">+ E-Mail</button>

            <label style="margin-top:10px; display:block;">Adressen:</label>
            <div id="kontaktAdressListe"></div>
            <button type="button" onclick="addDynamicAddressInput('kontaktAdressListe')">+ Adresse</button>

            <label style="margin-top:10px; display:block;">Notizen:</label>
            <textarea id="kontaktNotizenInput" rows="2"></textarea>

            <h4 style="margin-top:15px; border-bottom:1px solid #eee;">Firmen-Zuweisung</h4>
            <div id="zuweisungsListe" style="margin-bottom:10px; background:#f9f9f9; padding:5px; border:1px solid #eee; min-height: 20px;"></div>
            <div style="display:flex; gap:5px; align-items:flex-end;">
                <div style="flex:2;">
                    <label style="font-size:0.8em;">Firma:</label>
                    <select id="neueZuweisungMandantSelect" style="margin:0;"></select>
                </div>
                <div style="flex:2;">
                    <label style="font-size:0.8em;">Position/Abt.:</label>
                    <input type="text" id="neueZuweisungPositionInput" style="margin:0;">
                </div>
                <!-- Typ Button wichtig, damit Formular nicht submitted -->
                <button type="button" onclick="addZuweisung()" style="margin:0;" title="Verbindung hinzufügen">+</button>
            </div>

            <div style="margin-top:20px; display:flex; justify-content:space-between; flex-wrap:wrap; gap:10px;">
                <div style="display:flex; gap:5px;">
                    <button type="button" onclick="exportKontaktAsVCF()" id="kontaktExportVCFBtn">VCF Export</button>
                    <!-- Button zur Umwandlung -->
                    <button type="button" onclick="convertToMandant()" class="convert-btn" id="kontaktToMandantBtn" title="Erstellt einen neuen Mandanten aus diesen Daten">🏢 Als Mandant anlegen</button>
                </div>
                <div style="display:flex; gap:5px;">
                    <button type="button" onclick="closeModals()">Abbrechen</button>
                    <button class="primary-btn" onclick="saveKontakt()">Speichern</button>
                    <button class="warn-btn" id="kontaktDeleteBtn" onclick="deleteKontakt()">Löschen</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ======================================================= -->
    <!-- LOGIC -->
    <!-- ======================================================= -->
    <script>
        // --- 1. KONFIGURATION & GLOBALE VARIABLEN ---
        
        const msalConfig = { 
            auth: { 
                clientId: "c3cd3be4-3540-46dd-a24c-82eb6ed5542d", 
                authority: "https://login.microsoftonline.com/common", 
                redirectUri: window.location.origin + window.location.pathname
            } 
        };

        let msalInstance = null;
        let accessToken = null;
        let userEmail = null;
        let tokenRefreshIntervalId = null; // Für den Wachhund

        const MANDANTEN_KEY = "kontakte_mandanten";
        const KONTAKTE_KEY = "kontakte_personen";
        const VERKNUEPFUNGEN_KEY = "kontakte_verknuepfungen";
        
        let dbMandanten = new Map();
        let dbKontakte = new Map();
        let dbVerknuepfungen = [];
        let tempZuweisungen = [];

        // --- 2. INITIALISIERUNG ---
        document.addEventListener('DOMContentLoaded', async () => {
            loadLocalDatabases();
            refreshAuswertungslisten();

            // VCF Listener
            const vcfInput = document.getElementById('vcfImportInput');
            if(vcfInput) vcfInput.onchange = handleVCFImport;

            try {
                msalInstance = new msal.PublicClientApplication(msalConfig);
                await msalInstance.initialize();
                
                // --- WACHHUND LOGIK ---
                // Prüft, ob aus der Ideen-App oder vorheriger Sitzung eine Anmeldung vorliegt
                await versucheSitzungWiederherzustellen();

            } catch (e) {
                console.error("MSAL Init Fehler:", e);
            }
        });

        // --- 3. CLOUD / MICROSOFT LOGIK (INKL. WACHHUND) ---
        
        // Versucht, eine bestehende Sitzung zu reaktivieren (z.B. nach Reload oder Wechsel von Ideen-App)
        async function versucheSitzungWiederherzustellen() {
            // Wir schauen, ob in sessionStorage Daten liegen (die teilen sich index.html und kontakte.html bei gleicher Domain)
            const savedLoginType = sessionStorage.getItem('loginType');
            const savedAccountId = sessionStorage.getItem('msalAccountIdentifier');

            if (savedLoginType === 'microsoft' && savedAccountId) {
                console.log("Versuche, Sitzung wiederherzustellen...");
                const account = await msalInstance.getAccountByHomeId(savedAccountId);
                if (account) {
                    msalInstance.setActiveAccount(account);
                    // Versuche, still ein Token zu bekommen
                    const token = await getValidToken(false); // Nicht interaktiv
                    if (token) {
                        await handleLoginSuccess(account);
                    }
                }
            }
        }

        async function handleMicrosoftLogin() {
            try {
                const loginResponse = await msalInstance.loginPopup({ 
                    scopes: ["Files.ReadWrite", "User.Read", "offline_access"],
                    prompt: "select_account"
                });
                await handleLoginSuccess(loginResponse.account);
            } catch (e) {
                zeigeStatus("Login fehlgeschlagen: " + e.message, "error");
            }
        }

        async function handleLoginSuccess(account) {
            userEmail = account.username;
            document.getElementById('loggedInUser').textContent = `(${userEmail})`;
            document.getElementById('msLoginBtn').style.display = 'none';
            document.getElementById('msLogoutBtn').style.display = 'inline-block';
            document.getElementById('cloudLoadBtn').disabled = false;
            document.getElementById('cloudSaveBtn').disabled = false;
            document.getElementById('sessionExpiredWarning').style.display = 'none';

            // Session Storage setzen (für Kommunikation mit index.html und Reloads)
            sessionStorage.setItem('loginType', 'microsoft');
            sessionStorage.setItem('userEmail', userEmail);
            sessionStorage.setItem('msalAccountIdentifier', account.homeAccountId);
            
            // Erstes Token holen
            const token = await getValidToken(false);
            if (token) {
                // Wachhund starten: Alle 10 Minuten Token prüfen
                clearInterval(tokenRefreshIntervalId);
                tokenRefreshIntervalId = setInterval(() => getValidToken(false), 10 * 60 * 1000);
                
                zeigeStatus("Angemeldet & Wachhund aktiv.", "info");
                // Automatisches Laden beim Start, wenn Token da ist
                await loadFromOneDrive(); 
            }
        }

        // --- KERN DES WACHHUNDS: Token holen/erneuern ---
        async function getValidToken(interactive = false) {
            if (!msalInstance) return null;
            const account = msalInstance.getActiveAccount();
            if (!account) return null;

            try {
                const response = await msalInstance.acquireTokenSilent({ 
                    scopes: ["Files.ReadWrite"], 
                    account: account 
                });
                accessToken = response.accessToken;
                document.getElementById('sessionExpiredWarning').style.display = 'none';
                return accessToken;
            } catch (error) {
                console.warn("Stiller Token-Refresh fehlgeschlagen", error);
                if (interactive) {
                    try {
                        const response = await msalInstance.acquireTokenPopup({ 
                            scopes: ["Files.ReadWrite"], 
                            account: account 
                        });
                        accessToken = response.accessToken;
                        document.getElementById('sessionExpiredWarning').style.display = 'none';
                        return accessToken;
                    } catch (err2) {
                        console.error("Interaktiver Refresh fehlgeschlagen", err2);
                        handleExpiredSession();
                        return null;
                    }
                } else {
                    handleExpiredSession();
                    return null;
                }
            }
        }

        function handleExpiredSession() {
            document.getElementById('sessionExpiredWarning').style.display = 'block';
            accessToken = null;
        }

        async function handleLogout() {
            await msalInstance.logoutPopup();
            sessionStorage.clear(); // Session bereinigen
            location.reload();
        }

        // --- NEU: Statusanzeige-Logik ---
        function zeigeStatus(msg, type) {
            const el = document.getElementById('onedriveStatus');
            el.textContent = msg;
            
            // Klassen resetten und neuen Typ setzen
            el.className = 'onedrive-status'; 
            el.classList.add(type);
            
            el.style.display = 'inline-flex';
            
            if (type === 'success' || type === 'error' || type === 'info') {
                setTimeout(() => { 
                    if(el.textContent === msg) el.style.display = 'none'; 
                }, 4000);
            }
        }

        // --- 4. LOAD & SAVE (CLOUD & LOKAL) ---

        let autoSaveTimer = null;
        function triggerAutoSave() {
            if (!accessToken) return; // Nicht eingeloggt -> kein AutoSave
            
            zeigeStatus("⏳ Änderungen erkannt...", "info");
            clearTimeout(autoSaveTimer);
            autoSaveTimer = setTimeout(() => {
                saveToOneDrive(false); // false = automatisch
            }, 2000);
        }

        function prepareDataForSave() {
            return {
                mandanten: Array.from(dbMandanten.entries()),
                kontakte: Array.from(dbKontakte.entries()),
                verknuepfungen: dbVerknuepfungen,
                meta: {
                    last_update: new Date().toISOString(),
                    saved_by: userEmail || "lokal"
                }
            };
        }

        function parseDataFromLoad(data) {
            if (!data) return false;
            try {
                if (data.mandanten) dbMandanten = new Map(data.mandanten);
                if (data.kontakte) dbKontakte = new Map(data.kontakte);
                if (data.verknuepfungen && Array.isArray(data.verknuepfungen)) {
                    dbVerknuepfungen = data.verknuepfungen;
                } else {
                    dbVerknuepfungen = [];
                }
                return true;
            } catch (e) {
                console.error("Daten Parsing Fehler:", e);
                return false;
            }
        }

        async function saveToOneDrive(isManual = true) {
            // WICHTIG: Token prüfen bevor wir speichern!
            if (!(await getValidToken(isManual))) {
                if(isManual) alert("Sitzung abgelaufen. Bitte neu anmelden.");
                return;
            }
            
            zeigeStatus("☁️ Wird gespeichert...", "saving");
            
            const dataObj = prepareDataForSave();
            const jsonStr = JSON.stringify(dataObj, null, 2);
            const path = document.getElementById('onedrivePath').value;
            
            try {
                const url = `https://graph.microsoft.com/v1.0/me/drive/root:${path}:/content`;
                const res = await fetch(url, {
                    method: "PUT",
                    headers: { "Authorization": `Bearer ${accessToken}`, "Content-Type": "application/json" },
                    body: jsonStr
                });
                
                if (res.ok) {
                    zeigeStatus("✓ Gespeichert", "success");
                    saveLocalDatabases();
                } else {
                    if (res.status === 401) handleExpiredSession();
                    throw new Error(res.statusText);
                }
            } catch (e) {
                zeigeStatus("Fehler: " + e.message, "error");
            }
        }

        async function loadFromOneDrive() {
            // WICHTIG: Token prüfen
            if (!(await getValidToken(true))) {
                alert("Bitte erst einloggen.");
                return;
            }
            zeigeStatus("Lade Daten...", "saving");
            
            const path = document.getElementById('onedrivePath').value;
            
            try {
                const url = `https://graph.microsoft.com/v1.0/me/drive/root:${path}:/content`;
                const res = await fetch(url, {
                    method: "GET",
                    headers: { "Authorization": `Bearer ${accessToken}` }
                });
                
                if (res.ok) {
                    const data = await res.json();
                    if (parseDataFromLoad(data)) {
                        refreshAuswertungslisten();
                        saveLocalDatabases();
                        zeigeStatus("✓ Daten geladen", "success");
                    } else {
                        zeigeStatus("Datenformat ungültig.", "error");
                    }
                } else if (res.status === 404) {
                    zeigeStatus("Neue Datei wird angelegt.", "info");
                } else {
                    if (res.status === 401) handleExpiredSession();
                    throw new Error(res.statusText);
                }
            } catch (e) {
                zeigeStatus("Ladefehler: " + e.message, "error");
            }
        }

        function loadLocalDatabases() {
            try {
                const m = localStorage.getItem(MANDANTEN_KEY);
                if (m) dbMandanten = new Map(JSON.parse(m));
                
                const k = localStorage.getItem(KONTAKTE_KEY);
                if (k) dbKontakte = new Map(JSON.parse(k));
                
                const v = localStorage.getItem(VERKNUEPFUNGEN_KEY);
                if (v) dbVerknuepfungen = JSON.parse(v) || [];
                else dbVerknuepfungen = [];
            } catch (e) { 
                console.warn("Lokal leer/korrupt, starte leer."); 
                dbVerknuepfungen = [];
            }
        }

        function saveLocalDatabases() {
            localStorage.setItem(MANDANTEN_KEY, JSON.stringify(Array.from(dbMandanten.entries())));
            localStorage.setItem(KONTAKTE_KEY, JSON.stringify(Array.from(dbKontakte.entries())));
            localStorage.setItem(VERKNUEPFUNGEN_KEY, JSON.stringify(dbVerknuepfungen));
        }


        // --- 5. LOGIK: MANDANTEN & KONTAKTE VERWALTUNG ---

        function switchTab(id) {
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            
            const capId = id.charAt(0).toUpperCase() + id.slice(1);
            document.getElementById(`panel${capId}`).classList.add('active');
            const btns = document.querySelectorAll('.tab-btn');
            if (id === 'mandanten') btns[0].classList.add('active');
            if (id === 'kontakte') btns[1].classList.add('active');
        }

        function refreshAuswertungslisten() {
            const select = document.getElementById('neueZuweisungMandantSelect');
            if(select) {
                select.innerHTML = "<option value=''>-- Firma wählen --</option>";
                dbMandanten.forEach((m, id) => {
                    select.add(new Option(`${m.firmenname} [${m.mandantennummer}]`, id));
                });
            }
            renderMandantenListe();
            renderKontakteListe();
        }

        function renderMandantenListe() {
            const container = document.getElementById('mandantenListe');
            if(!container) return;
            container.innerHTML = "";
            if (dbMandanten.size === 0) { container.innerHTML = "<i>Keine Daten.</i>"; return; }
            
            dbMandanten.forEach((m, id) => {
                const div = document.createElement('div');
                div.className = 'liste-item';
                const count = dbVerknuepfungen.filter(v => String(v.mandantennummer_fk) === String(id)).length;
                div.innerHTML = `
                    <div style="display:flex; justify-content:space-between;">
                        <h4>${m.firmenname} <small style="color:#999;">[ID: ${m.mandantennummer}]</small></h4>
                        <div class="action-buttons">
                            <button onclick="openMandantMask('${id}')">Bearbeiten</button>
                            <button class="warn-btn" onclick="deleteMandant('${id}')" title="Löschen">🗑️</button>
                        </div>
                    </div>
                    <div style="font-size:0.9em; margin-bottom:5px;">
                        ${m.adresse?.[0]?.city || ''} | Tel: ${m.telefon?.[0]?.number || '-'}
                    </div>
                    <div class="zuordnungen">Verknüpfte Personen: ${count}</div>
                `;
                container.appendChild(div);
            });
        }

        function renderKontakteListe() {
            const container = document.getElementById('kontakteListe');
            if(!container) return;
            container.innerHTML = "";
            if (dbKontakte.size === 0) { container.innerHTML = "<i>Keine Daten.</i>"; return; }
            
            dbKontakte.forEach((k, id) => {
                const div = document.createElement('div');
                div.className = 'liste-item';
                const firmen = dbVerknuepfungen
                    .filter(v => String(v.kontakt_id_fk) === String(id))
                    .map(v => {
                        const m = dbMandanten.get(String(v.mandantennummer_fk));
                        const pos = v.position_abteilung ? ` (${v.position_abteilung})` : '';
                        return m ? `${m.firmenname}${pos}` : '?';
                    }).join(", ");
                
                div.innerHTML = `
                    <div style="display:flex; justify-content:space-between;">
                        <h4>${k.fn} <small style="color:#999;">${k.org || ''}</small></h4>
                        <div class="action-buttons">
                            <button onclick="openKontaktMask('${id}')">Bearbeiten</button>
                            <button class="warn-btn" onclick="deleteKontakt('${id}')" title="Löschen">🗑️</button>
                        </div>
                    </div>
                    <div style="font-size:0.9em; margin-bottom:5px;">
                         ${k.email?.[0]?.address || '-'} | Tel: ${k.telefon?.[0]?.number || '-'}
                    </div>
                    <div class="zuordnungen">Firmen: ${firmen || '-'}</div>
                `;
                container.appendChild(div);
            });
        }

        // --- MASKEN STEUERUNG (FIXED) ---

        function closeModals(e) {
            if (!e) {
                document.getElementById('mandantModal').classList.remove('active');
                document.getElementById('kontaktModal').classList.remove('active');
                return;
            }
            if (e.target.classList.contains('modal-overlay')) {
                document.getElementById('mandantModal').classList.remove('active');
                document.getElementById('kontaktModal').classList.remove('active');
            }
        }

        function openMandantMask(id = null) {
            const isEdit = !!id;
            document.getElementById('mandantModalTitle').textContent = isEdit ? "Mandant bearbeiten" : "Neuen Mandant anlegen";
            document.getElementById('mandantDeleteBtn').style.display = isEdit ? 'inline-block' : 'none';
            document.getElementById('mandantExportVCFBtn').style.display = isEdit ? 'inline-block' : 'none';
            
            const m = isEdit ? dbMandanten.get(id) : {};
            
            document.getElementById('mandantIdInput').value = id || ""; 
            document.getElementById('mandantNummerInput').value = m.mandantennummer || "";
            document.getElementById('mandantNameInput').value = m.firmenname || "";
            document.getElementById('mandantUstIdInput').value = m.ust_id || "";
            document.getElementById('mandantSteuerNrInput').value = m.steuernummer || "";
            document.getElementById('mandantIbanInput').value = m.bankverbindung?.iban || "";
            document.getElementById('mandantNotizenInput').value = m.firmen_notizen || "";
            
            document.getElementById('mandantTelefonListe').innerHTML="";
            (m.telefon||[]).forEach(x => addDynamicInput('mandantTelefonListe','telefon',x));
            if(!isEdit) addDynamicInput('mandantTelefonListe','telefon');

            document.getElementById('mandantEmailListe').innerHTML="";
            (m.email||[]).forEach(x => addDynamicInput('mandantEmailListe','email',x));
            if(!isEdit) addDynamicInput('mandantEmailListe','email');

            document.getElementById('mandantAdressListe').innerHTML="";
            (m.adresse||[]).forEach(x => addDynamicAddressInput('mandantAdressListe',x));
            if(!isEdit) addDynamicAddressInput('mandantAdressListe');

            document.getElementById('mandantModal').classList.add('active');
        }

        function openKontaktMask(id = null) {
            const isEdit = !!id;
            refreshAuswertungslisten();

            document.getElementById('kontaktModalTitle').textContent = isEdit ? "Kontakt bearbeiten" : "Neuen Kontakt anlegen";
            document.getElementById('kontaktDeleteBtn').style.display = isEdit ? 'inline-block' : 'none';
            document.getElementById('kontaktExportVCFBtn').style.display = isEdit ? 'inline-block' : 'none';
            document.getElementById('kontaktToMandantBtn').style.display = isEdit ? 'inline-block' : 'none';

            const k = isEdit ? dbKontakte.get(id) : {};
            
            document.getElementById('kontaktIdInput').value = k.kontakt_id || "";
            document.getElementById('kontaktNameInput').value = k.fn || "";
            document.getElementById('kontaktOrgInput').value = k.org || "";
            document.getElementById('kontaktNotizenInput').value = k.person_notizen || "";
            
            document.getElementById('kontaktTelefonListe').innerHTML="";
            (k.telefon||[]).forEach(x => addDynamicInput('kontaktTelefonListe','telefon',x));
            if(!isEdit) addDynamicInput('kontaktTelefonListe','telefon');

            document.getElementById('kontaktEmailListe').innerHTML="";
            (k.email||[]).forEach(x => addDynamicInput('kontaktEmailListe','email',x));
            if(!isEdit) addDynamicInput('kontaktEmailListe','email');

            document.getElementById('kontaktAdressListe').innerHTML="";
            (k.adresse||[]).forEach(x => addDynamicAddressInput('kontaktAdressListe',x));
            if(!isEdit) addDynamicAddressInput('kontaktAdressListe');

            // Zuweisungen laden
            tempZuweisungen = [];
            if (isEdit) {
                tempZuweisungen = dbVerknuepfungen.filter(v => String(v.kontakt_id_fk) === String(id)).map(v => ({...v}));
            }
            renderTempZuweisungen();

            document.getElementById('kontaktModal').classList.add('active');
        }

        function convertToMandant() {
            const kid = document.getElementById('kontaktIdInput').value;
            if(!kid) return;
            const name = document.getElementById('kontaktNameInput').value;
            
            if(!confirm(`Möchten Sie "${name}" wirklich in eine Firma (Mandant) umwandeln?`)) return;

            const telefon = collectDynamicInputs('kontaktTelefonListe', 'number');
            const email = collectDynamicInputs('kontaktEmailListe', 'address');
            const adresse = collectDynamicAddressInputs('kontaktAdressListe');
            const notizen = document.getElementById('kontaktNotizenInput').value;
            const org = document.getElementById('kontaktOrgInput').value;

            const mId = (Math.floor(Math.random() * 9000) + 1000).toString(); 

            const neuerMandant = {
                mandantennummer: mId,
                firmenname: name + (org ? ` (${org})` : ""),
                ust_id: "",
                steuernummer: "",
                bankverbindung: { iban: "", bic: null },
                firmen_notizen: `Umgewandelt von Kontakt.\n${notizen}`,
                telefon: telefon,
                email: email,
                adresse: adresse
            };

            dbMandanten.set(mId, neuerMandant);
            saveLocalDatabases();
            refreshAuswertungslisten();
            document.getElementById('kontaktModal').classList.remove('active');
            
            switchTab('mandanten');
            openMandantMask(mId);
            triggerAutoSave(); // NEU: Auto-Save
            alert(`Mandant angelegt (ID: ${mId}).`);
        }

        function updateZuweisungPosition(idx, newVal) {
            if (tempZuweisungen[idx]) {
                tempZuweisungen[idx].position_abteilung = newVal;
            }
        }

        function renderTempZuweisungen() {
            const div = document.getElementById('zuweisungsListe');
            div.innerHTML = "";
            if (tempZuweisungen.length === 0) {
                div.innerHTML = "<div style='color:#999; font-size:0.9em; padding:5px;'>Keine Firmen zugewiesen</div>";
                return;
            }
            tempZuweisungen.forEach((z, idx) => {
                const m = dbMandanten.get(String(z.mandantennummer_fk));
                const row = document.createElement('div');
                row.style.borderBottom = "1px solid #ddd";
                row.style.padding = "4px";
                row.style.display = "flex";
                row.style.alignItems = "center";
                row.style.gap = "5px";

                const displayId = m ? m.mandantennummer : z.mandantennummer_fk;
                const firmenName = m ? m.firmenname : `Unbekannt`;
                
                const label = document.createElement('div');
                label.style.flex = "1";
                label.innerHTML = `<b>${firmenName} [${displayId}]</b>`;
                
                const posInput = document.createElement('input');
                posInput.type = "text";
                posInput.placeholder = "Position/Abteilung";
                posInput.value = z.position_abteilung || "";
                posInput.style.flex = "1";
                posInput.style.margin = "0";
                posInput.style.padding = "4px";
                posInput.style.fontSize = "0.9em";
                posInput.onchange = function() { updateZuweisungPosition(idx, this.value); };

                const delBtn = document.createElement('button');
                delBtn.className = "warn-btn";
                delBtn.textContent = "X";
                delBtn.style.padding = "2px 6px";
                delBtn.style.fontSize = "0.8em";
                delBtn.onclick = function() { removeTempZuweisung(idx); };

                row.appendChild(label);
                row.appendChild(posInput);
                row.appendChild(delBtn);
                
                div.appendChild(row);
            });
        }
        
        function addZuweisung() {
            try {
                const select = document.getElementById('neueZuweisungMandantSelect');
                const mid = select.value;
                const pos = document.getElementById('neueZuweisungPositionInput').value;
                
                if(!mid) {
                    alert("Bitte wählen Sie zuerst eine Firma (Mandant) aus der Liste aus.");
                    return;
                }

                tempZuweisungen.push({
                    verknuepfung_id: 'v_' + Date.now(),
                    kontakt_id_fk: null,
                    mandantennummer_fk: String(mid),
                    position_abteilung: pos,
                    kostenstelle: ""
                });
                renderTempZuweisungen();
                
                select.value = "";
                document.getElementById('neueZuweisungPositionInput').value = "";
            } catch(e) {
                console.error(e);
            }
        }
        
        function removeTempZuweisung(idx) {
            tempZuweisungen.splice(idx, 1);
            renderTempZuweisungen();
        }

        function saveMandant() {
            let id = document.getElementById('mandantIdInput').value;
            const name = document.getElementById('mandantNameInput').value.trim();
            const nummer = document.getElementById('mandantNummerInput').value.trim();
            if(!name) return alert("Firmenname fehlt.");
            
            if(!id) id = 'm_' + Date.now() + Math.random().toString(36).substr(2,5);

            const data = {
                mandantennummer: String(nummer || id),
                firmenname: name,
                ust_id: document.getElementById('mandantUstIdInput').value,
                steuernummer: document.getElementById('mandantSteuerNrInput').value,
                bankverbindung: { iban: document.getElementById('mandantIbanInput').value },
                firmen_notizen: document.getElementById('mandantNotizenInput').value,
                telefon: collectDynamicInputs('mandantTelefonListe', 'number'),
                email: collectDynamicInputs('mandantEmailListe', 'address'),
                adresse: collectDynamicAddressInputs('mandantAdressListe')
            };

            dbMandanten.set(String(id), data);
            saveLocalDatabases();
            refreshAuswertungslisten();
            document.getElementById('mandantModal').classList.remove('active');
            triggerAutoSave(); // NEU: Auto-Save
        }

        function deleteMandant(id = null) {
            if(!id) id = document.getElementById('mandantIdInput').value;
            if(!id) return;
            if(!confirm("Wirklich löschen?")) return;
            dbMandanten.delete(String(id));
            dbVerknuepfungen = dbVerknuepfungen.filter(v => String(v.mandantennummer_fk) !== String(id));
            saveLocalDatabases();
            refreshAuswertungslisten();
            document.getElementById('mandantModal').classList.remove('active');
            triggerAutoSave(); // NEU: Auto-Save
        }

        async function saveKontakt() {
            // 1. Validierung
            const fn = document.getElementById('kontaktNameInput').value.trim();
            if (!fn) return alert("Name ist erforderlich!");

            let id = document.getElementById('kontaktIdInput').value;

            // NEU: Duplikat-Prüfung (Nur beim Neuanlegen relevant)
            if (!id) {
                const existiert = Array.from(dbKontakte.values()).some(k => k.fn.toLowerCase() === fn.toLowerCase());
                if (existiert) {
                    return alert(`Ein Kontakt mit dem Namen "${fn}" existiert bereits! Bitte wählen Sie ihn aus der Liste, um ihn zu bearbeiten.`);
                }
                id = 'k_' + Date.now() + Math.random().toString(36).substr(2,5);
            }

            const pendingSelect = document.getElementById('neueZuweisungMandantSelect');
            if (pendingSelect && pendingSelect.value) {
                addZuweisung();
            }

            const data = {
                kontakt_id: String(id),
                fn: fn,
                org: document.getElementById('kontaktOrgInput').value,
                person_notizen: document.getElementById('kontaktNotizenInput').value,
                telefon: collectDynamicInputs('kontaktTelefonListe', 'number'),
                email: collectDynamicInputs('kontaktEmailListe', 'address'),
                adresse: collectDynamicAddressInputs('kontaktAdressListe')
            };
            
            // 1. Kontakt speichern
            dbKontakte.set(String(id), data);
            
            // 2. Verknüpfungen speichern
            const cleanDB = dbVerknuepfungen.filter(v => String(v.kontakt_id_fk) !== String(id));
            const newAssignments = tempZuweisungen.map(z => {
                return {
                    ...z,
                    kontakt_id_fk: String(id) // ID explizit setzen
                };
            });
            dbVerknuepfungen = [...cleanDB, ...newAssignments];

            saveLocalDatabases();
            refreshAuswertungslisten();
            document.getElementById('kontaktModal').classList.remove('active');
            triggerAutoSave(); // NEU: Auto-Save
        }

        function deleteKontakt(id = null) {
            if(!id) id = document.getElementById('kontaktIdInput').value;
            if(!id) return;
            if(!confirm("Wirklich löschen?")) return;
            dbKontakte.delete(String(id));
            dbVerknuepfungen = dbVerknuepfungen.filter(v => String(v.kontakt_id_fk) !== String(id));
            saveLocalDatabases();
            refreshAuswertungslisten();
            document.getElementById('kontaktModal').classList.remove('active');
            triggerAutoSave(); // NEU: Auto-Save
        }

        // --- NEUE HELPER FÜR FORMULARE (DOM-BASIERT für Stabilität) ---
        function addDynamicInput(containerId, type, dataObj) {
            const container = document.getElementById(containerId);
            if (!container) return;

            let safeData = {};
            if (dataObj && typeof dataObj === 'object' && !dataObj.preventDefault) {
                safeData = dataObj;
            }

            const row = document.createElement('div');
            row.className = 'dynamic-input-row';

            const select = document.createElement('select');
            select.style.width = 'auto';
            select.style.margin = '0';
            
            const types = ['WORK', 'HOME', 'MOBILE', 'CELL', 'FAX'];
            types.forEach(t => {
                const opt = document.createElement('option');
                opt.value = t;
                opt.textContent = t;
                if (safeData.type === t) opt.selected = true;
                select.appendChild(opt);
            });

            const input = document.createElement('input');
            input.type = type === 'telefon' ? 'tel' : 'email';
            input.style.margin = '0';
            input.style.flex = '1';
            
            const val = type === 'telefon' ? safeData.number : safeData.address;
            input.value = val || ""; 

            const delBtn = document.createElement('button');
            delBtn.type = 'button';
            delBtn.className = 'warn-btn';
            delBtn.style.margin = '0';
            delBtn.textContent = 'X';
            delBtn.onclick = function() { row.remove(); };

            row.appendChild(select);
            row.appendChild(input);
            row.appendChild(delBtn);

            container.appendChild(row);
        }

        function addDynamicAddressInput(containerId, dataObj) {
            const container = document.getElementById(containerId);
            if (!container) return;

            let safeData = {};
            if (dataObj && typeof dataObj === 'object' && !dataObj.preventDefault) {
                safeData = dataObj;
            }

            const row = document.createElement('div');
            row.className = 'dynamic-address-row';

            const row1 = document.createElement('div');
            row1.className = 'address-row-1';

            const grpStreet = document.createElement('div');
            grpStreet.className = 'input-group';
            grpStreet.innerHTML = '<label>Str:</label>';
            const inpStreet = document.createElement('input');
            inpStreet.className = 'adr-street';
            inpStreet.value = safeData.street || "";
            grpStreet.appendChild(inpStreet);

            const grpType = document.createElement('div');
            grpType.className = 'input-group';
            grpType.innerHTML = '<label>Typ:</label>';
            const selType = document.createElement('select');
            selType.className = 'adr-type';
            ['WORK', 'HOME'].forEach(t => {
                const opt = document.createElement('option');
                opt.value = t; 
                opt.textContent = t;
                if(safeData.type === t) opt.selected = true;
                selType.appendChild(opt);
            });
            grpType.appendChild(selType);

            row1.appendChild(grpStreet);
            row1.appendChild(grpType);

            const row2 = document.createElement('div');
            row2.className = 'address-row-2';

            const grpZip = document.createElement('div');
            grpZip.className = 'input-group';
            grpZip.innerHTML = '<label>PLZ:</label>';
            const inpZip = document.createElement('input');
            inpZip.className = 'adr-zip';
            inpZip.value = safeData.zip || "";
            grpZip.appendChild(inpZip);

            const grpCity = document.createElement('div');
            grpCity.className = 'input-group';
            grpCity.innerHTML = '<label>Stadt:</label>';
            const inpCity = document.createElement('input');
            inpCity.className = 'adr-city';
            inpCity.value = safeData.city || "";
            grpCity.appendChild(inpCity);

            row2.appendChild(grpZip);
            row2.appendChild(grpCity);

            const delBtn = document.createElement('button');
            delBtn.type = 'button';
            delBtn.className = 'warn-btn';
            delBtn.style.fontSize = '0.8em';
            delBtn.style.padding = '2px';
            delBtn.textContent = 'Adresse entfernen';
            delBtn.onclick = function() { row.remove(); };

            row.appendChild(row1);
            row.appendChild(row2);
            row.appendChild(delBtn);

            container.appendChild(row);
        }

        function collectDynamicInputs(cid, key) {
            const arr = [];
            const container = document.getElementById(cid);
            if(container) {
                Array.from(container.children).forEach(row => {
                    if(!row.classList.contains('dynamic-input-row')) return;
                    const select = row.querySelector('select');
                    const input = row.querySelector('input');
                    if(select && input && input.value) {
                         arr.push({ type: select.value, [key]: input.value });
                    }
                });
            }
            return arr;
        }

        function collectDynamicAddressInputs(cid) {
            const arr = [];
            const container = document.getElementById(cid);
            if(container) {
                Array.from(container.children).forEach(row => {
                    if(!row.classList.contains('dynamic-address-row')) return;
                    const s = row.querySelector('.adr-street').value;
                    const z = row.querySelector('.adr-zip').value;
                    const c = row.querySelector('.adr-city').value;
                    const t = row.querySelector('.adr-type').value;
                    if(s||c||z) {
                        arr.push({ type: t, street: s, zip: z, city: c });
                    }
                });
            }
            return arr;
        }

        async function handleVCFImport(e) {
            const files = e.target.files;
            if(!files.length) return;
            const log = document.getElementById('importProtokoll');
            let totalImported = 0;
            let totalUpdated = 0;

            for(const f of files) {
                log.value += `Lese ${f.name}...\n`;
                const txt = await f.text();
                const vcards = txt.split(/BEGIN:VCARD/i);
                
                for(const vcRaw of vcards) {
                    if(!vcRaw.trim()) continue;
                    let lines = vcRaw.split(/\r\n|\r|\n/);
                    let unfoldedLines = [];
                    lines.forEach(line => {
                        if (line.startsWith(' ') || line.startsWith('\t')) {
                            if (unfoldedLines.length > 0) unfoldedLines[unfoldedLines.length - 1] += line.trim();
                        } else if(line.trim()) unfoldedLines.push(line.trim());
                    });

                    let fn = "", n = "", org = "", telefon = [], email = [], adresse = [];

                    unfoldedLines.forEach(line => {
                        let parts = line.split(':');
                        if (parts.length < 2) return;
                        let keyPart = parts.shift();
                        let value = parts.join(':');
                        let keyParams = keyPart.split(';');
                        let params = keyParams.slice(1).map(p => p.toUpperCase());

                        if (keyParams.some(p => p.includes('QUOTED-PRINTABLE'))) {
                            value = value.replace(/=([0-9A-F]{2})/gi, (m, h) => String.fromCharCode(parseInt(h, 16)));
                            value = value.replace(/=\r\n/g, '').replace(/=\n/g, '');
                        }

                        if (keyParams[0].toUpperCase() === 'FN') fn = value;
                        if (keyParams[0].toUpperCase() === 'N' && !fn) n = value.replace(/;/g, ' ').trim();
                        if (keyParams[0].toUpperCase() === 'ORG') org = value;
                        if (keyParams[0].toUpperCase() === 'TEL') {
                            let type = "WORK";
                            if (params.includes("CELL")) type = "CELL";
                            else if (params.includes("HOME")) type = "HOME";
                            else if (params.includes("FAX")) type = "FAX";
                            telefon.push({ type, number: value });
                        }
                        if (keyParams[0].toUpperCase() === 'EMAIL') {
                            email.push({ type: "WORK", address: value });
                        }
                        if (keyParams[0].toUpperCase() === 'ADR') {
                            let adrParts = value.split(';');
                            let street = adrParts[2] || "";
                            let city = adrParts[3] || "";
                            let zip = adrParts[5] || "";
                            if (street || city || zip) adresse.push({ type: "WORK", street, zip, city });
                        }
                    });

                    if (!fn && n) fn = n;
                    if (!fn) continue;

                    let existingId = null;
                    for (const [id, kontakt] of dbKontakte.entries()) {
                        if (kontakt.fn && kontakt.fn.toLowerCase().trim() === fn.toLowerCase().trim()) {
                            existingId = id;
                            break;
                        }
                    }

                    if (existingId) {
                        const existing = dbKontakte.get(existingId);
                        if(!existing.telefon) existing.telefon = [];
                        if(!existing.email) existing.email = [];
                        if(!existing.adresse) existing.adresse = [];
                        
                        let updated = false;
                        telefon.forEach(newTel => {
                            if (!existing.telefon.some(t => t.number === newTel.number)) {
                                existing.telefon.push(newTel);
                                updated = true;
                            }
                        });
                        email.forEach(newMail => {
                            if (!existing.email.some(e => e.address.toLowerCase() === newMail.address.toLowerCase())) {
                                existing.email.push(newMail);
                                updated = true;
                            }
                        });
                        adresse.forEach(newAdr => {
                            if (!existing.adresse.some(a => a.street === newAdr.street)) {
                                existing.adresse.push(newAdr);
                                updated = true;
                            }
                        });
                        if (org && !existing.org) { existing.org = org; updated = true; }

                        if (updated) {
                            dbKontakte.set(existingId, existing);
                            log.value += `[Aktualisiert] ${fn}\n`;
                            totalUpdated++;
                        } else {
                            log.value += `[Skip] ${fn}\n`;
                        }
                    } else {
                        const id = 'k_' + Date.now() + Math.random().toString(36).substr(2,5);
                        dbKontakte.set(id, { kontakt_id: id, fn: fn, org: org, person_notizen: "", telefon: telefon, email: email, adresse: adresse });
                        log.value += `[Neu] ${fn}\n`;
                        totalImported++;
                    }
                }
                log.value += `Import Ende: ${totalImported} neu, ${totalUpdated} aktualisiert.\n`;
            }
            saveLocalDatabases();
            refreshAuswertungslisten();
            document.getElementById('vcfImportInput').value = ''; 
            triggerAutoSave(); // NEU: Auto-Save nach Import
        }

        // --- VCF EXPORT LOGIK ---
        
        function downloadVCF(filename, content) {
            const blob = new Blob([content], { type: 'text/vcard;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            setTimeout(() => {
                document.body.removeChild(link);
                URL.revokeObjectURL(link.href);
            }, 100);
        }

        function exportMandantAsVCF() {
            const id = document.getElementById('mandantIdInput').value;
            const m = dbMandanten.get(String(id));
            if (!m) return alert("Kein Mandant geladen.");
            
            let vcf = "BEGIN:VCARD\nVERSION:3.0\n";
            vcf += `FN:${m.firmenname}\n`;
            vcf += `ORG:${m.firmenname}\n`;
            
            (m.telefon || []).forEach(t => vcf += `TEL;TYPE=${t.type},VOICE:${t.number}\n`);
            (m.email || []).forEach(e => vcf += `EMAIL;TYPE=${e.type},INTERNET:${e.address}\n`);
            (m.adresse || []).forEach(a => {
                vcf += `ADR;TYPE=${a.type}:;;${a.street || ''};${a.city || ''};;${a.zip || ''};;\n`;
            });
            
            if(m.firmen_notizen) vcf += `NOTE:${m.firmen_notizen.replace(/\n/g, '\\n')}\n`;
            
            vcf += "END:VCARD";
            downloadVCF(`${m.firmenname.replace(/[^a-z0-9]/gi, '_')}.vcf`, vcf);
        }

        function exportKontaktAsVCF() {
            const id = document.getElementById('kontaktIdInput').value;
            const k = dbKontakte.get(String(id));
            if (!k) return alert("Kein Kontakt geladen.");

            let vcf = "BEGIN:VCARD\nVERSION:3.0\n";
            vcf += `FN:${k.fn}\n`;
            vcf += `N:;${k.fn};;;\n`; 
            if(k.org) vcf += `ORG:${k.org}\n`;
            
            (k.telefon || []).forEach(t => vcf += `TEL;TYPE=${t.type},VOICE:${t.number}\n`);
            (k.email || []).forEach(e => vcf += `EMAIL;TYPE=${e.type},INTERNET:${e.address}\n`);
            (k.adresse || []).forEach(a => {
                vcf += `ADR;TYPE=${a.type}:;;${a.street || ''};${a.city || ''};;${a.zip || ''};;\n`;
            });

            if(k.person_notizen) vcf += `NOTE:${k.person_notizen.replace(/\n/g, '\\n')}\n`;

            vcf += "END:VCARD";
            downloadVCF(`${k.fn.replace(/[^a-z0-9]/gi, '_')}.vcf`, vcf);
        }

        // --- PDF EXPORT (COMPREHENSIVE & LANDSCAPE) ---
        function exportMandantenReportPDF() { 
            const doc = new jspdf.jsPDF({ orientation: 'landscape' });
            const rows = [];
            dbMandanten.forEach(m => {
                const adr = m.adresse && m.adresse.length > 0 
                    ? `${m.adresse[0].street || ''}, ${m.adresse[0].zip || ''} ${m.adresse[0].city || ''}` 
                    : '';
                const tel = m.telefon ? m.telefon.map(t => `${t.type}: ${t.number}`).join(', ') : '';
                const mail = m.email ? m.email.map(e => e.address).join(', ') : '';
                const bank = m.bankverbindung?.iban || '';
                const steuer = (m.ust_id ? `USt: ${m.ust_id}` : '') + (m.steuernummer ? ` StNr: ${m.steuernummer}` : '');
                const notizen = m.firmen_notizen || '';

                rows.push([
                    m.mandantennummer, 
                    m.firmenname, 
                    adr,
                    tel, 
                    mail,
                    bank,
                    steuer,
                    notizen
                ]);
            });

            doc.autoTable({
                head: [['ID', 'Firma', 'Adresse', 'Telefon', 'Email', 'IBAN', 'Steuer', 'Notizen']],
                body: rows,
                styles: { fontSize: 8, cellPadding: 2 },
                columnStyles: {
                    0: { cellWidth: 15 }, 1: { cellWidth: 40 }, 2: { cellWidth: 40 }, 5: { cellWidth: 35 }, 7: { cellWidth: 40 }
                },
                theme: 'grid'
            });
            doc.save('mandanten_report_full.pdf');
        }

        function exportPersonenReportPDF() { 
            const doc = new jspdf.jsPDF({ orientation: 'landscape' });
            const rows = [];
            dbKontakte.forEach((k, kId) => {
                const adr = k.adresse && k.adresse.length > 0 
                    ? `${k.adresse[0].street || ''}, ${k.adresse[0].zip || ''} ${k.adresse[0].city || ''}` 
                    : '';
                const tel = k.telefon ? k.telefon.map(t => `${t.type}: ${t.number}`).join(', ') : '';
                const mail = k.email ? k.email.map(e => e.address).join(', ') : '';
                const notizen = k.person_notizen || '';
                
                const links = dbVerknuepfungen
                    .filter(v => String(v.kontakt_id_fk) === String(kId))
                    .map(v => {
                        const m = dbMandanten.get(String(v.mandantennummer_fk));
                        const pos = v.position_abteilung ? ` (${v.position_abteilung})` : '';
                        return m ? `${m.firmenname}${pos}` : '?';
                    }).join("\n");

                rows.push([
                    k.fn, 
                    k.org||'', 
                    adr,
                    tel, 
                    mail,
                    links,
                    notizen
                ]);
            });

            doc.autoTable({
                head: [['Name', 'Org', 'Adresse', 'Telefon', 'Email', 'Firmen (Pos)', 'Notizen']],
                body: rows,
                styles: { fontSize: 8, cellPadding: 2 },
                columnStyles: {
                    0: { cellWidth: 30 }, 2: { cellWidth: 40 }, 5: { cellWidth: 50 }, 6: { cellWidth: 40 }
                },
                theme: 'grid'
            });
            doc.save('kontakte_report_full.pdf');
        }

    </script>
</body>
</html>